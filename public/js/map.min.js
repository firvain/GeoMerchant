// var map;
// var trans;
var dustBluebird = Promise.promisifyAll(dust);


var utils = {
  findById: function findById(map, id) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (id === layers.item(i).get('id')) {
        return layers.item(i);
      }
    }
    return null;
  },
  findByName: function findByName(map, name) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (name === layers.item(i).get('name')) {
        return layers.item(i);
      }
    }
    return null;
  },
  preventDotAndSpace: function preventDotAndSpace(e) {
    var key = e.charCode ? e.charCode : e.keyCode;
    this.innerHTML = key;
    if (key === 46 || key === 32) {
      return false;
    }
    return true;
  }
};

var mymap = (function (window, document, undefined, Promise, ol) {
  'use strict';
  var center = [3677385, 4120949];
  var extent = [3652772, 4112808, 3700000, 4132797];
  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });
  var mapStyles = {
    iconType: function iconType(estateType) {
      var type = {
        Apartment: function apartmentIcon() {
          return 'apartment';
        },
        'Detached House': function detachedHouceIcon() {
          return 'detached';
        },
        Villa: function villaIcon() {
          return 'villa';
        },
        Maisonette: function maisonetteIcon() {
          return 'villa';
        }
      };
      return (type[estateType])();
    },
    iconPath: function iconPath(listingType) {
      var path = {
        true: function saleIcon() {
          return './images/pins/sale/';
        },
        false: function rentIcon() {
          return './images/pins/rent/';
        }
      };
      return (path[listingType])();
    },
    estates: function estates(feature) {
      var src = mapStyles.iconPath(feature.get('sale')) +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        geometry: feature.getGeometry(),
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    },
    cluster: function cluster(feature) {
      var size = feature.get('features').length;
      var style;
      var originalFeature;
      if (size > 1) {
        style = [new ol.style.Style({
          image: new ol.style.Circle({
            radius: 20,
            stroke: new ol.style.Stroke({
              color: [156, 39, 176, 1],
              width: 5
            }),
            fill: new ol.style.Fill({
              color: [68, 138, 255, 0.8]
            })
          }),
          text: new ol.style.Text({
            text: size.toString(),
            fill: new ol.style.Fill({
              color: '#FFFFFF'
            })
          }),
          zIndex: 101
        })];
      } else {
        originalFeature = feature.get('features')[0];
        style = [mapStyles.estates(originalFeature)];
      }
      return style;
    },
    poi: function poi(feature) {
      var styleCache = {};
      var symbol = feature.get('style');
      var text;
      if (window.trans.lang === 'el') {
        text = feature.get('name_el');
      } else {
        text = feature.get('name_en');
      }
      if (!styleCache[symbol]) {
        styleCache = [new ol.style.Style({
          image: new ol.style.Icon(({
            src: '../images/maki/renders/' + symbol + '-24.png',
            anchorOrigin: 'bottom-left',
            anchor: [0.5, 0.5],
            scale: 1
          })),
          text: new ol.style.Text({
            text: text,
            stroke: new ol.style.Stroke({
              color: [156, 39, 176, 0.8],
              width: 1
            }),
            offsetY: 12
          })
        })];
      }
      return styleCache;
    },
    filteredEstates: function filteredEstates(feature) {
      var src = mapStyles.iconPath(feature.get('sale')) +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    }
  };


  var mapSources = {
    bing: function bing() {
      return new ol.source.BingMaps({
        key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
        imagerySet: 'AerialWithLabels'
      });
    },
    mapBox: function mapBox() {
      return new ol.source.XYZ({
        attributions: [new ol.Attribution({
          html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
        })],
        url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
      });
    },
    estates: function estates() {
      return new ol.source.Vector({
        format: geoJSONFormat,
        loader: function featreLoader() {
          var self = this;
          this.clear();
          $.ajax({
            url: 'http://127.0.0.1:3000/db/listed',
            type: 'GET',
            dataType: 'json'
          })
            .done(function succeded(response) {
              var features = geoJSONFormat.readFeatures(response, {
                featureProjection: 'EPSG:3857'
              });
              self.addFeatures(features);
            })
            .fail(function failed(jqXHR) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find any properties!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            });
        }
      });
    },
    cluster: function cluster() {
      return new ol.source.Cluster({
        distance: 40,
        source: mapSources.estates(),
        attributions: [new ol.Attribution({
          html: 'All maps Â© <a href="http://www.terracognita.gr/">Terra Cognita</a>'
        })]
      });
    },
    select: function select() {
      return new ol.source.Vector({});
    },
    poi: function poi() {
      return new ol.source.Vector({
        attributions: [new ol.Attribution({
          html: 'POI by <a href="http://www.terracognita.gr/">Terra Cognita</a>'
        })],
        format: geoJSONFormat
      });
    }
  };

  var mapLayers = {
    bing: function bing(trans) {
      return new ol.layer.Tile({
        visible: true,
        source: mapSources.bing(),
        maxZoom: 19,
        crossOrigin: 'anonymous',
        preload: Infinity,
        id: 'bing',
        name: trans.layers.bing
      });
    },
    mapBox: function mapBox(trans) {
      return new ol.layer.Tile({
        source: mapSources.mapBox(),
        id: 'mapbox',
        name: trans.layers.mapBox
      });
    },
    estates: function estates(trans) {
      return new ol.layer.Vector({
        source: mapSources.cluster(),
        id: 'estates',
        visible: true,
        style: mapStyles.cluster,
        zIndex: 2,
        name: trans.layers.estates
      });
    },
    poi: function poi(trans) {
      return new ol.layer.Vector({
        source: mapSources.poi(),
        style: mapStyles.poi,
        maxResolution: 3,
        zIndex: 1,
        id: 'poi'
      });
    },
    filteredEstates: function filteredEstates(trans) {
      return new ol.layer.Vector({
        source: new ol.source.Vector({
          format: geoJSONFormat
        }),
        id: 'filteredEstates',
        visible: true,
        style: mapStyles.filteredEstates,
        zIndex: 2
      });
    },
    select: function select(trans) {
      return new ol.layer.Vector({
        source: mapSources.select(),
        style: new ol.style.Style({
          fill: new ol.style.Fill({
            color: 'rgba(227, 72, 27, 0.2)'
          }),
          stroke: new ol.style.Stroke({
            color: '#E3481B',
            width: 2
          }),
          image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
              color: '#E3481B'
            })
          })
        }),
        zIndex: 3
      });
    }
  };
  var initialize = function initialize(trans) {
    var layers = Object.keys(mapLayers).map(function addMapLayers(key) {
      return mapLayers[key](trans);
    });
    return new ol.Map({
      target: 'map',
      layers: layers,
      loadTilesWhileAnimating: true,
      loadTilesWhileInteracting: true,
      renderer: 'canvas',
      controls: ol.control.defaults({
        attributionOptions: {
          collapsible: false,
          collapsed: false
        }
      })
       .extend([
         new ol.control.ScaleLine({
           units: 'metric'
         }), new ol.control.OverviewMap({
           className: 'ol-overviewmap ol-custom-overviewmap',
           collapsible: true,
           collapsed: true,
           layers: [mapLayers.bing(trans)]
         }),
         new ol.control.ZoomToExtent({
           extent: extent
         })
       ]),
      view: new ol.View({
        center: center,
        extent: extent,
        projection: 'EPSG:3857',
        zoom: 14,
        maxZoom: 19,
        minZoom: 14
      })
    });
  };
  return {
    initialize: initialize
  };
}(window, document, undefined, Promise, ol));

var filters = (function filters(window, document, Promise, $, utils, Parsley) {
  'use strict';
  function addResults(data, map) {
    var geoJSONFormat = new ol.format.GeoJSON({
      defaultDataProjection: 'EPSG:4326'
    });
    var features = geoJSONFormat.readFeatures(data, {
      featureProjection: 'EPSG:3857'
    });
    utils.findById(map, 'filteredEstates').getSource().addFeatures(features);
    if (trans.lang === 'el') {
      toastr.info('ÎÏÎ­Î¸Î·ÎºÎ±Î½ ' + features.length + ' Î¹Î´Î¹Î¿ÎºÏÎ·ÏÎ¯ÎµÏ!');
    } else {
      toastr.info('Found ' + features.length + ' estates!');
    }
  }
  function clearResults(map) {
    utils.findById(map, 'filteredEstates').getSource().clear();
  }
  function setOptions() {
    var filterData = {};
    filterData.estateType = $('#estateType').val();
    filterData.leaseType = $('input[name=options]:checked').val() !== undefined ? $('input[name=options]:checked').val() : 'Rent';
    filterData.startPrice = $('#startPrice').val() !== '' ? $('#startPrice').val() : 0;
    filterData.endPrice = $('#endPrice').val() !== '' ? $('#endPrice').val() : 2147483647;
    filterData.areaStart = $('#area-start').val() !== '' ? $('#area-start').val() : 0;
    filterData.areaEnd = $('#area-end').val() !== '' ? $('#area-end').val() : 2147483647;
    filterData.parking = $('#checkbox-1').prop('checked') !== undefined ? $('#checkbox-1').prop('checked') : false;
    filterData.furnished = $('#checkbox-2').prop('checked') !== undefined ? $('#checkbox-2').prop('checked') : false;
    filterData.heating = $('#checkbox-3').prop('checked') !== undefined ? $('#checkbox-3').prop('checked') : false;
    filterData.cooling = $('#checkbox-4').prop('checked') !== undefined ? $('#checkbox-4').prop('checked') : false;
    filterData.view = $('#checkbox-5').prop('checked') !== undefined ? $('#checkbox-5').prop('checked') : false;
    return filterData;
  }
  function getResults(options, map) {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/db/listed/filters',
        type: 'GET',
        dataType: 'json',
        data: options
      })
    )
    .then(function resolve(data) {
      utils.findById(map, 'estates').setVisible(false);
      utils.findById(map, 'poi').getSource().clear();
      clearResults(map);
      addResults(data, map);
    }).catch(function error(e) {
      if (e.status === 404) {
        toastr.error(trans.errors.property[404]);
      } else if (e.status === 503) {
        toastr.error(trans.errors.property[503]);
      } else {
        toastr.error(trans.errors.internal);
      }
    });
  }
  function init(map) {
    $('#invokeFilters').click(function invokeFilters(event) {
      var options;
      event.preventDefault();
      event.stopPropagation();
      options = setOptions();
      if ($('form[name=filters]').parsley().validate()) {
        getResults(options, map);
      }
    });
    $('#clearFilters').click(function clearFilters(event) {
      event.preventDefault();
      event.stopPropagation();
      clearResults(map);
      $('label[for=option-1]').addClass('is-checked');
      $('#option-1').prop('checked', true);
      $('label[for=option-2]').removeClass('is-checked');
      $('#option-2').prop('checked', false);
      $('.mdl-checkbox__input').each(function clearCheckboxes(index, el) {
        $(el).prop('checked', false).parent('label')
        .removeClass('is-checked');
      });
      $('.mdl-textfield__input').each(function clearInputs(index, el) {
        if ($(el).attr('id') !== 'estateType') {
          $(el).val('').parent()
          .eq(0)
          .removeClass('is-dirty');
        } else {
          $(el).attr('data-val', 'Apartment');
          if (trans.lang === 'el') {
            $(el).val('ÎÎ¹Î±Î¼Î­ÏÎ¹ÏÎ¼Î±');
          } else {
            $('#estateType').val('Apartment');
          }
        }
      });
      utils.findById(map, 'estates').setVisible(true);
    });
  }
  return {
    init: init
  };
}(window, document, Promise, $, utils, Parsley));

var info = (function info(window, document, Promise, $, utils) {
  'use strict';
  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });
  function extraInfoModal(feature) {
    var modalPromise;
    var obj = {};
    if (feature.get('rent')) {
      obj.listing_type = trans.listing.rent;
    } else {
      obj.listing_type = trans.listing.sale;
    }
    obj.type = feature.get('estatetype');
    obj.gid = feature.get('gid');
    if (trans.lang === 'el') {
      obj.address = feature.get('street_el') + '' +  feature.get('street_number');
      obj.contact = {
        name: feature.getProperties().name_el,
        lastname: feature.getProperties().lastname_el
      };
    } else {
      obj.address = feature.get('street_en') + '' +  feature.get('street_number');
      obj.contact = {
        name: feature.getProperties().name_en,
        lastname: feature.getProperties().lastname_en
      };
    }
    obj.area = feature.get('estatearea');
    obj.bedrooms = feature.get('bedrooms');
    obj.price = feature.get('price');
    obj.title = {
      gid: trans.estate.gid,
      listing_type: trans.listing.type,
      address: trans.estate.address,
      area: trans.estate.area,
      bedrooms: trans.estate.amenities.bedrooms,
      price: trans.listing.price,
      isnew: trans.estate.amenities.isnew,
      parking: trans.estate.amenities.parking,
      furnished: trans.estate.amenities.furnished,
      pets: trans.estate.amenities.pets,
      view: trans.estate.amenities.view,
      heating: trans.estate.amenities.heating,
      cooling: trans.estate.amenities.cooling,
      contactInfo: trans.contact.contactInfo,
      name: trans.contact.name,
      lastname: trans.contact.lastname,
      phone: trans.contact.phone,
      email: trans.contact.email
    };
    obj.isnew = feature.get('isnew');
    obj.furnished = feature.get('furnished');
    obj.pets = feature.get('pets');
    obj.btns = {
      info: trans.btns.info,
      close: trans.btns.close
    };
    if (feature.getProperties().phone2 !== null) {
      obj.contact.phone = feature.getProperties().phone1 + ' ' + feature.getProperties().phone2;
    } else {
      obj.contact.phone = feature.getProperties().phone1;
    }
    obj.contact.email = feature.getProperties().email;

    modalPromise = dustBluebird.renderAsync('modalInfo', obj)
    .then(function resolve(data) {
      $('#modal').removeClass('visuallyhidden');
      $('.modal-content').html(data);
    })
    .then(function resolve() {
      $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg)');
      console.log(feature);
    })
    .catch(function error(e) {
      console.log(e);
    });
    $('#modal-close').click(function closeModal() {
      $('#modal').addClass('visuallyhidden');
    });
  }
  function renderEstateCards(feature) {
    var estateCardsPromise;
    var obj = {};
    if (feature.get('rent')) {
      obj.listing_type = trans.listing.rent;
    } else {
      obj.listing_type = trans.listing.sale;
    }
    obj.type = feature.get('estatetype');
    obj.gid = feature.get('gid');
    if (trans.lang === 'el') {
      obj.address = feature.get('street_el') + '' +  feature.get('street_number');
    } else {
      obj.address = feature.get('street_en') + '' +  feature.get('street_number');
    }
    obj.area = feature.get('estatearea');
    obj.bedrooms = feature.get('bedrooms');
    obj.price = feature.get('price');
    obj.title = {
      listing_type: trans.listing.type,
      address: trans.estate.address,
      area: trans.estate.area,
      bedrooms: trans.estate.amenities.bedrooms,
      price: trans.listing.price,
      isnew: trans.estate.amenities.isnew,
      furnished: trans.estate.amenities.furnished,
      pets: trans.estate.amenities.pets
    };
    obj.isnew = feature.get('isnew');
    obj.furnished = feature.get('furnished');
    obj.pets = feature.get('pets');
    obj.btns = {
      info: trans.btns.info,
      close: trans.btns.close
    };
    estateCardsPromise = dustBluebird.renderAsync('estateCards', obj)
    .then(function resolve(data) {
      $('.estate-cards').html(data);
    })
    .then(function resolve() {
      $('.mdl-card__title').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/w_432,c_scale/' + obj.gid + '.jpg)');
      $('.estate-cards').addClass('estate-cards-active');
      $('#estate-card-square-close').click(function close() {
        $('.estate-cards').removeClass('estate-cards-active');
      });
      $('#estate-card-square-extra-info').click(function extraInfo() {
        extraInfoModal(feature);
      });
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function selectFeature(evt) {
    var map = evt.map;
    // var coordinate = evt.coordinate;
    var f;
    var clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function findFeature(feature, layer) {
      return {
        feature: feature,
        layer: layer
      };
    }, this, function clickedFeatureLayerFilter(layer) {
      if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
        return true;
      }
      return false;
    }, this);
    if (clickedFeature) {
      if (clickedFeature.layer.get('id') === 'estates' &&
        clickedFeature.feature.get('features').length === 1) {
        f = clickedFeature.feature.getProperties().features[0];
        renderEstateCards(f);
        map.getView().setCenter(f.getGeometry().getCoordinates());
        map.getView().setZoom(16);
        Promise.resolve(
          $.ajax({
            url: 'http://127.0.0.1:3000/db/uses/' + f.getProperties().gid,
            type: 'GET',
            dataType: 'json'
          })
        )
        .then(function resolve(data) {
          var features;
          utils.findById(map, 'poi').getSource().clear();
          features = geoJSONFormat.readFeatures(data.property_services_analysis, {
            featureProjection: 'EPSG:3857'
          });
          features.forEach(function removePolygon(feature) {
            if (feature.getGeometry().getType() === 'Polygon') {
              features.splice(features.indexOf(feature), 1);
            }
          });
          utils.findById(map, 'poi').getSource().addFeatures(features);
          // map.getView().fit(utils.findById(map, 'poi').getSource().getExtent(), map.getSize());

          toastr.info('Found ' + features.length + ' Points of Interest in 8 minute distance!');
        })
        .catch(function error(e) {
          utils.findById(map, 'poi').getSource().clear();
          if (e.status === 404) {
            toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
          } else {
            console.log(e);
            toastr.error(e.responseText);
          }
        });
      } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
        f = clickedFeature.feature;
        renderEstateCards(f);
        Promise.resolve(
          $.ajax({
            url: 'http://127.0.0.1:3000/db/uses/' + f.getProperties().gid,
            type: 'GET',
            dataType: 'json'
          })
        )
        .then(function resolve(data) {
          var features;
          if (utils.findById(map, 'poi').getSource().getFeatures().length !== 0) {
            utils.findById(map, 'poi').getSource().clear();
          }
          features = geoJSONFormat.readFeatures(data.property_services_analysis, {
            featureProjection: 'EPSG:3857'
          });
          features.forEach(function removePolygon(feature) {
            if (feature.getGeometry().getType() === 'Polygon') {
              features.splice(features.indexOf(feature), 1);
            }
          });
          utils.findById(map, 'poi').getSource().addFeatures(features);
          map.getView().fit(utils.findById(map, 'poi').getSource().getExtent(), map.getSize());
          toastr.info('Found ' + features.length + ' Points of Interest in 8 minute distance!');
          console.log(trans);
        })
        .catch(function error(e) {
          if (e.status === 404) {
            toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
          } else {
            console.log(e);
            toastr.error(e.responseText);
          }
        });
      }
    } else {
      utils.findById(map, 'poi').getSource().clear();
    }
  }

  function init(map) {
    map.on('click', selectFeature);
  }
  function disable(map) {
    map.un('click', selectFeature);
  }
  return {
    init: init,
    disable: disable
  };
}(window, document, Promise, jQuery, utils));


// function handleInfo(evt) {
//   var coordinate = evt.coordinate;
//   var obj = {};
//   var title = {};
//   var owner = {};
//   var features = [];
//   var clickedFeature;
//   var f;

//   map.removeInteraction(draw);
//   evt.preventDefault();
//   obj.title = title;
//   if (lang === 'el') {
//     title.gid = 'ÎÏÎ´Î¹ÎºÏÏ ÎÎ´Î¹Î¿ÎºÏÎ·ÏÎ¯Î±Ï';
//     title.type = 'ÎÎ¯Î´Î¿Ï ÎÎ´Î¹Î¿ÎºÏÎ·ÏÎ¯Î±Ï';
//     title.listing_type = 'Î¤ÏÏÎ¿Ï ÎÎ³Î³ÎµÎ»Î¯Î±Ï';
//     title.area = 'ÎÎ¼Î²Î±Î´Ï';
//     title.address = 'ÎÎ¹ÎµÏÎ¸ÏÎ½ÏÎ·';
//     title.bedrooms = 'Î¥ÏÎ½Î¿Î´ÏÎ¼Î¬ÏÎ¹Î±';
//     title.price = 'Î¤Î¹Î¼Î®';
//     title.isnew = 'ÎÎµÏÎ´Î¼Î·ÏÎ¿';
//     title.parking = 'Î£ÏÎ¬Î¸Î¼ÎµÏÎ·';
//     title.furnished = 'ÎÏÎ¹ÏÎ»ÏÎ¼Î­Î½Î¿';
//     title.pets = 'ÎÎ±ÏÎ¿Î¹ÎºÎ¯Î´Î¹Î±';
//     title.view = 'ÎÎ­Î±';
//     title.heating = 'ÎÎ­ÏÎ¼Î±Î½ÏÎ·';
//     title.cooling = 'Î¨ÏÎ¾Î·';
//     title.contactInfo = 'Î£ÏÎ¿Î¹ÏÎµÎ¯Î± ÎÏÎ¹ÎºÎ¿Î¹Î½ÏÎ½Î¯Î±Ï';
//     title.name = 'ÎÎ½Î¿Î¼Î±';
//     title.lastname = 'ÎÏÎ¯Î¸ÎµÏÎ¿';
//     title.phone = 'Î¤Î·Î»Î­ÏÏÎ½Î¿';
//     title.email = 'ÎÎ»ÎµÎºÏÏÎ¿Î½Î¹ÎºÎ® ÎÎ¹ÎµÏÎ¸ÏÎ½ÏÎ·';
//   } else {
//     title.gid = 'Estate Code';
//     title.type = 'Property Type';
//     title.listing_type = 'Listing Type';
//     title.area = 'Size';
//     title.address = 'Address';
//     title.bedrooms = 'Bedrooms';
//     title.price = 'Price';
//     title.isnew = 'Newly Build';
//     title.parking = 'Parking';
//     title.furnished = 'Furnished';
//     title.pets = 'Pets Allowed';
//     title.view = 'View';
//     title.heating = 'Heating';
//     title.cooling = 'Cooling';
//     title.contactInfo = 'Contact Info';
//     title.name = 'Name';
//     title.lastname = 'Last Name';
//     title.phone = 'Telephone';
//     title.email = 'Email';
//   }
//   clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
//     return {
//       feature: feature,
//       layer: layer
//     };
//   }, this, function (layer) {
//     if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
//       return true;
//     }
//     return false;
//   }, this);
//   if (clickedFeature) {
//     if (clickedFeature.layer.get('id') === 'estates' && clickedFeature.feature.get('features').length === 1) {
//       f = clickedFeature.feature.getProperties().features[0];
//       createPSAandCard(f, obj);
//     } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
//       f = clickedFeature.feature;
//       createPSAandCard(f, obj);
//     }
//   } else {
//     PSA.setSource(null);
//   }
// }

// function createPSAandCard(f, obj) {
//   var feature = {};
  // feature.gid = f.get('gid');
  // feature.area = f.get('estatearea');
//   if (lang === 'el') {
//     feature.type = f.get('estatetype');
//     feature.address = f.get('street_el') + ' ' + f.get('street_number');
//     feature.name = f.get('name_el');
//     feature.lastname = f.get('lastname_el');
//     if (f.get('sale') === true) {
//       feature.listing_type = 'Î ÏÎ»Î·ÏÎ·';
//     } else {
//       feature.listing_type = 'ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·';
//     }
//     feature.btns = {
//       info: 'ÏÎ»Î·ÏÎ¿ÏÎ¿ÏÎ¹ÎµÏ',
//       close: 'ÎºÎ»ÎµÎ¹ÏÎ¹Î¼Î¿'
//     };
//   } else {
//     feature.type = f.get('estatetype_en');
//     feature.address = f.get('street_en') + ' ' + f.get('street_number');
//     feature.name = f.get('name_en');
//     feature.lastname = f.get('lastname_en');
//     if (f.get('sale') === true) {
//       feature.listing_type = 'Sale';
//     } else {
//       feature.listing_type = 'Rent';
//     }
//     feature.btns = {
//       info: 'info',
//       close: 'close'
//     };
//   }
//   feature.bedrooms = f.get('bedrooms');
//   feature.price = f.get('price');
//   feature.isnew = f.get('isnew');
//   feature.parking = f.get('parking');
//   feature.furnished = f.get('furnished');
//   feature.pets = f.get('pets');
//   feature.view = f.get('view');
//   feature.heating = f.get('heating');
//   feature.cooling = f.get('cooling');
//   feature.phone = f.get('phone1');
//   feature.email = f.get('email');
//   feature.coordinate = f.get('geometry').getCoordinates();

//   var PSASource = new ol.source.Vector({
//     attributions: [new ol.Attribution({
//       html: 'POI by ' + '<a href="http://www.terracognita.gr/">Terra Cognita</a>'
//     })],
//     format: geoJSONFormat,
//     loader: function (extent, resolution, projection) {
//       var url = 'http://127.0.0.1:3000/db/uses/' + feature.gid;
//       var self = this;
//       $.ajax({
//         url: url,
//         type: 'GET',
//         dataType: 'json'
//       }).done(function succeded(data, textStatus, jqXHR) {
        // var features = geoJSONFormat.readFeatures(data.property_services_analysis, {
        //   featureProjection: 'EPSG:3857'
        // });
        // var featuresLength = features.length - 1;
        // var area = new ol.style.Style({
        //   fill: new ol.style.Fill({
        //     color: [156, 39, 176, 0.1]
        //   })
        // });
        // features[0].setStyle(area);
        // self.addFeatures(features);
//         toastr.clear();
//         toastr.info('Found ' + featuresLength + ' Points of Interest in 8 minute distance!');
//       }).fail(function failed(jqXHR) {
//         toastr.clear();
//         if (jqXHR.status === 404) {
//           toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
//         } else if (jqXHR.status === 503) {
//           toastr.error('Service Unavailable');
//         } else {
//           toastr.error('Internal Server Error');
//         }
//       });
//     },
//     strategy: ol.loadingstrategy.all
//   });
//   PSA.setSource(PSASource);
//   map.getView().setCenter(feature.coordinate);
//   map.getView().setResolution(1.2);
//   obj.feature = feature;

//   dust.render('estateCards', obj, function renderEstateCards(err, out) {
//     $('.estate-cards').html(out);
//     $('.mdl-card__title').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/w_432,c_scale/' + obj.feature.gid + '.jpg)');
//     $('.estate-cards').addClass('estate-cards-active');
//   // $("#infobox").addClass("visuallyhidden");
//   });
//   $('a[href="#openModal"]').click(function () {
//     dust.render('modalInfo', obj, function renderModalInfo(err, out) {
//       $('.modal-content').html(out);
//       $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + obj.feature.gid + '.jpg)');
//     });
//   });
//   $('a[href="#closeEstateCard"]').click(function () {
//     $('.estate-cards').removeClass('estate-cards-active');
//   });
// }
// $('#information').on('click', function (e) {
//   // PSA.setSource(null);
//   if ($(this).prop('checked') === true) {
//     map.on('click', selectedFeature);
//     // $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', true);});
//   } else {
//     map.un('click', selectedFeature);
//     // $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', false);});
//   }
// });

var trans;
var userMap = (function userMap(window, document, Promise, $, mymap, info, filters) {
  'use strict';
  var context = 'map';
  var lang = document.documentElement.lang;
  // var globals = {};
  var $loading = $('.mdl-spinner');
  $(document)
  .ajaxStart(function start() {
    $loading.addClass('is-active');
  })
  .ajaxStop(function stop() {
    $loading.removeClass('is-active');
  });
  toastr.options = {
    closeButton: false,
    debug: false,
    newestOnTop: false,
    progressBar: false,
    positionClass: 'toast-top-center',
    preventDuplicates: false,
    onclick: null,
    showDuration: '300',
    hideDuration: '1000',
    timeOut: '5000',
    extendedTimeOut: '1000',
    showEasing: 'swing',
    hideEasing: 'linear',
    showMethod: 'fadeIn',
    hideMethod: 'fadeOut'
  };

  function init() {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/language',
        type: 'GET',
        data: {
          type: lang,
          context: context
        }
      })
      )
      .then(function resolve(data) {
        var map;
        trans = data;
        map = mymap.initialize(trans);
        return map;
      })
      .then(function resolve(map) {
        info.init(map);
        filters.init(map);
      })
      .finally(function finish() {
        console.log(this);
      })
      .catch(function error(e) {
        console.log(e);
      });
  }

  return {
    init: init
  };
}(window, document, Promise, jQuery, mymap, info, filters));


// jQuery(document).ready(function ($) {
//   $('.spinner').addClass('visuallyhidden');
//   $('.mdl-spinner').removeClass('is-active');
//   // handleSelect();
// });

userMap.init();
$('#advanced-filters').click(function toggleFilters() {
  $('#estate-filters').toggleClass('visuallyhidden');
});
// $('#toggle-price-range').click(function togglePriceRange() {
//   $('#price-range').toggleClass('visuallyhidden');
// });

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdsb2JhbHMuanMiLCJ0cmFuc2xhdGlvbi5qcyIsInV0aWxzLmpzIiwib2wzLW1hcC5qcyIsImZpbHRlcnMuanMiLCJpbmZvLmpzIiwiaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUNIQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDckdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwYkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1hcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB2YXIgbWFwO1xyXG4vLyB2YXIgdHJhbnM7XHJcbnZhciBkdXN0Qmx1ZWJpcmQgPSBQcm9taXNlLnByb21pc2lmeUFsbChkdXN0KTtcclxuIiwiIiwidmFyIHV0aWxzID0ge1xyXG4gIGZpbmRCeUlkOiBmdW5jdGlvbiBmaW5kQnlJZChtYXAsIGlkKSB7XHJcbiAgICB2YXIgbGF5ZXJzID0gbWFwLmdldExheWVycygpO1xyXG4gICAgdmFyIGxlbmd0aCA9IGxheWVycy5nZXRMZW5ndGgoKTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKGlkID09PSBsYXllcnMuaXRlbShpKS5nZXQoJ2lkJykpIHtcclxuICAgICAgICByZXR1cm4gbGF5ZXJzLml0ZW0oaSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH0sXHJcbiAgZmluZEJ5TmFtZTogZnVuY3Rpb24gZmluZEJ5TmFtZShtYXAsIG5hbWUpIHtcclxuICAgIHZhciBsYXllcnMgPSBtYXAuZ2V0TGF5ZXJzKCk7XHJcbiAgICB2YXIgbGVuZ3RoID0gbGF5ZXJzLmdldExlbmd0aCgpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAobmFtZSA9PT0gbGF5ZXJzLml0ZW0oaSkuZ2V0KCduYW1lJykpIHtcclxuICAgICAgICByZXR1cm4gbGF5ZXJzLml0ZW0oaSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH0sXHJcbiAgcHJldmVudERvdEFuZFNwYWNlOiBmdW5jdGlvbiBwcmV2ZW50RG90QW5kU3BhY2UoZSkge1xyXG4gICAgdmFyIGtleSA9IGUuY2hhckNvZGUgPyBlLmNoYXJDb2RlIDogZS5rZXlDb2RlO1xyXG4gICAgdGhpcy5pbm5lckhUTUwgPSBrZXk7XHJcbiAgICBpZiAoa2V5ID09PSA0NiB8fCBrZXkgPT09IDMyKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxufTtcclxuIiwidmFyIG15bWFwID0gKGZ1bmN0aW9uICh3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQsIFByb21pc2UsIG9sKSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG4gIHZhciBjZW50ZXIgPSBbMzY3NzM4NSwgNDEyMDk0OV07XHJcbiAgdmFyIGV4dGVudCA9IFszNjUyNzcyLCA0MTEyODA4LCAzNzAwMDAwLCA0MTMyNzk3XTtcclxuICB2YXIgZ2VvSlNPTkZvcm1hdCA9IG5ldyBvbC5mb3JtYXQuR2VvSlNPTih7XHJcbiAgICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbiAgfSk7XHJcbiAgdmFyIG1hcFN0eWxlcyA9IHtcclxuICAgIGljb25UeXBlOiBmdW5jdGlvbiBpY29uVHlwZShlc3RhdGVUeXBlKSB7XHJcbiAgICAgIHZhciB0eXBlID0ge1xyXG4gICAgICAgIEFwYXJ0bWVudDogZnVuY3Rpb24gYXBhcnRtZW50SWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAnYXBhcnRtZW50JztcclxuICAgICAgICB9LFxyXG4gICAgICAgICdEZXRhY2hlZCBIb3VzZSc6IGZ1bmN0aW9uIGRldGFjaGVkSG91Y2VJY29uKCkge1xyXG4gICAgICAgICAgcmV0dXJuICdkZXRhY2hlZCc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBWaWxsYTogZnVuY3Rpb24gdmlsbGFJY29uKCkge1xyXG4gICAgICAgICAgcmV0dXJuICd2aWxsYSc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBNYWlzb25ldHRlOiBmdW5jdGlvbiBtYWlzb25ldHRlSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuICh0eXBlW2VzdGF0ZVR5cGVdKSgpO1xyXG4gICAgfSxcclxuICAgIGljb25QYXRoOiBmdW5jdGlvbiBpY29uUGF0aChsaXN0aW5nVHlwZSkge1xyXG4gICAgICB2YXIgcGF0aCA9IHtcclxuICAgICAgICB0cnVlOiBmdW5jdGlvbiBzYWxlSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9zYWxlLyc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBmYWxzZTogZnVuY3Rpb24gcmVudEljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvcmVudC8nO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIChwYXRoW2xpc3RpbmdUeXBlXSkoKTtcclxuICAgIH0sXHJcbiAgICBlc3RhdGVzOiBmdW5jdGlvbiBlc3RhdGVzKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHNyYyA9IG1hcFN0eWxlcy5pY29uUGF0aChmZWF0dXJlLmdldCgnc2FsZScpKSArXHJcbiAgICAgIG1hcFN0eWxlcy5pY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNDgucG5nJztcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgICAgZ2VvbWV0cnk6IGZlYXR1cmUuZ2V0R2VvbWV0cnkoKSxcclxuICAgICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICAgIHNyYzogc3JjLFxyXG4gICAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgICAgYW5jaG9yOiBbMC41LCAwXSxcclxuICAgICAgICAgIHNjYWxlOiAxXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGNsdXN0ZXI6IGZ1bmN0aW9uIGNsdXN0ZXIoZmVhdHVyZSkge1xyXG4gICAgICB2YXIgc2l6ZSA9IGZlYXR1cmUuZ2V0KCdmZWF0dXJlcycpLmxlbmd0aDtcclxuICAgICAgdmFyIHN0eWxlO1xyXG4gICAgICB2YXIgb3JpZ2luYWxGZWF0dXJlO1xyXG4gICAgICBpZiAoc2l6ZSA+IDEpIHtcclxuICAgICAgICBzdHlsZSA9IFtuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5DaXJjbGUoe1xyXG4gICAgICAgICAgICByYWRpdXM6IDIwLFxyXG4gICAgICAgICAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2Uoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiBbMTU2LCAzOSwgMTc2LCAxXSxcclxuICAgICAgICAgICAgICB3aWR0aDogNVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiBbNjgsIDEzOCwgMjU1LCAwLjhdXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICAgIHRleHQ6IG5ldyBvbC5zdHlsZS5UZXh0KHtcclxuICAgICAgICAgICAgdGV4dDogc2l6ZS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgICAgICAgY29sb3I6ICcjRkZGRkZGJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICB6SW5kZXg6IDEwMVxyXG4gICAgICAgIH0pXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBvcmlnaW5hbEZlYXR1cmUgPSBmZWF0dXJlLmdldCgnZmVhdHVyZXMnKVswXTtcclxuICAgICAgICBzdHlsZSA9IFttYXBTdHlsZXMuZXN0YXRlcyhvcmlnaW5hbEZlYXR1cmUpXTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gc3R5bGU7XHJcbiAgICB9LFxyXG4gICAgcG9pOiBmdW5jdGlvbiBwb2koZmVhdHVyZSkge1xyXG4gICAgICB2YXIgc3R5bGVDYWNoZSA9IHt9O1xyXG4gICAgICB2YXIgc3ltYm9sID0gZmVhdHVyZS5nZXQoJ3N0eWxlJyk7XHJcbiAgICAgIHZhciB0ZXh0O1xyXG4gICAgICBpZiAod2luZG93LnRyYW5zLmxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgICB0ZXh0ID0gZmVhdHVyZS5nZXQoJ25hbWVfZWwnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0ZXh0ID0gZmVhdHVyZS5nZXQoJ25hbWVfZW4nKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXN0eWxlQ2FjaGVbc3ltYm9sXSkge1xyXG4gICAgICAgIHN0eWxlQ2FjaGUgPSBbbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICAgICAgICBzcmM6ICcuLi9pbWFnZXMvbWFraS9yZW5kZXJzLycgKyBzeW1ib2wgKyAnLTI0LnBuZycsXHJcbiAgICAgICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICAgICAgYW5jaG9yOiBbMC41LCAwLjVdLFxyXG4gICAgICAgICAgICBzY2FsZTogMVxyXG4gICAgICAgICAgfSkpLFxyXG4gICAgICAgICAgdGV4dDogbmV3IG9sLnN0eWxlLlRleHQoe1xyXG4gICAgICAgICAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgICAgICAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2Uoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiBbMTU2LCAzOSwgMTc2LCAwLjhdLFxyXG4gICAgICAgICAgICAgIHdpZHRoOiAxXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBvZmZzZXRZOiAxMlxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9KV07XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHN0eWxlQ2FjaGU7XHJcbiAgICB9LFxyXG4gICAgZmlsdGVyZWRFc3RhdGVzOiBmdW5jdGlvbiBmaWx0ZXJlZEVzdGF0ZXMoZmVhdHVyZSkge1xyXG4gICAgICB2YXIgc3JjID0gbWFwU3R5bGVzLmljb25QYXRoKGZlYXR1cmUuZ2V0KCdzYWxlJykpICtcclxuICAgICAgbWFwU3R5bGVzLmljb25UeXBlKGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlX2VuJykpICsgJy00OC5wbmcnO1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICAgIHNyYzogc3JjLFxyXG4gICAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgICAgYW5jaG9yOiBbMC41LCAwXSxcclxuICAgICAgICAgIHNjYWxlOiAxXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG5cclxuICB2YXIgbWFwU291cmNlcyA9IHtcclxuICAgIGJpbmc6IGZ1bmN0aW9uIGJpbmcoKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLkJpbmdNYXBzKHtcclxuICAgICAgICBrZXk6ICdBazJHcThWVWZJQ3NQcHVmN0xSQU5YbVh0MnNIV21TTFBob2htVkxGdEZJRXdZanNfNU1DeUFoQUZ3UlNWcExqJyxcclxuICAgICAgICBpbWFnZXJ5U2V0OiAnQWVyaWFsV2l0aExhYmVscydcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgbWFwQm94OiBmdW5jdGlvbiBtYXBCb3goKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLlhZWih7XHJcbiAgICAgICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgICAgIGh0bWw6ICc8YSBocmVmPVwiaHR0cHM6Ly93d3cubWFwYm94LmNvbS9hYm91dC9tYXBzL1wiIHRhcmdldD1cIl9ibGFua1wiPiZjb3B5OyBNYXBib3ggJmNvcHk7IE9wZW5TdHJlZXRNYXA8L2E+J1xyXG4gICAgICAgIH0pXSxcclxuICAgICAgICB1cmw6ICdodHRwczovL2FwaS5tYXBib3guY29tL3Y0L21hcGJveC5zdHJlZXRzL3t6fS97eH0ve3l9LnBuZz9hY2Nlc3NfdG9rZW49cGsuZXlKMUlqb2labWx5ZG1GcGJpSXNJbUVpT2lKbE9XWXlZVE0wTlRoaU5XTTBZakpqT0RKak5ERTRPRFF6TnpBMk1HUXlOaUo5Li1OVkRPMjdIenQtd19uUW9zVVBmTEEnXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGVzdGF0ZXM6IGZ1bmN0aW9uIGVzdGF0ZXMoKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLlZlY3Rvcih7XHJcbiAgICAgICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0LFxyXG4gICAgICAgIGxvYWRlcjogZnVuY3Rpb24gZmVhdHJlTG9hZGVyKCkge1xyXG4gICAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgICAgICAgdGhpcy5jbGVhcigpO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RlZCcsXHJcbiAgICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZShmdW5jdGlvbiBzdWNjZWRlZChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgIHZhciBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKHJlc3BvbnNlLCB7XHJcbiAgICAgICAgICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICBzZWxmLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCBhbnkgcHJvcGVydGllcyEnKTtcclxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgY2x1c3RlcjogZnVuY3Rpb24gY2x1c3RlcigpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuQ2x1c3Rlcih7XHJcbiAgICAgICAgZGlzdGFuY2U6IDQwLFxyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5lc3RhdGVzKCksXHJcbiAgICAgICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgICAgIGh0bWw6ICdBbGwgbWFwcyDCqSA8YSBocmVmPVwiaHR0cDovL3d3dy50ZXJyYWNvZ25pdGEuZ3IvXCI+VGVycmEgQ29nbml0YTwvYT4nXHJcbiAgICAgICAgfSldXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHNlbGVjdDogZnVuY3Rpb24gc2VsZWN0KCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe30pO1xyXG4gICAgfSxcclxuICAgIHBvaTogZnVuY3Rpb24gcG9pKCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgICAgICBodG1sOiAnUE9JIGJ5IDxhIGhyZWY9XCJodHRwOi8vd3d3LnRlcnJhY29nbml0YS5nci9cIj5UZXJyYSBDb2duaXRhPC9hPidcclxuICAgICAgICB9KV0sXHJcbiAgICAgICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIHZhciBtYXBMYXllcnMgPSB7XHJcbiAgICBiaW5nOiBmdW5jdGlvbiBiaW5nKHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuYmluZygpLFxyXG4gICAgICAgIG1heFpvb206IDE5LFxyXG4gICAgICAgIGNyb3NzT3JpZ2luOiAnYW5vbnltb3VzJyxcclxuICAgICAgICBwcmVsb2FkOiBJbmZpbml0eSxcclxuICAgICAgICBpZDogJ2JpbmcnLFxyXG4gICAgICAgIG5hbWU6IHRyYW5zLmxheWVycy5iaW5nXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIG1hcEJveDogZnVuY3Rpb24gbWFwQm94KHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgICAgICAgc291cmNlOiBtYXBTb3VyY2VzLm1hcEJveCgpLFxyXG4gICAgICAgIGlkOiAnbWFwYm94JyxcclxuICAgICAgICBuYW1lOiB0cmFucy5sYXllcnMubWFwQm94XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGVzdGF0ZXM6IGZ1bmN0aW9uIGVzdGF0ZXModHJhbnMpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5jbHVzdGVyKCksXHJcbiAgICAgICAgaWQ6ICdlc3RhdGVzJyxcclxuICAgICAgICB2aXNpYmxlOiB0cnVlLFxyXG4gICAgICAgIHN0eWxlOiBtYXBTdHlsZXMuY2x1c3RlcixcclxuICAgICAgICB6SW5kZXg6IDIsXHJcbiAgICAgICAgbmFtZTogdHJhbnMubGF5ZXJzLmVzdGF0ZXNcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgcG9pOiBmdW5jdGlvbiBwb2kodHJhbnMpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5wb2koKSxcclxuICAgICAgICBzdHlsZTogbWFwU3R5bGVzLnBvaSxcclxuICAgICAgICBtYXhSZXNvbHV0aW9uOiAzLFxyXG4gICAgICAgIHpJbmRleDogMSxcclxuICAgICAgICBpZDogJ3BvaSdcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgZmlsdGVyZWRFc3RhdGVzOiBmdW5jdGlvbiBmaWx0ZXJlZEVzdGF0ZXModHJhbnMpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgICAgICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgaWQ6ICdmaWx0ZXJlZEVzdGF0ZXMnLFxyXG4gICAgICAgIHZpc2libGU6IHRydWUsXHJcbiAgICAgICAgc3R5bGU6IG1hcFN0eWxlcy5maWx0ZXJlZEVzdGF0ZXMsXHJcbiAgICAgICAgekluZGV4OiAyXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHNlbGVjdDogZnVuY3Rpb24gc2VsZWN0KHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuc2VsZWN0KCksXHJcbiAgICAgICAgc3R5bGU6IG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgICAgIGNvbG9yOiAncmdiYSgyMjcsIDcyLCAyNywgMC4yKSdcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHtcclxuICAgICAgICAgICAgY29sb3I6ICcjRTM0ODFCJyxcclxuICAgICAgICAgICAgd2lkdGg6IDJcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5DaXJjbGUoe1xyXG4gICAgICAgICAgICByYWRpdXM6IDcsXHJcbiAgICAgICAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAgICAgICBjb2xvcjogJyNFMzQ4MUInXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHpJbmRleDogM1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9O1xyXG4gIHZhciBpbml0aWFsaXplID0gZnVuY3Rpb24gaW5pdGlhbGl6ZSh0cmFucykge1xyXG4gICAgdmFyIGxheWVycyA9IE9iamVjdC5rZXlzKG1hcExheWVycykubWFwKGZ1bmN0aW9uIGFkZE1hcExheWVycyhrZXkpIHtcclxuICAgICAgcmV0dXJuIG1hcExheWVyc1trZXldKHRyYW5zKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG5ldyBvbC5NYXAoe1xyXG4gICAgICB0YXJnZXQ6ICdtYXAnLFxyXG4gICAgICBsYXllcnM6IGxheWVycyxcclxuICAgICAgbG9hZFRpbGVzV2hpbGVBbmltYXRpbmc6IHRydWUsXHJcbiAgICAgIGxvYWRUaWxlc1doaWxlSW50ZXJhY3Rpbmc6IHRydWUsXHJcbiAgICAgIHJlbmRlcmVyOiAnY2FudmFzJyxcclxuICAgICAgY29udHJvbHM6IG9sLmNvbnRyb2wuZGVmYXVsdHMoe1xyXG4gICAgICAgIGF0dHJpYnV0aW9uT3B0aW9uczoge1xyXG4gICAgICAgICAgY29sbGFwc2libGU6IGZhbHNlLFxyXG4gICAgICAgICAgY29sbGFwc2VkOiBmYWxzZVxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgIC5leHRlbmQoW1xyXG4gICAgICAgICBuZXcgb2wuY29udHJvbC5TY2FsZUxpbmUoe1xyXG4gICAgICAgICAgIHVuaXRzOiAnbWV0cmljJ1xyXG4gICAgICAgICB9KSwgbmV3IG9sLmNvbnRyb2wuT3ZlcnZpZXdNYXAoe1xyXG4gICAgICAgICAgIGNsYXNzTmFtZTogJ29sLW92ZXJ2aWV3bWFwIG9sLWN1c3RvbS1vdmVydmlld21hcCcsXHJcbiAgICAgICAgICAgY29sbGFwc2libGU6IHRydWUsXHJcbiAgICAgICAgICAgY29sbGFwc2VkOiB0cnVlLFxyXG4gICAgICAgICAgIGxheWVyczogW21hcExheWVycy5iaW5nKHRyYW5zKV1cclxuICAgICAgICAgfSksXHJcbiAgICAgICAgIG5ldyBvbC5jb250cm9sLlpvb21Ub0V4dGVudCh7XHJcbiAgICAgICAgICAgZXh0ZW50OiBleHRlbnRcclxuICAgICAgICAgfSlcclxuICAgICAgIF0pLFxyXG4gICAgICB2aWV3OiBuZXcgb2wuVmlldyh7XHJcbiAgICAgICAgY2VudGVyOiBjZW50ZXIsXHJcbiAgICAgICAgZXh0ZW50OiBleHRlbnQsXHJcbiAgICAgICAgcHJvamVjdGlvbjogJ0VQU0c6Mzg1NycsXHJcbiAgICAgICAgem9vbTogMTQsXHJcbiAgICAgICAgbWF4Wm9vbTogMTksXHJcbiAgICAgICAgbWluWm9vbTogMTRcclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH07XHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXRpYWxpemU6IGluaXRpYWxpemVcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCwgUHJvbWlzZSwgb2wpKTtcclxuIiwidmFyIGZpbHRlcnMgPSAoZnVuY3Rpb24gZmlsdGVycyh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCB1dGlscywgUGFyc2xleSkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICBmdW5jdGlvbiBhZGRSZXN1bHRzKGRhdGEsIG1hcCkge1xyXG4gICAgdmFyIGdlb0pTT05Gb3JtYXQgPSBuZXcgb2wuZm9ybWF0Lkdlb0pTT04oe1xyXG4gICAgICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbiAgICB9KTtcclxuICAgIHZhciBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKGRhdGEsIHtcclxuICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICB9KTtcclxuICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ2ZpbHRlcmVkRXN0YXRlcycpLmdldFNvdXJjZSgpLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgIGlmICh0cmFucy5sYW5nID09PSAnZWwnKSB7XHJcbiAgICAgIHRvYXN0ci5pbmZvKCfOks+Bzq3OuM63zrrOsc69ICcgKyBmZWF0dXJlcy5sZW5ndGggKyAnIM65zrTOuc6/zrrPhM63z4POr861z4IhJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0b2FzdHIuaW5mbygnRm91bmQgJyArIGZlYXR1cmVzLmxlbmd0aCArICcgZXN0YXRlcyEnKTtcclxuICAgIH1cclxuICB9XHJcbiAgZnVuY3Rpb24gY2xlYXJSZXN1bHRzKG1hcCkge1xyXG4gICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZmlsdGVyZWRFc3RhdGVzJykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICB9XHJcbiAgZnVuY3Rpb24gc2V0T3B0aW9ucygpIHtcclxuICAgIHZhciBmaWx0ZXJEYXRhID0ge307XHJcbiAgICBmaWx0ZXJEYXRhLmVzdGF0ZVR5cGUgPSAkKCcjZXN0YXRlVHlwZScpLnZhbCgpO1xyXG4gICAgZmlsdGVyRGF0YS5sZWFzZVR5cGUgPSAkKCdpbnB1dFtuYW1lPW9wdGlvbnNdOmNoZWNrZWQnKS52YWwoKSAhPT0gdW5kZWZpbmVkID8gJCgnaW5wdXRbbmFtZT1vcHRpb25zXTpjaGVja2VkJykudmFsKCkgOiAnUmVudCc7XHJcbiAgICBmaWx0ZXJEYXRhLnN0YXJ0UHJpY2UgPSAkKCcjc3RhcnRQcmljZScpLnZhbCgpICE9PSAnJyA/ICQoJyNzdGFydFByaWNlJykudmFsKCkgOiAwO1xyXG4gICAgZmlsdGVyRGF0YS5lbmRQcmljZSA9ICQoJyNlbmRQcmljZScpLnZhbCgpICE9PSAnJyA/ICQoJyNlbmRQcmljZScpLnZhbCgpIDogMjE0NzQ4MzY0NztcclxuICAgIGZpbHRlckRhdGEuYXJlYVN0YXJ0ID0gJCgnI2FyZWEtc3RhcnQnKS52YWwoKSAhPT0gJycgPyAkKCcjYXJlYS1zdGFydCcpLnZhbCgpIDogMDtcclxuICAgIGZpbHRlckRhdGEuYXJlYUVuZCA9ICQoJyNhcmVhLWVuZCcpLnZhbCgpICE9PSAnJyA/ICQoJyNhcmVhLWVuZCcpLnZhbCgpIDogMjE0NzQ4MzY0NztcclxuICAgIGZpbHRlckRhdGEucGFya2luZyA9ICQoJyNjaGVja2JveC0xJykucHJvcCgnY2hlY2tlZCcpICE9PSB1bmRlZmluZWQgPyAkKCcjY2hlY2tib3gtMScpLnByb3AoJ2NoZWNrZWQnKSA6IGZhbHNlO1xyXG4gICAgZmlsdGVyRGF0YS5mdXJuaXNoZWQgPSAkKCcjY2hlY2tib3gtMicpLnByb3AoJ2NoZWNrZWQnKSAhPT0gdW5kZWZpbmVkID8gJCgnI2NoZWNrYm94LTInKS5wcm9wKCdjaGVja2VkJykgOiBmYWxzZTtcclxuICAgIGZpbHRlckRhdGEuaGVhdGluZyA9ICQoJyNjaGVja2JveC0zJykucHJvcCgnY2hlY2tlZCcpICE9PSB1bmRlZmluZWQgPyAkKCcjY2hlY2tib3gtMycpLnByb3AoJ2NoZWNrZWQnKSA6IGZhbHNlO1xyXG4gICAgZmlsdGVyRGF0YS5jb29saW5nID0gJCgnI2NoZWNrYm94LTQnKS5wcm9wKCdjaGVja2VkJykgIT09IHVuZGVmaW5lZCA/ICQoJyNjaGVja2JveC00JykucHJvcCgnY2hlY2tlZCcpIDogZmFsc2U7XHJcbiAgICBmaWx0ZXJEYXRhLnZpZXcgPSAkKCcjY2hlY2tib3gtNScpLnByb3AoJ2NoZWNrZWQnKSAhPT0gdW5kZWZpbmVkID8gJCgnI2NoZWNrYm94LTUnKS5wcm9wKCdjaGVja2VkJykgOiBmYWxzZTtcclxuICAgIHJldHVybiBmaWx0ZXJEYXRhO1xyXG4gIH1cclxuICBmdW5jdGlvbiBnZXRSZXN1bHRzKG9wdGlvbnMsIG1hcCkge1xyXG4gICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9saXN0ZWQvZmlsdGVycycsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICBkYXRhOiBvcHRpb25zXHJcbiAgICAgIH0pXHJcbiAgICApXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLnNldFZpc2libGUoZmFsc2UpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICBjbGVhclJlc3VsdHMobWFwKTtcclxuICAgICAgYWRkUmVzdWx0cyhkYXRhLCBtYXApO1xyXG4gICAgfSkuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBpZiAoZS5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcih0cmFucy5lcnJvcnMucHJvcGVydHlbNDA0XSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZS5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcih0cmFucy5lcnJvcnMucHJvcGVydHlbNTAzXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKHRyYW5zLmVycm9ycy5pbnRlcm5hbCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBpbml0KG1hcCkge1xyXG4gICAgJCgnI2ludm9rZUZpbHRlcnMnKS5jbGljayhmdW5jdGlvbiBpbnZva2VGaWx0ZXJzKGV2ZW50KSB7XHJcbiAgICAgIHZhciBvcHRpb25zO1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgb3B0aW9ucyA9IHNldE9wdGlvbnMoKTtcclxuICAgICAgaWYgKCQoJ2Zvcm1bbmFtZT1maWx0ZXJzXScpLnBhcnNsZXkoKS52YWxpZGF0ZSgpKSB7XHJcbiAgICAgICAgZ2V0UmVzdWx0cyhvcHRpb25zLCBtYXApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgICQoJyNjbGVhckZpbHRlcnMnKS5jbGljayhmdW5jdGlvbiBjbGVhckZpbHRlcnMoZXZlbnQpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgIGNsZWFyUmVzdWx0cyhtYXApO1xyXG4gICAgICAkKCdsYWJlbFtmb3I9b3B0aW9uLTFdJykuYWRkQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgJCgnI29wdGlvbi0xJykucHJvcCgnY2hlY2tlZCcsIHRydWUpO1xyXG4gICAgICAkKCdsYWJlbFtmb3I9b3B0aW9uLTJdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgJCgnI29wdGlvbi0yJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgJCgnLm1kbC1jaGVja2JveF9faW5wdXQnKS5lYWNoKGZ1bmN0aW9uIGNsZWFyQ2hlY2tib3hlcyhpbmRleCwgZWwpIHtcclxuICAgICAgICAkKGVsKS5wcm9wKCdjaGVja2VkJywgZmFsc2UpLnBhcmVudCgnbGFiZWwnKVxyXG4gICAgICAgIC5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnLm1kbC10ZXh0ZmllbGRfX2lucHV0JykuZWFjaChmdW5jdGlvbiBjbGVhcklucHV0cyhpbmRleCwgZWwpIHtcclxuICAgICAgICBpZiAoJChlbCkuYXR0cignaWQnKSAhPT0gJ2VzdGF0ZVR5cGUnKSB7XHJcbiAgICAgICAgICAkKGVsKS52YWwoJycpLnBhcmVudCgpXHJcbiAgICAgICAgICAuZXEoMClcclxuICAgICAgICAgIC5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJChlbCkuYXR0cignZGF0YS12YWwnLCAnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICBpZiAodHJhbnMubGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICAgICAgICAkKGVsKS52YWwoJ86UzrnOsc68zq3Pgc65z4POvM6xJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXQ6IGluaXRcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsICQsIHV0aWxzLCBQYXJzbGV5KSk7XHJcbiIsInZhciBpbmZvID0gKGZ1bmN0aW9uIGluZm8od2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgJCwgdXRpbHMpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGdlb0pTT05Gb3JtYXQgPSBuZXcgb2wuZm9ybWF0Lkdlb0pTT04oe1xyXG4gICAgZGVmYXVsdERhdGFQcm9qZWN0aW9uOiAnRVBTRzo0MzI2J1xyXG4gIH0pO1xyXG4gIGZ1bmN0aW9uIGV4dHJhSW5mb01vZGFsKGZlYXR1cmUpIHtcclxuICAgIHZhciBtb2RhbFByb21pc2U7XHJcbiAgICB2YXIgb2JqID0ge307XHJcbiAgICBpZiAoZmVhdHVyZS5nZXQoJ3JlbnQnKSkge1xyXG4gICAgICBvYmoubGlzdGluZ190eXBlID0gdHJhbnMubGlzdGluZy5yZW50O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb2JqLmxpc3RpbmdfdHlwZSA9IHRyYW5zLmxpc3Rpbmcuc2FsZTtcclxuICAgIH1cclxuICAgIG9iai50eXBlID0gZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGUnKTtcclxuICAgIG9iai5naWQgPSBmZWF0dXJlLmdldCgnZ2lkJyk7XHJcbiAgICBpZiAodHJhbnMubGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICBvYmouYWRkcmVzcyA9IGZlYXR1cmUuZ2V0KCdzdHJlZXRfZWwnKSArICcnICsgIGZlYXR1cmUuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICAgIG9iai5jb250YWN0ID0ge1xyXG4gICAgICAgIG5hbWU6IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLm5hbWVfZWwsXHJcbiAgICAgICAgbGFzdG5hbWU6IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLmxhc3RuYW1lX2VsXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBvYmouYWRkcmVzcyA9IGZlYXR1cmUuZ2V0KCdzdHJlZXRfZW4nKSArICcnICsgIGZlYXR1cmUuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICAgIG9iai5jb250YWN0ID0ge1xyXG4gICAgICAgIG5hbWU6IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLm5hbWVfZW4sXHJcbiAgICAgICAgbGFzdG5hbWU6IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLmxhc3RuYW1lX2VuXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBvYmouYXJlYSA9IGZlYXR1cmUuZ2V0KCdlc3RhdGVhcmVhJyk7XHJcbiAgICBvYmouYmVkcm9vbXMgPSBmZWF0dXJlLmdldCgnYmVkcm9vbXMnKTtcclxuICAgIG9iai5wcmljZSA9IGZlYXR1cmUuZ2V0KCdwcmljZScpO1xyXG4gICAgb2JqLnRpdGxlID0ge1xyXG4gICAgICBnaWQ6IHRyYW5zLmVzdGF0ZS5naWQsXHJcbiAgICAgIGxpc3RpbmdfdHlwZTogdHJhbnMubGlzdGluZy50eXBlLFxyXG4gICAgICBhZGRyZXNzOiB0cmFucy5lc3RhdGUuYWRkcmVzcyxcclxuICAgICAgYXJlYTogdHJhbnMuZXN0YXRlLmFyZWEsXHJcbiAgICAgIGJlZHJvb21zOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmJlZHJvb21zLFxyXG4gICAgICBwcmljZTogdHJhbnMubGlzdGluZy5wcmljZSxcclxuICAgICAgaXNuZXc6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuaXNuZXcsXHJcbiAgICAgIHBhcmtpbmc6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMucGFya2luZyxcclxuICAgICAgZnVybmlzaGVkOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmZ1cm5pc2hlZCxcclxuICAgICAgcGV0czogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5wZXRzLFxyXG4gICAgICB2aWV3OiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLnZpZXcsXHJcbiAgICAgIGhlYXRpbmc6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuaGVhdGluZyxcclxuICAgICAgY29vbGluZzogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5jb29saW5nLFxyXG4gICAgICBjb250YWN0SW5mbzogdHJhbnMuY29udGFjdC5jb250YWN0SW5mbyxcclxuICAgICAgbmFtZTogdHJhbnMuY29udGFjdC5uYW1lLFxyXG4gICAgICBsYXN0bmFtZTogdHJhbnMuY29udGFjdC5sYXN0bmFtZSxcclxuICAgICAgcGhvbmU6IHRyYW5zLmNvbnRhY3QucGhvbmUsXHJcbiAgICAgIGVtYWlsOiB0cmFucy5jb250YWN0LmVtYWlsXHJcbiAgICB9O1xyXG4gICAgb2JqLmlzbmV3ID0gZmVhdHVyZS5nZXQoJ2lzbmV3Jyk7XHJcbiAgICBvYmouZnVybmlzaGVkID0gZmVhdHVyZS5nZXQoJ2Z1cm5pc2hlZCcpO1xyXG4gICAgb2JqLnBldHMgPSBmZWF0dXJlLmdldCgncGV0cycpO1xyXG4gICAgb2JqLmJ0bnMgPSB7XHJcbiAgICAgIGluZm86IHRyYW5zLmJ0bnMuaW5mbyxcclxuICAgICAgY2xvc2U6IHRyYW5zLmJ0bnMuY2xvc2VcclxuICAgIH07XHJcbiAgICBpZiAoZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkucGhvbmUyICE9PSBudWxsKSB7XHJcbiAgICAgIG9iai5jb250YWN0LnBob25lID0gZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkucGhvbmUxICsgJyAnICsgZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkucGhvbmUyO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb2JqLmNvbnRhY3QucGhvbmUgPSBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5waG9uZTE7XHJcbiAgICB9XHJcbiAgICBvYmouY29udGFjdC5lbWFpbCA9IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLmVtYWlsO1xyXG5cclxuICAgIG1vZGFsUHJvbWlzZSA9IGR1c3RCbHVlYmlyZC5yZW5kZXJBc3luYygnbW9kYWxJbmZvJywgb2JqKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgICQoJyNtb2RhbCcpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwoZGF0YSk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZSgpIHtcclxuICAgICAgJCgnLmJpZy1pbWFnZScpLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoaHR0cDovL3Jlcy5jbG91ZGluYXJ5LmNvbS9maXJ2YWluL2ltYWdlL3VwbG9hZC9oXzIyMixjX3NjYWxlLycgKyBmZWF0dXJlLmdldCgnZ2lkJykgKyAnLmpwZyknKTtcclxuICAgICAgY29uc29sZS5sb2coZmVhdHVyZSk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICB9KTtcclxuICAgICQoJyNtb2RhbC1jbG9zZScpLmNsaWNrKGZ1bmN0aW9uIGNsb3NlTW9kYWwoKSB7XHJcbiAgICAgICQoJyNtb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHJlbmRlckVzdGF0ZUNhcmRzKGZlYXR1cmUpIHtcclxuICAgIHZhciBlc3RhdGVDYXJkc1Byb21pc2U7XHJcbiAgICB2YXIgb2JqID0ge307XHJcbiAgICBpZiAoZmVhdHVyZS5nZXQoJ3JlbnQnKSkge1xyXG4gICAgICBvYmoubGlzdGluZ190eXBlID0gdHJhbnMubGlzdGluZy5yZW50O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb2JqLmxpc3RpbmdfdHlwZSA9IHRyYW5zLmxpc3Rpbmcuc2FsZTtcclxuICAgIH1cclxuICAgIG9iai50eXBlID0gZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGUnKTtcclxuICAgIG9iai5naWQgPSBmZWF0dXJlLmdldCgnZ2lkJyk7XHJcbiAgICBpZiAodHJhbnMubGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICBvYmouYWRkcmVzcyA9IGZlYXR1cmUuZ2V0KCdzdHJlZXRfZWwnKSArICcnICsgIGZlYXR1cmUuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBvYmouYWRkcmVzcyA9IGZlYXR1cmUuZ2V0KCdzdHJlZXRfZW4nKSArICcnICsgIGZlYXR1cmUuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICB9XHJcbiAgICBvYmouYXJlYSA9IGZlYXR1cmUuZ2V0KCdlc3RhdGVhcmVhJyk7XHJcbiAgICBvYmouYmVkcm9vbXMgPSBmZWF0dXJlLmdldCgnYmVkcm9vbXMnKTtcclxuICAgIG9iai5wcmljZSA9IGZlYXR1cmUuZ2V0KCdwcmljZScpO1xyXG4gICAgb2JqLnRpdGxlID0ge1xyXG4gICAgICBsaXN0aW5nX3R5cGU6IHRyYW5zLmxpc3RpbmcudHlwZSxcclxuICAgICAgYWRkcmVzczogdHJhbnMuZXN0YXRlLmFkZHJlc3MsXHJcbiAgICAgIGFyZWE6IHRyYW5zLmVzdGF0ZS5hcmVhLFxyXG4gICAgICBiZWRyb29tczogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5iZWRyb29tcyxcclxuICAgICAgcHJpY2U6IHRyYW5zLmxpc3RpbmcucHJpY2UsXHJcbiAgICAgIGlzbmV3OiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmlzbmV3LFxyXG4gICAgICBmdXJuaXNoZWQ6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuZnVybmlzaGVkLFxyXG4gICAgICBwZXRzOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLnBldHNcclxuICAgIH07XHJcbiAgICBvYmouaXNuZXcgPSBmZWF0dXJlLmdldCgnaXNuZXcnKTtcclxuICAgIG9iai5mdXJuaXNoZWQgPSBmZWF0dXJlLmdldCgnZnVybmlzaGVkJyk7XHJcbiAgICBvYmoucGV0cyA9IGZlYXR1cmUuZ2V0KCdwZXRzJyk7XHJcbiAgICBvYmouYnRucyA9IHtcclxuICAgICAgaW5mbzogdHJhbnMuYnRucy5pbmZvLFxyXG4gICAgICBjbG9zZTogdHJhbnMuYnRucy5jbG9zZVxyXG4gICAgfTtcclxuICAgIGVzdGF0ZUNhcmRzUHJvbWlzZSA9IGR1c3RCbHVlYmlyZC5yZW5kZXJBc3luYygnZXN0YXRlQ2FyZHMnLCBvYmopXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgJCgnLmVzdGF0ZS1jYXJkcycpLmh0bWwoZGF0YSk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZSgpIHtcclxuICAgICAgJCgnLm1kbC1jYXJkX190aXRsZScpLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoaHR0cDovL3Jlcy5jbG91ZGluYXJ5LmNvbS9maXJ2YWluL2ltYWdlL3VwbG9hZC93XzQzMixjX3NjYWxlLycgKyBvYmouZ2lkICsgJy5qcGcpJyk7XHJcbiAgICAgICQoJy5lc3RhdGUtY2FyZHMnKS5hZGRDbGFzcygnZXN0YXRlLWNhcmRzLWFjdGl2ZScpO1xyXG4gICAgICAkKCcjZXN0YXRlLWNhcmQtc3F1YXJlLWNsb3NlJykuY2xpY2soZnVuY3Rpb24gY2xvc2UoKSB7XHJcbiAgICAgICAgJCgnLmVzdGF0ZS1jYXJkcycpLnJlbW92ZUNsYXNzKCdlc3RhdGUtY2FyZHMtYWN0aXZlJyk7XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjZXN0YXRlLWNhcmQtc3F1YXJlLWV4dHJhLWluZm8nKS5jbGljayhmdW5jdGlvbiBleHRyYUluZm8oKSB7XHJcbiAgICAgICAgZXh0cmFJbmZvTW9kYWwoZmVhdHVyZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHNlbGVjdEZlYXR1cmUoZXZ0KSB7XHJcbiAgICB2YXIgbWFwID0gZXZ0Lm1hcDtcclxuICAgIC8vIHZhciBjb29yZGluYXRlID0gZXZ0LmNvb3JkaW5hdGU7XHJcbiAgICB2YXIgZjtcclxuICAgIHZhciBjbGlja2VkRmVhdHVyZSA9IG1hcC5mb3JFYWNoRmVhdHVyZUF0UGl4ZWwoZXZ0LnBpeGVsLCBmdW5jdGlvbiBmaW5kRmVhdHVyZShmZWF0dXJlLCBsYXllcikge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGZlYXR1cmU6IGZlYXR1cmUsXHJcbiAgICAgICAgbGF5ZXI6IGxheWVyXHJcbiAgICAgIH07XHJcbiAgICB9LCB0aGlzLCBmdW5jdGlvbiBjbGlja2VkRmVhdHVyZUxheWVyRmlsdGVyKGxheWVyKSB7XHJcbiAgICAgIGlmIChsYXllci5nZXQoJ2lkJykgPT09ICdlc3RhdGVzJyB8fCBsYXllci5nZXQoJ2lkJykgPT09ICdmaWx0ZXJlZEVzdGF0ZXMnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSwgdGhpcyk7XHJcbiAgICBpZiAoY2xpY2tlZEZlYXR1cmUpIHtcclxuICAgICAgaWYgKGNsaWNrZWRGZWF0dXJlLmxheWVyLmdldCgnaWQnKSA9PT0gJ2VzdGF0ZXMnICYmXHJcbiAgICAgICAgY2xpY2tlZEZlYXR1cmUuZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJykubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgZiA9IGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuZ2V0UHJvcGVydGllcygpLmZlYXR1cmVzWzBdO1xyXG4gICAgICAgIHJlbmRlckVzdGF0ZUNhcmRzKGYpO1xyXG4gICAgICAgIG1hcC5nZXRWaWV3KCkuc2V0Q2VudGVyKGYuZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpKTtcclxuICAgICAgICBtYXAuZ2V0VmlldygpLnNldFpvb20oMTYpO1xyXG4gICAgICAgIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi91c2VzLycgKyBmLmdldFByb3BlcnRpZXMoKS5naWQsXHJcbiAgICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIClcclxuICAgICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgICAgIHZhciBmZWF0dXJlcztcclxuICAgICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgICBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKGRhdGEucHJvcGVydHlfc2VydmljZXNfYW5hbHlzaXMsIHtcclxuICAgICAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGZlYXR1cmVzLmZvckVhY2goZnVuY3Rpb24gcmVtb3ZlUG9seWdvbihmZWF0dXJlKSB7XHJcbiAgICAgICAgICAgIGlmIChmZWF0dXJlLmdldEdlb21ldHJ5KCkuZ2V0VHlwZSgpID09PSAnUG9seWdvbicpIHtcclxuICAgICAgICAgICAgICBmZWF0dXJlcy5zcGxpY2UoZmVhdHVyZXMuaW5kZXhPZihmZWF0dXJlKSwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuYWRkRmVhdHVyZXMoZmVhdHVyZXMpO1xyXG4gICAgICAgICAgLy8gbWFwLmdldFZpZXcoKS5maXQodXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuZ2V0RXh0ZW50KCksIG1hcC5nZXRTaXplKCkpO1xyXG5cclxuICAgICAgICAgIHRvYXN0ci5pbmZvKCdGb3VuZCAnICsgZmVhdHVyZXMubGVuZ3RoICsgJyBQb2ludHMgb2YgSW50ZXJlc3QgaW4gOCBtaW51dGUgZGlzdGFuY2UhJyk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICAgIGlmIChlLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIGFueSBQb2ludHMgb2YgSW50ZXJlc3QgaW4gOCBtaW51dGUgZGlzdGFuY2UhJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgICAgICAgICAgdG9hc3RyLmVycm9yKGUucmVzcG9uc2VUZXh0KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIGlmIChjbGlja2VkRmVhdHVyZS5sYXllci5nZXQoJ2lkJykgPT09ICdmaWx0ZXJlZEVzdGF0ZXMnKSB7XHJcbiAgICAgICAgZiA9IGNsaWNrZWRGZWF0dXJlLmZlYXR1cmU7XHJcbiAgICAgICAgcmVuZGVyRXN0YXRlQ2FyZHMoZik7XHJcbiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3VzZXMvJyArIGYuZ2V0UHJvcGVydGllcygpLmdpZCxcclxuICAgICAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICAgICAgdmFyIGZlYXR1cmVzO1xyXG4gICAgICAgICAgaWYgKHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmdldEZlYXR1cmVzKCkubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKGRhdGEucHJvcGVydHlfc2VydmljZXNfYW5hbHlzaXMsIHtcclxuICAgICAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGZlYXR1cmVzLmZvckVhY2goZnVuY3Rpb24gcmVtb3ZlUG9seWdvbihmZWF0dXJlKSB7XHJcbiAgICAgICAgICAgIGlmIChmZWF0dXJlLmdldEdlb21ldHJ5KCkuZ2V0VHlwZSgpID09PSAnUG9seWdvbicpIHtcclxuICAgICAgICAgICAgICBmZWF0dXJlcy5zcGxpY2UoZmVhdHVyZXMuaW5kZXhPZihmZWF0dXJlKSwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuYWRkRmVhdHVyZXMoZmVhdHVyZXMpO1xyXG4gICAgICAgICAgbWFwLmdldFZpZXcoKS5maXQodXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuZ2V0RXh0ZW50KCksIG1hcC5nZXRTaXplKCkpO1xyXG4gICAgICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlcy5sZW5ndGggKyAnIFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKHRyYW5zKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgICAgICBpZiAoZS5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCBhbnkgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgICAgIHRvYXN0ci5lcnJvcihlLnJlc3BvbnNlVGV4dCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBpbml0KG1hcCkge1xyXG4gICAgbWFwLm9uKCdjbGljaycsIHNlbGVjdEZlYXR1cmUpO1xyXG4gIH1cclxuICBmdW5jdGlvbiBkaXNhYmxlKG1hcCkge1xyXG4gICAgbWFwLnVuKCdjbGljaycsIHNlbGVjdEZlYXR1cmUpO1xyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgaW5pdDogaW5pdCxcclxuICAgIGRpc2FibGU6IGRpc2FibGVcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsIGpRdWVyeSwgdXRpbHMpKTtcclxuXHJcblxyXG4vLyBmdW5jdGlvbiBoYW5kbGVJbmZvKGV2dCkge1xyXG4vLyAgIHZhciBjb29yZGluYXRlID0gZXZ0LmNvb3JkaW5hdGU7XHJcbi8vICAgdmFyIG9iaiA9IHt9O1xyXG4vLyAgIHZhciB0aXRsZSA9IHt9O1xyXG4vLyAgIHZhciBvd25lciA9IHt9O1xyXG4vLyAgIHZhciBmZWF0dXJlcyA9IFtdO1xyXG4vLyAgIHZhciBjbGlja2VkRmVhdHVyZTtcclxuLy8gICB2YXIgZjtcclxuXHJcbi8vICAgbWFwLnJlbW92ZUludGVyYWN0aW9uKGRyYXcpO1xyXG4vLyAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4vLyAgIG9iai50aXRsZSA9IHRpdGxlO1xyXG4vLyAgIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbi8vICAgICB0aXRsZS5naWQgPSAnzprPic60zrnOus+Mz4IgzpnOtM65zr/Ous+EzrfPg86vzrHPgic7XHJcbi8vICAgICB0aXRsZS50eXBlID0gJ86Vzq/OtM6/z4IgzpnOtM65zr/Ous+EzrfPg86vzrHPgic7XHJcbi8vICAgICB0aXRsZS5saXN0aW5nX3R5cGUgPSAnzqTPjc+Azr/PgiDOkc6zzrPOtc67zq/Osc+CJztcclxuLy8gICAgIHRpdGxlLmFyZWEgPSAnzpXOvM6yzrHOtM+MJztcclxuLy8gICAgIHRpdGxlLmFkZHJlc3MgPSAnzpTOuc61z4XOuM+Fzr3Pg863JztcclxuLy8gICAgIHRpdGxlLmJlZHJvb21zID0gJ86lz4DOvc6/zrTPic68zqzPhM65zrEnO1xyXG4vLyAgICAgdGl0bGUucHJpY2UgPSAnzqTOuc68zq4nO1xyXG4vLyAgICAgdGl0bGUuaXNuZXcgPSAnzp3Otc+MzrTOvM63z4TOvyc7XHJcbi8vICAgICB0aXRsZS5wYXJraW5nID0gJ86jz4TOrM64zrzOtc+DzrcnO1xyXG4vLyAgICAgdGl0bGUuZnVybmlzaGVkID0gJ86Vz4DOuc+AzrvPic68zq3Ovc6/JztcclxuLy8gICAgIHRpdGxlLnBldHMgPSAnzprOsc+Ezr/Ouc66zq/OtM65zrEnO1xyXG4vLyAgICAgdGl0bGUudmlldyA9ICfOmM6tzrEnO1xyXG4vLyAgICAgdGl0bGUuaGVhdGluZyA9ICfOmM6tz4HOvM6xzr3Pg863JztcclxuLy8gICAgIHRpdGxlLmNvb2xpbmcgPSAnzqjPjc6+zrcnO1xyXG4vLyAgICAgdGl0bGUuY29udGFjdEluZm8gPSAnzqPPhM6/zrnPh861zq/OsSDOlc+AzrnOus6/zrnOvc+Jzr3Or86xz4InO1xyXG4vLyAgICAgdGl0bGUubmFtZSA9ICfOjM69zr/OvM6xJztcclxuLy8gICAgIHRpdGxlLmxhc3RuYW1lID0gJ86Vz4DOr864zrXPhM6/JztcclxuLy8gICAgIHRpdGxlLnBob25lID0gJ86kzrfOu86tz4bPic69zr8nO1xyXG4vLyAgICAgdGl0bGUuZW1haWwgPSAnzpfOu861zrrPhM+Bzr/Ovc65zrrOriDOlM65zrXPjc64z4XOvc+DzrcnO1xyXG4vLyAgIH0gZWxzZSB7XHJcbi8vICAgICB0aXRsZS5naWQgPSAnRXN0YXRlIENvZGUnO1xyXG4vLyAgICAgdGl0bGUudHlwZSA9ICdQcm9wZXJ0eSBUeXBlJztcclxuLy8gICAgIHRpdGxlLmxpc3RpbmdfdHlwZSA9ICdMaXN0aW5nIFR5cGUnO1xyXG4vLyAgICAgdGl0bGUuYXJlYSA9ICdTaXplJztcclxuLy8gICAgIHRpdGxlLmFkZHJlc3MgPSAnQWRkcmVzcyc7XHJcbi8vICAgICB0aXRsZS5iZWRyb29tcyA9ICdCZWRyb29tcyc7XHJcbi8vICAgICB0aXRsZS5wcmljZSA9ICdQcmljZSc7XHJcbi8vICAgICB0aXRsZS5pc25ldyA9ICdOZXdseSBCdWlsZCc7XHJcbi8vICAgICB0aXRsZS5wYXJraW5nID0gJ1BhcmtpbmcnO1xyXG4vLyAgICAgdGl0bGUuZnVybmlzaGVkID0gJ0Z1cm5pc2hlZCc7XHJcbi8vICAgICB0aXRsZS5wZXRzID0gJ1BldHMgQWxsb3dlZCc7XHJcbi8vICAgICB0aXRsZS52aWV3ID0gJ1ZpZXcnO1xyXG4vLyAgICAgdGl0bGUuaGVhdGluZyA9ICdIZWF0aW5nJztcclxuLy8gICAgIHRpdGxlLmNvb2xpbmcgPSAnQ29vbGluZyc7XHJcbi8vICAgICB0aXRsZS5jb250YWN0SW5mbyA9ICdDb250YWN0IEluZm8nO1xyXG4vLyAgICAgdGl0bGUubmFtZSA9ICdOYW1lJztcclxuLy8gICAgIHRpdGxlLmxhc3RuYW1lID0gJ0xhc3QgTmFtZSc7XHJcbi8vICAgICB0aXRsZS5waG9uZSA9ICdUZWxlcGhvbmUnO1xyXG4vLyAgICAgdGl0bGUuZW1haWwgPSAnRW1haWwnO1xyXG4vLyAgIH1cclxuLy8gICBjbGlja2VkRmVhdHVyZSA9IG1hcC5mb3JFYWNoRmVhdHVyZUF0UGl4ZWwoZXZ0LnBpeGVsLCBmdW5jdGlvbiAoZmVhdHVyZSwgbGF5ZXIpIHtcclxuLy8gICAgIHJldHVybiB7XHJcbi8vICAgICAgIGZlYXR1cmU6IGZlYXR1cmUsXHJcbi8vICAgICAgIGxheWVyOiBsYXllclxyXG4vLyAgICAgfTtcclxuLy8gICB9LCB0aGlzLCBmdW5jdGlvbiAobGF5ZXIpIHtcclxuLy8gICAgIGlmIChsYXllci5nZXQoJ2lkJykgPT09ICdlc3RhdGVzJyB8fCBsYXllci5nZXQoJ2lkJykgPT09ICdmaWx0ZXJlZEVzdGF0ZXMnKSB7XHJcbi8vICAgICAgIHJldHVybiB0cnVlO1xyXG4vLyAgICAgfVxyXG4vLyAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAgIH0sIHRoaXMpO1xyXG4vLyAgIGlmIChjbGlja2VkRmVhdHVyZSkge1xyXG4vLyAgICAgaWYgKGNsaWNrZWRGZWF0dXJlLmxheWVyLmdldCgnaWQnKSA9PT0gJ2VzdGF0ZXMnICYmIGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuZ2V0KCdmZWF0dXJlcycpLmxlbmd0aCA9PT0gMSkge1xyXG4vLyAgICAgICBmID0gY2xpY2tlZEZlYXR1cmUuZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkuZmVhdHVyZXNbMF07XHJcbi8vICAgICAgIGNyZWF0ZVBTQWFuZENhcmQoZiwgb2JqKTtcclxuLy8gICAgIH0gZWxzZSBpZiAoY2xpY2tlZEZlYXR1cmUubGF5ZXIuZ2V0KCdpZCcpID09PSAnZmlsdGVyZWRFc3RhdGVzJykge1xyXG4vLyAgICAgICBmID0gY2xpY2tlZEZlYXR1cmUuZmVhdHVyZTtcclxuLy8gICAgICAgY3JlYXRlUFNBYW5kQ2FyZChmLCBvYmopO1xyXG4vLyAgICAgfVxyXG4vLyAgIH0gZWxzZSB7XHJcbi8vICAgICBQU0Euc2V0U291cmNlKG51bGwpO1xyXG4vLyAgIH1cclxuLy8gfVxyXG5cclxuLy8gZnVuY3Rpb24gY3JlYXRlUFNBYW5kQ2FyZChmLCBvYmopIHtcclxuLy8gICB2YXIgZmVhdHVyZSA9IHt9O1xyXG4gIC8vIGZlYXR1cmUuZ2lkID0gZi5nZXQoJ2dpZCcpO1xyXG4gIC8vIGZlYXR1cmUuYXJlYSA9IGYuZ2V0KCdlc3RhdGVhcmVhJyk7XHJcbi8vICAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuLy8gICAgIGZlYXR1cmUudHlwZSA9IGYuZ2V0KCdlc3RhdGV0eXBlJyk7XHJcbi8vICAgICBmZWF0dXJlLmFkZHJlc3MgPSBmLmdldCgnc3RyZWV0X2VsJykgKyAnICcgKyBmLmdldCgnc3RyZWV0X251bWJlcicpO1xyXG4vLyAgICAgZmVhdHVyZS5uYW1lID0gZi5nZXQoJ25hbWVfZWwnKTtcclxuLy8gICAgIGZlYXR1cmUubGFzdG5hbWUgPSBmLmdldCgnbGFzdG5hbWVfZWwnKTtcclxuLy8gICAgIGlmIChmLmdldCgnc2FsZScpID09PSB0cnVlKSB7XHJcbi8vICAgICAgIGZlYXR1cmUubGlzdGluZ190eXBlID0gJ86gz47Ou863z4POtyc7XHJcbi8vICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICBmZWF0dXJlLmxpc3RpbmdfdHlwZSA9ICfOlc69zr/Ouc66zq/Osc+DzrcnO1xyXG4vLyAgICAgfVxyXG4vLyAgICAgZmVhdHVyZS5idG5zID0ge1xyXG4vLyAgICAgICBpbmZvOiAnz4DOu863z4HOv8+Gzr/Pgc65zrXPgicsXHJcbi8vICAgICAgIGNsb3NlOiAnzrrOu861zrnPg865zrzOvydcclxuLy8gICAgIH07XHJcbi8vICAgfSBlbHNlIHtcclxuLy8gICAgIGZlYXR1cmUudHlwZSA9IGYuZ2V0KCdlc3RhdGV0eXBlX2VuJyk7XHJcbi8vICAgICBmZWF0dXJlLmFkZHJlc3MgPSBmLmdldCgnc3RyZWV0X2VuJykgKyAnICcgKyBmLmdldCgnc3RyZWV0X251bWJlcicpO1xyXG4vLyAgICAgZmVhdHVyZS5uYW1lID0gZi5nZXQoJ25hbWVfZW4nKTtcclxuLy8gICAgIGZlYXR1cmUubGFzdG5hbWUgPSBmLmdldCgnbGFzdG5hbWVfZW4nKTtcclxuLy8gICAgIGlmIChmLmdldCgnc2FsZScpID09PSB0cnVlKSB7XHJcbi8vICAgICAgIGZlYXR1cmUubGlzdGluZ190eXBlID0gJ1NhbGUnO1xyXG4vLyAgICAgfSBlbHNlIHtcclxuLy8gICAgICAgZmVhdHVyZS5saXN0aW5nX3R5cGUgPSAnUmVudCc7XHJcbi8vICAgICB9XHJcbi8vICAgICBmZWF0dXJlLmJ0bnMgPSB7XHJcbi8vICAgICAgIGluZm86ICdpbmZvJyxcclxuLy8gICAgICAgY2xvc2U6ICdjbG9zZSdcclxuLy8gICAgIH07XHJcbi8vICAgfVxyXG4vLyAgIGZlYXR1cmUuYmVkcm9vbXMgPSBmLmdldCgnYmVkcm9vbXMnKTtcclxuLy8gICBmZWF0dXJlLnByaWNlID0gZi5nZXQoJ3ByaWNlJyk7XHJcbi8vICAgZmVhdHVyZS5pc25ldyA9IGYuZ2V0KCdpc25ldycpO1xyXG4vLyAgIGZlYXR1cmUucGFya2luZyA9IGYuZ2V0KCdwYXJraW5nJyk7XHJcbi8vICAgZmVhdHVyZS5mdXJuaXNoZWQgPSBmLmdldCgnZnVybmlzaGVkJyk7XHJcbi8vICAgZmVhdHVyZS5wZXRzID0gZi5nZXQoJ3BldHMnKTtcclxuLy8gICBmZWF0dXJlLnZpZXcgPSBmLmdldCgndmlldycpO1xyXG4vLyAgIGZlYXR1cmUuaGVhdGluZyA9IGYuZ2V0KCdoZWF0aW5nJyk7XHJcbi8vICAgZmVhdHVyZS5jb29saW5nID0gZi5nZXQoJ2Nvb2xpbmcnKTtcclxuLy8gICBmZWF0dXJlLnBob25lID0gZi5nZXQoJ3Bob25lMScpO1xyXG4vLyAgIGZlYXR1cmUuZW1haWwgPSBmLmdldCgnZW1haWwnKTtcclxuLy8gICBmZWF0dXJlLmNvb3JkaW5hdGUgPSBmLmdldCgnZ2VvbWV0cnknKS5nZXRDb29yZGluYXRlcygpO1xyXG5cclxuLy8gICB2YXIgUFNBU291cmNlID0gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4vLyAgICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuLy8gICAgICAgaHRtbDogJ1BPSSBieSAnICsgJzxhIGhyZWY9XCJodHRwOi8vd3d3LnRlcnJhY29nbml0YS5nci9cIj5UZXJyYSBDb2duaXRhPC9hPidcclxuLy8gICAgIH0pXSxcclxuLy8gICAgIGZvcm1hdDogZ2VvSlNPTkZvcm1hdCxcclxuLy8gICAgIGxvYWRlcjogZnVuY3Rpb24gKGV4dGVudCwgcmVzb2x1dGlvbiwgcHJvamVjdGlvbikge1xyXG4vLyAgICAgICB2YXIgdXJsID0gJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi91c2VzLycgKyBmZWF0dXJlLmdpZDtcclxuLy8gICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4vLyAgICAgICAkLmFqYXgoe1xyXG4vLyAgICAgICAgIHVybDogdXJsLFxyXG4vLyAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4vLyAgICAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuLy8gICAgICAgfSkuZG9uZShmdW5jdGlvbiBzdWNjZWRlZChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgIC8vIHZhciBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKGRhdGEucHJvcGVydHlfc2VydmljZXNfYW5hbHlzaXMsIHtcclxuICAgICAgICAvLyAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICAgIC8vIH0pO1xyXG4gICAgICAgIC8vIHZhciBmZWF0dXJlc0xlbmd0aCA9IGZlYXR1cmVzLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgLy8gdmFyIGFyZWEgPSBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICAgIC8vICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgIC8vICAgICBjb2xvcjogWzE1NiwgMzksIDE3NiwgMC4xXVxyXG4gICAgICAgIC8vICAgfSlcclxuICAgICAgICAvLyB9KTtcclxuICAgICAgICAvLyBmZWF0dXJlc1swXS5zZXRTdHlsZShhcmVhKTtcclxuICAgICAgICAvLyBzZWxmLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuLy8gICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuLy8gICAgICAgICB0b2FzdHIuaW5mbygnRm91bmQgJyArIGZlYXR1cmVzTGVuZ3RoICsgJyBQb2ludHMgb2YgSW50ZXJlc3QgaW4gOCBtaW51dGUgZGlzdGFuY2UhJyk7XHJcbi8vICAgICAgIH0pLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSKSB7XHJcbi8vICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbi8vICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbi8vICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCBhbnkgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4vLyAgICAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuLy8gICAgICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZScpO1xyXG4vLyAgICAgICAgIH0gZWxzZSB7XHJcbi8vICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4vLyAgICAgICAgIH1cclxuLy8gICAgICAgfSk7XHJcbi8vICAgICB9LFxyXG4vLyAgICAgc3RyYXRlZ3k6IG9sLmxvYWRpbmdzdHJhdGVneS5hbGxcclxuLy8gICB9KTtcclxuLy8gICBQU0Euc2V0U291cmNlKFBTQVNvdXJjZSk7XHJcbi8vICAgbWFwLmdldFZpZXcoKS5zZXRDZW50ZXIoZmVhdHVyZS5jb29yZGluYXRlKTtcclxuLy8gICBtYXAuZ2V0VmlldygpLnNldFJlc29sdXRpb24oMS4yKTtcclxuLy8gICBvYmouZmVhdHVyZSA9IGZlYXR1cmU7XHJcblxyXG4vLyAgIGR1c3QucmVuZGVyKCdlc3RhdGVDYXJkcycsIG9iaiwgZnVuY3Rpb24gcmVuZGVyRXN0YXRlQ2FyZHMoZXJyLCBvdXQpIHtcclxuLy8gICAgICQoJy5lc3RhdGUtY2FyZHMnKS5odG1sKG91dCk7XHJcbi8vICAgICAkKCcubWRsLWNhcmRfX3RpdGxlJykuY3NzKCdiYWNrZ3JvdW5kLWltYWdlJywgJ3VybChodHRwOi8vcmVzLmNsb3VkaW5hcnkuY29tL2ZpcnZhaW4vaW1hZ2UvdXBsb2FkL3dfNDMyLGNfc2NhbGUvJyArIG9iai5mZWF0dXJlLmdpZCArICcuanBnKScpO1xyXG4vLyAgICAgJCgnLmVzdGF0ZS1jYXJkcycpLmFkZENsYXNzKCdlc3RhdGUtY2FyZHMtYWN0aXZlJyk7XHJcbi8vICAgLy8gJChcIiNpbmZvYm94XCIpLmFkZENsYXNzKFwidmlzdWFsbHloaWRkZW5cIik7XHJcbi8vICAgfSk7XHJcbi8vICAgJCgnYVtocmVmPVwiI29wZW5Nb2RhbFwiXScpLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuLy8gICAgIGR1c3QucmVuZGVyKCdtb2RhbEluZm8nLCBvYmosIGZ1bmN0aW9uIHJlbmRlck1vZGFsSW5mbyhlcnIsIG91dCkge1xyXG4vLyAgICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuLy8gICAgICAgJCgnLmJpZy1pbWFnZScpLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoaHR0cDovL3Jlcy5jbG91ZGluYXJ5LmNvbS9maXJ2YWluL2ltYWdlL3VwbG9hZC9oXzIyMixjX3NjYWxlLycgKyBvYmouZmVhdHVyZS5naWQgKyAnLmpwZyknKTtcclxuLy8gICAgIH0pO1xyXG4vLyAgIH0pO1xyXG4vLyAgICQoJ2FbaHJlZj1cIiNjbG9zZUVzdGF0ZUNhcmRcIl0nKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbi8vICAgICAkKCcuZXN0YXRlLWNhcmRzJykucmVtb3ZlQ2xhc3MoJ2VzdGF0ZS1jYXJkcy1hY3RpdmUnKTtcclxuLy8gICB9KTtcclxuLy8gfVxyXG4vLyAkKCcjaW5mb3JtYXRpb24nKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xyXG4vLyAgIC8vIFBTQS5zZXRTb3VyY2UobnVsbCk7XHJcbi8vICAgaWYgKCQodGhpcykucHJvcCgnY2hlY2tlZCcpID09PSB0cnVlKSB7XHJcbi8vICAgICBtYXAub24oJ2NsaWNrJywgc2VsZWN0ZWRGZWF0dXJlKTtcclxuLy8gICAgIC8vICQodGhpcykucGFyZW50KCkuc2libGluZ3MoKS5maW5kKCdpbnB1dCcpLmVhY2goZnVuY3Rpb24gKCkgeyQodGhpcykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTt9KTtcclxuLy8gICB9IGVsc2Uge1xyXG4vLyAgICAgbWFwLnVuKCdjbGljaycsIHNlbGVjdGVkRmVhdHVyZSk7XHJcbi8vICAgICAvLyAkKHRoaXMpLnBhcmVudCgpLnNpYmxpbmdzKCkuZmluZCgnaW5wdXQnKS5lYWNoKGZ1bmN0aW9uICgpIHskKHRoaXMpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO30pO1xyXG4vLyAgIH1cclxuLy8gfSk7XHJcbiIsInZhciB0cmFucztcclxudmFyIHVzZXJNYXAgPSAoZnVuY3Rpb24gdXNlck1hcCh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCBteW1hcCwgaW5mbywgZmlsdGVycykge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgY29udGV4dCA9ICdtYXAnO1xyXG4gIHZhciBsYW5nID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmxhbmc7XHJcbiAgLy8gdmFyIGdsb2JhbHMgPSB7fTtcclxuICB2YXIgJGxvYWRpbmcgPSAkKCcubWRsLXNwaW5uZXInKTtcclxuICAkKGRvY3VtZW50KVxyXG4gIC5hamF4U3RhcnQoZnVuY3Rpb24gc3RhcnQoKSB7XHJcbiAgICAkbG9hZGluZy5hZGRDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSlcclxuICAuYWpheFN0b3AoZnVuY3Rpb24gc3RvcCgpIHtcclxuICAgICRsb2FkaW5nLnJlbW92ZUNsYXNzKCdpcy1hY3RpdmUnKTtcclxuICB9KTtcclxuICB0b2FzdHIub3B0aW9ucyA9IHtcclxuICAgIGNsb3NlQnV0dG9uOiBmYWxzZSxcclxuICAgIGRlYnVnOiBmYWxzZSxcclxuICAgIG5ld2VzdE9uVG9wOiBmYWxzZSxcclxuICAgIHByb2dyZXNzQmFyOiBmYWxzZSxcclxuICAgIHBvc2l0aW9uQ2xhc3M6ICd0b2FzdC10b3AtY2VudGVyJyxcclxuICAgIHByZXZlbnREdXBsaWNhdGVzOiBmYWxzZSxcclxuICAgIG9uY2xpY2s6IG51bGwsXHJcbiAgICBzaG93RHVyYXRpb246ICczMDAnLFxyXG4gICAgaGlkZUR1cmF0aW9uOiAnMTAwMCcsXHJcbiAgICB0aW1lT3V0OiAnNTAwMCcsXHJcbiAgICBleHRlbmRlZFRpbWVPdXQ6ICcxMDAwJyxcclxuICAgIHNob3dFYXNpbmc6ICdzd2luZycsXHJcbiAgICBoaWRlRWFzaW5nOiAnbGluZWFyJyxcclxuICAgIHNob3dNZXRob2Q6ICdmYWRlSW4nLFxyXG4gICAgaGlkZU1ldGhvZDogJ2ZhZGVPdXQnXHJcbiAgfTtcclxuXHJcbiAgZnVuY3Rpb24gaW5pdCgpIHtcclxuICAgIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvYXBpL2xhbmd1YWdlJyxcclxuICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICB0eXBlOiBsYW5nLFxyXG4gICAgICAgICAgY29udGV4dDogY29udGV4dFxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgICB2YXIgbWFwO1xyXG4gICAgICAgIHRyYW5zID0gZGF0YTtcclxuICAgICAgICBtYXAgPSBteW1hcC5pbml0aWFsaXplKHRyYW5zKTtcclxuICAgICAgICByZXR1cm4gbWFwO1xyXG4gICAgICB9KVxyXG4gICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKG1hcCkge1xyXG4gICAgICAgIGluZm8uaW5pdChtYXApO1xyXG4gICAgICAgIGZpbHRlcnMuaW5pdChtYXApO1xyXG4gICAgICB9KVxyXG4gICAgICAuZmluYWxseShmdW5jdGlvbiBmaW5pc2goKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2codGhpcyk7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXQ6IGluaXRcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsIGpRdWVyeSwgbXltYXAsIGluZm8sIGZpbHRlcnMpKTtcclxuXHJcblxyXG4vLyBqUXVlcnkoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgkKSB7XHJcbi8vICAgJCgnLnNwaW5uZXInKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuLy8gICAkKCcubWRsLXNwaW5uZXInKS5yZW1vdmVDbGFzcygnaXMtYWN0aXZlJyk7XHJcbi8vICAgLy8gaGFuZGxlU2VsZWN0KCk7XHJcbi8vIH0pO1xyXG5cclxudXNlck1hcC5pbml0KCk7XHJcbiQoJyNhZHZhbmNlZC1maWx0ZXJzJykuY2xpY2soZnVuY3Rpb24gdG9nZ2xlRmlsdGVycygpIHtcclxuICAkKCcjZXN0YXRlLWZpbHRlcnMnKS50b2dnbGVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxufSk7XHJcbi8vICQoJyN0b2dnbGUtcHJpY2UtcmFuZ2UnKS5jbGljayhmdW5jdGlvbiB0b2dnbGVQcmljZVJhbmdlKCkge1xyXG4vLyAgICQoJyNwcmljZS1yYW5nZScpLnRvZ2dsZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4vLyB9KTtcclxuIl19
