var $loading = $('.mdl-spinner');
var center = [3677385, 4120949];
var extent = [3652772, 4112808, 3700000, 4132797];
var lang = document.documentElement.lang;
var styleCache = {};
var geoJSONFormat = new ol.format.GeoJSON({
  defaultDataProjection: 'EPSG:4326'
});
toastr.options = {
  closeButton: false,
  debug: false,
  newestOnTop: false,
  progressBar: false,
  positionClass: 'toast-top-center',
  preventDuplicates: false,
  onclick: null,
  showDuration: '300',
  hideDuration: '1000',
  timeOut: '5000',
  extendedTimeOut: '1000',
  showEasing: 'swing',
  hideEasing: 'linear',
  showMethod: 'fadeIn',
  hideMethod: 'fadeOut'
};
var bing = new ol.layer.Tile({
  visible: true,
  source: new ol.source.BingMaps({
    key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
    imagerySet: 'Aerial'
  }),
  maxZoom: 19,
  crossOrigin: 'anonymous',
  preload: Infinity,
  id: 'bing'
});
var mapbox = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [new ol.Attribution({
      html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
    })],
    url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
  }),
  id: 'mapbox'
});
function getIconType(estateType) {
  var iconType = {
    Apartment: function apartmentIcon() {
      return 'apartment';
    },
    'Detached House': function detachedHouceIcon() {
      return 'detached';
    },
    Villa: function villaIcon() {
      return 'villa';
    },
    Maisonette: function maisonetteIcon() {
      return 'villa';
    }
  };
  return (iconType[estateType])();
}

function getIconPath(listingType) {
  var iconPath = {
    true: function saleIcon() {
      return './images/pins/sale/';
    },
    false: function rentIcon() {
      return './images/pins/rent/';
    }
  };
  return (iconPath[listingType])();
}

function createPropertyStyle(feature) {
  var src;
  src = getIconPath(feature.get('sale')) + getIconType(feature.get('estatetype_en')) + '-48.png';
  return new ol.style.Style({
    geometry: feature.getGeometry(),
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1
    }))
  });
}

function propertyStyleFunction(feature, resolution) {
  var size = feature.get('features').length;
  var style;
  var originalFeature;
  if (size > 1) {
    style = [new ol.style.Style({
      image: new ol.style.Circle({
        radius: 20,
        stroke: new ol.style.Stroke({
          color: [156, 39, 176, 1],
          width: 5
        }),
        fill: new ol.style.Fill({
          color: [68, 138, 255, 0.8]
        })
      }),
      text: new ol.style.Text({
        text: size.toString(),
        fill: new ol.style.Fill({
          color: '#FFFFFF'
        })
      }),
      zIndex: 101
    })];
  } else {
    originalFeature = feature.get('features')[0];
    style = [createPropertyStyle(originalFeature)];
  }
  return style;
}

// function selectStyleFunction(feature, resolution) {
//   var styles = [new ol.style.Style({})];
//   var originalFeatures = feature.get('features');
//   var originaFeature;
//   for (var i = originalFeatures.length - 1; i >= 0; --i) {
//     originalFeature = originalFeatures[i];
//     styles.push(createPropertyStyle(originalFeature));
//   }
//   return styles;
// }
var propertySource = new ol.source.Vector({
  format: geoJSONFormat,
  loader: function featreLoader() {
    var self = this;
    this.clear();
    $.ajax({
      url: 'http://127.0.0.1:3000/db/listed',
      type: 'GET',
      dataType: 'json'
    })
      .done(function succeded(response) {
        var features = geoJSONFormat.readFeatures(response, {
          featureProjection: 'EPSG:3857'
        });
        self.addFeatures(features);
      })
      .fail(function failed(jqXHR, textStatus, errorThrown) {
        toastr.clear();
        if (jqXHR.status === 404) {
          toastr.error('Sorry, we cannot find any properties!');
        } else if (jqXHR.status === 503) {
          toastr.error('Service Unavailable');
        } else {
          toastr.error('Internal Server Error');
        }
      });
  },
  strategy: ol.loadingstrategy.bbox
});
var propertyClusterSource = new ol.source.Cluster({
  distance: 40,
  source: propertySource,
  attributions: [new ol.Attribution({
    html: 'All maps © ' + '<a href="http://www.terracognita.gr/">Terra Cognita</a>'
  })]
});
var property = new ol.layer.Vector({
  source: propertyClusterSource,
  id: 'estates',
  visible: true,
  style: propertyStyleFunction
});
property.setZIndex(2);
var PSAStyleFunction = function (feature, resolution) {
  var symbol = feature.get('style');
  var text;
  if (lang === 'el') {
    text = feature.get('name_el');
  } else {
    text = feature.get('name_en');
  }
  if (!styleCache[symbol]) {
    styleCache = [new ol.style.Style({
      image: new ol.style.Icon(({
        src: '../images/maki/renders/' + symbol + '-24.png',
        anchorOrigin: 'bottom-left',
        anchor: [0.5, 0.5],
        scale: 1
      })),
      text: new ol.style.Text({
        text: text,
        stroke: new ol.style.Stroke({
          color: [156, 39, 176, 0.8],
          width: 1
        }),
        offsetY: 12
      })
    })];
  }
  return styleCache;
};
var PSA = new ol.layer.Vector({
  style: PSAStyleFunction,
  maxResolution: 3
});
PSA.setZIndex(1);

function filteredEsateStyle(feature, resolution) {
  var src;
  src = getIconPath(feature.get('sale')) + getIconType(feature.get('estatetype_en')) + '-64.png';
  styleCache = [new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1
    }))
  })];
  return styleCache;
}
var filteredEstates = new ol.layer.Vector({
  source: new ol.source.Vector({
    format: geoJSONFormat
  }),
  id: 'filteredEstates',
  visible: true,
  style: filteredEsateStyle
});
filteredEstates.setZIndex(2);
var selectSource = new ol.source.Vector({});
var selectBox = new ol.layer.Vector({
  source: selectSource,
  style: new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(227, 72, 27, 0.2)'
    }),
    stroke: new ol.style.Stroke({
      color: '#E3481B',
      width: 2
    }),
    image: new ol.style.Circle({
      radius: 7,
      fill: new ol.style.Fill({
        color: '#E3481B'
      })
    })
  })
});
selectBox.setZIndex(3);
var map = new ol.Map({
  target: 'map',
  layers: [mapbox, property, PSA, filteredEstates, selectBox],
  // interactions: ol.interaction.defaults().extend([new ol.interaction.Select({
  //   condition: function(evt) {
  //     return evt.type === 'singleclick' && ol.events.condition.shiftKeyOnly(evt);
  //   },
  //   style: selectStyleFunction
  // })]),
  loadTilesWhileAnimating: true,
  loadTilesWhileInteracting: true,
  renderer: 'canvas',
  controls: ol.control.defaults({
    attributionOptions: {
      collapsible: false,
      collapsed: false
    }
  })
    .extend([
      new ol.control.ScaleLine({
        units: 'metric'
      }), new ol.control.OverviewMap({
        className: 'ol-overviewmap ol-custom-overviewmap',
        collapsible: true,
        collapsed: true,
        layers: [bing]
      }),
      new ol.control.ZoomToExtent({
        extent: extent
      })
    ]),
  view: new ol.View({
    center: center,
    extent: extent,
    projection: 'EPSG:3857',
    zoom: 14,
    maxZoom: 19,
    minZoom: 14
  })
});
if (lang === 'el') {
  bing.set('name', 'Δορυφορική εικόνα');
  mapbox.set('name', 'Χάρτης');
  property.set('name', 'Ακίνητα');
} else {
  bing.set('name', 'Sattelite Image');
  mapbox.set('name', 'Map');
  property.set('name', 'Properties');
}
jQuery(document).ready(function ($) {
  $('.spinner').addClass('visuallyhidden');
  $('.mdl-spinner').removeClass('is-active');
  // handleSelect();
});
$(document)
  .ajaxStart(function () {
    $loading.addClass('is-active');
  })
  .ajaxStop(function () {
    $loading.removeClass('is-active');
  });

window.app || (window.app = {});
var app = window.app;
app.Filters = function (options) {
  this.estateType = options.estateType;
  this.leaseType = options.leaseType !== undefined ? options.leaseType : 'Rent';
  this.startPrice = options.startPrice !== undefined ? options.startPrice : 0;
  this.endPrice = options.endPrice !== undefined ? options.endPrice : 2147483647;
  this.parking = options.parking !== undefined ? options.parking : false;
  this.furnished = options.furnished !== undefined ? options.furnished : false;
  this.heating = options.heating !== undefined ? options.heating : false;
  this.cooling = options.cooling !== undefined ? options.cooling : false;
  this.view = options.view !== undefined ? options.view : false;
};
app.Filters.prototype.createValidator = function () {
  var p = $('form[name=filters]').parsley();
  return p;
};
app.Filters.prototype.setDefaults = function () {
  var epsg4326Extent;
  PSA.setSource(null);
  if (selectSource.getFeatures().length === 0) {
    epsg4326Extent = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
  } else {
    epsg4326Extent = ol.proj.transformExtent(selectSource.getFeatures()[0]
      .getGeometry().getExtent(), 'EPSG:3857', 'EPSG:4326');
  }
  this.extent = epsg4326Extent;
  this.p = this.createValidator();
};
app.Filters.prototype.ajaxCall = function () {
  if (this.p.validate() === true) {
    $.ajax({
      url: 'http://127.0.0.1:3000/db/listed/filters?bbox[x1]=' + this.extent[0] + '&bbox[y1]=' + this.extent[1] + '&bbox[x2]=' + this.extent[2] + '&bbox[y2]=' + this.extent[3],
      type: 'GET',
      dataType: 'json',
      data: {
        estateType: this.estateType,
        leaseType: this.leaseType,
        furnished: this.furnished,
        heating: this.heating,
        parking: this.parking,
        cooling: this.cooling,
        view: this.view,
        startPrice: this.startPrice,
        endPrice: this.endPrice
      }
    }).done(function succeded(data, textStatus, jqXHR) {
      var features = geoJSONFormat.readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
        toastr.clear();
        filteredEstates.getSource().clear();
        filteredEstates.getSource().addFeatures(features);
        filteredEstates.setVisible(true);
        property.setVisible(false);
        toastr.info('Found ' + features.length + ' properties');
    })
    .fail(function failed(jqXHR) {
      // var a = jQuery.parseJSON(jqXHR.responseText); // response is Json so we need to parse
      toastr.clear();
      if (jqXHR.status === 404) {
        toastr.error('No properties found wit these filters');
      } else if (jqXHR.status === 503) {
        toastr.error('Service Unavailable');
      } else {
        toastr.error('Internal Server Error');
      }
      filteredEstates.setVisible(false);
      property.setVisible(true);
    });
  }
};
$('#invokeFilters').click(function () {
  var filters;
  var options = {};
  options.estateType = $('#estateType').val();
  options.leaseType = $('input[name=options]:checked').val();
  options.startPrice = $('#startPrice').val();
  options.endPrice = $('#endPrice').val();
  options.parking = $('#checkbox-1').prop('checked');
  options.furnished = $('#checkbox-2').prop('checked');
  options.heating = $('#checkbox-3').prop('checked');
  options.cooling = $('#checkbox-4').prop('checked');
  options.view = $('#checkbox-5').prop('checked');
  filters = new app.Filters(options);
  filters.setDefaults();
  filters.ajaxCall();
});
$('#clearFilters').click(function () {
  var orignalEstateTypeValue = $('#estateType option').val();
  var orignalPriceRangeValue = $('#priceSelect option').val();
  $('label[for=option-1]').addClass('is-checked');
  $('label[for=option-2]').removeClass('is-checked');
  $('label[for=checkbox-1]').removeClass('is-checked');
  $('label[for=checkbox-2]').removeClass('is-checked');
  $('label[for=checkbox-3]').removeClass('is-checked');
  $('label[for=checkbox-4]').removeClass('is-checked');
  $('label[for=checkbox-5]').removeClass('is-checked');
  $('label[for=checkbox-6]').removeClass('is-checked');
  $('#estateType').siblings().find('.mdl-selectfield__box-value').html(orignalEstateTypeValue);
  $('#priceSelect').siblings().find('.mdl-selectfield__box-value').html(orignalPriceRangeValue);
  $('#startPrice').parent().eq(0).removeClass('is-dirty');
  $('#endPrice').parent().eq(0).removeClass('is-dirty');
  $('#estateProperties').addClass('estateProperties');
  filteredEstates.getSource().clear();
  property.setVisible(true);
  PSA.setSource(null);
  selectSource.clear();
  map.removeInteraction(draw);
});
var draw;
function addInteraction() {
  selectSource.clear();
  draw = new ol.interaction.Draw({
    source: selectSource,
    type: 'LineString',
    geometryFunction: geometryFunction,
    maxPoints: 2
  });
  draw.on('drawstart', function () {
    selectSource.clear();
  });
  draw.on('drawend', function () {
    map.removeInteraction(draw);
  });
  map.addInteraction(draw);
}
function geometryFunction(coordinates, geometry) {
  if (!geometry) {
    geometry = new ol.geom.Polygon(null);
  }
  var start = coordinates[0];
  var end = coordinates[1];
  geometry.setCoordinates([
    [
      start,
      [
        start[0], end[1]
      ],
      end,
      [
        end[0], start[1]
      ],
      start
    ]
  ]);
  return geometry;
}
$('#checkbox-6').click(function () {
  if (this.checked) {
    addInteraction();
  } else {
    map.removeInteraction(draw);
    selectSource.clear();
  }
});


var handleFilters = (function handleFilters() {
  'use strict';

  function selectRange() {
    $('#priceSelect').change(function (e) {
      var val = $(this).val();
      if (val === 100000) {
        $('#startPrice').val('0').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('100000').parent().eq(0).addClass('is-dirty');
      } else if (val === 150000) {
        $('#startPrice').val('100000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('150000').parent().eq(0).addClass('is-dirty');
      } else if (val === 200000) {
        $('#startPrice').val('150000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('200000').parent().eq(0).addClass('is-dirty');
      } else if (val === 250000) {
        $('#startPrice').val('200000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('250000').parent().eq(0).addClass('is-dirty');
      } else if (val === 300000) {
        $('#startPrice').val('250000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('300000').parent().eq(0).addClass('is-dirty');
      } else {
        $('#startPrice').val('250000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('300000').parent().eq(0).addClass('is-dirty');
      }
    });
  }

  return {
    selectRange: selectRange
  };
}());
function getValueRange(listingType) {
  var saleType = {
    Sale: function sale() {
      $('#priceSelect').change(function (e) {
        var val = $(this).val();
        if (val === '100000') {
          $('#startPrice').val('0').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('100000').parent().eq(0).addClass('is-dirty');
        } else if (val === '150000') {
          $('#startPrice').val('100000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('150000').parent().eq(0).addClass('is-dirty');
        } else if (val === '200000') {
          $('#startPrice').val('150000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('200000').parent().eq(0).addClass('is-dirty');
        } else if (val === '250000') {
          $('#startPrice').val('200000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('250000').parent().eq(0).addClass('is-dirty');
        } else if (val === '300000') {
          $('#startPrice').val('250000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('300000').parent().eq(0).addClass('is-dirty');
        } else {
          $('#startPrice').val('300000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('');
        }
      });
    },
    Rent: function rent() {
      $('#priceSelect').change(function (e) {
        var val = $(this).val();
        if (val === '300') {
          $('#startPrice').val('0').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('300').parent().eq(0).addClass('is-dirty');
        } else if (val === '450') {
          $('#startPrice').val('300').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('450').parent().eq(0).addClass('is-dirty');
        } else if (val === '600') {
          $('#startPrice').val('450').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('600').parent().eq(0).addClass('is-dirty');
        } else {
          $('#startPrice').val('600').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('');
        }
      });
    }
  };
  return (saleType[listingType])();
}
$(function () {
  getValueRange('Rent');
  $('input[type=radio][name=options]').change(function () {
    var value = this.value;
    var type = {
      rangeType: this.value
    };
    $('#startPrice').val('').parent().eq(0).removeClass('is-dirty');
    $('#endPrice').val('').parent().eq(0).removeClass('is-dirty');
    dust.render('valueRange', type, function (error, html) {
      $('.priceSelect').html(html);
      componentHandler.upgradeAllRegistered();
      getValueRange(value);
    });
  }
  );
$('#advanced-filters').on('click', function (event) {
  event.preventDefault();
  if ($('#estateProperties').hasClass('estateProperties')) {
    $('#estateProperties').removeClass('estateProperties');
  } else {
    $('#estateProperties').addClass('estateProperties');
  }
});
});
function preventDotAndSpace(e) {
  var key = e.charCode ? e.charCode : e.keyCode;
  this.innerHTML = key;
  if (key === 46 || key === 32) {
    return false;
  }
}

(function () {
  var geolocation = new ol.Geolocation({
    // take the projection to use from the map's view
    projection: map.getView().getProjection(),
    trackingOptions: {
      maximumAge: 10000,
      enableHighAccuracy: true,
      timeout: 600000
    }
  });
  var accuracyFeature = new ol.Feature();
  geolocation.on('change:accuracyGeometry', function () {
    accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
  });
  var positionFeature = new ol.Feature();
  positionFeature.setStyle(new ol.style.Style({
    image: new ol.style.Circle({
      radius: 6,
      fill: new ol.style.Fill({ color: '#3399CC' }),
      stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
    })
  }));
  // listen to changes in position
  geolocation.on('change:position', function () {
    var coordinates = geolocation.getPosition();
    positionFeature.setGeometry(coordinates
      ? new ol.geom.Point(coordinates)
      : null);
  });
  featuresOverlaySource = new ol.source.Vector({});
  var featuresOverlay = new ol.layer.Vector({ map: map, source: featuresOverlaySource });
  $('.geolocation').on('change', function (e) {
    e.preventDefault();
    if ($(this).prop('checked') === true) {
      geolocation.setTracking(true);
      featuresOverlaySource.addFeatures([positionFeature, accuracyFeature]);
    } else {
      geolocation.setTracking(false);
      featuresOverlaySource.clear();
    }
  });
}());

function handleInfo(evt) {
  var coordinate = evt.coordinate;
  var obj = {};
  var title = {};
  var owner = {};
  var features = [];
  var clickedFeature;
  var f;

  map.removeInteraction(draw);
  evt.preventDefault();
  obj.title = title;
  if (lang === 'el') {
    title.gid = 'Κωδικός Ιδιοκτησίας';
    title.type = 'Είδος Ιδιοκτησίας';
    title.listing_type = 'Τύπος Αγγελίας';
    title.area = 'Εμβαδό';
    title.address = 'Διευθυνση';
    title.bedrooms = 'Υπνοδωμάτια';
    title.price = 'Τιμή';
    title.isnew = 'Νεόδμητο';
    title.parking = 'Στάθμεση';
    title.furnished = 'Επιπλωμένο';
    title.pets = 'Κατοικίδια';
    title.view = 'Θέα';
    title.heating = 'Θέρμανση';
    title.cooling = 'Ψύξη';
    title.contactInfo = 'Στοιχεία Επικοινωνίας';
    title.name = 'Όνομα';
    title.lastname = 'Επίθετο';
    title.phone = 'Τηλέφωνο';
    title.email = 'Ηλεκτρονική Διεύθυνση';
  } else {
    title.gid = 'Estate Code';
    title.type = 'Property Type';
    title.listing_type = 'Listing Type';
    title.area = 'Size';
    title.address = 'Address';
    title.bedrooms = 'Bedrooms';
    title.price = 'Price';
    title.isnew = 'Newly Build';
    title.parking = 'Parking';
    title.furnished = 'Furnished';
    title.pets = 'Pets Allowed';
    title.view = 'View';
    title.heating = 'Heating';
    title.cooling = 'Cooling';
    title.contactInfo = 'Contact Info';
    title.name = 'Name';
    title.lastname = 'Last Name';
    title.phone = 'Telephone';
    title.email = 'Email';
  }
  clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
    return {
      feature: feature,
      layer: layer
    };
  }, this, function (layer) {
    if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
      return true;
    }
    return false;
  }, this);
  if (clickedFeature) {
    if (clickedFeature.layer.get('id') === 'estates' && clickedFeature.feature.get('features').length === 1) {
      f = clickedFeature.feature.getProperties().features[0];
      createPSAandCard(f, obj);
    } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
      f = clickedFeature.feature;
      createPSAandCard(f, obj);
    }
  } else {
    PSA.setSource(null);
  }
}

function createPSAandCard(f, obj) {
  var feature = {};
  feature.gid = f.get('gid');
  feature.area = f.get('estatearea');
  if (lang === 'el') {
    feature.type = f.get('estatetype');
    feature.address = f.get('street_el') + ' ' + f.get('street_number');
    feature.name = f.get('name_el');
    feature.lastname = f.get('lastname_el');
    if (f.get('sale') === true) {
      feature.listing_type = 'Πώληση';
    } else {
      feature.listing_type = 'Ενοικίαση';
    }
    feature.btns = {
      info: 'πληροφοριες',
      close: 'κλεισιμο'
    };
  } else {
    feature.type = f.get('estatetype_en');
    feature.address = f.get('street_en') + ' ' + f.get('street_number');
    feature.name = f.get('name_en');
    feature.lastname = f.get('lastname_en');
    if (f.get('sale') === true) {
      feature.listing_type = 'Sale';
    } else {
      feature.listing_type = 'Rent';
    }
    feature.btns = {
      info: 'info',
      close: 'close'
    };
  }
  feature.bedrooms = f.get('bedrooms');
  feature.price = f.get('price');
  feature.isnew = f.get('isnew');
  feature.parking = f.get('parking');
  feature.furnished = f.get('furnished');
  feature.pets = f.get('pets');
  feature.view = f.get('view');
  feature.heating = f.get('heating');
  feature.cooling = f.get('cooling');
  feature.phone = f.get('phone1');
  feature.email = f.get('email');
  feature.coordinate = f.get('geometry').getCoordinates();

  var PSASource = new ol.source.Vector({
    attributions: [new ol.Attribution({
      html: 'POI by ' + '<a href="http://www.terracognita.gr/">Terra Cognita</a>'
    })],
    format: geoJSONFormat,
    loader: function (extent, resolution, projection) {
      var url = 'http://127.0.0.1:3000/db/uses/' + feature.gid;
      var self = this;
      $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json'
      }).done(function succeded(data, textStatus, jqXHR) {
        var features = geoJSONFormat.readFeatures(data.property_services_analysis, {
          featureProjection: 'EPSG:3857'
        });
        var featuresLength = features.length - 1;
        var area = new ol.style.Style({
          fill: new ol.style.Fill({
            color: [156, 39, 176, 0.1]
          })
        });
        features[0].setStyle(area);
        self.addFeatures(features);
        toastr.clear();
        toastr.info('Found ' + featuresLength + ' Points of Interest in 8 minute distance!');
      }).fail(function failed(jqXHR) {
        toastr.clear();
        if (jqXHR.status === 404) {
          toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
        } else if (jqXHR.status === 503) {
          toastr.error('Service Unavailable');
        } else {
          toastr.error('Internal Server Error');
        }
      });
    },
    strategy: ol.loadingstrategy.all
  });
  PSA.setSource(PSASource);
  map.getView().setCenter(feature.coordinate);
  map.getView().setResolution(1.2);
  obj.feature = feature;

  dust.render('estateCards', obj, function renderEstateCards(err, out) {
    $('.estate-cards').html(out);
    $('.mdl-card__title').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/w_432,c_scale/' + obj.feature.gid + '.jpg)');
    $('.estate-cards').addClass('estate-cards-active');
  // $("#infobox").addClass("visuallyhidden");
  });
  $('a[href="#openModal"]').click(function () {
    dust.render('modalInfo', obj, function renderModalInfo(err, out) {
      $('.modal-content').html(out);
      $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + obj.feature.gid + '.jpg)');
    });
  });
  $('a[href="#closeEstateCard"]').click(function () {
    $('.estate-cards').removeClass('estate-cards-active');
  });
}
$('#information').on('click', function (e) {
  PSA.setSource(null);
  if ($(this).prop('checked') === true) {
    map.on('click', handleInfo);
    $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', true);});
  } else {
    map.un('click', handleInfo);
    $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', false);});
  }
});

(function () {
  var marker = new ol.Feature();
  var iconStyle = new ol.style.Style({
    image: new ol.style.Icon(/** @type {olx.style.IconOptions} */
    ({
      anchor: [
        0.5, 1
      ],
      anchorXUnits: 'fraction',
      anchorYUnits: 'fraction',
      opacity: 1,
      scale: 1,
      src: '../images/map-icons/pins/24/pin1.png',
      snapToPixel: false
    })),
    zIndex: 100
  });
  marker.setStyle(iconStyle);
  var featuresOverlayStyle = new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: '#408080',
      width: 5,
      lineDash: [4, 4]
    })
  });
  var featuresOverlay = new ol.layer.Vector({
    map: map,
    source: new ol.source.Vector(),
    style: featuresOverlayStyle,
    id: 'route',
    nameEl: 'Διαδρομή',
    NameEn: 'Route'
  });
  var routeCoords = [];
  function handleMarker(event) {
    event.preventDefault();
    var featureCount = featuresOverlay.getSource().getFeatures().length;
    var coordinates = event.coordinate;
    if (featureCount === 0) {
      marker.setGeometry(new ol.geom.Point(coordinates));
      marker.setId('first');
      featuresOverlay.getSource().addFeature(marker);
      routeCoords[0] = coordinates[0];
      routeCoords[1] = coordinates[1];
    } else if (featureCount === 1) {
      var clone = marker.clone();
      clone.setGeometry(new ol.geom.Point(coordinates));
      clone.setId('second');
      featuresOverlay.getSource().addFeature(clone);
      routeCoords[2] = coordinates[0];
      routeCoords[3] = coordinates[1];
      callRoute(routeCoords);
    } else {
      featuresOverlay.getSource().clear();
    }
  }
  geoJSONFormat = new ol.format.GeoJSON({ defaultDataProjection: 'EPSG:4326', geometryName: 'geometry' });
  function callRoute(routeCoords) {
    var first = ol.proj.transform([
      routeCoords[0], routeCoords[1]
    ], 'EPSG:3857', 'EPSG:4326');
    var second = ol.proj.transform([
      routeCoords[2], routeCoords[3]
    ], 'EPSG:3857', 'EPSG:4326');
    var x1 = first[0];
    var y1 = first[1];
    var x2 = second[0];
    var y2 = second[1];
    $.ajax({
      url: 'https://api.mapbox.com/v4/directions/mapbox.driving/' + x1 + ',' + y1 + ';' + x2 + ',' + y2 + '.json?alternatives=false&access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA',
      type: 'GET',
      dataType: 'json'
    }).done(function (data) {
      var route = {};
      route.type = 'Feature';
      route.geometry = data.routes[0].geometry;
      featuresOverlay.getSource().addFeatures(geoJSONFormat.readFeatures(route, {
        dataProjection: 'EPSG:4326',
        featureProjection: 'EPSG:3857'
      }));
      map.getView().fit(featuresOverlay.getSource().getExtent(), map.getSize());
    }).fail(function () {
      // console.log("error");
    }).always(function () {
      // console.log("complete");
    });
  }
  $('#marker').on('change', function (event) {
    event.preventDefault();
    /* Act on the event */
    if ($(this).prop('checked') === true) {
      map.on('singleclick', handleMarker);
    } else {
      map.un('singleclick', handleMarker);
      featuresOverlay.getSource().clear();
    }
  });
}());

(function () {
  $('#weather').click(function () {
    if ($(this).prop('checked') === true) {
      $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', true);});
      map.getOverlays().forEach(function (ovl) {
        if (ovl.get('name') === 'weather') {
          ($(ovl.getElement()).parent()).remove();
          $(ovl.getElement()).remove();
        }
      });
      var center = ol.proj.transform(map.getView().getCenter(), 'EPSG:3857', 'EPSG:4326');
      var lat = center[1];
      var lon = center[0];
      $.ajax({
        url: 'http://api.openweathermap.org/data/2.5/find?lat=' + lat + '&lon=' + lon + '&cnt=5&cluster=no&units=metric&type=accurate&APPID=f9cd9fa2c427c3b115e87e4862619c5c',
        type: 'GET',
        dataType: 'json'
      }).done(function (data) {
        function createWeatherOverlay(position, index) {
          var elem = document.createElement('div');
          elem.setAttribute('class', 'weather-popup  mdl-shadow--6dp');
          elem.setAttribute('id', index);
          elem.setAttribute('data-name', 'weather');
          return new ol.Overlay({ element: elem, position: position });
        }
        var objs = data.list;
        var overlay,
          coordinates;
        $.each(objs, function (index, val) {
          coordinates = ol.proj.transform([
            val.coord.lon, val.coord.lat
          ], 'EPSG:4326', 'EPSG:3857');
          overlay = createWeatherOverlay(coordinates, index);
          map.addOverlay(overlay);
          overlay.set('name', 'weather');
          weatherData = {
            'name': val.name,
            'temp': val.main.temp,
            'pressure': val.main.pressure,
            'humidity': val.main.humidity
          };
          dust.render('weatherPopup', weatherData, function (err, out) {
            $('#' + index).html(out);
          });
        });
      }).fail(function () {
        // toastr.error("Δεν βρέθηκαν πληροφορίες για τις καιρικές συνθήκες!");
      });
    } else if ($(this).prop('checked') === false) {
      $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', false);});
      map.getOverlays().forEach(function (ovl) {
        if (ovl.get('name') === 'weather') {
          ($(ovl.getElement()).parent()).remove();
          $(ovl.getElement()).remove();
        }
      });
    }
  });
}());

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hcC5qcyIsImZpbHRlcnMuanMiLCJnZW9sb2NhdGlvbi5qcyIsImluZm8uanMiLCJyb3V0aW5nLmpzIiwid2VhdGhlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdFRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdRQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDak1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciAkbG9hZGluZyA9ICQoJy5tZGwtc3Bpbm5lcicpO1xyXG52YXIgY2VudGVyID0gWzM2NzczODUsIDQxMjA5NDldO1xyXG52YXIgZXh0ZW50ID0gWzM2NTI3NzIsIDQxMTI4MDgsIDM3MDAwMDAsIDQxMzI3OTddO1xyXG52YXIgbGFuZyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xyXG52YXIgc3R5bGVDYWNoZSA9IHt9O1xyXG52YXIgZ2VvSlNPTkZvcm1hdCA9IG5ldyBvbC5mb3JtYXQuR2VvSlNPTih7XHJcbiAgZGVmYXVsdERhdGFQcm9qZWN0aW9uOiAnRVBTRzo0MzI2J1xyXG59KTtcclxudG9hc3RyLm9wdGlvbnMgPSB7XHJcbiAgY2xvc2VCdXR0b246IGZhbHNlLFxyXG4gIGRlYnVnOiBmYWxzZSxcclxuICBuZXdlc3RPblRvcDogZmFsc2UsXHJcbiAgcHJvZ3Jlc3NCYXI6IGZhbHNlLFxyXG4gIHBvc2l0aW9uQ2xhc3M6ICd0b2FzdC10b3AtY2VudGVyJyxcclxuICBwcmV2ZW50RHVwbGljYXRlczogZmFsc2UsXHJcbiAgb25jbGljazogbnVsbCxcclxuICBzaG93RHVyYXRpb246ICczMDAnLFxyXG4gIGhpZGVEdXJhdGlvbjogJzEwMDAnLFxyXG4gIHRpbWVPdXQ6ICc1MDAwJyxcclxuICBleHRlbmRlZFRpbWVPdXQ6ICcxMDAwJyxcclxuICBzaG93RWFzaW5nOiAnc3dpbmcnLFxyXG4gIGhpZGVFYXNpbmc6ICdsaW5lYXInLFxyXG4gIHNob3dNZXRob2Q6ICdmYWRlSW4nLFxyXG4gIGhpZGVNZXRob2Q6ICdmYWRlT3V0J1xyXG59O1xyXG52YXIgYmluZyA9IG5ldyBvbC5sYXllci5UaWxlKHtcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5CaW5nTWFwcyh7XHJcbiAgICBrZXk6ICdBazJHcThWVWZJQ3NQcHVmN0xSQU5YbVh0MnNIV21TTFBob2htVkxGdEZJRXdZanNfNU1DeUFoQUZ3UlNWcExqJyxcclxuICAgIGltYWdlcnlTZXQ6ICdBZXJpYWwnXHJcbiAgfSksXHJcbiAgbWF4Wm9vbTogMTksXHJcbiAgY3Jvc3NPcmlnaW46ICdhbm9ueW1vdXMnLFxyXG4gIHByZWxvYWQ6IEluZmluaXR5LFxyXG4gIGlkOiAnYmluZydcclxufSk7XHJcbnZhciBtYXBib3ggPSBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgc291cmNlOiBuZXcgb2wuc291cmNlLlhZWih7XHJcbiAgICBhdHRyaWJ1dGlvbnM6IFtuZXcgb2wuQXR0cmlidXRpb24oe1xyXG4gICAgICBodG1sOiAnPGEgaHJlZj1cImh0dHBzOi8vd3d3Lm1hcGJveC5jb20vYWJvdXQvbWFwcy9cIiB0YXJnZXQ9XCJfYmxhbmtcIj4mY29weTsgTWFwYm94ICZjb3B5OyBPcGVuU3RyZWV0TWFwPC9hPidcclxuICAgIH0pXSxcclxuICAgIHVybDogJ2h0dHBzOi8vYXBpLm1hcGJveC5jb20vdjQvbWFwYm94LnN0cmVldHMve3p9L3t4fS97eX0ucG5nP2FjY2Vzc190b2tlbj1way5leUoxSWpvaVptbHlkbUZwYmlJc0ltRWlPaUpsT1dZeVlUTTBOVGhpTldNMFlqSmpPREpqTkRFNE9EUXpOekEyTUdReU5pSjkuLU5WRE8yN0h6dC13X25Rb3NVUGZMQSdcclxuICB9KSxcclxuICBpZDogJ21hcGJveCdcclxufSk7XHJcbmZ1bmN0aW9uIGdldEljb25UeXBlKGVzdGF0ZVR5cGUpIHtcclxuICB2YXIgaWNvblR5cGUgPSB7XHJcbiAgICBBcGFydG1lbnQ6IGZ1bmN0aW9uIGFwYXJ0bWVudEljb24oKSB7XHJcbiAgICAgIHJldHVybiAnYXBhcnRtZW50JztcclxuICAgIH0sXHJcbiAgICAnRGV0YWNoZWQgSG91c2UnOiBmdW5jdGlvbiBkZXRhY2hlZEhvdWNlSWNvbigpIHtcclxuICAgICAgcmV0dXJuICdkZXRhY2hlZCc7XHJcbiAgICB9LFxyXG4gICAgVmlsbGE6IGZ1bmN0aW9uIHZpbGxhSWNvbigpIHtcclxuICAgICAgcmV0dXJuICd2aWxsYSc7XHJcbiAgICB9LFxyXG4gICAgTWFpc29uZXR0ZTogZnVuY3Rpb24gbWFpc29uZXR0ZUljb24oKSB7XHJcbiAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgcmV0dXJuIChpY29uVHlwZVtlc3RhdGVUeXBlXSkoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0SWNvblBhdGgobGlzdGluZ1R5cGUpIHtcclxuICB2YXIgaWNvblBhdGggPSB7XHJcbiAgICB0cnVlOiBmdW5jdGlvbiBzYWxlSWNvbigpIHtcclxuICAgICAgcmV0dXJuICcuL2ltYWdlcy9waW5zL3NhbGUvJztcclxuICAgIH0sXHJcbiAgICBmYWxzZTogZnVuY3Rpb24gcmVudEljb24oKSB7XHJcbiAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9yZW50Lyc7XHJcbiAgICB9XHJcbiAgfTtcclxuICByZXR1cm4gKGljb25QYXRoW2xpc3RpbmdUeXBlXSkoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlUHJvcGVydHlTdHlsZShmZWF0dXJlKSB7XHJcbiAgdmFyIHNyYztcclxuICBzcmMgPSBnZXRJY29uUGF0aChmZWF0dXJlLmdldCgnc2FsZScpKSArIGdldEljb25UeXBlKGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlX2VuJykpICsgJy00OC5wbmcnO1xyXG4gIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgZ2VvbWV0cnk6IGZlYXR1cmUuZ2V0R2VvbWV0cnkoKSxcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICBzcmM6IHNyYyxcclxuICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICBhbmNob3I6IFswLjUsIDBdLFxyXG4gICAgICBzY2FsZTogMVxyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByb3BlcnR5U3R5bGVGdW5jdGlvbihmZWF0dXJlLCByZXNvbHV0aW9uKSB7XHJcbiAgdmFyIHNpemUgPSBmZWF0dXJlLmdldCgnZmVhdHVyZXMnKS5sZW5ndGg7XHJcbiAgdmFyIHN0eWxlO1xyXG4gIHZhciBvcmlnaW5hbEZlYXR1cmU7XHJcbiAgaWYgKHNpemUgPiAxKSB7XHJcbiAgICBzdHlsZSA9IFtuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkNpcmNsZSh7XHJcbiAgICAgICAgcmFkaXVzOiAyMCxcclxuICAgICAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2Uoe1xyXG4gICAgICAgICAgY29sb3I6IFsxNTYsIDM5LCAxNzYsIDFdLFxyXG4gICAgICAgICAgd2lkdGg6IDVcclxuICAgICAgICB9KSxcclxuICAgICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgICBjb2xvcjogWzY4LCAxMzgsIDI1NSwgMC44XVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pLFxyXG4gICAgICB0ZXh0OiBuZXcgb2wuc3R5bGUuVGV4dCh7XHJcbiAgICAgICAgdGV4dDogc2l6ZS50b1N0cmluZygpLFxyXG4gICAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAgIGNvbG9yOiAnI0ZGRkZGRidcclxuICAgICAgICB9KVxyXG4gICAgICB9KSxcclxuICAgICAgekluZGV4OiAxMDFcclxuICAgIH0pXTtcclxuICB9IGVsc2Uge1xyXG4gICAgb3JpZ2luYWxGZWF0dXJlID0gZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJylbMF07XHJcbiAgICBzdHlsZSA9IFtjcmVhdGVQcm9wZXJ0eVN0eWxlKG9yaWdpbmFsRmVhdHVyZSldO1xyXG4gIH1cclxuICByZXR1cm4gc3R5bGU7XHJcbn1cclxuXHJcbi8vIGZ1bmN0aW9uIHNlbGVjdFN0eWxlRnVuY3Rpb24oZmVhdHVyZSwgcmVzb2x1dGlvbikge1xyXG4vLyAgIHZhciBzdHlsZXMgPSBbbmV3IG9sLnN0eWxlLlN0eWxlKHt9KV07XHJcbi8vICAgdmFyIG9yaWdpbmFsRmVhdHVyZXMgPSBmZWF0dXJlLmdldCgnZmVhdHVyZXMnKTtcclxuLy8gICB2YXIgb3JpZ2luYUZlYXR1cmU7XHJcbi8vICAgZm9yICh2YXIgaSA9IG9yaWdpbmFsRmVhdHVyZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHtcclxuLy8gICAgIG9yaWdpbmFsRmVhdHVyZSA9IG9yaWdpbmFsRmVhdHVyZXNbaV07XHJcbi8vICAgICBzdHlsZXMucHVzaChjcmVhdGVQcm9wZXJ0eVN0eWxlKG9yaWdpbmFsRmVhdHVyZSkpO1xyXG4vLyAgIH1cclxuLy8gICByZXR1cm4gc3R5bGVzO1xyXG4vLyB9XHJcbnZhciBwcm9wZXJ0eVNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuICBmb3JtYXQ6IGdlb0pTT05Gb3JtYXQsXHJcbiAgbG9hZGVyOiBmdW5jdGlvbiBmZWF0cmVMb2FkZXIoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB0aGlzLmNsZWFyKCk7XHJcbiAgICAkLmFqYXgoe1xyXG4gICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvbGlzdGVkJyxcclxuICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgIH0pXHJcbiAgICAgIC5kb25lKGZ1bmN0aW9uIHN1Y2NlZGVkKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgdmFyIGZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMocmVzcG9uc2UsIHtcclxuICAgICAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYuYWRkRmVhdHVyZXMoZmVhdHVyZXMpO1xyXG4gICAgICB9KVxyXG4gICAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCBhbnkgcHJvcGVydGllcyEnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gIH0sXHJcbiAgc3RyYXRlZ3k6IG9sLmxvYWRpbmdzdHJhdGVneS5iYm94XHJcbn0pO1xyXG52YXIgcHJvcGVydHlDbHVzdGVyU291cmNlID0gbmV3IG9sLnNvdXJjZS5DbHVzdGVyKHtcclxuICBkaXN0YW5jZTogNDAsXHJcbiAgc291cmNlOiBwcm9wZXJ0eVNvdXJjZSxcclxuICBhdHRyaWJ1dGlvbnM6IFtuZXcgb2wuQXR0cmlidXRpb24oe1xyXG4gICAgaHRtbDogJ0FsbCBtYXBzIMKpICcgKyAnPGEgaHJlZj1cImh0dHA6Ly93d3cudGVycmFjb2duaXRhLmdyL1wiPlRlcnJhIENvZ25pdGE8L2E+J1xyXG4gIH0pXVxyXG59KTtcclxudmFyIHByb3BlcnR5ID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgc291cmNlOiBwcm9wZXJ0eUNsdXN0ZXJTb3VyY2UsXHJcbiAgaWQ6ICdlc3RhdGVzJyxcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHN0eWxlOiBwcm9wZXJ0eVN0eWxlRnVuY3Rpb25cclxufSk7XHJcbnByb3BlcnR5LnNldFpJbmRleCgyKTtcclxudmFyIFBTQVN0eWxlRnVuY3Rpb24gPSBmdW5jdGlvbiAoZmVhdHVyZSwgcmVzb2x1dGlvbikge1xyXG4gIHZhciBzeW1ib2wgPSBmZWF0dXJlLmdldCgnc3R5bGUnKTtcclxuICB2YXIgdGV4dDtcclxuICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgdGV4dCA9IGZlYXR1cmUuZ2V0KCduYW1lX2VsJyk7XHJcbiAgfSBlbHNlIHtcclxuICAgIHRleHQgPSBmZWF0dXJlLmdldCgnbmFtZV9lbicpO1xyXG4gIH1cclxuICBpZiAoIXN0eWxlQ2FjaGVbc3ltYm9sXSkge1xyXG4gICAgc3R5bGVDYWNoZSA9IFtuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICBzcmM6ICcuLi9pbWFnZXMvbWFraS9yZW5kZXJzLycgKyBzeW1ib2wgKyAnLTI0LnBuZycsXHJcbiAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgIGFuY2hvcjogWzAuNSwgMC41XSxcclxuICAgICAgICBzY2FsZTogMVxyXG4gICAgICB9KSksXHJcbiAgICAgIHRleHQ6IG5ldyBvbC5zdHlsZS5UZXh0KHtcclxuICAgICAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XHJcbiAgICAgICAgICBjb2xvcjogWzE1NiwgMzksIDE3NiwgMC44XSxcclxuICAgICAgICAgIHdpZHRoOiAxXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgb2Zmc2V0WTogMTJcclxuICAgICAgfSlcclxuICAgIH0pXTtcclxuICB9XHJcbiAgcmV0dXJuIHN0eWxlQ2FjaGU7XHJcbn07XHJcbnZhciBQU0EgPSBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICBzdHlsZTogUFNBU3R5bGVGdW5jdGlvbixcclxuICBtYXhSZXNvbHV0aW9uOiAzXHJcbn0pO1xyXG5QU0Euc2V0WkluZGV4KDEpO1xyXG5cclxuZnVuY3Rpb24gZmlsdGVyZWRFc2F0ZVN0eWxlKGZlYXR1cmUsIHJlc29sdXRpb24pIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9IGdldEljb25QYXRoKGZlYXR1cmUuZ2V0KCdzYWxlJykpICsgZ2V0SWNvblR5cGUoZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGVfZW4nKSkgKyAnLTY0LnBuZyc7XHJcbiAgc3R5bGVDYWNoZSA9IFtuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgIHNjYWxlOiAxXHJcbiAgICB9KSlcclxuICB9KV07XHJcbiAgcmV0dXJuIHN0eWxlQ2FjaGU7XHJcbn1cclxudmFyIGZpbHRlcmVkRXN0YXRlcyA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0XHJcbiAgfSksXHJcbiAgaWQ6ICdmaWx0ZXJlZEVzdGF0ZXMnLFxyXG4gIHZpc2libGU6IHRydWUsXHJcbiAgc3R5bGU6IGZpbHRlcmVkRXNhdGVTdHlsZVxyXG59KTtcclxuZmlsdGVyZWRFc3RhdGVzLnNldFpJbmRleCgyKTtcclxudmFyIHNlbGVjdFNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHt9KTtcclxudmFyIHNlbGVjdEJveCA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gIHNvdXJjZTogc2VsZWN0U291cmNlLFxyXG4gIHN0eWxlOiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICBjb2xvcjogJ3JnYmEoMjI3LCA3MiwgMjcsIDAuMiknXHJcbiAgICB9KSxcclxuICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XHJcbiAgICAgIGNvbG9yOiAnI0UzNDgxQicsXHJcbiAgICAgIHdpZHRoOiAyXHJcbiAgICB9KSxcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuQ2lyY2xlKHtcclxuICAgICAgcmFkaXVzOiA3LFxyXG4gICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgY29sb3I6ICcjRTM0ODFCJ1xyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9KVxyXG59KTtcclxuc2VsZWN0Qm94LnNldFpJbmRleCgzKTtcclxudmFyIG1hcCA9IG5ldyBvbC5NYXAoe1xyXG4gIHRhcmdldDogJ21hcCcsXHJcbiAgbGF5ZXJzOiBbbWFwYm94LCBwcm9wZXJ0eSwgUFNBLCBmaWx0ZXJlZEVzdGF0ZXMsIHNlbGVjdEJveF0sXHJcbiAgLy8gaW50ZXJhY3Rpb25zOiBvbC5pbnRlcmFjdGlvbi5kZWZhdWx0cygpLmV4dGVuZChbbmV3IG9sLmludGVyYWN0aW9uLlNlbGVjdCh7XHJcbiAgLy8gICBjb25kaXRpb246IGZ1bmN0aW9uKGV2dCkge1xyXG4gIC8vICAgICByZXR1cm4gZXZ0LnR5cGUgPT09ICdzaW5nbGVjbGljaycgJiYgb2wuZXZlbnRzLmNvbmRpdGlvbi5zaGlmdEtleU9ubHkoZXZ0KTtcclxuICAvLyAgIH0sXHJcbiAgLy8gICBzdHlsZTogc2VsZWN0U3R5bGVGdW5jdGlvblxyXG4gIC8vIH0pXSksXHJcbiAgbG9hZFRpbGVzV2hpbGVBbmltYXRpbmc6IHRydWUsXHJcbiAgbG9hZFRpbGVzV2hpbGVJbnRlcmFjdGluZzogdHJ1ZSxcclxuICByZW5kZXJlcjogJ2NhbnZhcycsXHJcbiAgY29udHJvbHM6IG9sLmNvbnRyb2wuZGVmYXVsdHMoe1xyXG4gICAgYXR0cmlidXRpb25PcHRpb25zOiB7XHJcbiAgICAgIGNvbGxhcHNpYmxlOiBmYWxzZSxcclxuICAgICAgY29sbGFwc2VkOiBmYWxzZVxyXG4gICAgfVxyXG4gIH0pXHJcbiAgICAuZXh0ZW5kKFtcclxuICAgICAgbmV3IG9sLmNvbnRyb2wuU2NhbGVMaW5lKHtcclxuICAgICAgICB1bml0czogJ21ldHJpYydcclxuICAgICAgfSksIG5ldyBvbC5jb250cm9sLk92ZXJ2aWV3TWFwKHtcclxuICAgICAgICBjbGFzc05hbWU6ICdvbC1vdmVydmlld21hcCBvbC1jdXN0b20tb3ZlcnZpZXdtYXAnLFxyXG4gICAgICAgIGNvbGxhcHNpYmxlOiB0cnVlLFxyXG4gICAgICAgIGNvbGxhcHNlZDogdHJ1ZSxcclxuICAgICAgICBsYXllcnM6IFtiaW5nXVxyXG4gICAgICB9KSxcclxuICAgICAgbmV3IG9sLmNvbnRyb2wuWm9vbVRvRXh0ZW50KHtcclxuICAgICAgICBleHRlbnQ6IGV4dGVudFxyXG4gICAgICB9KVxyXG4gICAgXSksXHJcbiAgdmlldzogbmV3IG9sLlZpZXcoe1xyXG4gICAgY2VudGVyOiBjZW50ZXIsXHJcbiAgICBleHRlbnQ6IGV4dGVudCxcclxuICAgIHByb2plY3Rpb246ICdFUFNHOjM4NTcnLFxyXG4gICAgem9vbTogMTQsXHJcbiAgICBtYXhab29tOiAxOSxcclxuICAgIG1pblpvb206IDE0XHJcbiAgfSlcclxufSk7XHJcbmlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgYmluZy5zZXQoJ25hbWUnLCAnzpTOv8+Bz4XPhs6/z4HOuc66zq4gzrXOuc66z4zOvc6xJyk7XHJcbiAgbWFwYm94LnNldCgnbmFtZScsICfOp86sz4HPhM63z4InKTtcclxuICBwcm9wZXJ0eS5zZXQoJ25hbWUnLCAnzpHOus6vzr3Ot8+EzrEnKTtcclxufSBlbHNlIHtcclxuICBiaW5nLnNldCgnbmFtZScsICdTYXR0ZWxpdGUgSW1hZ2UnKTtcclxuICBtYXBib3guc2V0KCduYW1lJywgJ01hcCcpO1xyXG4gIHByb3BlcnR5LnNldCgnbmFtZScsICdQcm9wZXJ0aWVzJyk7XHJcbn1cclxualF1ZXJ5KGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoJCkge1xyXG4gICQoJy5zcGlubmVyJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgJCgnLm1kbC1zcGlubmVyJykucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIC8vIGhhbmRsZVNlbGVjdCgpO1xyXG59KTtcclxuJChkb2N1bWVudClcclxuICAuYWpheFN0YXJ0KGZ1bmN0aW9uICgpIHtcclxuICAgICRsb2FkaW5nLmFkZENsYXNzKCdpcy1hY3RpdmUnKTtcclxuICB9KVxyXG4gIC5hamF4U3RvcChmdW5jdGlvbiAoKSB7XHJcbiAgICAkbG9hZGluZy5yZW1vdmVDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSk7XHJcbiIsIndpbmRvdy5hcHAgfHwgKHdpbmRvdy5hcHAgPSB7fSk7XHJcbnZhciBhcHAgPSB3aW5kb3cuYXBwO1xyXG5hcHAuRmlsdGVycyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgdGhpcy5lc3RhdGVUeXBlID0gb3B0aW9ucy5lc3RhdGVUeXBlO1xyXG4gIHRoaXMubGVhc2VUeXBlID0gb3B0aW9ucy5sZWFzZVR5cGUgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubGVhc2VUeXBlIDogJ1JlbnQnO1xyXG4gIHRoaXMuc3RhcnRQcmljZSA9IG9wdGlvbnMuc3RhcnRQcmljZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zdGFydFByaWNlIDogMDtcclxuICB0aGlzLmVuZFByaWNlID0gb3B0aW9ucy5lbmRQcmljZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5lbmRQcmljZSA6IDIxNDc0ODM2NDc7XHJcbiAgdGhpcy5wYXJraW5nID0gb3B0aW9ucy5wYXJraW5nICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnBhcmtpbmcgOiBmYWxzZTtcclxuICB0aGlzLmZ1cm5pc2hlZCA9IG9wdGlvbnMuZnVybmlzaGVkICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZ1cm5pc2hlZCA6IGZhbHNlO1xyXG4gIHRoaXMuaGVhdGluZyA9IG9wdGlvbnMuaGVhdGluZyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5oZWF0aW5nIDogZmFsc2U7XHJcbiAgdGhpcy5jb29saW5nID0gb3B0aW9ucy5jb29saW5nICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvb2xpbmcgOiBmYWxzZTtcclxuICB0aGlzLnZpZXcgPSBvcHRpb25zLnZpZXcgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmlldyA6IGZhbHNlO1xyXG59O1xyXG5hcHAuRmlsdGVycy5wcm90b3R5cGUuY3JlYXRlVmFsaWRhdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBwID0gJCgnZm9ybVtuYW1lPWZpbHRlcnNdJykucGFyc2xleSgpO1xyXG4gIHJldHVybiBwO1xyXG59O1xyXG5hcHAuRmlsdGVycy5wcm90b3R5cGUuc2V0RGVmYXVsdHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGVwc2c0MzI2RXh0ZW50O1xyXG4gIFBTQS5zZXRTb3VyY2UobnVsbCk7XHJcbiAgaWYgKHNlbGVjdFNvdXJjZS5nZXRGZWF0dXJlcygpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgZXBzZzQzMjZFeHRlbnQgPSBvbC5wcm9qLnRyYW5zZm9ybUV4dGVudChleHRlbnQsICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGVwc2c0MzI2RXh0ZW50ID0gb2wucHJvai50cmFuc2Zvcm1FeHRlbnQoc2VsZWN0U291cmNlLmdldEZlYXR1cmVzKClbMF1cclxuICAgICAgLmdldEdlb21ldHJ5KCkuZ2V0RXh0ZW50KCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgfVxyXG4gIHRoaXMuZXh0ZW50ID0gZXBzZzQzMjZFeHRlbnQ7XHJcbiAgdGhpcy5wID0gdGhpcy5jcmVhdGVWYWxpZGF0b3IoKTtcclxufTtcclxuYXBwLkZpbHRlcnMucHJvdG90eXBlLmFqYXhDYWxsID0gZnVuY3Rpb24gKCkge1xyXG4gIGlmICh0aGlzLnAudmFsaWRhdGUoKSA9PT0gdHJ1ZSkge1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RlZC9maWx0ZXJzP2Jib3hbeDFdPScgKyB0aGlzLmV4dGVudFswXSArICcmYmJveFt5MV09JyArIHRoaXMuZXh0ZW50WzFdICsgJyZiYm94W3gyXT0nICsgdGhpcy5leHRlbnRbMl0gKyAnJmJib3hbeTJdPScgKyB0aGlzLmV4dGVudFszXSxcclxuICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBlc3RhdGVUeXBlOiB0aGlzLmVzdGF0ZVR5cGUsXHJcbiAgICAgICAgbGVhc2VUeXBlOiB0aGlzLmxlYXNlVHlwZSxcclxuICAgICAgICBmdXJuaXNoZWQ6IHRoaXMuZnVybmlzaGVkLFxyXG4gICAgICAgIGhlYXRpbmc6IHRoaXMuaGVhdGluZyxcclxuICAgICAgICBwYXJraW5nOiB0aGlzLnBhcmtpbmcsXHJcbiAgICAgICAgY29vbGluZzogdGhpcy5jb29saW5nLFxyXG4gICAgICAgIHZpZXc6IHRoaXMudmlldyxcclxuICAgICAgICBzdGFydFByaWNlOiB0aGlzLnN0YXJ0UHJpY2UsXHJcbiAgICAgICAgZW5kUHJpY2U6IHRoaXMuZW5kUHJpY2VcclxuICAgICAgfVxyXG4gICAgfSkuZG9uZShmdW5jdGlvbiBzdWNjZWRlZChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLCB7XHJcbiAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgIH0pO1xyXG4gICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgIGZpbHRlcmVkRXN0YXRlcy5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgIGZpbHRlcmVkRXN0YXRlcy5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICAgICAgZmlsdGVyZWRFc3RhdGVzLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgcHJvcGVydHkuc2V0VmlzaWJsZShmYWxzZSk7XHJcbiAgICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlcy5sZW5ndGggKyAnIHByb3BlcnRpZXMnKTtcclxuICAgIH0pXHJcbiAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIpIHtcclxuICAgICAgLy8gdmFyIGEgPSBqUXVlcnkucGFyc2VKU09OKGpxWEhSLnJlc3BvbnNlVGV4dCk7IC8vIHJlc3BvbnNlIGlzIEpzb24gc28gd2UgbmVlZCB0byBwYXJzZVxyXG4gICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKCdObyBwcm9wZXJ0aWVzIGZvdW5kIHdpdCB0aGVzZSBmaWx0ZXJzJyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICB9XHJcbiAgICAgIGZpbHRlcmVkRXN0YXRlcy5zZXRWaXNpYmxlKGZhbHNlKTtcclxuICAgICAgcHJvcGVydHkuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxufTtcclxuJCgnI2ludm9rZUZpbHRlcnMnKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGZpbHRlcnM7XHJcbiAgdmFyIG9wdGlvbnMgPSB7fTtcclxuICBvcHRpb25zLmVzdGF0ZVR5cGUgPSAkKCcjZXN0YXRlVHlwZScpLnZhbCgpO1xyXG4gIG9wdGlvbnMubGVhc2VUeXBlID0gJCgnaW5wdXRbbmFtZT1vcHRpb25zXTpjaGVja2VkJykudmFsKCk7XHJcbiAgb3B0aW9ucy5zdGFydFByaWNlID0gJCgnI3N0YXJ0UHJpY2UnKS52YWwoKTtcclxuICBvcHRpb25zLmVuZFByaWNlID0gJCgnI2VuZFByaWNlJykudmFsKCk7XHJcbiAgb3B0aW9ucy5wYXJraW5nID0gJCgnI2NoZWNrYm94LTEnKS5wcm9wKCdjaGVja2VkJyk7XHJcbiAgb3B0aW9ucy5mdXJuaXNoZWQgPSAkKCcjY2hlY2tib3gtMicpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBvcHRpb25zLmhlYXRpbmcgPSAkKCcjY2hlY2tib3gtMycpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBvcHRpb25zLmNvb2xpbmcgPSAkKCcjY2hlY2tib3gtNCcpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBvcHRpb25zLnZpZXcgPSAkKCcjY2hlY2tib3gtNScpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBmaWx0ZXJzID0gbmV3IGFwcC5GaWx0ZXJzKG9wdGlvbnMpO1xyXG4gIGZpbHRlcnMuc2V0RGVmYXVsdHMoKTtcclxuICBmaWx0ZXJzLmFqYXhDYWxsKCk7XHJcbn0pO1xyXG4kKCcjY2xlYXJGaWx0ZXJzJykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gIHZhciBvcmlnbmFsRXN0YXRlVHlwZVZhbHVlID0gJCgnI2VzdGF0ZVR5cGUgb3B0aW9uJykudmFsKCk7XHJcbiAgdmFyIG9yaWduYWxQcmljZVJhbmdlVmFsdWUgPSAkKCcjcHJpY2VTZWxlY3Qgb3B0aW9uJykudmFsKCk7XHJcbiAgJCgnbGFiZWxbZm9yPW9wdGlvbi0xXScpLmFkZENsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnbGFiZWxbZm9yPW9wdGlvbi0yXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnbGFiZWxbZm9yPWNoZWNrYm94LTFdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAkKCdsYWJlbFtmb3I9Y2hlY2tib3gtMl0nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICQoJ2xhYmVsW2Zvcj1jaGVja2JveC0zXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnbGFiZWxbZm9yPWNoZWNrYm94LTRdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAkKCdsYWJlbFtmb3I9Y2hlY2tib3gtNV0nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICQoJ2xhYmVsW2Zvcj1jaGVja2JveC02XScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnI2VzdGF0ZVR5cGUnKS5zaWJsaW5ncygpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwob3JpZ25hbEVzdGF0ZVR5cGVWYWx1ZSk7XHJcbiAgJCgnI3ByaWNlU2VsZWN0Jykuc2libGluZ3MoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKG9yaWduYWxQcmljZVJhbmdlVmFsdWUpO1xyXG4gICQoJyNzdGFydFByaWNlJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgJCgnI2VuZFByaWNlJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgJCgnI2VzdGF0ZVByb3BlcnRpZXMnKS5hZGRDbGFzcygnZXN0YXRlUHJvcGVydGllcycpO1xyXG4gIGZpbHRlcmVkRXN0YXRlcy5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gIHByb3BlcnR5LnNldFZpc2libGUodHJ1ZSk7XHJcbiAgUFNBLnNldFNvdXJjZShudWxsKTtcclxuICBzZWxlY3RTb3VyY2UuY2xlYXIoKTtcclxuICBtYXAucmVtb3ZlSW50ZXJhY3Rpb24oZHJhdyk7XHJcbn0pO1xyXG52YXIgZHJhdztcclxuZnVuY3Rpb24gYWRkSW50ZXJhY3Rpb24oKSB7XHJcbiAgc2VsZWN0U291cmNlLmNsZWFyKCk7XHJcbiAgZHJhdyA9IG5ldyBvbC5pbnRlcmFjdGlvbi5EcmF3KHtcclxuICAgIHNvdXJjZTogc2VsZWN0U291cmNlLFxyXG4gICAgdHlwZTogJ0xpbmVTdHJpbmcnLFxyXG4gICAgZ2VvbWV0cnlGdW5jdGlvbjogZ2VvbWV0cnlGdW5jdGlvbixcclxuICAgIG1heFBvaW50czogMlxyXG4gIH0pO1xyXG4gIGRyYXcub24oJ2RyYXdzdGFydCcsIGZ1bmN0aW9uICgpIHtcclxuICAgIHNlbGVjdFNvdXJjZS5jbGVhcigpO1xyXG4gIH0pO1xyXG4gIGRyYXcub24oJ2RyYXdlbmQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICBtYXAucmVtb3ZlSW50ZXJhY3Rpb24oZHJhdyk7XHJcbiAgfSk7XHJcbiAgbWFwLmFkZEludGVyYWN0aW9uKGRyYXcpO1xyXG59XHJcbmZ1bmN0aW9uIGdlb21ldHJ5RnVuY3Rpb24oY29vcmRpbmF0ZXMsIGdlb21ldHJ5KSB7XHJcbiAgaWYgKCFnZW9tZXRyeSkge1xyXG4gICAgZ2VvbWV0cnkgPSBuZXcgb2wuZ2VvbS5Qb2x5Z29uKG51bGwpO1xyXG4gIH1cclxuICB2YXIgc3RhcnQgPSBjb29yZGluYXRlc1swXTtcclxuICB2YXIgZW5kID0gY29vcmRpbmF0ZXNbMV07XHJcbiAgZ2VvbWV0cnkuc2V0Q29vcmRpbmF0ZXMoW1xyXG4gICAgW1xyXG4gICAgICBzdGFydCxcclxuICAgICAgW1xyXG4gICAgICAgIHN0YXJ0WzBdLCBlbmRbMV1cclxuICAgICAgXSxcclxuICAgICAgZW5kLFxyXG4gICAgICBbXHJcbiAgICAgICAgZW5kWzBdLCBzdGFydFsxXVxyXG4gICAgICBdLFxyXG4gICAgICBzdGFydFxyXG4gICAgXVxyXG4gIF0pO1xyXG4gIHJldHVybiBnZW9tZXRyeTtcclxufVxyXG4kKCcjY2hlY2tib3gtNicpLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuICBpZiAodGhpcy5jaGVja2VkKSB7XHJcbiAgICBhZGRJbnRlcmFjdGlvbigpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBtYXAucmVtb3ZlSW50ZXJhY3Rpb24oZHJhdyk7XHJcbiAgICBzZWxlY3RTb3VyY2UuY2xlYXIoKTtcclxuICB9XHJcbn0pO1xyXG5cclxuXHJcbnZhciBoYW5kbGVGaWx0ZXJzID0gKGZ1bmN0aW9uIGhhbmRsZUZpbHRlcnMoKSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG5cclxuICBmdW5jdGlvbiBzZWxlY3RSYW5nZSgpIHtcclxuICAgICQoJyNwcmljZVNlbGVjdCcpLmNoYW5nZShmdW5jdGlvbiAoZSkge1xyXG4gICAgICB2YXIgdmFsID0gJCh0aGlzKS52YWwoKTtcclxuICAgICAgaWYgKHZhbCA9PT0gMTAwMDAwKSB7XHJcbiAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzEwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gMTUwMDAwKSB7XHJcbiAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzEwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMTUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsID09PSAyMDAwMDApIHtcclxuICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMTUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCcyMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgfSBlbHNlIGlmICh2YWwgPT09IDI1MDAwMCkge1xyXG4gICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCcyMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzI1MDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gMzAwMDAwKSB7XHJcbiAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzI1MDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMzAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzI1MDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMzAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHNlbGVjdFJhbmdlOiBzZWxlY3RSYW5nZVxyXG4gIH07XHJcbn0oKSk7XHJcbmZ1bmN0aW9uIGdldFZhbHVlUmFuZ2UobGlzdGluZ1R5cGUpIHtcclxuICB2YXIgc2FsZVR5cGUgPSB7XHJcbiAgICBTYWxlOiBmdW5jdGlvbiBzYWxlKCkge1xyXG4gICAgICAkKCcjcHJpY2VTZWxlY3QnKS5jaGFuZ2UoZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgdmFsID0gJCh0aGlzKS52YWwoKTtcclxuICAgICAgICBpZiAodmFsID09PSAnMTAwMDAwJykge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMTAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT09ICcxNTAwMDAnKSB7XHJcbiAgICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMTAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzE1MDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsID09PSAnMjAwMDAwJykge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzE1MDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCcyMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gJzI1MDAwMCcpIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCcyMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMjUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT09ICczMDAwMDAnKSB7XHJcbiAgICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMjUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzMwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMzAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJycpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgUmVudDogZnVuY3Rpb24gcmVudCgpIHtcclxuICAgICAgJCgnI3ByaWNlU2VsZWN0JykuY2hhbmdlKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIHZhbCA9ICQodGhpcykudmFsKCk7XHJcbiAgICAgICAgaWYgKHZhbCA9PT0gJzMwMCcpIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCcwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzMwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsID09PSAnNDUwJykge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzMwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCc0NTAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gJzYwMCcpIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCc0NTAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnNjAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCc2MDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9O1xyXG4gIHJldHVybiAoc2FsZVR5cGVbbGlzdGluZ1R5cGVdKSgpO1xyXG59XHJcbiQoZnVuY3Rpb24gKCkge1xyXG4gIGdldFZhbHVlUmFuZ2UoJ1JlbnQnKTtcclxuICAkKCdpbnB1dFt0eXBlPXJhZGlvXVtuYW1lPW9wdGlvbnNdJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciB2YWx1ZSA9IHRoaXMudmFsdWU7XHJcbiAgICB2YXIgdHlwZSA9IHtcclxuICAgICAgcmFuZ2VUeXBlOiB0aGlzLnZhbHVlXHJcbiAgICB9O1xyXG4gICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJycpLnBhcmVudCgpLmVxKDApLnJlbW92ZUNsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgJCgnI2VuZFByaWNlJykudmFsKCcnKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgIGR1c3QucmVuZGVyKCd2YWx1ZVJhbmdlJywgdHlwZSwgZnVuY3Rpb24gKGVycm9yLCBodG1sKSB7XHJcbiAgICAgICQoJy5wcmljZVNlbGVjdCcpLmh0bWwoaHRtbCk7XHJcbiAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZUFsbFJlZ2lzdGVyZWQoKTtcclxuICAgICAgZ2V0VmFsdWVSYW5nZSh2YWx1ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgKTtcclxuJCgnI2FkdmFuY2VkLWZpbHRlcnMnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIGlmICgkKCcjZXN0YXRlUHJvcGVydGllcycpLmhhc0NsYXNzKCdlc3RhdGVQcm9wZXJ0aWVzJykpIHtcclxuICAgICQoJyNlc3RhdGVQcm9wZXJ0aWVzJykucmVtb3ZlQ2xhc3MoJ2VzdGF0ZVByb3BlcnRpZXMnKTtcclxuICB9IGVsc2Uge1xyXG4gICAgJCgnI2VzdGF0ZVByb3BlcnRpZXMnKS5hZGRDbGFzcygnZXN0YXRlUHJvcGVydGllcycpO1xyXG4gIH1cclxufSk7XHJcbn0pO1xyXG5mdW5jdGlvbiBwcmV2ZW50RG90QW5kU3BhY2UoZSkge1xyXG4gIHZhciBrZXkgPSBlLmNoYXJDb2RlID8gZS5jaGFyQ29kZSA6IGUua2V5Q29kZTtcclxuICB0aGlzLmlubmVySFRNTCA9IGtleTtcclxuICBpZiAoa2V5ID09PSA0NiB8fCBrZXkgPT09IDMyKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59XHJcbiIsIihmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGdlb2xvY2F0aW9uID0gbmV3IG9sLkdlb2xvY2F0aW9uKHtcclxuICAgIC8vIHRha2UgdGhlIHByb2plY3Rpb24gdG8gdXNlIGZyb20gdGhlIG1hcCdzIHZpZXdcclxuICAgIHByb2plY3Rpb246IG1hcC5nZXRWaWV3KCkuZ2V0UHJvamVjdGlvbigpLFxyXG4gICAgdHJhY2tpbmdPcHRpb25zOiB7XHJcbiAgICAgIG1heGltdW1BZ2U6IDEwMDAwLFxyXG4gICAgICBlbmFibGVIaWdoQWNjdXJhY3k6IHRydWUsXHJcbiAgICAgIHRpbWVvdXQ6IDYwMDAwMFxyXG4gICAgfVxyXG4gIH0pO1xyXG4gIHZhciBhY2N1cmFjeUZlYXR1cmUgPSBuZXcgb2wuRmVhdHVyZSgpO1xyXG4gIGdlb2xvY2F0aW9uLm9uKCdjaGFuZ2U6YWNjdXJhY3lHZW9tZXRyeScsIGZ1bmN0aW9uICgpIHtcclxuICAgIGFjY3VyYWN5RmVhdHVyZS5zZXRHZW9tZXRyeShnZW9sb2NhdGlvbi5nZXRBY2N1cmFjeUdlb21ldHJ5KCkpO1xyXG4gIH0pO1xyXG4gIHZhciBwb3NpdGlvbkZlYXR1cmUgPSBuZXcgb2wuRmVhdHVyZSgpO1xyXG4gIHBvc2l0aW9uRmVhdHVyZS5zZXRTdHlsZShuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5DaXJjbGUoe1xyXG4gICAgICByYWRpdXM6IDYsXHJcbiAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHsgY29sb3I6ICcjMzM5OUNDJyB9KSxcclxuICAgICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHsgY29sb3I6ICcjZmZmJywgd2lkdGg6IDIgfSlcclxuICAgIH0pXHJcbiAgfSkpO1xyXG4gIC8vIGxpc3RlbiB0byBjaGFuZ2VzIGluIHBvc2l0aW9uXHJcbiAgZ2VvbG9jYXRpb24ub24oJ2NoYW5nZTpwb3NpdGlvbicsIGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBjb29yZGluYXRlcyA9IGdlb2xvY2F0aW9uLmdldFBvc2l0aW9uKCk7XHJcbiAgICBwb3NpdGlvbkZlYXR1cmUuc2V0R2VvbWV0cnkoY29vcmRpbmF0ZXNcclxuICAgICAgPyBuZXcgb2wuZ2VvbS5Qb2ludChjb29yZGluYXRlcylcclxuICAgICAgOiBudWxsKTtcclxuICB9KTtcclxuICBmZWF0dXJlc092ZXJsYXlTb3VyY2UgPSBuZXcgb2wuc291cmNlLlZlY3Rvcih7fSk7XHJcbiAgdmFyIGZlYXR1cmVzT3ZlcmxheSA9IG5ldyBvbC5sYXllci5WZWN0b3IoeyBtYXA6IG1hcCwgc291cmNlOiBmZWF0dXJlc092ZXJsYXlTb3VyY2UgfSk7XHJcbiAgJCgnLmdlb2xvY2F0aW9uJykub24oJ2NoYW5nZScsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBpZiAoJCh0aGlzKS5wcm9wKCdjaGVja2VkJykgPT09IHRydWUpIHtcclxuICAgICAgZ2VvbG9jYXRpb24uc2V0VHJhY2tpbmcodHJ1ZSk7XHJcbiAgICAgIGZlYXR1cmVzT3ZlcmxheVNvdXJjZS5hZGRGZWF0dXJlcyhbcG9zaXRpb25GZWF0dXJlLCBhY2N1cmFjeUZlYXR1cmVdKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGdlb2xvY2F0aW9uLnNldFRyYWNraW5nKGZhbHNlKTtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5U291cmNlLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn0oKSk7XHJcbiIsImZ1bmN0aW9uIGhhbmRsZUluZm8oZXZ0KSB7XHJcbiAgdmFyIGNvb3JkaW5hdGUgPSBldnQuY29vcmRpbmF0ZTtcclxuICB2YXIgb2JqID0ge307XHJcbiAgdmFyIHRpdGxlID0ge307XHJcbiAgdmFyIG93bmVyID0ge307XHJcbiAgdmFyIGZlYXR1cmVzID0gW107XHJcbiAgdmFyIGNsaWNrZWRGZWF0dXJlO1xyXG4gIHZhciBmO1xyXG5cclxuICBtYXAucmVtb3ZlSW50ZXJhY3Rpb24oZHJhdyk7XHJcbiAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgb2JqLnRpdGxlID0gdGl0bGU7XHJcbiAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICAgIHRpdGxlLmdpZCA9ICfOms+JzrTOuc66z4zPgiDOmc60zrnOv866z4TOt8+Dzq/Osc+CJztcclxuICAgIHRpdGxlLnR5cGUgPSAnzpXOr860zr/PgiDOmc60zrnOv866z4TOt8+Dzq/Osc+CJztcclxuICAgIHRpdGxlLmxpc3RpbmdfdHlwZSA9ICfOpM+Nz4DOv8+CIM6RzrPOs861zrvOr86xz4InO1xyXG4gICAgdGl0bGUuYXJlYSA9ICfOlc68zrLOsc60z4wnO1xyXG4gICAgdGl0bGUuYWRkcmVzcyA9ICfOlM65zrXPhc64z4XOvc+DzrcnO1xyXG4gICAgdGl0bGUuYmVkcm9vbXMgPSAnzqXPgM69zr/OtM+JzrzOrM+EzrnOsSc7XHJcbiAgICB0aXRsZS5wcmljZSA9ICfOpM65zrzOric7XHJcbiAgICB0aXRsZS5pc25ldyA9ICfOnc61z4zOtM68zrfPhM6/JztcclxuICAgIHRpdGxlLnBhcmtpbmcgPSAnzqPPhM6szrjOvM61z4POtyc7XHJcbiAgICB0aXRsZS5mdXJuaXNoZWQgPSAnzpXPgM65z4DOu8+JzrzOrc69zr8nO1xyXG4gICAgdGl0bGUucGV0cyA9ICfOms6xz4TOv865zrrOr860zrnOsSc7XHJcbiAgICB0aXRsZS52aWV3ID0gJ86Yzq3OsSc7XHJcbiAgICB0aXRsZS5oZWF0aW5nID0gJ86Yzq3Pgc68zrHOvc+DzrcnO1xyXG4gICAgdGl0bGUuY29vbGluZyA9ICfOqM+Nzr7Otyc7XHJcbiAgICB0aXRsZS5jb250YWN0SW5mbyA9ICfOo8+Ezr/Ouc+HzrXOr86xIM6Vz4DOuc66zr/Ouc69z4nOvc6vzrHPgic7XHJcbiAgICB0aXRsZS5uYW1lID0gJ86Mzr3Ov868zrEnO1xyXG4gICAgdGl0bGUubGFzdG5hbWUgPSAnzpXPgM6vzrjOtc+Ezr8nO1xyXG4gICAgdGl0bGUucGhvbmUgPSAnzqTOt867zq3Phs+Jzr3Ovyc7XHJcbiAgICB0aXRsZS5lbWFpbCA9ICfOl867zrXOus+Ez4HOv869zrnOus6uIM6UzrnOtc+NzrjPhc69z4POtyc7XHJcbiAgfSBlbHNlIHtcclxuICAgIHRpdGxlLmdpZCA9ICdFc3RhdGUgQ29kZSc7XHJcbiAgICB0aXRsZS50eXBlID0gJ1Byb3BlcnR5IFR5cGUnO1xyXG4gICAgdGl0bGUubGlzdGluZ190eXBlID0gJ0xpc3RpbmcgVHlwZSc7XHJcbiAgICB0aXRsZS5hcmVhID0gJ1NpemUnO1xyXG4gICAgdGl0bGUuYWRkcmVzcyA9ICdBZGRyZXNzJztcclxuICAgIHRpdGxlLmJlZHJvb21zID0gJ0JlZHJvb21zJztcclxuICAgIHRpdGxlLnByaWNlID0gJ1ByaWNlJztcclxuICAgIHRpdGxlLmlzbmV3ID0gJ05ld2x5IEJ1aWxkJztcclxuICAgIHRpdGxlLnBhcmtpbmcgPSAnUGFya2luZyc7XHJcbiAgICB0aXRsZS5mdXJuaXNoZWQgPSAnRnVybmlzaGVkJztcclxuICAgIHRpdGxlLnBldHMgPSAnUGV0cyBBbGxvd2VkJztcclxuICAgIHRpdGxlLnZpZXcgPSAnVmlldyc7XHJcbiAgICB0aXRsZS5oZWF0aW5nID0gJ0hlYXRpbmcnO1xyXG4gICAgdGl0bGUuY29vbGluZyA9ICdDb29saW5nJztcclxuICAgIHRpdGxlLmNvbnRhY3RJbmZvID0gJ0NvbnRhY3QgSW5mbyc7XHJcbiAgICB0aXRsZS5uYW1lID0gJ05hbWUnO1xyXG4gICAgdGl0bGUubGFzdG5hbWUgPSAnTGFzdCBOYW1lJztcclxuICAgIHRpdGxlLnBob25lID0gJ1RlbGVwaG9uZSc7XHJcbiAgICB0aXRsZS5lbWFpbCA9ICdFbWFpbCc7XHJcbiAgfVxyXG4gIGNsaWNrZWRGZWF0dXJlID0gbWFwLmZvckVhY2hGZWF0dXJlQXRQaXhlbChldnQucGl4ZWwsIGZ1bmN0aW9uIChmZWF0dXJlLCBsYXllcikge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgZmVhdHVyZTogZmVhdHVyZSxcclxuICAgICAgbGF5ZXI6IGxheWVyXHJcbiAgICB9O1xyXG4gIH0sIHRoaXMsIGZ1bmN0aW9uIChsYXllcikge1xyXG4gICAgaWYgKGxheWVyLmdldCgnaWQnKSA9PT0gJ2VzdGF0ZXMnIHx8IGxheWVyLmdldCgnaWQnKSA9PT0gJ2ZpbHRlcmVkRXN0YXRlcycpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfSwgdGhpcyk7XHJcbiAgaWYgKGNsaWNrZWRGZWF0dXJlKSB7XHJcbiAgICBpZiAoY2xpY2tlZEZlYXR1cmUubGF5ZXIuZ2V0KCdpZCcpID09PSAnZXN0YXRlcycgJiYgY2xpY2tlZEZlYXR1cmUuZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJykubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIGYgPSBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLmdldFByb3BlcnRpZXMoKS5mZWF0dXJlc1swXTtcclxuICAgICAgY3JlYXRlUFNBYW5kQ2FyZChmLCBvYmopO1xyXG4gICAgfSBlbHNlIGlmIChjbGlja2VkRmVhdHVyZS5sYXllci5nZXQoJ2lkJykgPT09ICdmaWx0ZXJlZEVzdGF0ZXMnKSB7XHJcbiAgICAgIGYgPSBjbGlja2VkRmVhdHVyZS5mZWF0dXJlO1xyXG4gICAgICBjcmVhdGVQU0FhbmRDYXJkKGYsIG9iaik7XHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIFBTQS5zZXRTb3VyY2UobnVsbCk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVQU0FhbmRDYXJkKGYsIG9iaikge1xyXG4gIHZhciBmZWF0dXJlID0ge307XHJcbiAgZmVhdHVyZS5naWQgPSBmLmdldCgnZ2lkJyk7XHJcbiAgZmVhdHVyZS5hcmVhID0gZi5nZXQoJ2VzdGF0ZWFyZWEnKTtcclxuICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgZmVhdHVyZS50eXBlID0gZi5nZXQoJ2VzdGF0ZXR5cGUnKTtcclxuICAgIGZlYXR1cmUuYWRkcmVzcyA9IGYuZ2V0KCdzdHJlZXRfZWwnKSArICcgJyArIGYuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICBmZWF0dXJlLm5hbWUgPSBmLmdldCgnbmFtZV9lbCcpO1xyXG4gICAgZmVhdHVyZS5sYXN0bmFtZSA9IGYuZ2V0KCdsYXN0bmFtZV9lbCcpO1xyXG4gICAgaWYgKGYuZ2V0KCdzYWxlJykgPT09IHRydWUpIHtcclxuICAgICAgZmVhdHVyZS5saXN0aW5nX3R5cGUgPSAnzqDPjs67zrfPg863JztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZlYXR1cmUubGlzdGluZ190eXBlID0gJ86Vzr3Ov865zrrOr86xz4POtyc7XHJcbiAgICB9XHJcbiAgICBmZWF0dXJlLmJ0bnMgPSB7XHJcbiAgICAgIGluZm86ICfPgM67zrfPgc6/z4bOv8+BzrnOtc+CJyxcclxuICAgICAgY2xvc2U6ICfOus67zrXOuc+DzrnOvM6/J1xyXG4gICAgfTtcclxuICB9IGVsc2Uge1xyXG4gICAgZmVhdHVyZS50eXBlID0gZi5nZXQoJ2VzdGF0ZXR5cGVfZW4nKTtcclxuICAgIGZlYXR1cmUuYWRkcmVzcyA9IGYuZ2V0KCdzdHJlZXRfZW4nKSArICcgJyArIGYuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICBmZWF0dXJlLm5hbWUgPSBmLmdldCgnbmFtZV9lbicpO1xyXG4gICAgZmVhdHVyZS5sYXN0bmFtZSA9IGYuZ2V0KCdsYXN0bmFtZV9lbicpO1xyXG4gICAgaWYgKGYuZ2V0KCdzYWxlJykgPT09IHRydWUpIHtcclxuICAgICAgZmVhdHVyZS5saXN0aW5nX3R5cGUgPSAnU2FsZSc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmZWF0dXJlLmxpc3RpbmdfdHlwZSA9ICdSZW50JztcclxuICAgIH1cclxuICAgIGZlYXR1cmUuYnRucyA9IHtcclxuICAgICAgaW5mbzogJ2luZm8nLFxyXG4gICAgICBjbG9zZTogJ2Nsb3NlJ1xyXG4gICAgfTtcclxuICB9XHJcbiAgZmVhdHVyZS5iZWRyb29tcyA9IGYuZ2V0KCdiZWRyb29tcycpO1xyXG4gIGZlYXR1cmUucHJpY2UgPSBmLmdldCgncHJpY2UnKTtcclxuICBmZWF0dXJlLmlzbmV3ID0gZi5nZXQoJ2lzbmV3Jyk7XHJcbiAgZmVhdHVyZS5wYXJraW5nID0gZi5nZXQoJ3BhcmtpbmcnKTtcclxuICBmZWF0dXJlLmZ1cm5pc2hlZCA9IGYuZ2V0KCdmdXJuaXNoZWQnKTtcclxuICBmZWF0dXJlLnBldHMgPSBmLmdldCgncGV0cycpO1xyXG4gIGZlYXR1cmUudmlldyA9IGYuZ2V0KCd2aWV3Jyk7XHJcbiAgZmVhdHVyZS5oZWF0aW5nID0gZi5nZXQoJ2hlYXRpbmcnKTtcclxuICBmZWF0dXJlLmNvb2xpbmcgPSBmLmdldCgnY29vbGluZycpO1xyXG4gIGZlYXR1cmUucGhvbmUgPSBmLmdldCgncGhvbmUxJyk7XHJcbiAgZmVhdHVyZS5lbWFpbCA9IGYuZ2V0KCdlbWFpbCcpO1xyXG4gIGZlYXR1cmUuY29vcmRpbmF0ZSA9IGYuZ2V0KCdnZW9tZXRyeScpLmdldENvb3JkaW5hdGVzKCk7XHJcblxyXG4gIHZhciBQU0FTb3VyY2UgPSBuZXcgb2wuc291cmNlLlZlY3Rvcih7XHJcbiAgICBhdHRyaWJ1dGlvbnM6IFtuZXcgb2wuQXR0cmlidXRpb24oe1xyXG4gICAgICBodG1sOiAnUE9JIGJ5ICcgKyAnPGEgaHJlZj1cImh0dHA6Ly93d3cudGVycmFjb2duaXRhLmdyL1wiPlRlcnJhIENvZ25pdGE8L2E+J1xyXG4gICAgfSldLFxyXG4gICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0LFxyXG4gICAgbG9hZGVyOiBmdW5jdGlvbiAoZXh0ZW50LCByZXNvbHV0aW9uLCBwcm9qZWN0aW9uKSB7XHJcbiAgICAgIHZhciB1cmwgPSAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3VzZXMvJyArIGZlYXR1cmUuZ2lkO1xyXG4gICAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICAgICQuYWpheCh7XHJcbiAgICAgICAgdXJsOiB1cmwsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YVR5cGU6ICdqc29uJ1xyXG4gICAgICB9KS5kb25lKGZ1bmN0aW9uIHN1Y2NlZGVkKGRhdGEsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgICAgdmFyIGZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMoZGF0YS5wcm9wZXJ0eV9zZXJ2aWNlc19hbmFseXNpcywge1xyXG4gICAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdmFyIGZlYXR1cmVzTGVuZ3RoID0gZmVhdHVyZXMubGVuZ3RoIC0gMTtcclxuICAgICAgICB2YXIgYXJlYSA9IG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgICAgIGNvbG9yOiBbMTU2LCAzOSwgMTc2LCAwLjFdXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZlYXR1cmVzWzBdLnNldFN0eWxlKGFyZWEpO1xyXG4gICAgICAgIHNlbGYuYWRkRmVhdHVyZXMoZmVhdHVyZXMpO1xyXG4gICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgIHRvYXN0ci5pbmZvKCdGb3VuZCAnICsgZmVhdHVyZXNMZW5ndGggKyAnIFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuICAgICAgfSkuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIpIHtcclxuICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIGFueSBQb2ludHMgb2YgSW50ZXJlc3QgaW4gOCBtaW51dGUgZGlzdGFuY2UhJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBzdHJhdGVneTogb2wubG9hZGluZ3N0cmF0ZWd5LmFsbFxyXG4gIH0pO1xyXG4gIFBTQS5zZXRTb3VyY2UoUFNBU291cmNlKTtcclxuICBtYXAuZ2V0VmlldygpLnNldENlbnRlcihmZWF0dXJlLmNvb3JkaW5hdGUpO1xyXG4gIG1hcC5nZXRWaWV3KCkuc2V0UmVzb2x1dGlvbigxLjIpO1xyXG4gIG9iai5mZWF0dXJlID0gZmVhdHVyZTtcclxuXHJcbiAgZHVzdC5yZW5kZXIoJ2VzdGF0ZUNhcmRzJywgb2JqLCBmdW5jdGlvbiByZW5kZXJFc3RhdGVDYXJkcyhlcnIsIG91dCkge1xyXG4gICAgJCgnLmVzdGF0ZS1jYXJkcycpLmh0bWwob3V0KTtcclxuICAgICQoJy5tZGwtY2FyZF9fdGl0bGUnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKGh0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvd180MzIsY19zY2FsZS8nICsgb2JqLmZlYXR1cmUuZ2lkICsgJy5qcGcpJyk7XHJcbiAgICAkKCcuZXN0YXRlLWNhcmRzJykuYWRkQ2xhc3MoJ2VzdGF0ZS1jYXJkcy1hY3RpdmUnKTtcclxuICAvLyAkKFwiI2luZm9ib3hcIikuYWRkQ2xhc3MoXCJ2aXN1YWxseWhpZGRlblwiKTtcclxuICB9KTtcclxuICAkKCdhW2hyZWY9XCIjb3Blbk1vZGFsXCJdJykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gICAgZHVzdC5yZW5kZXIoJ21vZGFsSW5mbycsIG9iaiwgZnVuY3Rpb24gcmVuZGVyTW9kYWxJbmZvKGVyciwgb3V0KSB7XHJcbiAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICAkKCcuYmlnLWltYWdlJykuY3NzKCdiYWNrZ3JvdW5kLWltYWdlJywgJ3VybChodHRwOi8vcmVzLmNsb3VkaW5hcnkuY29tL2ZpcnZhaW4vaW1hZ2UvdXBsb2FkL2hfMjIyLGNfc2NhbGUvJyArIG9iai5mZWF0dXJlLmdpZCArICcuanBnKScpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbiAgJCgnYVtocmVmPVwiI2Nsb3NlRXN0YXRlQ2FyZFwiXScpLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuICAgICQoJy5lc3RhdGUtY2FyZHMnKS5yZW1vdmVDbGFzcygnZXN0YXRlLWNhcmRzLWFjdGl2ZScpO1xyXG4gIH0pO1xyXG59XHJcbiQoJyNpbmZvcm1hdGlvbicpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7XHJcbiAgUFNBLnNldFNvdXJjZShudWxsKTtcclxuICBpZiAoJCh0aGlzKS5wcm9wKCdjaGVja2VkJykgPT09IHRydWUpIHtcclxuICAgIG1hcC5vbignY2xpY2snLCBoYW5kbGVJbmZvKTtcclxuICAgICQodGhpcykucGFyZW50KCkuc2libGluZ3MoKS5maW5kKCdpbnB1dCcpLmVhY2goZnVuY3Rpb24gKCkgeyQodGhpcykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTt9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgbWFwLnVuKCdjbGljaycsIGhhbmRsZUluZm8pO1xyXG4gICAgJCh0aGlzKS5wYXJlbnQoKS5zaWJsaW5ncygpLmZpbmQoJ2lucHV0JykuZWFjaChmdW5jdGlvbiAoKSB7JCh0aGlzKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTt9KTtcclxuICB9XHJcbn0pO1xyXG4iLCIoZnVuY3Rpb24gKCkge1xyXG4gIHZhciBtYXJrZXIgPSBuZXcgb2wuRmVhdHVyZSgpO1xyXG4gIHZhciBpY29uU3R5bGUgPSBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKC8qKiBAdHlwZSB7b2x4LnN0eWxlLkljb25PcHRpb25zfSAqL1xyXG4gICAgKHtcclxuICAgICAgYW5jaG9yOiBbXHJcbiAgICAgICAgMC41LCAxXHJcbiAgICAgIF0sXHJcbiAgICAgIGFuY2hvclhVbml0czogJ2ZyYWN0aW9uJyxcclxuICAgICAgYW5jaG9yWVVuaXRzOiAnZnJhY3Rpb24nLFxyXG4gICAgICBvcGFjaXR5OiAxLFxyXG4gICAgICBzY2FsZTogMSxcclxuICAgICAgc3JjOiAnLi4vaW1hZ2VzL21hcC1pY29ucy9waW5zLzI0L3BpbjEucG5nJyxcclxuICAgICAgc25hcFRvUGl4ZWw6IGZhbHNlXHJcbiAgICB9KSksXHJcbiAgICB6SW5kZXg6IDEwMFxyXG4gIH0pO1xyXG4gIG1hcmtlci5zZXRTdHlsZShpY29uU3R5bGUpO1xyXG4gIHZhciBmZWF0dXJlc092ZXJsYXlTdHlsZSA9IG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2Uoe1xyXG4gICAgICBjb2xvcjogJyM0MDgwODAnLFxyXG4gICAgICB3aWR0aDogNSxcclxuICAgICAgbGluZURhc2g6IFs0LCA0XVxyXG4gICAgfSlcclxuICB9KTtcclxuICB2YXIgZmVhdHVyZXNPdmVybGF5ID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgICBtYXA6IG1hcCxcclxuICAgIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5WZWN0b3IoKSxcclxuICAgIHN0eWxlOiBmZWF0dXJlc092ZXJsYXlTdHlsZSxcclxuICAgIGlkOiAncm91dGUnLFxyXG4gICAgbmFtZUVsOiAnzpTOuc6xzrTPgc6/zrzOricsXHJcbiAgICBOYW1lRW46ICdSb3V0ZSdcclxuICB9KTtcclxuICB2YXIgcm91dGVDb29yZHMgPSBbXTtcclxuICBmdW5jdGlvbiBoYW5kbGVNYXJrZXIoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgZmVhdHVyZUNvdW50ID0gZmVhdHVyZXNPdmVybGF5LmdldFNvdXJjZSgpLmdldEZlYXR1cmVzKCkubGVuZ3RoO1xyXG4gICAgdmFyIGNvb3JkaW5hdGVzID0gZXZlbnQuY29vcmRpbmF0ZTtcclxuICAgIGlmIChmZWF0dXJlQ291bnQgPT09IDApIHtcclxuICAgICAgbWFya2VyLnNldEdlb21ldHJ5KG5ldyBvbC5nZW9tLlBvaW50KGNvb3JkaW5hdGVzKSk7XHJcbiAgICAgIG1hcmtlci5zZXRJZCgnZmlyc3QnKTtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5LmdldFNvdXJjZSgpLmFkZEZlYXR1cmUobWFya2VyKTtcclxuICAgICAgcm91dGVDb29yZHNbMF0gPSBjb29yZGluYXRlc1swXTtcclxuICAgICAgcm91dGVDb29yZHNbMV0gPSBjb29yZGluYXRlc1sxXTtcclxuICAgIH0gZWxzZSBpZiAoZmVhdHVyZUNvdW50ID09PSAxKSB7XHJcbiAgICAgIHZhciBjbG9uZSA9IG1hcmtlci5jbG9uZSgpO1xyXG4gICAgICBjbG9uZS5zZXRHZW9tZXRyeShuZXcgb2wuZ2VvbS5Qb2ludChjb29yZGluYXRlcykpO1xyXG4gICAgICBjbG9uZS5zZXRJZCgnc2Vjb25kJyk7XHJcbiAgICAgIGZlYXR1cmVzT3ZlcmxheS5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlKGNsb25lKTtcclxuICAgICAgcm91dGVDb29yZHNbMl0gPSBjb29yZGluYXRlc1swXTtcclxuICAgICAgcm91dGVDb29yZHNbM10gPSBjb29yZGluYXRlc1sxXTtcclxuICAgICAgY2FsbFJvdXRlKHJvdXRlQ29vcmRzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZlYXR1cmVzT3ZlcmxheS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgfVxyXG4gIH1cclxuICBnZW9KU09ORm9ybWF0ID0gbmV3IG9sLmZvcm1hdC5HZW9KU09OKHsgZGVmYXVsdERhdGFQcm9qZWN0aW9uOiAnRVBTRzo0MzI2JywgZ2VvbWV0cnlOYW1lOiAnZ2VvbWV0cnknIH0pO1xyXG4gIGZ1bmN0aW9uIGNhbGxSb3V0ZShyb3V0ZUNvb3Jkcykge1xyXG4gICAgdmFyIGZpcnN0ID0gb2wucHJvai50cmFuc2Zvcm0oW1xyXG4gICAgICByb3V0ZUNvb3Jkc1swXSwgcm91dGVDb29yZHNbMV1cclxuICAgIF0sICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICB2YXIgc2Vjb25kID0gb2wucHJvai50cmFuc2Zvcm0oW1xyXG4gICAgICByb3V0ZUNvb3Jkc1syXSwgcm91dGVDb29yZHNbM11cclxuICAgIF0sICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICB2YXIgeDEgPSBmaXJzdFswXTtcclxuICAgIHZhciB5MSA9IGZpcnN0WzFdO1xyXG4gICAgdmFyIHgyID0gc2Vjb25kWzBdO1xyXG4gICAgdmFyIHkyID0gc2Vjb25kWzFdO1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgdXJsOiAnaHR0cHM6Ly9hcGkubWFwYm94LmNvbS92NC9kaXJlY3Rpb25zL21hcGJveC5kcml2aW5nLycgKyB4MSArICcsJyArIHkxICsgJzsnICsgeDIgKyAnLCcgKyB5MiArICcuanNvbj9hbHRlcm5hdGl2ZXM9ZmFsc2UmYWNjZXNzX3Rva2VuPXBrLmV5SjFJam9pWm1seWRtRnBiaUlzSW1FaU9pSmxPV1l5WVRNME5UaGlOV00wWWpKak9ESmpOREU0T0RRek56QTJNR1F5TmlKOS4tTlZETzI3SHp0LXdfblFvc1VQZkxBJyxcclxuICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgIH0pLmRvbmUoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgdmFyIHJvdXRlID0ge307XHJcbiAgICAgIHJvdXRlLnR5cGUgPSAnRmVhdHVyZSc7XHJcbiAgICAgIHJvdXRlLmdlb21ldHJ5ID0gZGF0YS5yb3V0ZXNbMF0uZ2VvbWV0cnk7XHJcbiAgICAgIGZlYXR1cmVzT3ZlcmxheS5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlcyhnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhyb3V0ZSwge1xyXG4gICAgICAgIGRhdGFQcm9qZWN0aW9uOiAnRVBTRzo0MzI2JyxcclxuICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgfSkpO1xyXG4gICAgICBtYXAuZ2V0VmlldygpLmZpdChmZWF0dXJlc092ZXJsYXkuZ2V0U291cmNlKCkuZ2V0RXh0ZW50KCksIG1hcC5nZXRTaXplKCkpO1xyXG4gICAgfSkuZmFpbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKFwiZXJyb3JcIik7XHJcbiAgICB9KS5hbHdheXMoZnVuY3Rpb24gKCkge1xyXG4gICAgICAvLyBjb25zb2xlLmxvZyhcImNvbXBsZXRlXCIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gICQoJyNtYXJrZXInKS5vbignY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgLyogQWN0IG9uIHRoZSBldmVudCAqL1xyXG4gICAgaWYgKCQodGhpcykucHJvcCgnY2hlY2tlZCcpID09PSB0cnVlKSB7XHJcbiAgICAgIG1hcC5vbignc2luZ2xlY2xpY2snLCBoYW5kbGVNYXJrZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbWFwLnVuKCdzaW5nbGVjbGljaycsIGhhbmRsZU1hcmtlcik7XHJcbiAgICAgIGZlYXR1cmVzT3ZlcmxheS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59KCkpO1xyXG4iLCIoZnVuY3Rpb24gKCkge1xyXG4gICQoJyN3ZWF0aGVyJykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCQodGhpcykucHJvcCgnY2hlY2tlZCcpID09PSB0cnVlKSB7XHJcbiAgICAgICQodGhpcykucGFyZW50KCkuc2libGluZ3MoKS5maW5kKCdpbnB1dCcpLmVhY2goZnVuY3Rpb24gKCkgeyQodGhpcykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTt9KTtcclxuICAgICAgbWFwLmdldE92ZXJsYXlzKCkuZm9yRWFjaChmdW5jdGlvbiAob3ZsKSB7XHJcbiAgICAgICAgaWYgKG92bC5nZXQoJ25hbWUnKSA9PT0gJ3dlYXRoZXInKSB7XHJcbiAgICAgICAgICAoJChvdmwuZ2V0RWxlbWVudCgpKS5wYXJlbnQoKSkucmVtb3ZlKCk7XHJcbiAgICAgICAgICAkKG92bC5nZXRFbGVtZW50KCkpLnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHZhciBjZW50ZXIgPSBvbC5wcm9qLnRyYW5zZm9ybShtYXAuZ2V0VmlldygpLmdldENlbnRlcigpLCAnRVBTRzozODU3JywgJ0VQU0c6NDMyNicpO1xyXG4gICAgICB2YXIgbGF0ID0gY2VudGVyWzFdO1xyXG4gICAgICB2YXIgbG9uID0gY2VudGVyWzBdO1xyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly9hcGkub3BlbndlYXRoZXJtYXAub3JnL2RhdGEvMi41L2ZpbmQ/bGF0PScgKyBsYXQgKyAnJmxvbj0nICsgbG9uICsgJyZjbnQ9NSZjbHVzdGVyPW5vJnVuaXRzPW1ldHJpYyZ0eXBlPWFjY3VyYXRlJkFQUElEPWY5Y2Q5ZmEyYzQyN2MzYjExNWU4N2U0ODYyNjE5YzVjJyxcclxuICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICAgIH0pLmRvbmUoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICBmdW5jdGlvbiBjcmVhdGVXZWF0aGVyT3ZlcmxheShwb3NpdGlvbiwgaW5kZXgpIHtcclxuICAgICAgICAgIHZhciBlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnd2VhdGhlci1wb3B1cCAgbWRsLXNoYWRvdy0tNmRwJyk7XHJcbiAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgnaWQnLCBpbmRleCk7XHJcbiAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgnZGF0YS1uYW1lJywgJ3dlYXRoZXInKTtcclxuICAgICAgICAgIHJldHVybiBuZXcgb2wuT3ZlcmxheSh7IGVsZW1lbnQ6IGVsZW0sIHBvc2l0aW9uOiBwb3NpdGlvbiB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG9ianMgPSBkYXRhLmxpc3Q7XHJcbiAgICAgICAgdmFyIG92ZXJsYXksXHJcbiAgICAgICAgICBjb29yZGluYXRlcztcclxuICAgICAgICAkLmVhY2gob2JqcywgZnVuY3Rpb24gKGluZGV4LCB2YWwpIHtcclxuICAgICAgICAgIGNvb3JkaW5hdGVzID0gb2wucHJvai50cmFuc2Zvcm0oW1xyXG4gICAgICAgICAgICB2YWwuY29vcmQubG9uLCB2YWwuY29vcmQubGF0XHJcbiAgICAgICAgICBdLCAnRVBTRzo0MzI2JywgJ0VQU0c6Mzg1NycpO1xyXG4gICAgICAgICAgb3ZlcmxheSA9IGNyZWF0ZVdlYXRoZXJPdmVybGF5KGNvb3JkaW5hdGVzLCBpbmRleCk7XHJcbiAgICAgICAgICBtYXAuYWRkT3ZlcmxheShvdmVybGF5KTtcclxuICAgICAgICAgIG92ZXJsYXkuc2V0KCduYW1lJywgJ3dlYXRoZXInKTtcclxuICAgICAgICAgIHdlYXRoZXJEYXRhID0ge1xyXG4gICAgICAgICAgICAnbmFtZSc6IHZhbC5uYW1lLFxyXG4gICAgICAgICAgICAndGVtcCc6IHZhbC5tYWluLnRlbXAsXHJcbiAgICAgICAgICAgICdwcmVzc3VyZSc6IHZhbC5tYWluLnByZXNzdXJlLFxyXG4gICAgICAgICAgICAnaHVtaWRpdHknOiB2YWwubWFpbi5odW1pZGl0eVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGR1c3QucmVuZGVyKCd3ZWF0aGVyUG9wdXAnLCB3ZWF0aGVyRGF0YSwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICAgICAgICQoJyMnICsgaW5kZXgpLmh0bWwob3V0KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KS5mYWlsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyB0b2FzdHIuZXJyb3IoXCLOlM61zr0gzrLPgc6tzrjOt866zrHOvSDPgM67zrfPgc6/z4bOv8+Bzq/Otc+CIM6zzrnOsSDPhM65z4IgzrrOsc65z4HOuc66zq3PgiDPg8+Fzr3OuM6uzrrOtc+CIVwiKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2UgaWYgKCQodGhpcykucHJvcCgnY2hlY2tlZCcpID09PSBmYWxzZSkge1xyXG4gICAgICAkKHRoaXMpLnBhcmVudCgpLnNpYmxpbmdzKCkuZmluZCgnaW5wdXQnKS5lYWNoKGZ1bmN0aW9uICgpIHskKHRoaXMpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO30pO1xyXG4gICAgICBtYXAuZ2V0T3ZlcmxheXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChvdmwpIHtcclxuICAgICAgICBpZiAob3ZsLmdldCgnbmFtZScpID09PSAnd2VhdGhlcicpIHtcclxuICAgICAgICAgICgkKG92bC5nZXRFbGVtZW50KCkpLnBhcmVudCgpKS5yZW1vdmUoKTtcclxuICAgICAgICAgICQob3ZsLmdldEVsZW1lbnQoKSkucmVtb3ZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9KTtcclxufSgpKTtcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
