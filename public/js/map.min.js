var $loading = $('.mdl-spinner');
var center = [3677385, 4120949];
var extent = [3652772, 4112808, 3700000, 4132797];
var lang = document.documentElement.lang;
var styleCache = {};
var geoJSONFormat = new ol.format.GeoJSON({
  defaultDataProjection: 'EPSG:4326'
});
toastr.options = {
  closeButton: false,
  debug: false,
  newestOnTop: false,
  progressBar: false,
  positionClass: 'toast-top-center',
  preventDuplicates: false,
  onclick: null,
  showDuration: '300',
  hideDuration: '1000',
  timeOut: '5000',
  extendedTimeOut: '1000',
  showEasing: 'swing',
  hideEasing: 'linear',
  showMethod: 'fadeIn',
  hideMethod: 'fadeOut'
};
var bing = new ol.layer.Tile({
  visible: true,
  source: new ol.source.BingMaps({
    key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
    imagerySet: 'Aerial'
  }),
  maxZoom: 19,
  crossOrigin: 'anonymous',
  preload: Infinity,
  id: 'bing'
});
var mapbox = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [new ol.Attribution({
      html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
    })],
    url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
  }),
  id: 'mapbox'
});
function getIconType(estateType) {
  var iconType = {
    Apartment: function apartmentIcon() {
      return 'apartment';
    },
    'Detached House': function detachedHouceIcon() {
      return 'detached';
    },
    Villa: function villaIcon() {
      return 'villa';
    },
    Maisonette: function maisonetteIcon() {
      return 'villa';
    }
  };
  return (iconType[estateType])();
}

function getIconPath(listingType) {
  var iconPath = {
    true: function saleIcon() {
      return './images/pins/sale/';
    },
    false: function rentIcon() {
      return './images/pins/rent/';
    }
  };
  return (iconPath[listingType])();
}

function createPropertyStyle(feature) {
  var src;
  src = getIconPath(feature.get('sale')) + getIconType(feature.get('estatetype_en')) + '-48.png';
  return new ol.style.Style({
    geometry: feature.getGeometry(),
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1
    }))
  });
}

function propertyStyleFunction(feature, resolution) {
  var size = feature.get('features').length;
  var style;
  var originalFeature;
  if (size > 1) {
    style = [new ol.style.Style({
      image: new ol.style.Circle({
        radius: 20,
        stroke: new ol.style.Stroke({
          color: [156, 39, 176, 1],
          width: 5
        }),
        fill: new ol.style.Fill({
          color: [68, 138, 255, 0.8]
        })
      }),
      text: new ol.style.Text({
        text: size.toString(),
        fill: new ol.style.Fill({
          color: '#FFFFFF'
        })
      }),
      zIndex: 101
    })];
  } else {
    originalFeature = feature.get('features')[0];
    style = [createPropertyStyle(originalFeature)];
  }
  return style;
}

// function selectStyleFunction(feature, resolution) {
//   var styles = [new ol.style.Style({})];
//   var originalFeatures = feature.get('features');
//   var originaFeature;
//   for (var i = originalFeatures.length - 1; i >= 0; --i) {
//     originalFeature = originalFeatures[i];
//     styles.push(createPropertyStyle(originalFeature));
//   }
//   return styles;
// }
var propertySource = new ol.source.Vector({
  format: geoJSONFormat,
  loader: function featreLoader() {
    var self = this;
    this.clear();
    $.ajax({
      url: 'http://127.0.0.1:3000/db/listed',
      type: 'GET',
      dataType: 'json'
    })
      .done(function succeded(response) {
        var features = geoJSONFormat.readFeatures(response, {
          featureProjection: 'EPSG:3857'
        });
        self.addFeatures(features);
      })
      .fail(function failed(jqXHR, textStatus, errorThrown) {
        toastr.clear();
        if (jqXHR.status === 404) {
          toastr.error('Sorry, we cannot find any properties!');
        } else if (jqXHR.status === 503) {
          toastr.error('Service Unavailable');
        } else {
          toastr.error('Internal Server Error');
        }
      });
  }
});
var propertyClusterSource = new ol.source.Cluster({
  distance: 40,
  source: propertySource,
  attributions: [new ol.Attribution({
    html: 'All maps © ' + '<a href="http://www.terracognita.gr/">Terra Cognita</a>'
  })]
});
var property = new ol.layer.Vector({
  source: propertyClusterSource,
  id: 'estates',
  visible: true,
  style: propertyStyleFunction
});
property.setZIndex(2);
var PSAStyleFunction = function (feature, resolution) {
  var symbol = feature.get('style');
  var text;
  if (lang === 'el') {
    text = feature.get('name_el');
  } else {
    text = feature.get('name_en');
  }
  if (!styleCache[symbol]) {
    styleCache = [new ol.style.Style({
      image: new ol.style.Icon(({
        src: '../images/maki/renders/' + symbol + '-24.png',
        anchorOrigin: 'bottom-left',
        anchor: [0.5, 0.5],
        scale: 1
      })),
      text: new ol.style.Text({
        text: text,
        stroke: new ol.style.Stroke({
          color: [156, 39, 176, 0.8],
          width: 1
        }),
        offsetY: 12
      })
    })];
  }
  return styleCache;
};
var PSA = new ol.layer.Vector({
  style: PSAStyleFunction,
  maxResolution: 3
});
PSA.setZIndex(1);

function filteredEsateStyle(feature, resolution) {
  var src;
  src = getIconPath(feature.get('sale')) + getIconType(feature.get('estatetype_en')) + '-64.png';
  styleCache = [new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1
    }))
  })];
  return styleCache;
}
var filteredEstates = new ol.layer.Vector({
  source: new ol.source.Vector({
    format: geoJSONFormat
  }),
  id: 'filteredEstates',
  visible: true,
  style: filteredEsateStyle
});
filteredEstates.setZIndex(2);
var selectSource = new ol.source.Vector({});
var selectBox = new ol.layer.Vector({
  source: selectSource,
  style: new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(227, 72, 27, 0.2)'
    }),
    stroke: new ol.style.Stroke({
      color: '#E3481B',
      width: 2
    }),
    image: new ol.style.Circle({
      radius: 7,
      fill: new ol.style.Fill({
        color: '#E3481B'
      })
    })
  })
});
selectBox.setZIndex(3);
var map = new ol.Map({
  target: 'map',
  layers: [mapbox, property, PSA, filteredEstates, selectBox],
  // interactions: ol.interaction.defaults().extend([new ol.interaction.Select({
  //   condition: function(evt) {
  //     return evt.type === 'singleclick' && ol.events.condition.shiftKeyOnly(evt);
  //   },
  //   style: selectStyleFunction
  // })]),
  loadTilesWhileAnimating: true,
  loadTilesWhileInteracting: true,
  renderer: 'canvas',
  controls: ol.control.defaults({
    attributionOptions: {
      collapsible: false,
      collapsed: false
    }
  })
    .extend([
      new ol.control.ScaleLine({
        units: 'metric'
      }), new ol.control.OverviewMap({
        className: 'ol-overviewmap ol-custom-overviewmap',
        collapsible: true,
        collapsed: true,
        layers: [bing]
      }),
      new ol.control.ZoomToExtent({
        extent: extent
      })
    ]),
  view: new ol.View({
    center: center,
    extent: extent,
    projection: 'EPSG:3857',
    zoom: 14,
    maxZoom: 19,
    minZoom: 14
  })
});
if (lang === 'el') {
  bing.set('name', 'Δορυφορική εικόνα');
  mapbox.set('name', 'Χάρτης');
  property.set('name', 'Ακίνητα');
} else {
  bing.set('name', 'Sattelite Image');
  mapbox.set('name', 'Map');
  property.set('name', 'Properties');
}
jQuery(document).ready(function ($) {
  $('.spinner').addClass('visuallyhidden');
  $('.mdl-spinner').removeClass('is-active');
  // handleSelect();
});
$(document)
  .ajaxStart(function () {
    $loading.addClass('is-active');
  })
  .ajaxStop(function () {
    $loading.removeClass('is-active');
  });

window.app || (window.app = {});
var app = window.app;
app.Filters = function (options) {
  this.estateType = options.estateType;
  this.leaseType = options.leaseType !== undefined ? options.leaseType : 'Rent';
  this.startPrice = options.startPrice !== undefined ? options.startPrice : 0;
  this.endPrice = options.endPrice !== undefined ? options.endPrice : 2147483647;
  this.parking = options.parking !== undefined ? options.parking : false;
  this.furnished = options.furnished !== undefined ? options.furnished : false;
  this.heating = options.heating !== undefined ? options.heating : false;
  this.cooling = options.cooling !== undefined ? options.cooling : false;
  this.view = options.view !== undefined ? options.view : false;
};
app.Filters.prototype.createValidator = function () {
  var p = $('form[name=filters]').parsley();
  return p;
};
app.Filters.prototype.setDefaults = function () {
  var epsg4326Extent;
  PSA.setSource(null);
  if (selectSource.getFeatures().length === 0) {
    epsg4326Extent = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
  } else {
    epsg4326Extent = ol.proj.transformExtent(selectSource.getFeatures()[0]
      .getGeometry().getExtent(), 'EPSG:3857', 'EPSG:4326');
  }
  this.extent = epsg4326Extent;
  this.p = this.createValidator();
};
app.Filters.prototype.ajaxCall = function () {
  if (this.p.validate() === true) {
    $.ajax({
      url: 'http://127.0.0.1:3000/db/listed/filters?bbox[x1]=' + this.extent[0] + '&bbox[y1]=' + this.extent[1] + '&bbox[x2]=' + this.extent[2] + '&bbox[y2]=' + this.extent[3],
      type: 'GET',
      dataType: 'json',
      data: {
        estateType: this.estateType,
        leaseType: this.leaseType,
        furnished: this.furnished,
        heating: this.heating,
        parking: this.parking,
        cooling: this.cooling,
        view: this.view,
        startPrice: this.startPrice,
        endPrice: this.endPrice
      }
    }).done(function succeded(data, textStatus, jqXHR) {
      var features = geoJSONFormat.readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
        toastr.clear();
        filteredEstates.getSource().clear();
        filteredEstates.getSource().addFeatures(features);
        filteredEstates.setVisible(true);
        property.setVisible(false);
        toastr.info('Found ' + features.length + ' properties');
    })
    .fail(function failed(jqXHR) {
      // var a = jQuery.parseJSON(jqXHR.responseText); // response is Json so we need to parse
      toastr.clear();
      if (jqXHR.status === 404) {
        toastr.error('No properties found wit these filters');
      } else if (jqXHR.status === 503) {
        toastr.error('Service Unavailable');
      } else {
        toastr.error('Internal Server Error');
      }
      filteredEstates.setVisible(false);
      property.setVisible(true);
    });
  }
};
$('#invokeFilters').click(function () {
  var filters;
  var options = {};
  options.estateType = $('#estateType').val();
  options.leaseType = $('input[name=options]:checked').val();
  options.startPrice = $('#startPrice').val();
  options.endPrice = $('#endPrice').val();
  options.parking = $('#checkbox-1').prop('checked');
  options.furnished = $('#checkbox-2').prop('checked');
  options.heating = $('#checkbox-3').prop('checked');
  options.cooling = $('#checkbox-4').prop('checked');
  options.view = $('#checkbox-5').prop('checked');
  filters = new app.Filters(options);
  filters.setDefaults();
  filters.ajaxCall();
});
$('#clearFilters').click(function () {
  var orignalEstateTypeValue = $('#estateType option').val();
  var orignalPriceRangeValue = $('#priceSelect option').val();
  $('label[for=option-1]').addClass('is-checked');
  $('label[for=option-2]').removeClass('is-checked');
  $('label[for=checkbox-1]').removeClass('is-checked');
  $('label[for=checkbox-2]').removeClass('is-checked');
  $('label[for=checkbox-3]').removeClass('is-checked');
  $('label[for=checkbox-4]').removeClass('is-checked');
  $('label[for=checkbox-5]').removeClass('is-checked');
  $('label[for=checkbox-6]').removeClass('is-checked');
  $('#estateType').siblings().find('.mdl-selectfield__box-value').html(orignalEstateTypeValue);
  $('#priceSelect').siblings().find('.mdl-selectfield__box-value').html(orignalPriceRangeValue);
  $('#startPrice').parent().eq(0).removeClass('is-dirty');
  $('#endPrice').parent().eq(0).removeClass('is-dirty');
  $('#estate-filters').addClass('visuallyhidden');
  $('#price-range').addClass('visuallyhidden');
  filteredEstates.getSource().clear();
  property.setVisible(true);
  PSA.setSource(null);
  selectSource.clear();
  map.removeInteraction(draw);
});
var draw;
function addInteraction() {
  selectSource.clear();
  draw = new ol.interaction.Draw({
    source: selectSource,
    type: 'LineString',
    geometryFunction: geometryFunction,
    maxPoints: 2
  });
  draw.on('drawstart', function () {
    selectSource.clear();
  });
  draw.on('drawend', function () {
    map.removeInteraction(draw);
  });
  map.addInteraction(draw);
}
function geometryFunction(coordinates, geometry) {
  if (!geometry) {
    geometry = new ol.geom.Polygon(null);
  }
  var start = coordinates[0];
  var end = coordinates[1];
  geometry.setCoordinates([
    [
      start,
      [
        start[0], end[1]
      ],
      end,
      [
        end[0], start[1]
      ],
      start
    ]
  ]);
  return geometry;
}
$('#checkbox-6').click(function () {
  if (this.checked) {
    addInteraction();
  } else {
    map.removeInteraction(draw);
    selectSource.clear();
  }
});


var handleFilters = (function handleFilters() {
  'use strict';

  function selectRange() {
    $('#priceSelect').change(function (e) {
      var val = $(this).val();
      if (val === 100000) {
        $('#startPrice').val('0').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('100000').parent().eq(0).addClass('is-dirty');
      } else if (val === 150000) {
        $('#startPrice').val('100000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('150000').parent().eq(0).addClass('is-dirty');
      } else if (val === 200000) {
        $('#startPrice').val('150000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('200000').parent().eq(0).addClass('is-dirty');
      } else if (val === 250000) {
        $('#startPrice').val('200000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('250000').parent().eq(0).addClass('is-dirty');
      } else if (val === 300000) {
        $('#startPrice').val('250000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('300000').parent().eq(0).addClass('is-dirty');
      } else {
        $('#startPrice').val('250000').parent().eq(0).addClass('is-dirty');
        $('#endPrice').val('300000').parent().eq(0).addClass('is-dirty');
      }
    });
  }

  return {
    selectRange: selectRange
  };
}());
function getValueRange(listingType) {
  var saleType = {
    Sale: function sale() {
      $('#priceSelect').change(function (e) {
        var val = $(this).val();
        if (val === '100000') {
          $('#startPrice').val('0').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('100000').parent().eq(0).addClass('is-dirty');
        } else if (val === '150000') {
          $('#startPrice').val('100000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('150000').parent().eq(0).addClass('is-dirty');
        } else if (val === '200000') {
          $('#startPrice').val('150000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('200000').parent().eq(0).addClass('is-dirty');
        } else if (val === '250000') {
          $('#startPrice').val('200000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('250000').parent().eq(0).addClass('is-dirty');
        } else if (val === '300000') {
          $('#startPrice').val('250000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('300000').parent().eq(0).addClass('is-dirty');
        } else {
          $('#startPrice').val('300000').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('');
        }
      });
    },
    Rent: function rent() {
      $('#priceSelect').change(function (e) {
        var val = $(this).val();
        if (val === '300') {
          $('#startPrice').val('0').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('300').parent().eq(0).addClass('is-dirty');
        } else if (val === '450') {
          $('#startPrice').val('300').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('450').parent().eq(0).addClass('is-dirty');
        } else if (val === '600') {
          $('#startPrice').val('450').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('600').parent().eq(0).addClass('is-dirty');
        } else {
          $('#startPrice').val('600').parent().eq(0).addClass('is-dirty');
          $('#endPrice').val('');
        }
      });
    }
  };
  return (saleType[listingType])();
}
$(function () {
  getValueRange('Rent');
  $('input[type=radio][name=options]').change(function () {
    var lang = document.documentElement.lang;
    var value = this.value;
    var type = {
      rangeType: this.value
    };
    if (lang === 'en') {
      type.priceTitle = 'Choose Estate Price';
      type.price = 'Price';
      type.or = 'or Enter Price';
    } else {
      type.priceTitle = 'Επιλέξτε Τιμή Ακινήτου';
      type.price = 'Τιμή';
      type.or = 'ή Εισάγετε Τιμές';
    }
    $('#startPrice').val('').parent().eq(0).removeClass('is-dirty');
    $('#endPrice').val('').parent().eq(0).removeClass('is-dirty');
    dust.render('valueRange', type, function (error, html) {
      $('.priceSelect').html(html);
      componentHandler.upgradeAllRegistered();
      $('#toggle-price-range').on('click', function(event) {
        event.preventDefault();
        if ($('#price-range').hasClass('visuallyhidden')) {
          $('#price-range').removeClass('visuallyhidden');
        } else {
          $('#price-range').addClass('visuallyhidden');
        }
      });
      getValueRange(value);
    });
  }
  );
$('#advanced-filters').on('click', function (event) {
  event.preventDefault();
  if ($('#estate-filters').hasClass('visuallyhidden')) {
    $('#estate-filters').removeClass('visuallyhidden');
  } else {
    $('#estate-filters').addClass('visuallyhidden');
  }
});
$('#toggle-price-range').on('click', function(event) {
  event.preventDefault();
  if ($('#price-range').hasClass('visuallyhidden')) {
    $('#price-range').removeClass('visuallyhidden');
  } else {
    $('#price-range').addClass('visuallyhidden');
  }
});
});
function preventDotAndSpace(e) {
  var key = e.charCode ? e.charCode : e.keyCode;
  this.innerHTML = key;
  if (key === 46 || key === 32) {
    return false;
  }
}

(function () {
  var geolocation = new ol.Geolocation({
    // take the projection to use from the map's view
    projection: map.getView().getProjection(),
    trackingOptions: {
      maximumAge: 10000,
      enableHighAccuracy: true,
      timeout: 600000
    }
  });
  var accuracyFeature = new ol.Feature();
  geolocation.on('change:accuracyGeometry', function () {
    accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
  });
  var positionFeature = new ol.Feature();
  positionFeature.setStyle(new ol.style.Style({
    image: new ol.style.Circle({
      radius: 6,
      fill: new ol.style.Fill({ color: '#3399CC' }),
      stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
    })
  }));
  // listen to changes in position
  geolocation.on('change:position', function () {
    var coordinates = geolocation.getPosition();
    positionFeature.setGeometry(coordinates
      ? new ol.geom.Point(coordinates)
      : null);
  });
  featuresOverlaySource = new ol.source.Vector({});
  var featuresOverlay = new ol.layer.Vector({ map: map, source: featuresOverlaySource });
  $('.geolocation').on('change', function (e) {
    e.preventDefault();
    if ($(this).prop('checked') === true) {
      geolocation.setTracking(true);
      featuresOverlaySource.addFeatures([positionFeature, accuracyFeature]);
    } else {
      geolocation.setTracking(false);
      featuresOverlaySource.clear();
    }
  });
}());

function handleInfo(evt) {
  var coordinate = evt.coordinate;
  var obj = {};
  var title = {};
  var owner = {};
  var features = [];
  var clickedFeature;
  var f;

  map.removeInteraction(draw);
  evt.preventDefault();
  obj.title = title;
  if (lang === 'el') {
    title.gid = 'Κωδικός Ιδιοκτησίας';
    title.type = 'Είδος Ιδιοκτησίας';
    title.listing_type = 'Τύπος Αγγελίας';
    title.area = 'Εμβαδό';
    title.address = 'Διευθυνση';
    title.bedrooms = 'Υπνοδωμάτια';
    title.price = 'Τιμή';
    title.isnew = 'Νεόδμητο';
    title.parking = 'Στάθμεση';
    title.furnished = 'Επιπλωμένο';
    title.pets = 'Κατοικίδια';
    title.view = 'Θέα';
    title.heating = 'Θέρμανση';
    title.cooling = 'Ψύξη';
    title.contactInfo = 'Στοιχεία Επικοινωνίας';
    title.name = 'Όνομα';
    title.lastname = 'Επίθετο';
    title.phone = 'Τηλέφωνο';
    title.email = 'Ηλεκτρονική Διεύθυνση';
  } else {
    title.gid = 'Estate Code';
    title.type = 'Property Type';
    title.listing_type = 'Listing Type';
    title.area = 'Size';
    title.address = 'Address';
    title.bedrooms = 'Bedrooms';
    title.price = 'Price';
    title.isnew = 'Newly Build';
    title.parking = 'Parking';
    title.furnished = 'Furnished';
    title.pets = 'Pets Allowed';
    title.view = 'View';
    title.heating = 'Heating';
    title.cooling = 'Cooling';
    title.contactInfo = 'Contact Info';
    title.name = 'Name';
    title.lastname = 'Last Name';
    title.phone = 'Telephone';
    title.email = 'Email';
  }
  clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
    return {
      feature: feature,
      layer: layer
    };
  }, this, function (layer) {
    if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
      return true;
    }
    return false;
  }, this);
  if (clickedFeature) {
    if (clickedFeature.layer.get('id') === 'estates' && clickedFeature.feature.get('features').length === 1) {
      f = clickedFeature.feature.getProperties().features[0];
      createPSAandCard(f, obj);
    } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
      f = clickedFeature.feature;
      createPSAandCard(f, obj);
    }
  } else {
    PSA.setSource(null);
  }
}

function createPSAandCard(f, obj) {
  var feature = {};
  feature.gid = f.get('gid');
  feature.area = f.get('estatearea');
  if (lang === 'el') {
    feature.type = f.get('estatetype');
    feature.address = f.get('street_el') + ' ' + f.get('street_number');
    feature.name = f.get('name_el');
    feature.lastname = f.get('lastname_el');
    if (f.get('sale') === true) {
      feature.listing_type = 'Πώληση';
    } else {
      feature.listing_type = 'Ενοικίαση';
    }
    feature.btns = {
      info: 'πληροφοριες',
      close: 'κλεισιμο'
    };
  } else {
    feature.type = f.get('estatetype_en');
    feature.address = f.get('street_en') + ' ' + f.get('street_number');
    feature.name = f.get('name_en');
    feature.lastname = f.get('lastname_en');
    if (f.get('sale') === true) {
      feature.listing_type = 'Sale';
    } else {
      feature.listing_type = 'Rent';
    }
    feature.btns = {
      info: 'info',
      close: 'close'
    };
  }
  feature.bedrooms = f.get('bedrooms');
  feature.price = f.get('price');
  feature.isnew = f.get('isnew');
  feature.parking = f.get('parking');
  feature.furnished = f.get('furnished');
  feature.pets = f.get('pets');
  feature.view = f.get('view');
  feature.heating = f.get('heating');
  feature.cooling = f.get('cooling');
  feature.phone = f.get('phone1');
  feature.email = f.get('email');
  feature.coordinate = f.get('geometry').getCoordinates();

  var PSASource = new ol.source.Vector({
    attributions: [new ol.Attribution({
      html: 'POI by ' + '<a href="http://www.terracognita.gr/">Terra Cognita</a>'
    })],
    format: geoJSONFormat,
    loader: function (extent, resolution, projection) {
      var url = 'http://127.0.0.1:3000/db/uses/' + feature.gid;
      var self = this;
      $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json'
      }).done(function succeded(data, textStatus, jqXHR) {
        var features = geoJSONFormat.readFeatures(data.property_services_analysis, {
          featureProjection: 'EPSG:3857'
        });
        var featuresLength = features.length - 1;
        var area = new ol.style.Style({
          fill: new ol.style.Fill({
            color: [156, 39, 176, 0.1]
          })
        });
        features[0].setStyle(area);
        self.addFeatures(features);
        toastr.clear();
        toastr.info('Found ' + featuresLength + ' Points of Interest in 8 minute distance!');
      }).fail(function failed(jqXHR) {
        toastr.clear();
        if (jqXHR.status === 404) {
          toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
        } else if (jqXHR.status === 503) {
          toastr.error('Service Unavailable');
        } else {
          toastr.error('Internal Server Error');
        }
      });
    },
    strategy: ol.loadingstrategy.all
  });
  PSA.setSource(PSASource);
  map.getView().setCenter(feature.coordinate);
  map.getView().setResolution(1.2);
  obj.feature = feature;

  dust.render('estateCards', obj, function renderEstateCards(err, out) {
    $('.estate-cards').html(out);
    $('.mdl-card__title').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/w_432,c_scale/' + obj.feature.gid + '.jpg)');
    $('.estate-cards').addClass('estate-cards-active');
  // $("#infobox").addClass("visuallyhidden");
  });
  $('a[href="#openModal"]').click(function () {
    dust.render('modalInfo', obj, function renderModalInfo(err, out) {
      $('.modal-content').html(out);
      $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + obj.feature.gid + '.jpg)');
    });
  });
  $('a[href="#closeEstateCard"]').click(function () {
    $('.estate-cards').removeClass('estate-cards-active');
  });
}
$('#information').on('click', function (e) {
  PSA.setSource(null);
  if ($(this).prop('checked') === true) {
    map.on('click', handleInfo);
    $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', true);});
  } else {
    map.un('click', handleInfo);
    $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', false);});
  }
});

(function () {
  var marker = new ol.Feature();
  var iconStyle = new ol.style.Style({
    image: new ol.style.Icon(/** @type {olx.style.IconOptions} */
    ({
      anchor: [
        0.5, 1
      ],
      anchorXUnits: 'fraction',
      anchorYUnits: 'fraction',
      opacity: 1,
      scale: 1,
      src: '../images/map-icons/pins/24/pin1.png',
      snapToPixel: false
    })),
    zIndex: 100
  });
  marker.setStyle(iconStyle);
  var featuresOverlayStyle = new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: '#408080',
      width: 5,
      lineDash: [4, 4]
    })
  });
  var featuresOverlay = new ol.layer.Vector({
    map: map,
    source: new ol.source.Vector(),
    style: featuresOverlayStyle,
    id: 'route',
    nameEl: 'Διαδρομή',
    NameEn: 'Route'
  });
  var routeCoords = [];
  function handleMarker(event) {
    event.preventDefault();
    var featureCount = featuresOverlay.getSource().getFeatures().length;
    var coordinates = event.coordinate;
    if (featureCount === 0) {
      marker.setGeometry(new ol.geom.Point(coordinates));
      marker.setId('first');
      featuresOverlay.getSource().addFeature(marker);
      routeCoords[0] = coordinates[0];
      routeCoords[1] = coordinates[1];
    } else if (featureCount === 1) {
      var clone = marker.clone();
      clone.setGeometry(new ol.geom.Point(coordinates));
      clone.setId('second');
      featuresOverlay.getSource().addFeature(clone);
      routeCoords[2] = coordinates[0];
      routeCoords[3] = coordinates[1];
      callRoute(routeCoords);
    } else {
      featuresOverlay.getSource().clear();
    }
  }
  geoJSONFormat = new ol.format.GeoJSON({ defaultDataProjection: 'EPSG:4326', geometryName: 'geometry' });
  function callRoute(routeCoords) {
    var first = ol.proj.transform([
      routeCoords[0], routeCoords[1]
    ], 'EPSG:3857', 'EPSG:4326');
    var second = ol.proj.transform([
      routeCoords[2], routeCoords[3]
    ], 'EPSG:3857', 'EPSG:4326');
    var x1 = first[0];
    var y1 = first[1];
    var x2 = second[0];
    var y2 = second[1];
    $.ajax({
      url: 'https://api.mapbox.com/v4/directions/mapbox.driving/' + x1 + ',' + y1 + ';' + x2 + ',' + y2 + '.json?alternatives=false&access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA',
      type: 'GET',
      dataType: 'json'
    }).done(function (data) {
      var route = {};
      route.type = 'Feature';
      route.geometry = data.routes[0].geometry;
      featuresOverlay.getSource().addFeatures(geoJSONFormat.readFeatures(route, {
        dataProjection: 'EPSG:4326',
        featureProjection: 'EPSG:3857'
      }));
      map.getView().fit(featuresOverlay.getSource().getExtent(), map.getSize());
    }).fail(function () {
      // console.log("error");
    }).always(function () {
      // console.log("complete");
    });
  }
  $('#marker').on('change', function (event) {
    event.preventDefault();
    /* Act on the event */
    if ($(this).prop('checked') === true) {
      map.on('singleclick', handleMarker);
    } else {
      map.un('singleclick', handleMarker);
      featuresOverlay.getSource().clear();
    }
  });
}());

(function () {
  $('#weather').click(function () {
    if ($(this).prop('checked') === true) {
      $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', true);});
      map.getOverlays().forEach(function (ovl) {
        if (ovl.get('name') === 'weather') {
          ($(ovl.getElement()).parent()).remove();
          $(ovl.getElement()).remove();
        }
      });
      var center = ol.proj.transform(map.getView().getCenter(), 'EPSG:3857', 'EPSG:4326');
      var lat = center[1];
      var lon = center[0];
      $.ajax({
        url: 'http://api.openweathermap.org/data/2.5/find?lat=' + lat + '&lon=' + lon + '&cnt=5&cluster=no&units=metric&type=accurate&APPID=f9cd9fa2c427c3b115e87e4862619c5c',
        type: 'GET',
        dataType: 'json'
      }).done(function (data) {
        function createWeatherOverlay(position, index) {
          var elem = document.createElement('div');
          elem.setAttribute('class', 'weather-popup  mdl-shadow--6dp');
          elem.setAttribute('id', index);
          elem.setAttribute('data-name', 'weather');
          return new ol.Overlay({ element: elem, position: position });
        }
        var objs = data.list;
        var overlay,
          coordinates;
        $.each(objs, function (index, val) {
          coordinates = ol.proj.transform([
            val.coord.lon, val.coord.lat
          ], 'EPSG:4326', 'EPSG:3857');
          overlay = createWeatherOverlay(coordinates, index);
          map.addOverlay(overlay);
          overlay.set('name', 'weather');
          weatherData = {
            'name': val.name,
            'temp': val.main.temp,
            'pressure': val.main.pressure,
            'humidity': val.main.humidity
          };
          dust.render('weatherPopup', weatherData, function (err, out) {
            $('#' + index).html(out);
          });
        });
      }).fail(function () {
        // toastr.error("Δεν βρέθηκαν πληροφορίες για τις καιρικές συνθήκες!");
      });
    } else if ($(this).prop('checked') === false) {
      $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', false);});
      map.getOverlays().forEach(function (ovl) {
        if (ovl.get('name') === 'weather') {
          ($(ovl.getElement()).parent()).remove();
          $(ovl.getElement()).remove();
        }
      });
    }
  });
}());

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hcC5qcyIsImZpbHRlcnMuanMiLCJnZW9sb2NhdGlvbi5qcyIsImluZm8uanMiLCJyb3V0aW5nLmpzIiwid2VhdGhlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN4U0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pNQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1hcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgJGxvYWRpbmcgPSAkKCcubWRsLXNwaW5uZXInKTtcclxudmFyIGNlbnRlciA9IFszNjc3Mzg1LCA0MTIwOTQ5XTtcclxudmFyIGV4dGVudCA9IFszNjUyNzcyLCA0MTEyODA4LCAzNzAwMDAwLCA0MTMyNzk3XTtcclxudmFyIGxhbmcgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZztcclxudmFyIHN0eWxlQ2FjaGUgPSB7fTtcclxudmFyIGdlb0pTT05Gb3JtYXQgPSBuZXcgb2wuZm9ybWF0Lkdlb0pTT04oe1xyXG4gIGRlZmF1bHREYXRhUHJvamVjdGlvbjogJ0VQU0c6NDMyNidcclxufSk7XHJcbnRvYXN0ci5vcHRpb25zID0ge1xyXG4gIGNsb3NlQnV0dG9uOiBmYWxzZSxcclxuICBkZWJ1ZzogZmFsc2UsXHJcbiAgbmV3ZXN0T25Ub3A6IGZhbHNlLFxyXG4gIHByb2dyZXNzQmFyOiBmYWxzZSxcclxuICBwb3NpdGlvbkNsYXNzOiAndG9hc3QtdG9wLWNlbnRlcicsXHJcbiAgcHJldmVudER1cGxpY2F0ZXM6IGZhbHNlLFxyXG4gIG9uY2xpY2s6IG51bGwsXHJcbiAgc2hvd0R1cmF0aW9uOiAnMzAwJyxcclxuICBoaWRlRHVyYXRpb246ICcxMDAwJyxcclxuICB0aW1lT3V0OiAnNTAwMCcsXHJcbiAgZXh0ZW5kZWRUaW1lT3V0OiAnMTAwMCcsXHJcbiAgc2hvd0Vhc2luZzogJ3N3aW5nJyxcclxuICBoaWRlRWFzaW5nOiAnbGluZWFyJyxcclxuICBzaG93TWV0aG9kOiAnZmFkZUluJyxcclxuICBoaWRlTWV0aG9kOiAnZmFkZU91dCdcclxufTtcclxudmFyIGJpbmcgPSBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgdmlzaWJsZTogdHJ1ZSxcclxuICBzb3VyY2U6IG5ldyBvbC5zb3VyY2UuQmluZ01hcHMoe1xyXG4gICAga2V5OiAnQWsyR3E4VlVmSUNzUHB1ZjdMUkFOWG1YdDJzSFdtU0xQaG9obVZMRnRGSUV3WWpzXzVNQ3lBaEFGd1JTVnBMaicsXHJcbiAgICBpbWFnZXJ5U2V0OiAnQWVyaWFsJ1xyXG4gIH0pLFxyXG4gIG1heFpvb206IDE5LFxyXG4gIGNyb3NzT3JpZ2luOiAnYW5vbnltb3VzJyxcclxuICBwcmVsb2FkOiBJbmZpbml0eSxcclxuICBpZDogJ2JpbmcnXHJcbn0pO1xyXG52YXIgbWFwYm94ID0gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5YWVooe1xyXG4gICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgaHRtbDogJzxhIGhyZWY9XCJodHRwczovL3d3dy5tYXBib3guY29tL2Fib3V0L21hcHMvXCIgdGFyZ2V0PVwiX2JsYW5rXCI+JmNvcHk7IE1hcGJveCAmY29weTsgT3BlblN0cmVldE1hcDwvYT4nXHJcbiAgICB9KV0sXHJcbiAgICB1cmw6ICdodHRwczovL2FwaS5tYXBib3guY29tL3Y0L21hcGJveC5zdHJlZXRzL3t6fS97eH0ve3l9LnBuZz9hY2Nlc3NfdG9rZW49cGsuZXlKMUlqb2labWx5ZG1GcGJpSXNJbUVpT2lKbE9XWXlZVE0wTlRoaU5XTTBZakpqT0RKak5ERTRPRFF6TnpBMk1HUXlOaUo5Li1OVkRPMjdIenQtd19uUW9zVVBmTEEnXHJcbiAgfSksXHJcbiAgaWQ6ICdtYXBib3gnXHJcbn0pO1xyXG5mdW5jdGlvbiBnZXRJY29uVHlwZShlc3RhdGVUeXBlKSB7XHJcbiAgdmFyIGljb25UeXBlID0ge1xyXG4gICAgQXBhcnRtZW50OiBmdW5jdGlvbiBhcGFydG1lbnRJY29uKCkge1xyXG4gICAgICByZXR1cm4gJ2FwYXJ0bWVudCc7XHJcbiAgICB9LFxyXG4gICAgJ0RldGFjaGVkIEhvdXNlJzogZnVuY3Rpb24gZGV0YWNoZWRIb3VjZUljb24oKSB7XHJcbiAgICAgIHJldHVybiAnZGV0YWNoZWQnO1xyXG4gICAgfSxcclxuICAgIFZpbGxhOiBmdW5jdGlvbiB2aWxsYUljb24oKSB7XHJcbiAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgfSxcclxuICAgIE1haXNvbmV0dGU6IGZ1bmN0aW9uIG1haXNvbmV0dGVJY29uKCkge1xyXG4gICAgICByZXR1cm4gJ3ZpbGxhJztcclxuICAgIH1cclxuICB9O1xyXG4gIHJldHVybiAoaWNvblR5cGVbZXN0YXRlVHlwZV0pKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEljb25QYXRoKGxpc3RpbmdUeXBlKSB7XHJcbiAgdmFyIGljb25QYXRoID0ge1xyXG4gICAgdHJ1ZTogZnVuY3Rpb24gc2FsZUljb24oKSB7XHJcbiAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9zYWxlLyc7XHJcbiAgICB9LFxyXG4gICAgZmFsc2U6IGZ1bmN0aW9uIHJlbnRJY29uKCkge1xyXG4gICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvcmVudC8nO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgcmV0dXJuIChpY29uUGF0aFtsaXN0aW5nVHlwZV0pKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVByb3BlcnR5U3R5bGUoZmVhdHVyZSkge1xyXG4gIHZhciBzcmM7XHJcbiAgc3JjID0gZ2V0SWNvblBhdGgoZmVhdHVyZS5nZXQoJ3NhbGUnKSkgKyBnZXRJY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNDgucG5nJztcclxuICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgIGdlb21ldHJ5OiBmZWF0dXJlLmdldEdlb21ldHJ5KCksXHJcbiAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgc3JjOiBzcmMsXHJcbiAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgYW5jaG9yOiBbMC41LCAwXSxcclxuICAgICAgc2NhbGU6IDFcclxuICAgIH0pKVxyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwcm9wZXJ0eVN0eWxlRnVuY3Rpb24oZmVhdHVyZSwgcmVzb2x1dGlvbikge1xyXG4gIHZhciBzaXplID0gZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJykubGVuZ3RoO1xyXG4gIHZhciBzdHlsZTtcclxuICB2YXIgb3JpZ2luYWxGZWF0dXJlO1xyXG4gIGlmIChzaXplID4gMSkge1xyXG4gICAgc3R5bGUgPSBbbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5DaXJjbGUoe1xyXG4gICAgICAgIHJhZGl1czogMjAsXHJcbiAgICAgICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHtcclxuICAgICAgICAgIGNvbG9yOiBbMTU2LCAzOSwgMTc2LCAxXSxcclxuICAgICAgICAgIHdpZHRoOiA1XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgICAgY29sb3I6IFs2OCwgMTM4LCAyNTUsIDAuOF1cclxuICAgICAgICB9KVxyXG4gICAgICB9KSxcclxuICAgICAgdGV4dDogbmV3IG9sLnN0eWxlLlRleHQoe1xyXG4gICAgICAgIHRleHQ6IHNpemUudG9TdHJpbmcoKSxcclxuICAgICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgICBjb2xvcjogJyNGRkZGRkYnXHJcbiAgICAgICAgfSlcclxuICAgICAgfSksXHJcbiAgICAgIHpJbmRleDogMTAxXHJcbiAgICB9KV07XHJcbiAgfSBlbHNlIHtcclxuICAgIG9yaWdpbmFsRmVhdHVyZSA9IGZlYXR1cmUuZ2V0KCdmZWF0dXJlcycpWzBdO1xyXG4gICAgc3R5bGUgPSBbY3JlYXRlUHJvcGVydHlTdHlsZShvcmlnaW5hbEZlYXR1cmUpXTtcclxuICB9XHJcbiAgcmV0dXJuIHN0eWxlO1xyXG59XHJcblxyXG4vLyBmdW5jdGlvbiBzZWxlY3RTdHlsZUZ1bmN0aW9uKGZlYXR1cmUsIHJlc29sdXRpb24pIHtcclxuLy8gICB2YXIgc3R5bGVzID0gW25ldyBvbC5zdHlsZS5TdHlsZSh7fSldO1xyXG4vLyAgIHZhciBvcmlnaW5hbEZlYXR1cmVzID0gZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJyk7XHJcbi8vICAgdmFyIG9yaWdpbmFGZWF0dXJlO1xyXG4vLyAgIGZvciAodmFyIGkgPSBvcmlnaW5hbEZlYXR1cmVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XHJcbi8vICAgICBvcmlnaW5hbEZlYXR1cmUgPSBvcmlnaW5hbEZlYXR1cmVzW2ldO1xyXG4vLyAgICAgc3R5bGVzLnB1c2goY3JlYXRlUHJvcGVydHlTdHlsZShvcmlnaW5hbEZlYXR1cmUpKTtcclxuLy8gICB9XHJcbi8vICAgcmV0dXJuIHN0eWxlcztcclxuLy8gfVxyXG52YXIgcHJvcGVydHlTb3VyY2UgPSBuZXcgb2wuc291cmNlLlZlY3Rvcih7XHJcbiAgZm9ybWF0OiBnZW9KU09ORm9ybWF0LFxyXG4gIGxvYWRlcjogZnVuY3Rpb24gZmVhdHJlTG9hZGVyKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdGhpcy5jbGVhcigpO1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RlZCcsXHJcbiAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICB9KVxyXG4gICAgICAuZG9uZShmdW5jdGlvbiBzdWNjZWRlZChyZXNwb25zZSkge1xyXG4gICAgICAgIHZhciBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKHJlc3BvbnNlLCB7XHJcbiAgICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZWxmLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgICAgfSlcclxuICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IHByb3BlcnRpZXMhJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICB9XHJcbn0pO1xyXG52YXIgcHJvcGVydHlDbHVzdGVyU291cmNlID0gbmV3IG9sLnNvdXJjZS5DbHVzdGVyKHtcclxuICBkaXN0YW5jZTogNDAsXHJcbiAgc291cmNlOiBwcm9wZXJ0eVNvdXJjZSxcclxuICBhdHRyaWJ1dGlvbnM6IFtuZXcgb2wuQXR0cmlidXRpb24oe1xyXG4gICAgaHRtbDogJ0FsbCBtYXBzIMKpICcgKyAnPGEgaHJlZj1cImh0dHA6Ly93d3cudGVycmFjb2duaXRhLmdyL1wiPlRlcnJhIENvZ25pdGE8L2E+J1xyXG4gIH0pXVxyXG59KTtcclxudmFyIHByb3BlcnR5ID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgc291cmNlOiBwcm9wZXJ0eUNsdXN0ZXJTb3VyY2UsXHJcbiAgaWQ6ICdlc3RhdGVzJyxcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHN0eWxlOiBwcm9wZXJ0eVN0eWxlRnVuY3Rpb25cclxufSk7XHJcbnByb3BlcnR5LnNldFpJbmRleCgyKTtcclxudmFyIFBTQVN0eWxlRnVuY3Rpb24gPSBmdW5jdGlvbiAoZmVhdHVyZSwgcmVzb2x1dGlvbikge1xyXG4gIHZhciBzeW1ib2wgPSBmZWF0dXJlLmdldCgnc3R5bGUnKTtcclxuICB2YXIgdGV4dDtcclxuICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgdGV4dCA9IGZlYXR1cmUuZ2V0KCduYW1lX2VsJyk7XHJcbiAgfSBlbHNlIHtcclxuICAgIHRleHQgPSBmZWF0dXJlLmdldCgnbmFtZV9lbicpO1xyXG4gIH1cclxuICBpZiAoIXN0eWxlQ2FjaGVbc3ltYm9sXSkge1xyXG4gICAgc3R5bGVDYWNoZSA9IFtuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICBzcmM6ICcuLi9pbWFnZXMvbWFraS9yZW5kZXJzLycgKyBzeW1ib2wgKyAnLTI0LnBuZycsXHJcbiAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgIGFuY2hvcjogWzAuNSwgMC41XSxcclxuICAgICAgICBzY2FsZTogMVxyXG4gICAgICB9KSksXHJcbiAgICAgIHRleHQ6IG5ldyBvbC5zdHlsZS5UZXh0KHtcclxuICAgICAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XHJcbiAgICAgICAgICBjb2xvcjogWzE1NiwgMzksIDE3NiwgMC44XSxcclxuICAgICAgICAgIHdpZHRoOiAxXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgb2Zmc2V0WTogMTJcclxuICAgICAgfSlcclxuICAgIH0pXTtcclxuICB9XHJcbiAgcmV0dXJuIHN0eWxlQ2FjaGU7XHJcbn07XHJcbnZhciBQU0EgPSBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICBzdHlsZTogUFNBU3R5bGVGdW5jdGlvbixcclxuICBtYXhSZXNvbHV0aW9uOiAzXHJcbn0pO1xyXG5QU0Euc2V0WkluZGV4KDEpO1xyXG5cclxuZnVuY3Rpb24gZmlsdGVyZWRFc2F0ZVN0eWxlKGZlYXR1cmUsIHJlc29sdXRpb24pIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9IGdldEljb25QYXRoKGZlYXR1cmUuZ2V0KCdzYWxlJykpICsgZ2V0SWNvblR5cGUoZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGVfZW4nKSkgKyAnLTY0LnBuZyc7XHJcbiAgc3R5bGVDYWNoZSA9IFtuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgIHNjYWxlOiAxXHJcbiAgICB9KSlcclxuICB9KV07XHJcbiAgcmV0dXJuIHN0eWxlQ2FjaGU7XHJcbn1cclxudmFyIGZpbHRlcmVkRXN0YXRlcyA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0XHJcbiAgfSksXHJcbiAgaWQ6ICdmaWx0ZXJlZEVzdGF0ZXMnLFxyXG4gIHZpc2libGU6IHRydWUsXHJcbiAgc3R5bGU6IGZpbHRlcmVkRXNhdGVTdHlsZVxyXG59KTtcclxuZmlsdGVyZWRFc3RhdGVzLnNldFpJbmRleCgyKTtcclxudmFyIHNlbGVjdFNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHt9KTtcclxudmFyIHNlbGVjdEJveCA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gIHNvdXJjZTogc2VsZWN0U291cmNlLFxyXG4gIHN0eWxlOiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICBjb2xvcjogJ3JnYmEoMjI3LCA3MiwgMjcsIDAuMiknXHJcbiAgICB9KSxcclxuICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XHJcbiAgICAgIGNvbG9yOiAnI0UzNDgxQicsXHJcbiAgICAgIHdpZHRoOiAyXHJcbiAgICB9KSxcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuQ2lyY2xlKHtcclxuICAgICAgcmFkaXVzOiA3LFxyXG4gICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgY29sb3I6ICcjRTM0ODFCJ1xyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9KVxyXG59KTtcclxuc2VsZWN0Qm94LnNldFpJbmRleCgzKTtcclxudmFyIG1hcCA9IG5ldyBvbC5NYXAoe1xyXG4gIHRhcmdldDogJ21hcCcsXHJcbiAgbGF5ZXJzOiBbbWFwYm94LCBwcm9wZXJ0eSwgUFNBLCBmaWx0ZXJlZEVzdGF0ZXMsIHNlbGVjdEJveF0sXHJcbiAgLy8gaW50ZXJhY3Rpb25zOiBvbC5pbnRlcmFjdGlvbi5kZWZhdWx0cygpLmV4dGVuZChbbmV3IG9sLmludGVyYWN0aW9uLlNlbGVjdCh7XHJcbiAgLy8gICBjb25kaXRpb246IGZ1bmN0aW9uKGV2dCkge1xyXG4gIC8vICAgICByZXR1cm4gZXZ0LnR5cGUgPT09ICdzaW5nbGVjbGljaycgJiYgb2wuZXZlbnRzLmNvbmRpdGlvbi5zaGlmdEtleU9ubHkoZXZ0KTtcclxuICAvLyAgIH0sXHJcbiAgLy8gICBzdHlsZTogc2VsZWN0U3R5bGVGdW5jdGlvblxyXG4gIC8vIH0pXSksXHJcbiAgbG9hZFRpbGVzV2hpbGVBbmltYXRpbmc6IHRydWUsXHJcbiAgbG9hZFRpbGVzV2hpbGVJbnRlcmFjdGluZzogdHJ1ZSxcclxuICByZW5kZXJlcjogJ2NhbnZhcycsXHJcbiAgY29udHJvbHM6IG9sLmNvbnRyb2wuZGVmYXVsdHMoe1xyXG4gICAgYXR0cmlidXRpb25PcHRpb25zOiB7XHJcbiAgICAgIGNvbGxhcHNpYmxlOiBmYWxzZSxcclxuICAgICAgY29sbGFwc2VkOiBmYWxzZVxyXG4gICAgfVxyXG4gIH0pXHJcbiAgICAuZXh0ZW5kKFtcclxuICAgICAgbmV3IG9sLmNvbnRyb2wuU2NhbGVMaW5lKHtcclxuICAgICAgICB1bml0czogJ21ldHJpYydcclxuICAgICAgfSksIG5ldyBvbC5jb250cm9sLk92ZXJ2aWV3TWFwKHtcclxuICAgICAgICBjbGFzc05hbWU6ICdvbC1vdmVydmlld21hcCBvbC1jdXN0b20tb3ZlcnZpZXdtYXAnLFxyXG4gICAgICAgIGNvbGxhcHNpYmxlOiB0cnVlLFxyXG4gICAgICAgIGNvbGxhcHNlZDogdHJ1ZSxcclxuICAgICAgICBsYXllcnM6IFtiaW5nXVxyXG4gICAgICB9KSxcclxuICAgICAgbmV3IG9sLmNvbnRyb2wuWm9vbVRvRXh0ZW50KHtcclxuICAgICAgICBleHRlbnQ6IGV4dGVudFxyXG4gICAgICB9KVxyXG4gICAgXSksXHJcbiAgdmlldzogbmV3IG9sLlZpZXcoe1xyXG4gICAgY2VudGVyOiBjZW50ZXIsXHJcbiAgICBleHRlbnQ6IGV4dGVudCxcclxuICAgIHByb2plY3Rpb246ICdFUFNHOjM4NTcnLFxyXG4gICAgem9vbTogMTQsXHJcbiAgICBtYXhab29tOiAxOSxcclxuICAgIG1pblpvb206IDE0XHJcbiAgfSlcclxufSk7XHJcbmlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgYmluZy5zZXQoJ25hbWUnLCAnzpTOv8+Bz4XPhs6/z4HOuc66zq4gzrXOuc66z4zOvc6xJyk7XHJcbiAgbWFwYm94LnNldCgnbmFtZScsICfOp86sz4HPhM63z4InKTtcclxuICBwcm9wZXJ0eS5zZXQoJ25hbWUnLCAnzpHOus6vzr3Ot8+EzrEnKTtcclxufSBlbHNlIHtcclxuICBiaW5nLnNldCgnbmFtZScsICdTYXR0ZWxpdGUgSW1hZ2UnKTtcclxuICBtYXBib3guc2V0KCduYW1lJywgJ01hcCcpO1xyXG4gIHByb3BlcnR5LnNldCgnbmFtZScsICdQcm9wZXJ0aWVzJyk7XHJcbn1cclxualF1ZXJ5KGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoJCkge1xyXG4gICQoJy5zcGlubmVyJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgJCgnLm1kbC1zcGlubmVyJykucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIC8vIGhhbmRsZVNlbGVjdCgpO1xyXG59KTtcclxuJChkb2N1bWVudClcclxuICAuYWpheFN0YXJ0KGZ1bmN0aW9uICgpIHtcclxuICAgICRsb2FkaW5nLmFkZENsYXNzKCdpcy1hY3RpdmUnKTtcclxuICB9KVxyXG4gIC5hamF4U3RvcChmdW5jdGlvbiAoKSB7XHJcbiAgICAkbG9hZGluZy5yZW1vdmVDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSk7XHJcbiIsIndpbmRvdy5hcHAgfHwgKHdpbmRvdy5hcHAgPSB7fSk7XHJcbnZhciBhcHAgPSB3aW5kb3cuYXBwO1xyXG5hcHAuRmlsdGVycyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgdGhpcy5lc3RhdGVUeXBlID0gb3B0aW9ucy5lc3RhdGVUeXBlO1xyXG4gIHRoaXMubGVhc2VUeXBlID0gb3B0aW9ucy5sZWFzZVR5cGUgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubGVhc2VUeXBlIDogJ1JlbnQnO1xyXG4gIHRoaXMuc3RhcnRQcmljZSA9IG9wdGlvbnMuc3RhcnRQcmljZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zdGFydFByaWNlIDogMDtcclxuICB0aGlzLmVuZFByaWNlID0gb3B0aW9ucy5lbmRQcmljZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5lbmRQcmljZSA6IDIxNDc0ODM2NDc7XHJcbiAgdGhpcy5wYXJraW5nID0gb3B0aW9ucy5wYXJraW5nICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnBhcmtpbmcgOiBmYWxzZTtcclxuICB0aGlzLmZ1cm5pc2hlZCA9IG9wdGlvbnMuZnVybmlzaGVkICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmZ1cm5pc2hlZCA6IGZhbHNlO1xyXG4gIHRoaXMuaGVhdGluZyA9IG9wdGlvbnMuaGVhdGluZyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5oZWF0aW5nIDogZmFsc2U7XHJcbiAgdGhpcy5jb29saW5nID0gb3B0aW9ucy5jb29saW5nICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvb2xpbmcgOiBmYWxzZTtcclxuICB0aGlzLnZpZXcgPSBvcHRpb25zLnZpZXcgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudmlldyA6IGZhbHNlO1xyXG59O1xyXG5hcHAuRmlsdGVycy5wcm90b3R5cGUuY3JlYXRlVmFsaWRhdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBwID0gJCgnZm9ybVtuYW1lPWZpbHRlcnNdJykucGFyc2xleSgpO1xyXG4gIHJldHVybiBwO1xyXG59O1xyXG5hcHAuRmlsdGVycy5wcm90b3R5cGUuc2V0RGVmYXVsdHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGVwc2c0MzI2RXh0ZW50O1xyXG4gIFBTQS5zZXRTb3VyY2UobnVsbCk7XHJcbiAgaWYgKHNlbGVjdFNvdXJjZS5nZXRGZWF0dXJlcygpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgZXBzZzQzMjZFeHRlbnQgPSBvbC5wcm9qLnRyYW5zZm9ybUV4dGVudChleHRlbnQsICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGVwc2c0MzI2RXh0ZW50ID0gb2wucHJvai50cmFuc2Zvcm1FeHRlbnQoc2VsZWN0U291cmNlLmdldEZlYXR1cmVzKClbMF1cclxuICAgICAgLmdldEdlb21ldHJ5KCkuZ2V0RXh0ZW50KCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgfVxyXG4gIHRoaXMuZXh0ZW50ID0gZXBzZzQzMjZFeHRlbnQ7XHJcbiAgdGhpcy5wID0gdGhpcy5jcmVhdGVWYWxpZGF0b3IoKTtcclxufTtcclxuYXBwLkZpbHRlcnMucHJvdG90eXBlLmFqYXhDYWxsID0gZnVuY3Rpb24gKCkge1xyXG4gIGlmICh0aGlzLnAudmFsaWRhdGUoKSA9PT0gdHJ1ZSkge1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RlZC9maWx0ZXJzP2Jib3hbeDFdPScgKyB0aGlzLmV4dGVudFswXSArICcmYmJveFt5MV09JyArIHRoaXMuZXh0ZW50WzFdICsgJyZiYm94W3gyXT0nICsgdGhpcy5leHRlbnRbMl0gKyAnJmJib3hbeTJdPScgKyB0aGlzLmV4dGVudFszXSxcclxuICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBlc3RhdGVUeXBlOiB0aGlzLmVzdGF0ZVR5cGUsXHJcbiAgICAgICAgbGVhc2VUeXBlOiB0aGlzLmxlYXNlVHlwZSxcclxuICAgICAgICBmdXJuaXNoZWQ6IHRoaXMuZnVybmlzaGVkLFxyXG4gICAgICAgIGhlYXRpbmc6IHRoaXMuaGVhdGluZyxcclxuICAgICAgICBwYXJraW5nOiB0aGlzLnBhcmtpbmcsXHJcbiAgICAgICAgY29vbGluZzogdGhpcy5jb29saW5nLFxyXG4gICAgICAgIHZpZXc6IHRoaXMudmlldyxcclxuICAgICAgICBzdGFydFByaWNlOiB0aGlzLnN0YXJ0UHJpY2UsXHJcbiAgICAgICAgZW5kUHJpY2U6IHRoaXMuZW5kUHJpY2VcclxuICAgICAgfVxyXG4gICAgfSkuZG9uZShmdW5jdGlvbiBzdWNjZWRlZChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLCB7XHJcbiAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgIH0pO1xyXG4gICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgIGZpbHRlcmVkRXN0YXRlcy5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgIGZpbHRlcmVkRXN0YXRlcy5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICAgICAgZmlsdGVyZWRFc3RhdGVzLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgcHJvcGVydHkuc2V0VmlzaWJsZShmYWxzZSk7XHJcbiAgICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlcy5sZW5ndGggKyAnIHByb3BlcnRpZXMnKTtcclxuICAgIH0pXHJcbiAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIpIHtcclxuICAgICAgLy8gdmFyIGEgPSBqUXVlcnkucGFyc2VKU09OKGpxWEhSLnJlc3BvbnNlVGV4dCk7IC8vIHJlc3BvbnNlIGlzIEpzb24gc28gd2UgbmVlZCB0byBwYXJzZVxyXG4gICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKCdObyBwcm9wZXJ0aWVzIGZvdW5kIHdpdCB0aGVzZSBmaWx0ZXJzJyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICB9XHJcbiAgICAgIGZpbHRlcmVkRXN0YXRlcy5zZXRWaXNpYmxlKGZhbHNlKTtcclxuICAgICAgcHJvcGVydHkuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxufTtcclxuJCgnI2ludm9rZUZpbHRlcnMnKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGZpbHRlcnM7XHJcbiAgdmFyIG9wdGlvbnMgPSB7fTtcclxuICBvcHRpb25zLmVzdGF0ZVR5cGUgPSAkKCcjZXN0YXRlVHlwZScpLnZhbCgpO1xyXG4gIG9wdGlvbnMubGVhc2VUeXBlID0gJCgnaW5wdXRbbmFtZT1vcHRpb25zXTpjaGVja2VkJykudmFsKCk7XHJcbiAgb3B0aW9ucy5zdGFydFByaWNlID0gJCgnI3N0YXJ0UHJpY2UnKS52YWwoKTtcclxuICBvcHRpb25zLmVuZFByaWNlID0gJCgnI2VuZFByaWNlJykudmFsKCk7XHJcbiAgb3B0aW9ucy5wYXJraW5nID0gJCgnI2NoZWNrYm94LTEnKS5wcm9wKCdjaGVja2VkJyk7XHJcbiAgb3B0aW9ucy5mdXJuaXNoZWQgPSAkKCcjY2hlY2tib3gtMicpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBvcHRpb25zLmhlYXRpbmcgPSAkKCcjY2hlY2tib3gtMycpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBvcHRpb25zLmNvb2xpbmcgPSAkKCcjY2hlY2tib3gtNCcpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBvcHRpb25zLnZpZXcgPSAkKCcjY2hlY2tib3gtNScpLnByb3AoJ2NoZWNrZWQnKTtcclxuICBmaWx0ZXJzID0gbmV3IGFwcC5GaWx0ZXJzKG9wdGlvbnMpO1xyXG4gIGZpbHRlcnMuc2V0RGVmYXVsdHMoKTtcclxuICBmaWx0ZXJzLmFqYXhDYWxsKCk7XHJcbn0pO1xyXG4kKCcjY2xlYXJGaWx0ZXJzJykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gIHZhciBvcmlnbmFsRXN0YXRlVHlwZVZhbHVlID0gJCgnI2VzdGF0ZVR5cGUgb3B0aW9uJykudmFsKCk7XHJcbiAgdmFyIG9yaWduYWxQcmljZVJhbmdlVmFsdWUgPSAkKCcjcHJpY2VTZWxlY3Qgb3B0aW9uJykudmFsKCk7XHJcbiAgJCgnbGFiZWxbZm9yPW9wdGlvbi0xXScpLmFkZENsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnbGFiZWxbZm9yPW9wdGlvbi0yXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnbGFiZWxbZm9yPWNoZWNrYm94LTFdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAkKCdsYWJlbFtmb3I9Y2hlY2tib3gtMl0nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICQoJ2xhYmVsW2Zvcj1jaGVja2JveC0zXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnbGFiZWxbZm9yPWNoZWNrYm94LTRdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAkKCdsYWJlbFtmb3I9Y2hlY2tib3gtNV0nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICQoJ2xhYmVsW2Zvcj1jaGVja2JveC02XScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgJCgnI2VzdGF0ZVR5cGUnKS5zaWJsaW5ncygpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwob3JpZ25hbEVzdGF0ZVR5cGVWYWx1ZSk7XHJcbiAgJCgnI3ByaWNlU2VsZWN0Jykuc2libGluZ3MoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKG9yaWduYWxQcmljZVJhbmdlVmFsdWUpO1xyXG4gICQoJyNzdGFydFByaWNlJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgJCgnI2VuZFByaWNlJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgJCgnI2VzdGF0ZS1maWx0ZXJzJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgJCgnI3ByaWNlLXJhbmdlJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgZmlsdGVyZWRFc3RhdGVzLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgcHJvcGVydHkuc2V0VmlzaWJsZSh0cnVlKTtcclxuICBQU0Euc2V0U291cmNlKG51bGwpO1xyXG4gIHNlbGVjdFNvdXJjZS5jbGVhcigpO1xyXG4gIG1hcC5yZW1vdmVJbnRlcmFjdGlvbihkcmF3KTtcclxufSk7XHJcbnZhciBkcmF3O1xyXG5mdW5jdGlvbiBhZGRJbnRlcmFjdGlvbigpIHtcclxuICBzZWxlY3RTb3VyY2UuY2xlYXIoKTtcclxuICBkcmF3ID0gbmV3IG9sLmludGVyYWN0aW9uLkRyYXcoe1xyXG4gICAgc291cmNlOiBzZWxlY3RTb3VyY2UsXHJcbiAgICB0eXBlOiAnTGluZVN0cmluZycsXHJcbiAgICBnZW9tZXRyeUZ1bmN0aW9uOiBnZW9tZXRyeUZ1bmN0aW9uLFxyXG4gICAgbWF4UG9pbnRzOiAyXHJcbiAgfSk7XHJcbiAgZHJhdy5vbignZHJhd3N0YXJ0JywgZnVuY3Rpb24gKCkge1xyXG4gICAgc2VsZWN0U291cmNlLmNsZWFyKCk7XHJcbiAgfSk7XHJcbiAgZHJhdy5vbignZHJhd2VuZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgIG1hcC5yZW1vdmVJbnRlcmFjdGlvbihkcmF3KTtcclxuICB9KTtcclxuICBtYXAuYWRkSW50ZXJhY3Rpb24oZHJhdyk7XHJcbn1cclxuZnVuY3Rpb24gZ2VvbWV0cnlGdW5jdGlvbihjb29yZGluYXRlcywgZ2VvbWV0cnkpIHtcclxuICBpZiAoIWdlb21ldHJ5KSB7XHJcbiAgICBnZW9tZXRyeSA9IG5ldyBvbC5nZW9tLlBvbHlnb24obnVsbCk7XHJcbiAgfVxyXG4gIHZhciBzdGFydCA9IGNvb3JkaW5hdGVzWzBdO1xyXG4gIHZhciBlbmQgPSBjb29yZGluYXRlc1sxXTtcclxuICBnZW9tZXRyeS5zZXRDb29yZGluYXRlcyhbXHJcbiAgICBbXHJcbiAgICAgIHN0YXJ0LFxyXG4gICAgICBbXHJcbiAgICAgICAgc3RhcnRbMF0sIGVuZFsxXVxyXG4gICAgICBdLFxyXG4gICAgICBlbmQsXHJcbiAgICAgIFtcclxuICAgICAgICBlbmRbMF0sIHN0YXJ0WzFdXHJcbiAgICAgIF0sXHJcbiAgICAgIHN0YXJ0XHJcbiAgICBdXHJcbiAgXSk7XHJcbiAgcmV0dXJuIGdlb21ldHJ5O1xyXG59XHJcbiQoJyNjaGVja2JveC02JykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gIGlmICh0aGlzLmNoZWNrZWQpIHtcclxuICAgIGFkZEludGVyYWN0aW9uKCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIG1hcC5yZW1vdmVJbnRlcmFjdGlvbihkcmF3KTtcclxuICAgIHNlbGVjdFNvdXJjZS5jbGVhcigpO1xyXG4gIH1cclxufSk7XHJcblxyXG5cclxudmFyIGhhbmRsZUZpbHRlcnMgPSAoZnVuY3Rpb24gaGFuZGxlRmlsdGVycygpIHtcclxuICAndXNlIHN0cmljdCc7XHJcblxyXG4gIGZ1bmN0aW9uIHNlbGVjdFJhbmdlKCkge1xyXG4gICAgJCgnI3ByaWNlU2VsZWN0JykuY2hhbmdlKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgIHZhciB2YWwgPSAkKHRoaXMpLnZhbCgpO1xyXG4gICAgICBpZiAodmFsID09PSAxMDAwMDApIHtcclxuICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMTAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsID09PSAxNTAwMDApIHtcclxuICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMTAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCcxNTAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgfSBlbHNlIGlmICh2YWwgPT09IDIwMDAwMCkge1xyXG4gICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCcxNTAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzIwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gMjUwMDAwKSB7XHJcbiAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzIwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMjUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsID09PSAzMDAwMDApIHtcclxuICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMjUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCczMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMjUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCczMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc2VsZWN0UmFuZ2U6IHNlbGVjdFJhbmdlXHJcbiAgfTtcclxufSgpKTtcclxuZnVuY3Rpb24gZ2V0VmFsdWVSYW5nZShsaXN0aW5nVHlwZSkge1xyXG4gIHZhciBzYWxlVHlwZSA9IHtcclxuICAgIFNhbGU6IGZ1bmN0aW9uIHNhbGUoKSB7XHJcbiAgICAgICQoJyNwcmljZVNlbGVjdCcpLmNoYW5nZShmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciB2YWwgPSAkKHRoaXMpLnZhbCgpO1xyXG4gICAgICAgIGlmICh2YWwgPT09ICcxMDAwMDAnKSB7XHJcbiAgICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCcxMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gJzE1MDAwMCcpIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCcxMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMTUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT09ICcyMDAwMDAnKSB7XHJcbiAgICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMTUwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzIwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsID09PSAnMjUwMDAwJykge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzIwMDAwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCcyNTAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gJzMwMDAwMCcpIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCcyNTAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMzAwMDAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNzdGFydFByaWNlJykudmFsKCczMDAwMDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBSZW50OiBmdW5jdGlvbiByZW50KCkge1xyXG4gICAgICAkKCcjcHJpY2VTZWxlY3QnKS5jaGFuZ2UoZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgdmFsID0gJCh0aGlzKS52YWwoKTtcclxuICAgICAgICBpZiAodmFsID09PSAnMzAwJykge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICQoJyNlbmRQcmljZScpLnZhbCgnMzAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT09ICc0NTAnKSB7XHJcbiAgICAgICAgICAkKCcjc3RhcnRQcmljZScpLnZhbCgnMzAwJykucGFyZW50KCkuZXEoMCkuYWRkQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAkKCcjZW5kUHJpY2UnKS52YWwoJzQ1MCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsID09PSAnNjAwJykge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzQ1MCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCc2MDAnKS5wYXJlbnQoKS5lcSgwKS5hZGRDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI3N0YXJ0UHJpY2UnKS52YWwoJzYwMCcpLnBhcmVudCgpLmVxKDApLmFkZENsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgJCgnI2VuZFByaWNlJykudmFsKCcnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgcmV0dXJuIChzYWxlVHlwZVtsaXN0aW5nVHlwZV0pKCk7XHJcbn1cclxuJChmdW5jdGlvbiAoKSB7XHJcbiAgZ2V0VmFsdWVSYW5nZSgnUmVudCcpO1xyXG4gICQoJ2lucHV0W3R5cGU9cmFkaW9dW25hbWU9b3B0aW9uc10nKS5jaGFuZ2UoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGxhbmcgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZztcclxuICAgIHZhciB2YWx1ZSA9IHRoaXMudmFsdWU7XHJcbiAgICB2YXIgdHlwZSA9IHtcclxuICAgICAgcmFuZ2VUeXBlOiB0aGlzLnZhbHVlXHJcbiAgICB9O1xyXG4gICAgaWYgKGxhbmcgPT09ICdlbicpIHtcclxuICAgICAgdHlwZS5wcmljZVRpdGxlID0gJ0Nob29zZSBFc3RhdGUgUHJpY2UnO1xyXG4gICAgICB0eXBlLnByaWNlID0gJ1ByaWNlJztcclxuICAgICAgdHlwZS5vciA9ICdvciBFbnRlciBQcmljZSc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0eXBlLnByaWNlVGl0bGUgPSAnzpXPgM65zrvOrc6+z4TOtSDOpM65zrzOriDOkc66zrnOvc6uz4TOv8+FJztcclxuICAgICAgdHlwZS5wcmljZSA9ICfOpM65zrzOric7XHJcbiAgICAgIHR5cGUub3IgPSAnzq4gzpXOuc+DzqzOs861z4TOtSDOpM65zrzOrc+CJztcclxuICAgIH1cclxuICAgICQoJyNzdGFydFByaWNlJykudmFsKCcnKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgICQoJyNlbmRQcmljZScpLnZhbCgnJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICBkdXN0LnJlbmRlcigndmFsdWVSYW5nZScsIHR5cGUsIGZ1bmN0aW9uIChlcnJvciwgaHRtbCkge1xyXG4gICAgICAkKCcucHJpY2VTZWxlY3QnKS5odG1sKGh0bWwpO1xyXG4gICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVBbGxSZWdpc3RlcmVkKCk7XHJcbiAgICAgICQoJyN0b2dnbGUtcHJpY2UtcmFuZ2UnKS5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgaWYgKCQoJyNwcmljZS1yYW5nZScpLmhhc0NsYXNzKCd2aXN1YWxseWhpZGRlbicpKSB7XHJcbiAgICAgICAgICAkKCcjcHJpY2UtcmFuZ2UnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI3ByaWNlLXJhbmdlJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgZ2V0VmFsdWVSYW5nZSh2YWx1ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgKTtcclxuJCgnI2FkdmFuY2VkLWZpbHRlcnMnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIGlmICgkKCcjZXN0YXRlLWZpbHRlcnMnKS5oYXNDbGFzcygndmlzdWFsbHloaWRkZW4nKSkge1xyXG4gICAgJCgnI2VzdGF0ZS1maWx0ZXJzJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgfSBlbHNlIHtcclxuICAgICQoJyNlc3RhdGUtZmlsdGVycycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gIH1cclxufSk7XHJcbiQoJyN0b2dnbGUtcHJpY2UtcmFuZ2UnKS5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkge1xyXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgaWYgKCQoJyNwcmljZS1yYW5nZScpLmhhc0NsYXNzKCd2aXN1YWxseWhpZGRlbicpKSB7XHJcbiAgICAkKCcjcHJpY2UtcmFuZ2UnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICB9IGVsc2Uge1xyXG4gICAgJCgnI3ByaWNlLXJhbmdlJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgfVxyXG59KTtcclxufSk7XHJcbmZ1bmN0aW9uIHByZXZlbnREb3RBbmRTcGFjZShlKSB7XHJcbiAgdmFyIGtleSA9IGUuY2hhckNvZGUgPyBlLmNoYXJDb2RlIDogZS5rZXlDb2RlO1xyXG4gIHRoaXMuaW5uZXJIVE1MID0ga2V5O1xyXG4gIGlmIChrZXkgPT09IDQ2IHx8IGtleSA9PT0gMzIpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbn1cclxuIiwiKGZ1bmN0aW9uICgpIHtcclxuICB2YXIgZ2VvbG9jYXRpb24gPSBuZXcgb2wuR2VvbG9jYXRpb24oe1xyXG4gICAgLy8gdGFrZSB0aGUgcHJvamVjdGlvbiB0byB1c2UgZnJvbSB0aGUgbWFwJ3Mgdmlld1xyXG4gICAgcHJvamVjdGlvbjogbWFwLmdldFZpZXcoKS5nZXRQcm9qZWN0aW9uKCksXHJcbiAgICB0cmFja2luZ09wdGlvbnM6IHtcclxuICAgICAgbWF4aW11bUFnZTogMTAwMDAsXHJcbiAgICAgIGVuYWJsZUhpZ2hBY2N1cmFjeTogdHJ1ZSxcclxuICAgICAgdGltZW91dDogNjAwMDAwXHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgdmFyIGFjY3VyYWN5RmVhdHVyZSA9IG5ldyBvbC5GZWF0dXJlKCk7XHJcbiAgZ2VvbG9jYXRpb24ub24oJ2NoYW5nZTphY2N1cmFjeUdlb21ldHJ5JywgZnVuY3Rpb24gKCkge1xyXG4gICAgYWNjdXJhY3lGZWF0dXJlLnNldEdlb21ldHJ5KGdlb2xvY2F0aW9uLmdldEFjY3VyYWN5R2VvbWV0cnkoKSk7XHJcbiAgfSk7XHJcbiAgdmFyIHBvc2l0aW9uRmVhdHVyZSA9IG5ldyBvbC5GZWF0dXJlKCk7XHJcbiAgcG9zaXRpb25GZWF0dXJlLnNldFN0eWxlKG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkNpcmNsZSh7XHJcbiAgICAgIHJhZGl1czogNixcclxuICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoeyBjb2xvcjogJyMzMzk5Q0MnIH0pLFxyXG4gICAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2UoeyBjb2xvcjogJyNmZmYnLCB3aWR0aDogMiB9KVxyXG4gICAgfSlcclxuICB9KSk7XHJcbiAgLy8gbGlzdGVuIHRvIGNoYW5nZXMgaW4gcG9zaXRpb25cclxuICBnZW9sb2NhdGlvbi5vbignY2hhbmdlOnBvc2l0aW9uJywgZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGNvb3JkaW5hdGVzID0gZ2VvbG9jYXRpb24uZ2V0UG9zaXRpb24oKTtcclxuICAgIHBvc2l0aW9uRmVhdHVyZS5zZXRHZW9tZXRyeShjb29yZGluYXRlc1xyXG4gICAgICA/IG5ldyBvbC5nZW9tLlBvaW50KGNvb3JkaW5hdGVzKVxyXG4gICAgICA6IG51bGwpO1xyXG4gIH0pO1xyXG4gIGZlYXR1cmVzT3ZlcmxheVNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHt9KTtcclxuICB2YXIgZmVhdHVyZXNPdmVybGF5ID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7IG1hcDogbWFwLCBzb3VyY2U6IGZlYXR1cmVzT3ZlcmxheVNvdXJjZSB9KTtcclxuICAkKCcuZ2VvbG9jYXRpb24nKS5vbignY2hhbmdlJywgZnVuY3Rpb24gKGUpIHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGlmICgkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKSA9PT0gdHJ1ZSkge1xyXG4gICAgICBnZW9sb2NhdGlvbi5zZXRUcmFja2luZyh0cnVlKTtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5U291cmNlLmFkZEZlYXR1cmVzKFtwb3NpdGlvbkZlYXR1cmUsIGFjY3VyYWN5RmVhdHVyZV0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZ2VvbG9jYXRpb24uc2V0VHJhY2tpbmcoZmFsc2UpO1xyXG4gICAgICBmZWF0dXJlc092ZXJsYXlTb3VyY2UuY2xlYXIoKTtcclxuICAgIH1cclxuICB9KTtcclxufSgpKTtcclxuIiwiZnVuY3Rpb24gaGFuZGxlSW5mbyhldnQpIHtcclxuICB2YXIgY29vcmRpbmF0ZSA9IGV2dC5jb29yZGluYXRlO1xyXG4gIHZhciBvYmogPSB7fTtcclxuICB2YXIgdGl0bGUgPSB7fTtcclxuICB2YXIgb3duZXIgPSB7fTtcclxuICB2YXIgZmVhdHVyZXMgPSBbXTtcclxuICB2YXIgY2xpY2tlZEZlYXR1cmU7XHJcbiAgdmFyIGY7XHJcblxyXG4gIG1hcC5yZW1vdmVJbnRlcmFjdGlvbihkcmF3KTtcclxuICBldnQucHJldmVudERlZmF1bHQoKTtcclxuICBvYmoudGl0bGUgPSB0aXRsZTtcclxuICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgdGl0bGUuZ2lkID0gJ86az4nOtM65zrrPjM+CIM6ZzrTOuc6/zrrPhM63z4POr86xz4InO1xyXG4gICAgdGl0bGUudHlwZSA9ICfOlc6vzrTOv8+CIM6ZzrTOuc6/zrrPhM63z4POr86xz4InO1xyXG4gICAgdGl0bGUubGlzdGluZ190eXBlID0gJ86kz43PgM6/z4IgzpHOs86zzrXOu86vzrHPgic7XHJcbiAgICB0aXRsZS5hcmVhID0gJ86VzrzOss6xzrTPjCc7XHJcbiAgICB0aXRsZS5hZGRyZXNzID0gJ86UzrnOtc+FzrjPhc69z4POtyc7XHJcbiAgICB0aXRsZS5iZWRyb29tcyA9ICfOpc+Azr3Ov860z4nOvM6sz4TOuc6xJztcclxuICAgIHRpdGxlLnByaWNlID0gJ86kzrnOvM6uJztcclxuICAgIHRpdGxlLmlzbmV3ID0gJ86dzrXPjM60zrzOt8+Ezr8nO1xyXG4gICAgdGl0bGUucGFya2luZyA9ICfOo8+EzqzOuM68zrXPg863JztcclxuICAgIHRpdGxlLmZ1cm5pc2hlZCA9ICfOlc+AzrnPgM67z4nOvM6tzr3Ovyc7XHJcbiAgICB0aXRsZS5wZXRzID0gJ86azrHPhM6/zrnOus6vzrTOuc6xJztcclxuICAgIHRpdGxlLnZpZXcgPSAnzpjOrc6xJztcclxuICAgIHRpdGxlLmhlYXRpbmcgPSAnzpjOrc+BzrzOsc69z4POtyc7XHJcbiAgICB0aXRsZS5jb29saW5nID0gJ86oz43Ovs63JztcclxuICAgIHRpdGxlLmNvbnRhY3RJbmZvID0gJ86jz4TOv865z4fOtc6vzrEgzpXPgM65zrrOv865zr3Pic69zq/Osc+CJztcclxuICAgIHRpdGxlLm5hbWUgPSAnzozOvc6/zrzOsSc7XHJcbiAgICB0aXRsZS5sYXN0bmFtZSA9ICfOlc+Azq/OuM61z4TOvyc7XHJcbiAgICB0aXRsZS5waG9uZSA9ICfOpM63zrvOrc+Gz4nOvc6/JztcclxuICAgIHRpdGxlLmVtYWlsID0gJ86XzrvOtc66z4TPgc6/zr3Ouc66zq4gzpTOuc61z43OuM+Fzr3Pg863JztcclxuICB9IGVsc2Uge1xyXG4gICAgdGl0bGUuZ2lkID0gJ0VzdGF0ZSBDb2RlJztcclxuICAgIHRpdGxlLnR5cGUgPSAnUHJvcGVydHkgVHlwZSc7XHJcbiAgICB0aXRsZS5saXN0aW5nX3R5cGUgPSAnTGlzdGluZyBUeXBlJztcclxuICAgIHRpdGxlLmFyZWEgPSAnU2l6ZSc7XHJcbiAgICB0aXRsZS5hZGRyZXNzID0gJ0FkZHJlc3MnO1xyXG4gICAgdGl0bGUuYmVkcm9vbXMgPSAnQmVkcm9vbXMnO1xyXG4gICAgdGl0bGUucHJpY2UgPSAnUHJpY2UnO1xyXG4gICAgdGl0bGUuaXNuZXcgPSAnTmV3bHkgQnVpbGQnO1xyXG4gICAgdGl0bGUucGFya2luZyA9ICdQYXJraW5nJztcclxuICAgIHRpdGxlLmZ1cm5pc2hlZCA9ICdGdXJuaXNoZWQnO1xyXG4gICAgdGl0bGUucGV0cyA9ICdQZXRzIEFsbG93ZWQnO1xyXG4gICAgdGl0bGUudmlldyA9ICdWaWV3JztcclxuICAgIHRpdGxlLmhlYXRpbmcgPSAnSGVhdGluZyc7XHJcbiAgICB0aXRsZS5jb29saW5nID0gJ0Nvb2xpbmcnO1xyXG4gICAgdGl0bGUuY29udGFjdEluZm8gPSAnQ29udGFjdCBJbmZvJztcclxuICAgIHRpdGxlLm5hbWUgPSAnTmFtZSc7XHJcbiAgICB0aXRsZS5sYXN0bmFtZSA9ICdMYXN0IE5hbWUnO1xyXG4gICAgdGl0bGUucGhvbmUgPSAnVGVsZXBob25lJztcclxuICAgIHRpdGxlLmVtYWlsID0gJ0VtYWlsJztcclxuICB9XHJcbiAgY2xpY2tlZEZlYXR1cmUgPSBtYXAuZm9yRWFjaEZlYXR1cmVBdFBpeGVsKGV2dC5waXhlbCwgZnVuY3Rpb24gKGZlYXR1cmUsIGxheWVyKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBmZWF0dXJlOiBmZWF0dXJlLFxyXG4gICAgICBsYXllcjogbGF5ZXJcclxuICAgIH07XHJcbiAgfSwgdGhpcywgZnVuY3Rpb24gKGxheWVyKSB7XHJcbiAgICBpZiAobGF5ZXIuZ2V0KCdpZCcpID09PSAnZXN0YXRlcycgfHwgbGF5ZXIuZ2V0KCdpZCcpID09PSAnZmlsdGVyZWRFc3RhdGVzJykge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9LCB0aGlzKTtcclxuICBpZiAoY2xpY2tlZEZlYXR1cmUpIHtcclxuICAgIGlmIChjbGlja2VkRmVhdHVyZS5sYXllci5nZXQoJ2lkJykgPT09ICdlc3RhdGVzJyAmJiBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLmdldCgnZmVhdHVyZXMnKS5sZW5ndGggPT09IDEpIHtcclxuICAgICAgZiA9IGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuZ2V0UHJvcGVydGllcygpLmZlYXR1cmVzWzBdO1xyXG4gICAgICBjcmVhdGVQU0FhbmRDYXJkKGYsIG9iaik7XHJcbiAgICB9IGVsc2UgaWYgKGNsaWNrZWRGZWF0dXJlLmxheWVyLmdldCgnaWQnKSA9PT0gJ2ZpbHRlcmVkRXN0YXRlcycpIHtcclxuICAgICAgZiA9IGNsaWNrZWRGZWF0dXJlLmZlYXR1cmU7XHJcbiAgICAgIGNyZWF0ZVBTQWFuZENhcmQoZiwgb2JqKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgUFNBLnNldFNvdXJjZShudWxsKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVBTQWFuZENhcmQoZiwgb2JqKSB7XHJcbiAgdmFyIGZlYXR1cmUgPSB7fTtcclxuICBmZWF0dXJlLmdpZCA9IGYuZ2V0KCdnaWQnKTtcclxuICBmZWF0dXJlLmFyZWEgPSBmLmdldCgnZXN0YXRlYXJlYScpO1xyXG4gIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgICBmZWF0dXJlLnR5cGUgPSBmLmdldCgnZXN0YXRldHlwZScpO1xyXG4gICAgZmVhdHVyZS5hZGRyZXNzID0gZi5nZXQoJ3N0cmVldF9lbCcpICsgJyAnICsgZi5nZXQoJ3N0cmVldF9udW1iZXInKTtcclxuICAgIGZlYXR1cmUubmFtZSA9IGYuZ2V0KCduYW1lX2VsJyk7XHJcbiAgICBmZWF0dXJlLmxhc3RuYW1lID0gZi5nZXQoJ2xhc3RuYW1lX2VsJyk7XHJcbiAgICBpZiAoZi5nZXQoJ3NhbGUnKSA9PT0gdHJ1ZSkge1xyXG4gICAgICBmZWF0dXJlLmxpc3RpbmdfdHlwZSA9ICfOoM+OzrvOt8+DzrcnO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZmVhdHVyZS5saXN0aW5nX3R5cGUgPSAnzpXOvc6/zrnOus6vzrHPg863JztcclxuICAgIH1cclxuICAgIGZlYXR1cmUuYnRucyA9IHtcclxuICAgICAgaW5mbzogJ8+AzrvOt8+Bzr/Phs6/z4HOuc61z4InLFxyXG4gICAgICBjbG9zZTogJ866zrvOtc65z4POuc68zr8nXHJcbiAgICB9O1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmZWF0dXJlLnR5cGUgPSBmLmdldCgnZXN0YXRldHlwZV9lbicpO1xyXG4gICAgZmVhdHVyZS5hZGRyZXNzID0gZi5nZXQoJ3N0cmVldF9lbicpICsgJyAnICsgZi5nZXQoJ3N0cmVldF9udW1iZXInKTtcclxuICAgIGZlYXR1cmUubmFtZSA9IGYuZ2V0KCduYW1lX2VuJyk7XHJcbiAgICBmZWF0dXJlLmxhc3RuYW1lID0gZi5nZXQoJ2xhc3RuYW1lX2VuJyk7XHJcbiAgICBpZiAoZi5nZXQoJ3NhbGUnKSA9PT0gdHJ1ZSkge1xyXG4gICAgICBmZWF0dXJlLmxpc3RpbmdfdHlwZSA9ICdTYWxlJztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZlYXR1cmUubGlzdGluZ190eXBlID0gJ1JlbnQnO1xyXG4gICAgfVxyXG4gICAgZmVhdHVyZS5idG5zID0ge1xyXG4gICAgICBpbmZvOiAnaW5mbycsXHJcbiAgICAgIGNsb3NlOiAnY2xvc2UnXHJcbiAgICB9O1xyXG4gIH1cclxuICBmZWF0dXJlLmJlZHJvb21zID0gZi5nZXQoJ2JlZHJvb21zJyk7XHJcbiAgZmVhdHVyZS5wcmljZSA9IGYuZ2V0KCdwcmljZScpO1xyXG4gIGZlYXR1cmUuaXNuZXcgPSBmLmdldCgnaXNuZXcnKTtcclxuICBmZWF0dXJlLnBhcmtpbmcgPSBmLmdldCgncGFya2luZycpO1xyXG4gIGZlYXR1cmUuZnVybmlzaGVkID0gZi5nZXQoJ2Z1cm5pc2hlZCcpO1xyXG4gIGZlYXR1cmUucGV0cyA9IGYuZ2V0KCdwZXRzJyk7XHJcbiAgZmVhdHVyZS52aWV3ID0gZi5nZXQoJ3ZpZXcnKTtcclxuICBmZWF0dXJlLmhlYXRpbmcgPSBmLmdldCgnaGVhdGluZycpO1xyXG4gIGZlYXR1cmUuY29vbGluZyA9IGYuZ2V0KCdjb29saW5nJyk7XHJcbiAgZmVhdHVyZS5waG9uZSA9IGYuZ2V0KCdwaG9uZTEnKTtcclxuICBmZWF0dXJlLmVtYWlsID0gZi5nZXQoJ2VtYWlsJyk7XHJcbiAgZmVhdHVyZS5jb29yZGluYXRlID0gZi5nZXQoJ2dlb21ldHJ5JykuZ2V0Q29vcmRpbmF0ZXMoKTtcclxuXHJcbiAgdmFyIFBTQVNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgIGh0bWw6ICdQT0kgYnkgJyArICc8YSBocmVmPVwiaHR0cDovL3d3dy50ZXJyYWNvZ25pdGEuZ3IvXCI+VGVycmEgQ29nbml0YTwvYT4nXHJcbiAgICB9KV0sXHJcbiAgICBmb3JtYXQ6IGdlb0pTT05Gb3JtYXQsXHJcbiAgICBsb2FkZXI6IGZ1bmN0aW9uIChleHRlbnQsIHJlc29sdXRpb24sIHByb2plY3Rpb24pIHtcclxuICAgICAgdmFyIHVybCA9ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvdXNlcy8nICsgZmVhdHVyZS5naWQ7XHJcbiAgICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6IHVybCxcclxuICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICAgIH0pLmRvbmUoZnVuY3Rpb24gc3VjY2VkZWQoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLnByb3BlcnR5X3NlcnZpY2VzX2FuYWx5c2lzLCB7XHJcbiAgICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICB9KTtcclxuICAgICAgICB2YXIgZmVhdHVyZXNMZW5ndGggPSBmZWF0dXJlcy5sZW5ndGggLSAxO1xyXG4gICAgICAgIHZhciBhcmVhID0gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAgICAgY29sb3I6IFsxNTYsIDM5LCAxNzYsIDAuMV1cclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZmVhdHVyZXNbMF0uc2V0U3R5bGUoYXJlYSk7XHJcbiAgICAgICAgc2VsZi5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlc0xlbmd0aCArICcgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4gICAgICB9KS5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUikge1xyXG4gICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHN0cmF0ZWd5OiBvbC5sb2FkaW5nc3RyYXRlZ3kuYWxsXHJcbiAgfSk7XHJcbiAgUFNBLnNldFNvdXJjZShQU0FTb3VyY2UpO1xyXG4gIG1hcC5nZXRWaWV3KCkuc2V0Q2VudGVyKGZlYXR1cmUuY29vcmRpbmF0ZSk7XHJcbiAgbWFwLmdldFZpZXcoKS5zZXRSZXNvbHV0aW9uKDEuMik7XHJcbiAgb2JqLmZlYXR1cmUgPSBmZWF0dXJlO1xyXG5cclxuICBkdXN0LnJlbmRlcignZXN0YXRlQ2FyZHMnLCBvYmosIGZ1bmN0aW9uIHJlbmRlckVzdGF0ZUNhcmRzKGVyciwgb3V0KSB7XHJcbiAgICAkKCcuZXN0YXRlLWNhcmRzJykuaHRtbChvdXQpO1xyXG4gICAgJCgnLm1kbC1jYXJkX190aXRsZScpLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoaHR0cDovL3Jlcy5jbG91ZGluYXJ5LmNvbS9maXJ2YWluL2ltYWdlL3VwbG9hZC93XzQzMixjX3NjYWxlLycgKyBvYmouZmVhdHVyZS5naWQgKyAnLmpwZyknKTtcclxuICAgICQoJy5lc3RhdGUtY2FyZHMnKS5hZGRDbGFzcygnZXN0YXRlLWNhcmRzLWFjdGl2ZScpO1xyXG4gIC8vICQoXCIjaW5mb2JveFwiKS5hZGRDbGFzcyhcInZpc3VhbGx5aGlkZGVuXCIpO1xyXG4gIH0pO1xyXG4gICQoJ2FbaHJlZj1cIiNvcGVuTW9kYWxcIl0nKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgICBkdXN0LnJlbmRlcignbW9kYWxJbmZvJywgb2JqLCBmdW5jdGlvbiByZW5kZXJNb2RhbEluZm8oZXJyLCBvdXQpIHtcclxuICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgICQoJy5iaWctaW1hZ2UnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKGh0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvaF8yMjIsY19zY2FsZS8nICsgb2JqLmZlYXR1cmUuZ2lkICsgJy5qcGcpJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuICAkKCdhW2hyZWY9XCIjY2xvc2VFc3RhdGVDYXJkXCJdJykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gICAgJCgnLmVzdGF0ZS1jYXJkcycpLnJlbW92ZUNsYXNzKCdlc3RhdGUtY2FyZHMtYWN0aXZlJyk7XHJcbiAgfSk7XHJcbn1cclxuJCgnI2luZm9ybWF0aW9uJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHtcclxuICBQU0Euc2V0U291cmNlKG51bGwpO1xyXG4gIGlmICgkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKSA9PT0gdHJ1ZSkge1xyXG4gICAgbWFwLm9uKCdjbGljaycsIGhhbmRsZUluZm8pO1xyXG4gICAgJCh0aGlzKS5wYXJlbnQoKS5zaWJsaW5ncygpLmZpbmQoJ2lucHV0JykuZWFjaChmdW5jdGlvbiAoKSB7JCh0aGlzKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO30pO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBtYXAudW4oJ2NsaWNrJywgaGFuZGxlSW5mbyk7XHJcbiAgICAkKHRoaXMpLnBhcmVudCgpLnNpYmxpbmdzKCkuZmluZCgnaW5wdXQnKS5lYWNoKGZ1bmN0aW9uICgpIHskKHRoaXMpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO30pO1xyXG4gIH1cclxufSk7XHJcbiIsIihmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIG1hcmtlciA9IG5ldyBvbC5GZWF0dXJlKCk7XHJcbiAgdmFyIGljb25TdHlsZSA9IG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oLyoqIEB0eXBlIHtvbHguc3R5bGUuSWNvbk9wdGlvbnN9ICovXHJcbiAgICAoe1xyXG4gICAgICBhbmNob3I6IFtcclxuICAgICAgICAwLjUsIDFcclxuICAgICAgXSxcclxuICAgICAgYW5jaG9yWFVuaXRzOiAnZnJhY3Rpb24nLFxyXG4gICAgICBhbmNob3JZVW5pdHM6ICdmcmFjdGlvbicsXHJcbiAgICAgIG9wYWNpdHk6IDEsXHJcbiAgICAgIHNjYWxlOiAxLFxyXG4gICAgICBzcmM6ICcuLi9pbWFnZXMvbWFwLWljb25zL3BpbnMvMjQvcGluMS5wbmcnLFxyXG4gICAgICBzbmFwVG9QaXhlbDogZmFsc2VcclxuICAgIH0pKSxcclxuICAgIHpJbmRleDogMTAwXHJcbiAgfSk7XHJcbiAgbWFya2VyLnNldFN0eWxlKGljb25TdHlsZSk7XHJcbiAgdmFyIGZlYXR1cmVzT3ZlcmxheVN0eWxlID0gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XHJcbiAgICAgIGNvbG9yOiAnIzQwODA4MCcsXHJcbiAgICAgIHdpZHRoOiA1LFxyXG4gICAgICBsaW5lRGFzaDogWzQsIDRdXHJcbiAgICB9KVxyXG4gIH0pO1xyXG4gIHZhciBmZWF0dXJlc092ZXJsYXkgPSBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICAgIG1hcDogbWFwLFxyXG4gICAgc291cmNlOiBuZXcgb2wuc291cmNlLlZlY3RvcigpLFxyXG4gICAgc3R5bGU6IGZlYXR1cmVzT3ZlcmxheVN0eWxlLFxyXG4gICAgaWQ6ICdyb3V0ZScsXHJcbiAgICBuYW1lRWw6ICfOlM65zrHOtM+Bzr/OvM6uJyxcclxuICAgIE5hbWVFbjogJ1JvdXRlJ1xyXG4gIH0pO1xyXG4gIHZhciByb3V0ZUNvb3JkcyA9IFtdO1xyXG4gIGZ1bmN0aW9uIGhhbmRsZU1hcmtlcihldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIHZhciBmZWF0dXJlQ291bnQgPSBmZWF0dXJlc092ZXJsYXkuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZXMoKS5sZW5ndGg7XHJcbiAgICB2YXIgY29vcmRpbmF0ZXMgPSBldmVudC5jb29yZGluYXRlO1xyXG4gICAgaWYgKGZlYXR1cmVDb3VudCA9PT0gMCkge1xyXG4gICAgICBtYXJrZXIuc2V0R2VvbWV0cnkobmV3IG9sLmdlb20uUG9pbnQoY29vcmRpbmF0ZXMpKTtcclxuICAgICAgbWFya2VyLnNldElkKCdmaXJzdCcpO1xyXG4gICAgICBmZWF0dXJlc092ZXJsYXkuZ2V0U291cmNlKCkuYWRkRmVhdHVyZShtYXJrZXIpO1xyXG4gICAgICByb3V0ZUNvb3Jkc1swXSA9IGNvb3JkaW5hdGVzWzBdO1xyXG4gICAgICByb3V0ZUNvb3Jkc1sxXSA9IGNvb3JkaW5hdGVzWzFdO1xyXG4gICAgfSBlbHNlIGlmIChmZWF0dXJlQ291bnQgPT09IDEpIHtcclxuICAgICAgdmFyIGNsb25lID0gbWFya2VyLmNsb25lKCk7XHJcbiAgICAgIGNsb25lLnNldEdlb21ldHJ5KG5ldyBvbC5nZW9tLlBvaW50KGNvb3JkaW5hdGVzKSk7XHJcbiAgICAgIGNsb25lLnNldElkKCdzZWNvbmQnKTtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5LmdldFNvdXJjZSgpLmFkZEZlYXR1cmUoY2xvbmUpO1xyXG4gICAgICByb3V0ZUNvb3Jkc1syXSA9IGNvb3JkaW5hdGVzWzBdO1xyXG4gICAgICByb3V0ZUNvb3Jkc1szXSA9IGNvb3JkaW5hdGVzWzFdO1xyXG4gICAgICBjYWxsUm91dGUocm91dGVDb29yZHMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5LmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIGdlb0pTT05Gb3JtYXQgPSBuZXcgb2wuZm9ybWF0Lkdlb0pTT04oeyBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnLCBnZW9tZXRyeU5hbWU6ICdnZW9tZXRyeScgfSk7XHJcbiAgZnVuY3Rpb24gY2FsbFJvdXRlKHJvdXRlQ29vcmRzKSB7XHJcbiAgICB2YXIgZmlyc3QgPSBvbC5wcm9qLnRyYW5zZm9ybShbXHJcbiAgICAgIHJvdXRlQ29vcmRzWzBdLCByb3V0ZUNvb3Jkc1sxXVxyXG4gICAgXSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgIHZhciBzZWNvbmQgPSBvbC5wcm9qLnRyYW5zZm9ybShbXHJcbiAgICAgIHJvdXRlQ29vcmRzWzJdLCByb3V0ZUNvb3Jkc1szXVxyXG4gICAgXSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgIHZhciB4MSA9IGZpcnN0WzBdO1xyXG4gICAgdmFyIHkxID0gZmlyc3RbMV07XHJcbiAgICB2YXIgeDIgPSBzZWNvbmRbMF07XHJcbiAgICB2YXIgeTIgPSBzZWNvbmRbMV07XHJcbiAgICAkLmFqYXgoe1xyXG4gICAgICB1cmw6ICdodHRwczovL2FwaS5tYXBib3guY29tL3Y0L2RpcmVjdGlvbnMvbWFwYm94LmRyaXZpbmcvJyArIHgxICsgJywnICsgeTEgKyAnOycgKyB4MiArICcsJyArIHkyICsgJy5qc29uP2FsdGVybmF0aXZlcz1mYWxzZSZhY2Nlc3NfdG9rZW49cGsuZXlKMUlqb2labWx5ZG1GcGJpSXNJbUVpT2lKbE9XWXlZVE0wTlRoaU5XTTBZakpqT0RKak5ERTRPRFF6TnpBMk1HUXlOaUo5Li1OVkRPMjdIenQtd19uUW9zVVBmTEEnLFxyXG4gICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgZGF0YVR5cGU6ICdqc29uJ1xyXG4gICAgfSkuZG9uZShmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICB2YXIgcm91dGUgPSB7fTtcclxuICAgICAgcm91dGUudHlwZSA9ICdGZWF0dXJlJztcclxuICAgICAgcm91dGUuZ2VvbWV0cnkgPSBkYXRhLnJvdXRlc1swXS5nZW9tZXRyeTtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5LmdldFNvdXJjZSgpLmFkZEZlYXR1cmVzKGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKHJvdXRlLCB7XHJcbiAgICAgICAgZGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnLFxyXG4gICAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICB9KSk7XHJcbiAgICAgIG1hcC5nZXRWaWV3KCkuZml0KGZlYXR1cmVzT3ZlcmxheS5nZXRTb3VyY2UoKS5nZXRFeHRlbnQoKSwgbWFwLmdldFNpemUoKSk7XHJcbiAgICB9KS5mYWlsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgLy8gY29uc29sZS5sb2coXCJlcnJvclwiKTtcclxuICAgIH0pLmFsd2F5cyhmdW5jdGlvbiAoKSB7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKFwiY29tcGxldGVcIik7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgJCgnI21hcmtlcicpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAvKiBBY3Qgb24gdGhlIGV2ZW50ICovXHJcbiAgICBpZiAoJCh0aGlzKS5wcm9wKCdjaGVja2VkJykgPT09IHRydWUpIHtcclxuICAgICAgbWFwLm9uKCdzaW5nbGVjbGljaycsIGhhbmRsZU1hcmtlcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBtYXAudW4oJ3NpbmdsZWNsaWNrJywgaGFuZGxlTWFya2VyKTtcclxuICAgICAgZmVhdHVyZXNPdmVybGF5LmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn0oKSk7XHJcbiIsIihmdW5jdGlvbiAoKSB7XHJcbiAgJCgnI3dlYXRoZXInKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoJCh0aGlzKS5wcm9wKCdjaGVja2VkJykgPT09IHRydWUpIHtcclxuICAgICAgJCh0aGlzKS5wYXJlbnQoKS5zaWJsaW5ncygpLmZpbmQoJ2lucHV0JykuZWFjaChmdW5jdGlvbiAoKSB7JCh0aGlzKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO30pO1xyXG4gICAgICBtYXAuZ2V0T3ZlcmxheXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChvdmwpIHtcclxuICAgICAgICBpZiAob3ZsLmdldCgnbmFtZScpID09PSAnd2VhdGhlcicpIHtcclxuICAgICAgICAgICgkKG92bC5nZXRFbGVtZW50KCkpLnBhcmVudCgpKS5yZW1vdmUoKTtcclxuICAgICAgICAgICQob3ZsLmdldEVsZW1lbnQoKSkucmVtb3ZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgdmFyIGNlbnRlciA9IG9sLnByb2oudHJhbnNmb3JtKG1hcC5nZXRWaWV3KCkuZ2V0Q2VudGVyKCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICAgIHZhciBsYXQgPSBjZW50ZXJbMV07XHJcbiAgICAgIHZhciBsb24gPSBjZW50ZXJbMF07XHJcbiAgICAgICQuYWpheCh7XHJcbiAgICAgICAgdXJsOiAnaHR0cDovL2FwaS5vcGVud2VhdGhlcm1hcC5vcmcvZGF0YS8yLjUvZmluZD9sYXQ9JyArIGxhdCArICcmbG9uPScgKyBsb24gKyAnJmNudD01JmNsdXN0ZXI9bm8mdW5pdHM9bWV0cmljJnR5cGU9YWNjdXJhdGUmQVBQSUQ9ZjljZDlmYTJjNDI3YzNiMTE1ZTg3ZTQ4NjI2MTljNWMnLFxyXG4gICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgICAgfSkuZG9uZShmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdlYXRoZXJPdmVybGF5KHBvc2l0aW9uLCBpbmRleCkge1xyXG4gICAgICAgICAgdmFyIGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCdjbGFzcycsICd3ZWF0aGVyLXBvcHVwICBtZGwtc2hhZG93LS02ZHAnKTtcclxuICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCdpZCcsIGluZGV4KTtcclxuICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCdkYXRhLW5hbWUnLCAnd2VhdGhlcicpO1xyXG4gICAgICAgICAgcmV0dXJuIG5ldyBvbC5PdmVybGF5KHsgZWxlbWVudDogZWxlbSwgcG9zaXRpb246IHBvc2l0aW9uIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgb2JqcyA9IGRhdGEubGlzdDtcclxuICAgICAgICB2YXIgb3ZlcmxheSxcclxuICAgICAgICAgIGNvb3JkaW5hdGVzO1xyXG4gICAgICAgICQuZWFjaChvYmpzLCBmdW5jdGlvbiAoaW5kZXgsIHZhbCkge1xyXG4gICAgICAgICAgY29vcmRpbmF0ZXMgPSBvbC5wcm9qLnRyYW5zZm9ybShbXHJcbiAgICAgICAgICAgIHZhbC5jb29yZC5sb24sIHZhbC5jb29yZC5sYXRcclxuICAgICAgICAgIF0sICdFUFNHOjQzMjYnLCAnRVBTRzozODU3Jyk7XHJcbiAgICAgICAgICBvdmVybGF5ID0gY3JlYXRlV2VhdGhlck92ZXJsYXkoY29vcmRpbmF0ZXMsIGluZGV4KTtcclxuICAgICAgICAgIG1hcC5hZGRPdmVybGF5KG92ZXJsYXkpO1xyXG4gICAgICAgICAgb3ZlcmxheS5zZXQoJ25hbWUnLCAnd2VhdGhlcicpO1xyXG4gICAgICAgICAgd2VhdGhlckRhdGEgPSB7XHJcbiAgICAgICAgICAgICduYW1lJzogdmFsLm5hbWUsXHJcbiAgICAgICAgICAgICd0ZW1wJzogdmFsLm1haW4udGVtcCxcclxuICAgICAgICAgICAgJ3ByZXNzdXJlJzogdmFsLm1haW4ucHJlc3N1cmUsXHJcbiAgICAgICAgICAgICdodW1pZGl0eSc6IHZhbC5tYWluLmh1bWlkaXR5XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgZHVzdC5yZW5kZXIoJ3dlYXRoZXJQb3B1cCcsIHdlYXRoZXJEYXRhLCBmdW5jdGlvbiAoZXJyLCBvdXQpIHtcclxuICAgICAgICAgICAgJCgnIycgKyBpbmRleCkuaHRtbChvdXQpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pLmZhaWwoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIHRvYXN0ci5lcnJvcihcIs6UzrXOvSDOss+Bzq3OuM63zrrOsc69IM+AzrvOt8+Bzr/Phs6/z4HOr861z4IgzrPOuc6xIM+EzrnPgiDOus6xzrnPgc65zrrOrc+CIM+Dz4XOvc64zq7Ous61z4IhXCIpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSBpZiAoJCh0aGlzKS5wcm9wKCdjaGVja2VkJykgPT09IGZhbHNlKSB7XHJcbiAgICAgICQodGhpcykucGFyZW50KCkuc2libGluZ3MoKS5maW5kKCdpbnB1dCcpLmVhY2goZnVuY3Rpb24gKCkgeyQodGhpcykucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSk7fSk7XHJcbiAgICAgIG1hcC5nZXRPdmVybGF5cygpLmZvckVhY2goZnVuY3Rpb24gKG92bCkge1xyXG4gICAgICAgIGlmIChvdmwuZ2V0KCduYW1lJykgPT09ICd3ZWF0aGVyJykge1xyXG4gICAgICAgICAgKCQob3ZsLmdldEVsZW1lbnQoKSkucGFyZW50KCkpLnJlbW92ZSgpO1xyXG4gICAgICAgICAgJChvdmwuZ2V0RWxlbWVudCgpKS5yZW1vdmUoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59KCkpO1xyXG4iXX0=
