(function () {

  if ( typeof window.CustomEvent === "function" ) return false;

  function CustomEvent ( event, params ) {
    params = params || { bubbles: false, cancelable: false, detail: undefined };
    var evt = document.createEvent( 'CustomEvent' );
    evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
    return evt;
   }

  CustomEvent.prototype = window.Event.prototype;

  window.CustomEvent = CustomEvent;
})();

  (function () {
    if (!Element.prototype.scrollIntoViewIfNeeded) {
      Element.prototype.scrollIntoViewIfNeeded = function (centerIfNeeded) {
        centerIfNeeded = arguments.length === 0 ? true : !!centerIfNeeded;

        var parent = this.parentNode,
        parentComputedStyle = window.getComputedStyle(parent, null),
        parentBorderTopWidth = parseInt(parentComputedStyle.getPropertyValue('border-top-width')),
        parentBorderLeftWidth = parseInt(parentComputedStyle.getPropertyValue('border-left-width')),
        overTop = this.offsetTop - parent.offsetTop < parent.scrollTop,
        overBottom = (this.offsetTop - parent.offsetTop + this.clientHeight - parentBorderTopWidth) > (parent.scrollTop + parent.clientHeight),
        overLeft = this.offsetLeft - parent.offsetLeft < parent.scrollLeft,
        overRight = (this.offsetLeft - parent.offsetLeft + this.clientWidth - parentBorderLeftWidth) > (parent.scrollLeft + parent.clientWidth),
        alignWithTop = overTop && !overBottom;

        if ((overTop || overBottom) && centerIfNeeded) {
          parent.scrollTop = this.offsetTop - parent.offsetTop - parent.clientHeight / 2 - parentBorderTopWidth + this.clientHeight / 2;
        }

        if ((overLeft || overRight) && centerIfNeeded) {
          parent.scrollLeft = this.offsetLeft - parent.offsetLeft - parent.clientWidth / 2 - parentBorderLeftWidth + this.clientWidth / 2;
        }

        if ((overTop || overBottom || overLeft || overRight) && !centerIfNeeded) {
          this.scrollIntoView(alignWithTop);
        }
      };
    }
  })();

window.App || (window.App = {});
window.App.config = {
  promises: {
    dustBluebird: Promise.promisifyAll(dust),
    cloudinaryBird: Promise.promisifyAll($.cloudinary)
  },
  commons: {
    map: {},
    trans: {}
  },
  cache: {
    activeEstate: {},
    activeEstateListing: {}
  },
  modules: {
    map: {},
    info: {},
    edit: {},
    delete: {},
    insert: {},
    filters: {}
  }
};
window.App.utils = {};
// var trans;
// var cloudinaryBird = Promise.promisifyAll($.cloudinary);
// var activeEstate;
// var activeEstateListing;
$.cloudinary.config({ cloud_name: 'firvain', api_key: '375138932689591' });

/*eslint no-param-reassign: ["error", { "props": false }]*/
App.utils = {
  findById: function findById(map, id) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (id === layers.item(i).get('id')) {
        return layers.item(i);
      }
    }
    return null;
  },
  findByName: function findByName(map, name) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (name === layers.item(i).get('name')) {
        return layers.item(i);
      }
    }
    return null;
  },
  preventDotAndSpace: function preventDotAndSpace(e) {
    var key = e.charCode ? e.charCode : e.keyCode;
    this.innerHTML = key;
    if (key === 46 || key === 32) {
      return false;
    }
    return true;
  },
  geometryFunction: function geometryFunction(coordinates, geometry) {
    var geom = geometry;
    var start;
    var end;
    if (!geom) {
      geom = new ol.geom.Polygon(null);
    }
    start = coordinates[0];
    end = coordinates[1];
    geom.setCoordinates([
      [start, [start[0], end[1]], end, [end[0], start[1]], start]
    ]);
    return geom;
  },
  hasClass: function hasClass(el, className) {
    if (el.classList) {
      return el.classList.contains(className);
    }
    return new RegExp('(^| )' + className + '( |$)', 'gi').test(el.className);
  },
  removeClass: function removeClass(el, className) {
    var element = el;
    if (element.classList) {
      element.classList.remove(className);
    } else {
      element.className = element.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
    }
  },
  addClass: function removeClass(el, className) {
    var element = el;
    if (element.classList) {
      element.classList.add(className);
    } else {
      element.className += ' ' + className;
    }
  },
  toggleClass: function toggleClass(el, className) {
    var classes;
    var existingIndex;
    var element = el;
    if (element.classList) {
      element.classList.toggle(className);
    } else {
      classes = element.className.split(' ');
      existingIndex = classes.indexOf(className);

      if (existingIndex >= 0) {
        classes.splice(existingIndex, 1);
      } else {
        classes.push(className);
      }
      element.className = classes.join(' ');
    }
  },
  requestFullScreen: function requestFullScreen(element) {
    // Supports most browsers and their versions.
    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
    var wscript;
    if (requestMethod) { // Native full screen.
      requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== 'undefined') { // Older IE.
      wscript = new ActiveXObject('WScript.Shell');
      if (wscript !== null) {
        wscript.SendKeys('{F11}');
      }
    }
  },
  exitFullsreen: function exitFullsreen(element) {
    var requestMethod = element.exitFullScreen || element.webkitExitFullscreen || element.mozCancelFullScreen || element.msExitFullscreen;
    var wscript;
    if (requestMethod) { // Native full screen.
      requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== 'undefined') { // Older IE.
      wscript = new ActiveXObject('WScript.Shell');
      if (wscript !== null) {
        wscript.SendKeys('{Esc}');
      }
    }
  },
  elToEn: function elToEn(string) {
    var originalString = string;
    var newString;
    var replace = new Array('α', 'ά', 'Ά', 'Α', 'β', 'Β', 'γ', 'Γ', 'δ', 'Δ', 'ε', 'έ', 'Ε', 'Έ', 'ζ', 'Ζ', 'η', 'ή', 'Η', 'θ', 'Θ', 'ι', 'ί', 'ϊ', 'ΐ', 'Ι', 'Ί', 'κ', 'Κ', 'λ', 'Λ', 'μ', 'Μ', 'ν', 'Ν', 'ξ', 'Ξ', 'ο', 'ό', 'Ο', 'Ό', 'π', 'Π', 'ρ', 'Ρ', 'σ', 'ς', 'Σ', 'τ', 'Τ', 'υ', 'ύ', 'Υ', 'Ύ', 'φ', 'Φ', 'χ', 'Χ', 'ψ', 'Ψ', 'ω', 'ώ', 'Ω', 'Ώ', ' ', '\'', '\'', ',');
    var replace_n = new Array('a', 'a', 'A', 'A', 'v', 'V', 'g', 'G', 'd', 'D', 'e', 'e', 'E', 'E', 'z', 'Z', 'i', 'i', 'I', 'th', 'Th', 'i', 'i', 'i', 'i', 'I', 'I', 'k', 'K', 'l', 'L', 'm', 'M', 'n', 'N', 'x', 'X', 'o', 'o', 'O', 'O', 'p', 'P', 'r', 'R', 's', 's', 'S', 't', 'T', 'u', 'u', 'Y', 'Y', 'f', 'F', 'ch', 'Ch', 'ps', 'Ps', 'o', 'o', 'O', 'O', ' ', '_', '_', '_');

    for (var i = 0; i < replace.length; i++) {
      originalString = originalString.replace(new RegExp(replace[i], 'g'), replace_n[i]);
    }
    newString = originalString;
    return newString;
  },
  handleDate: function handleDate(str, lang) {
    var split;
    var newDate = [];
    if (typeof str === 'string' && lang !== 'el') {
      split = _.split(str, '-', 3);
      newDate = [split[1], split[0], split[2]];
      return _.join(newDate, '-');
    }
    return str;
  },
  sanitize: function sanitize(el) {
    var sanitizedStr;
    var str = el.value;
    sanitizedStr = str.replace(/[^a-z0-9A-ZA-zΑ-Ωα-ωίϊΐόάέύϋΰήώ]/gi, '');
    el.value = sanitizedStr;
    console.log(el);
    console.log(el.value);
    console.log(sanitizedStr);
  }
  // zoomToGid: function zoomToGid(map, gid) {
  //   var coordinates = utils.findById(map, 'filteredEstates').getSource().getFeatureById(gid)
  //   .getGeometry()
  //   .getCoordinates();
  //   map.getView().setCenter(coordinates);
  // }
};

App.config.modules.map = (function ol3Map(window, document, Promise, ol, App) {
  'use strict';
  var lang = document.documentElement.lang;
  var center = [3677385, 4120949];
  var extent = [3652772, 4112808, 3700000, 4132797];
  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });

  var mapStyles = {
    iconType: function iconType(estateType) {
      var type = {
        Apartment: function apartmentIcon() {
          return 'apartment';
        },
        'Detached House': function detachedHouceIcon() {
          return 'detached';
        },
        Villa: function villaIcon() {
          return 'villa';
        },
        Maisonette: function maisonetteIcon() {
          return 'villa';
        }
      };
      return (type[estateType])();
    },
    iconPath: function iconPath(listingType) {
      var path = {
        true: function saleIcon() {
          return './images/pins/sale/';
        },
        false: function rentIcon() {
          return './images/pins/rent/';
        }
      };
      return (path[listingType])();
    },
    estates: function estates(feature) {
      var src = mapStyles.iconPath(feature.get('sale')) +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        geometry: feature.getGeometry(),
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    },
    cluster: function cluster(feature) {
      var size = feature.get('features').length;
      var style;
      var originalFeature;
      if (size > 1) {
        style = [new ol.style.Style({
          image: new ol.style.Circle({
            radius: 20,
            stroke: new ol.style.Stroke({
              color: [156, 39, 176, 1],
              width: 5
            }),
            fill: new ol.style.Fill({
              color: [68, 138, 255, 0.8]
            })
          }),
          text: new ol.style.Text({
            text: size.toString(),
            fill: new ol.style.Fill({
              color: '#FFFFFF'
            })
          }),
          zIndex: 101
        })];
      } else {
        originalFeature = feature.get('features')[0];
        style = [mapStyles.estates(originalFeature)];
      }
      return style;
    },
    poi: function poi(feature) {
      var styleCache = {};
      var symbol = feature.get('style');
      var text;
      if (lang === 'el') {
        text = feature.get('name_el');
      } else {
        text = feature.get('name_en');
      }
      if (!styleCache[symbol]) {
        styleCache = [new ol.style.Style({
          image: new ol.style.Icon(({
            src: '../images/maki/renders/' + symbol + '-24.png',
            anchorOrigin: 'bottom-left',
            anchor: [0.5, 0.5],
            scale: 1
          })),
          text: new ol.style.Text({
            text: text,
            stroke: new ol.style.Stroke({
              color: [156, 39, 176, 0.8],
              width: 1
            }),
            offsetY: 12
          })
        })];
      }
      return styleCache;
    },
    filteredEstates: function filteredEstates(feature) {
      var src = mapStyles.iconPath(feature.get('sale')) +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    }
  };


  var mapSources = {
    bing: function bing() {
      return new ol.source.BingMaps({
        key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
        imagerySet: 'AerialWithLabels'
      });
    },
    mapBox: function mapBox() {
      return new ol.source.XYZ({
        attributions: [new ol.Attribution({
          html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
        })],
        url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
      });
    },
    estates: function estates() {
      return new ol.source.Vector({
        format: geoJSONFormat,
        loader: function featreLoader() {
          var self = this;
          this.clear();
          $.ajax({
            url: 'http://127.0.0.1:3000/api/listing/all',
            type: 'GET',
            dataType: 'json'
          })
            .done(function succeded(response) {
              var features = geoJSONFormat.readFeatures(response, {
                featureProjection: 'EPSG:3857'
              });
              self.addFeatures(features);
            })
            .fail(function failed(jqXHR) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find any properties!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            });
        }
      });
    },
    cluster: function cluster() {
      return new ol.source.Cluster({
        distance: 40,
        source: mapSources.estates(),
        attributions: [new ol.Attribution({
          html: 'All maps © <a href="http://www.terracognita.gr/">Terra Cognita</a>'
        })]
      });
    },
    select: function select() {
      return new ol.source.Vector({});
    },
    poi: function poi() {
      return new ol.source.Vector({
        attributions: [new ol.Attribution({
          html: 'POI by <a href="http://www.terracognita.gr/">Terra Cognita</a>'
        })],
        format: geoJSONFormat
      });
    }
  };

  var mapLayers = {
    bing: function bing(trans) {
      return new ol.layer.Tile({
        visible: true,
        source: mapSources.bing(),
        maxZoom: 19,
        crossOrigin: 'anonymous',
        preload: Infinity,
        id: 'bing',
        name: trans.layers.bing
      });
    },
    mapBox: function mapBox(trans) {
      return new ol.layer.Tile({
        source: mapSources.mapBox(),
        id: 'mapbox',
        name: trans.layers.mapBox
      });
    },
    estates: function estates(trans) {
      return new ol.layer.Vector({
        source: mapSources.cluster(),
        id: 'estates',
        visible: true,
        style: mapStyles.cluster,
        zIndex: 2,
        name: trans.layers.estates
      });
    },
    poi: function poi(trans) {
      return new ol.layer.Vector({
        source: mapSources.poi(),
        style: mapStyles.poi,
        maxResolution: 3,
        zIndex: 1,
        id: 'poi'
      });
    },
    filteredEstates: function filteredEstates(trans) {
      return new ol.layer.Vector({
        source: new ol.source.Vector({
          format: geoJSONFormat
        }),
        id: 'filteredEstates',
        visible: true,
        style: mapStyles.filteredEstates,
        zIndex: 2
      });
    },
    select: function select() {
      return new ol.layer.Vector({
        source: mapSources.select(),
        style: new ol.style.Style({
          fill: new ol.style.Fill({
            color: 'rgba(227, 72, 27, 0.2)'
          }),
          stroke: new ol.style.Stroke({
            color: '#E3481B',
            width: 2
          }),
          image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
              color: '#E3481B'
            })
          })
        }),
        zIndex: 3,
        id: 'select'
      });
    }
  };
  var initialize = function initialize() {
     var trans = _.cloneDeep(App.config.commons.trans);
    var layers = Object.keys(mapLayers).map(function addMapLayers(key) {
      if (key !== 'bing') { return mapLayers[key](trans); }
      return null;
    });
    return new ol.Map({
      target: 'map',
      layers: _.compact(layers),
      loadTilesWhileAnimating: true,
      loadTilesWhileInteracting: true,
      renderer: 'canvas',
      controls: ol.control.defaults({
        attributionOptions: {
          collapsible: false,
          collapsed: false
        }
      })
       .extend([
         new ol.control.ScaleLine({
           units: 'metric'
         }), new ol.control.OverviewMap({
           className: 'ol-overviewmap ol-custom-overviewmap',
           collapsible: true,
           collapsed: true,
           layers: [mapLayers.bing(trans)]
         }),
         new ol.control.ZoomToExtent({
           extent: extent
         })
       ]),
      view: new ol.View({
        center: center,
        extent: extent,
        projection: 'EPSG:3857',
        zoom: 14,
        maxZoom: 19,
        minZoom: 14
      })
    });
  };
  return {
    initialize: initialize
  };
}(window, document, Promise, ol, App));

App.config.modules.info = (function info(window, document, Promise, $, App) {
  'use strict';
  var lang = document.documentElement.lang;
  var dustBluebird = App.config.promises.dustBluebird;
  var utils = App.utils;

  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });
  function extraInfoModal(feature) {
    var trans = _.cloneDeep(App.config.commons.trans);
    var modalPromise;
    var obj = {};
    if (feature.get('rent')) {
      obj.listing_type = trans.listing.rent;
    } else {
      obj.listing_type = trans.listing.sale;
    }
    obj.type = feature.get('estatetype');
    obj.gid = feature.get('gid');
    if (lang === 'el') {
      obj.address = feature.get('street_el') + '' +  feature.get('street_number');
      obj.contact = {
        name: feature.getProperties().name_el,
        lastname: feature.getProperties().lastname_el
      };
    } else {
      obj.address = feature.get('street_en') + '' +  feature.get('street_number');
      obj.contact = {
        name: feature.getProperties().name_en,
        lastname: feature.getProperties().lastname_en
      };
    }
    obj.area = feature.get('estatearea');
    obj.bedrooms = feature.get('bedrooms');
    obj.price = feature.get('price');
    obj.title = {
      gid: trans.estate.gid,
      listing_type: trans.listing.type,
      address: trans.estate.address,
      area: trans.estate.area,
      bedrooms: trans.estate.amenities.bedrooms,
      price: trans.listing.price,
      isnew: trans.estate.amenities.isnew,
      parking: trans.estate.amenities.parking,
      furnished: trans.estate.amenities.furnished,
      pets: trans.estate.amenities.pets,
      view: trans.estate.amenities.view,
      heating: trans.estate.amenities.heating,
      cooling: trans.estate.amenities.cooling,
      contactInfo: trans.contact.contactInfo,
      name: trans.contact.name,
      lastname: trans.contact.lastname,
      phone: trans.contact.phone,
      email: trans.contact.email
    };
    obj.isnew = feature.get('isnew');
    obj.furnished = feature.get('furnished');
    obj.pets = feature.get('pets');
    obj.btns = {
      info: trans.btns.info,
      close: trans.btns.close
    };
    if (feature.getProperties().phone2 !== null) {
      obj.contact.phone = feature.getProperties().phone1 + ' ' + feature.getProperties().phone2;
    } else {
      obj.contact.phone = feature.getProperties().phone1;
    }
    obj.contact.email = feature.getProperties().email;

    modalPromise = dustBluebird.renderAsync('modalInfo', obj)
    .then(function resolve(data) {
      $('#modal').removeClass('visuallyhidden');
      $('.modal-content').html(data);
    })
    .then(function resolve() {
      Promise.resolve(
        $.get('http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg')
      )
      .then(function resolveCloudinary() {
        $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg)');
      })
      .catch(function error(e) {
        if (e.status === 404) {
          $('.big-image').css('background-image', 'url(/images/no_image_available.png)');
        }
      });
    })
    .catch(function error(e) {
      console.log(e.status);
    });
    $('#modal-close').click(function closeModal() {
      $('#modal').addClass('visuallyhidden');
    });
  }
  function renderEstateCards(feature) {
    var trans = _.cloneDeep(App.config.commons.trans);
    var estateCardsPromise;
    var obj = {};
    if (feature.get('rent')) {
      obj.listing_type = trans.listing.rent;
    } else {
      obj.listing_type = trans.listing.sale;
    }
    obj.type = feature.get('estatetype');
    obj.gid = feature.get('gid');
    if (lang === 'el') {
      obj.address = feature.get('street_el') + '' +  feature.get('street_number');
    } else {
      obj.address = feature.get('street_en') + '' +  feature.get('street_number');
    }
    obj.area = feature.get('estatearea');
    obj.bedrooms = feature.get('bedrooms');
    obj.price = feature.get('price');
    obj.title = {
      listing_type: trans.listing.type,
      address: trans.estate.address,
      area: trans.estate.area,
      bedrooms: trans.estate.amenities.bedrooms,
      price: trans.listing.price,
      isnew: trans.estate.amenities.isnew,
      furnished: trans.estate.amenities.furnished,
      pets: trans.estate.amenities.pets
    };
    obj.isnew = feature.get('isnew');
    obj.furnished = feature.get('furnished');
    obj.pets = feature.get('pets');
    obj.btns = {
      info: trans.btns.info,
      close: trans.btns.close
    };
    estateCardsPromise = dustBluebird.renderAsync('estateCards', obj)
    .then(function resolve(data) {
      $('.estate-cards').html(data);
    })
    .then(function resolve() {
      Promise.resolve(
        $.get('http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg')
      )
      .then(function resolveCloudinary() {
        $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg)');
      })
      .catch(function error(e) {
        if (e.status === 404) {
          $('.big-image').css('background-image', 'url(/images/no_image_available.png)');
        }
      });
    })
    .then(function resolve() {
      $('.estate-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg)');
      $('.estate-cards').addClass('estate-cards-active');
      $('#estate-card-square-close').click(function close() {
        $('.estate-cards').removeClass('estate-cards-active');
      });
      $('#estate-card-square-extra-info').click(function extraInfo() {
        extraInfoModal(feature);
      });
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function selectFeature(evt) {
    var map = evt.map;
    // var coordinate = evt.coordinate;
    var f;
    var clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function findFeature(feature, layer) {
      return {
        feature: feature,
        layer: layer
      };
    }, this, function clickedFeatureLayerFilter(layer) {
      if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
        return true;
      }
      return false;
    }, this);
    if (clickedFeature) {
      if (clickedFeature.layer.get('id') === 'estates' &&
        clickedFeature.feature.get('features').length === 1) {
        f = clickedFeature.feature.getProperties().features[0];
        renderEstateCards(f);
        map.getView().setCenter(f.getGeometry().getCoordinates());
        map.getView().setZoom(16);
        Promise.resolve(
          $.ajax({
            url: 'http://127.0.0.1:3000/api/uses/' + f.getProperties().gid,
            type: 'GET',
            dataType: 'json'
          })
        )
        .then(function resolve(data) {
          var features;
          utils.findById(map, 'poi').getSource().clear();
          features = geoJSONFormat.readFeatures(data.property_services_analysis, {
            featureProjection: 'EPSG:3857'
          });
          features.forEach(function removePolygon(feature) {
            if (feature.getGeometry().getType() === 'Polygon') {
              features.splice(features.indexOf(feature), 1);
            }
          });
          utils.findById(map, 'poi').getSource().addFeatures(features);
          // map.getView().fit(utils.findById(map, 'poi').getSource().getExtent(), map.getSize());

          toastr.info('Found ' + features.length + ' Points of Interest in 8 minute distance!');
        })
        .catch(function error(e) {
          utils.findById(map, 'poi').getSource().clear();
          if (e.status === 404) {
            toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
          } else {
            console.log(e);
            toastr.error(e.responseText);
          }
        });
      } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
        f = clickedFeature.feature;
        renderEstateCards(f);
        Promise.resolve(
          $.ajax({
            url: 'http://127.0.0.1:3000/db/uses/' + f.getProperties().gid,
            type: 'GET',
            dataType: 'json'
          })
        )
        .then(function resolve(data) {
          var features;
          if (utils.findById(map, 'poi').getSource().getFeatures().length !== 0) {
            utils.findById(map, 'poi').getSource().clear();
          }
          features = geoJSONFormat.readFeatures(data.property_services_analysis, {
            featureProjection: 'EPSG:3857'
          });
          features.forEach(function removePolygon(feature) {
            if (feature.getGeometry().getType() === 'Polygon') {
              features.splice(features.indexOf(feature), 1);
            }
          });
          utils.findById(map, 'poi').getSource().addFeatures(features);
          map.getView().fit(utils.findById(map, 'poi').getSource().getExtent(), map.getSize());
          toastr.info('Found ' + features.length + ' Points of Interest in 8 minute distance!');
        })
        .catch(function error(e) {
          if (e.status === 404) {
            toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
          } else {
            console.log(e);
            toastr.error(e.responseText);
          }
        });
      }
    } else {
      utils.findById(map, 'poi').getSource().clear();
    }
  }

  function init() {
    var map = App.config.commons.map;
    map.on('click', selectFeature);
  }
  function disable() {
    var map = App.config.commons.map;
    map.un('click', selectFeature);
  }
  return {
    init: init,
    disable: disable
  };
}(window, document, Promise, jQuery, App));

App.config.modules.filters = (function filters(window, document, Promise, $, Parsley, moment, App) {
  'use strict';
  var lang = document.documentElement.lang;
  var dustBluebird = App.config.promises.dustBluebird;
  var utils = App.utils;

  var xy1 = ol.proj.transform([3652772, 4112808], 'EPSG:3857', 'EPSG:4326');
  var xy2 = ol.proj.transform([3700000, 4132797], 'EPSG:3857', 'EPSG:4326');
  var extent = _.concat(xy1, xy2);
  var bbox = extent;
  function assignValidators() {
    var content = document.getElementById('infobox-content');
    var inputs = content.querySelectorAll('input[type=text]');
    [].forEach.call(inputs, function makeParsleyInputs(el) {
      el.addEventListener('blur', function sanitize() {
        var str = this.value;
        var sanitizedStr;
        if (this.dataset.type === 'number') {
          sanitizedStr = str.replace(/[/\D/ ]/gi, '');
        } else if (this.dataset.type === 'alphanum') {
          sanitizedStr = str.replace(/[^a-z0-9A-ZA-zΑ-Ωα-ωίϊΐόάέύϋΰήώ ]/gi, '');
        } else if (this.dataset.type === 'special') {
          sanitizedStr = str.replace(/[^0-9 \/]/gi, '');
        } else if (this.dataset.type === 'date') {
          sanitizedStr = str.replace(/[^0-9 \-]/gi, '');
        }
        this.value = sanitizedStr;
        utils.removeClass(this.parentNode, 'is-invalid');
      });
    });
  }
  function addResults(data) {
    var map = App.config.commons.map;
    var geoJSONFormat = new ol.format.GeoJSON({
      defaultDataProjection: 'EPSG:4326'
    });
    var features = geoJSONFormat.readFeatures(data, {
      featureProjection: 'EPSG:3857'
    });
    features.forEach(function setId(f) {
      f.setId(f.getProperties().gid);
    });
    utils.findById(map, 'filteredEstates').getSource().addFeatures(features);
    if (lang === 'el') {
      toastr.info('Βρέθηκαν ' + features.length + ' ιδιοκτησίες!');
    } else {
      toastr.info('Found ' + features.length + ' estates!');
    }
  }
  function clearResults() {
    var map = App.config.commons.map;
    utils.findById(map, 'filteredEstates').getSource().clear();
    utils.findById(map, 'select').getSource().clear();
    map.getInteractions().forEach(function findInteractionById(i) {
      if (i.getProperties().id === 'draw') {
        i.setActive(false);
      }
    });
    $(map.getViewport()).off('mouseleave');
    $(map.getViewport()).off('mouseenter');
    bbox = extent;
    utils.findById(map, 'estates').setVisible(true);
    App.config.modules.info.init();
    $('#results').addClass('visuallyhidden').removeAttr('style')
    .empty();
  }
  function setOptions() {
    var filterData = {};
    filterData.estateType = $('#estateType').val();
    filterData.leaseType = $('input[name=options]:checked').val() !== undefined ? $('input[name=options]:checked').val() : 'Rent';
    filterData.startPrice = $('#startPrice').val() !== '' ? $('#startPrice').val() : 0;
    filterData.endPrice = $('#endPrice').val() !== '' ? $('#endPrice').val() : 2147483647;
    filterData.areaStart = $('#area-start').val() !== '' ? $('#area-start').val() : 0;
    filterData.areaEnd = $('#area-end').val() !== '' ? $('#area-end').val() : 2147483647;
    filterData.parking = $('#checkbox-1').prop('checked') !== undefined ? $('#checkbox-1').prop('checked') : false;
    filterData.furnished = $('#checkbox-2').prop('checked') !== undefined ? $('#checkbox-2').prop('checked') : false;
    filterData.heating = $('#checkbox-3').prop('checked') !== undefined ? $('#checkbox-3').prop('checked') : false;
    filterData.cooling = $('#checkbox-4').prop('checked') !== undefined ? $('#checkbox-4').prop('checked') : false;
    filterData.view = $('#checkbox-5').prop('checked') !== undefined ? $('#checkbox-5').prop('checked') : false;
    filterData.bbox = bbox;
    return filterData;
  }
  function getResults(options) {
    var map = App.config.commons.map;
    var trans = _.cloneDeep(App.config.commons.trans);
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/listing/filters',
        type: 'GET',
        dataType: 'json',
        data: options
      })
    )
    .then(function resolve(data) {

      var renderData = {};

      var results = [];

      utils.findById(map, 'estates').setVisible(false);
      utils.findById(map, 'poi').getSource().clear();
      utils.findById(map, 'filteredEstates').getSource().clear();
      // utils.findById(map, 'select').getSource().clear();
      addResults(data);
      _.forEach(data.features, function(value) {
        var address;
        var dateStart;
        var dateEnd;
        var coordinates = ol.proj.transform(value.geometry.coordinates, 'EPSG:3857', 'EPSG:4326');
        if (lang === 'el') {
          address = value.properties.street_el + ' ' + value.properties.street_number;
          dateStart = moment(value.properties.date_start).format('DD-MM-YYYY');
          dateEnd = moment(value.properties.end).format('DD-MM-YYYY');
        } else {
          address = value.properties.street_en + ' ' + value.properties.street_number;
          dateStart = moment(value.properties.date_start).format('MM-DD-YYYY');
          dateEnd = moment(value.properties.end).format('MM-DD-YYYY');
        }
        results.push({
          gid: value.properties.gid,
          price: value.properties.price,
          area: value.properties.estatearea,
          address: address,
          dateStart: dateStart,
          dateEnd: dateEnd,
          title: {
            price: trans.listing.price,
            area: trans.estate.area,
            areaUnits: trans.estate.areaUnits
          },
          coordinates: coordinates
        });
      });
      renderData.results = results;
      return renderData;
    })
    .then(function resolve(data) {
      dustBluebird.renderAsync('results', data)
      .then(function resolveDust(d) {
        $('#results').removeClass('visuallyhidden');
        $('#results').html(d);
        $('.results-list').find('i').each(function addZoomToResults() {
          var gid = $(this).parents('li').data('gid');
          $(this).click(function zoomToGid(event) {
            var coordinates = utils.findById(map, 'filteredEstates').getSource().getFeatureById(gid)
            .getGeometry()
            .getCoordinates();
            map.getView().setCenter(coordinates);
            map.getView().setZoom(16);
          });
        });
      });
    })
    .catch(function error(e) {
      if (e.status === 404) {
        toastr.error(trans.errors.property[404]);
      } else if (e.status === 503) {
        toastr.error(trans.errors.property[503]);
      } else {
        toastr.error(trans.errors.internal);
      }
    });
  }
  function chooseByArea(draw) {
    var map = App.config.commons.map;
    $(map.getViewport()).mouseleave(function leaveMapForAreaSelection(event) {
      event.preventDefault();
      event.stopPropagation();
      draw.setActive(false);
    });
    $(map.getViewport()).mouseenter(function enterMapForAreaSelection(event) {
      event.preventDefault();
      event.stopPropagation();
      draw.setActive(true);
    });
    draw.on('drawstart', function drawstart() {
      utils.findById(map, 'select').getSource().clear();
    });
    draw.on('drawend', function drawend(e) {
      var coordinates = e.feature.getGeometry().getExtent();
      var transformedCoordinates = _.chunk(coordinates, 2).map(function split(currentValue) {
        return ol.proj.transform(currentValue, 'EPSG:3857', 'EPSG:4326');
      });
      bbox = _.concat(transformedCoordinates[0], transformedCoordinates[1]);
    });
  }
  function init() {
    var map = App.config.commons.map;
    var drawInteraction = new ol.interaction.Draw({
      source: utils.findById(map, 'select').getSource(),
      type: 'LineString',
      geometryFunction: utils.geometryFunction,
      maxPoints: 2
      // condition: function(event) {
      //   return ol.events.condition.platformModifierKeyOnly(event);
      // }
    });
    drawInteraction.setProperties({
      id: 'draw'
    });
    drawInteraction.setActive(false);
    $('#checkbox-6').change(function enableAreaSelection() {
      if (this.checked) {
        map.addInteraction(drawInteraction);
        App.config.modules.info.disable();
        chooseByArea(drawInteraction);
      } else {
        App.config.modules.info.init();
        map.removeInteraction(drawInteraction);
        drawInteraction.setActive(false);
        utils.findById(map, 'select').getSource().clear();
        bbox = extent;
      }
    });
    assignValidators();
    $('#invokeFilters').click(function invokeFilters(event) {
      var options;
      event.preventDefault();
      event.stopPropagation();
      options = setOptions();
      if ($('form[name=filters]').parsley().validate()) {
        getResults(options);
      }
    });
    $('#clearFilters').click(function clearFilters(event) {
      event.preventDefault();
      event.stopPropagation();
      clearResults(map);
      $('label[for=option-1]').addClass('is-checked');
      $('#option-1').prop('checked', true);
      $('label[for=option-2]').removeClass('is-checked');
      $('#option-2').prop('checked', false);
      $('.mdl-checkbox__input').each(function clearCheckboxes(index, el) {
        $(el).prop('checked', false).parent('label')
        .removeClass('is-checked');
      });
      $('.mdl-textfield__input').each(function clearInputs(index, el) {
        if ($(el).attr('id') !== 'estateType') {
          $(el).val('').parent()
          .eq(0)
          .removeClass('is-dirty');
        } else {
          $(el).attr('data-val', 'Apartment');
          if (lang === 'el') {
            $(el).val('Διαμέρισμα');
          } else {
            $('#estateType').val('Apartment');
          }
        }
      });
    });
  }
  return {
    init: init
  };
}(window, document, Promise, $, Parsley, moment, App));

var userMap = (function userMap(window, document, Promise, $, App) {
  'use strict';
  var context = 'map';
  var lang = document.documentElement.lang;
  var $loading = $('.mdl-spinner');
  $(document)
  .ajaxStart(function start() {
    $('.spiner-wrapper').removeClass('visuallyhidden');
    $loading.addClass('is-active');
  })
  .ajaxStop(function stop() {
    $('.spiner-wrapper').addClass('visuallyhidden');
    $loading.removeClass('is-active');
  });
  toastr.options = {
    closeButton: false,
    debug: false,
    newestOnTop: false,
    progressBar: false,
    positionClass: 'toast-top-center',
    preventDuplicates: false,
    onclick: null,
    showDuration: '300',
    hideDuration: '1000',
    timeOut: '5000',
    extendedTimeOut: '1000',
    showEasing: 'swing',
    hideEasing: 'linear',
    showMethod: 'fadeIn',
    hideMethod: 'fadeOut'
  };

  function init() {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/language',
        type: 'GET',
        data: {
          type: lang,
          context: context
        }
      })
      )
    .then(function resolve(data) {
      App.config.commons.trans = data;
      App.config.commons.map = App.config.modules.map.initialize();
    })
    .then(function resolve() {
      App.config.modules.info.init();
      App.config.modules.filters.init();
    })
    .catch(function error(e) {
      console.log(e);
    });
  }

  return {
    init: init
  };
}(window, document, Promise, jQuery, App));


// jQuery(document).ready(function ($) {
//   $('.spinner').addClass('visuallyhidden');
//   $('.mdl-spinner').removeClass('is-active');
//   // handleSelect();
// });

userMap.init();
$('#advanced-filters').click(function toggleFilters() {
  $('#estate-filters').toggleClass('visuallyhidden');
});
// $('#toggle-price-range').click(function togglePriceRange() {
//   $('#price-range').toggleClass('visuallyhidden');
// });

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkN1c3RvbUV2ZW50LmpzIiwic2Nyb2xsSW50b1ZpZXdJZk5lZWRlZC5qcyIsImdsb2JhbHMuanMiLCJ1dGlscy5qcyIsIm9sMy1tYXAuanMiLCJpbmZvLmpzIiwiZmlsdGVycy5qcyIsImluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDN0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25KQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlRQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaFFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1hcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKCkge1xyXG5cclxuICBpZiAoIHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgPT09IFwiZnVuY3Rpb25cIiApIHJldHVybiBmYWxzZTtcclxuXHJcbiAgZnVuY3Rpb24gQ3VzdG9tRXZlbnQgKCBldmVudCwgcGFyYW1zICkge1xyXG4gICAgcGFyYW1zID0gcGFyYW1zIHx8IHsgYnViYmxlczogZmFsc2UsIGNhbmNlbGFibGU6IGZhbHNlLCBkZXRhaWw6IHVuZGVmaW5lZCB9O1xyXG4gICAgdmFyIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCAnQ3VzdG9tRXZlbnQnICk7XHJcbiAgICBldnQuaW5pdEN1c3RvbUV2ZW50KCBldmVudCwgcGFyYW1zLmJ1YmJsZXMsIHBhcmFtcy5jYW5jZWxhYmxlLCBwYXJhbXMuZGV0YWlsICk7XHJcbiAgICByZXR1cm4gZXZ0O1xyXG4gICB9XHJcblxyXG4gIEN1c3RvbUV2ZW50LnByb3RvdHlwZSA9IHdpbmRvdy5FdmVudC5wcm90b3R5cGU7XHJcblxyXG4gIHdpbmRvdy5DdXN0b21FdmVudCA9IEN1c3RvbUV2ZW50O1xyXG59KSgpO1xyXG4iLCIgIChmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIUVsZW1lbnQucHJvdG90eXBlLnNjcm9sbEludG9WaWV3SWZOZWVkZWQpIHtcclxuICAgICAgRWxlbWVudC5wcm90b3R5cGUuc2Nyb2xsSW50b1ZpZXdJZk5lZWRlZCA9IGZ1bmN0aW9uIChjZW50ZXJJZk5lZWRlZCkge1xyXG4gICAgICAgIGNlbnRlcklmTmVlZGVkID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMCA/IHRydWUgOiAhIWNlbnRlcklmTmVlZGVkO1xyXG5cclxuICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlLFxyXG4gICAgICAgIHBhcmVudENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShwYXJlbnQsIG51bGwpLFxyXG4gICAgICAgIHBhcmVudEJvcmRlclRvcFdpZHRoID0gcGFyc2VJbnQocGFyZW50Q29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdib3JkZXItdG9wLXdpZHRoJykpLFxyXG4gICAgICAgIHBhcmVudEJvcmRlckxlZnRXaWR0aCA9IHBhcnNlSW50KHBhcmVudENvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgnYm9yZGVyLWxlZnQtd2lkdGgnKSksXHJcbiAgICAgICAgb3ZlclRvcCA9IHRoaXMub2Zmc2V0VG9wIC0gcGFyZW50Lm9mZnNldFRvcCA8IHBhcmVudC5zY3JvbGxUb3AsXHJcbiAgICAgICAgb3ZlckJvdHRvbSA9ICh0aGlzLm9mZnNldFRvcCAtIHBhcmVudC5vZmZzZXRUb3AgKyB0aGlzLmNsaWVudEhlaWdodCAtIHBhcmVudEJvcmRlclRvcFdpZHRoKSA+IChwYXJlbnQuc2Nyb2xsVG9wICsgcGFyZW50LmNsaWVudEhlaWdodCksXHJcbiAgICAgICAgb3ZlckxlZnQgPSB0aGlzLm9mZnNldExlZnQgLSBwYXJlbnQub2Zmc2V0TGVmdCA8IHBhcmVudC5zY3JvbGxMZWZ0LFxyXG4gICAgICAgIG92ZXJSaWdodCA9ICh0aGlzLm9mZnNldExlZnQgLSBwYXJlbnQub2Zmc2V0TGVmdCArIHRoaXMuY2xpZW50V2lkdGggLSBwYXJlbnRCb3JkZXJMZWZ0V2lkdGgpID4gKHBhcmVudC5zY3JvbGxMZWZ0ICsgcGFyZW50LmNsaWVudFdpZHRoKSxcclxuICAgICAgICBhbGlnbldpdGhUb3AgPSBvdmVyVG9wICYmICFvdmVyQm90dG9tO1xyXG5cclxuICAgICAgICBpZiAoKG92ZXJUb3AgfHwgb3ZlckJvdHRvbSkgJiYgY2VudGVySWZOZWVkZWQpIHtcclxuICAgICAgICAgIHBhcmVudC5zY3JvbGxUb3AgPSB0aGlzLm9mZnNldFRvcCAtIHBhcmVudC5vZmZzZXRUb3AgLSBwYXJlbnQuY2xpZW50SGVpZ2h0IC8gMiAtIHBhcmVudEJvcmRlclRvcFdpZHRoICsgdGhpcy5jbGllbnRIZWlnaHQgLyAyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKChvdmVyTGVmdCB8fCBvdmVyUmlnaHQpICYmIGNlbnRlcklmTmVlZGVkKSB7XHJcbiAgICAgICAgICBwYXJlbnQuc2Nyb2xsTGVmdCA9IHRoaXMub2Zmc2V0TGVmdCAtIHBhcmVudC5vZmZzZXRMZWZ0IC0gcGFyZW50LmNsaWVudFdpZHRoIC8gMiAtIHBhcmVudEJvcmRlckxlZnRXaWR0aCArIHRoaXMuY2xpZW50V2lkdGggLyAyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKChvdmVyVG9wIHx8IG92ZXJCb3R0b20gfHwgb3ZlckxlZnQgfHwgb3ZlclJpZ2h0KSAmJiAhY2VudGVySWZOZWVkZWQpIHtcclxuICAgICAgICAgIHRoaXMuc2Nyb2xsSW50b1ZpZXcoYWxpZ25XaXRoVG9wKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfSkoKTtcclxuIiwid2luZG93LkFwcCB8fCAod2luZG93LkFwcCA9IHt9KTtcclxud2luZG93LkFwcC5jb25maWcgPSB7XHJcbiAgcHJvbWlzZXM6IHtcclxuICAgIGR1c3RCbHVlYmlyZDogUHJvbWlzZS5wcm9taXNpZnlBbGwoZHVzdCksXHJcbiAgICBjbG91ZGluYXJ5QmlyZDogUHJvbWlzZS5wcm9taXNpZnlBbGwoJC5jbG91ZGluYXJ5KVxyXG4gIH0sXHJcbiAgY29tbW9uczoge1xyXG4gICAgbWFwOiB7fSxcclxuICAgIHRyYW5zOiB7fVxyXG4gIH0sXHJcbiAgY2FjaGU6IHtcclxuICAgIGFjdGl2ZUVzdGF0ZToge30sXHJcbiAgICBhY3RpdmVFc3RhdGVMaXN0aW5nOiB7fVxyXG4gIH0sXHJcbiAgbW9kdWxlczoge1xyXG4gICAgbWFwOiB7fSxcclxuICAgIGluZm86IHt9LFxyXG4gICAgZWRpdDoge30sXHJcbiAgICBkZWxldGU6IHt9LFxyXG4gICAgaW5zZXJ0OiB7fSxcclxuICAgIGZpbHRlcnM6IHt9XHJcbiAgfVxyXG59O1xyXG53aW5kb3cuQXBwLnV0aWxzID0ge307XHJcbi8vIHZhciB0cmFucztcclxuLy8gdmFyIGNsb3VkaW5hcnlCaXJkID0gUHJvbWlzZS5wcm9taXNpZnlBbGwoJC5jbG91ZGluYXJ5KTtcclxuLy8gdmFyIGFjdGl2ZUVzdGF0ZTtcclxuLy8gdmFyIGFjdGl2ZUVzdGF0ZUxpc3Rpbmc7XHJcbiQuY2xvdWRpbmFyeS5jb25maWcoeyBjbG91ZF9uYW1lOiAnZmlydmFpbicsIGFwaV9rZXk6ICczNzUxMzg5MzI2ODk1OTEnIH0pO1xyXG4iLCIvKmVzbGludCBuby1wYXJhbS1yZWFzc2lnbjogW1wiZXJyb3JcIiwgeyBcInByb3BzXCI6IGZhbHNlIH1dKi9cclxuQXBwLnV0aWxzID0ge1xyXG4gIGZpbmRCeUlkOiBmdW5jdGlvbiBmaW5kQnlJZChtYXAsIGlkKSB7XHJcbiAgICB2YXIgbGF5ZXJzID0gbWFwLmdldExheWVycygpO1xyXG4gICAgdmFyIGxlbmd0aCA9IGxheWVycy5nZXRMZW5ndGgoKTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKGlkID09PSBsYXllcnMuaXRlbShpKS5nZXQoJ2lkJykpIHtcclxuICAgICAgICByZXR1cm4gbGF5ZXJzLml0ZW0oaSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH0sXHJcbiAgZmluZEJ5TmFtZTogZnVuY3Rpb24gZmluZEJ5TmFtZShtYXAsIG5hbWUpIHtcclxuICAgIHZhciBsYXllcnMgPSBtYXAuZ2V0TGF5ZXJzKCk7XHJcbiAgICB2YXIgbGVuZ3RoID0gbGF5ZXJzLmdldExlbmd0aCgpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAobmFtZSA9PT0gbGF5ZXJzLml0ZW0oaSkuZ2V0KCduYW1lJykpIHtcclxuICAgICAgICByZXR1cm4gbGF5ZXJzLml0ZW0oaSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH0sXHJcbiAgcHJldmVudERvdEFuZFNwYWNlOiBmdW5jdGlvbiBwcmV2ZW50RG90QW5kU3BhY2UoZSkge1xyXG4gICAgdmFyIGtleSA9IGUuY2hhckNvZGUgPyBlLmNoYXJDb2RlIDogZS5rZXlDb2RlO1xyXG4gICAgdGhpcy5pbm5lckhUTUwgPSBrZXk7XHJcbiAgICBpZiAoa2V5ID09PSA0NiB8fCBrZXkgPT09IDMyKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH0sXHJcbiAgZ2VvbWV0cnlGdW5jdGlvbjogZnVuY3Rpb24gZ2VvbWV0cnlGdW5jdGlvbihjb29yZGluYXRlcywgZ2VvbWV0cnkpIHtcclxuICAgIHZhciBnZW9tID0gZ2VvbWV0cnk7XHJcbiAgICB2YXIgc3RhcnQ7XHJcbiAgICB2YXIgZW5kO1xyXG4gICAgaWYgKCFnZW9tKSB7XHJcbiAgICAgIGdlb20gPSBuZXcgb2wuZ2VvbS5Qb2x5Z29uKG51bGwpO1xyXG4gICAgfVxyXG4gICAgc3RhcnQgPSBjb29yZGluYXRlc1swXTtcclxuICAgIGVuZCA9IGNvb3JkaW5hdGVzWzFdO1xyXG4gICAgZ2VvbS5zZXRDb29yZGluYXRlcyhbXHJcbiAgICAgIFtzdGFydCwgW3N0YXJ0WzBdLCBlbmRbMV1dLCBlbmQsIFtlbmRbMF0sIHN0YXJ0WzFdXSwgc3RhcnRdXHJcbiAgICBdKTtcclxuICAgIHJldHVybiBnZW9tO1xyXG4gIH0sXHJcbiAgaGFzQ2xhc3M6IGZ1bmN0aW9uIGhhc0NsYXNzKGVsLCBjbGFzc05hbWUpIHtcclxuICAgIGlmIChlbC5jbGFzc0xpc3QpIHtcclxuICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5jb250YWlucyhjbGFzc05hbWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ldyBSZWdFeHAoJyhefCApJyArIGNsYXNzTmFtZSArICcoIHwkKScsICdnaScpLnRlc3QoZWwuY2xhc3NOYW1lKTtcclxuICB9LFxyXG4gIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiByZW1vdmVDbGFzcyhlbCwgY2xhc3NOYW1lKSB7XHJcbiAgICB2YXIgZWxlbWVudCA9IGVsO1xyXG4gICAgaWYgKGVsZW1lbnQuY2xhc3NMaXN0KSB7XHJcbiAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxcXFxiKScgKyBjbGFzc05hbWUuc3BsaXQoJyAnKS5qb2luKCd8JykgKyAnKFxcXFxifCQpJywgJ2dpJyksICcgJyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBhZGRDbGFzczogZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoZWwsIGNsYXNzTmFtZSkge1xyXG4gICAgdmFyIGVsZW1lbnQgPSBlbDtcclxuICAgIGlmIChlbGVtZW50LmNsYXNzTGlzdCkge1xyXG4gICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lICs9ICcgJyArIGNsYXNzTmFtZTtcclxuICAgIH1cclxuICB9LFxyXG4gIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiB0b2dnbGVDbGFzcyhlbCwgY2xhc3NOYW1lKSB7XHJcbiAgICB2YXIgY2xhc3NlcztcclxuICAgIHZhciBleGlzdGluZ0luZGV4O1xyXG4gICAgdmFyIGVsZW1lbnQgPSBlbDtcclxuICAgIGlmIChlbGVtZW50LmNsYXNzTGlzdCkge1xyXG4gICAgICBlbGVtZW50LmNsYXNzTGlzdC50b2dnbGUoY2xhc3NOYW1lKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNsYXNzZXMgPSBlbGVtZW50LmNsYXNzTmFtZS5zcGxpdCgnICcpO1xyXG4gICAgICBleGlzdGluZ0luZGV4ID0gY2xhc3Nlcy5pbmRleE9mKGNsYXNzTmFtZSk7XHJcblxyXG4gICAgICBpZiAoZXhpc3RpbmdJbmRleCA+PSAwKSB7XHJcbiAgICAgICAgY2xhc3Nlcy5zcGxpY2UoZXhpc3RpbmdJbmRleCwgMSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2xhc3Nlcy5wdXNoKGNsYXNzTmFtZSk7XHJcbiAgICAgIH1cclxuICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHJlcXVlc3RGdWxsU2NyZWVuOiBmdW5jdGlvbiByZXF1ZXN0RnVsbFNjcmVlbihlbGVtZW50KSB7XHJcbiAgICAvLyBTdXBwb3J0cyBtb3N0IGJyb3dzZXJzIGFuZCB0aGVpciB2ZXJzaW9ucy5cclxuICAgIHZhciByZXF1ZXN0TWV0aG9kID0gZWxlbWVudC5yZXF1ZXN0RnVsbFNjcmVlbiB8fCBlbGVtZW50LndlYmtpdFJlcXVlc3RGdWxsU2NyZWVuIHx8IGVsZW1lbnQubW96UmVxdWVzdEZ1bGxTY3JlZW4gfHwgZWxlbWVudC5tc1JlcXVlc3RGdWxsU2NyZWVuO1xyXG4gICAgdmFyIHdzY3JpcHQ7XHJcbiAgICBpZiAocmVxdWVzdE1ldGhvZCkgeyAvLyBOYXRpdmUgZnVsbCBzY3JlZW4uXHJcbiAgICAgIHJlcXVlc3RNZXRob2QuY2FsbChlbGVtZW50KTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHdpbmRvdy5BY3RpdmVYT2JqZWN0ICE9PSAndW5kZWZpbmVkJykgeyAvLyBPbGRlciBJRS5cclxuICAgICAgd3NjcmlwdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCdXU2NyaXB0LlNoZWxsJyk7XHJcbiAgICAgIGlmICh3c2NyaXB0ICE9PSBudWxsKSB7XHJcbiAgICAgICAgd3NjcmlwdC5TZW5kS2V5cygne0YxMX0nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgZXhpdEZ1bGxzcmVlbjogZnVuY3Rpb24gZXhpdEZ1bGxzcmVlbihlbGVtZW50KSB7XHJcbiAgICB2YXIgcmVxdWVzdE1ldGhvZCA9IGVsZW1lbnQuZXhpdEZ1bGxTY3JlZW4gfHwgZWxlbWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbiB8fCBlbGVtZW50Lm1vekNhbmNlbEZ1bGxTY3JlZW4gfHwgZWxlbWVudC5tc0V4aXRGdWxsc2NyZWVuO1xyXG4gICAgdmFyIHdzY3JpcHQ7XHJcbiAgICBpZiAocmVxdWVzdE1ldGhvZCkgeyAvLyBOYXRpdmUgZnVsbCBzY3JlZW4uXHJcbiAgICAgIHJlcXVlc3RNZXRob2QuY2FsbChlbGVtZW50KTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHdpbmRvdy5BY3RpdmVYT2JqZWN0ICE9PSAndW5kZWZpbmVkJykgeyAvLyBPbGRlciBJRS5cclxuICAgICAgd3NjcmlwdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCdXU2NyaXB0LlNoZWxsJyk7XHJcbiAgICAgIGlmICh3c2NyaXB0ICE9PSBudWxsKSB7XHJcbiAgICAgICAgd3NjcmlwdC5TZW5kS2V5cygne0VzY30nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgZWxUb0VuOiBmdW5jdGlvbiBlbFRvRW4oc3RyaW5nKSB7XHJcbiAgICB2YXIgb3JpZ2luYWxTdHJpbmcgPSBzdHJpbmc7XHJcbiAgICB2YXIgbmV3U3RyaW5nO1xyXG4gICAgdmFyIHJlcGxhY2UgPSBuZXcgQXJyYXkoJ86xJywgJ86sJywgJ86GJywgJ86RJywgJ86yJywgJ86SJywgJ86zJywgJ86TJywgJ860JywgJ86UJywgJ861JywgJ86tJywgJ86VJywgJ86IJywgJ862JywgJ86WJywgJ863JywgJ86uJywgJ86XJywgJ864JywgJ86YJywgJ865JywgJ86vJywgJ8+KJywgJ86QJywgJ86ZJywgJ86KJywgJ866JywgJ86aJywgJ867JywgJ86bJywgJ868JywgJ86cJywgJ869JywgJ86dJywgJ86+JywgJ86eJywgJ86/JywgJ8+MJywgJ86fJywgJ86MJywgJ8+AJywgJ86gJywgJ8+BJywgJ86hJywgJ8+DJywgJ8+CJywgJ86jJywgJ8+EJywgJ86kJywgJ8+FJywgJ8+NJywgJ86lJywgJ86OJywgJ8+GJywgJ86mJywgJ8+HJywgJ86nJywgJ8+IJywgJ86oJywgJ8+JJywgJ8+OJywgJ86pJywgJ86PJywgJyAnLCAnXFwnJywgJ1xcJycsICcsJyk7XHJcbiAgICB2YXIgcmVwbGFjZV9uID0gbmV3IEFycmF5KCdhJywgJ2EnLCAnQScsICdBJywgJ3YnLCAnVicsICdnJywgJ0cnLCAnZCcsICdEJywgJ2UnLCAnZScsICdFJywgJ0UnLCAneicsICdaJywgJ2knLCAnaScsICdJJywgJ3RoJywgJ1RoJywgJ2knLCAnaScsICdpJywgJ2knLCAnSScsICdJJywgJ2snLCAnSycsICdsJywgJ0wnLCAnbScsICdNJywgJ24nLCAnTicsICd4JywgJ1gnLCAnbycsICdvJywgJ08nLCAnTycsICdwJywgJ1AnLCAncicsICdSJywgJ3MnLCAncycsICdTJywgJ3QnLCAnVCcsICd1JywgJ3UnLCAnWScsICdZJywgJ2YnLCAnRicsICdjaCcsICdDaCcsICdwcycsICdQcycsICdvJywgJ28nLCAnTycsICdPJywgJyAnLCAnXycsICdfJywgJ18nKTtcclxuXHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcGxhY2UubGVuZ3RoOyBpKyspIHtcclxuICAgICAgb3JpZ2luYWxTdHJpbmcgPSBvcmlnaW5hbFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAocmVwbGFjZVtpXSwgJ2cnKSwgcmVwbGFjZV9uW2ldKTtcclxuICAgIH1cclxuICAgIG5ld1N0cmluZyA9IG9yaWdpbmFsU3RyaW5nO1xyXG4gICAgcmV0dXJuIG5ld1N0cmluZztcclxuICB9LFxyXG4gIGhhbmRsZURhdGU6IGZ1bmN0aW9uIGhhbmRsZURhdGUoc3RyLCBsYW5nKSB7XHJcbiAgICB2YXIgc3BsaXQ7XHJcbiAgICB2YXIgbmV3RGF0ZSA9IFtdO1xyXG4gICAgaWYgKHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnICYmIGxhbmcgIT09ICdlbCcpIHtcclxuICAgICAgc3BsaXQgPSBfLnNwbGl0KHN0ciwgJy0nLCAzKTtcclxuICAgICAgbmV3RGF0ZSA9IFtzcGxpdFsxXSwgc3BsaXRbMF0sIHNwbGl0WzJdXTtcclxuICAgICAgcmV0dXJuIF8uam9pbihuZXdEYXRlLCAnLScpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0cjtcclxuICB9LFxyXG4gIHNhbml0aXplOiBmdW5jdGlvbiBzYW5pdGl6ZShlbCkge1xyXG4gICAgdmFyIHNhbml0aXplZFN0cjtcclxuICAgIHZhciBzdHIgPSBlbC52YWx1ZTtcclxuICAgIHNhbml0aXplZFN0ciA9IHN0ci5yZXBsYWNlKC9bXmEtejAtOUEtWkEtes6RLc6pzrEtz4nOr8+KzpDPjM6szq3Pjc+LzrDOrs+OXS9naSwgJycpO1xyXG4gICAgZWwudmFsdWUgPSBzYW5pdGl6ZWRTdHI7XHJcbiAgICBjb25zb2xlLmxvZyhlbCk7XHJcbiAgICBjb25zb2xlLmxvZyhlbC52YWx1ZSk7XHJcbiAgICBjb25zb2xlLmxvZyhzYW5pdGl6ZWRTdHIpO1xyXG4gIH1cclxuICAvLyB6b29tVG9HaWQ6IGZ1bmN0aW9uIHpvb21Ub0dpZChtYXAsIGdpZCkge1xyXG4gIC8vICAgdmFyIGNvb3JkaW5hdGVzID0gdXRpbHMuZmluZEJ5SWQobWFwLCAnZmlsdGVyZWRFc3RhdGVzJykuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZUJ5SWQoZ2lkKVxyXG4gIC8vICAgLmdldEdlb21ldHJ5KClcclxuICAvLyAgIC5nZXRDb29yZGluYXRlcygpO1xyXG4gIC8vICAgbWFwLmdldFZpZXcoKS5zZXRDZW50ZXIoY29vcmRpbmF0ZXMpO1xyXG4gIC8vIH1cclxufTtcclxuIiwiQXBwLmNvbmZpZy5tb2R1bGVzLm1hcCA9IChmdW5jdGlvbiBvbDNNYXAod2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgb2wsIEFwcCkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgbGFuZyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xyXG4gIHZhciBjZW50ZXIgPSBbMzY3NzM4NSwgNDEyMDk0OV07XHJcbiAgdmFyIGV4dGVudCA9IFszNjUyNzcyLCA0MTEyODA4LCAzNzAwMDAwLCA0MTMyNzk3XTtcclxuICB2YXIgZ2VvSlNPTkZvcm1hdCA9IG5ldyBvbC5mb3JtYXQuR2VvSlNPTih7XHJcbiAgICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbiAgfSk7XHJcblxyXG4gIHZhciBtYXBTdHlsZXMgPSB7XHJcbiAgICBpY29uVHlwZTogZnVuY3Rpb24gaWNvblR5cGUoZXN0YXRlVHlwZSkge1xyXG4gICAgICB2YXIgdHlwZSA9IHtcclxuICAgICAgICBBcGFydG1lbnQ6IGZ1bmN0aW9uIGFwYXJ0bWVudEljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ2FwYXJ0bWVudCc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAnRGV0YWNoZWQgSG91c2UnOiBmdW5jdGlvbiBkZXRhY2hlZEhvdWNlSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAnZGV0YWNoZWQnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgVmlsbGE6IGZ1bmN0aW9uIHZpbGxhSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgTWFpc29uZXR0ZTogZnVuY3Rpb24gbWFpc29uZXR0ZUljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ3ZpbGxhJztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiAodHlwZVtlc3RhdGVUeXBlXSkoKTtcclxuICAgIH0sXHJcbiAgICBpY29uUGF0aDogZnVuY3Rpb24gaWNvblBhdGgobGlzdGluZ1R5cGUpIHtcclxuICAgICAgdmFyIHBhdGggPSB7XHJcbiAgICAgICAgdHJ1ZTogZnVuY3Rpb24gc2FsZUljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvc2FsZS8nO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZmFsc2U6IGZ1bmN0aW9uIHJlbnRJY29uKCkge1xyXG4gICAgICAgICAgcmV0dXJuICcuL2ltYWdlcy9waW5zL3JlbnQvJztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiAocGF0aFtsaXN0aW5nVHlwZV0pKCk7XHJcbiAgICB9LFxyXG4gICAgZXN0YXRlczogZnVuY3Rpb24gZXN0YXRlcyhmZWF0dXJlKSB7XHJcbiAgICAgIHZhciBzcmMgPSBtYXBTdHlsZXMuaWNvblBhdGgoZmVhdHVyZS5nZXQoJ3NhbGUnKSkgK1xyXG4gICAgICBtYXBTdHlsZXMuaWNvblR5cGUoZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGVfZW4nKSkgKyAnLTQ4LnBuZyc7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICAgIGdlb21ldHJ5OiBmZWF0dXJlLmdldEdlb21ldHJ5KCksXHJcbiAgICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgICAgICBzcmM6IHNyYyxcclxuICAgICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgICAgICBzY2FsZTogMVxyXG4gICAgICAgIH0pKVxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBjbHVzdGVyOiBmdW5jdGlvbiBjbHVzdGVyKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHNpemUgPSBmZWF0dXJlLmdldCgnZmVhdHVyZXMnKS5sZW5ndGg7XHJcbiAgICAgIHZhciBzdHlsZTtcclxuICAgICAgdmFyIG9yaWdpbmFsRmVhdHVyZTtcclxuICAgICAgaWYgKHNpemUgPiAxKSB7XHJcbiAgICAgICAgc3R5bGUgPSBbbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuQ2lyY2xlKHtcclxuICAgICAgICAgICAgcmFkaXVzOiAyMCxcclxuICAgICAgICAgICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHtcclxuICAgICAgICAgICAgICBjb2xvcjogWzE1NiwgMzksIDE3NiwgMV0sXHJcbiAgICAgICAgICAgICAgd2lkdGg6IDVcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAgICAgICBjb2xvcjogWzY4LCAxMzgsIDI1NSwgMC44XVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICB0ZXh0OiBuZXcgb2wuc3R5bGUuVGV4dCh7XHJcbiAgICAgICAgICAgIHRleHQ6IHNpemUudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiAnI0ZGRkZGRidcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgekluZGV4OiAxMDFcclxuICAgICAgICB9KV07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgb3JpZ2luYWxGZWF0dXJlID0gZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJylbMF07XHJcbiAgICAgICAgc3R5bGUgPSBbbWFwU3R5bGVzLmVzdGF0ZXMob3JpZ2luYWxGZWF0dXJlKV07XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHN0eWxlO1xyXG4gICAgfSxcclxuICAgIHBvaTogZnVuY3Rpb24gcG9pKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHN0eWxlQ2FjaGUgPSB7fTtcclxuICAgICAgdmFyIHN5bWJvbCA9IGZlYXR1cmUuZ2V0KCdzdHlsZScpO1xyXG4gICAgICB2YXIgdGV4dDtcclxuICAgICAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgICB0ZXh0ID0gZmVhdHVyZS5nZXQoJ25hbWVfZWwnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0ZXh0ID0gZmVhdHVyZS5nZXQoJ25hbWVfZW4nKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXN0eWxlQ2FjaGVbc3ltYm9sXSkge1xyXG4gICAgICAgIHN0eWxlQ2FjaGUgPSBbbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICAgICAgICBzcmM6ICcuLi9pbWFnZXMvbWFraS9yZW5kZXJzLycgKyBzeW1ib2wgKyAnLTI0LnBuZycsXHJcbiAgICAgICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICAgICAgYW5jaG9yOiBbMC41LCAwLjVdLFxyXG4gICAgICAgICAgICBzY2FsZTogMVxyXG4gICAgICAgICAgfSkpLFxyXG4gICAgICAgICAgdGV4dDogbmV3IG9sLnN0eWxlLlRleHQoe1xyXG4gICAgICAgICAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgICAgICAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2Uoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiBbMTU2LCAzOSwgMTc2LCAwLjhdLFxyXG4gICAgICAgICAgICAgIHdpZHRoOiAxXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBvZmZzZXRZOiAxMlxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9KV07XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHN0eWxlQ2FjaGU7XHJcbiAgICB9LFxyXG4gICAgZmlsdGVyZWRFc3RhdGVzOiBmdW5jdGlvbiBmaWx0ZXJlZEVzdGF0ZXMoZmVhdHVyZSkge1xyXG4gICAgICB2YXIgc3JjID0gbWFwU3R5bGVzLmljb25QYXRoKGZlYXR1cmUuZ2V0KCdzYWxlJykpICtcclxuICAgICAgbWFwU3R5bGVzLmljb25UeXBlKGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlX2VuJykpICsgJy00OC5wbmcnO1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICAgIHNyYzogc3JjLFxyXG4gICAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgICAgYW5jaG9yOiBbMC41LCAwXSxcclxuICAgICAgICAgIHNjYWxlOiAxXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG5cclxuICB2YXIgbWFwU291cmNlcyA9IHtcclxuICAgIGJpbmc6IGZ1bmN0aW9uIGJpbmcoKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLkJpbmdNYXBzKHtcclxuICAgICAgICBrZXk6ICdBazJHcThWVWZJQ3NQcHVmN0xSQU5YbVh0MnNIV21TTFBob2htVkxGdEZJRXdZanNfNU1DeUFoQUZ3UlNWcExqJyxcclxuICAgICAgICBpbWFnZXJ5U2V0OiAnQWVyaWFsV2l0aExhYmVscydcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgbWFwQm94OiBmdW5jdGlvbiBtYXBCb3goKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLlhZWih7XHJcbiAgICAgICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgICAgIGh0bWw6ICc8YSBocmVmPVwiaHR0cHM6Ly93d3cubWFwYm94LmNvbS9hYm91dC9tYXBzL1wiIHRhcmdldD1cIl9ibGFua1wiPiZjb3B5OyBNYXBib3ggJmNvcHk7IE9wZW5TdHJlZXRNYXA8L2E+J1xyXG4gICAgICAgIH0pXSxcclxuICAgICAgICB1cmw6ICdodHRwczovL2FwaS5tYXBib3guY29tL3Y0L21hcGJveC5zdHJlZXRzL3t6fS97eH0ve3l9LnBuZz9hY2Nlc3NfdG9rZW49cGsuZXlKMUlqb2labWx5ZG1GcGJpSXNJbUVpT2lKbE9XWXlZVE0wTlRoaU5XTTBZakpqT0RKak5ERTRPRFF6TnpBMk1HUXlOaUo5Li1OVkRPMjdIenQtd19uUW9zVVBmTEEnXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGVzdGF0ZXM6IGZ1bmN0aW9uIGVzdGF0ZXMoKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLlZlY3Rvcih7XHJcbiAgICAgICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0LFxyXG4gICAgICAgIGxvYWRlcjogZnVuY3Rpb24gZmVhdHJlTG9hZGVyKCkge1xyXG4gICAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgICAgICAgdGhpcy5jbGVhcigpO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9saXN0aW5nL2FsbCcsXHJcbiAgICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZShmdW5jdGlvbiBzdWNjZWRlZChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgIHZhciBmZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKHJlc3BvbnNlLCB7XHJcbiAgICAgICAgICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICBzZWxmLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCBhbnkgcHJvcGVydGllcyEnKTtcclxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgY2x1c3RlcjogZnVuY3Rpb24gY2x1c3RlcigpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuQ2x1c3Rlcih7XHJcbiAgICAgICAgZGlzdGFuY2U6IDQwLFxyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5lc3RhdGVzKCksXHJcbiAgICAgICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgICAgIGh0bWw6ICdBbGwgbWFwcyDCqSA8YSBocmVmPVwiaHR0cDovL3d3dy50ZXJyYWNvZ25pdGEuZ3IvXCI+VGVycmEgQ29nbml0YTwvYT4nXHJcbiAgICAgICAgfSldXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHNlbGVjdDogZnVuY3Rpb24gc2VsZWN0KCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe30pO1xyXG4gICAgfSxcclxuICAgIHBvaTogZnVuY3Rpb24gcG9pKCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgICAgICBodG1sOiAnUE9JIGJ5IDxhIGhyZWY9XCJodHRwOi8vd3d3LnRlcnJhY29nbml0YS5nci9cIj5UZXJyYSBDb2duaXRhPC9hPidcclxuICAgICAgICB9KV0sXHJcbiAgICAgICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIHZhciBtYXBMYXllcnMgPSB7XHJcbiAgICBiaW5nOiBmdW5jdGlvbiBiaW5nKHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuYmluZygpLFxyXG4gICAgICAgIG1heFpvb206IDE5LFxyXG4gICAgICAgIGNyb3NzT3JpZ2luOiAnYW5vbnltb3VzJyxcclxuICAgICAgICBwcmVsb2FkOiBJbmZpbml0eSxcclxuICAgICAgICBpZDogJ2JpbmcnLFxyXG4gICAgICAgIG5hbWU6IHRyYW5zLmxheWVycy5iaW5nXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIG1hcEJveDogZnVuY3Rpb24gbWFwQm94KHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgICAgICAgc291cmNlOiBtYXBTb3VyY2VzLm1hcEJveCgpLFxyXG4gICAgICAgIGlkOiAnbWFwYm94JyxcclxuICAgICAgICBuYW1lOiB0cmFucy5sYXllcnMubWFwQm94XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGVzdGF0ZXM6IGZ1bmN0aW9uIGVzdGF0ZXModHJhbnMpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5jbHVzdGVyKCksXHJcbiAgICAgICAgaWQ6ICdlc3RhdGVzJyxcclxuICAgICAgICB2aXNpYmxlOiB0cnVlLFxyXG4gICAgICAgIHN0eWxlOiBtYXBTdHlsZXMuY2x1c3RlcixcclxuICAgICAgICB6SW5kZXg6IDIsXHJcbiAgICAgICAgbmFtZTogdHJhbnMubGF5ZXJzLmVzdGF0ZXNcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgcG9pOiBmdW5jdGlvbiBwb2kodHJhbnMpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5wb2koKSxcclxuICAgICAgICBzdHlsZTogbWFwU3R5bGVzLnBvaSxcclxuICAgICAgICBtYXhSZXNvbHV0aW9uOiAzLFxyXG4gICAgICAgIHpJbmRleDogMSxcclxuICAgICAgICBpZDogJ3BvaSdcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgZmlsdGVyZWRFc3RhdGVzOiBmdW5jdGlvbiBmaWx0ZXJlZEVzdGF0ZXModHJhbnMpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgICAgICAgZm9ybWF0OiBnZW9KU09ORm9ybWF0XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgaWQ6ICdmaWx0ZXJlZEVzdGF0ZXMnLFxyXG4gICAgICAgIHZpc2libGU6IHRydWUsXHJcbiAgICAgICAgc3R5bGU6IG1hcFN0eWxlcy5maWx0ZXJlZEVzdGF0ZXMsXHJcbiAgICAgICAgekluZGV4OiAyXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHNlbGVjdDogZnVuY3Rpb24gc2VsZWN0KCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgICAgICAgc291cmNlOiBtYXBTb3VyY2VzLnNlbGVjdCgpLFxyXG4gICAgICAgIHN0eWxlOiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgICAgICBjb2xvcjogJ3JnYmEoMjI3LCA3MiwgMjcsIDAuMiknXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XHJcbiAgICAgICAgICAgIGNvbG9yOiAnI0UzNDgxQicsXHJcbiAgICAgICAgICAgIHdpZHRoOiAyXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuQ2lyY2xlKHtcclxuICAgICAgICAgICAgcmFkaXVzOiA3LFxyXG4gICAgICAgICAgICBmaWxsOiBuZXcgb2wuc3R5bGUuRmlsbCh7XHJcbiAgICAgICAgICAgICAgY29sb3I6ICcjRTM0ODFCJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9KSxcclxuICAgICAgICB6SW5kZXg6IDMsXHJcbiAgICAgICAgaWQ6ICdzZWxlY3QnXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgdmFyIGluaXRpYWxpemUgPSBmdW5jdGlvbiBpbml0aWFsaXplKCkge1xyXG4gICAgIHZhciB0cmFucyA9IF8uY2xvbmVEZWVwKEFwcC5jb25maWcuY29tbW9ucy50cmFucyk7XHJcbiAgICB2YXIgbGF5ZXJzID0gT2JqZWN0LmtleXMobWFwTGF5ZXJzKS5tYXAoZnVuY3Rpb24gYWRkTWFwTGF5ZXJzKGtleSkge1xyXG4gICAgICBpZiAoa2V5ICE9PSAnYmluZycpIHsgcmV0dXJuIG1hcExheWVyc1trZXldKHRyYW5zKTsgfVxyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG5ldyBvbC5NYXAoe1xyXG4gICAgICB0YXJnZXQ6ICdtYXAnLFxyXG4gICAgICBsYXllcnM6IF8uY29tcGFjdChsYXllcnMpLFxyXG4gICAgICBsb2FkVGlsZXNXaGlsZUFuaW1hdGluZzogdHJ1ZSxcclxuICAgICAgbG9hZFRpbGVzV2hpbGVJbnRlcmFjdGluZzogdHJ1ZSxcclxuICAgICAgcmVuZGVyZXI6ICdjYW52YXMnLFxyXG4gICAgICBjb250cm9sczogb2wuY29udHJvbC5kZWZhdWx0cyh7XHJcbiAgICAgICAgYXR0cmlidXRpb25PcHRpb25zOiB7XHJcbiAgICAgICAgICBjb2xsYXBzaWJsZTogZmFsc2UsXHJcbiAgICAgICAgICBjb2xsYXBzZWQ6IGZhbHNlXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICAgLmV4dGVuZChbXHJcbiAgICAgICAgIG5ldyBvbC5jb250cm9sLlNjYWxlTGluZSh7XHJcbiAgICAgICAgICAgdW5pdHM6ICdtZXRyaWMnXHJcbiAgICAgICAgIH0pLCBuZXcgb2wuY29udHJvbC5PdmVydmlld01hcCh7XHJcbiAgICAgICAgICAgY2xhc3NOYW1lOiAnb2wtb3ZlcnZpZXdtYXAgb2wtY3VzdG9tLW92ZXJ2aWV3bWFwJyxcclxuICAgICAgICAgICBjb2xsYXBzaWJsZTogdHJ1ZSxcclxuICAgICAgICAgICBjb2xsYXBzZWQ6IHRydWUsXHJcbiAgICAgICAgICAgbGF5ZXJzOiBbbWFwTGF5ZXJzLmJpbmcodHJhbnMpXVxyXG4gICAgICAgICB9KSxcclxuICAgICAgICAgbmV3IG9sLmNvbnRyb2wuWm9vbVRvRXh0ZW50KHtcclxuICAgICAgICAgICBleHRlbnQ6IGV4dGVudFxyXG4gICAgICAgICB9KVxyXG4gICAgICAgXSksXHJcbiAgICAgIHZpZXc6IG5ldyBvbC5WaWV3KHtcclxuICAgICAgICBjZW50ZXI6IGNlbnRlcixcclxuICAgICAgICBleHRlbnQ6IGV4dGVudCxcclxuICAgICAgICBwcm9qZWN0aW9uOiAnRVBTRzozODU3JyxcclxuICAgICAgICB6b29tOiAxNCxcclxuICAgICAgICBtYXhab29tOiAxOSxcclxuICAgICAgICBtaW5ab29tOiAxNFxyXG4gICAgICB9KVxyXG4gICAgfSk7XHJcbiAgfTtcclxuICByZXR1cm4ge1xyXG4gICAgaW5pdGlhbGl6ZTogaW5pdGlhbGl6ZVxyXG4gIH07XHJcbn0od2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgb2wsIEFwcCkpO1xyXG4iLCJBcHAuY29uZmlnLm1vZHVsZXMuaW5mbyA9IChmdW5jdGlvbiBpbmZvKHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsICQsIEFwcCkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgbGFuZyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xyXG4gIHZhciBkdXN0Qmx1ZWJpcmQgPSBBcHAuY29uZmlnLnByb21pc2VzLmR1c3RCbHVlYmlyZDtcclxuICB2YXIgdXRpbHMgPSBBcHAudXRpbHM7XHJcblxyXG4gIHZhciBnZW9KU09ORm9ybWF0ID0gbmV3IG9sLmZvcm1hdC5HZW9KU09OKHtcclxuICAgIGRlZmF1bHREYXRhUHJvamVjdGlvbjogJ0VQU0c6NDMyNidcclxuICB9KTtcclxuICBmdW5jdGlvbiBleHRyYUluZm9Nb2RhbChmZWF0dXJlKSB7XHJcbiAgICB2YXIgdHJhbnMgPSBfLmNsb25lRGVlcChBcHAuY29uZmlnLmNvbW1vbnMudHJhbnMpO1xyXG4gICAgdmFyIG1vZGFsUHJvbWlzZTtcclxuICAgIHZhciBvYmogPSB7fTtcclxuICAgIGlmIChmZWF0dXJlLmdldCgncmVudCcpKSB7XHJcbiAgICAgIG9iai5saXN0aW5nX3R5cGUgPSB0cmFucy5saXN0aW5nLnJlbnQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBvYmoubGlzdGluZ190eXBlID0gdHJhbnMubGlzdGluZy5zYWxlO1xyXG4gICAgfVxyXG4gICAgb2JqLnR5cGUgPSBmZWF0dXJlLmdldCgnZXN0YXRldHlwZScpO1xyXG4gICAgb2JqLmdpZCA9IGZlYXR1cmUuZ2V0KCdnaWQnKTtcclxuICAgIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgICAgIG9iai5hZGRyZXNzID0gZmVhdHVyZS5nZXQoJ3N0cmVldF9lbCcpICsgJycgKyAgZmVhdHVyZS5nZXQoJ3N0cmVldF9udW1iZXInKTtcclxuICAgICAgb2JqLmNvbnRhY3QgPSB7XHJcbiAgICAgICAgbmFtZTogZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkubmFtZV9lbCxcclxuICAgICAgICBsYXN0bmFtZTogZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkubGFzdG5hbWVfZWxcclxuICAgICAgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG9iai5hZGRyZXNzID0gZmVhdHVyZS5nZXQoJ3N0cmVldF9lbicpICsgJycgKyAgZmVhdHVyZS5nZXQoJ3N0cmVldF9udW1iZXInKTtcclxuICAgICAgb2JqLmNvbnRhY3QgPSB7XHJcbiAgICAgICAgbmFtZTogZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkubmFtZV9lbixcclxuICAgICAgICBsYXN0bmFtZTogZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkubGFzdG5hbWVfZW5cclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIG9iai5hcmVhID0gZmVhdHVyZS5nZXQoJ2VzdGF0ZWFyZWEnKTtcclxuICAgIG9iai5iZWRyb29tcyA9IGZlYXR1cmUuZ2V0KCdiZWRyb29tcycpO1xyXG4gICAgb2JqLnByaWNlID0gZmVhdHVyZS5nZXQoJ3ByaWNlJyk7XHJcbiAgICBvYmoudGl0bGUgPSB7XHJcbiAgICAgIGdpZDogdHJhbnMuZXN0YXRlLmdpZCxcclxuICAgICAgbGlzdGluZ190eXBlOiB0cmFucy5saXN0aW5nLnR5cGUsXHJcbiAgICAgIGFkZHJlc3M6IHRyYW5zLmVzdGF0ZS5hZGRyZXNzLFxyXG4gICAgICBhcmVhOiB0cmFucy5lc3RhdGUuYXJlYSxcclxuICAgICAgYmVkcm9vbXM6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuYmVkcm9vbXMsXHJcbiAgICAgIHByaWNlOiB0cmFucy5saXN0aW5nLnByaWNlLFxyXG4gICAgICBpc25ldzogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5pc25ldyxcclxuICAgICAgcGFya2luZzogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5wYXJraW5nLFxyXG4gICAgICBmdXJuaXNoZWQ6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuZnVybmlzaGVkLFxyXG4gICAgICBwZXRzOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLnBldHMsXHJcbiAgICAgIHZpZXc6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMudmlldyxcclxuICAgICAgaGVhdGluZzogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5oZWF0aW5nLFxyXG4gICAgICBjb29saW5nOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmNvb2xpbmcsXHJcbiAgICAgIGNvbnRhY3RJbmZvOiB0cmFucy5jb250YWN0LmNvbnRhY3RJbmZvLFxyXG4gICAgICBuYW1lOiB0cmFucy5jb250YWN0Lm5hbWUsXHJcbiAgICAgIGxhc3RuYW1lOiB0cmFucy5jb250YWN0Lmxhc3RuYW1lLFxyXG4gICAgICBwaG9uZTogdHJhbnMuY29udGFjdC5waG9uZSxcclxuICAgICAgZW1haWw6IHRyYW5zLmNvbnRhY3QuZW1haWxcclxuICAgIH07XHJcbiAgICBvYmouaXNuZXcgPSBmZWF0dXJlLmdldCgnaXNuZXcnKTtcclxuICAgIG9iai5mdXJuaXNoZWQgPSBmZWF0dXJlLmdldCgnZnVybmlzaGVkJyk7XHJcbiAgICBvYmoucGV0cyA9IGZlYXR1cmUuZ2V0KCdwZXRzJyk7XHJcbiAgICBvYmouYnRucyA9IHtcclxuICAgICAgaW5mbzogdHJhbnMuYnRucy5pbmZvLFxyXG4gICAgICBjbG9zZTogdHJhbnMuYnRucy5jbG9zZVxyXG4gICAgfTtcclxuICAgIGlmIChmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5waG9uZTIgIT09IG51bGwpIHtcclxuICAgICAgb2JqLmNvbnRhY3QucGhvbmUgPSBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5waG9uZTEgKyAnICcgKyBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5waG9uZTI7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBvYmouY29udGFjdC5waG9uZSA9IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLnBob25lMTtcclxuICAgIH1cclxuICAgIG9iai5jb250YWN0LmVtYWlsID0gZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkuZW1haWw7XHJcblxyXG4gICAgbW9kYWxQcm9taXNlID0gZHVzdEJsdWViaXJkLnJlbmRlckFzeW5jKCdtb2RhbEluZm8nLCBvYmopXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgJCgnI21vZGFsJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChkYXRhKTtcclxuICAgIH0pXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKCkge1xyXG4gICAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICAgJC5nZXQoJ2h0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvaF8yMjIsY19zY2FsZS8nICsgZmVhdHVyZS5nZXQoJ2dpZCcpICsgJy5qcGcnKVxyXG4gICAgICApXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmVDbG91ZGluYXJ5KCkge1xyXG4gICAgICAgICQoJy5iaWctaW1hZ2UnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKGh0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvaF8yMjIsY19zY2FsZS8nICsgZmVhdHVyZS5nZXQoJ2dpZCcpICsgJy5qcGcpJyk7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgICAgaWYgKGUuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICQoJy5iaWctaW1hZ2UnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKC9pbWFnZXMvbm9faW1hZ2VfYXZhaWxhYmxlLnBuZyknKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGUuc3RhdHVzKTtcclxuICAgIH0pO1xyXG4gICAgJCgnI21vZGFsLWNsb3NlJykuY2xpY2soZnVuY3Rpb24gY2xvc2VNb2RhbCgpIHtcclxuICAgICAgJCgnI21vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gcmVuZGVyRXN0YXRlQ2FyZHMoZmVhdHVyZSkge1xyXG4gICAgdmFyIHRyYW5zID0gXy5jbG9uZURlZXAoQXBwLmNvbmZpZy5jb21tb25zLnRyYW5zKTtcclxuICAgIHZhciBlc3RhdGVDYXJkc1Byb21pc2U7XHJcbiAgICB2YXIgb2JqID0ge307XHJcbiAgICBpZiAoZmVhdHVyZS5nZXQoJ3JlbnQnKSkge1xyXG4gICAgICBvYmoubGlzdGluZ190eXBlID0gdHJhbnMubGlzdGluZy5yZW50O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb2JqLmxpc3RpbmdfdHlwZSA9IHRyYW5zLmxpc3Rpbmcuc2FsZTtcclxuICAgIH1cclxuICAgIG9iai50eXBlID0gZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGUnKTtcclxuICAgIG9iai5naWQgPSBmZWF0dXJlLmdldCgnZ2lkJyk7XHJcbiAgICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICBvYmouYWRkcmVzcyA9IGZlYXR1cmUuZ2V0KCdzdHJlZXRfZWwnKSArICcnICsgIGZlYXR1cmUuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBvYmouYWRkcmVzcyA9IGZlYXR1cmUuZ2V0KCdzdHJlZXRfZW4nKSArICcnICsgIGZlYXR1cmUuZ2V0KCdzdHJlZXRfbnVtYmVyJyk7XHJcbiAgICB9XHJcbiAgICBvYmouYXJlYSA9IGZlYXR1cmUuZ2V0KCdlc3RhdGVhcmVhJyk7XHJcbiAgICBvYmouYmVkcm9vbXMgPSBmZWF0dXJlLmdldCgnYmVkcm9vbXMnKTtcclxuICAgIG9iai5wcmljZSA9IGZlYXR1cmUuZ2V0KCdwcmljZScpO1xyXG4gICAgb2JqLnRpdGxlID0ge1xyXG4gICAgICBsaXN0aW5nX3R5cGU6IHRyYW5zLmxpc3RpbmcudHlwZSxcclxuICAgICAgYWRkcmVzczogdHJhbnMuZXN0YXRlLmFkZHJlc3MsXHJcbiAgICAgIGFyZWE6IHRyYW5zLmVzdGF0ZS5hcmVhLFxyXG4gICAgICBiZWRyb29tczogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5iZWRyb29tcyxcclxuICAgICAgcHJpY2U6IHRyYW5zLmxpc3RpbmcucHJpY2UsXHJcbiAgICAgIGlzbmV3OiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmlzbmV3LFxyXG4gICAgICBmdXJuaXNoZWQ6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuZnVybmlzaGVkLFxyXG4gICAgICBwZXRzOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLnBldHNcclxuICAgIH07XHJcbiAgICBvYmouaXNuZXcgPSBmZWF0dXJlLmdldCgnaXNuZXcnKTtcclxuICAgIG9iai5mdXJuaXNoZWQgPSBmZWF0dXJlLmdldCgnZnVybmlzaGVkJyk7XHJcbiAgICBvYmoucGV0cyA9IGZlYXR1cmUuZ2V0KCdwZXRzJyk7XHJcbiAgICBvYmouYnRucyA9IHtcclxuICAgICAgaW5mbzogdHJhbnMuYnRucy5pbmZvLFxyXG4gICAgICBjbG9zZTogdHJhbnMuYnRucy5jbG9zZVxyXG4gICAgfTtcclxuICAgIGVzdGF0ZUNhcmRzUHJvbWlzZSA9IGR1c3RCbHVlYmlyZC5yZW5kZXJBc3luYygnZXN0YXRlQ2FyZHMnLCBvYmopXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgJCgnLmVzdGF0ZS1jYXJkcycpLmh0bWwoZGF0YSk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZSgpIHtcclxuICAgICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAgICQuZ2V0KCdodHRwOi8vcmVzLmNsb3VkaW5hcnkuY29tL2ZpcnZhaW4vaW1hZ2UvdXBsb2FkL2hfMjIyLGNfc2NhbGUvJyArIGZlYXR1cmUuZ2V0KCdnaWQnKSArICcuanBnJylcclxuICAgICAgKVxyXG4gICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlQ2xvdWRpbmFyeSgpIHtcclxuICAgICAgICAkKCcuYmlnLWltYWdlJykuY3NzKCdiYWNrZ3JvdW5kLWltYWdlJywgJ3VybChodHRwOi8vcmVzLmNsb3VkaW5hcnkuY29tL2ZpcnZhaW4vaW1hZ2UvdXBsb2FkL2hfMjIyLGNfc2NhbGUvJyArIGZlYXR1cmUuZ2V0KCdnaWQnKSArICcuanBnKScpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICAgIGlmIChlLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAkKCcuYmlnLWltYWdlJykuY3NzKCdiYWNrZ3JvdW5kLWltYWdlJywgJ3VybCgvaW1hZ2VzL25vX2ltYWdlX2F2YWlsYWJsZS5wbmcpJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKCkge1xyXG4gICAgICAkKCcuZXN0YXRlLWltYWdlJykuY3NzKCdiYWNrZ3JvdW5kLWltYWdlJywgJ3VybChodHRwOi8vcmVzLmNsb3VkaW5hcnkuY29tL2ZpcnZhaW4vaW1hZ2UvdXBsb2FkL2hfMjIyLGNfc2NhbGUvJyArIGZlYXR1cmUuZ2V0KCdnaWQnKSArICcuanBnKScpO1xyXG4gICAgICAkKCcuZXN0YXRlLWNhcmRzJykuYWRkQ2xhc3MoJ2VzdGF0ZS1jYXJkcy1hY3RpdmUnKTtcclxuICAgICAgJCgnI2VzdGF0ZS1jYXJkLXNxdWFyZS1jbG9zZScpLmNsaWNrKGZ1bmN0aW9uIGNsb3NlKCkge1xyXG4gICAgICAgICQoJy5lc3RhdGUtY2FyZHMnKS5yZW1vdmVDbGFzcygnZXN0YXRlLWNhcmRzLWFjdGl2ZScpO1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2VzdGF0ZS1jYXJkLXNxdWFyZS1leHRyYS1pbmZvJykuY2xpY2soZnVuY3Rpb24gZXh0cmFJbmZvKCkge1xyXG4gICAgICAgIGV4dHJhSW5mb01vZGFsKGZlYXR1cmUpO1xyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBzZWxlY3RGZWF0dXJlKGV2dCkge1xyXG4gICAgdmFyIG1hcCA9IGV2dC5tYXA7XHJcbiAgICAvLyB2YXIgY29vcmRpbmF0ZSA9IGV2dC5jb29yZGluYXRlO1xyXG4gICAgdmFyIGY7XHJcbiAgICB2YXIgY2xpY2tlZEZlYXR1cmUgPSBtYXAuZm9yRWFjaEZlYXR1cmVBdFBpeGVsKGV2dC5waXhlbCwgZnVuY3Rpb24gZmluZEZlYXR1cmUoZmVhdHVyZSwgbGF5ZXIpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBmZWF0dXJlOiBmZWF0dXJlLFxyXG4gICAgICAgIGxheWVyOiBsYXllclxyXG4gICAgICB9O1xyXG4gICAgfSwgdGhpcywgZnVuY3Rpb24gY2xpY2tlZEZlYXR1cmVMYXllckZpbHRlcihsYXllcikge1xyXG4gICAgICBpZiAobGF5ZXIuZ2V0KCdpZCcpID09PSAnZXN0YXRlcycgfHwgbGF5ZXIuZ2V0KCdpZCcpID09PSAnZmlsdGVyZWRFc3RhdGVzJykge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0sIHRoaXMpO1xyXG4gICAgaWYgKGNsaWNrZWRGZWF0dXJlKSB7XHJcbiAgICAgIGlmIChjbGlja2VkRmVhdHVyZS5sYXllci5nZXQoJ2lkJykgPT09ICdlc3RhdGVzJyAmJlxyXG4gICAgICAgIGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuZ2V0KCdmZWF0dXJlcycpLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAgIGYgPSBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLmdldFByb3BlcnRpZXMoKS5mZWF0dXJlc1swXTtcclxuICAgICAgICByZW5kZXJFc3RhdGVDYXJkcyhmKTtcclxuICAgICAgICBtYXAuZ2V0VmlldygpLnNldENlbnRlcihmLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSk7XHJcbiAgICAgICAgbWFwLmdldFZpZXcoKS5zZXRab29tKDE2KTtcclxuICAgICAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvYXBpL3VzZXMvJyArIGYuZ2V0UHJvcGVydGllcygpLmdpZCxcclxuICAgICAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICAgICAgdmFyIGZlYXR1cmVzO1xyXG4gICAgICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICAgIGZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMoZGF0YS5wcm9wZXJ0eV9zZXJ2aWNlc19hbmFseXNpcywge1xyXG4gICAgICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgZmVhdHVyZXMuZm9yRWFjaChmdW5jdGlvbiByZW1vdmVQb2x5Z29uKGZlYXR1cmUpIHtcclxuICAgICAgICAgICAgaWYgKGZlYXR1cmUuZ2V0R2VvbWV0cnkoKS5nZXRUeXBlKCkgPT09ICdQb2x5Z29uJykge1xyXG4gICAgICAgICAgICAgIGZlYXR1cmVzLnNwbGljZShmZWF0dXJlcy5pbmRleE9mKGZlYXR1cmUpLCAxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICAgICAgICAvLyBtYXAuZ2V0VmlldygpLmZpdCh1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5nZXRFeHRlbnQoKSwgbWFwLmdldFNpemUoKSk7XHJcblxyXG4gICAgICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlcy5sZW5ndGggKyAnIFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgICAgaWYgKGUuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgICAgICB0b2FzdHIuZXJyb3IoZS5yZXNwb25zZVRleHQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2UgaWYgKGNsaWNrZWRGZWF0dXJlLmxheWVyLmdldCgnaWQnKSA9PT0gJ2ZpbHRlcmVkRXN0YXRlcycpIHtcclxuICAgICAgICBmID0gY2xpY2tlZEZlYXR1cmUuZmVhdHVyZTtcclxuICAgICAgICByZW5kZXJFc3RhdGVDYXJkcyhmKTtcclxuICAgICAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvdXNlcy8nICsgZi5nZXRQcm9wZXJ0aWVzKCkuZ2lkLFxyXG4gICAgICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJ1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApXHJcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgICAgICB2YXIgZmVhdHVyZXM7XHJcbiAgICAgICAgICBpZiAodXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZXMoKS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMoZGF0YS5wcm9wZXJ0eV9zZXJ2aWNlc19hbmFseXNpcywge1xyXG4gICAgICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgZmVhdHVyZXMuZm9yRWFjaChmdW5jdGlvbiByZW1vdmVQb2x5Z29uKGZlYXR1cmUpIHtcclxuICAgICAgICAgICAgaWYgKGZlYXR1cmUuZ2V0R2VvbWV0cnkoKS5nZXRUeXBlKCkgPT09ICdQb2x5Z29uJykge1xyXG4gICAgICAgICAgICAgIGZlYXR1cmVzLnNwbGljZShmZWF0dXJlcy5pbmRleE9mKGZlYXR1cmUpLCAxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICAgICAgICBtYXAuZ2V0VmlldygpLmZpdCh1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5nZXRFeHRlbnQoKSwgbWFwLmdldFNpemUoKSk7XHJcbiAgICAgICAgICB0b2FzdHIuaW5mbygnRm91bmQgJyArIGZlYXR1cmVzLmxlbmd0aCArICcgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgICAgIGlmIChlLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIGFueSBQb2ludHMgb2YgSW50ZXJlc3QgaW4gOCBtaW51dGUgZGlzdGFuY2UhJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgICAgICAgICAgdG9hc3RyLmVycm9yKGUucmVzcG9uc2VUZXh0KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAncG9pJykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGluaXQoKSB7XHJcbiAgICB2YXIgbWFwID0gQXBwLmNvbmZpZy5jb21tb25zLm1hcDtcclxuICAgIG1hcC5vbignY2xpY2snLCBzZWxlY3RGZWF0dXJlKTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZGlzYWJsZSgpIHtcclxuICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgbWFwLnVuKCdjbGljaycsIHNlbGVjdEZlYXR1cmUpO1xyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgaW5pdDogaW5pdCxcclxuICAgIGRpc2FibGU6IGRpc2FibGVcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsIGpRdWVyeSwgQXBwKSk7XHJcbiIsIkFwcC5jb25maWcubW9kdWxlcy5maWx0ZXJzID0gKGZ1bmN0aW9uIGZpbHRlcnMod2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgJCwgUGFyc2xleSwgbW9tZW50LCBBcHApIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGxhbmcgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZztcclxuICB2YXIgZHVzdEJsdWViaXJkID0gQXBwLmNvbmZpZy5wcm9taXNlcy5kdXN0Qmx1ZWJpcmQ7XHJcbiAgdmFyIHV0aWxzID0gQXBwLnV0aWxzO1xyXG5cclxuICB2YXIgeHkxID0gb2wucHJvai50cmFuc2Zvcm0oWzM2NTI3NzIsIDQxMTI4MDhdLCAnRVBTRzozODU3JywgJ0VQU0c6NDMyNicpO1xyXG4gIHZhciB4eTIgPSBvbC5wcm9qLnRyYW5zZm9ybShbMzcwMDAwMCwgNDEzMjc5N10sICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgdmFyIGV4dGVudCA9IF8uY29uY2F0KHh5MSwgeHkyKTtcclxuICB2YXIgYmJveCA9IGV4dGVudDtcclxuICBmdW5jdGlvbiBhc3NpZ25WYWxpZGF0b3JzKCkge1xyXG4gICAgdmFyIGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5mb2JveC1jb250ZW50Jyk7XHJcbiAgICB2YXIgaW5wdXRzID0gY29udGVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFt0eXBlPXRleHRdJyk7XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoaW5wdXRzLCBmdW5jdGlvbiBtYWtlUGFyc2xleUlucHV0cyhlbCkge1xyXG4gICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgZnVuY3Rpb24gc2FuaXRpemUoKSB7XHJcbiAgICAgICAgdmFyIHN0ciA9IHRoaXMudmFsdWU7XHJcbiAgICAgICAgdmFyIHNhbml0aXplZFN0cjtcclxuICAgICAgICBpZiAodGhpcy5kYXRhc2V0LnR5cGUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICBzYW5pdGl6ZWRTdHIgPSBzdHIucmVwbGFjZSgvWy9cXEQvIF0vZ2ksICcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YXNldC50eXBlID09PSAnYWxwaGFudW0nKSB7XHJcbiAgICAgICAgICBzYW5pdGl6ZWRTdHIgPSBzdHIucmVwbGFjZSgvW15hLXowLTlBLVpBLXrOkS3Oqc6xLc+Jzq/Pis6Qz4zOrM6tz43Pi86wzq7PjiBdL2dpLCAnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRhdGFzZXQudHlwZSA9PT0gJ3NwZWNpYWwnKSB7XHJcbiAgICAgICAgICBzYW5pdGl6ZWRTdHIgPSBzdHIucmVwbGFjZSgvW14wLTkgXFwvXS9naSwgJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhc2V0LnR5cGUgPT09ICdkYXRlJykge1xyXG4gICAgICAgICAgc2FuaXRpemVkU3RyID0gc3RyLnJlcGxhY2UoL1teMC05IFxcLV0vZ2ksICcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy52YWx1ZSA9IHNhbml0aXplZFN0cjtcclxuICAgICAgICB1dGlscy5yZW1vdmVDbGFzcyh0aGlzLnBhcmVudE5vZGUsICdpcy1pbnZhbGlkJyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGFkZFJlc3VsdHMoZGF0YSkge1xyXG4gICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICB2YXIgZ2VvSlNPTkZvcm1hdCA9IG5ldyBvbC5mb3JtYXQuR2VvSlNPTih7XHJcbiAgICAgIGRlZmF1bHREYXRhUHJvamVjdGlvbjogJ0VQU0c6NDMyNidcclxuICAgIH0pO1xyXG4gICAgdmFyIGZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMoZGF0YSwge1xyXG4gICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgIH0pO1xyXG4gICAgZmVhdHVyZXMuZm9yRWFjaChmdW5jdGlvbiBzZXRJZChmKSB7XHJcbiAgICAgIGYuc2V0SWQoZi5nZXRQcm9wZXJ0aWVzKCkuZ2lkKTtcclxuICAgIH0pO1xyXG4gICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZmlsdGVyZWRFc3RhdGVzJykuZ2V0U291cmNlKCkuYWRkRmVhdHVyZXMoZmVhdHVyZXMpO1xyXG4gICAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgdG9hc3RyLmluZm8oJ86Sz4HOrc64zrfOus6xzr0gJyArIGZlYXR1cmVzLmxlbmd0aCArICcgzrnOtM65zr/Ous+EzrfPg86vzrXPgiEnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRvYXN0ci5pbmZvKCdGb3VuZCAnICsgZmVhdHVyZXMubGVuZ3RoICsgJyBlc3RhdGVzIScpO1xyXG4gICAgfVxyXG4gIH1cclxuICBmdW5jdGlvbiBjbGVhclJlc3VsdHMoKSB7XHJcbiAgICB2YXIgbWFwID0gQXBwLmNvbmZpZy5jb21tb25zLm1hcDtcclxuICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ2ZpbHRlcmVkRXN0YXRlcycpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICB1dGlscy5maW5kQnlJZChtYXAsICdzZWxlY3QnKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgbWFwLmdldEludGVyYWN0aW9ucygpLmZvckVhY2goZnVuY3Rpb24gZmluZEludGVyYWN0aW9uQnlJZChpKSB7XHJcbiAgICAgIGlmIChpLmdldFByb3BlcnRpZXMoKS5pZCA9PT0gJ2RyYXcnKSB7XHJcbiAgICAgICAgaS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgICQobWFwLmdldFZpZXdwb3J0KCkpLm9mZignbW91c2VsZWF2ZScpO1xyXG4gICAgJChtYXAuZ2V0Vmlld3BvcnQoKSkub2ZmKCdtb3VzZWVudGVyJyk7XHJcbiAgICBiYm94ID0gZXh0ZW50O1xyXG4gICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICBBcHAuY29uZmlnLm1vZHVsZXMuaW5mby5pbml0KCk7XHJcbiAgICAkKCcjcmVzdWx0cycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpLnJlbW92ZUF0dHIoJ3N0eWxlJylcclxuICAgIC5lbXB0eSgpO1xyXG4gIH1cclxuICBmdW5jdGlvbiBzZXRPcHRpb25zKCkge1xyXG4gICAgdmFyIGZpbHRlckRhdGEgPSB7fTtcclxuICAgIGZpbHRlckRhdGEuZXN0YXRlVHlwZSA9ICQoJyNlc3RhdGVUeXBlJykudmFsKCk7XHJcbiAgICBmaWx0ZXJEYXRhLmxlYXNlVHlwZSA9ICQoJ2lucHV0W25hbWU9b3B0aW9uc106Y2hlY2tlZCcpLnZhbCgpICE9PSB1bmRlZmluZWQgPyAkKCdpbnB1dFtuYW1lPW9wdGlvbnNdOmNoZWNrZWQnKS52YWwoKSA6ICdSZW50JztcclxuICAgIGZpbHRlckRhdGEuc3RhcnRQcmljZSA9ICQoJyNzdGFydFByaWNlJykudmFsKCkgIT09ICcnID8gJCgnI3N0YXJ0UHJpY2UnKS52YWwoKSA6IDA7XHJcbiAgICBmaWx0ZXJEYXRhLmVuZFByaWNlID0gJCgnI2VuZFByaWNlJykudmFsKCkgIT09ICcnID8gJCgnI2VuZFByaWNlJykudmFsKCkgOiAyMTQ3NDgzNjQ3O1xyXG4gICAgZmlsdGVyRGF0YS5hcmVhU3RhcnQgPSAkKCcjYXJlYS1zdGFydCcpLnZhbCgpICE9PSAnJyA/ICQoJyNhcmVhLXN0YXJ0JykudmFsKCkgOiAwO1xyXG4gICAgZmlsdGVyRGF0YS5hcmVhRW5kID0gJCgnI2FyZWEtZW5kJykudmFsKCkgIT09ICcnID8gJCgnI2FyZWEtZW5kJykudmFsKCkgOiAyMTQ3NDgzNjQ3O1xyXG4gICAgZmlsdGVyRGF0YS5wYXJraW5nID0gJCgnI2NoZWNrYm94LTEnKS5wcm9wKCdjaGVja2VkJykgIT09IHVuZGVmaW5lZCA/ICQoJyNjaGVja2JveC0xJykucHJvcCgnY2hlY2tlZCcpIDogZmFsc2U7XHJcbiAgICBmaWx0ZXJEYXRhLmZ1cm5pc2hlZCA9ICQoJyNjaGVja2JveC0yJykucHJvcCgnY2hlY2tlZCcpICE9PSB1bmRlZmluZWQgPyAkKCcjY2hlY2tib3gtMicpLnByb3AoJ2NoZWNrZWQnKSA6IGZhbHNlO1xyXG4gICAgZmlsdGVyRGF0YS5oZWF0aW5nID0gJCgnI2NoZWNrYm94LTMnKS5wcm9wKCdjaGVja2VkJykgIT09IHVuZGVmaW5lZCA/ICQoJyNjaGVja2JveC0zJykucHJvcCgnY2hlY2tlZCcpIDogZmFsc2U7XHJcbiAgICBmaWx0ZXJEYXRhLmNvb2xpbmcgPSAkKCcjY2hlY2tib3gtNCcpLnByb3AoJ2NoZWNrZWQnKSAhPT0gdW5kZWZpbmVkID8gJCgnI2NoZWNrYm94LTQnKS5wcm9wKCdjaGVja2VkJykgOiBmYWxzZTtcclxuICAgIGZpbHRlckRhdGEudmlldyA9ICQoJyNjaGVja2JveC01JykucHJvcCgnY2hlY2tlZCcpICE9PSB1bmRlZmluZWQgPyAkKCcjY2hlY2tib3gtNScpLnByb3AoJ2NoZWNrZWQnKSA6IGZhbHNlO1xyXG4gICAgZmlsdGVyRGF0YS5iYm94ID0gYmJveDtcclxuICAgIHJldHVybiBmaWx0ZXJEYXRhO1xyXG4gIH1cclxuICBmdW5jdGlvbiBnZXRSZXN1bHRzKG9wdGlvbnMpIHtcclxuICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgdmFyIHRyYW5zID0gXy5jbG9uZURlZXAoQXBwLmNvbmZpZy5jb21tb25zLnRyYW5zKTtcclxuICAgIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvYXBpL2xpc3RpbmcvZmlsdGVycycsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICBkYXRhOiBvcHRpb25zXHJcbiAgICAgIH0pXHJcbiAgICApXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuXHJcbiAgICAgIHZhciByZW5kZXJEYXRhID0ge307XHJcblxyXG4gICAgICB2YXIgcmVzdWx0cyA9IFtdO1xyXG5cclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLnNldFZpc2libGUoZmFsc2UpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdmaWx0ZXJlZEVzdGF0ZXMnKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAvLyB1dGlscy5maW5kQnlJZChtYXAsICdzZWxlY3QnKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICBhZGRSZXN1bHRzKGRhdGEpO1xyXG4gICAgICBfLmZvckVhY2goZGF0YS5mZWF0dXJlcywgZnVuY3Rpb24odmFsdWUpIHtcclxuICAgICAgICB2YXIgYWRkcmVzcztcclxuICAgICAgICB2YXIgZGF0ZVN0YXJ0O1xyXG4gICAgICAgIHZhciBkYXRlRW5kO1xyXG4gICAgICAgIHZhciBjb29yZGluYXRlcyA9IG9sLnByb2oudHJhbnNmb3JtKHZhbHVlLmdlb21ldHJ5LmNvb3JkaW5hdGVzLCAnRVBTRzozODU3JywgJ0VQU0c6NDMyNicpO1xyXG4gICAgICAgIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgICAgICAgICBhZGRyZXNzID0gdmFsdWUucHJvcGVydGllcy5zdHJlZXRfZWwgKyAnICcgKyB2YWx1ZS5wcm9wZXJ0aWVzLnN0cmVldF9udW1iZXI7XHJcbiAgICAgICAgICBkYXRlU3RhcnQgPSBtb21lbnQodmFsdWUucHJvcGVydGllcy5kYXRlX3N0YXJ0KS5mb3JtYXQoJ0RELU1NLVlZWVknKTtcclxuICAgICAgICAgIGRhdGVFbmQgPSBtb21lbnQodmFsdWUucHJvcGVydGllcy5lbmQpLmZvcm1hdCgnREQtTU0tWVlZWScpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBhZGRyZXNzID0gdmFsdWUucHJvcGVydGllcy5zdHJlZXRfZW4gKyAnICcgKyB2YWx1ZS5wcm9wZXJ0aWVzLnN0cmVldF9udW1iZXI7XHJcbiAgICAgICAgICBkYXRlU3RhcnQgPSBtb21lbnQodmFsdWUucHJvcGVydGllcy5kYXRlX3N0YXJ0KS5mb3JtYXQoJ01NLURELVlZWVknKTtcclxuICAgICAgICAgIGRhdGVFbmQgPSBtb21lbnQodmFsdWUucHJvcGVydGllcy5lbmQpLmZvcm1hdCgnTU0tREQtWVlZWScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgZ2lkOiB2YWx1ZS5wcm9wZXJ0aWVzLmdpZCxcclxuICAgICAgICAgIHByaWNlOiB2YWx1ZS5wcm9wZXJ0aWVzLnByaWNlLFxyXG4gICAgICAgICAgYXJlYTogdmFsdWUucHJvcGVydGllcy5lc3RhdGVhcmVhLFxyXG4gICAgICAgICAgYWRkcmVzczogYWRkcmVzcyxcclxuICAgICAgICAgIGRhdGVTdGFydDogZGF0ZVN0YXJ0LFxyXG4gICAgICAgICAgZGF0ZUVuZDogZGF0ZUVuZCxcclxuICAgICAgICAgIHRpdGxlOiB7XHJcbiAgICAgICAgICAgIHByaWNlOiB0cmFucy5saXN0aW5nLnByaWNlLFxyXG4gICAgICAgICAgICBhcmVhOiB0cmFucy5lc3RhdGUuYXJlYSxcclxuICAgICAgICAgICAgYXJlYVVuaXRzOiB0cmFucy5lc3RhdGUuYXJlYVVuaXRzXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgY29vcmRpbmF0ZXM6IGNvb3JkaW5hdGVzXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZW5kZXJEYXRhLnJlc3VsdHMgPSByZXN1bHRzO1xyXG4gICAgICByZXR1cm4gcmVuZGVyRGF0YTtcclxuICAgIH0pXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgZHVzdEJsdWViaXJkLnJlbmRlckFzeW5jKCdyZXN1bHRzJywgZGF0YSlcclxuICAgICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZUR1c3QoZCkge1xyXG4gICAgICAgICQoJyNyZXN1bHRzJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgJCgnI3Jlc3VsdHMnKS5odG1sKGQpO1xyXG4gICAgICAgICQoJy5yZXN1bHRzLWxpc3QnKS5maW5kKCdpJykuZWFjaChmdW5jdGlvbiBhZGRab29tVG9SZXN1bHRzKCkge1xyXG4gICAgICAgICAgdmFyIGdpZCA9ICQodGhpcykucGFyZW50cygnbGknKS5kYXRhKCdnaWQnKTtcclxuICAgICAgICAgICQodGhpcykuY2xpY2soZnVuY3Rpb24gem9vbVRvR2lkKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIHZhciBjb29yZGluYXRlcyA9IHV0aWxzLmZpbmRCeUlkKG1hcCwgJ2ZpbHRlcmVkRXN0YXRlcycpLmdldFNvdXJjZSgpLmdldEZlYXR1cmVCeUlkKGdpZClcclxuICAgICAgICAgICAgLmdldEdlb21ldHJ5KClcclxuICAgICAgICAgICAgLmdldENvb3JkaW5hdGVzKCk7XHJcbiAgICAgICAgICAgIG1hcC5nZXRWaWV3KCkuc2V0Q2VudGVyKGNvb3JkaW5hdGVzKTtcclxuICAgICAgICAgICAgbWFwLmdldFZpZXcoKS5zZXRab29tKDE2KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBpZiAoZS5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcih0cmFucy5lcnJvcnMucHJvcGVydHlbNDA0XSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZS5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcih0cmFucy5lcnJvcnMucHJvcGVydHlbNTAzXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKHRyYW5zLmVycm9ycy5pbnRlcm5hbCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBjaG9vc2VCeUFyZWEoZHJhdykge1xyXG4gICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICAkKG1hcC5nZXRWaWV3cG9ydCgpKS5tb3VzZWxlYXZlKGZ1bmN0aW9uIGxlYXZlTWFwRm9yQXJlYVNlbGVjdGlvbihldmVudCkge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgICAkKG1hcC5nZXRWaWV3cG9ydCgpKS5tb3VzZWVudGVyKGZ1bmN0aW9uIGVudGVyTWFwRm9yQXJlYVNlbGVjdGlvbihldmVudCkge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgZHJhdy5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuICAgIGRyYXcub24oJ2RyYXdzdGFydCcsIGZ1bmN0aW9uIGRyYXdzdGFydCgpIHtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnc2VsZWN0JykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgIH0pO1xyXG4gICAgZHJhdy5vbignZHJhd2VuZCcsIGZ1bmN0aW9uIGRyYXdlbmQoZSkge1xyXG4gICAgICB2YXIgY29vcmRpbmF0ZXMgPSBlLmZlYXR1cmUuZ2V0R2VvbWV0cnkoKS5nZXRFeHRlbnQoKTtcclxuICAgICAgdmFyIHRyYW5zZm9ybWVkQ29vcmRpbmF0ZXMgPSBfLmNodW5rKGNvb3JkaW5hdGVzLCAyKS5tYXAoZnVuY3Rpb24gc3BsaXQoY3VycmVudFZhbHVlKSB7XHJcbiAgICAgICAgcmV0dXJuIG9sLnByb2oudHJhbnNmb3JtKGN1cnJlbnRWYWx1ZSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGJib3ggPSBfLmNvbmNhdCh0cmFuc2Zvcm1lZENvb3JkaW5hdGVzWzBdLCB0cmFuc2Zvcm1lZENvb3JkaW5hdGVzWzFdKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBpbml0KCkge1xyXG4gICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICB2YXIgZHJhd0ludGVyYWN0aW9uID0gbmV3IG9sLmludGVyYWN0aW9uLkRyYXcoe1xyXG4gICAgICBzb3VyY2U6IHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3NlbGVjdCcpLmdldFNvdXJjZSgpLFxyXG4gICAgICB0eXBlOiAnTGluZVN0cmluZycsXHJcbiAgICAgIGdlb21ldHJ5RnVuY3Rpb246IHV0aWxzLmdlb21ldHJ5RnVuY3Rpb24sXHJcbiAgICAgIG1heFBvaW50czogMlxyXG4gICAgICAvLyBjb25kaXRpb246IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgIC8vICAgcmV0dXJuIG9sLmV2ZW50cy5jb25kaXRpb24ucGxhdGZvcm1Nb2RpZmllcktleU9ubHkoZXZlbnQpO1xyXG4gICAgICAvLyB9XHJcbiAgICB9KTtcclxuICAgIGRyYXdJbnRlcmFjdGlvbi5zZXRQcm9wZXJ0aWVzKHtcclxuICAgICAgaWQ6ICdkcmF3J1xyXG4gICAgfSk7XHJcbiAgICBkcmF3SW50ZXJhY3Rpb24uc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICQoJyNjaGVja2JveC02JykuY2hhbmdlKGZ1bmN0aW9uIGVuYWJsZUFyZWFTZWxlY3Rpb24oKSB7XHJcbiAgICAgIGlmICh0aGlzLmNoZWNrZWQpIHtcclxuICAgICAgICBtYXAuYWRkSW50ZXJhY3Rpb24oZHJhd0ludGVyYWN0aW9uKTtcclxuICAgICAgICBBcHAuY29uZmlnLm1vZHVsZXMuaW5mby5kaXNhYmxlKCk7XHJcbiAgICAgICAgY2hvb3NlQnlBcmVhKGRyYXdJbnRlcmFjdGlvbik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgQXBwLmNvbmZpZy5tb2R1bGVzLmluZm8uaW5pdCgpO1xyXG4gICAgICAgIG1hcC5yZW1vdmVJbnRlcmFjdGlvbihkcmF3SW50ZXJhY3Rpb24pO1xyXG4gICAgICAgIGRyYXdJbnRlcmFjdGlvbi5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3NlbGVjdCcpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgYmJveCA9IGV4dGVudDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBhc3NpZ25WYWxpZGF0b3JzKCk7XHJcbiAgICAkKCcjaW52b2tlRmlsdGVycycpLmNsaWNrKGZ1bmN0aW9uIGludm9rZUZpbHRlcnMoZXZlbnQpIHtcclxuICAgICAgdmFyIG9wdGlvbnM7XHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICBvcHRpb25zID0gc2V0T3B0aW9ucygpO1xyXG4gICAgICBpZiAoJCgnZm9ybVtuYW1lPWZpbHRlcnNdJykucGFyc2xleSgpLnZhbGlkYXRlKCkpIHtcclxuICAgICAgICBnZXRSZXN1bHRzKG9wdGlvbnMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgICQoJyNjbGVhckZpbHRlcnMnKS5jbGljayhmdW5jdGlvbiBjbGVhckZpbHRlcnMoZXZlbnQpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgIGNsZWFyUmVzdWx0cyhtYXApO1xyXG4gICAgICAkKCdsYWJlbFtmb3I9b3B0aW9uLTFdJykuYWRkQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgJCgnI29wdGlvbi0xJykucHJvcCgnY2hlY2tlZCcsIHRydWUpO1xyXG4gICAgICAkKCdsYWJlbFtmb3I9b3B0aW9uLTJdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgJCgnI29wdGlvbi0yJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgJCgnLm1kbC1jaGVja2JveF9faW5wdXQnKS5lYWNoKGZ1bmN0aW9uIGNsZWFyQ2hlY2tib3hlcyhpbmRleCwgZWwpIHtcclxuICAgICAgICAkKGVsKS5wcm9wKCdjaGVja2VkJywgZmFsc2UpLnBhcmVudCgnbGFiZWwnKVxyXG4gICAgICAgIC5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnLm1kbC10ZXh0ZmllbGRfX2lucHV0JykuZWFjaChmdW5jdGlvbiBjbGVhcklucHV0cyhpbmRleCwgZWwpIHtcclxuICAgICAgICBpZiAoJChlbCkuYXR0cignaWQnKSAhPT0gJ2VzdGF0ZVR5cGUnKSB7XHJcbiAgICAgICAgICAkKGVsKS52YWwoJycpLnBhcmVudCgpXHJcbiAgICAgICAgICAuZXEoMClcclxuICAgICAgICAgIC5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJChlbCkuYXR0cignZGF0YS12YWwnLCAnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICAgICAgICAkKGVsKS52YWwoJ86UzrnOsc68zq3Pgc65z4POvM6xJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgaW5pdDogaW5pdFxyXG4gIH07XHJcbn0od2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgJCwgUGFyc2xleSwgbW9tZW50LCBBcHApKTtcclxuIiwidmFyIHVzZXJNYXAgPSAoZnVuY3Rpb24gdXNlck1hcCh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCBBcHApIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGNvbnRleHQgPSAnbWFwJztcclxuICB2YXIgbGFuZyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xyXG4gIHZhciAkbG9hZGluZyA9ICQoJy5tZGwtc3Bpbm5lcicpO1xyXG4gICQoZG9jdW1lbnQpXHJcbiAgLmFqYXhTdGFydChmdW5jdGlvbiBzdGFydCgpIHtcclxuICAgICQoJy5zcGluZXItd3JhcHBlcicpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgJGxvYWRpbmcuYWRkQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIH0pXHJcbiAgLmFqYXhTdG9wKGZ1bmN0aW9uIHN0b3AoKSB7XHJcbiAgICAkKCcuc3BpbmVyLXdyYXBwZXInKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICRsb2FkaW5nLnJlbW92ZUNsYXNzKCdpcy1hY3RpdmUnKTtcclxuICB9KTtcclxuICB0b2FzdHIub3B0aW9ucyA9IHtcclxuICAgIGNsb3NlQnV0dG9uOiBmYWxzZSxcclxuICAgIGRlYnVnOiBmYWxzZSxcclxuICAgIG5ld2VzdE9uVG9wOiBmYWxzZSxcclxuICAgIHByb2dyZXNzQmFyOiBmYWxzZSxcclxuICAgIHBvc2l0aW9uQ2xhc3M6ICd0b2FzdC10b3AtY2VudGVyJyxcclxuICAgIHByZXZlbnREdXBsaWNhdGVzOiBmYWxzZSxcclxuICAgIG9uY2xpY2s6IG51bGwsXHJcbiAgICBzaG93RHVyYXRpb246ICczMDAnLFxyXG4gICAgaGlkZUR1cmF0aW9uOiAnMTAwMCcsXHJcbiAgICB0aW1lT3V0OiAnNTAwMCcsXHJcbiAgICBleHRlbmRlZFRpbWVPdXQ6ICcxMDAwJyxcclxuICAgIHNob3dFYXNpbmc6ICdzd2luZycsXHJcbiAgICBoaWRlRWFzaW5nOiAnbGluZWFyJyxcclxuICAgIHNob3dNZXRob2Q6ICdmYWRlSW4nLFxyXG4gICAgaGlkZU1ldGhvZDogJ2ZhZGVPdXQnXHJcbiAgfTtcclxuXHJcbiAgZnVuY3Rpb24gaW5pdCgpIHtcclxuICAgIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvYXBpL2xhbmd1YWdlJyxcclxuICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICB0eXBlOiBsYW5nLFxyXG4gICAgICAgICAgY29udGV4dDogY29udGV4dFxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgIEFwcC5jb25maWcuY29tbW9ucy50cmFucyA9IGRhdGE7XHJcbiAgICAgIEFwcC5jb25maWcuY29tbW9ucy5tYXAgPSBBcHAuY29uZmlnLm1vZHVsZXMubWFwLmluaXRpYWxpemUoKTtcclxuICAgIH0pXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKCkge1xyXG4gICAgICBBcHAuY29uZmlnLm1vZHVsZXMuaW5mby5pbml0KCk7XHJcbiAgICAgIEFwcC5jb25maWcubW9kdWxlcy5maWx0ZXJzLmluaXQoKTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXQ6IGluaXRcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsIGpRdWVyeSwgQXBwKSk7XHJcblxyXG5cclxuLy8galF1ZXJ5KGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoJCkge1xyXG4vLyAgICQoJy5zcGlubmVyJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbi8vICAgJCgnLm1kbC1zcGlubmVyJykucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4vLyAgIC8vIGhhbmRsZVNlbGVjdCgpO1xyXG4vLyB9KTtcclxuXHJcbnVzZXJNYXAuaW5pdCgpO1xyXG4kKCcjYWR2YW5jZWQtZmlsdGVycycpLmNsaWNrKGZ1bmN0aW9uIHRvZ2dsZUZpbHRlcnMoKSB7XHJcbiAgJCgnI2VzdGF0ZS1maWx0ZXJzJykudG9nZ2xlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbn0pO1xyXG4vLyAkKCcjdG9nZ2xlLXByaWNlLXJhbmdlJykuY2xpY2soZnVuY3Rpb24gdG9nZ2xlUHJpY2VSYW5nZSgpIHtcclxuLy8gICAkKCcjcHJpY2UtcmFuZ2UnKS50b2dnbGVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuLy8gfSk7XHJcbiJdfQ==
