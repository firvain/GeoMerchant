var map1;
var bbox;
// var trans;
var dustBluebird = Promise.promisifyAll(dust);


var utils = {
  findById: function findById(map, id) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (id === layers.item(i).get('id')) {
        return layers.item(i);
      }
    }
    return null;
  },
  findByName: function findByName(map, name) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (name === layers.item(i).get('name')) {
        return layers.item(i);
      }
    }
    return null;
  },
  preventDotAndSpace: function preventDotAndSpace(e) {
    var key = e.charCode ? e.charCode : e.keyCode;
    this.innerHTML = key;
    if (key === 46 || key === 32) {
      return false;
    }
    return true;
  },
  geometryFunction: function geometryFunction(coordinates, geometry) {
    var geom;
    var start;
    var end;
    if (!geometry) {
      geom = new ol.geom.Polygon(null);
    } else {
      geom = geometry;
    }
    start = coordinates[0];
    end = coordinates[1];
    geom.setCoordinates([
      [
        start,
        [
          start[0], end[1]
        ],
        end,
        [
          end[0], start[1]
        ],
        start
      ]
    ]);
    return geom;
  }
};

var mymap = (function (window, document, undefined, Promise, ol, utils) {
  'use strict';
  var center = [3677385, 4120949];
  var extent = [3652772, 4112808, 3700000, 4132797];
  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });

  var mapStyles = {
    iconType: function iconType(estateType) {
      var type = {
        Apartment: function apartmentIcon() {
          return 'apartment';
        },
        'Detached House': function detachedHouceIcon() {
          return 'detached';
        },
        Villa: function villaIcon() {
          return 'villa';
        },
        Maisonette: function maisonetteIcon() {
          return 'villa';
        }
      };
      return (type[estateType])();
    },
    iconPath: function iconPath(listingType) {
      var path = {
        true: function saleIcon() {
          return './images/pins/sale/';
        },
        false: function rentIcon() {
          return './images/pins/rent/';
        }
      };
      return (path[listingType])();
    },
    estates: function estates(feature) {
      var src = mapStyles.iconPath(feature.get('sale')) +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        geometry: feature.getGeometry(),
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    },
    cluster: function cluster(feature) {
      var size = feature.get('features').length;
      var style;
      var originalFeature;
      if (size > 1) {
        style = [new ol.style.Style({
          image: new ol.style.Circle({
            radius: 20,
            stroke: new ol.style.Stroke({
              color: [156, 39, 176, 1],
              width: 5
            }),
            fill: new ol.style.Fill({
              color: [68, 138, 255, 0.8]
            })
          }),
          text: new ol.style.Text({
            text: size.toString(),
            fill: new ol.style.Fill({
              color: '#FFFFFF'
            })
          }),
          zIndex: 101
        })];
      } else {
        originalFeature = feature.get('features')[0];
        style = [mapStyles.estates(originalFeature)];
      }
      return style;
    },
    poi: function poi(feature) {
      var styleCache = {};
      var symbol = feature.get('style');
      var text;
      if (window.trans.lang === 'el') {
        text = feature.get('name_el');
      } else {
        text = feature.get('name_en');
      }
      if (!styleCache[symbol]) {
        styleCache = [new ol.style.Style({
          image: new ol.style.Icon(({
            src: '../images/maki/renders/' + symbol + '-24.png',
            anchorOrigin: 'bottom-left',
            anchor: [0.5, 0.5],
            scale: 1
          })),
          text: new ol.style.Text({
            text: text,
            stroke: new ol.style.Stroke({
              color: [156, 39, 176, 0.8],
              width: 1
            }),
            offsetY: 12
          })
        })];
      }
      return styleCache;
    },
    filteredEstates: function filteredEstates(feature) {
      var src = mapStyles.iconPath(feature.get('sale')) +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    }
  };


  var mapSources = {
    bing: function bing() {
      return new ol.source.BingMaps({
        key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
        imagerySet: 'AerialWithLabels'
      });
    },
    mapBox: function mapBox() {
      return new ol.source.XYZ({
        attributions: [new ol.Attribution({
          html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
        })],
        url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
      });
    },
    estates: function estates() {
      return new ol.source.Vector({
        format: geoJSONFormat,
        loader: function featreLoader() {
          var self = this;
          this.clear();
          $.ajax({
            url: 'http://127.0.0.1:3000/db/listed',
            type: 'GET',
            dataType: 'json'
          })
            .done(function succeded(response) {
              var features = geoJSONFormat.readFeatures(response, {
                featureProjection: 'EPSG:3857'
              });
              self.addFeatures(features);
            })
            .fail(function failed(jqXHR) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find any properties!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            });
        }
      });
    },
    cluster: function cluster() {
      return new ol.source.Cluster({
        distance: 40,
        source: mapSources.estates(),
        attributions: [new ol.Attribution({
          html: 'All maps © <a href="http://www.terracognita.gr/">Terra Cognita</a>'
        })]
      });
    },
    select: function select() {
      return new ol.source.Vector({});
    },
    poi: function poi() {
      return new ol.source.Vector({
        attributions: [new ol.Attribution({
          html: 'POI by <a href="http://www.terracognita.gr/">Terra Cognita</a>'
        })],
        format: geoJSONFormat
      });
    }
  };

  var mapLayers = {
    bing: function bing(trans) {
      return new ol.layer.Tile({
        visible: true,
        source: mapSources.bing(),
        maxZoom: 19,
        crossOrigin: 'anonymous',
        preload: Infinity,
        id: 'bing',
        name: trans.layers.bing
      });
    },
    mapBox: function mapBox(trans) {
      return new ol.layer.Tile({
        source: mapSources.mapBox(),
        id: 'mapbox',
        name: trans.layers.mapBox
      });
    },
    estates: function estates(trans) {
      return new ol.layer.Vector({
        source: mapSources.cluster(),
        id: 'estates',
        visible: true,
        style: mapStyles.cluster,
        zIndex: 2,
        name: trans.layers.estates
      });
    },
    poi: function poi(trans) {
      return new ol.layer.Vector({
        source: mapSources.poi(),
        style: mapStyles.poi,
        maxResolution: 3,
        zIndex: 1,
        id: 'poi'
      });
    },
    filteredEstates: function filteredEstates(trans) {
      return new ol.layer.Vector({
        source: new ol.source.Vector({
          format: geoJSONFormat
        }),
        id: 'filteredEstates',
        visible: true,
        style: mapStyles.filteredEstates,
        zIndex: 2
      });
    },
    select: function select() {
      return new ol.layer.Vector({
        source: mapSources.select(),
        style: new ol.style.Style({
          fill: new ol.style.Fill({
            color: 'rgba(227, 72, 27, 0.2)'
          }),
          stroke: new ol.style.Stroke({
            color: '#E3481B',
            width: 2
          }),
          image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
              color: '#E3481B'
            })
          })
        }),
        zIndex: 3,
        id: 'select'
      });
    }
  };
  var initialize = function initialize(trans) {
    var layers = Object.keys(mapLayers).map(function addMapLayers(key) {
      return mapLayers[key](trans);
    });
    return new ol.Map({
      target: 'map',
      layers: layers,
      loadTilesWhileAnimating: true,
      loadTilesWhileInteracting: true,
      renderer: 'canvas',
      controls: ol.control.defaults({
        attributionOptions: {
          collapsible: false,
          collapsed: false
        }
      })
       .extend([
         new ol.control.ScaleLine({
           units: 'metric'
         }), new ol.control.OverviewMap({
           className: 'ol-overviewmap ol-custom-overviewmap',
           collapsible: true,
           collapsed: true,
           layers: [mapLayers.bing(trans)]
         }),
         new ol.control.ZoomToExtent({
           extent: extent
         })
       ]),
      view: new ol.View({
        center: center,
        extent: extent,
        projection: 'EPSG:3857',
        zoom: 14,
        maxZoom: 19,
        minZoom: 14
      })
    });
  };
  return {
    initialize: initialize
  };
}(window, document, undefined, Promise, ol, utils));

var filters = (function filters(window, document, Promise, $, utils, Parsley) {
  'use strict';
  function addResults(data, map) {
    var geoJSONFormat = new ol.format.GeoJSON({
      defaultDataProjection: 'EPSG:4326'
    });
    var features = geoJSONFormat.readFeatures(data, {
      featureProjection: 'EPSG:3857'
    });
    utils.findById(map, 'filteredEstates').getSource().addFeatures(features);
    if (trans.lang === 'el') {
      toastr.info('Βρέθηκαν ' + features.length + ' ιδιοκτησίες!');
    } else {
      toastr.info('Found ' + features.length + ' estates!');
    }
  }
  function clearResults(map) {
    utils.findById(map, 'filteredEstates').getSource().clear();
  }
  function setOptions(map) {
    var filterData = {};
    filterData.estateType = $('#estateType').val();
    filterData.leaseType = $('input[name=options]:checked').val() !== undefined ? $('input[name=options]:checked').val() : 'Rent';
    filterData.startPrice = $('#startPrice').val() !== '' ? $('#startPrice').val() : 0;
    filterData.endPrice = $('#endPrice').val() !== '' ? $('#endPrice').val() : 2147483647;
    filterData.areaStart = $('#area-start').val() !== '' ? $('#area-start').val() : 0;
    filterData.areaEnd = $('#area-end').val() !== '' ? $('#area-end').val() : 2147483647;
    filterData.parking = $('#checkbox-1').prop('checked') !== undefined ? $('#checkbox-1').prop('checked') : false;
    filterData.furnished = $('#checkbox-2').prop('checked') !== undefined ? $('#checkbox-2').prop('checked') : false;
    filterData.heating = $('#checkbox-3').prop('checked') !== undefined ? $('#checkbox-3').prop('checked') : false;
    filterData.cooling = $('#checkbox-4').prop('checked') !== undefined ? $('#checkbox-4').prop('checked') : false;
    filterData.view = $('#checkbox-5').prop('checked') !== undefined ? $('#checkbox-5').prop('checked') : false;
    filterData.bbox = window.bbox !== undefined ? window.bbox : ol.proj.transform(utils.findById(map, 'estates').getSource().getExtent(), 'EPSG:3857', 'EPSG:4326');
    console.log(filterData);
    return filterData;
  }
  function getResults(options, map) {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/db/listed/filters',
        type: 'GET',
        dataType: 'json',
        data: options
      })
    )
    .then(function resolve(data) {
      utils.findById(map, 'estates').setVisible(false);
      utils.findById(map, 'poi').getSource().clear();
      clearResults(map);
      addResults(data, map);
    }).catch(function error(e) {
      if (e.status === 404) {
        toastr.error(trans.errors.property[404]);
      } else if (e.status === 503) {
        toastr.error(trans.errors.property[503]);
      } else {
        toastr.error(trans.errors.internal);
      }
    });
  }
  function chooseByArea(draw) {
    var map = draw.getMap();
    $(map.getViewport()).mouseleave(function leaveMapForAreaSelection(event) {
      event.preventDefault();
      event.stopPropagation();
      draw.setActive(false);
    });
    $(map.getViewport()).mouseenter(function enterMapForAreaSelection(event) {
      event.preventDefault();
      event.stopPropagation();
      draw.setActive(true);
    });
    draw.on('drawstart', function drawstart() {
      utils.findById(map, 'select').getSource().clear();
    });
    draw.on('drawend', function drawend(e) {
      var coordinates = e.feature.getGeometry().getExtent();
      var transformedCoordinates = _.chunk(coordinates, 2).map(function split(currentValue) {
        return ol.proj.transform(currentValue, 'EPSG:3857', 'EPSG:4326');
      });
      window.bbox = _.concat(transformedCoordinates[0], transformedCoordinates[1]);
    });
  }
  function init(map) {
    var drawInteraction = new ol.interaction.Draw({
      source: utils.findById(map, 'select').getSource(),
      type: 'LineString',
      geometryFunction: utils.geometryFunction,
      maxPoints: 2
    });
    drawInteraction.setProperties({
      id: 'draw'
    });
    drawInteraction.setActive(false);
    $('#checkbox-6').change(function enableAreaSelection() {
      if (this.checked) {
        map.addInteraction(drawInteraction);
        chooseByArea(drawInteraction);
      } else {
        map.removeInteraction(drawInteraction);
        drawInteraction.setActive(false);
        utils.findById(map, 'select').getSource().clear();
      }
    });
    $('#invokeFilters').click(function invokeFilters(event) {
      var options;
      event.preventDefault();
      event.stopPropagation();
      options = setOptions(map);
      if ($('form[name=filters]').parsley().validate()) {
        getResults(options, map);
      }
    });
    $('#clearFilters').click(function clearFilters(event) {
      event.preventDefault();
      event.stopPropagation();
      clearResults(map);
      $('label[for=option-1]').addClass('is-checked');
      $('#option-1').prop('checked', true);
      $('label[for=option-2]').removeClass('is-checked');
      $('#option-2').prop('checked', false);
      $('.mdl-checkbox__input').each(function clearCheckboxes(index, el) {
        $(el).prop('checked', false).parent('label')
        .removeClass('is-checked');
      });
      $('.mdl-textfield__input').each(function clearInputs(index, el) {
        if ($(el).attr('id') !== 'estateType') {
          $(el).val('').parent()
          .eq(0)
          .removeClass('is-dirty');
        } else {
          $(el).attr('data-val', 'Apartment');
          if (trans.lang === 'el') {
            $(el).val('Διαμέρισμα');
          } else {
            $('#estateType').val('Apartment');
          }
        }
      });
      utils.findById(map, 'estates').setVisible(true);
    });
  }
  return {
    init: init
  };
}(window, document, Promise, $, utils, Parsley));

var info = (function info(window, document, Promise, $, utils) {
  'use strict';
  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });
  function extraInfoModal(feature) {
    var modalPromise;
    var obj = {};
    if (feature.get('rent')) {
      obj.listing_type = trans.listing.rent;
    } else {
      obj.listing_type = trans.listing.sale;
    }
    obj.type = feature.get('estatetype');
    obj.gid = feature.get('gid');
    if (trans.lang === 'el') {
      obj.address = feature.get('street_el') + '' +  feature.get('street_number');
      obj.contact = {
        name: feature.getProperties().name_el,
        lastname: feature.getProperties().lastname_el
      };
    } else {
      obj.address = feature.get('street_en') + '' +  feature.get('street_number');
      obj.contact = {
        name: feature.getProperties().name_en,
        lastname: feature.getProperties().lastname_en
      };
    }
    obj.area = feature.get('estatearea');
    obj.bedrooms = feature.get('bedrooms');
    obj.price = feature.get('price');
    obj.title = {
      gid: trans.estate.gid,
      listing_type: trans.listing.type,
      address: trans.estate.address,
      area: trans.estate.area,
      bedrooms: trans.estate.amenities.bedrooms,
      price: trans.listing.price,
      isnew: trans.estate.amenities.isnew,
      parking: trans.estate.amenities.parking,
      furnished: trans.estate.amenities.furnished,
      pets: trans.estate.amenities.pets,
      view: trans.estate.amenities.view,
      heating: trans.estate.amenities.heating,
      cooling: trans.estate.amenities.cooling,
      contactInfo: trans.contact.contactInfo,
      name: trans.contact.name,
      lastname: trans.contact.lastname,
      phone: trans.contact.phone,
      email: trans.contact.email
    };
    obj.isnew = feature.get('isnew');
    obj.furnished = feature.get('furnished');
    obj.pets = feature.get('pets');
    obj.btns = {
      info: trans.btns.info,
      close: trans.btns.close
    };
    if (feature.getProperties().phone2 !== null) {
      obj.contact.phone = feature.getProperties().phone1 + ' ' + feature.getProperties().phone2;
    } else {
      obj.contact.phone = feature.getProperties().phone1;
    }
    obj.contact.email = feature.getProperties().email;

    modalPromise = dustBluebird.renderAsync('modalInfo', obj)
    .then(function resolve(data) {
      $('#modal').removeClass('visuallyhidden');
      $('.modal-content').html(data);
    })
    .then(function resolve() {
      $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + feature.get('gid') + '.jpg)');
      console.log(feature);
    })
    .catch(function error(e) {
      console.log(e);
    });
    $('#modal-close').click(function closeModal() {
      $('#modal').addClass('visuallyhidden');
    });
  }
  function renderEstateCards(feature) {
    var estateCardsPromise;
    var obj = {};
    if (feature.get('rent')) {
      obj.listing_type = trans.listing.rent;
    } else {
      obj.listing_type = trans.listing.sale;
    }
    obj.type = feature.get('estatetype');
    obj.gid = feature.get('gid');
    if (trans.lang === 'el') {
      obj.address = feature.get('street_el') + '' +  feature.get('street_number');
    } else {
      obj.address = feature.get('street_en') + '' +  feature.get('street_number');
    }
    obj.area = feature.get('estatearea');
    obj.bedrooms = feature.get('bedrooms');
    obj.price = feature.get('price');
    obj.title = {
      listing_type: trans.listing.type,
      address: trans.estate.address,
      area: trans.estate.area,
      bedrooms: trans.estate.amenities.bedrooms,
      price: trans.listing.price,
      isnew: trans.estate.amenities.isnew,
      furnished: trans.estate.amenities.furnished,
      pets: trans.estate.amenities.pets
    };
    obj.isnew = feature.get('isnew');
    obj.furnished = feature.get('furnished');
    obj.pets = feature.get('pets');
    obj.btns = {
      info: trans.btns.info,
      close: trans.btns.close
    };
    estateCardsPromise = dustBluebird.renderAsync('estateCards', obj)
    .then(function resolve(data) {
      $('.estate-cards').html(data);
    })
    .then(function resolve() {
      $('.mdl-card__title').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/w_432,c_scale/' + obj.gid + '.jpg)');
      $('.estate-cards').addClass('estate-cards-active');
      $('#estate-card-square-close').click(function close() {
        $('.estate-cards').removeClass('estate-cards-active');
      });
      $('#estate-card-square-extra-info').click(function extraInfo() {
        extraInfoModal(feature);
      });
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function selectFeature(evt) {
    var map = evt.map;
    // var coordinate = evt.coordinate;
    var f;
    var clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function findFeature(feature, layer) {
      return {
        feature: feature,
        layer: layer
      };
    }, this, function clickedFeatureLayerFilter(layer) {
      if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
        return true;
      }
      return false;
    }, this);
    if (clickedFeature) {
      if (clickedFeature.layer.get('id') === 'estates' &&
        clickedFeature.feature.get('features').length === 1) {
        f = clickedFeature.feature.getProperties().features[0];
        renderEstateCards(f);
        map.getView().setCenter(f.getGeometry().getCoordinates());
        map.getView().setZoom(16);
        Promise.resolve(
          $.ajax({
            url: 'http://127.0.0.1:3000/db/uses/' + f.getProperties().gid,
            type: 'GET',
            dataType: 'json'
          })
        )
        .then(function resolve(data) {
          var features;
          utils.findById(map, 'poi').getSource().clear();
          features = geoJSONFormat.readFeatures(data.property_services_analysis, {
            featureProjection: 'EPSG:3857'
          });
          features.forEach(function removePolygon(feature) {
            if (feature.getGeometry().getType() === 'Polygon') {
              features.splice(features.indexOf(feature), 1);
            }
          });
          utils.findById(map, 'poi').getSource().addFeatures(features);
          // map.getView().fit(utils.findById(map, 'poi').getSource().getExtent(), map.getSize());

          toastr.info('Found ' + features.length + ' Points of Interest in 8 minute distance!');
        })
        .catch(function error(e) {
          utils.findById(map, 'poi').getSource().clear();
          if (e.status === 404) {
            toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
          } else {
            console.log(e);
            toastr.error(e.responseText);
          }
        });
      } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
        f = clickedFeature.feature;
        renderEstateCards(f);
        Promise.resolve(
          $.ajax({
            url: 'http://127.0.0.1:3000/db/uses/' + f.getProperties().gid,
            type: 'GET',
            dataType: 'json'
          })
        )
        .then(function resolve(data) {
          var features;
          if (utils.findById(map, 'poi').getSource().getFeatures().length !== 0) {
            utils.findById(map, 'poi').getSource().clear();
          }
          features = geoJSONFormat.readFeatures(data.property_services_analysis, {
            featureProjection: 'EPSG:3857'
          });
          features.forEach(function removePolygon(feature) {
            if (feature.getGeometry().getType() === 'Polygon') {
              features.splice(features.indexOf(feature), 1);
            }
          });
          utils.findById(map, 'poi').getSource().addFeatures(features);
          map.getView().fit(utils.findById(map, 'poi').getSource().getExtent(), map.getSize());
          toastr.info('Found ' + features.length + ' Points of Interest in 8 minute distance!');
          console.log(trans);
        })
        .catch(function error(e) {
          if (e.status === 404) {
            toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
          } else {
            console.log(e);
            toastr.error(e.responseText);
          }
        });
      }
    } else {
      utils.findById(map, 'poi').getSource().clear();
    }
  }

  function init(map) {
    map.on('click', selectFeature);
  }
  function disable(map) {
    map.un('click', selectFeature);
  }
  return {
    init: init,
    disable: disable
  };
}(window, document, Promise, jQuery, utils));


// function handleInfo(evt) {
//   var coordinate = evt.coordinate;
//   var obj = {};
//   var title = {};
//   var owner = {};
//   var features = [];
//   var clickedFeature;
//   var f;

//   map.removeInteraction(draw);
//   evt.preventDefault();
//   obj.title = title;
//   if (lang === 'el') {
//     title.gid = 'Κωδικός Ιδιοκτησίας';
//     title.type = 'Είδος Ιδιοκτησίας';
//     title.listing_type = 'Τύπος Αγγελίας';
//     title.area = 'Εμβαδό';
//     title.address = 'Διευθυνση';
//     title.bedrooms = 'Υπνοδωμάτια';
//     title.price = 'Τιμή';
//     title.isnew = 'Νεόδμητο';
//     title.parking = 'Στάθμεση';
//     title.furnished = 'Επιπλωμένο';
//     title.pets = 'Κατοικίδια';
//     title.view = 'Θέα';
//     title.heating = 'Θέρμανση';
//     title.cooling = 'Ψύξη';
//     title.contactInfo = 'Στοιχεία Επικοινωνίας';
//     title.name = 'Όνομα';
//     title.lastname = 'Επίθετο';
//     title.phone = 'Τηλέφωνο';
//     title.email = 'Ηλεκτρονική Διεύθυνση';
//   } else {
//     title.gid = 'Estate Code';
//     title.type = 'Property Type';
//     title.listing_type = 'Listing Type';
//     title.area = 'Size';
//     title.address = 'Address';
//     title.bedrooms = 'Bedrooms';
//     title.price = 'Price';
//     title.isnew = 'Newly Build';
//     title.parking = 'Parking';
//     title.furnished = 'Furnished';
//     title.pets = 'Pets Allowed';
//     title.view = 'View';
//     title.heating = 'Heating';
//     title.cooling = 'Cooling';
//     title.contactInfo = 'Contact Info';
//     title.name = 'Name';
//     title.lastname = 'Last Name';
//     title.phone = 'Telephone';
//     title.email = 'Email';
//   }
//   clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
//     return {
//       feature: feature,
//       layer: layer
//     };
//   }, this, function (layer) {
//     if (layer.get('id') === 'estates' || layer.get('id') === 'filteredEstates') {
//       return true;
//     }
//     return false;
//   }, this);
//   if (clickedFeature) {
//     if (clickedFeature.layer.get('id') === 'estates' && clickedFeature.feature.get('features').length === 1) {
//       f = clickedFeature.feature.getProperties().features[0];
//       createPSAandCard(f, obj);
//     } else if (clickedFeature.layer.get('id') === 'filteredEstates') {
//       f = clickedFeature.feature;
//       createPSAandCard(f, obj);
//     }
//   } else {
//     PSA.setSource(null);
//   }
// }

// function createPSAandCard(f, obj) {
//   var feature = {};
  // feature.gid = f.get('gid');
  // feature.area = f.get('estatearea');
//   if (lang === 'el') {
//     feature.type = f.get('estatetype');
//     feature.address = f.get('street_el') + ' ' + f.get('street_number');
//     feature.name = f.get('name_el');
//     feature.lastname = f.get('lastname_el');
//     if (f.get('sale') === true) {
//       feature.listing_type = 'Πώληση';
//     } else {
//       feature.listing_type = 'Ενοικίαση';
//     }
//     feature.btns = {
//       info: 'πληροφοριες',
//       close: 'κλεισιμο'
//     };
//   } else {
//     feature.type = f.get('estatetype_en');
//     feature.address = f.get('street_en') + ' ' + f.get('street_number');
//     feature.name = f.get('name_en');
//     feature.lastname = f.get('lastname_en');
//     if (f.get('sale') === true) {
//       feature.listing_type = 'Sale';
//     } else {
//       feature.listing_type = 'Rent';
//     }
//     feature.btns = {
//       info: 'info',
//       close: 'close'
//     };
//   }
//   feature.bedrooms = f.get('bedrooms');
//   feature.price = f.get('price');
//   feature.isnew = f.get('isnew');
//   feature.parking = f.get('parking');
//   feature.furnished = f.get('furnished');
//   feature.pets = f.get('pets');
//   feature.view = f.get('view');
//   feature.heating = f.get('heating');
//   feature.cooling = f.get('cooling');
//   feature.phone = f.get('phone1');
//   feature.email = f.get('email');
//   feature.coordinate = f.get('geometry').getCoordinates();

//   var PSASource = new ol.source.Vector({
//     attributions: [new ol.Attribution({
//       html: 'POI by ' + '<a href="http://www.terracognita.gr/">Terra Cognita</a>'
//     })],
//     format: geoJSONFormat,
//     loader: function (extent, resolution, projection) {
//       var url = 'http://127.0.0.1:3000/db/uses/' + feature.gid;
//       var self = this;
//       $.ajax({
//         url: url,
//         type: 'GET',
//         dataType: 'json'
//       }).done(function succeded(data, textStatus, jqXHR) {
        // var features = geoJSONFormat.readFeatures(data.property_services_analysis, {
        //   featureProjection: 'EPSG:3857'
        // });
        // var featuresLength = features.length - 1;
        // var area = new ol.style.Style({
        //   fill: new ol.style.Fill({
        //     color: [156, 39, 176, 0.1]
        //   })
        // });
        // features[0].setStyle(area);
        // self.addFeatures(features);
//         toastr.clear();
//         toastr.info('Found ' + featuresLength + ' Points of Interest in 8 minute distance!');
//       }).fail(function failed(jqXHR) {
//         toastr.clear();
//         if (jqXHR.status === 404) {
//           toastr.error('Sorry, we cannot find any Points of Interest in 8 minute distance!');
//         } else if (jqXHR.status === 503) {
//           toastr.error('Service Unavailable');
//         } else {
//           toastr.error('Internal Server Error');
//         }
//       });
//     },
//     strategy: ol.loadingstrategy.all
//   });
//   PSA.setSource(PSASource);
//   map.getView().setCenter(feature.coordinate);
//   map.getView().setResolution(1.2);
//   obj.feature = feature;

//   dust.render('estateCards', obj, function renderEstateCards(err, out) {
//     $('.estate-cards').html(out);
//     $('.mdl-card__title').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/w_432,c_scale/' + obj.feature.gid + '.jpg)');
//     $('.estate-cards').addClass('estate-cards-active');
//   // $("#infobox").addClass("visuallyhidden");
//   });
//   $('a[href="#openModal"]').click(function () {
//     dust.render('modalInfo', obj, function renderModalInfo(err, out) {
//       $('.modal-content').html(out);
//       $('.big-image').css('background-image', 'url(http://res.cloudinary.com/firvain/image/upload/h_222,c_scale/' + obj.feature.gid + '.jpg)');
//     });
//   });
//   $('a[href="#closeEstateCard"]').click(function () {
//     $('.estate-cards').removeClass('estate-cards-active');
//   });
// }
// $('#information').on('click', function (e) {
//   // PSA.setSource(null);
//   if ($(this).prop('checked') === true) {
//     map.on('click', selectedFeature);
//     // $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', true);});
//   } else {
//     map.un('click', selectedFeature);
//     // $(this).parent().siblings().find('input').each(function () {$(this).prop('disabled', false);});
//   }
// });

var trans;
var userMap = (function userMap(window, document, Promise, $, mymap, info, filters) {
  'use strict';
  var context = 'map';
  var lang = document.documentElement.lang;
  // var globals = {};
  var $loading = $('.mdl-spinner');
  $(document)
  .ajaxStart(function start() {
    $loading.addClass('is-active');
  })
  .ajaxStop(function stop() {
    $loading.removeClass('is-active');
  });
  toastr.options = {
    closeButton: false,
    debug: false,
    newestOnTop: false,
    progressBar: false,
    positionClass: 'toast-top-center',
    preventDuplicates: false,
    onclick: null,
    showDuration: '300',
    hideDuration: '1000',
    timeOut: '5000',
    extendedTimeOut: '1000',
    showEasing: 'swing',
    hideEasing: 'linear',
    showMethod: 'fadeIn',
    hideMethod: 'fadeOut'
  };

  function init() {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/language',
        type: 'GET',
        data: {
          type: lang,
          context: context
        }
      })
      )
      .then(function resolve(data) {
        var map;
        trans = data;
        map = mymap.initialize(trans);
        map1 = map;
        return map;
      })
      .then(function resolve(map) {
        info.init(map);
        filters.init(map);
      })
      .catch(function error(e) {
        console.log(e);
      });
  }

  return {
    init: init
  };
}(window, document, Promise, jQuery, mymap, info, filters));


// jQuery(document).ready(function ($) {
//   $('.spinner').addClass('visuallyhidden');
//   $('.mdl-spinner').removeClass('is-active');
//   // handleSelect();
// });

userMap.init();
$('#advanced-filters').click(function toggleFilters() {
  $('#estate-filters').toggleClass('visuallyhidden');
});
// $('#toggle-price-range').click(function togglePriceRange() {
//   $('#price-range').toggleClass('visuallyhidden');
// });

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdsb2JhbHMuanMiLCJ0cmFuc2xhdGlvbi5qcyIsInV0aWxzLmpzIiwib2wzLW1hcC5qcyIsImZpbHRlcnMuanMiLCJpbmZvLmpzIiwiaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ0pBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbFRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcGJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im1hcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgbWFwMTtcclxudmFyIGJib3g7XHJcbi8vIHZhciB0cmFucztcclxudmFyIGR1c3RCbHVlYmlyZCA9IFByb21pc2UucHJvbWlzaWZ5QWxsKGR1c3QpO1xyXG4iLCIiLCJ2YXIgdXRpbHMgPSB7XHJcbiAgZmluZEJ5SWQ6IGZ1bmN0aW9uIGZpbmRCeUlkKG1hcCwgaWQpIHtcclxuICAgIHZhciBsYXllcnMgPSBtYXAuZ2V0TGF5ZXJzKCk7XHJcbiAgICB2YXIgbGVuZ3RoID0gbGF5ZXJzLmdldExlbmd0aCgpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAoaWQgPT09IGxheWVycy5pdGVtKGkpLmdldCgnaWQnKSkge1xyXG4gICAgICAgIHJldHVybiBsYXllcnMuaXRlbShpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfSxcclxuICBmaW5kQnlOYW1lOiBmdW5jdGlvbiBmaW5kQnlOYW1lKG1hcCwgbmFtZSkge1xyXG4gICAgdmFyIGxheWVycyA9IG1hcC5nZXRMYXllcnMoKTtcclxuICAgIHZhciBsZW5ndGggPSBsYXllcnMuZ2V0TGVuZ3RoKCk7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGlmIChuYW1lID09PSBsYXllcnMuaXRlbShpKS5nZXQoJ25hbWUnKSkge1xyXG4gICAgICAgIHJldHVybiBsYXllcnMuaXRlbShpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfSxcclxuICBwcmV2ZW50RG90QW5kU3BhY2U6IGZ1bmN0aW9uIHByZXZlbnREb3RBbmRTcGFjZShlKSB7XHJcbiAgICB2YXIga2V5ID0gZS5jaGFyQ29kZSA/IGUuY2hhckNvZGUgOiBlLmtleUNvZGU7XHJcbiAgICB0aGlzLmlubmVySFRNTCA9IGtleTtcclxuICAgIGlmIChrZXkgPT09IDQ2IHx8IGtleSA9PT0gMzIpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfSxcclxuICBnZW9tZXRyeUZ1bmN0aW9uOiBmdW5jdGlvbiBnZW9tZXRyeUZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBnZW9tZXRyeSkge1xyXG4gICAgdmFyIGdlb207XHJcbiAgICB2YXIgc3RhcnQ7XHJcbiAgICB2YXIgZW5kO1xyXG4gICAgaWYgKCFnZW9tZXRyeSkge1xyXG4gICAgICBnZW9tID0gbmV3IG9sLmdlb20uUG9seWdvbihudWxsKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGdlb20gPSBnZW9tZXRyeTtcclxuICAgIH1cclxuICAgIHN0YXJ0ID0gY29vcmRpbmF0ZXNbMF07XHJcbiAgICBlbmQgPSBjb29yZGluYXRlc1sxXTtcclxuICAgIGdlb20uc2V0Q29vcmRpbmF0ZXMoW1xyXG4gICAgICBbXHJcbiAgICAgICAgc3RhcnQsXHJcbiAgICAgICAgW1xyXG4gICAgICAgICAgc3RhcnRbMF0sIGVuZFsxXVxyXG4gICAgICAgIF0sXHJcbiAgICAgICAgZW5kLFxyXG4gICAgICAgIFtcclxuICAgICAgICAgIGVuZFswXSwgc3RhcnRbMV1cclxuICAgICAgICBdLFxyXG4gICAgICAgIHN0YXJ0XHJcbiAgICAgIF1cclxuICAgIF0pO1xyXG4gICAgcmV0dXJuIGdlb207XHJcbiAgfVxyXG59O1xyXG4iLCJ2YXIgbXltYXAgPSAoZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCwgUHJvbWlzZSwgb2wsIHV0aWxzKSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG4gIHZhciBjZW50ZXIgPSBbMzY3NzM4NSwgNDEyMDk0OV07XHJcbiAgdmFyIGV4dGVudCA9IFszNjUyNzcyLCA0MTEyODA4LCAzNzAwMDAwLCA0MTMyNzk3XTtcclxuICB2YXIgZ2VvSlNPTkZvcm1hdCA9IG5ldyBvbC5mb3JtYXQuR2VvSlNPTih7XHJcbiAgICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbiAgfSk7XHJcblxyXG4gIHZhciBtYXBTdHlsZXMgPSB7XHJcbiAgICBpY29uVHlwZTogZnVuY3Rpb24gaWNvblR5cGUoZXN0YXRlVHlwZSkge1xyXG4gICAgICB2YXIgdHlwZSA9IHtcclxuICAgICAgICBBcGFydG1lbnQ6IGZ1bmN0aW9uIGFwYXJ0bWVudEljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ2FwYXJ0bWVudCc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAnRGV0YWNoZWQgSG91c2UnOiBmdW5jdGlvbiBkZXRhY2hlZEhvdWNlSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAnZGV0YWNoZWQnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgVmlsbGE6IGZ1bmN0aW9uIHZpbGxhSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgTWFpc29uZXR0ZTogZnVuY3Rpb24gbWFpc29uZXR0ZUljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ3ZpbGxhJztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiAodHlwZVtlc3RhdGVUeXBlXSkoKTtcclxuICAgIH0sXHJcbiAgICBpY29uUGF0aDogZnVuY3Rpb24gaWNvblBhdGgobGlzdGluZ1R5cGUpIHtcclxuICAgICAgdmFyIHBhdGggPSB7XHJcbiAgICAgICAgdHJ1ZTogZnVuY3Rpb24gc2FsZUljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvc2FsZS8nO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZmFsc2U6IGZ1bmN0aW9uIHJlbnRJY29uKCkge1xyXG4gICAgICAgICAgcmV0dXJuICcuL2ltYWdlcy9waW5zL3JlbnQvJztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiAocGF0aFtsaXN0aW5nVHlwZV0pKCk7XHJcbiAgICB9LFxyXG4gICAgZXN0YXRlczogZnVuY3Rpb24gZXN0YXRlcyhmZWF0dXJlKSB7XHJcbiAgICAgIHZhciBzcmMgPSBtYXBTdHlsZXMuaWNvblBhdGgoZmVhdHVyZS5nZXQoJ3NhbGUnKSkgK1xyXG4gICAgICBtYXBTdHlsZXMuaWNvblR5cGUoZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGVfZW4nKSkgKyAnLTQ4LnBuZyc7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICAgIGdlb21ldHJ5OiBmZWF0dXJlLmdldEdlb21ldHJ5KCksXHJcbiAgICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgICAgICBzcmM6IHNyYyxcclxuICAgICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgICAgICBzY2FsZTogMVxyXG4gICAgICAgIH0pKVxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBjbHVzdGVyOiBmdW5jdGlvbiBjbHVzdGVyKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHNpemUgPSBmZWF0dXJlLmdldCgnZmVhdHVyZXMnKS5sZW5ndGg7XHJcbiAgICAgIHZhciBzdHlsZTtcclxuICAgICAgdmFyIG9yaWdpbmFsRmVhdHVyZTtcclxuICAgICAgaWYgKHNpemUgPiAxKSB7XHJcbiAgICAgICAgc3R5bGUgPSBbbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuQ2lyY2xlKHtcclxuICAgICAgICAgICAgcmFkaXVzOiAyMCxcclxuICAgICAgICAgICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHtcclxuICAgICAgICAgICAgICBjb2xvcjogWzE1NiwgMzksIDE3NiwgMV0sXHJcbiAgICAgICAgICAgICAgd2lkdGg6IDVcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAgICAgICBjb2xvcjogWzY4LCAxMzgsIDI1NSwgMC44XVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICB0ZXh0OiBuZXcgb2wuc3R5bGUuVGV4dCh7XHJcbiAgICAgICAgICAgIHRleHQ6IHNpemUudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiAnI0ZGRkZGRidcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgekluZGV4OiAxMDFcclxuICAgICAgICB9KV07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgb3JpZ2luYWxGZWF0dXJlID0gZmVhdHVyZS5nZXQoJ2ZlYXR1cmVzJylbMF07XHJcbiAgICAgICAgc3R5bGUgPSBbbWFwU3R5bGVzLmVzdGF0ZXMob3JpZ2luYWxGZWF0dXJlKV07XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHN0eWxlO1xyXG4gICAgfSxcclxuICAgIHBvaTogZnVuY3Rpb24gcG9pKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHN0eWxlQ2FjaGUgPSB7fTtcclxuICAgICAgdmFyIHN5bWJvbCA9IGZlYXR1cmUuZ2V0KCdzdHlsZScpO1xyXG4gICAgICB2YXIgdGV4dDtcclxuICAgICAgaWYgKHdpbmRvdy50cmFucy5sYW5nID09PSAnZWwnKSB7XHJcbiAgICAgICAgdGV4dCA9IGZlYXR1cmUuZ2V0KCduYW1lX2VsJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGV4dCA9IGZlYXR1cmUuZ2V0KCduYW1lX2VuJyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCFzdHlsZUNhY2hlW3N5bWJvbF0pIHtcclxuICAgICAgICBzdHlsZUNhY2hlID0gW25ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICAgICAgc3JjOiAnLi4vaW1hZ2VzL21ha2kvcmVuZGVycy8nICsgc3ltYm9sICsgJy0yNC5wbmcnLFxyXG4gICAgICAgICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgICAgICAgIGFuY2hvcjogWzAuNSwgMC41XSxcclxuICAgICAgICAgICAgc2NhbGU6IDFcclxuICAgICAgICAgIH0pKSxcclxuICAgICAgICAgIHRleHQ6IG5ldyBvbC5zdHlsZS5UZXh0KHtcclxuICAgICAgICAgICAgdGV4dDogdGV4dCxcclxuICAgICAgICAgICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHtcclxuICAgICAgICAgICAgICBjb2xvcjogWzE1NiwgMzksIDE3NiwgMC44XSxcclxuICAgICAgICAgICAgICB3aWR0aDogMVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgb2Zmc2V0WTogMTJcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfSldO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBzdHlsZUNhY2hlO1xyXG4gICAgfSxcclxuICAgIGZpbHRlcmVkRXN0YXRlczogZnVuY3Rpb24gZmlsdGVyZWRFc3RhdGVzKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHNyYyA9IG1hcFN0eWxlcy5pY29uUGF0aChmZWF0dXJlLmdldCgnc2FsZScpKSArXHJcbiAgICAgIG1hcFN0eWxlcy5pY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNDgucG5nJztcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgICAgICBzcmM6IHNyYyxcclxuICAgICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgICAgICBzY2FsZTogMVxyXG4gICAgICAgIH0pKVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuXHJcbiAgdmFyIG1hcFNvdXJjZXMgPSB7XHJcbiAgICBiaW5nOiBmdW5jdGlvbiBiaW5nKCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5CaW5nTWFwcyh7XHJcbiAgICAgICAga2V5OiAnQWsyR3E4VlVmSUNzUHB1ZjdMUkFOWG1YdDJzSFdtU0xQaG9obVZMRnRGSUV3WWpzXzVNQ3lBaEFGd1JTVnBMaicsXHJcbiAgICAgICAgaW1hZ2VyeVNldDogJ0FlcmlhbFdpdGhMYWJlbHMnXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIG1hcEJveDogZnVuY3Rpb24gbWFwQm94KCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5YWVooe1xyXG4gICAgICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgICAgICBodG1sOiAnPGEgaHJlZj1cImh0dHBzOi8vd3d3Lm1hcGJveC5jb20vYWJvdXQvbWFwcy9cIiB0YXJnZXQ9XCJfYmxhbmtcIj4mY29weTsgTWFwYm94ICZjb3B5OyBPcGVuU3RyZWV0TWFwPC9hPidcclxuICAgICAgICB9KV0sXHJcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9hcGkubWFwYm94LmNvbS92NC9tYXBib3guc3RyZWV0cy97en0ve3h9L3t5fS5wbmc/YWNjZXNzX3Rva2VuPXBrLmV5SjFJam9pWm1seWRtRnBiaUlzSW1FaU9pSmxPV1l5WVRNME5UaGlOV00wWWpKak9ESmpOREU0T0RRek56QTJNR1F5TmlKOS4tTlZETzI3SHp0LXdfblFvc1VQZkxBJ1xyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBlc3RhdGVzOiBmdW5jdGlvbiBlc3RhdGVzKCkge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gICAgICAgIGZvcm1hdDogZ2VvSlNPTkZvcm1hdCxcclxuICAgICAgICBsb2FkZXI6IGZ1bmN0aW9uIGZlYXRyZUxvYWRlcigpIHtcclxuICAgICAgICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgICAgICAgIHRoaXMuY2xlYXIoKTtcclxuICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9saXN0ZWQnLFxyXG4gICAgICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJ1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmRvbmUoZnVuY3Rpb24gc3VjY2VkZWQocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhyZXNwb25zZSwge1xyXG4gICAgICAgICAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgc2VsZi5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUikge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IHByb3BlcnRpZXMhJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGNsdXN0ZXI6IGZ1bmN0aW9uIGNsdXN0ZXIoKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wuc291cmNlLkNsdXN0ZXIoe1xyXG4gICAgICAgIGRpc3RhbmNlOiA0MCxcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuZXN0YXRlcygpLFxyXG4gICAgICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgICAgICBodG1sOiAnQWxsIG1hcHMgwqkgPGEgaHJlZj1cImh0dHA6Ly93d3cudGVycmFjb2duaXRhLmdyL1wiPlRlcnJhIENvZ25pdGE8L2E+J1xyXG4gICAgICAgIH0pXVxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBzZWxlY3Q6IGZ1bmN0aW9uIHNlbGVjdCgpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuVmVjdG9yKHt9KTtcclxuICAgIH0sXHJcbiAgICBwb2k6IGZ1bmN0aW9uIHBvaSgpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuICAgICAgICBhdHRyaWJ1dGlvbnM6IFtuZXcgb2wuQXR0cmlidXRpb24oe1xyXG4gICAgICAgICAgaHRtbDogJ1BPSSBieSA8YSBocmVmPVwiaHR0cDovL3d3dy50ZXJyYWNvZ25pdGEuZ3IvXCI+VGVycmEgQ29nbml0YTwvYT4nXHJcbiAgICAgICAgfSldLFxyXG4gICAgICAgIGZvcm1hdDogZ2VvSlNPTkZvcm1hdFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICB2YXIgbWFwTGF5ZXJzID0ge1xyXG4gICAgYmluZzogZnVuY3Rpb24gYmluZyh0cmFucykge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gICAgICAgIHZpc2libGU6IHRydWUsXHJcbiAgICAgICAgc291cmNlOiBtYXBTb3VyY2VzLmJpbmcoKSxcclxuICAgICAgICBtYXhab29tOiAxOSxcclxuICAgICAgICBjcm9zc09yaWdpbjogJ2Fub255bW91cycsXHJcbiAgICAgICAgcHJlbG9hZDogSW5maW5pdHksXHJcbiAgICAgICAgaWQ6ICdiaW5nJyxcclxuICAgICAgICBuYW1lOiB0cmFucy5sYXllcnMuYmluZ1xyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBtYXBCb3g6IGZ1bmN0aW9uIG1hcEJveCh0cmFucykge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5tYXBCb3goKSxcclxuICAgICAgICBpZDogJ21hcGJveCcsXHJcbiAgICAgICAgbmFtZTogdHJhbnMubGF5ZXJzLm1hcEJveFxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBlc3RhdGVzOiBmdW5jdGlvbiBlc3RhdGVzKHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuY2x1c3RlcigpLFxyXG4gICAgICAgIGlkOiAnZXN0YXRlcycsXHJcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcclxuICAgICAgICBzdHlsZTogbWFwU3R5bGVzLmNsdXN0ZXIsXHJcbiAgICAgICAgekluZGV4OiAyLFxyXG4gICAgICAgIG5hbWU6IHRyYW5zLmxheWVycy5lc3RhdGVzXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIHBvaTogZnVuY3Rpb24gcG9pKHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMucG9pKCksXHJcbiAgICAgICAgc3R5bGU6IG1hcFN0eWxlcy5wb2ksXHJcbiAgICAgICAgbWF4UmVzb2x1dGlvbjogMyxcclxuICAgICAgICB6SW5kZXg6IDEsXHJcbiAgICAgICAgaWQ6ICdwb2knXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGZpbHRlcmVkRXN0YXRlczogZnVuY3Rpb24gZmlsdGVyZWRFc3RhdGVzKHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICAgICAgICBzb3VyY2U6IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuICAgICAgICAgIGZvcm1hdDogZ2VvSlNPTkZvcm1hdFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIGlkOiAnZmlsdGVyZWRFc3RhdGVzJyxcclxuICAgICAgICB2aXNpYmxlOiB0cnVlLFxyXG4gICAgICAgIHN0eWxlOiBtYXBTdHlsZXMuZmlsdGVyZWRFc3RhdGVzLFxyXG4gICAgICAgIHpJbmRleDogMlxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBzZWxlY3Q6IGZ1bmN0aW9uIHNlbGVjdCgpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gICAgICAgIHNvdXJjZTogbWFwU291cmNlcy5zZWxlY3QoKSxcclxuICAgICAgICBzdHlsZTogbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAgICAgY29sb3I6ICdyZ2JhKDIyNywgNzIsIDI3LCAwLjIpJ1xyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICBzdHJva2U6IG5ldyBvbC5zdHlsZS5TdHJva2Uoe1xyXG4gICAgICAgICAgICBjb2xvcjogJyNFMzQ4MUInLFxyXG4gICAgICAgICAgICB3aWR0aDogMlxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkNpcmNsZSh7XHJcbiAgICAgICAgICAgIHJhZGl1czogNyxcclxuICAgICAgICAgICAgZmlsbDogbmV3IG9sLnN0eWxlLkZpbGwoe1xyXG4gICAgICAgICAgICAgIGNvbG9yOiAnI0UzNDgxQidcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgekluZGV4OiAzLFxyXG4gICAgICAgIGlkOiAnc2VsZWN0J1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9O1xyXG4gIHZhciBpbml0aWFsaXplID0gZnVuY3Rpb24gaW5pdGlhbGl6ZSh0cmFucykge1xyXG4gICAgdmFyIGxheWVycyA9IE9iamVjdC5rZXlzKG1hcExheWVycykubWFwKGZ1bmN0aW9uIGFkZE1hcExheWVycyhrZXkpIHtcclxuICAgICAgcmV0dXJuIG1hcExheWVyc1trZXldKHRyYW5zKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG5ldyBvbC5NYXAoe1xyXG4gICAgICB0YXJnZXQ6ICdtYXAnLFxyXG4gICAgICBsYXllcnM6IGxheWVycyxcclxuICAgICAgbG9hZFRpbGVzV2hpbGVBbmltYXRpbmc6IHRydWUsXHJcbiAgICAgIGxvYWRUaWxlc1doaWxlSW50ZXJhY3Rpbmc6IHRydWUsXHJcbiAgICAgIHJlbmRlcmVyOiAnY2FudmFzJyxcclxuICAgICAgY29udHJvbHM6IG9sLmNvbnRyb2wuZGVmYXVsdHMoe1xyXG4gICAgICAgIGF0dHJpYnV0aW9uT3B0aW9uczoge1xyXG4gICAgICAgICAgY29sbGFwc2libGU6IGZhbHNlLFxyXG4gICAgICAgICAgY29sbGFwc2VkOiBmYWxzZVxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgIC5leHRlbmQoW1xyXG4gICAgICAgICBuZXcgb2wuY29udHJvbC5TY2FsZUxpbmUoe1xyXG4gICAgICAgICAgIHVuaXRzOiAnbWV0cmljJ1xyXG4gICAgICAgICB9KSwgbmV3IG9sLmNvbnRyb2wuT3ZlcnZpZXdNYXAoe1xyXG4gICAgICAgICAgIGNsYXNzTmFtZTogJ29sLW92ZXJ2aWV3bWFwIG9sLWN1c3RvbS1vdmVydmlld21hcCcsXHJcbiAgICAgICAgICAgY29sbGFwc2libGU6IHRydWUsXHJcbiAgICAgICAgICAgY29sbGFwc2VkOiB0cnVlLFxyXG4gICAgICAgICAgIGxheWVyczogW21hcExheWVycy5iaW5nKHRyYW5zKV1cclxuICAgICAgICAgfSksXHJcbiAgICAgICAgIG5ldyBvbC5jb250cm9sLlpvb21Ub0V4dGVudCh7XHJcbiAgICAgICAgICAgZXh0ZW50OiBleHRlbnRcclxuICAgICAgICAgfSlcclxuICAgICAgIF0pLFxyXG4gICAgICB2aWV3OiBuZXcgb2wuVmlldyh7XHJcbiAgICAgICAgY2VudGVyOiBjZW50ZXIsXHJcbiAgICAgICAgZXh0ZW50OiBleHRlbnQsXHJcbiAgICAgICAgcHJvamVjdGlvbjogJ0VQU0c6Mzg1NycsXHJcbiAgICAgICAgem9vbTogMTQsXHJcbiAgICAgICAgbWF4Wm9vbTogMTksXHJcbiAgICAgICAgbWluWm9vbTogMTRcclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH07XHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXRpYWxpemU6IGluaXRpYWxpemVcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCwgUHJvbWlzZSwgb2wsIHV0aWxzKSk7XHJcbiIsInZhciBmaWx0ZXJzID0gKGZ1bmN0aW9uIGZpbHRlcnMod2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgJCwgdXRpbHMsIFBhcnNsZXkpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgZnVuY3Rpb24gYWRkUmVzdWx0cyhkYXRhLCBtYXApIHtcclxuICAgIHZhciBnZW9KU09ORm9ybWF0ID0gbmV3IG9sLmZvcm1hdC5HZW9KU09OKHtcclxuICAgICAgZGVmYXVsdERhdGFQcm9qZWN0aW9uOiAnRVBTRzo0MzI2J1xyXG4gICAgfSk7XHJcbiAgICB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLCB7XHJcbiAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgfSk7XHJcbiAgICB1dGlscy5maW5kQnlJZChtYXAsICdmaWx0ZXJlZEVzdGF0ZXMnKS5nZXRTb3VyY2UoKS5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbiAgICBpZiAodHJhbnMubGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICB0b2FzdHIuaW5mbygnzpLPgc6tzrjOt866zrHOvSAnICsgZmVhdHVyZXMubGVuZ3RoICsgJyDOuc60zrnOv866z4TOt8+Dzq/Otc+CIScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlcy5sZW5ndGggKyAnIGVzdGF0ZXMhJyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGNsZWFyUmVzdWx0cyhtYXApIHtcclxuICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ2ZpbHRlcmVkRXN0YXRlcycpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHNldE9wdGlvbnMobWFwKSB7XHJcbiAgICB2YXIgZmlsdGVyRGF0YSA9IHt9O1xyXG4gICAgZmlsdGVyRGF0YS5lc3RhdGVUeXBlID0gJCgnI2VzdGF0ZVR5cGUnKS52YWwoKTtcclxuICAgIGZpbHRlckRhdGEubGVhc2VUeXBlID0gJCgnaW5wdXRbbmFtZT1vcHRpb25zXTpjaGVja2VkJykudmFsKCkgIT09IHVuZGVmaW5lZCA/ICQoJ2lucHV0W25hbWU9b3B0aW9uc106Y2hlY2tlZCcpLnZhbCgpIDogJ1JlbnQnO1xyXG4gICAgZmlsdGVyRGF0YS5zdGFydFByaWNlID0gJCgnI3N0YXJ0UHJpY2UnKS52YWwoKSAhPT0gJycgPyAkKCcjc3RhcnRQcmljZScpLnZhbCgpIDogMDtcclxuICAgIGZpbHRlckRhdGEuZW5kUHJpY2UgPSAkKCcjZW5kUHJpY2UnKS52YWwoKSAhPT0gJycgPyAkKCcjZW5kUHJpY2UnKS52YWwoKSA6IDIxNDc0ODM2NDc7XHJcbiAgICBmaWx0ZXJEYXRhLmFyZWFTdGFydCA9ICQoJyNhcmVhLXN0YXJ0JykudmFsKCkgIT09ICcnID8gJCgnI2FyZWEtc3RhcnQnKS52YWwoKSA6IDA7XHJcbiAgICBmaWx0ZXJEYXRhLmFyZWFFbmQgPSAkKCcjYXJlYS1lbmQnKS52YWwoKSAhPT0gJycgPyAkKCcjYXJlYS1lbmQnKS52YWwoKSA6IDIxNDc0ODM2NDc7XHJcbiAgICBmaWx0ZXJEYXRhLnBhcmtpbmcgPSAkKCcjY2hlY2tib3gtMScpLnByb3AoJ2NoZWNrZWQnKSAhPT0gdW5kZWZpbmVkID8gJCgnI2NoZWNrYm94LTEnKS5wcm9wKCdjaGVja2VkJykgOiBmYWxzZTtcclxuICAgIGZpbHRlckRhdGEuZnVybmlzaGVkID0gJCgnI2NoZWNrYm94LTInKS5wcm9wKCdjaGVja2VkJykgIT09IHVuZGVmaW5lZCA/ICQoJyNjaGVja2JveC0yJykucHJvcCgnY2hlY2tlZCcpIDogZmFsc2U7XHJcbiAgICBmaWx0ZXJEYXRhLmhlYXRpbmcgPSAkKCcjY2hlY2tib3gtMycpLnByb3AoJ2NoZWNrZWQnKSAhPT0gdW5kZWZpbmVkID8gJCgnI2NoZWNrYm94LTMnKS5wcm9wKCdjaGVja2VkJykgOiBmYWxzZTtcclxuICAgIGZpbHRlckRhdGEuY29vbGluZyA9ICQoJyNjaGVja2JveC00JykucHJvcCgnY2hlY2tlZCcpICE9PSB1bmRlZmluZWQgPyAkKCcjY2hlY2tib3gtNCcpLnByb3AoJ2NoZWNrZWQnKSA6IGZhbHNlO1xyXG4gICAgZmlsdGVyRGF0YS52aWV3ID0gJCgnI2NoZWNrYm94LTUnKS5wcm9wKCdjaGVja2VkJykgIT09IHVuZGVmaW5lZCA/ICQoJyNjaGVja2JveC01JykucHJvcCgnY2hlY2tlZCcpIDogZmFsc2U7XHJcbiAgICBmaWx0ZXJEYXRhLmJib3ggPSB3aW5kb3cuYmJveCAhPT0gdW5kZWZpbmVkID8gd2luZG93LmJib3ggOiBvbC5wcm9qLnRyYW5zZm9ybSh1dGlscy5maW5kQnlJZChtYXAsICdlc3RhdGVzJykuZ2V0U291cmNlKCkuZ2V0RXh0ZW50KCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICBjb25zb2xlLmxvZyhmaWx0ZXJEYXRhKTtcclxuICAgIHJldHVybiBmaWx0ZXJEYXRhO1xyXG4gIH1cclxuICBmdW5jdGlvbiBnZXRSZXN1bHRzKG9wdGlvbnMsIG1hcCkge1xyXG4gICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9saXN0ZWQvZmlsdGVycycsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICBkYXRhOiBvcHRpb25zXHJcbiAgICAgIH0pXHJcbiAgICApXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLnNldFZpc2libGUoZmFsc2UpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICBjbGVhclJlc3VsdHMobWFwKTtcclxuICAgICAgYWRkUmVzdWx0cyhkYXRhLCBtYXApO1xyXG4gICAgfSkuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBpZiAoZS5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcih0cmFucy5lcnJvcnMucHJvcGVydHlbNDA0XSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZS5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcih0cmFucy5lcnJvcnMucHJvcGVydHlbNTAzXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKHRyYW5zLmVycm9ycy5pbnRlcm5hbCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBjaG9vc2VCeUFyZWEoZHJhdykge1xyXG4gICAgdmFyIG1hcCA9IGRyYXcuZ2V0TWFwKCk7XHJcbiAgICAkKG1hcC5nZXRWaWV3cG9ydCgpKS5tb3VzZWxlYXZlKGZ1bmN0aW9uIGxlYXZlTWFwRm9yQXJlYVNlbGVjdGlvbihldmVudCkge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgICAkKG1hcC5nZXRWaWV3cG9ydCgpKS5tb3VzZWVudGVyKGZ1bmN0aW9uIGVudGVyTWFwRm9yQXJlYVNlbGVjdGlvbihldmVudCkge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgZHJhdy5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuICAgIGRyYXcub24oJ2RyYXdzdGFydCcsIGZ1bmN0aW9uIGRyYXdzdGFydCgpIHtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnc2VsZWN0JykuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgIH0pO1xyXG4gICAgZHJhdy5vbignZHJhd2VuZCcsIGZ1bmN0aW9uIGRyYXdlbmQoZSkge1xyXG4gICAgICB2YXIgY29vcmRpbmF0ZXMgPSBlLmZlYXR1cmUuZ2V0R2VvbWV0cnkoKS5nZXRFeHRlbnQoKTtcclxuICAgICAgdmFyIHRyYW5zZm9ybWVkQ29vcmRpbmF0ZXMgPSBfLmNodW5rKGNvb3JkaW5hdGVzLCAyKS5tYXAoZnVuY3Rpb24gc3BsaXQoY3VycmVudFZhbHVlKSB7XHJcbiAgICAgICAgcmV0dXJuIG9sLnByb2oudHJhbnNmb3JtKGN1cnJlbnRWYWx1ZSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHdpbmRvdy5iYm94ID0gXy5jb25jYXQodHJhbnNmb3JtZWRDb29yZGluYXRlc1swXSwgdHJhbnNmb3JtZWRDb29yZGluYXRlc1sxXSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gaW5pdChtYXApIHtcclxuICAgIHZhciBkcmF3SW50ZXJhY3Rpb24gPSBuZXcgb2wuaW50ZXJhY3Rpb24uRHJhdyh7XHJcbiAgICAgIHNvdXJjZTogdXRpbHMuZmluZEJ5SWQobWFwLCAnc2VsZWN0JykuZ2V0U291cmNlKCksXHJcbiAgICAgIHR5cGU6ICdMaW5lU3RyaW5nJyxcclxuICAgICAgZ2VvbWV0cnlGdW5jdGlvbjogdXRpbHMuZ2VvbWV0cnlGdW5jdGlvbixcclxuICAgICAgbWF4UG9pbnRzOiAyXHJcbiAgICB9KTtcclxuICAgIGRyYXdJbnRlcmFjdGlvbi5zZXRQcm9wZXJ0aWVzKHtcclxuICAgICAgaWQ6ICdkcmF3J1xyXG4gICAgfSk7XHJcbiAgICBkcmF3SW50ZXJhY3Rpb24uc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICQoJyNjaGVja2JveC02JykuY2hhbmdlKGZ1bmN0aW9uIGVuYWJsZUFyZWFTZWxlY3Rpb24oKSB7XHJcbiAgICAgIGlmICh0aGlzLmNoZWNrZWQpIHtcclxuICAgICAgICBtYXAuYWRkSW50ZXJhY3Rpb24oZHJhd0ludGVyYWN0aW9uKTtcclxuICAgICAgICBjaG9vc2VCeUFyZWEoZHJhd0ludGVyYWN0aW9uKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBtYXAucmVtb3ZlSW50ZXJhY3Rpb24oZHJhd0ludGVyYWN0aW9uKTtcclxuICAgICAgICBkcmF3SW50ZXJhY3Rpb24uc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICB1dGlscy5maW5kQnlJZChtYXAsICdzZWxlY3QnKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgICQoJyNpbnZva2VGaWx0ZXJzJykuY2xpY2soZnVuY3Rpb24gaW52b2tlRmlsdGVycyhldmVudCkge1xyXG4gICAgICB2YXIgb3B0aW9ucztcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgIG9wdGlvbnMgPSBzZXRPcHRpb25zKG1hcCk7XHJcbiAgICAgIGlmICgkKCdmb3JtW25hbWU9ZmlsdGVyc10nKS5wYXJzbGV5KCkudmFsaWRhdGUoKSkge1xyXG4gICAgICAgIGdldFJlc3VsdHMob3B0aW9ucywgbWFwKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAkKCcjY2xlYXJGaWx0ZXJzJykuY2xpY2soZnVuY3Rpb24gY2xlYXJGaWx0ZXJzKGV2ZW50KSB7XHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICBjbGVhclJlc3VsdHMobWFwKTtcclxuICAgICAgJCgnbGFiZWxbZm9yPW9wdGlvbi0xXScpLmFkZENsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgICAgICQoJyNvcHRpb24tMScpLnByb3AoJ2NoZWNrZWQnLCB0cnVlKTtcclxuICAgICAgJCgnbGFiZWxbZm9yPW9wdGlvbi0yXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgICAgICQoJyNvcHRpb24tMicpLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7XHJcbiAgICAgICQoJy5tZGwtY2hlY2tib3hfX2lucHV0JykuZWFjaChmdW5jdGlvbiBjbGVhckNoZWNrYm94ZXMoaW5kZXgsIGVsKSB7XHJcbiAgICAgICAgJChlbCkucHJvcCgnY2hlY2tlZCcsIGZhbHNlKS5wYXJlbnQoJ2xhYmVsJylcclxuICAgICAgICAucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgfSk7XHJcbiAgICAgICQoJy5tZGwtdGV4dGZpZWxkX19pbnB1dCcpLmVhY2goZnVuY3Rpb24gY2xlYXJJbnB1dHMoaW5kZXgsIGVsKSB7XHJcbiAgICAgICAgaWYgKCQoZWwpLmF0dHIoJ2lkJykgIT09ICdlc3RhdGVUeXBlJykge1xyXG4gICAgICAgICAgJChlbCkudmFsKCcnKS5wYXJlbnQoKVxyXG4gICAgICAgICAgLmVxKDApXHJcbiAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoZWwpLmF0dHIoJ2RhdGEtdmFsJywgJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgaWYgKHRyYW5zLmxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgICAgICAgJChlbCkudmFsKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ2VzdGF0ZXMnKS5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiB7XHJcbiAgICBpbml0OiBpbml0XHJcbiAgfTtcclxufSh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCB1dGlscywgUGFyc2xleSkpO1xyXG4iLCJ2YXIgaW5mbyA9IChmdW5jdGlvbiBpbmZvKHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsICQsIHV0aWxzKSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG4gIHZhciBnZW9KU09ORm9ybWF0ID0gbmV3IG9sLmZvcm1hdC5HZW9KU09OKHtcclxuICAgIGRlZmF1bHREYXRhUHJvamVjdGlvbjogJ0VQU0c6NDMyNidcclxuICB9KTtcclxuICBmdW5jdGlvbiBleHRyYUluZm9Nb2RhbChmZWF0dXJlKSB7XHJcbiAgICB2YXIgbW9kYWxQcm9taXNlO1xyXG4gICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgaWYgKGZlYXR1cmUuZ2V0KCdyZW50JykpIHtcclxuICAgICAgb2JqLmxpc3RpbmdfdHlwZSA9IHRyYW5zLmxpc3RpbmcucmVudDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG9iai5saXN0aW5nX3R5cGUgPSB0cmFucy5saXN0aW5nLnNhbGU7XHJcbiAgICB9XHJcbiAgICBvYmoudHlwZSA9IGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlJyk7XHJcbiAgICBvYmouZ2lkID0gZmVhdHVyZS5nZXQoJ2dpZCcpO1xyXG4gICAgaWYgKHRyYW5zLmxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgb2JqLmFkZHJlc3MgPSBmZWF0dXJlLmdldCgnc3RyZWV0X2VsJykgKyAnJyArICBmZWF0dXJlLmdldCgnc3RyZWV0X251bWJlcicpO1xyXG4gICAgICBvYmouY29udGFjdCA9IHtcclxuICAgICAgICBuYW1lOiBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5uYW1lX2VsLFxyXG4gICAgICAgIGxhc3RuYW1lOiBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5sYXN0bmFtZV9lbFxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb2JqLmFkZHJlc3MgPSBmZWF0dXJlLmdldCgnc3RyZWV0X2VuJykgKyAnJyArICBmZWF0dXJlLmdldCgnc3RyZWV0X251bWJlcicpO1xyXG4gICAgICBvYmouY29udGFjdCA9IHtcclxuICAgICAgICBuYW1lOiBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5uYW1lX2VuLFxyXG4gICAgICAgIGxhc3RuYW1lOiBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5sYXN0bmFtZV9lblxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgb2JqLmFyZWEgPSBmZWF0dXJlLmdldCgnZXN0YXRlYXJlYScpO1xyXG4gICAgb2JqLmJlZHJvb21zID0gZmVhdHVyZS5nZXQoJ2JlZHJvb21zJyk7XHJcbiAgICBvYmoucHJpY2UgPSBmZWF0dXJlLmdldCgncHJpY2UnKTtcclxuICAgIG9iai50aXRsZSA9IHtcclxuICAgICAgZ2lkOiB0cmFucy5lc3RhdGUuZ2lkLFxyXG4gICAgICBsaXN0aW5nX3R5cGU6IHRyYW5zLmxpc3RpbmcudHlwZSxcclxuICAgICAgYWRkcmVzczogdHJhbnMuZXN0YXRlLmFkZHJlc3MsXHJcbiAgICAgIGFyZWE6IHRyYW5zLmVzdGF0ZS5hcmVhLFxyXG4gICAgICBiZWRyb29tczogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5iZWRyb29tcyxcclxuICAgICAgcHJpY2U6IHRyYW5zLmxpc3RpbmcucHJpY2UsXHJcbiAgICAgIGlzbmV3OiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmlzbmV3LFxyXG4gICAgICBwYXJraW5nOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLnBhcmtpbmcsXHJcbiAgICAgIGZ1cm5pc2hlZDogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5mdXJuaXNoZWQsXHJcbiAgICAgIHBldHM6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMucGV0cyxcclxuICAgICAgdmlldzogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy52aWV3LFxyXG4gICAgICBoZWF0aW5nOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmhlYXRpbmcsXHJcbiAgICAgIGNvb2xpbmc6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuY29vbGluZyxcclxuICAgICAgY29udGFjdEluZm86IHRyYW5zLmNvbnRhY3QuY29udGFjdEluZm8sXHJcbiAgICAgIG5hbWU6IHRyYW5zLmNvbnRhY3QubmFtZSxcclxuICAgICAgbGFzdG5hbWU6IHRyYW5zLmNvbnRhY3QubGFzdG5hbWUsXHJcbiAgICAgIHBob25lOiB0cmFucy5jb250YWN0LnBob25lLFxyXG4gICAgICBlbWFpbDogdHJhbnMuY29udGFjdC5lbWFpbFxyXG4gICAgfTtcclxuICAgIG9iai5pc25ldyA9IGZlYXR1cmUuZ2V0KCdpc25ldycpO1xyXG4gICAgb2JqLmZ1cm5pc2hlZCA9IGZlYXR1cmUuZ2V0KCdmdXJuaXNoZWQnKTtcclxuICAgIG9iai5wZXRzID0gZmVhdHVyZS5nZXQoJ3BldHMnKTtcclxuICAgIG9iai5idG5zID0ge1xyXG4gICAgICBpbmZvOiB0cmFucy5idG5zLmluZm8sXHJcbiAgICAgIGNsb3NlOiB0cmFucy5idG5zLmNsb3NlXHJcbiAgICB9O1xyXG4gICAgaWYgKGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLnBob25lMiAhPT0gbnVsbCkge1xyXG4gICAgICBvYmouY29udGFjdC5waG9uZSA9IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLnBob25lMSArICcgJyArIGZlYXR1cmUuZ2V0UHJvcGVydGllcygpLnBob25lMjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG9iai5jb250YWN0LnBob25lID0gZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkucGhvbmUxO1xyXG4gICAgfVxyXG4gICAgb2JqLmNvbnRhY3QuZW1haWwgPSBmZWF0dXJlLmdldFByb3BlcnRpZXMoKS5lbWFpbDtcclxuXHJcbiAgICBtb2RhbFByb21pc2UgPSBkdXN0Qmx1ZWJpcmQucmVuZGVyQXN5bmMoJ21vZGFsSW5mbycsIG9iailcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICAkKCcjbW9kYWwnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKGRhdGEpO1xyXG4gICAgfSlcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoKSB7XHJcbiAgICAgICQoJy5iaWctaW1hZ2UnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKGh0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvaF8yMjIsY19zY2FsZS8nICsgZmVhdHVyZS5nZXQoJ2dpZCcpICsgJy5qcGcpJyk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGZlYXR1cmUpO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgfSk7XHJcbiAgICAkKCcjbW9kYWwtY2xvc2UnKS5jbGljayhmdW5jdGlvbiBjbG9zZU1vZGFsKCkge1xyXG4gICAgICAkKCcjbW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiByZW5kZXJFc3RhdGVDYXJkcyhmZWF0dXJlKSB7XHJcbiAgICB2YXIgZXN0YXRlQ2FyZHNQcm9taXNlO1xyXG4gICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgaWYgKGZlYXR1cmUuZ2V0KCdyZW50JykpIHtcclxuICAgICAgb2JqLmxpc3RpbmdfdHlwZSA9IHRyYW5zLmxpc3RpbmcucmVudDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG9iai5saXN0aW5nX3R5cGUgPSB0cmFucy5saXN0aW5nLnNhbGU7XHJcbiAgICB9XHJcbiAgICBvYmoudHlwZSA9IGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlJyk7XHJcbiAgICBvYmouZ2lkID0gZmVhdHVyZS5nZXQoJ2dpZCcpO1xyXG4gICAgaWYgKHRyYW5zLmxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgb2JqLmFkZHJlc3MgPSBmZWF0dXJlLmdldCgnc3RyZWV0X2VsJykgKyAnJyArICBmZWF0dXJlLmdldCgnc3RyZWV0X251bWJlcicpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb2JqLmFkZHJlc3MgPSBmZWF0dXJlLmdldCgnc3RyZWV0X2VuJykgKyAnJyArICBmZWF0dXJlLmdldCgnc3RyZWV0X251bWJlcicpO1xyXG4gICAgfVxyXG4gICAgb2JqLmFyZWEgPSBmZWF0dXJlLmdldCgnZXN0YXRlYXJlYScpO1xyXG4gICAgb2JqLmJlZHJvb21zID0gZmVhdHVyZS5nZXQoJ2JlZHJvb21zJyk7XHJcbiAgICBvYmoucHJpY2UgPSBmZWF0dXJlLmdldCgncHJpY2UnKTtcclxuICAgIG9iai50aXRsZSA9IHtcclxuICAgICAgbGlzdGluZ190eXBlOiB0cmFucy5saXN0aW5nLnR5cGUsXHJcbiAgICAgIGFkZHJlc3M6IHRyYW5zLmVzdGF0ZS5hZGRyZXNzLFxyXG4gICAgICBhcmVhOiB0cmFucy5lc3RhdGUuYXJlYSxcclxuICAgICAgYmVkcm9vbXM6IHRyYW5zLmVzdGF0ZS5hbWVuaXRpZXMuYmVkcm9vbXMsXHJcbiAgICAgIHByaWNlOiB0cmFucy5saXN0aW5nLnByaWNlLFxyXG4gICAgICBpc25ldzogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5pc25ldyxcclxuICAgICAgZnVybmlzaGVkOiB0cmFucy5lc3RhdGUuYW1lbml0aWVzLmZ1cm5pc2hlZCxcclxuICAgICAgcGV0czogdHJhbnMuZXN0YXRlLmFtZW5pdGllcy5wZXRzXHJcbiAgICB9O1xyXG4gICAgb2JqLmlzbmV3ID0gZmVhdHVyZS5nZXQoJ2lzbmV3Jyk7XHJcbiAgICBvYmouZnVybmlzaGVkID0gZmVhdHVyZS5nZXQoJ2Z1cm5pc2hlZCcpO1xyXG4gICAgb2JqLnBldHMgPSBmZWF0dXJlLmdldCgncGV0cycpO1xyXG4gICAgb2JqLmJ0bnMgPSB7XHJcbiAgICAgIGluZm86IHRyYW5zLmJ0bnMuaW5mbyxcclxuICAgICAgY2xvc2U6IHRyYW5zLmJ0bnMuY2xvc2VcclxuICAgIH07XHJcbiAgICBlc3RhdGVDYXJkc1Byb21pc2UgPSBkdXN0Qmx1ZWJpcmQucmVuZGVyQXN5bmMoJ2VzdGF0ZUNhcmRzJywgb2JqKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgICQoJy5lc3RhdGUtY2FyZHMnKS5odG1sKGRhdGEpO1xyXG4gICAgfSlcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoKSB7XHJcbiAgICAgICQoJy5tZGwtY2FyZF9fdGl0bGUnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKGh0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvd180MzIsY19zY2FsZS8nICsgb2JqLmdpZCArICcuanBnKScpO1xyXG4gICAgICAkKCcuZXN0YXRlLWNhcmRzJykuYWRkQ2xhc3MoJ2VzdGF0ZS1jYXJkcy1hY3RpdmUnKTtcclxuICAgICAgJCgnI2VzdGF0ZS1jYXJkLXNxdWFyZS1jbG9zZScpLmNsaWNrKGZ1bmN0aW9uIGNsb3NlKCkge1xyXG4gICAgICAgICQoJy5lc3RhdGUtY2FyZHMnKS5yZW1vdmVDbGFzcygnZXN0YXRlLWNhcmRzLWFjdGl2ZScpO1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2VzdGF0ZS1jYXJkLXNxdWFyZS1leHRyYS1pbmZvJykuY2xpY2soZnVuY3Rpb24gZXh0cmFJbmZvKCkge1xyXG4gICAgICAgIGV4dHJhSW5mb01vZGFsKGZlYXR1cmUpO1xyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBzZWxlY3RGZWF0dXJlKGV2dCkge1xyXG4gICAgdmFyIG1hcCA9IGV2dC5tYXA7XHJcbiAgICAvLyB2YXIgY29vcmRpbmF0ZSA9IGV2dC5jb29yZGluYXRlO1xyXG4gICAgdmFyIGY7XHJcbiAgICB2YXIgY2xpY2tlZEZlYXR1cmUgPSBtYXAuZm9yRWFjaEZlYXR1cmVBdFBpeGVsKGV2dC5waXhlbCwgZnVuY3Rpb24gZmluZEZlYXR1cmUoZmVhdHVyZSwgbGF5ZXIpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBmZWF0dXJlOiBmZWF0dXJlLFxyXG4gICAgICAgIGxheWVyOiBsYXllclxyXG4gICAgICB9O1xyXG4gICAgfSwgdGhpcywgZnVuY3Rpb24gY2xpY2tlZEZlYXR1cmVMYXllckZpbHRlcihsYXllcikge1xyXG4gICAgICBpZiAobGF5ZXIuZ2V0KCdpZCcpID09PSAnZXN0YXRlcycgfHwgbGF5ZXIuZ2V0KCdpZCcpID09PSAnZmlsdGVyZWRFc3RhdGVzJykge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0sIHRoaXMpO1xyXG4gICAgaWYgKGNsaWNrZWRGZWF0dXJlKSB7XHJcbiAgICAgIGlmIChjbGlja2VkRmVhdHVyZS5sYXllci5nZXQoJ2lkJykgPT09ICdlc3RhdGVzJyAmJlxyXG4gICAgICAgIGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuZ2V0KCdmZWF0dXJlcycpLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAgIGYgPSBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLmdldFByb3BlcnRpZXMoKS5mZWF0dXJlc1swXTtcclxuICAgICAgICByZW5kZXJFc3RhdGVDYXJkcyhmKTtcclxuICAgICAgICBtYXAuZ2V0VmlldygpLnNldENlbnRlcihmLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSk7XHJcbiAgICAgICAgbWFwLmdldFZpZXcoKS5zZXRab29tKDE2KTtcclxuICAgICAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvdXNlcy8nICsgZi5nZXRQcm9wZXJ0aWVzKCkuZ2lkLFxyXG4gICAgICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJ1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApXHJcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgICAgICB2YXIgZmVhdHVyZXM7XHJcbiAgICAgICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgICAgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLnByb3BlcnR5X3NlcnZpY2VzX2FuYWx5c2lzLCB7XHJcbiAgICAgICAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBmZWF0dXJlcy5mb3JFYWNoKGZ1bmN0aW9uIHJlbW92ZVBvbHlnb24oZmVhdHVyZSkge1xyXG4gICAgICAgICAgICBpZiAoZmVhdHVyZS5nZXRHZW9tZXRyeSgpLmdldFR5cGUoKSA9PT0gJ1BvbHlnb24nKSB7XHJcbiAgICAgICAgICAgICAgZmVhdHVyZXMuc3BsaWNlKGZlYXR1cmVzLmluZGV4T2YoZmVhdHVyZSksIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgICAgICAgIC8vIG1hcC5nZXRWaWV3KCkuZml0KHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmdldEV4dGVudCgpLCBtYXAuZ2V0U2l6ZSgpKTtcclxuXHJcbiAgICAgICAgICB0b2FzdHIuaW5mbygnRm91bmQgJyArIGZlYXR1cmVzLmxlbmd0aCArICcgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgICBpZiAoZS5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCBhbnkgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgICAgIHRvYXN0ci5lcnJvcihlLnJlc3BvbnNlVGV4dCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoY2xpY2tlZEZlYXR1cmUubGF5ZXIuZ2V0KCdpZCcpID09PSAnZmlsdGVyZWRFc3RhdGVzJykge1xyXG4gICAgICAgIGYgPSBjbGlja2VkRmVhdHVyZS5mZWF0dXJlO1xyXG4gICAgICAgIHJlbmRlckVzdGF0ZUNhcmRzKGYpO1xyXG4gICAgICAgIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi91c2VzLycgKyBmLmdldFByb3BlcnRpZXMoKS5naWQsXHJcbiAgICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIClcclxuICAgICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgICAgIHZhciBmZWF0dXJlcztcclxuICAgICAgICAgIGlmICh1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5nZXRGZWF0dXJlcygpLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLnByb3BlcnR5X3NlcnZpY2VzX2FuYWx5c2lzLCB7XHJcbiAgICAgICAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBmZWF0dXJlcy5mb3JFYWNoKGZ1bmN0aW9uIHJlbW92ZVBvbHlnb24oZmVhdHVyZSkge1xyXG4gICAgICAgICAgICBpZiAoZmVhdHVyZS5nZXRHZW9tZXRyeSgpLmdldFR5cGUoKSA9PT0gJ1BvbHlnb24nKSB7XHJcbiAgICAgICAgICAgICAgZmVhdHVyZXMuc3BsaWNlKGZlYXR1cmVzLmluZGV4T2YoZmVhdHVyZSksIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgICAgICAgIG1hcC5nZXRWaWV3KCkuZml0KHV0aWxzLmZpbmRCeUlkKG1hcCwgJ3BvaScpLmdldFNvdXJjZSgpLmdldEV4dGVudCgpLCBtYXAuZ2V0U2l6ZSgpKTtcclxuICAgICAgICAgIHRvYXN0ci5pbmZvKCdGb3VuZCAnICsgZmVhdHVyZXMubGVuZ3RoICsgJyBQb2ludHMgb2YgSW50ZXJlc3QgaW4gOCBtaW51dGUgZGlzdGFuY2UhJyk7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyh0cmFucyk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICAgICAgaWYgKGUuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgICAgICB0b2FzdHIuZXJyb3IoZS5yZXNwb25zZVRleHQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdwb2knKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaW5pdChtYXApIHtcclxuICAgIG1hcC5vbignY2xpY2snLCBzZWxlY3RGZWF0dXJlKTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZGlzYWJsZShtYXApIHtcclxuICAgIG1hcC51bignY2xpY2snLCBzZWxlY3RGZWF0dXJlKTtcclxuICB9XHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXQ6IGluaXQsXHJcbiAgICBkaXNhYmxlOiBkaXNhYmxlXHJcbiAgfTtcclxufSh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCBqUXVlcnksIHV0aWxzKSk7XHJcblxyXG5cclxuLy8gZnVuY3Rpb24gaGFuZGxlSW5mbyhldnQpIHtcclxuLy8gICB2YXIgY29vcmRpbmF0ZSA9IGV2dC5jb29yZGluYXRlO1xyXG4vLyAgIHZhciBvYmogPSB7fTtcclxuLy8gICB2YXIgdGl0bGUgPSB7fTtcclxuLy8gICB2YXIgb3duZXIgPSB7fTtcclxuLy8gICB2YXIgZmVhdHVyZXMgPSBbXTtcclxuLy8gICB2YXIgY2xpY2tlZEZlYXR1cmU7XHJcbi8vICAgdmFyIGY7XHJcblxyXG4vLyAgIG1hcC5yZW1vdmVJbnRlcmFjdGlvbihkcmF3KTtcclxuLy8gICBldnQucHJldmVudERlZmF1bHQoKTtcclxuLy8gICBvYmoudGl0bGUgPSB0aXRsZTtcclxuLy8gICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4vLyAgICAgdGl0bGUuZ2lkID0gJ86az4nOtM65zrrPjM+CIM6ZzrTOuc6/zrrPhM63z4POr86xz4InO1xyXG4vLyAgICAgdGl0bGUudHlwZSA9ICfOlc6vzrTOv8+CIM6ZzrTOuc6/zrrPhM63z4POr86xz4InO1xyXG4vLyAgICAgdGl0bGUubGlzdGluZ190eXBlID0gJ86kz43PgM6/z4IgzpHOs86zzrXOu86vzrHPgic7XHJcbi8vICAgICB0aXRsZS5hcmVhID0gJ86VzrzOss6xzrTPjCc7XHJcbi8vICAgICB0aXRsZS5hZGRyZXNzID0gJ86UzrnOtc+FzrjPhc69z4POtyc7XHJcbi8vICAgICB0aXRsZS5iZWRyb29tcyA9ICfOpc+Azr3Ov860z4nOvM6sz4TOuc6xJztcclxuLy8gICAgIHRpdGxlLnByaWNlID0gJ86kzrnOvM6uJztcclxuLy8gICAgIHRpdGxlLmlzbmV3ID0gJ86dzrXPjM60zrzOt8+Ezr8nO1xyXG4vLyAgICAgdGl0bGUucGFya2luZyA9ICfOo8+EzqzOuM68zrXPg863JztcclxuLy8gICAgIHRpdGxlLmZ1cm5pc2hlZCA9ICfOlc+AzrnPgM67z4nOvM6tzr3Ovyc7XHJcbi8vICAgICB0aXRsZS5wZXRzID0gJ86azrHPhM6/zrnOus6vzrTOuc6xJztcclxuLy8gICAgIHRpdGxlLnZpZXcgPSAnzpjOrc6xJztcclxuLy8gICAgIHRpdGxlLmhlYXRpbmcgPSAnzpjOrc+BzrzOsc69z4POtyc7XHJcbi8vICAgICB0aXRsZS5jb29saW5nID0gJ86oz43Ovs63JztcclxuLy8gICAgIHRpdGxlLmNvbnRhY3RJbmZvID0gJ86jz4TOv865z4fOtc6vzrEgzpXPgM65zrrOv865zr3Pic69zq/Osc+CJztcclxuLy8gICAgIHRpdGxlLm5hbWUgPSAnzozOvc6/zrzOsSc7XHJcbi8vICAgICB0aXRsZS5sYXN0bmFtZSA9ICfOlc+Azq/OuM61z4TOvyc7XHJcbi8vICAgICB0aXRsZS5waG9uZSA9ICfOpM63zrvOrc+Gz4nOvc6/JztcclxuLy8gICAgIHRpdGxlLmVtYWlsID0gJ86XzrvOtc66z4TPgc6/zr3Ouc66zq4gzpTOuc61z43OuM+Fzr3Pg863JztcclxuLy8gICB9IGVsc2Uge1xyXG4vLyAgICAgdGl0bGUuZ2lkID0gJ0VzdGF0ZSBDb2RlJztcclxuLy8gICAgIHRpdGxlLnR5cGUgPSAnUHJvcGVydHkgVHlwZSc7XHJcbi8vICAgICB0aXRsZS5saXN0aW5nX3R5cGUgPSAnTGlzdGluZyBUeXBlJztcclxuLy8gICAgIHRpdGxlLmFyZWEgPSAnU2l6ZSc7XHJcbi8vICAgICB0aXRsZS5hZGRyZXNzID0gJ0FkZHJlc3MnO1xyXG4vLyAgICAgdGl0bGUuYmVkcm9vbXMgPSAnQmVkcm9vbXMnO1xyXG4vLyAgICAgdGl0bGUucHJpY2UgPSAnUHJpY2UnO1xyXG4vLyAgICAgdGl0bGUuaXNuZXcgPSAnTmV3bHkgQnVpbGQnO1xyXG4vLyAgICAgdGl0bGUucGFya2luZyA9ICdQYXJraW5nJztcclxuLy8gICAgIHRpdGxlLmZ1cm5pc2hlZCA9ICdGdXJuaXNoZWQnO1xyXG4vLyAgICAgdGl0bGUucGV0cyA9ICdQZXRzIEFsbG93ZWQnO1xyXG4vLyAgICAgdGl0bGUudmlldyA9ICdWaWV3JztcclxuLy8gICAgIHRpdGxlLmhlYXRpbmcgPSAnSGVhdGluZyc7XHJcbi8vICAgICB0aXRsZS5jb29saW5nID0gJ0Nvb2xpbmcnO1xyXG4vLyAgICAgdGl0bGUuY29udGFjdEluZm8gPSAnQ29udGFjdCBJbmZvJztcclxuLy8gICAgIHRpdGxlLm5hbWUgPSAnTmFtZSc7XHJcbi8vICAgICB0aXRsZS5sYXN0bmFtZSA9ICdMYXN0IE5hbWUnO1xyXG4vLyAgICAgdGl0bGUucGhvbmUgPSAnVGVsZXBob25lJztcclxuLy8gICAgIHRpdGxlLmVtYWlsID0gJ0VtYWlsJztcclxuLy8gICB9XHJcbi8vICAgY2xpY2tlZEZlYXR1cmUgPSBtYXAuZm9yRWFjaEZlYXR1cmVBdFBpeGVsKGV2dC5waXhlbCwgZnVuY3Rpb24gKGZlYXR1cmUsIGxheWVyKSB7XHJcbi8vICAgICByZXR1cm4ge1xyXG4vLyAgICAgICBmZWF0dXJlOiBmZWF0dXJlLFxyXG4vLyAgICAgICBsYXllcjogbGF5ZXJcclxuLy8gICAgIH07XHJcbi8vICAgfSwgdGhpcywgZnVuY3Rpb24gKGxheWVyKSB7XHJcbi8vICAgICBpZiAobGF5ZXIuZ2V0KCdpZCcpID09PSAnZXN0YXRlcycgfHwgbGF5ZXIuZ2V0KCdpZCcpID09PSAnZmlsdGVyZWRFc3RhdGVzJykge1xyXG4vLyAgICAgICByZXR1cm4gdHJ1ZTtcclxuLy8gICAgIH1cclxuLy8gICAgIHJldHVybiBmYWxzZTtcclxuLy8gICB9LCB0aGlzKTtcclxuLy8gICBpZiAoY2xpY2tlZEZlYXR1cmUpIHtcclxuLy8gICAgIGlmIChjbGlja2VkRmVhdHVyZS5sYXllci5nZXQoJ2lkJykgPT09ICdlc3RhdGVzJyAmJiBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLmdldCgnZmVhdHVyZXMnKS5sZW5ndGggPT09IDEpIHtcclxuLy8gICAgICAgZiA9IGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuZ2V0UHJvcGVydGllcygpLmZlYXR1cmVzWzBdO1xyXG4vLyAgICAgICBjcmVhdGVQU0FhbmRDYXJkKGYsIG9iaik7XHJcbi8vICAgICB9IGVsc2UgaWYgKGNsaWNrZWRGZWF0dXJlLmxheWVyLmdldCgnaWQnKSA9PT0gJ2ZpbHRlcmVkRXN0YXRlcycpIHtcclxuLy8gICAgICAgZiA9IGNsaWNrZWRGZWF0dXJlLmZlYXR1cmU7XHJcbi8vICAgICAgIGNyZWF0ZVBTQWFuZENhcmQoZiwgb2JqKTtcclxuLy8gICAgIH1cclxuLy8gICB9IGVsc2Uge1xyXG4vLyAgICAgUFNBLnNldFNvdXJjZShudWxsKTtcclxuLy8gICB9XHJcbi8vIH1cclxuXHJcbi8vIGZ1bmN0aW9uIGNyZWF0ZVBTQWFuZENhcmQoZiwgb2JqKSB7XHJcbi8vICAgdmFyIGZlYXR1cmUgPSB7fTtcclxuICAvLyBmZWF0dXJlLmdpZCA9IGYuZ2V0KCdnaWQnKTtcclxuICAvLyBmZWF0dXJlLmFyZWEgPSBmLmdldCgnZXN0YXRlYXJlYScpO1xyXG4vLyAgIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbi8vICAgICBmZWF0dXJlLnR5cGUgPSBmLmdldCgnZXN0YXRldHlwZScpO1xyXG4vLyAgICAgZmVhdHVyZS5hZGRyZXNzID0gZi5nZXQoJ3N0cmVldF9lbCcpICsgJyAnICsgZi5nZXQoJ3N0cmVldF9udW1iZXInKTtcclxuLy8gICAgIGZlYXR1cmUubmFtZSA9IGYuZ2V0KCduYW1lX2VsJyk7XHJcbi8vICAgICBmZWF0dXJlLmxhc3RuYW1lID0gZi5nZXQoJ2xhc3RuYW1lX2VsJyk7XHJcbi8vICAgICBpZiAoZi5nZXQoJ3NhbGUnKSA9PT0gdHJ1ZSkge1xyXG4vLyAgICAgICBmZWF0dXJlLmxpc3RpbmdfdHlwZSA9ICfOoM+OzrvOt8+DzrcnO1xyXG4vLyAgICAgfSBlbHNlIHtcclxuLy8gICAgICAgZmVhdHVyZS5saXN0aW5nX3R5cGUgPSAnzpXOvc6/zrnOus6vzrHPg863JztcclxuLy8gICAgIH1cclxuLy8gICAgIGZlYXR1cmUuYnRucyA9IHtcclxuLy8gICAgICAgaW5mbzogJ8+AzrvOt8+Bzr/Phs6/z4HOuc61z4InLFxyXG4vLyAgICAgICBjbG9zZTogJ866zrvOtc65z4POuc68zr8nXHJcbi8vICAgICB9O1xyXG4vLyAgIH0gZWxzZSB7XHJcbi8vICAgICBmZWF0dXJlLnR5cGUgPSBmLmdldCgnZXN0YXRldHlwZV9lbicpO1xyXG4vLyAgICAgZmVhdHVyZS5hZGRyZXNzID0gZi5nZXQoJ3N0cmVldF9lbicpICsgJyAnICsgZi5nZXQoJ3N0cmVldF9udW1iZXInKTtcclxuLy8gICAgIGZlYXR1cmUubmFtZSA9IGYuZ2V0KCduYW1lX2VuJyk7XHJcbi8vICAgICBmZWF0dXJlLmxhc3RuYW1lID0gZi5nZXQoJ2xhc3RuYW1lX2VuJyk7XHJcbi8vICAgICBpZiAoZi5nZXQoJ3NhbGUnKSA9PT0gdHJ1ZSkge1xyXG4vLyAgICAgICBmZWF0dXJlLmxpc3RpbmdfdHlwZSA9ICdTYWxlJztcclxuLy8gICAgIH0gZWxzZSB7XHJcbi8vICAgICAgIGZlYXR1cmUubGlzdGluZ190eXBlID0gJ1JlbnQnO1xyXG4vLyAgICAgfVxyXG4vLyAgICAgZmVhdHVyZS5idG5zID0ge1xyXG4vLyAgICAgICBpbmZvOiAnaW5mbycsXHJcbi8vICAgICAgIGNsb3NlOiAnY2xvc2UnXHJcbi8vICAgICB9O1xyXG4vLyAgIH1cclxuLy8gICBmZWF0dXJlLmJlZHJvb21zID0gZi5nZXQoJ2JlZHJvb21zJyk7XHJcbi8vICAgZmVhdHVyZS5wcmljZSA9IGYuZ2V0KCdwcmljZScpO1xyXG4vLyAgIGZlYXR1cmUuaXNuZXcgPSBmLmdldCgnaXNuZXcnKTtcclxuLy8gICBmZWF0dXJlLnBhcmtpbmcgPSBmLmdldCgncGFya2luZycpO1xyXG4vLyAgIGZlYXR1cmUuZnVybmlzaGVkID0gZi5nZXQoJ2Z1cm5pc2hlZCcpO1xyXG4vLyAgIGZlYXR1cmUucGV0cyA9IGYuZ2V0KCdwZXRzJyk7XHJcbi8vICAgZmVhdHVyZS52aWV3ID0gZi5nZXQoJ3ZpZXcnKTtcclxuLy8gICBmZWF0dXJlLmhlYXRpbmcgPSBmLmdldCgnaGVhdGluZycpO1xyXG4vLyAgIGZlYXR1cmUuY29vbGluZyA9IGYuZ2V0KCdjb29saW5nJyk7XHJcbi8vICAgZmVhdHVyZS5waG9uZSA9IGYuZ2V0KCdwaG9uZTEnKTtcclxuLy8gICBmZWF0dXJlLmVtYWlsID0gZi5nZXQoJ2VtYWlsJyk7XHJcbi8vICAgZmVhdHVyZS5jb29yZGluYXRlID0gZi5nZXQoJ2dlb21ldHJ5JykuZ2V0Q29vcmRpbmF0ZXMoKTtcclxuXHJcbi8vICAgdmFyIFBTQVNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuLy8gICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbi8vICAgICAgIGh0bWw6ICdQT0kgYnkgJyArICc8YSBocmVmPVwiaHR0cDovL3d3dy50ZXJyYWNvZ25pdGEuZ3IvXCI+VGVycmEgQ29nbml0YTwvYT4nXHJcbi8vICAgICB9KV0sXHJcbi8vICAgICBmb3JtYXQ6IGdlb0pTT05Gb3JtYXQsXHJcbi8vICAgICBsb2FkZXI6IGZ1bmN0aW9uIChleHRlbnQsIHJlc29sdXRpb24sIHByb2plY3Rpb24pIHtcclxuLy8gICAgICAgdmFyIHVybCA9ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvdXNlcy8nICsgZmVhdHVyZS5naWQ7XHJcbi8vICAgICAgIHZhciBzZWxmID0gdGhpcztcclxuLy8gICAgICAgJC5hamF4KHtcclxuLy8gICAgICAgICB1cmw6IHVybCxcclxuLy8gICAgICAgICB0eXBlOiAnR0VUJyxcclxuLy8gICAgICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbi8vICAgICAgIH0pLmRvbmUoZnVuY3Rpb24gc3VjY2VkZWQoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICAvLyB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLnByb3BlcnR5X3NlcnZpY2VzX2FuYWx5c2lzLCB7XHJcbiAgICAgICAgLy8gICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgICAvLyB9KTtcclxuICAgICAgICAvLyB2YXIgZmVhdHVyZXNMZW5ndGggPSBmZWF0dXJlcy5sZW5ndGggLSAxO1xyXG4gICAgICAgIC8vIHZhciBhcmVhID0gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgICAvLyAgIGZpbGw6IG5ldyBvbC5zdHlsZS5GaWxsKHtcclxuICAgICAgICAvLyAgICAgY29sb3I6IFsxNTYsIDM5LCAxNzYsIDAuMV1cclxuICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgLy8gZmVhdHVyZXNbMF0uc2V0U3R5bGUoYXJlYSk7XHJcbiAgICAgICAgLy8gc2VsZi5hZGRGZWF0dXJlcyhmZWF0dXJlcyk7XHJcbi8vICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbi8vICAgICAgICAgdG9hc3RyLmluZm8oJ0ZvdW5kICcgKyBmZWF0dXJlc0xlbmd0aCArICcgUG9pbnRzIG9mIEludGVyZXN0IGluIDggbWludXRlIGRpc3RhbmNlIScpO1xyXG4vLyAgICAgICB9KS5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUikge1xyXG4vLyAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4vLyAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4vLyAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IFBvaW50cyBvZiBJbnRlcmVzdCBpbiA4IG1pbnV0ZSBkaXN0YW5jZSEnKTtcclxuLy8gICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbi8vICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuLy8gICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuLy8gICAgICAgICB9XHJcbi8vICAgICAgIH0pO1xyXG4vLyAgICAgfSxcclxuLy8gICAgIHN0cmF0ZWd5OiBvbC5sb2FkaW5nc3RyYXRlZ3kuYWxsXHJcbi8vICAgfSk7XHJcbi8vICAgUFNBLnNldFNvdXJjZShQU0FTb3VyY2UpO1xyXG4vLyAgIG1hcC5nZXRWaWV3KCkuc2V0Q2VudGVyKGZlYXR1cmUuY29vcmRpbmF0ZSk7XHJcbi8vICAgbWFwLmdldFZpZXcoKS5zZXRSZXNvbHV0aW9uKDEuMik7XHJcbi8vICAgb2JqLmZlYXR1cmUgPSBmZWF0dXJlO1xyXG5cclxuLy8gICBkdXN0LnJlbmRlcignZXN0YXRlQ2FyZHMnLCBvYmosIGZ1bmN0aW9uIHJlbmRlckVzdGF0ZUNhcmRzKGVyciwgb3V0KSB7XHJcbi8vICAgICAkKCcuZXN0YXRlLWNhcmRzJykuaHRtbChvdXQpO1xyXG4vLyAgICAgJCgnLm1kbC1jYXJkX190aXRsZScpLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoaHR0cDovL3Jlcy5jbG91ZGluYXJ5LmNvbS9maXJ2YWluL2ltYWdlL3VwbG9hZC93XzQzMixjX3NjYWxlLycgKyBvYmouZmVhdHVyZS5naWQgKyAnLmpwZyknKTtcclxuLy8gICAgICQoJy5lc3RhdGUtY2FyZHMnKS5hZGRDbGFzcygnZXN0YXRlLWNhcmRzLWFjdGl2ZScpO1xyXG4vLyAgIC8vICQoXCIjaW5mb2JveFwiKS5hZGRDbGFzcyhcInZpc3VhbGx5aGlkZGVuXCIpO1xyXG4vLyAgIH0pO1xyXG4vLyAgICQoJ2FbaHJlZj1cIiNvcGVuTW9kYWxcIl0nKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbi8vICAgICBkdXN0LnJlbmRlcignbW9kYWxJbmZvJywgb2JqLCBmdW5jdGlvbiByZW5kZXJNb2RhbEluZm8oZXJyLCBvdXQpIHtcclxuLy8gICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbi8vICAgICAgICQoJy5iaWctaW1hZ2UnKS5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKGh0dHA6Ly9yZXMuY2xvdWRpbmFyeS5jb20vZmlydmFpbi9pbWFnZS91cGxvYWQvaF8yMjIsY19zY2FsZS8nICsgb2JqLmZlYXR1cmUuZ2lkICsgJy5qcGcpJyk7XHJcbi8vICAgICB9KTtcclxuLy8gICB9KTtcclxuLy8gICAkKCdhW2hyZWY9XCIjY2xvc2VFc3RhdGVDYXJkXCJdJykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4vLyAgICAgJCgnLmVzdGF0ZS1jYXJkcycpLnJlbW92ZUNsYXNzKCdlc3RhdGUtY2FyZHMtYWN0aXZlJyk7XHJcbi8vICAgfSk7XHJcbi8vIH1cclxuLy8gJCgnI2luZm9ybWF0aW9uJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHtcclxuLy8gICAvLyBQU0Euc2V0U291cmNlKG51bGwpO1xyXG4vLyAgIGlmICgkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKSA9PT0gdHJ1ZSkge1xyXG4vLyAgICAgbWFwLm9uKCdjbGljaycsIHNlbGVjdGVkRmVhdHVyZSk7XHJcbi8vICAgICAvLyAkKHRoaXMpLnBhcmVudCgpLnNpYmxpbmdzKCkuZmluZCgnaW5wdXQnKS5lYWNoKGZ1bmN0aW9uICgpIHskKHRoaXMpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7fSk7XHJcbi8vICAgfSBlbHNlIHtcclxuLy8gICAgIG1hcC51bignY2xpY2snLCBzZWxlY3RlZEZlYXR1cmUpO1xyXG4vLyAgICAgLy8gJCh0aGlzKS5wYXJlbnQoKS5zaWJsaW5ncygpLmZpbmQoJ2lucHV0JykuZWFjaChmdW5jdGlvbiAoKSB7JCh0aGlzKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTt9KTtcclxuLy8gICB9XHJcbi8vIH0pO1xyXG4iLCJ2YXIgdHJhbnM7XHJcbnZhciB1c2VyTWFwID0gKGZ1bmN0aW9uIHVzZXJNYXAod2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgJCwgbXltYXAsIGluZm8sIGZpbHRlcnMpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGNvbnRleHQgPSAnbWFwJztcclxuICB2YXIgbGFuZyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xyXG4gIC8vIHZhciBnbG9iYWxzID0ge307XHJcbiAgdmFyICRsb2FkaW5nID0gJCgnLm1kbC1zcGlubmVyJyk7XHJcbiAgJChkb2N1bWVudClcclxuICAuYWpheFN0YXJ0KGZ1bmN0aW9uIHN0YXJ0KCkge1xyXG4gICAgJGxvYWRpbmcuYWRkQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIH0pXHJcbiAgLmFqYXhTdG9wKGZ1bmN0aW9uIHN0b3AoKSB7XHJcbiAgICAkbG9hZGluZy5yZW1vdmVDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSk7XHJcbiAgdG9hc3RyLm9wdGlvbnMgPSB7XHJcbiAgICBjbG9zZUJ1dHRvbjogZmFsc2UsXHJcbiAgICBkZWJ1ZzogZmFsc2UsXHJcbiAgICBuZXdlc3RPblRvcDogZmFsc2UsXHJcbiAgICBwcm9ncmVzc0JhcjogZmFsc2UsXHJcbiAgICBwb3NpdGlvbkNsYXNzOiAndG9hc3QtdG9wLWNlbnRlcicsXHJcbiAgICBwcmV2ZW50RHVwbGljYXRlczogZmFsc2UsXHJcbiAgICBvbmNsaWNrOiBudWxsLFxyXG4gICAgc2hvd0R1cmF0aW9uOiAnMzAwJyxcclxuICAgIGhpZGVEdXJhdGlvbjogJzEwMDAnLFxyXG4gICAgdGltZU91dDogJzUwMDAnLFxyXG4gICAgZXh0ZW5kZWRUaW1lT3V0OiAnMTAwMCcsXHJcbiAgICBzaG93RWFzaW5nOiAnc3dpbmcnLFxyXG4gICAgaGlkZUVhc2luZzogJ2xpbmVhcicsXHJcbiAgICBzaG93TWV0aG9kOiAnZmFkZUluJyxcclxuICAgIGhpZGVNZXRob2Q6ICdmYWRlT3V0J1xyXG4gIH07XHJcblxyXG4gIGZ1bmN0aW9uIGluaXQoKSB7XHJcbiAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICQuYWpheCh7XHJcbiAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9sYW5ndWFnZScsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgdHlwZTogbGFuZyxcclxuICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHRcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIClcclxuICAgICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgICAgdmFyIG1hcDtcclxuICAgICAgICB0cmFucyA9IGRhdGE7XHJcbiAgICAgICAgbWFwID0gbXltYXAuaW5pdGlhbGl6ZSh0cmFucyk7XHJcbiAgICAgICAgbWFwMSA9IG1hcDtcclxuICAgICAgICByZXR1cm4gbWFwO1xyXG4gICAgICB9KVxyXG4gICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKG1hcCkge1xyXG4gICAgICAgIGluZm8uaW5pdChtYXApO1xyXG4gICAgICAgIGZpbHRlcnMuaW5pdChtYXApO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBpbml0OiBpbml0XHJcbiAgfTtcclxufSh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCBqUXVlcnksIG15bWFwLCBpbmZvLCBmaWx0ZXJzKSk7XHJcblxyXG5cclxuLy8galF1ZXJ5KGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoJCkge1xyXG4vLyAgICQoJy5zcGlubmVyJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbi8vICAgJCgnLm1kbC1zcGlubmVyJykucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4vLyAgIC8vIGhhbmRsZVNlbGVjdCgpO1xyXG4vLyB9KTtcclxuXHJcbnVzZXJNYXAuaW5pdCgpO1xyXG4kKCcjYWR2YW5jZWQtZmlsdGVycycpLmNsaWNrKGZ1bmN0aW9uIHRvZ2dsZUZpbHRlcnMoKSB7XHJcbiAgJCgnI2VzdGF0ZS1maWx0ZXJzJykudG9nZ2xlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbn0pO1xyXG4vLyAkKCcjdG9nZ2xlLXByaWNlLXJhbmdlJykuY2xpY2soZnVuY3Rpb24gdG9nZ2xlUHJpY2VSYW5nZSgpIHtcclxuLy8gICAkKCcjcHJpY2UtcmFuZ2UnKS50b2dnbGVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuLy8gfSk7XHJcbiJdfQ==
