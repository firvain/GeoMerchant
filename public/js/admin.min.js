var $loading = $('.mdl-spinner');

var center = [3677385, 4120949];
var extent = [3590094, 4102833, 3855483, 4261211];
var lang = document.documentElement.lang;
var geoJSONFormat = new ol.format.GeoJSON({
  defaultDataProjection: 'EPSG:4326'
});
var propertySource;
var property;
var map;
var features;
var drawnProperties;
var draw;
var select;
var translate;
var bing;
var mapbox;
toastr.options = {
  closeButton: false,
  debug: false,
  newestOnTop: false,
  progressBar: false,
  positionClass: 'toast-top-center',
  preventDuplicates: false,
  onclick: null,
  showDuration: '300',
  hideDuration: '1000',
  timeOut: '5000',
  extendedTimeOut: '1000',
  showEasing: 'swing',
  hideEasing: 'linear',
  showMethod: 'fadeIn',
  hideMethod: 'fadeOut'
};
bing = new ol.layer.Tile({
  visible: true,
  source: new ol.source.BingMaps({
    key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
    imagerySet: 'Aerial'
  }),
  maxZoom: 19,
  crossOrigin: 'anonymous',
  preload: Infinity,
  id: 'bing'
});
mapbox = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [new ol.Attribution({
      html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
    })],
    url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
  }),
  id: 'mapbox'
});

function getIconType(estateType) {
  var iconType = {
    Apartment: function getApartmentIcon() {
      return 'apartment';
    },
    Store: function getStoreIcon() {
      return 'store';
    },
    'Detached House': function getDetachedHouseIcon() {
      return 'detached';
    },
    Maisonette: function getMaisonetteIcon() {
      return 'maisonette';
    },
    Villa: function getVillaIon() {
      return 'villa';
    }
  };
  return (iconType[estateType])();
}

function getIconPath(listingType) {
  var iconPath = {
    true: function () {
      return './images/pins/sale/';
    },
    false: function () {
      return './images/pins/rent/';
    },
    none: function () {
      return './images/pins/none/';
    }
  };
  return (iconPath[listingType])();
}

function PropertyStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-48.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
propertySource = new ol.source.Vector({
  format: geoJSONFormat,
  loader: function (extent, resolution, projection) {
    var url = 'http://127.0.0.1:3000/db/property/' + id;
    var self = this;
    // self.clear();
    $.ajax({
      url: url,
      type: 'GET',
      // beforeSend: function (xhr) {
      //   if (localStorage.getItem('userToken')) {
      //     xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('userToken'));
      //   }
      // },
      dataType: 'json'
    })
    .done(function completed(data, textStatus, jqXHR) {
      var newFeatures = geoJSONFormat.readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
      self.addFeatures(newFeatures);
    })
    .fail(function failed(jqXHR, textStatus, errorThrown) {
      toastr.clear();
      if (jqXHR.status === 404) {
        toastr.error('Sorry, we cannot find this property!');
      } else if (jqXHR.status === 503) {
        toastr.error('Service Unavailable');
      } else {
        toastr.error('Internal Server Error');
      }
    });
  }
});
property = new ol.layer.Vector({
  source: propertySource,
  id: 'property',
  visible: true,
  style: PropertyStyle
});
property.setZIndex(2);
map = new ol.Map({
  target: 'adminMap',
  layers: [
    mapbox, property
  ],
  loadTilesWhileAnimating: true,
  loadTilesWhileInteracting: true,
  renderer: 'canvas',
  controls: ol.control.defaults({
    attributionOptions: {
      collapsible: false,
      collapsed: false
    }
  }).extend([
    new ol.control.ScaleLine({
      units: 'metric'
    }),
    new ol.control.OverviewMap({
      className: 'ol-overviewmap ol-custom-overviewmap',
      collapsible: true,
      collapsed: true,
      layers: [bing]
    }),
    new ol.control.ZoomToExtent({
      extent: extent
    })
  ]),
  view: new ol.View({
    center: center,
    // extent: extent,
    projection: 'EPSG:3857',
    zoom: 14,
    maxZoom: 19,
    minZoom: 10
  })
});
if (lang === 'el') {
  bing.set('name', 'Δορυφορική εικόνα');
  mapbox.set('name', 'Χάρτης');
  property.set('name', 'Ακίνητα');
} else {
  bing.set('name', 'Sattelite Image');
  mapbox.set('name', 'Map');
  property.set('name', 'Properties');
}
// ====== interactions ======
features = new ol.Collection();

function drawnPropertiesStyle(color) {
  var src;
  src = './images/pins/generic-48.png';
  if (typeof color !== 'undefined') {
    return new ol.style.Style({
      image: new ol.style.Icon(({
        src: src,
        anchorOrigin: 'bottom-left',
        anchor: [
          0.5, 0
        ],
        scale: 1,
        color: color
      }))
    });
  }
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
drawnProperties = new ol.layer.Vector({
  source: new ol.source.Vector(),
  id: 'drawnProperties',
  style: drawnPropertiesStyle('#4caf50')
});
map.addLayer(drawnProperties);
// draw
draw = new ol.interaction.Draw({
  // features: features,
  source: drawnProperties.getSource(),
  type: 'Point',
  style: drawnPropertiesStyle('#4caf50')
});
map.addInteraction(draw);
draw.setActive(false);
// select
function selectedStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-64.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1,
      color: '#ffeb3b'
    }))
  });
}
select = new ol.interaction.Select({
  layers: [property],
  features: features,
  multi: false,
  style: selectedStyle
});
map.addInteraction(select);
select.setActive(false);
translate = new ol.interaction.Translate({
  features: select.getFeatures()
});
map.addInteraction(translate);
translate.setActive(false);
// ====== info ======
map.on('click', clickInfo);

function clickInfo(event) {
  var obj = {};

  event.preventDefault();
  select.setActive(true);
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      obj.feature = {};
      selectedFeature = _.head(e.selected);
      // clickedFeature.feature.setScale(1.2);
      selectedFeature.getKeys().forEach(function (key) {
        obj.feature[key] = selectedFeature.get(key);
      });
      dust.render('adminPropertyInfo', obj, function (err, out) {
        $('.property-info').html(out);
        $('.property-info').removeClass('visuallyhidden');
        componentHandler.upgradeDom();
        $('#listing').on('click', function (event) {
          var gid;
          event.preventDefault();
          gid = $(this).data('gid');
          $.ajax({
              url: 'http://127.0.0.1:3000/db/listing',
              type: 'GET',
              dataType: 'json',
              data: {
                gid: gid,
              },
            })
            .done(function (data) {
              // console.log(data);
              var listing_id = data.id;
              $('#openModal').css('width', 'auto');
              $('.modal-dialog').removeClass('visuallyhidden');
              dust.render('listingInsert', data, function (err, out) {
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                handleForm.set({
                  name: 'insert-update-listing',
                  submitBtnId: 'ok',
                });
                if ($('input[name=options]:checked').val() === 'Sale') {
                  $('#pets').parent().hide();
                  $('#prefered_customer').parent().hide();
                }
                $('input[name=options]').on('change', function (event) {
                  if ($(this).val() === 'Sale') {
                    $('#pets').prop('disabled', true);
                    $('#pets').prop('checked', false);
                    $('#pets').parent().hide();
                    $('label[for=pets]').removeClass('is-checked');
                    $('#prefered_customer').val('');
                    $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                    $('#prefered_customer').prop('disabled', true);
                    $('#prefered_customer').parent().hide();
                  } else {
                    $('#pets').prop('disabled', false);
                    $('#pets').parent().show();
                    $('#prefered_customer').prop('disabled', false);
                    $('#prefered_customer').parent().show();
                  }
                });
                $('#sent-listing').on('click', function (event) {
                  var data;
                  event.preventDefault();
                  data = handleForm.get();
                  if (data !== null) {
                    data.property_gid = gid;
                    data.listing_id = listing_id;
                    $.ajax({
                        url: 'http://127.0.0.1:3000/db/listing',
                        type: 'PUT',
                        data: data,
                        dataType: 'text'
                      })
                      .done(function (data, textStatus, jqXHR) {
                        if (jqXHR.status === 200) {
                          toastr.success('Property Updated In Database');
                        } else {
                          toastr.error('Oops Something Went Wrong!!!');
                        }
                      })
                      .fail(function (jqXHR, textStatus, errorThrown) {
                        toastr.error('Oops Something Went Wrong!!!');
                      })
                      .always(function () {
                        handleForm.clear();
                        $('#openModal').addClass('visuallyhidden');
                        propertySource.clear();
                        select.getFeatures().clear();
                        select.setActive(false);
                      });
                  }
                });
                $('#cancel-listing').on('click', function (event) {
                  event.preventDefault();
                  handleForm.clear();
                  select.getFeatures().clear();
                  select.setActive(false);
                  $('#openModal').addClass('visuallyhidden');
                });
              });
            })
            .fail(function () {
              var obj = {};
              if (lang === 'el') {
                obj.msg = 'Δεν Βρέθηκε Αγγελία';
                obj.text = 'Δημιουργία Καινούργιας;';
                obj.yes = 'ΝΑΙ';
                obj.no = 'ΟΧΙ';
              } else {
                obj.msg = 'No Listing Found';
                obj.text = 'Create New Listing?';
                obj.yes = 'YES';
                obj.no = 'NO';
              }
              dust.render('dialog', obj, function (error, out) {
                $('#openModal').removeClass('visuallyhidden');
                $('#openModal').css('width', 'auto');
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                $('#yes').on('click', function (event) {
                  event.preventDefault();
                  dust.render('listingInsert', {
                    rent: 'true',
                    addImage: 'true',
                  }, function (err, out) {
                    var myDropzone;
                    $('.modal-content').html(out);
                    componentHandler.upgradeDom();
                    myDropzone = new Dropzone(document.getElementById('dropzone'), {
                      uploadMultiple: false,
                      acceptedFiles: '.jpg',
                      parallelUploads: 6,
                      // addRemoveLinks : true,
                      url: 'https://api.cloudinary.com/v1_1/firvain/auto/upload'
                    });
                    myDropzone.on('sending', function (file, xhr, formData) {
                      formData.append('api_key', 375138932689591);
                      formData.append('callback', 'http://127.0.0.1:3000/public/cloudinary_cors.html');
                      formData.append('upload_preset', 'testupload');
                      formData.append('public_id', gid);
                    });
                    myDropzone.on('success', function () {
                      this.element.style.display = 'none';
                    });
                    handleForm.set({
                      name: 'insert-update-listing',
                      submitBtnId: 'ok'
                    });
                    // $('input[name=file]').cloudinary_fileupload();
                    // $('input[name=file]').unsigned_cloudinary_upload('testupload', {
                    //   cloud_name: 'firvain',
                    //   'public_id': gid,
                    // });
                    $('input[name=options]').on('change', function (event) {
                      if ($(this).val() === 'Sale') {
                        $('#pets').prop('disabled', true);
                        $('#pets').prop('checked', false);
                        $('label[for=pets]').removeClass('is-checked');
                        $('#prefered_customer').val('');
                        $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                        $('#prefered_customer').prop('disabled', true);
                      } else {
                        $('#pets').prop('disabled', false);
                        $('#prefered_customer').prop('disabled', false);
                      }
                    });
                    $('#sent-listing').on('click', function (event) {
                      var data;
                      event.preventDefault();
                      data = handleForm.get();
                      if (data !== null) {
                        data.property_gid = gid;
                        $.ajax({
                            url: 'http://127.0.0.1:3000/db/listing',
                            type: 'POST',
                            data: data,
                            dataType: 'text'
                          })
                          .done(function (data, textStatus, jqXHR) {
                            if (jqXHR.status === 201) {
                              toastr.success('Property Updated In Database');
                            } else {
                              toastr.error('Oops Something Went Wrong!!!');
                            }
                          })
                          .fail(function (jqXHR, textStatus, errorThrown) {
                            toastr.error('Oops Something Went Wrong!!!');
                          })
                          .always(function () {
                            handleForm.clear();
                            $('#openModal').addClass('visuallyhidden');
                            select.getFeatures().clear();
                            select.setActive(false);
                          });
                      }
                    });
                    $('#cancel-listing').on('click', function (event) {
                      event.preventDefault();
                      handleForm.clear();
                      select.getFeatures().clear();
                      select.setActive(false);
                      $('#openModal').addClass('visuallyhidden');
                    });
                  });
                });
                $('#no').on('click', function (event) {
                  event.preventDefault();
                  $('#openModal').addClass('visuallyhidden');
                  select.getFeatures().clear();
                  select.setActive(false);
                });
              });
            });
        });
      });
    } else {
      select.getFeatures().clear();
      // select.setActive(false);
      $('.property-info').addClass('visuallyhidden');
      toastr.error('Cant Find Any Property There...');
    }
  });
}
// ====== logout ======
$('#logout').click(function () {
  location.href = '/logout';
});
// ====== insert ======
$('#insertProperty').click(function () {
  var onEndDraw;
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  select.getFeatures().clear();
  select.setActive(false);
  draw.setActive(true);
  onEndDraw = draw.on('drawend', function (event) {
    var obj = {};
    var coords;
    var geocodeObj;
    var latlng;
    var geocodeName_el;
    var geocodeName_en;
    var geocodeAreaName;
    event.preventDefault();
    draw.setActive(false);
    coords = ol.proj.transform(event.feature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
    obj.coords = coords;
    latlng = coords[1] + '\,' + coords[0];
    geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
      latlng: latlng,
      key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ',
    }, function (json, textStatus) {
      return json;
    });
    geocodeObj.then(function () {
      geocodeName_el = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
      geocodeName_en = string_el_to_url(geocodeName_el);
      obj.street_el = geocodeName_el;
      obj.street_en = geocodeName_en;
      geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
      obj.area_name = geocodeAreaName;
      dataForm(obj);
    });

  });

  function dataForm(obj) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyInsert', obj, function (err, out) {
      $('.modal-content').html(out);
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'insertProperty',
        submitBtnId: 'insert'
      });
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val('');
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val('');
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');


        }
      });
      $('#cancelInsert').on('click', function (event) {
        event.preventDefault();
        handleForm.clear();
        drawnProperties.getSource().clear();
        draw.unByKey(onEndDraw);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
      $('#insert').on('click', function (event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (data !== null) {
          data.x = obj.coords[0];
          data.y = obj.coords[1];
          data.adminId = id;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'POST',
            data: data
          })
          .done(function completed() {
            toastr.clear();
            toastr.success('Property Recorded In Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function () {
            event.preventDefault();
            drawnProperties.getSource().clear();
            propertySource.clear();
            handleForm.clear();
            draw.unByKey(onEndDraw);
            $('.modal-dialog').addClass('visuallyhidden');
            map.on('click', clickInfo);
          });
        }
      });
    });
  }
});
// ====== delete ======
$('#deleteProperty').click(function (event) {
  event.preventDefault();
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  select.once('select', function (e) {
    var $toast;
    if (e.target.getFeatures().getLength() === 1) {
      $toast = toastr.warning('<p>Are you sure?</p><div class="toastr-btns"><button id="yesDelete" class="mdl-button mdl-js-button ">Yes</button><button id="noDelete" class="mdl-button mdl-js-button">No</button></div>');
      $toast.on('click', '#yesDelete', function () {
        var gid = select.getFeatures().item(0).get('gid');
        $.ajax({
          url: 'http://127.0.0.1:3000/db/property',
          type: 'DELETE',
          dataType: 'json',
          data: {
            gid: gid
          }
        })
          .done(function completed(data, textStatus, jqXHR) {
            toastr.clear();
            toastr.success('Property Successfully Deleted with id = ' + data.propertygid + ' from Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function always() {
            propertySource.clear();
            select.getFeatures().clear();
            select.setActive(false);
            map.on('click', clickInfo);
          });

        $toast.remove();
      });
      $toast.on('click', '#noDelete', function () {
        $toast.remove();
        select.getFeatures().clear();
        select.setActive(false);
      });
    }
  });
});

// ====== update ======

$('#updateProperty').on('click', function updateProperty(event) {
  var gid;
  var obj;
  var coords;
  var onEndTranslte;
  event.preventDefault();
  toastr.clear();
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  $('.property-info').addClass('visuallyhidden');
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      gid = _.head(e.selected).get('gid');
      selectedFeature = _.head(e.selected);
      coords = ol.proj.transform(selectedFeature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
      $.ajax({
        url: 'http://127.0.0.1:3000/db/property',
        type: 'GET',
        dataType: 'json',
        data: {
          gid: gid
        }
      })
        .done(function completed(data) {
          var $toast = {};
          $toast.options = {};
          obj = _.head(data.features).properties;
          console.log(obj)

          $toast = toastr.warning('<p>Change Property Coordinates?</p><div class="toastr-btns"><button id="yesChangeXY" class="mdl-button mdl-js-button ">Yes</button><button id="noChangeXY" class="mdl-button mdl-js-button">No</button></div>');
          $toast.on('click', '#yesChangeXY', function yesChangeXY() {
            var latlng;
            var geocodeObj;
            var geocodeNameEl;
            var geocodeNameEn;
            var geocodeAreaName;
            translate.setActive(true);
            onEndTranslte = translate.on('translateend', function translateEnd(e) {
              // var geocodeObj;
              coords = ol.proj.transform(e.features.item(0).getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
              latlng = coords[1] + '\,' + coords[0];
              geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
                latlng: latlng,
                key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ'
              }, function (json, textStatus) {
                return json.results;
              });
              geocodeObj.then(function () {
                geocodeNameEl = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
                geocodeNameEn = string_el_to_url(geocodeNameEl);
                obj.street_el = geocodeNameEl;
                obj.street_en = geocodeNameEn;
                geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
                obj.area_name = geocodeAreaName;
                dataForm(obj, coords);
              });
            });
          });
          $toast.on('click', '#noChangeXY', function noChangeXY() {
            translate.setActive(false);
            toastr.clear();
            dataForm(obj, coords);
          });
        })
        .fail(function failed() {
          toastr.error('Oops Something Went Wrong!!!');
        });
    }
  });

  function dataForm(obj, coords) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyUpdate', obj, function renderPropertyUpdate(err, out) {
      var oldValues = {};
      $('.modal-content').html(out);
      oldValues.bedrooms = $('#bedrooms').val();
      oldValues.street_en = $('#street_en').val();
      oldValues.street_el = $('#street_el').val();
      oldValues.area_name = $('#area_name').val();
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'updateProperty',
        submitBtnId: 'update'
      });
      // $('#street_el').val(obj.geocodeName_el);
      // $('#street_en').val(obj.geocodeName_en);
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');
        }
      });
      $('#update').on('click', function update(event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (!_.isNil(data)) {
          data.x = coords[0];
          data.y = coords[1];
          data.gid = gid;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'PUT',
            data: data
          })
            .done(function completed(response, textStatus, jqXHR) {
              toastr.clear();
              toastr.success('Property with gid ' + response.propertygid + ' Updated in Database');
            })
            .fail(function failed(jqXHR, textStatus, errorThrown) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find this property!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            })
            .always(function always() {
              propertySource.clear();
              select.getFeatures().clear();
              select.setActive(false);
              translate.unByKey(onEndTranslte);
              translate.setActive(false);
              map.on('click', clickInfo);
              $('.modal-dialog').addClass('visuallyhidden');
            });
        }
      });
      $('#cancelUpdate').on('click', function cancelUpdate(event) {
        event.preventDefault();
        handleForm.clear();
        propertySource.clear();
        select.getFeatures().clear();
        translate.unByKey(onEndTranslte);
        select.setActive(false);
        translate.setActive(false);
        map.on('click', clickInfo);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
    });
  }

  $('#adminMap').removeAttr('style');
});
$(document).ready(function () {
  window.Parsley.on('field:error', function () {
    // This global callback will be called for any field that fails validation.
    console.log('Validation failed for: ', this.$element);
  });
  window.Parsley
    .addValidator('date', {
      requirementType: 'string',
      validateString: function (value, requirement) {
        if (moment(value, 'DD-MM-YYYY', true).isValid() === true) {
          return true;
        }
        return false;
      },
      messages: {
        en: 'Wrong Date',
        el: 'Λάθος Ημερομηνία'
      }
    });
});

function string_el_to_url(string) {
  var originalString = string;
  var newString;
  var replace = new Array('α', 'ά', 'Ά', 'Α', 'β', 'Β', 'γ', 'Γ', 'δ', 'Δ', 'ε', 'έ', 'Ε', 'Έ', 'ζ', 'Ζ', 'η', 'ή', 'Η', 'θ', 'Θ', 'ι', 'ί', 'ϊ', 'ΐ', 'Ι', 'Ί', 'κ', 'Κ', 'λ', 'Λ', 'μ', 'Μ', 'ν', 'Ν', 'ξ', 'Ξ', 'ο', 'ό', 'Ο', 'Ό', 'π', 'Π', 'ρ', 'Ρ', 'σ', 'ς', 'Σ', 'τ', 'Τ', 'υ', 'ύ', 'Υ', 'Ύ', 'φ', 'Φ', 'χ', 'Χ', 'ψ', 'Ψ', 'ω', 'ώ', 'Ω', 'Ώ', ' ', '\'', '\'', ',');
  var replace_n = new Array('a', 'a', 'A', 'A', 'v', 'V', 'g', 'G', 'd', 'D', 'e', 'e', 'E', 'E', 'z', 'Z', 'i', 'i', 'I', 'th', 'Th', 'i', 'i', 'i', 'i', 'I', 'I', 'k', 'K', 'l', 'L', 'm', 'M', 'n', 'N', 'x', 'X', 'o', 'o', 'O', 'O', 'p', 'P', 'r', 'R', 's', 's', 'S', 't', 'T', 'u', 'u', 'Y', 'Y', 'f', 'F', 'ch', 'Ch', 'ps', 'Ps', 'o', 'o', 'O', 'O', ' ', '_', '_', '_');

  for (var i = 0; i < replace.length; i++) {
    originalString = originalString.replace(new RegExp(replace[i], 'g'), replace_n[i]);
  }
  newString = originalString;
  return newString;
}
$(document)
  .ajaxStart(function () {
    $loading.addClass('is-active');
  })
  .ajaxStop(function () {
    $loading.removeClass('is-active');
  });

var handleForm = (function ($, parsley) {
  'use strict';
  var formName, submitBtnId, p;

  function setOptions(options) {
    formName = options.name;
    submitBtnId = options.submitBtnId;
    enableSelect();
  }
  function enableSelect() {
    var e = $('.getmdl-select');
    e.each(function () {
      addEventListeners(this);
    });
  }
  function addEventListeners(e) {
    var t = e.querySelector('input'),
      n = e.querySelectorAll('li');
    e.querySelector('i');
    [].forEach.call(n, function (e) {
      e.onclick = function () {
        t.value = e.textContent;
      };
    });
  }
  function disableSubmitBtn() {
    $('#' + submitBtnId + '').prop('disabled', true);
  }

  function createValidator() {
    p = $('form[name="' + formName + '"').parsley();
    return true;
  }

  function destroyValidator() {
    p.destroy();
  }

  function validateForm() {
    return p.validate();
  }

  function onValidateFormSuccess() {
    p.on('form:success',

      function () {});
  }
  function setAttributes(atr) {
    $('#street_el').val(atr.street_el);
    $('#street_en').val(atr.street_en);
  }
  function getAttributes() {
    var obj = {};
    createValidator();
    if (validateForm() === true) {
      $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-radio__button').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-selectfield__select').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      return obj;
    }
    else return null;
  }

  function resetForm() {
    if (createValidator() == true) {
      destroyValidator();
    }
    $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

      function (index, element) {
        $(this).val('');
        $(this).parent().eq(0).removeClass('is-dirty');
        $(this).parent().eq(0).removeClass('is-invalid');
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

      function (index, element) {
        $(this).prop('checked', false);
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox').each(

      function (index, element) {
        $(this).removeClass('is-checked');
      });
  }
  return {
    set: setOptions,
    get: getAttributes,
    clear: resetForm,
    setAttributes: setAttributes,
  // createValidator: createValidator,
  // destroyValidator: destroyValidator,
  // validateForm: validateForm,
  // onValidateFormSuccess: onValidateFormSuccess,
  // disableSubmitBtn: disableSubmitBtn
  };
}(jQuery, parsley));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFkbWluLmpzIiwiaGFuZGxlRm9ybS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3Q1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhZG1pbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgJGxvYWRpbmcgPSAkKCcubWRsLXNwaW5uZXInKTtcclxuXHJcbnZhciBjZW50ZXIgPSBbMzY3NzM4NSwgNDEyMDk0OV07XHJcbnZhciBleHRlbnQgPSBbMzU5MDA5NCwgNDEwMjgzMywgMzg1NTQ4MywgNDI2MTIxMV07XHJcbnZhciBsYW5nID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmxhbmc7XHJcbnZhciBnZW9KU09ORm9ybWF0ID0gbmV3IG9sLmZvcm1hdC5HZW9KU09OKHtcclxuICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbn0pO1xyXG52YXIgcHJvcGVydHlTb3VyY2U7XHJcbnZhciBwcm9wZXJ0eTtcclxudmFyIG1hcDtcclxudmFyIGZlYXR1cmVzO1xyXG52YXIgZHJhd25Qcm9wZXJ0aWVzO1xyXG52YXIgZHJhdztcclxudmFyIHNlbGVjdDtcclxudmFyIHRyYW5zbGF0ZTtcclxudmFyIGJpbmc7XHJcbnZhciBtYXBib3g7XHJcbnRvYXN0ci5vcHRpb25zID0ge1xyXG4gIGNsb3NlQnV0dG9uOiBmYWxzZSxcclxuICBkZWJ1ZzogZmFsc2UsXHJcbiAgbmV3ZXN0T25Ub3A6IGZhbHNlLFxyXG4gIHByb2dyZXNzQmFyOiBmYWxzZSxcclxuICBwb3NpdGlvbkNsYXNzOiAndG9hc3QtdG9wLWNlbnRlcicsXHJcbiAgcHJldmVudER1cGxpY2F0ZXM6IGZhbHNlLFxyXG4gIG9uY2xpY2s6IG51bGwsXHJcbiAgc2hvd0R1cmF0aW9uOiAnMzAwJyxcclxuICBoaWRlRHVyYXRpb246ICcxMDAwJyxcclxuICB0aW1lT3V0OiAnNTAwMCcsXHJcbiAgZXh0ZW5kZWRUaW1lT3V0OiAnMTAwMCcsXHJcbiAgc2hvd0Vhc2luZzogJ3N3aW5nJyxcclxuICBoaWRlRWFzaW5nOiAnbGluZWFyJyxcclxuICBzaG93TWV0aG9kOiAnZmFkZUluJyxcclxuICBoaWRlTWV0aG9kOiAnZmFkZU91dCdcclxufTtcclxuYmluZyA9IG5ldyBvbC5sYXllci5UaWxlKHtcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5CaW5nTWFwcyh7XHJcbiAgICBrZXk6ICdBazJHcThWVWZJQ3NQcHVmN0xSQU5YbVh0MnNIV21TTFBob2htVkxGdEZJRXdZanNfNU1DeUFoQUZ3UlNWcExqJyxcclxuICAgIGltYWdlcnlTZXQ6ICdBZXJpYWwnXHJcbiAgfSksXHJcbiAgbWF4Wm9vbTogMTksXHJcbiAgY3Jvc3NPcmlnaW46ICdhbm9ueW1vdXMnLFxyXG4gIHByZWxvYWQ6IEluZmluaXR5LFxyXG4gIGlkOiAnYmluZydcclxufSk7XHJcbm1hcGJveCA9IG5ldyBvbC5sYXllci5UaWxlKHtcclxuICBzb3VyY2U6IG5ldyBvbC5zb3VyY2UuWFlaKHtcclxuICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgIGh0bWw6ICc8YSBocmVmPVwiaHR0cHM6Ly93d3cubWFwYm94LmNvbS9hYm91dC9tYXBzL1wiIHRhcmdldD1cIl9ibGFua1wiPiZjb3B5OyBNYXBib3ggJmNvcHk7IE9wZW5TdHJlZXRNYXA8L2E+J1xyXG4gICAgfSldLFxyXG4gICAgdXJsOiAnaHR0cHM6Ly9hcGkubWFwYm94LmNvbS92NC9tYXBib3guc3RyZWV0cy97en0ve3h9L3t5fS5wbmc/YWNjZXNzX3Rva2VuPXBrLmV5SjFJam9pWm1seWRtRnBiaUlzSW1FaU9pSmxPV1l5WVRNME5UaGlOV00wWWpKak9ESmpOREU0T0RRek56QTJNR1F5TmlKOS4tTlZETzI3SHp0LXdfblFvc1VQZkxBJ1xyXG4gIH0pLFxyXG4gIGlkOiAnbWFwYm94J1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGdldEljb25UeXBlKGVzdGF0ZVR5cGUpIHtcclxuICB2YXIgaWNvblR5cGUgPSB7XHJcbiAgICBBcGFydG1lbnQ6IGZ1bmN0aW9uIGdldEFwYXJ0bWVudEljb24oKSB7XHJcbiAgICAgIHJldHVybiAnYXBhcnRtZW50JztcclxuICAgIH0sXHJcbiAgICBTdG9yZTogZnVuY3Rpb24gZ2V0U3RvcmVJY29uKCkge1xyXG4gICAgICByZXR1cm4gJ3N0b3JlJztcclxuICAgIH0sXHJcbiAgICAnRGV0YWNoZWQgSG91c2UnOiBmdW5jdGlvbiBnZXREZXRhY2hlZEhvdXNlSWNvbigpIHtcclxuICAgICAgcmV0dXJuICdkZXRhY2hlZCc7XHJcbiAgICB9LFxyXG4gICAgTWFpc29uZXR0ZTogZnVuY3Rpb24gZ2V0TWFpc29uZXR0ZUljb24oKSB7XHJcbiAgICAgIHJldHVybiAnbWFpc29uZXR0ZSc7XHJcbiAgICB9LFxyXG4gICAgVmlsbGE6IGZ1bmN0aW9uIGdldFZpbGxhSW9uKCkge1xyXG4gICAgICByZXR1cm4gJ3ZpbGxhJztcclxuICAgIH1cclxuICB9O1xyXG4gIHJldHVybiAoaWNvblR5cGVbZXN0YXRlVHlwZV0pKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEljb25QYXRoKGxpc3RpbmdUeXBlKSB7XHJcbiAgdmFyIGljb25QYXRoID0ge1xyXG4gICAgdHJ1ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvc2FsZS8nO1xyXG4gICAgfSxcclxuICAgIGZhbHNlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9yZW50Lyc7XHJcbiAgICB9LFxyXG4gICAgbm9uZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvbm9uZS8nO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgcmV0dXJuIChpY29uUGF0aFtsaXN0aW5nVHlwZV0pKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIFByb3BlcnR5U3R5bGUoZmVhdHVyZSkge1xyXG4gIHZhciBzcmM7XHJcbiAgc3JjID0gZ2V0SWNvblBhdGgoJ25vbmUnKSArIGdldEljb25UeXBlKGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlX2VuJykpICsgJy00OC5wbmcnO1xyXG4gIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogW1xyXG4gICAgICAgIDAuNSwgMFxyXG4gICAgICBdLFxyXG4gICAgICBzY2FsZTogMVxyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxucHJvcGVydHlTb3VyY2UgPSBuZXcgb2wuc291cmNlLlZlY3Rvcih7XHJcbiAgZm9ybWF0OiBnZW9KU09ORm9ybWF0LFxyXG4gIGxvYWRlcjogZnVuY3Rpb24gKGV4dGVudCwgcmVzb2x1dGlvbiwgcHJvamVjdGlvbikge1xyXG4gICAgdmFyIHVybCA9ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHkvJyArIGlkO1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgLy8gc2VsZi5jbGVhcigpO1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgdXJsOiB1cmwsXHJcbiAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAvLyBiZWZvcmVTZW5kOiBmdW5jdGlvbiAoeGhyKSB7XHJcbiAgICAgIC8vICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCd1c2VyVG9rZW4nKSkge1xyXG4gICAgICAvLyAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCAnQmVhcmVyICcgKyBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlclRva2VuJykpO1xyXG4gICAgICAvLyAgIH1cclxuICAgICAgLy8gfSxcclxuICAgICAgZGF0YVR5cGU6ICdqc29uJ1xyXG4gICAgfSlcclxuICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICB2YXIgbmV3RmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLCB7XHJcbiAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgIH0pO1xyXG4gICAgICBzZWxmLmFkZEZlYXR1cmVzKG5ld0ZlYXR1cmVzKTtcclxuICAgIH0pXHJcbiAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCB0aGlzIHByb3BlcnR5IScpO1xyXG4gICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59KTtcclxucHJvcGVydHkgPSBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICBzb3VyY2U6IHByb3BlcnR5U291cmNlLFxyXG4gIGlkOiAncHJvcGVydHknLFxyXG4gIHZpc2libGU6IHRydWUsXHJcbiAgc3R5bGU6IFByb3BlcnR5U3R5bGVcclxufSk7XHJcbnByb3BlcnR5LnNldFpJbmRleCgyKTtcclxubWFwID0gbmV3IG9sLk1hcCh7XHJcbiAgdGFyZ2V0OiAnYWRtaW5NYXAnLFxyXG4gIGxheWVyczogW1xyXG4gICAgbWFwYm94LCBwcm9wZXJ0eVxyXG4gIF0sXHJcbiAgbG9hZFRpbGVzV2hpbGVBbmltYXRpbmc6IHRydWUsXHJcbiAgbG9hZFRpbGVzV2hpbGVJbnRlcmFjdGluZzogdHJ1ZSxcclxuICByZW5kZXJlcjogJ2NhbnZhcycsXHJcbiAgY29udHJvbHM6IG9sLmNvbnRyb2wuZGVmYXVsdHMoe1xyXG4gICAgYXR0cmlidXRpb25PcHRpb25zOiB7XHJcbiAgICAgIGNvbGxhcHNpYmxlOiBmYWxzZSxcclxuICAgICAgY29sbGFwc2VkOiBmYWxzZVxyXG4gICAgfVxyXG4gIH0pLmV4dGVuZChbXHJcbiAgICBuZXcgb2wuY29udHJvbC5TY2FsZUxpbmUoe1xyXG4gICAgICB1bml0czogJ21ldHJpYydcclxuICAgIH0pLFxyXG4gICAgbmV3IG9sLmNvbnRyb2wuT3ZlcnZpZXdNYXAoe1xyXG4gICAgICBjbGFzc05hbWU6ICdvbC1vdmVydmlld21hcCBvbC1jdXN0b20tb3ZlcnZpZXdtYXAnLFxyXG4gICAgICBjb2xsYXBzaWJsZTogdHJ1ZSxcclxuICAgICAgY29sbGFwc2VkOiB0cnVlLFxyXG4gICAgICBsYXllcnM6IFtiaW5nXVxyXG4gICAgfSksXHJcbiAgICBuZXcgb2wuY29udHJvbC5ab29tVG9FeHRlbnQoe1xyXG4gICAgICBleHRlbnQ6IGV4dGVudFxyXG4gICAgfSlcclxuICBdKSxcclxuICB2aWV3OiBuZXcgb2wuVmlldyh7XHJcbiAgICBjZW50ZXI6IGNlbnRlcixcclxuICAgIC8vIGV4dGVudDogZXh0ZW50LFxyXG4gICAgcHJvamVjdGlvbjogJ0VQU0c6Mzg1NycsXHJcbiAgICB6b29tOiAxNCxcclxuICAgIG1heFpvb206IDE5LFxyXG4gICAgbWluWm9vbTogMTBcclxuICB9KVxyXG59KTtcclxuaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICBiaW5nLnNldCgnbmFtZScsICfOlM6/z4HPhc+Gzr/Pgc65zrrOriDOtc65zrrPjM69zrEnKTtcclxuICBtYXBib3guc2V0KCduYW1lJywgJ86nzqzPgc+EzrfPgicpO1xyXG4gIHByb3BlcnR5LnNldCgnbmFtZScsICfOkc66zq/Ovc63z4TOsScpO1xyXG59IGVsc2Uge1xyXG4gIGJpbmcuc2V0KCduYW1lJywgJ1NhdHRlbGl0ZSBJbWFnZScpO1xyXG4gIG1hcGJveC5zZXQoJ25hbWUnLCAnTWFwJyk7XHJcbiAgcHJvcGVydHkuc2V0KCduYW1lJywgJ1Byb3BlcnRpZXMnKTtcclxufVxyXG4vLyA9PT09PT0gaW50ZXJhY3Rpb25zID09PT09PVxyXG5mZWF0dXJlcyA9IG5ldyBvbC5Db2xsZWN0aW9uKCk7XHJcblxyXG5mdW5jdGlvbiBkcmF3blByb3BlcnRpZXNTdHlsZShjb2xvcikge1xyXG4gIHZhciBzcmM7XHJcbiAgc3JjID0gJy4vaW1hZ2VzL3BpbnMvZ2VuZXJpYy00OC5wbmcnO1xyXG4gIGlmICh0eXBlb2YgY29sb3IgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgICAgc3JjOiBzcmMsXHJcbiAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgIGFuY2hvcjogW1xyXG4gICAgICAgICAgMC41LCAwXHJcbiAgICAgICAgXSxcclxuICAgICAgICBzY2FsZTogMSxcclxuICAgICAgICBjb2xvcjogY29sb3JcclxuICAgICAgfSkpXHJcbiAgICB9KTtcclxuICB9XHJcbiAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgc3JjOiBzcmMsXHJcbiAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgYW5jaG9yOiBbXHJcbiAgICAgICAgMC41LCAwXHJcbiAgICAgIF0sXHJcbiAgICAgIHNjYWxlOiAxXHJcbiAgICB9KSlcclxuICB9KTtcclxufVxyXG5kcmF3blByb3BlcnRpZXMgPSBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICBzb3VyY2U6IG5ldyBvbC5zb3VyY2UuVmVjdG9yKCksXHJcbiAgaWQ6ICdkcmF3blByb3BlcnRpZXMnLFxyXG4gIHN0eWxlOiBkcmF3blByb3BlcnRpZXNTdHlsZSgnIzRjYWY1MCcpXHJcbn0pO1xyXG5tYXAuYWRkTGF5ZXIoZHJhd25Qcm9wZXJ0aWVzKTtcclxuLy8gZHJhd1xyXG5kcmF3ID0gbmV3IG9sLmludGVyYWN0aW9uLkRyYXcoe1xyXG4gIC8vIGZlYXR1cmVzOiBmZWF0dXJlcyxcclxuICBzb3VyY2U6IGRyYXduUHJvcGVydGllcy5nZXRTb3VyY2UoKSxcclxuICB0eXBlOiAnUG9pbnQnLFxyXG4gIHN0eWxlOiBkcmF3blByb3BlcnRpZXNTdHlsZSgnIzRjYWY1MCcpXHJcbn0pO1xyXG5tYXAuYWRkSW50ZXJhY3Rpb24oZHJhdyk7XHJcbmRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuLy8gc2VsZWN0XHJcbmZ1bmN0aW9uIHNlbGVjdGVkU3R5bGUoZmVhdHVyZSkge1xyXG4gIHZhciBzcmM7XHJcbiAgc3JjID0gZ2V0SWNvblBhdGgoJ25vbmUnKSArIGdldEljb25UeXBlKGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlX2VuJykpICsgJy02NC5wbmcnO1xyXG4gIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgIHNjYWxlOiAxLFxyXG4gICAgICBjb2xvcjogJyNmZmViM2InXHJcbiAgICB9KSlcclxuICB9KTtcclxufVxyXG5zZWxlY3QgPSBuZXcgb2wuaW50ZXJhY3Rpb24uU2VsZWN0KHtcclxuICBsYXllcnM6IFtwcm9wZXJ0eV0sXHJcbiAgZmVhdHVyZXM6IGZlYXR1cmVzLFxyXG4gIG11bHRpOiBmYWxzZSxcclxuICBzdHlsZTogc2VsZWN0ZWRTdHlsZVxyXG59KTtcclxubWFwLmFkZEludGVyYWN0aW9uKHNlbGVjdCk7XHJcbnNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG50cmFuc2xhdGUgPSBuZXcgb2wuaW50ZXJhY3Rpb24uVHJhbnNsYXRlKHtcclxuICBmZWF0dXJlczogc2VsZWN0LmdldEZlYXR1cmVzKClcclxufSk7XHJcbm1hcC5hZGRJbnRlcmFjdGlvbih0cmFuc2xhdGUpO1xyXG50cmFuc2xhdGUuc2V0QWN0aXZlKGZhbHNlKTtcclxuLy8gPT09PT09IGluZm8gPT09PT09XHJcbm1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG5cclxuZnVuY3Rpb24gY2xpY2tJbmZvKGV2ZW50KSB7XHJcbiAgdmFyIG9iaiA9IHt9O1xyXG5cclxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIHNlbGVjdC5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgc2VsZWN0Lm9uY2UoJ3NlbGVjdCcsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICB2YXIgc2VsZWN0ZWRGZWF0dXJlcyA9IGUuc2VsZWN0ZWQ7XHJcbiAgICB2YXIgbGVuZ3RoID0gc2VsZWN0ZWRGZWF0dXJlcy5sZW5ndGg7XHJcbiAgICB2YXIgc2VsZWN0ZWRGZWF0dXJlO1xyXG4gICAgaWYgKGxlbmd0aCA9PT0gMSkge1xyXG4gICAgICBvYmouZmVhdHVyZSA9IHt9O1xyXG4gICAgICBzZWxlY3RlZEZlYXR1cmUgPSBfLmhlYWQoZS5zZWxlY3RlZCk7XHJcbiAgICAgIC8vIGNsaWNrZWRGZWF0dXJlLmZlYXR1cmUuc2V0U2NhbGUoMS4yKTtcclxuICAgICAgc2VsZWN0ZWRGZWF0dXJlLmdldEtleXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICBvYmouZmVhdHVyZVtrZXldID0gc2VsZWN0ZWRGZWF0dXJlLmdldChrZXkpO1xyXG4gICAgICB9KTtcclxuICAgICAgZHVzdC5yZW5kZXIoJ2FkbWluUHJvcGVydHlJbmZvJywgb2JqLCBmdW5jdGlvbiAoZXJyLCBvdXQpIHtcclxuICAgICAgICAkKCcucHJvcGVydHktaW5mbycpLmh0bWwob3V0KTtcclxuICAgICAgICAkKCcucHJvcGVydHktaW5mbycpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICAgICQoJyNsaXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICB2YXIgZ2lkO1xyXG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgIGdpZCA9ICQodGhpcykuZGF0YSgnZ2lkJyk7XHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9saXN0aW5nJyxcclxuICAgICAgICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLFxyXG4gICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGdpZDogZ2lkLFxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZGF0YSk7XHJcbiAgICAgICAgICAgICAgdmFyIGxpc3RpbmdfaWQgPSBkYXRhLmlkO1xyXG4gICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5jc3MoJ3dpZHRoJywgJ2F1dG8nKTtcclxuICAgICAgICAgICAgICAkKCcubW9kYWwtZGlhbG9nJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgZHVzdC5yZW5kZXIoJ2xpc3RpbmdJbnNlcnQnLCBkYXRhLCBmdW5jdGlvbiAoZXJyLCBvdXQpIHtcclxuICAgICAgICAgICAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLnNldCh7XHJcbiAgICAgICAgICAgICAgICAgIG5hbWU6ICdpbnNlcnQtdXBkYXRlLWxpc3RpbmcnLFxyXG4gICAgICAgICAgICAgICAgICBzdWJtaXRCdG5JZDogJ29rJyxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCQoJ2lucHV0W25hbWU9b3B0aW9uc106Y2hlY2tlZCcpLnZhbCgpID09PSAnU2FsZScpIHtcclxuICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wYXJlbnQoKS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnBhcmVudCgpLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICQoJ2lucHV0W25hbWU9b3B0aW9uc10nKS5vbignY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLnZhbCgpID09PSAnU2FsZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdjaGVja2VkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucGFyZW50KCkuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJ2xhYmVsW2Zvcj1wZXRzXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykudmFsKCcnKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnBhcmVudCgpLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucGFyZW50KCkuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnBhcmVudCgpLnNob3coKTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAkKCcjc2VudC1saXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIHZhciBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICBkYXRhID0gaGFuZGxlRm9ybS5nZXQoKTtcclxuICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLnByb3BlcnR5X2dpZCA9IGdpZDtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmxpc3RpbmdfaWQgPSBsaXN0aW5nX2lkO1xyXG4gICAgICAgICAgICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9saXN0aW5nJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BVVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCdcclxuICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAuZG9uZShmdW5jdGlvbiAoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoJ1Byb3BlcnR5IFVwZGF0ZWQgSW4gRGF0YWJhc2UnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ09vcHMgU29tZXRoaW5nIFdlbnQgV3JvbmchISEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdPb3BzIFNvbWV0aGluZyBXZW50IFdyb25nISEhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICQoJyNjYW5jZWwtbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmZhaWwoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIHZhciBvYmogPSB7fTtcclxuICAgICAgICAgICAgICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICAgICAgICAgICAgb2JqLm1zZyA9ICfOlM61zr0gzpLPgc6tzrjOt866zrUgzpHOs86zzrXOu86vzrEnO1xyXG4gICAgICAgICAgICAgICAgb2JqLnRleHQgPSAnzpTOt868zrnOv8+Fz4HOs86vzrEgzprOsc65zr3Ov8+Nz4HOs865zrHPgjsnO1xyXG4gICAgICAgICAgICAgICAgb2JqLnllcyA9ICfOnc6RzpknO1xyXG4gICAgICAgICAgICAgICAgb2JqLm5vID0gJ86fzqfOmSc7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9iai5tc2cgPSAnTm8gTGlzdGluZyBGb3VuZCc7XHJcbiAgICAgICAgICAgICAgICBvYmoudGV4dCA9ICdDcmVhdGUgTmV3IExpc3Rpbmc/JztcclxuICAgICAgICAgICAgICAgIG9iai55ZXMgPSAnWUVTJztcclxuICAgICAgICAgICAgICAgIG9iai5ubyA9ICdOTyc7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGR1c3QucmVuZGVyKCdkaWFsb2cnLCBvYmosIGZ1bmN0aW9uIChlcnJvciwgb3V0KSB7XHJcbiAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuY3NzKCd3aWR0aCcsICdhdXRvJyk7XHJcbiAgICAgICAgICAgICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICAgICAgICAgICAgJCgnI3llcycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICBkdXN0LnJlbmRlcignbGlzdGluZ0luc2VydCcsIHtcclxuICAgICAgICAgICAgICAgICAgICByZW50OiAndHJ1ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgYWRkSW1hZ2U6ICd0cnVlJyxcclxuICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG15RHJvcHpvbmU7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbXlEcm9wem9uZSA9IG5ldyBEcm9wem9uZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZHJvcHpvbmUnKSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdXBsb2FkTXVsdGlwbGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgYWNjZXB0ZWRGaWxlczogJy5qcGcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgcGFyYWxsZWxVcGxvYWRzOiA2LFxyXG4gICAgICAgICAgICAgICAgICAgICAgLy8gYWRkUmVtb3ZlTGlua3MgOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9hcGkuY2xvdWRpbmFyeS5jb20vdjFfMS9maXJ2YWluL2F1dG8vdXBsb2FkJ1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIG15RHJvcHpvbmUub24oJ3NlbmRpbmcnLCBmdW5jdGlvbiAoZmlsZSwgeGhyLCBmb3JtRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdhcGlfa2V5JywgMzc1MTM4OTMyNjg5NTkxKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnY2FsbGJhY2snLCAnaHR0cDovLzEyNy4wLjAuMTozMDAwL3B1YmxpYy9jbG91ZGluYXJ5X2NvcnMuaHRtbCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCd1cGxvYWRfcHJlc2V0JywgJ3Rlc3R1cGxvYWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncHVibGljX2lkJywgZ2lkKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBteURyb3B6b25lLm9uKCdzdWNjZXNzJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5zZXQoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2luc2VydC11cGRhdGUtbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgICAgICAgICBzdWJtaXRCdG5JZDogJ29rJ1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICQoJ2lucHV0W25hbWU9ZmlsZV0nKS5jbG91ZGluYXJ5X2ZpbGV1cGxvYWQoKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAkKCdpbnB1dFtuYW1lPWZpbGVdJykudW5zaWduZWRfY2xvdWRpbmFyeV91cGxvYWQoJ3Rlc3R1cGxvYWQnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICBjbG91ZF9uYW1lOiAnZmlydmFpbicsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAncHVibGljX2lkJzogZ2lkLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJ2lucHV0W25hbWU9b3B0aW9uc10nKS5vbignY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ1NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdjaGVja2VkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCdsYWJlbFtmb3I9cGV0c10nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS52YWwoJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNzZW50LWxpc3RpbmcnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBoYW5kbGVGb3JtLmdldCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wcm9wZXJ0eV9naWQgPSBnaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLmRvbmUoZnVuY3Rpb24gKGRhdGEsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSAyMDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoJ1Byb3BlcnR5IFVwZGF0ZWQgSW4gRGF0YWJhc2UnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLmZhaWwoZnVuY3Rpb24gKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdPb3BzIFNvbWV0aGluZyBXZW50IFdyb25nISEhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAuYWx3YXlzKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjY2FuY2VsLWxpc3RpbmcnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAkKCcjbm8nKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAvLyBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgJCgnLnByb3BlcnR5LWluZm8nKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgdG9hc3RyLmVycm9yKCdDYW50IEZpbmQgQW55IFByb3BlcnR5IFRoZXJlLi4uJyk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuLy8gPT09PT09IGxvZ291dCA9PT09PT1cclxuJCgnI2xvZ291dCcpLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuICBsb2NhdGlvbi5ocmVmID0gJy9sb2dvdXQnO1xyXG59KTtcclxuLy8gPT09PT09IGluc2VydCA9PT09PT1cclxuJCgnI2luc2VydFByb3BlcnR5JykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gIHZhciBvbkVuZERyYXc7XHJcbiAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgJCgnLnByb3BlcnR5LWluZm8nKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICBtYXAudW4oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gIGRyYXcuc2V0QWN0aXZlKHRydWUpO1xyXG4gIG9uRW5kRHJhdyA9IGRyYXcub24oJ2RyYXdlbmQnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciBvYmogPSB7fTtcclxuICAgIHZhciBjb29yZHM7XHJcbiAgICB2YXIgZ2VvY29kZU9iajtcclxuICAgIHZhciBsYXRsbmc7XHJcbiAgICB2YXIgZ2VvY29kZU5hbWVfZWw7XHJcbiAgICB2YXIgZ2VvY29kZU5hbWVfZW47XHJcbiAgICB2YXIgZ2VvY29kZUFyZWFOYW1lO1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgIGNvb3JkcyA9IG9sLnByb2oudHJhbnNmb3JtKGV2ZW50LmZlYXR1cmUuZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpLCAnRVBTRzozODU3JywgJ0VQU0c6NDMyNicpO1xyXG4gICAgb2JqLmNvb3JkcyA9IGNvb3JkcztcclxuICAgIGxhdGxuZyA9IGNvb3Jkc1sxXSArICdcXCwnICsgY29vcmRzWzBdO1xyXG4gICAgZ2VvY29kZU9iaiA9ICQuZ2V0SlNPTignaHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbicsIHtcclxuICAgICAgbGF0bG5nOiBsYXRsbmcsXHJcbiAgICAgIGtleTogJ0FJemFTeUNrSDM5X0V6MjFfUmxDX3BqWEQwOXpwSl8gLSBlVmh6Q3JRJyxcclxuICAgIH0sIGZ1bmN0aW9uIChqc29uLCB0ZXh0U3RhdHVzKSB7XHJcbiAgICAgIHJldHVybiBqc29uO1xyXG4gICAgfSk7XHJcbiAgICBnZW9jb2RlT2JqLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICBnZW9jb2RlTmFtZV9lbCA9IF8uaGVhZChfLmhlYWQoZ2VvY29kZU9iai5yZXNwb25zZUpTT04ucmVzdWx0cykuYWRkcmVzc19jb21wb25lbnRzKS5sb25nX25hbWU7XHJcbiAgICAgIGdlb2NvZGVOYW1lX2VuID0gc3RyaW5nX2VsX3RvX3VybChnZW9jb2RlTmFtZV9lbCk7XHJcbiAgICAgIG9iai5zdHJlZXRfZWwgPSBnZW9jb2RlTmFtZV9lbDtcclxuICAgICAgb2JqLnN0cmVldF9lbiA9IGdlb2NvZGVOYW1lX2VuO1xyXG4gICAgICBnZW9jb2RlQXJlYU5hbWUgPSBfLmZpcnN0KF8uZHJvcChfLm1hcChfLmhlYWQoZ2VvY29kZU9iai5yZXNwb25zZUpTT04ucmVzdWx0cykuYWRkcmVzc19jb21wb25lbnRzLCAnbG9uZ19uYW1lJykpKTtcclxuICAgICAgb2JqLmFyZWFfbmFtZSA9IGdlb2NvZGVBcmVhTmFtZTtcclxuICAgICAgZGF0YUZvcm0ob2JqKTtcclxuICAgIH0pO1xyXG5cclxuICB9KTtcclxuXHJcbiAgZnVuY3Rpb24gZGF0YUZvcm0ob2JqKSB7XHJcbiAgICAkKCcubW9kYWwtZGlhbG9nJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICBkdXN0LnJlbmRlcigncHJvcGVydHlJbnNlcnQnLCBvYmosIGZ1bmN0aW9uIChlcnIsIG91dCkge1xyXG4gICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgIGhhbmRsZUZvcm0uc2V0KHtcclxuICAgICAgICBuYW1lOiAnaW5zZXJ0UHJvcGVydHknLFxyXG4gICAgICAgIHN1Ym1pdEJ0bklkOiAnaW5zZXJ0J1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5jaGFuZ2UoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzpzOv869zr/Ous6xz4TOv865zrrOr86xJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ0RldGFjaGVkIEhvdXNlJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ0RldGFjaGVkIEhvdXNlJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86UzrnOsc68zq3Pgc65z4POvM6xJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdBcGFydG1lbnQnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzojPgM6xz4XOu863Jykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ1ZpbGxhJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ1ZpbGxhJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnTWFpc29uZXR0ZScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdNYWlzb25ldHRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5jaGFuZ2UoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICgkKHRoaXMpLnZhbCgpID09PSAnRGV0YWNoZWQgSG91c2UnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpzOv869zr/Ous6xz4TOv865zrrOr86xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICdBcGFydG1lbnQnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpTOuc6xzrzOrc+BzrnPg868zrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpTOuc6xzrzOrc+BzrnPg868zrEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnVmlsbGEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzojPgM6xz4XOu863Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86Iz4DOsc+FzrvOtycpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86czrXOts6/zr3Orc+EzrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpzOtc62zr/Ovc6tz4TOsScpO1xyXG5cclxuXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2NhbmNlbEluc2VydCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgIGRyYXduUHJvcGVydGllcy5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgIGRyYXcudW5CeUtleShvbkVuZERyYXcpO1xyXG4gICAgICAgICQoJy5tb2RhbC1kaWFsb2cnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNpbnNlcnQnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgZGF0YTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGRhdGEgPSBoYW5kbGVGb3JtLmdldCgpO1xyXG4gICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XHJcbiAgICAgICAgICBkYXRhLnggPSBvYmouY29vcmRzWzBdO1xyXG4gICAgICAgICAgZGF0YS55ID0gb2JqLmNvb3Jkc1sxXTtcclxuICAgICAgICAgIGRhdGEuYWRtaW5JZCA9IGlkO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3Byb3BlcnR5JyxcclxuICAgICAgICAgICAgdHlwZTogJ1BPU1QnLFxyXG4gICAgICAgICAgICBkYXRhOiBkYXRhXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmRvbmUoZnVuY3Rpb24gY29tcGxldGVkKCkge1xyXG4gICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoJ1Byb3BlcnR5IFJlY29yZGVkIEluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgdGhpcyBwcm9wZXJ0eSEnKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZScpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuYWx3YXlzKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgZHJhd25Qcm9wZXJ0aWVzLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICAgICAgZHJhdy51bkJ5S2V5KG9uRW5kRHJhdyk7XHJcbiAgICAgICAgICAgICQoJy5tb2RhbC1kaWFsb2cnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG59KTtcclxuLy8gPT09PT09IGRlbGV0ZSA9PT09PT1cclxuJCgnI2RlbGV0ZVByb3BlcnR5JykuY2xpY2soZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICB0b2FzdHIuY2xlYXIoKTtcclxuICAkKCcucHJvcGVydHktaW5mbycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gIG1hcC51bignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICBmZWF0dXJlcy5jbGVhcigpO1xyXG4gIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICBzZWxlY3Quc2V0QWN0aXZlKHRydWUpO1xyXG4gIHNlbGVjdC5vbmNlKCdzZWxlY3QnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgdmFyICR0b2FzdDtcclxuICAgIGlmIChlLnRhcmdldC5nZXRGZWF0dXJlcygpLmdldExlbmd0aCgpID09PSAxKSB7XHJcbiAgICAgICR0b2FzdCA9IHRvYXN0ci53YXJuaW5nKCc8cD5BcmUgeW91IHN1cmU/PC9wPjxkaXYgY2xhc3M9XCJ0b2FzdHItYnRuc1wiPjxidXR0b24gaWQ9XCJ5ZXNEZWxldGVcIiBjbGFzcz1cIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvbiBcIj5ZZXM8L2J1dHRvbj48YnV0dG9uIGlkPVwibm9EZWxldGVcIiBjbGFzcz1cIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvblwiPk5vPC9idXR0b24+PC9kaXY+Jyk7XHJcbiAgICAgICR0b2FzdC5vbignY2xpY2snLCAnI3llc0RlbGV0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgZ2lkID0gc2VsZWN0LmdldEZlYXR1cmVzKCkuaXRlbSgwKS5nZXQoJ2dpZCcpO1xyXG4gICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHknLFxyXG4gICAgICAgICAgdHlwZTogJ0RFTEVURScsXHJcbiAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLFxyXG4gICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICBnaWQ6IGdpZFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSBTdWNjZXNzZnVsbHkgRGVsZXRlZCB3aXRoIGlkID0gJyArIGRhdGEucHJvcGVydHlnaWQgKyAnIGZyb20gRGF0YWJhc2UnKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCB0aGlzIHByb3BlcnR5IScpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gYWx3YXlzKCkge1xyXG4gICAgICAgICAgICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHRvYXN0LnJlbW92ZSgpO1xyXG4gICAgICB9KTtcclxuICAgICAgJHRvYXN0Lm9uKCdjbGljaycsICcjbm9EZWxldGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgJHRvYXN0LnJlbW92ZSgpO1xyXG4gICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59KTtcclxuXHJcbi8vID09PT09PSB1cGRhdGUgPT09PT09XHJcblxyXG4kKCcjdXBkYXRlUHJvcGVydHknKS5vbignY2xpY2snLCBmdW5jdGlvbiB1cGRhdGVQcm9wZXJ0eShldmVudCkge1xyXG4gIHZhciBnaWQ7XHJcbiAgdmFyIG9iajtcclxuICB2YXIgY29vcmRzO1xyXG4gIHZhciBvbkVuZFRyYW5zbHRlO1xyXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgbWFwLnVuKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gIGZlYXR1cmVzLmNsZWFyKCk7XHJcbiAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gIHNlbGVjdC5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgJCgnLnByb3BlcnR5LWluZm8nKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICBzZWxlY3Qub25jZSgnc2VsZWN0JywgZnVuY3Rpb24gKGUpIHtcclxuICAgIHZhciBzZWxlY3RlZEZlYXR1cmVzID0gZS5zZWxlY3RlZDtcclxuICAgIHZhciBsZW5ndGggPSBzZWxlY3RlZEZlYXR1cmVzLmxlbmd0aDtcclxuICAgIHZhciBzZWxlY3RlZEZlYXR1cmU7XHJcbiAgICBpZiAobGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIGdpZCA9IF8uaGVhZChlLnNlbGVjdGVkKS5nZXQoJ2dpZCcpO1xyXG4gICAgICBzZWxlY3RlZEZlYXR1cmUgPSBfLmhlYWQoZS5zZWxlY3RlZCk7XHJcbiAgICAgIGNvb3JkcyA9IG9sLnByb2oudHJhbnNmb3JtKHNlbGVjdGVkRmVhdHVyZS5nZXRHZW9tZXRyeSgpLmdldENvb3JkaW5hdGVzKCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICAgICQuYWpheCh7XHJcbiAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3Byb3BlcnR5JyxcclxuICAgICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgICBkYXRhVHlwZTogJ2pzb24nLFxyXG4gICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgIGdpZDogZ2lkXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZChkYXRhKSB7XHJcbiAgICAgICAgICB2YXIgJHRvYXN0ID0ge307XHJcbiAgICAgICAgICAkdG9hc3Qub3B0aW9ucyA9IHt9O1xyXG4gICAgICAgICAgb2JqID0gXy5oZWFkKGRhdGEuZmVhdHVyZXMpLnByb3BlcnRpZXM7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhvYmopXHJcblxyXG4gICAgICAgICAgJHRvYXN0ID0gdG9hc3RyLndhcm5pbmcoJzxwPkNoYW5nZSBQcm9wZXJ0eSBDb29yZGluYXRlcz88L3A+PGRpdiBjbGFzcz1cInRvYXN0ci1idG5zXCI+PGJ1dHRvbiBpZD1cInllc0NoYW5nZVhZXCIgY2xhc3M9XCJtZGwtYnV0dG9uIG1kbC1qcy1idXR0b24gXCI+WWVzPC9idXR0b24+PGJ1dHRvbiBpZD1cIm5vQ2hhbmdlWFlcIiBjbGFzcz1cIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvblwiPk5vPC9idXR0b24+PC9kaXY+Jyk7XHJcbiAgICAgICAgICAkdG9hc3Qub24oJ2NsaWNrJywgJyN5ZXNDaGFuZ2VYWScsIGZ1bmN0aW9uIHllc0NoYW5nZVhZKCkge1xyXG4gICAgICAgICAgICB2YXIgbGF0bG5nO1xyXG4gICAgICAgICAgICB2YXIgZ2VvY29kZU9iajtcclxuICAgICAgICAgICAgdmFyIGdlb2NvZGVOYW1lRWw7XHJcbiAgICAgICAgICAgIHZhciBnZW9jb2RlTmFtZUVuO1xyXG4gICAgICAgICAgICB2YXIgZ2VvY29kZUFyZWFOYW1lO1xyXG4gICAgICAgICAgICB0cmFuc2xhdGUuc2V0QWN0aXZlKHRydWUpO1xyXG4gICAgICAgICAgICBvbkVuZFRyYW5zbHRlID0gdHJhbnNsYXRlLm9uKCd0cmFuc2xhdGVlbmQnLCBmdW5jdGlvbiB0cmFuc2xhdGVFbmQoZSkge1xyXG4gICAgICAgICAgICAgIC8vIHZhciBnZW9jb2RlT2JqO1xyXG4gICAgICAgICAgICAgIGNvb3JkcyA9IG9sLnByb2oudHJhbnNmb3JtKGUuZmVhdHVyZXMuaXRlbSgwKS5nZXRHZW9tZXRyeSgpLmdldENvb3JkaW5hdGVzKCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICAgICAgICAgICAgbGF0bG5nID0gY29vcmRzWzFdICsgJ1xcLCcgKyBjb29yZHNbMF07XHJcbiAgICAgICAgICAgICAgZ2VvY29kZU9iaiA9ICQuZ2V0SlNPTignaHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbicsIHtcclxuICAgICAgICAgICAgICAgIGxhdGxuZzogbGF0bG5nLFxyXG4gICAgICAgICAgICAgICAga2V5OiAnQUl6YVN5Q2tIMzlfRXoyMV9SbENfcGpYRDA5enBKXyAtIGVWaHpDclEnXHJcbiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGpzb24sIHRleHRTdGF0dXMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBqc29uLnJlc3VsdHM7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgZ2VvY29kZU9iai50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGdlb2NvZGVOYW1lRWwgPSBfLmhlYWQoXy5oZWFkKGdlb2NvZGVPYmoucmVzcG9uc2VKU09OLnJlc3VsdHMpLmFkZHJlc3NfY29tcG9uZW50cykubG9uZ19uYW1lO1xyXG4gICAgICAgICAgICAgICAgZ2VvY29kZU5hbWVFbiA9IHN0cmluZ19lbF90b191cmwoZ2VvY29kZU5hbWVFbCk7XHJcbiAgICAgICAgICAgICAgICBvYmouc3RyZWV0X2VsID0gZ2VvY29kZU5hbWVFbDtcclxuICAgICAgICAgICAgICAgIG9iai5zdHJlZXRfZW4gPSBnZW9jb2RlTmFtZUVuO1xyXG4gICAgICAgICAgICAgICAgZ2VvY29kZUFyZWFOYW1lID0gXy5maXJzdChfLmRyb3AoXy5tYXAoXy5oZWFkKGdlb2NvZGVPYmoucmVzcG9uc2VKU09OLnJlc3VsdHMpLmFkZHJlc3NfY29tcG9uZW50cywgJ2xvbmdfbmFtZScpKSk7XHJcbiAgICAgICAgICAgICAgICBvYmouYXJlYV9uYW1lID0gZ2VvY29kZUFyZWFOYW1lO1xyXG4gICAgICAgICAgICAgICAgZGF0YUZvcm0ob2JqLCBjb29yZHMpO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgJHRvYXN0Lm9uKCdjbGljaycsICcjbm9DaGFuZ2VYWScsIGZ1bmN0aW9uIG5vQ2hhbmdlWFkoKSB7XHJcbiAgICAgICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgZGF0YUZvcm0ob2JqLCBjb29yZHMpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoKSB7XHJcbiAgICAgICAgICB0b2FzdHIuZXJyb3IoJ09vcHMgU29tZXRoaW5nIFdlbnQgV3JvbmchISEnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgZnVuY3Rpb24gZGF0YUZvcm0ob2JqLCBjb29yZHMpIHtcclxuICAgICQoJy5tb2RhbC1kaWFsb2cnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgIGR1c3QucmVuZGVyKCdwcm9wZXJ0eVVwZGF0ZScsIG9iaiwgZnVuY3Rpb24gcmVuZGVyUHJvcGVydHlVcGRhdGUoZXJyLCBvdXQpIHtcclxuICAgICAgdmFyIG9sZFZhbHVlcyA9IHt9O1xyXG4gICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuICAgICAgb2xkVmFsdWVzLmJlZHJvb21zID0gJCgnI2JlZHJvb21zJykudmFsKCk7XHJcbiAgICAgIG9sZFZhbHVlcy5zdHJlZXRfZW4gPSAkKCcjc3RyZWV0X2VuJykudmFsKCk7XHJcbiAgICAgIG9sZFZhbHVlcy5zdHJlZXRfZWwgPSAkKCcjc3RyZWV0X2VsJykudmFsKCk7XHJcbiAgICAgIG9sZFZhbHVlcy5hcmVhX25hbWUgPSAkKCcjYXJlYV9uYW1lJykudmFsKCk7XHJcbiAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICBoYW5kbGVGb3JtLnNldCh7XHJcbiAgICAgICAgbmFtZTogJ3VwZGF0ZVByb3BlcnR5JyxcclxuICAgICAgICBzdWJtaXRCdG5JZDogJ3VwZGF0ZSdcclxuICAgICAgfSk7XHJcbiAgICAgIC8vICQoJyNzdHJlZXRfZWwnKS52YWwob2JqLmdlb2NvZGVOYW1lX2VsKTtcclxuICAgICAgLy8gJCgnI3N0cmVldF9lbicpLnZhbChvYmouZ2VvY29kZU5hbWVfZW4pO1xyXG4gICAgICAkKCcjZXN0YXRlVHlwZScpLmNoYW5nZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnRGV0YWNoZWQgSG91c2UnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnRGV0YWNoZWQgSG91c2UnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86UzrnOsc68zq3Pgc65z4POvM6xJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdBcGFydG1lbnQnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86Iz4DOsc+FzrvOtycpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdWaWxsYScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdWaWxsYScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdNYWlzb25ldHRlJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ01haXNvbmV0dGUnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLmNoYW5nZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICdEZXRhY2hlZCBIb3VzZScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpzOv869zr/Ous6xz4TOv865zrrOr86xJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICdBcGFydG1lbnQnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpTOuc6xzrzOrc+BzrnPg868zrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpTOuc6xzrzOrc+BzrnPg868zrEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ1ZpbGxhJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86Iz4DOsc+FzrvOtycpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOiM+AzrHPhc67zrcnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpzOtc62zr/Ovc6tz4TOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOnM61zrbOv869zq3PhM6xJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgJCgnI3VwZGF0ZScpLm9uKCdjbGljaycsIGZ1bmN0aW9uIHVwZGF0ZShldmVudCkge1xyXG4gICAgICAgIHZhciBkYXRhO1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgZGF0YSA9IGhhbmRsZUZvcm0uZ2V0KCk7XHJcbiAgICAgICAgaWYgKCFfLmlzTmlsKGRhdGEpKSB7XHJcbiAgICAgICAgICBkYXRhLnggPSBjb29yZHNbMF07XHJcbiAgICAgICAgICBkYXRhLnkgPSBjb29yZHNbMV07XHJcbiAgICAgICAgICBkYXRhLmdpZCA9IGdpZDtcclxuICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9wcm9wZXJ0eScsXHJcbiAgICAgICAgICAgIHR5cGU6ICdQVVQnLFxyXG4gICAgICAgICAgICBkYXRhOiBkYXRhXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQocmVzcG9uc2UsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoJ1Byb3BlcnR5IHdpdGggZ2lkICcgKyByZXNwb25zZS5wcm9wZXJ0eWdpZCArICcgVXBkYXRlZCBpbiBEYXRhYmFzZScpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCB0aGlzIHByb3BlcnR5IScpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZScpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiBhbHdheXMoKSB7XHJcbiAgICAgICAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgIHRyYW5zbGF0ZS51bkJ5S2V5KG9uRW5kVHJhbnNsdGUpO1xyXG4gICAgICAgICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICAgICAgICAgICQoJy5tb2RhbC1kaWFsb2cnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2NhbmNlbFVwZGF0ZScpLm9uKCdjbGljaycsIGZ1bmN0aW9uIGNhbmNlbFVwZGF0ZShldmVudCkge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICB0cmFuc2xhdGUudW5CeUtleShvbkVuZFRyYW5zbHRlKTtcclxuICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICB0cmFuc2xhdGUuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgICAkKCcubW9kYWwtZGlhbG9nJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAkKCcjYWRtaW5NYXAnKS5yZW1vdmVBdHRyKCdzdHlsZScpO1xyXG59KTtcclxuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkge1xyXG4gIHdpbmRvdy5QYXJzbGV5Lm9uKCdmaWVsZDplcnJvcicsIGZ1bmN0aW9uICgpIHtcclxuICAgIC8vIFRoaXMgZ2xvYmFsIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGZvciBhbnkgZmllbGQgdGhhdCBmYWlscyB2YWxpZGF0aW9uLlxyXG4gICAgY29uc29sZS5sb2coJ1ZhbGlkYXRpb24gZmFpbGVkIGZvcjogJywgdGhpcy4kZWxlbWVudCk7XHJcbiAgfSk7XHJcbiAgd2luZG93LlBhcnNsZXlcclxuICAgIC5hZGRWYWxpZGF0b3IoJ2RhdGUnLCB7XHJcbiAgICAgIHJlcXVpcmVtZW50VHlwZTogJ3N0cmluZycsXHJcbiAgICAgIHZhbGlkYXRlU3RyaW5nOiBmdW5jdGlvbiAodmFsdWUsIHJlcXVpcmVtZW50KSB7XHJcbiAgICAgICAgaWYgKG1vbWVudCh2YWx1ZSwgJ0RELU1NLVlZWVknLCB0cnVlKS5pc1ZhbGlkKCkgPT09IHRydWUpIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH0sXHJcbiAgICAgIG1lc3NhZ2VzOiB7XHJcbiAgICAgICAgZW46ICdXcm9uZyBEYXRlJyxcclxuICAgICAgICBlbDogJ86bzqzOuM6/z4IgzpfOvM61z4HOv868zrfOvc6vzrEnXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIHN0cmluZ19lbF90b191cmwoc3RyaW5nKSB7XHJcbiAgdmFyIG9yaWdpbmFsU3RyaW5nID0gc3RyaW5nO1xyXG4gIHZhciBuZXdTdHJpbmc7XHJcbiAgdmFyIHJlcGxhY2UgPSBuZXcgQXJyYXkoJ86xJywgJ86sJywgJ86GJywgJ86RJywgJ86yJywgJ86SJywgJ86zJywgJ86TJywgJ860JywgJ86UJywgJ861JywgJ86tJywgJ86VJywgJ86IJywgJ862JywgJ86WJywgJ863JywgJ86uJywgJ86XJywgJ864JywgJ86YJywgJ865JywgJ86vJywgJ8+KJywgJ86QJywgJ86ZJywgJ86KJywgJ866JywgJ86aJywgJ867JywgJ86bJywgJ868JywgJ86cJywgJ869JywgJ86dJywgJ86+JywgJ86eJywgJ86/JywgJ8+MJywgJ86fJywgJ86MJywgJ8+AJywgJ86gJywgJ8+BJywgJ86hJywgJ8+DJywgJ8+CJywgJ86jJywgJ8+EJywgJ86kJywgJ8+FJywgJ8+NJywgJ86lJywgJ86OJywgJ8+GJywgJ86mJywgJ8+HJywgJ86nJywgJ8+IJywgJ86oJywgJ8+JJywgJ8+OJywgJ86pJywgJ86PJywgJyAnLCAnXFwnJywgJ1xcJycsICcsJyk7XHJcbiAgdmFyIHJlcGxhY2VfbiA9IG5ldyBBcnJheSgnYScsICdhJywgJ0EnLCAnQScsICd2JywgJ1YnLCAnZycsICdHJywgJ2QnLCAnRCcsICdlJywgJ2UnLCAnRScsICdFJywgJ3onLCAnWicsICdpJywgJ2knLCAnSScsICd0aCcsICdUaCcsICdpJywgJ2knLCAnaScsICdpJywgJ0knLCAnSScsICdrJywgJ0snLCAnbCcsICdMJywgJ20nLCAnTScsICduJywgJ04nLCAneCcsICdYJywgJ28nLCAnbycsICdPJywgJ08nLCAncCcsICdQJywgJ3InLCAnUicsICdzJywgJ3MnLCAnUycsICd0JywgJ1QnLCAndScsICd1JywgJ1knLCAnWScsICdmJywgJ0YnLCAnY2gnLCAnQ2gnLCAncHMnLCAnUHMnLCAnbycsICdvJywgJ08nLCAnTycsICcgJywgJ18nLCAnXycsICdfJyk7XHJcblxyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgcmVwbGFjZS5sZW5ndGg7IGkrKykge1xyXG4gICAgb3JpZ2luYWxTdHJpbmcgPSBvcmlnaW5hbFN0cmluZy5yZXBsYWNlKG5ldyBSZWdFeHAocmVwbGFjZVtpXSwgJ2cnKSwgcmVwbGFjZV9uW2ldKTtcclxuICB9XHJcbiAgbmV3U3RyaW5nID0gb3JpZ2luYWxTdHJpbmc7XHJcbiAgcmV0dXJuIG5ld1N0cmluZztcclxufVxyXG4kKGRvY3VtZW50KVxyXG4gIC5hamF4U3RhcnQoZnVuY3Rpb24gKCkge1xyXG4gICAgJGxvYWRpbmcuYWRkQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIH0pXHJcbiAgLmFqYXhTdG9wKGZ1bmN0aW9uICgpIHtcclxuICAgICRsb2FkaW5nLnJlbW92ZUNsYXNzKCdpcy1hY3RpdmUnKTtcclxuICB9KTtcclxuIiwidmFyIGhhbmRsZUZvcm0gPSAoZnVuY3Rpb24gKCQsIHBhcnNsZXkpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGZvcm1OYW1lLCBzdWJtaXRCdG5JZCwgcDtcclxuXHJcbiAgZnVuY3Rpb24gc2V0T3B0aW9ucyhvcHRpb25zKSB7XHJcbiAgICBmb3JtTmFtZSA9IG9wdGlvbnMubmFtZTtcclxuICAgIHN1Ym1pdEJ0bklkID0gb3B0aW9ucy5zdWJtaXRCdG5JZDtcclxuICAgIGVuYWJsZVNlbGVjdCgpO1xyXG4gIH1cclxuICBmdW5jdGlvbiBlbmFibGVTZWxlY3QoKSB7XHJcbiAgICB2YXIgZSA9ICQoJy5nZXRtZGwtc2VsZWN0Jyk7XHJcbiAgICBlLmVhY2goZnVuY3Rpb24gKCkge1xyXG4gICAgICBhZGRFdmVudExpc3RlbmVycyh0aGlzKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVycyhlKSB7XHJcbiAgICB2YXIgdCA9IGUucXVlcnlTZWxlY3RvcignaW5wdXQnKSxcclxuICAgICAgbiA9IGUucXVlcnlTZWxlY3RvckFsbCgnbGknKTtcclxuICAgIGUucXVlcnlTZWxlY3RvcignaScpO1xyXG4gICAgW10uZm9yRWFjaC5jYWxsKG4sIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgIGUub25jbGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0LnZhbHVlID0gZS50ZXh0Q29udGVudDtcclxuICAgICAgfTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBkaXNhYmxlU3VibWl0QnRuKCkge1xyXG4gICAgJCgnIycgKyBzdWJtaXRCdG5JZCArICcnKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gY3JlYXRlVmFsaWRhdG9yKCkge1xyXG4gICAgcCA9ICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLnBhcnNsZXkoKTtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZGVzdHJveVZhbGlkYXRvcigpIHtcclxuICAgIHAuZGVzdHJveSgpO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gdmFsaWRhdGVGb3JtKCkge1xyXG4gICAgcmV0dXJuIHAudmFsaWRhdGUoKTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIG9uVmFsaWRhdGVGb3JtU3VjY2VzcygpIHtcclxuICAgIHAub24oJ2Zvcm06c3VjY2VzcycsXHJcblxyXG4gICAgICBmdW5jdGlvbiAoKSB7fSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHNldEF0dHJpYnV0ZXMoYXRyKSB7XHJcbiAgICAkKCcjc3RyZWV0X2VsJykudmFsKGF0ci5zdHJlZXRfZWwpO1xyXG4gICAgJCgnI3N0cmVldF9lbicpLnZhbChhdHIuc3RyZWV0X2VuKTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZ2V0QXR0cmlidXRlcygpIHtcclxuICAgIHZhciBvYmogPSB7fTtcclxuICAgIGNyZWF0ZVZhbGlkYXRvcigpO1xyXG4gICAgaWYgKHZhbGlkYXRlRm9ybSgpID09PSB0cnVlKSB7XHJcbiAgICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtdGV4dGZpZWxkX19pbnB1dCcpLmVhY2goXHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICAgb2JqWyQodGhpcykuYXR0cignaWQnKV0gPSAkKHRoaXMpLnZhbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLWNoZWNrYm94X19pbnB1dCcpLmVhY2goXHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICAgb2JqWyQodGhpcykuYXR0cignaWQnKV0gPSAkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC1yYWRpb19fYnV0dG9uJykuZWFjaChcclxuICAgICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAgIG9ialskKHRoaXMpLmF0dHIoJ2lkJyldID0gJCh0aGlzKS5wcm9wKCdjaGVja2VkJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX3NlbGVjdCcpLmVhY2goXHJcbiAgICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgICBvYmpbJCh0aGlzKS5hdHRyKCdpZCcpXSA9ICQodGhpcykudmFsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBvYmo7XHJcbiAgICB9XHJcbiAgICBlbHNlIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gcmVzZXRGb3JtKCkge1xyXG4gICAgaWYgKGNyZWF0ZVZhbGlkYXRvcigpID09IHRydWUpIHtcclxuICAgICAgZGVzdHJveVZhbGlkYXRvcigpO1xyXG4gICAgfVxyXG4gICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC10ZXh0ZmllbGRfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICQodGhpcykudmFsKCcnKTtcclxuICAgICAgICAkKHRoaXMpLnBhcmVudCgpLmVxKDApLnJlbW92ZUNsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICQodGhpcykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWludmFsaWQnKTtcclxuICAgICAgfSk7XHJcbiAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLWNoZWNrYm94X19pbnB1dCcpLmVhY2goXHJcblxyXG4gICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAkKHRoaXMpLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC1jaGVja2JveCcpLmVhY2goXHJcblxyXG4gICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgc2V0OiBzZXRPcHRpb25zLFxyXG4gICAgZ2V0OiBnZXRBdHRyaWJ1dGVzLFxyXG4gICAgY2xlYXI6IHJlc2V0Rm9ybSxcclxuICAgIHNldEF0dHJpYnV0ZXM6IHNldEF0dHJpYnV0ZXMsXHJcbiAgLy8gY3JlYXRlVmFsaWRhdG9yOiBjcmVhdGVWYWxpZGF0b3IsXHJcbiAgLy8gZGVzdHJveVZhbGlkYXRvcjogZGVzdHJveVZhbGlkYXRvcixcclxuICAvLyB2YWxpZGF0ZUZvcm06IHZhbGlkYXRlRm9ybSxcclxuICAvLyBvblZhbGlkYXRlRm9ybVN1Y2Nlc3M6IG9uVmFsaWRhdGVGb3JtU3VjY2VzcyxcclxuICAvLyBkaXNhYmxlU3VibWl0QnRuOiBkaXNhYmxlU3VibWl0QnRuXHJcbiAgfTtcclxufShqUXVlcnksIHBhcnNsZXkpKTtcclxuIl19
