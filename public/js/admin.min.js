var $loading = $('.mdl-spinner');
var center = [3677385, 4120949];
var extent = [3652772, 4112808, 3700000, 4132797];
var lang = document.documentElement.lang;
var geoJSONFormat = new ol.format.GeoJSON({
  defaultDataProjection: 'EPSG:4326'
});
var propertySource;
var property;
var map;
var features;
var drawnProperties;
var draw;
var select;
var translate;
var bing;
var mapbox;
toastr.options = {
  closeButton: false,
  debug: false,
  newestOnTop: false,
  progressBar: false,
  positionClass: 'toast-top-center',
  preventDuplicates: false,
  onclick: null,
  showDuration: '300',
  hideDuration: '1000',
  timeOut: '5000',
  extendedTimeOut: '1000',
  showEasing: 'swing',
  hideEasing: 'linear',
  showMethod: 'fadeIn',
  hideMethod: 'fadeOut'
};
bing = new ol.layer.Tile({
  visible: true,
  source: new ol.source.BingMaps({
    key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
    imagerySet: 'Aerial'
  }),
  maxZoom: 19,
  crossOrigin: 'anonymous',
  preload: Infinity,
  id: 'bing'
});
mapbox = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [new ol.Attribution({
      html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
    })],
    url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
  }),
  id: 'mapbox'
});

function getIconType(estateType) {
  var iconType = {
    Apartment: function getApartmentIcon() {
      return 'apartment';
    },
    Store: function getStoreIcon() {
      return 'store';
    },
    'Detached House': function getDetachedHouseIcon() {
      return 'detached';
    },
    Maisonette: function getMaisonetteIcon() {
      return 'maisonette';
    },
    Villa: function getVillaIon() {
      return 'villa';
    }
  };
  return (iconType[estateType])();
}

function getIconPath(listingType) {
  var iconPath = {
    true: function () {
      return './images/pins/sale/';
    },
    false: function () {
      return './images/pins/rent/';
    },
    none: function () {
      return './images/pins/none/';
    }
  };
  return (iconPath[listingType])();
}

function PropertyStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-48.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
propertySource = new ol.source.Vector({
  format: geoJSONFormat,
  loader: function (extent, resolution, projection) {
    var url = 'http://127.0.0.1:3000/db/property/' + id;
    var self = this;
    // self.clear();
    $.ajax({
      url: url,
      type: 'GET',
      dataType: 'json'
    })
    .done(function completed(data, textStatus, jqXHR) {
      var newFeatures = geoJSONFormat.readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
      self.addFeatures(newFeatures);
    })
    .fail(function failed(jqXHR, textStatus, errorThrown) {
      toastr.clear();
      if (jqXHR.status === 404) {
        toastr.error('Sorry, we cannot find this property!');
      } else if (jqXHR.status === 503) {
        toastr.error('Service Unavailable');
      } else {
        toastr.error('Internal Server Error');
      }
    });
  }
});
property = new ol.layer.Vector({
  source: propertySource,
  id: 'property',
  visible: true,
  style: PropertyStyle
});
property.setZIndex(2);
map = new ol.Map({
  target: 'adminMap',
  layers: [
    mapbox, property
  ],
  loadTilesWhileAnimating: true,
  loadTilesWhileInteracting: true,
  renderer: 'canvas',
  controls: ol.control.defaults({
    attributionOptions: {
      collapsible: false,
      collapsed: false
    }
  }).extend([
    new ol.control.ScaleLine({
      units: 'metric'
    }),
    new ol.control.OverviewMap({
      className: 'ol-overviewmap ol-custom-overviewmap',
      collapsible: true,
      collapsed: true,
      layers: [bing]
    }),
    new ol.control.ZoomToExtent({
      extent: extent
    })
  ]),
  view: new ol.View({
    center: center,
    extent: extent,
    projection: 'EPSG:3857',
    zoom: 14,
    maxZoom: 19,
    minZoom: 14
  })
});
if (lang === 'el') {
  bing.set('name', 'Δορυφορική εικόνα');
  mapbox.set('name', 'Χάρτης');
  property.set('name', 'Ακίνητα');
} else {
  bing.set('name', 'Sattelite Image');
  mapbox.set('name', 'Map');
  property.set('name', 'Properties');
}
// ====== interactions ======
features = new ol.Collection();

function drawnPropertiesStyle(color) {
  var src;
  src = './images/pins/generic-48.png';
  if (typeof color !== 'undefined') {
    return new ol.style.Style({
      image: new ol.style.Icon(({
        src: src,
        anchorOrigin: 'bottom-left',
        anchor: [
          0.5, 0
        ],
        scale: 1,
        color: color
      }))
    });
  }
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
drawnProperties = new ol.layer.Vector({
  source: new ol.source.Vector(),
  id: 'drawnProperties',
  style: drawnPropertiesStyle('#4caf50')
});
map.addLayer(drawnProperties);
// draw
draw = new ol.interaction.Draw({
  // features: features,
  source: drawnProperties.getSource(),
  type: 'Point',
  style: drawnPropertiesStyle('#4caf50')
});
map.addInteraction(draw);
draw.setActive(false);
// select
function selectedStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-64.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1,
      color: '#ffeb3b'
    }))
  });
}
select = new ol.interaction.Select({
  layers: [property],
  features: features,
  multi: false,
  style: selectedStyle
});
map.addInteraction(select);
select.setActive(false);
translate = new ol.interaction.Translate({
  features: select.getFeatures()
});
map.addInteraction(translate);
translate.setActive(false);
// ====== info ======
map.on('click', clickInfo);

function clickInfo(event) {
  var obj = {};

  event.preventDefault();
  select.setActive(true);
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      obj.feature = {};
      selectedFeature = _.head(e.selected);
      // clickedFeature.feature.setScale(1.2);
      selectedFeature.getKeys().forEach(function (key) {
        obj.feature[key] = selectedFeature.get(key);
      });
      dust.render('adminPropertyInfo', obj, function (err, out) {
        $('.property-info').html(out);
        $('.property-info').removeClass('visuallyhidden');
        componentHandler.upgradeDom();
        $('#listing').on('click', function (event) {
          var gid;
          event.preventDefault();
          gid = $(this).data('gid');
          $.ajax({
              url: 'http://127.0.0.1:3000/db/listing',
              type: 'GET',
              dataType: 'json',
              data: {
                gid: gid,
              },
            })
            .done(function (data) {
              // console.log(data);
              var listing_id = data.id;
              $('#openModal').css('width', 'auto');
              $('.modal-dialog').removeClass('visuallyhidden');
              dust.render('listingInsert', data, function (err, out) {
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                handleForm.set({
                  name: 'insert-update-listing',
                  submitBtnId: 'ok',
                });
                if ($('input[name=options]:checked').val() === 'Sale') {
                  $('#pets').parent().hide();
                  $('#prefered_customer').parent().hide();
                }
                $('input[name=options]').on('change', function (event) {
                  if ($(this).val() === 'Sale') {
                    $('#pets').prop('disabled', true);
                    $('#pets').prop('checked', false);
                    $('#pets').parent().hide();
                    $('label[for=pets]').removeClass('is-checked');
                    $('#prefered_customer').val('');
                    $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                    $('#prefered_customer').prop('disabled', true);
                    $('#prefered_customer').parent().hide();
                  } else {
                    $('#pets').prop('disabled', false);
                    $('#pets').parent().show();
                    $('#prefered_customer').prop('disabled', false);
                    $('#prefered_customer').parent().show();
                  }
                });
                $('#sent-listing').on('click', function (event) {
                  var data;
                  event.preventDefault();
                  data = handleForm.get();
                  if (data !== null) {
                    data.property_gid = gid;
                    data.listing_id = listing_id;
                    $.ajax({
                        url: 'http://127.0.0.1:3000/db/listing',
                        type: 'PUT',
                        data: data,
                        dataType: 'text'
                      })
                      .done(function (data, textStatus, jqXHR) {
                        if (jqXHR.status === 200) {
                          toastr.success('Property Updated In Database');
                        } else {
                          toastr.error('Oops Something Went Wrong!!!');
                        }
                      })
                      .fail(function (jqXHR, textStatus, errorThrown) {
                        toastr.error('Oops Something Went Wrong!!!');
                      })
                      .always(function () {
                        handleForm.clear();
                        $('#openModal').addClass('visuallyhidden');
                        propertySource.clear();
                        select.getFeatures().clear();
                        select.setActive(false);
                      });
                  }
                });
                $('#cancel-listing').on('click', function (event) {
                  event.preventDefault();
                  handleForm.clear();
                  select.getFeatures().clear();
                  select.setActive(false);
                  $('#openModal').addClass('visuallyhidden');
                });
              });
            })
            .fail(function () {
              var obj = {};
              if (lang === 'el') {
                obj.msg = 'Δεν Βρέθηκε Αγγελία';
                obj.text = 'Δημιουργία Καινούργιας;';
                obj.yes = 'ΝΑΙ';
                obj.no = 'ΟΧΙ';
              } else {
                obj.msg = 'No Listing Found';
                obj.text = 'Create New Listing?';
                obj.yes = 'YES';
                obj.no = 'NO';
              }
              dust.render('dialog', obj, function (error, out) {
                $('#openModal').removeClass('visuallyhidden');
                $('#openModal').css('width', 'auto');
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                $('#yes').on('click', function (event) {
                  event.preventDefault();
                  dust.render('listingInsert', {
                    rent: 'true',
                    addImage: 'true',
                  }, function (err, out) {
                    var myDropzone;
                    $('.modal-content').html(out);
                    componentHandler.upgradeDom();
                    myDropzone = new Dropzone(document.getElementById('dropzone'), {
                      uploadMultiple: false,
                      acceptedFiles: '.jpg',
                      parallelUploads: 6,
                      // addRemoveLinks : true,
                      url: 'https://api.cloudinary.com/v1_1/firvain/auto/upload'
                    });
                    myDropzone.on('sending', function (file, xhr, formData) {
                      formData.append('api_key', 375138932689591);
                      formData.append('callback', 'http://127.0.0.1:3000/public/cloudinary_cors.html');
                      formData.append('upload_preset', 'testupload');
                      formData.append('public_id', gid);
                    });
                    myDropzone.on('success', function () {
                      this.element.style.display = 'none';
                    });
                    handleForm.set({
                      name: 'insert-update-listing',
                      submitBtnId: 'ok'
                    });
                    // $('input[name=file]').cloudinary_fileupload();
                    // $('input[name=file]').unsigned_cloudinary_upload('testupload', {
                    //   cloud_name: 'firvain',
                    //   'public_id': gid,
                    // });
                    $('input[name=options]').on('change', function (event) {
                      if ($(this).val() === 'Sale') {
                        $('#pets').prop('disabled', true);
                        $('#pets').prop('checked', false);
                        $('label[for=pets]').removeClass('is-checked');
                        $('#prefered_customer').val('');
                        $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                        $('#prefered_customer').prop('disabled', true);
                      } else {
                        $('#pets').prop('disabled', false);
                        $('#prefered_customer').prop('disabled', false);
                      }
                    });
                    $('#sent-listing').on('click', function (event) {
                      var data;
                      event.preventDefault();
                      data = handleForm.get();
                      if (data !== null) {
                        data.property_gid = gid;
                        $.ajax({
                            url: 'http://127.0.0.1:3000/db/listing',
                            type: 'POST',
                            data: data,
                            dataType: 'text'
                          })
                          .done(function (data, textStatus, jqXHR) {
                            if (jqXHR.status === 201) {
                              toastr.success('Property Updated In Database');
                            } else {
                              toastr.error('Oops Something Went Wrong!!!');
                            }
                          })
                          .fail(function (jqXHR, textStatus, errorThrown) {
                            toastr.error('Oops Something Went Wrong!!!');
                          })
                          .always(function () {
                            handleForm.clear();
                            $('#openModal').addClass('visuallyhidden');
                            select.getFeatures().clear();
                            select.setActive(false);
                          });
                      }
                    });
                    $('#cancel-listing').on('click', function (event) {
                      event.preventDefault();
                      handleForm.clear();
                      select.getFeatures().clear();
                      select.setActive(false);
                      $('#openModal').addClass('visuallyhidden');
                    });
                  });
                });
                $('#no').on('click', function (event) {
                  event.preventDefault();
                  $('#openModal').addClass('visuallyhidden');
                  select.getFeatures().clear();
                  select.setActive(false);
                });
              });
            });
        });
      });
    } else {
      select.getFeatures().clear();
      // select.setActive(false);
      $('.property-info').addClass('visuallyhidden');
      toastr.error('Cant Find Any Property There...');
    }
  });
}
// ====== logout ======
$('#logout').click(function () {
  location.href = '/logout';
});
// ====== insert ======
$('#insertProperty').click(function () {
  var onEndDraw;
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  select.getFeatures().clear();
  select.setActive(false);
  draw.setActive(true);
  onEndDraw = draw.on('drawend', function (event) {
    var obj = {};
    var coords;
    var geocodeObj;
    var latlng;
    var geocodeName_el;
    var geocodeName_en;
    var geocodeAreaName;
    event.preventDefault();
    draw.setActive(false);
    coords = ol.proj.transform(event.feature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
    obj.coords = coords;
    latlng = coords[1] + '\,' + coords[0];
    geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
      latlng: latlng,
      key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ',
    }, function (json, textStatus) {
      return json;
    });
    geocodeObj.then(function () {
      geocodeName_el = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
      geocodeName_en = string_el_to_url(geocodeName_el);
      obj.street_el = geocodeName_el;
      obj.street_en = geocodeName_en;
      geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
      obj.area_name = geocodeAreaName;
      dataForm(obj);
    });

  });

  function dataForm(obj) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyInsert', obj, function (err, out) {
      $('.modal-content').html(out);
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'insertProperty',
        submitBtnId: 'insert'
      });
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val('');
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val('');
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');


        }
      });
      $('#cancelInsert').on('click', function (event) {
        event.preventDefault();
        handleForm.clear();
        drawnProperties.getSource().clear();
        draw.unByKey(onEndDraw);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
      $('#insert').on('click', function (event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (data !== null) {
          data.x = obj.coords[0];
          data.y = obj.coords[1];
          data.adminId = id;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'POST',
            data: data
          })
          .done(function completed() {
            toastr.clear();
            toastr.success('Property Recorded In Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function () {
            event.preventDefault();
            drawnProperties.getSource().clear();
            propertySource.clear();
            handleForm.clear();
            draw.unByKey(onEndDraw);
            $('.modal-dialog').addClass('visuallyhidden');
            map.on('click', clickInfo);
          });
        }
      });
    });
  }
});
// ====== delete ======
$('#deleteProperty').click(function (event) {
  event.preventDefault();
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  select.once('select', function (e) {
    var $toast;
    if (e.target.getFeatures().getLength() === 1) {
      $toast = toastr.warning('<p>Are you sure?</p><div class="toastr-btns"><button id="yesDelete" class="mdl-button mdl-js-button ">Yes</button><button id="noDelete" class="mdl-button mdl-js-button">No</button></div>');
      $toast.on('click', '#yesDelete', function () {
        var gid = select.getFeatures().item(0).get('gid');
        $.ajax({
          url: 'http://127.0.0.1:3000/db/property',
          type: 'DELETE',
          dataType: 'json',
          data: {
            gid: gid
          }
        })
          .done(function completed(data, textStatus, jqXHR) {
            toastr.clear();
            toastr.success('Property Successfully Deleted with id = ' + data.propertygid + ' from Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function always() {
            propertySource.clear();
            select.getFeatures().clear();
            select.setActive(false);
            map.on('click', clickInfo);
          });

        $toast.remove();
      });
      $toast.on('click', '#noDelete', function () {
        $toast.remove();
        select.getFeatures().clear();
        select.setActive(false);
      });
    }
  });
});

// ====== update ======

$('#updateProperty').on('click', function updateProperty(event) {
  var gid;
  var obj;
  var coords;
  var onEndTranslte;
  event.preventDefault();
  toastr.clear();
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  $('.property-info').addClass('visuallyhidden');
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      gid = _.head(e.selected).get('gid');
      selectedFeature = _.head(e.selected);
      coords = ol.proj.transform(selectedFeature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
      $.ajax({
        url: 'http://127.0.0.1:3000/db/property',
        type: 'GET',
        dataType: 'json',
        data: {
          gid: gid
        }
      })
        .done(function completed(data) {
          var $toast = {};
          $toast.options = {};
          obj = _.head(data.features).properties;
          console.log(obj)

          $toast = toastr.warning('<p>Change Property Coordinates?</p><div class="toastr-btns"><button id="yesChangeXY" class="mdl-button mdl-js-button ">Yes</button><button id="noChangeXY" class="mdl-button mdl-js-button">No</button></div>');
          $toast.on('click', '#yesChangeXY', function yesChangeXY() {
            var latlng;
            var geocodeObj;
            var geocodeNameEl;
            var geocodeNameEn;
            var geocodeAreaName;
            translate.setActive(true);
            onEndTranslte = translate.on('translateend', function translateEnd(e) {
              // var geocodeObj;
              coords = ol.proj.transform(e.features.item(0).getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
              latlng = coords[1] + '\,' + coords[0];
              geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
                latlng: latlng,
                key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ'
              }, function (json, textStatus) {
                return json.results;
              });
              geocodeObj.then(function () {
                geocodeNameEl = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
                geocodeNameEn = string_el_to_url(geocodeNameEl);
                obj.street_el = geocodeNameEl;
                obj.street_en = geocodeNameEn;
                geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
                obj.area_name = geocodeAreaName;
                dataForm(obj, coords);
              });
            });
          });
          $toast.on('click', '#noChangeXY', function noChangeXY() {
            translate.setActive(false);
            toastr.clear();
            dataForm(obj, coords);
          });
        })
        .fail(function failed() {
          toastr.error('Oops Something Went Wrong!!!');
        });
    }
  });

  function dataForm(obj, coords) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyUpdate', obj, function renderPropertyUpdate(err, out) {
      var oldValues = {};
      $('.modal-content').html(out);
      oldValues.bedrooms = $('#bedrooms').val();
      oldValues.street_en = $('#street_en').val();
      oldValues.street_el = $('#street_el').val();
      oldValues.area_name = $('#area_name').val();
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'updateProperty',
        submitBtnId: 'update'
      });
      // $('#street_el').val(obj.geocodeName_el);
      // $('#street_en').val(obj.geocodeName_en);
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');
        }
      });
      $('#update').on('click', function update(event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (!_.isNil(data)) {
          data.x = coords[0];
          data.y = coords[1];
          data.gid = gid;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'PUT',
            data: data
          })
            .done(function completed(response, textStatus, jqXHR) {
              toastr.clear();
              toastr.success('Property with gid ' + response.propertygid + ' Updated in Database');
            })
            .fail(function failed(jqXHR, textStatus, errorThrown) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find this property!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            })
            .always(function always() {
              propertySource.clear();
              select.getFeatures().clear();
              select.setActive(false);
              translate.unByKey(onEndTranslte);
              translate.setActive(false);
              map.on('click', clickInfo);
              $('.modal-dialog').addClass('visuallyhidden');
            });
        }
      });
      $('#cancelUpdate').on('click', function cancelUpdate(event) {
        event.preventDefault();
        handleForm.clear();
        propertySource.clear();
        select.getFeatures().clear();
        translate.unByKey(onEndTranslte);
        select.setActive(false);
        translate.setActive(false);
        map.on('click', clickInfo);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
    });
  }

  $('#adminMap').removeAttr('style');
});
$(document).ready(function () {
  window.Parsley.on('field:error', function () {
    // This global callback will be called for any field that fails validation.
    console.log('Validation failed for: ', this.$element);
  });
  window.Parsley
    .addValidator('date', {
      requirementType: 'string',
      validateString: function (value, requirement) {
        if (moment(value, 'DD-MM-YYYY', true).isValid() === true) {
          return true;
        }
        return false;
      },
      messages: {
        en: 'Wrong Date',
        el: 'Λάθος Ημερομηνία'
      }
    });
});

function string_el_to_url(string) {
  var originalString = string;
  var newString;
  var replace = new Array('α', 'ά', 'Ά', 'Α', 'β', 'Β', 'γ', 'Γ', 'δ', 'Δ', 'ε', 'έ', 'Ε', 'Έ', 'ζ', 'Ζ', 'η', 'ή', 'Η', 'θ', 'Θ', 'ι', 'ί', 'ϊ', 'ΐ', 'Ι', 'Ί', 'κ', 'Κ', 'λ', 'Λ', 'μ', 'Μ', 'ν', 'Ν', 'ξ', 'Ξ', 'ο', 'ό', 'Ο', 'Ό', 'π', 'Π', 'ρ', 'Ρ', 'σ', 'ς', 'Σ', 'τ', 'Τ', 'υ', 'ύ', 'Υ', 'Ύ', 'φ', 'Φ', 'χ', 'Χ', 'ψ', 'Ψ', 'ω', 'ώ', 'Ω', 'Ώ', ' ', '\'', '\'', ',');
  var replace_n = new Array('a', 'a', 'A', 'A', 'v', 'V', 'g', 'G', 'd', 'D', 'e', 'e', 'E', 'E', 'z', 'Z', 'i', 'i', 'I', 'th', 'Th', 'i', 'i', 'i', 'i', 'I', 'I', 'k', 'K', 'l', 'L', 'm', 'M', 'n', 'N', 'x', 'X', 'o', 'o', 'O', 'O', 'p', 'P', 'r', 'R', 's', 's', 'S', 't', 'T', 'u', 'u', 'Y', 'Y', 'f', 'F', 'ch', 'Ch', 'ps', 'Ps', 'o', 'o', 'O', 'O', ' ', '_', '_', '_');

  for (var i = 0; i < replace.length; i++) {
    originalString = originalString.replace(new RegExp(replace[i], 'g'), replace_n[i]);
  }
  newString = originalString;
  return newString;
}
$(document)
  .ajaxStart(function () {
    $loading.addClass('is-active');
  })
  .ajaxStop(function () {
    $loading.removeClass('is-active');
  });

var handleForm = (function ($, parsley) {
  'use strict';
  var formName, submitBtnId, p;

  function setOptions(options) {
    formName = options.name;
    submitBtnId = options.submitBtnId;
    enableSelect();
  }
  function enableSelect() {
    var e = $('.getmdl-select');
    e.each(function () {
      addEventListeners(this);
    });
  }
  function addEventListeners(e) {
    var t = e.querySelector('input'),
      n = e.querySelectorAll('li');
    e.querySelector('i');
    [].forEach.call(n, function (e) {
      e.onclick = function () {
        t.value = e.textContent;
      };
    });
  }
  function disableSubmitBtn() {
    $('#' + submitBtnId + '').prop('disabled', true);
  }

  function createValidator() {
    p = $('form[name="' + formName + '"').parsley();
    return true;
  }

  function destroyValidator() {
    p.destroy();
  }

  function validateForm() {
    return p.validate();
  }

  function onValidateFormSuccess() {
    p.on('form:success',

      function () {});
  }
  function setAttributes(atr) {
    $('#street_el').val(atr.street_el);
    $('#street_en').val(atr.street_en);
  }
  function getAttributes() {
    var obj = {};
    createValidator();
    if (validateForm() === true) {
      $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-radio__button').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-selectfield__select').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      return obj;
    }
    else return null;
  }

  function resetForm() {
    if (createValidator() == true) {
      destroyValidator();
    }
    $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

      function (index, element) {
        $(this).val('');
        $(this).parent().eq(0).removeClass('is-dirty');
        $(this).parent().eq(0).removeClass('is-invalid');
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

      function (index, element) {
        $(this).prop('checked', false);
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox').each(

      function (index, element) {
        $(this).removeClass('is-checked');
      });
  }
  return {
    set: setOptions,
    get: getAttributes,
    clear: resetForm,
    setAttributes: setAttributes
  // createValidator: createValidator,
  // destroyValidator: destroyValidator,
  // validateForm: validateForm,
  // onValidateFormSuccess: onValidateFormSuccess,
  // disableSubmitBtn: disableSubmitBtn
  };
}(jQuery, parsley));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFkbWluLmpzIiwiaGFuZGxlRm9ybS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2g1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhZG1pbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgJGxvYWRpbmcgPSAkKCcubWRsLXNwaW5uZXInKTtcclxudmFyIGNlbnRlciA9IFszNjc3Mzg1LCA0MTIwOTQ5XTtcclxudmFyIGV4dGVudCA9IFszNjUyNzcyLCA0MTEyODA4LCAzNzAwMDAwLCA0MTMyNzk3XTtcclxudmFyIGxhbmcgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZztcclxudmFyIGdlb0pTT05Gb3JtYXQgPSBuZXcgb2wuZm9ybWF0Lkdlb0pTT04oe1xyXG4gIGRlZmF1bHREYXRhUHJvamVjdGlvbjogJ0VQU0c6NDMyNidcclxufSk7XHJcbnZhciBwcm9wZXJ0eVNvdXJjZTtcclxudmFyIHByb3BlcnR5O1xyXG52YXIgbWFwO1xyXG52YXIgZmVhdHVyZXM7XHJcbnZhciBkcmF3blByb3BlcnRpZXM7XHJcbnZhciBkcmF3O1xyXG52YXIgc2VsZWN0O1xyXG52YXIgdHJhbnNsYXRlO1xyXG52YXIgYmluZztcclxudmFyIG1hcGJveDtcclxudG9hc3RyLm9wdGlvbnMgPSB7XHJcbiAgY2xvc2VCdXR0b246IGZhbHNlLFxyXG4gIGRlYnVnOiBmYWxzZSxcclxuICBuZXdlc3RPblRvcDogZmFsc2UsXHJcbiAgcHJvZ3Jlc3NCYXI6IGZhbHNlLFxyXG4gIHBvc2l0aW9uQ2xhc3M6ICd0b2FzdC10b3AtY2VudGVyJyxcclxuICBwcmV2ZW50RHVwbGljYXRlczogZmFsc2UsXHJcbiAgb25jbGljazogbnVsbCxcclxuICBzaG93RHVyYXRpb246ICczMDAnLFxyXG4gIGhpZGVEdXJhdGlvbjogJzEwMDAnLFxyXG4gIHRpbWVPdXQ6ICc1MDAwJyxcclxuICBleHRlbmRlZFRpbWVPdXQ6ICcxMDAwJyxcclxuICBzaG93RWFzaW5nOiAnc3dpbmcnLFxyXG4gIGhpZGVFYXNpbmc6ICdsaW5lYXInLFxyXG4gIHNob3dNZXRob2Q6ICdmYWRlSW4nLFxyXG4gIGhpZGVNZXRob2Q6ICdmYWRlT3V0J1xyXG59O1xyXG5iaW5nID0gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gIHZpc2libGU6IHRydWUsXHJcbiAgc291cmNlOiBuZXcgb2wuc291cmNlLkJpbmdNYXBzKHtcclxuICAgIGtleTogJ0FrMkdxOFZVZklDc1BwdWY3TFJBTlhtWHQyc0hXbVNMUGhvaG1WTEZ0RklFd1lqc181TUN5QWhBRndSU1ZwTGonLFxyXG4gICAgaW1hZ2VyeVNldDogJ0FlcmlhbCdcclxuICB9KSxcclxuICBtYXhab29tOiAxOSxcclxuICBjcm9zc09yaWdpbjogJ2Fub255bW91cycsXHJcbiAgcHJlbG9hZDogSW5maW5pdHksXHJcbiAgaWQ6ICdiaW5nJ1xyXG59KTtcclxubWFwYm94ID0gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5YWVooe1xyXG4gICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgaHRtbDogJzxhIGhyZWY9XCJodHRwczovL3d3dy5tYXBib3guY29tL2Fib3V0L21hcHMvXCIgdGFyZ2V0PVwiX2JsYW5rXCI+JmNvcHk7IE1hcGJveCAmY29weTsgT3BlblN0cmVldE1hcDwvYT4nXHJcbiAgICB9KV0sXHJcbiAgICB1cmw6ICdodHRwczovL2FwaS5tYXBib3guY29tL3Y0L21hcGJveC5zdHJlZXRzL3t6fS97eH0ve3l9LnBuZz9hY2Nlc3NfdG9rZW49cGsuZXlKMUlqb2labWx5ZG1GcGJpSXNJbUVpT2lKbE9XWXlZVE0wTlRoaU5XTTBZakpqT0RKak5ERTRPRFF6TnpBMk1HUXlOaUo5Li1OVkRPMjdIenQtd19uUW9zVVBmTEEnXHJcbiAgfSksXHJcbiAgaWQ6ICdtYXBib3gnXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZ2V0SWNvblR5cGUoZXN0YXRlVHlwZSkge1xyXG4gIHZhciBpY29uVHlwZSA9IHtcclxuICAgIEFwYXJ0bWVudDogZnVuY3Rpb24gZ2V0QXBhcnRtZW50SWNvbigpIHtcclxuICAgICAgcmV0dXJuICdhcGFydG1lbnQnO1xyXG4gICAgfSxcclxuICAgIFN0b3JlOiBmdW5jdGlvbiBnZXRTdG9yZUljb24oKSB7XHJcbiAgICAgIHJldHVybiAnc3RvcmUnO1xyXG4gICAgfSxcclxuICAgICdEZXRhY2hlZCBIb3VzZSc6IGZ1bmN0aW9uIGdldERldGFjaGVkSG91c2VJY29uKCkge1xyXG4gICAgICByZXR1cm4gJ2RldGFjaGVkJztcclxuICAgIH0sXHJcbiAgICBNYWlzb25ldHRlOiBmdW5jdGlvbiBnZXRNYWlzb25ldHRlSWNvbigpIHtcclxuICAgICAgcmV0dXJuICdtYWlzb25ldHRlJztcclxuICAgIH0sXHJcbiAgICBWaWxsYTogZnVuY3Rpb24gZ2V0VmlsbGFJb24oKSB7XHJcbiAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgcmV0dXJuIChpY29uVHlwZVtlc3RhdGVUeXBlXSkoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0SWNvblBhdGgobGlzdGluZ1R5cGUpIHtcclxuICB2YXIgaWNvblBhdGggPSB7XHJcbiAgICB0cnVlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9zYWxlLyc7XHJcbiAgICB9LFxyXG4gICAgZmFsc2U6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuICcuL2ltYWdlcy9waW5zL3JlbnQvJztcclxuICAgIH0sXHJcbiAgICBub25lOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9ub25lLyc7XHJcbiAgICB9XHJcbiAgfTtcclxuICByZXR1cm4gKGljb25QYXRoW2xpc3RpbmdUeXBlXSkoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gUHJvcGVydHlTdHlsZShmZWF0dXJlKSB7XHJcbiAgdmFyIHNyYztcclxuICBzcmMgPSBnZXRJY29uUGF0aCgnbm9uZScpICsgZ2V0SWNvblR5cGUoZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGVfZW4nKSkgKyAnLTQ4LnBuZyc7XHJcbiAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgc3JjOiBzcmMsXHJcbiAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgYW5jaG9yOiBbXHJcbiAgICAgICAgMC41LCAwXHJcbiAgICAgIF0sXHJcbiAgICAgIHNjYWxlOiAxXHJcbiAgICB9KSlcclxuICB9KTtcclxufVxyXG5wcm9wZXJ0eVNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuICBmb3JtYXQ6IGdlb0pTT05Gb3JtYXQsXHJcbiAgbG9hZGVyOiBmdW5jdGlvbiAoZXh0ZW50LCByZXNvbHV0aW9uLCBwcm9qZWN0aW9uKSB7XHJcbiAgICB2YXIgdXJsID0gJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9wcm9wZXJ0eS8nICsgaWQ7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICAvLyBzZWxmLmNsZWFyKCk7XHJcbiAgICAkLmFqYXgoe1xyXG4gICAgICB1cmw6IHVybCxcclxuICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgIH0pXHJcbiAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgdmFyIG5ld0ZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMoZGF0YSwge1xyXG4gICAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICB9KTtcclxuICAgICAgc2VsZi5hZGRGZWF0dXJlcyhuZXdGZWF0dXJlcyk7XHJcbiAgICB9KVxyXG4gICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgdGhpcyBwcm9wZXJ0eSEnKTtcclxuICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZScpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufSk7XHJcbnByb3BlcnR5ID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgc291cmNlOiBwcm9wZXJ0eVNvdXJjZSxcclxuICBpZDogJ3Byb3BlcnR5JyxcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHN0eWxlOiBQcm9wZXJ0eVN0eWxlXHJcbn0pO1xyXG5wcm9wZXJ0eS5zZXRaSW5kZXgoMik7XHJcbm1hcCA9IG5ldyBvbC5NYXAoe1xyXG4gIHRhcmdldDogJ2FkbWluTWFwJyxcclxuICBsYXllcnM6IFtcclxuICAgIG1hcGJveCwgcHJvcGVydHlcclxuICBdLFxyXG4gIGxvYWRUaWxlc1doaWxlQW5pbWF0aW5nOiB0cnVlLFxyXG4gIGxvYWRUaWxlc1doaWxlSW50ZXJhY3Rpbmc6IHRydWUsXHJcbiAgcmVuZGVyZXI6ICdjYW52YXMnLFxyXG4gIGNvbnRyb2xzOiBvbC5jb250cm9sLmRlZmF1bHRzKHtcclxuICAgIGF0dHJpYnV0aW9uT3B0aW9uczoge1xyXG4gICAgICBjb2xsYXBzaWJsZTogZmFsc2UsXHJcbiAgICAgIGNvbGxhcHNlZDogZmFsc2VcclxuICAgIH1cclxuICB9KS5leHRlbmQoW1xyXG4gICAgbmV3IG9sLmNvbnRyb2wuU2NhbGVMaW5lKHtcclxuICAgICAgdW5pdHM6ICdtZXRyaWMnXHJcbiAgICB9KSxcclxuICAgIG5ldyBvbC5jb250cm9sLk92ZXJ2aWV3TWFwKHtcclxuICAgICAgY2xhc3NOYW1lOiAnb2wtb3ZlcnZpZXdtYXAgb2wtY3VzdG9tLW92ZXJ2aWV3bWFwJyxcclxuICAgICAgY29sbGFwc2libGU6IHRydWUsXHJcbiAgICAgIGNvbGxhcHNlZDogdHJ1ZSxcclxuICAgICAgbGF5ZXJzOiBbYmluZ11cclxuICAgIH0pLFxyXG4gICAgbmV3IG9sLmNvbnRyb2wuWm9vbVRvRXh0ZW50KHtcclxuICAgICAgZXh0ZW50OiBleHRlbnRcclxuICAgIH0pXHJcbiAgXSksXHJcbiAgdmlldzogbmV3IG9sLlZpZXcoe1xyXG4gICAgY2VudGVyOiBjZW50ZXIsXHJcbiAgICBleHRlbnQ6IGV4dGVudCxcclxuICAgIHByb2plY3Rpb246ICdFUFNHOjM4NTcnLFxyXG4gICAgem9vbTogMTQsXHJcbiAgICBtYXhab29tOiAxOSxcclxuICAgIG1pblpvb206IDE0XHJcbiAgfSlcclxufSk7XHJcbmlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgYmluZy5zZXQoJ25hbWUnLCAnzpTOv8+Bz4XPhs6/z4HOuc66zq4gzrXOuc66z4zOvc6xJyk7XHJcbiAgbWFwYm94LnNldCgnbmFtZScsICfOp86sz4HPhM63z4InKTtcclxuICBwcm9wZXJ0eS5zZXQoJ25hbWUnLCAnzpHOus6vzr3Ot8+EzrEnKTtcclxufSBlbHNlIHtcclxuICBiaW5nLnNldCgnbmFtZScsICdTYXR0ZWxpdGUgSW1hZ2UnKTtcclxuICBtYXBib3guc2V0KCduYW1lJywgJ01hcCcpO1xyXG4gIHByb3BlcnR5LnNldCgnbmFtZScsICdQcm9wZXJ0aWVzJyk7XHJcbn1cclxuLy8gPT09PT09IGludGVyYWN0aW9ucyA9PT09PT1cclxuZmVhdHVyZXMgPSBuZXcgb2wuQ29sbGVjdGlvbigpO1xyXG5cclxuZnVuY3Rpb24gZHJhd25Qcm9wZXJ0aWVzU3R5bGUoY29sb3IpIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9ICcuL2ltYWdlcy9waW5zL2dlbmVyaWMtNDgucG5nJztcclxuICBpZiAodHlwZW9mIGNvbG9yICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICAgIHNyYzogc3JjLFxyXG4gICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICBhbmNob3I6IFtcclxuICAgICAgICAgIDAuNSwgMFxyXG4gICAgICAgIF0sXHJcbiAgICAgICAgc2NhbGU6IDEsXHJcbiAgICAgICAgY29sb3I6IGNvbG9yXHJcbiAgICAgIH0pKVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogW1xyXG4gICAgICAgIDAuNSwgMFxyXG4gICAgICBdLFxyXG4gICAgICBzY2FsZTogMVxyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxuZHJhd25Qcm9wZXJ0aWVzID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgc291cmNlOiBuZXcgb2wuc291cmNlLlZlY3RvcigpLFxyXG4gIGlkOiAnZHJhd25Qcm9wZXJ0aWVzJyxcclxuICBzdHlsZTogZHJhd25Qcm9wZXJ0aWVzU3R5bGUoJyM0Y2FmNTAnKVxyXG59KTtcclxubWFwLmFkZExheWVyKGRyYXduUHJvcGVydGllcyk7XHJcbi8vIGRyYXdcclxuZHJhdyA9IG5ldyBvbC5pbnRlcmFjdGlvbi5EcmF3KHtcclxuICAvLyBmZWF0dXJlczogZmVhdHVyZXMsXHJcbiAgc291cmNlOiBkcmF3blByb3BlcnRpZXMuZ2V0U291cmNlKCksXHJcbiAgdHlwZTogJ1BvaW50JyxcclxuICBzdHlsZTogZHJhd25Qcm9wZXJ0aWVzU3R5bGUoJyM0Y2FmNTAnKVxyXG59KTtcclxubWFwLmFkZEludGVyYWN0aW9uKGRyYXcpO1xyXG5kcmF3LnNldEFjdGl2ZShmYWxzZSk7XHJcbi8vIHNlbGVjdFxyXG5mdW5jdGlvbiBzZWxlY3RlZFN0eWxlKGZlYXR1cmUpIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9IGdldEljb25QYXRoKCdub25lJykgKyBnZXRJY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNjQucG5nJztcclxuICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICBzcmM6IHNyYyxcclxuICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICBhbmNob3I6IFswLjUsIDBdLFxyXG4gICAgICBzY2FsZTogMSxcclxuICAgICAgY29sb3I6ICcjZmZlYjNiJ1xyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxuc2VsZWN0ID0gbmV3IG9sLmludGVyYWN0aW9uLlNlbGVjdCh7XHJcbiAgbGF5ZXJzOiBbcHJvcGVydHldLFxyXG4gIGZlYXR1cmVzOiBmZWF0dXJlcyxcclxuICBtdWx0aTogZmFsc2UsXHJcbiAgc3R5bGU6IHNlbGVjdGVkU3R5bGVcclxufSk7XHJcbm1hcC5hZGRJbnRlcmFjdGlvbihzZWxlY3QpO1xyXG5zZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxudHJhbnNsYXRlID0gbmV3IG9sLmludGVyYWN0aW9uLlRyYW5zbGF0ZSh7XHJcbiAgZmVhdHVyZXM6IHNlbGVjdC5nZXRGZWF0dXJlcygpXHJcbn0pO1xyXG5tYXAuYWRkSW50ZXJhY3Rpb24odHJhbnNsYXRlKTtcclxudHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbi8vID09PT09PSBpbmZvID09PT09PVxyXG5tYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuXHJcbmZ1bmN0aW9uIGNsaWNrSW5mbyhldmVudCkge1xyXG4gIHZhciBvYmogPSB7fTtcclxuXHJcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICBzZWxlY3Quc2V0QWN0aXZlKHRydWUpO1xyXG4gIHNlbGVjdC5vbmNlKCdzZWxlY3QnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZXMgPSBlLnNlbGVjdGVkO1xyXG4gICAgdmFyIGxlbmd0aCA9IHNlbGVjdGVkRmVhdHVyZXMubGVuZ3RoO1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZTtcclxuICAgIGlmIChsZW5ndGggPT09IDEpIHtcclxuICAgICAgb2JqLmZlYXR1cmUgPSB7fTtcclxuICAgICAgc2VsZWN0ZWRGZWF0dXJlID0gXy5oZWFkKGUuc2VsZWN0ZWQpO1xyXG4gICAgICAvLyBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLnNldFNjYWxlKDEuMik7XHJcbiAgICAgIHNlbGVjdGVkRmVhdHVyZS5nZXRLZXlzKCkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgb2JqLmZlYXR1cmVba2V5XSA9IHNlbGVjdGVkRmVhdHVyZS5nZXQoa2V5KTtcclxuICAgICAgfSk7XHJcbiAgICAgIGR1c3QucmVuZGVyKCdhZG1pblByb3BlcnR5SW5mbycsIG9iaiwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICAgJCgnLnByb3BlcnR5LWluZm8nKS5odG1sKG91dCk7XHJcbiAgICAgICAgJCgnLnByb3BlcnR5LWluZm8nKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgICAkKCcjbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgdmFyIGdpZDtcclxuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICBnaWQgPSAkKHRoaXMpLmRhdGEoJ2dpZCcpO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBnaWQ6IGdpZCxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZShmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgIHZhciBsaXN0aW5nX2lkID0gZGF0YS5pZDtcclxuICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuY3NzKCd3aWR0aCcsICdhdXRvJyk7XHJcbiAgICAgICAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgIGR1c3QucmVuZGVyKCdsaXN0aW5nSW5zZXJ0JywgZGF0YSwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICAgICAgICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5zZXQoe1xyXG4gICAgICAgICAgICAgICAgICBuYW1lOiAnaW5zZXJ0LXVwZGF0ZS1saXN0aW5nJyxcclxuICAgICAgICAgICAgICAgICAgc3VibWl0QnRuSWQ6ICdvaycsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmICgkKCdpbnB1dFtuYW1lPW9wdGlvbnNdOmNoZWNrZWQnKS52YWwoKSA9PT0gJ1NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucGFyZW50KCkuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAkKCdpbnB1dFtuYW1lPW9wdGlvbnNdJykub24oJ2NoYW5nZScsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ1NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnBhcmVudCgpLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCdsYWJlbFtmb3I9cGV0c10nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnZhbCgnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnBhcmVudCgpLnNob3coKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5zaG93KCk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgJCgnI3NlbnQtbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICB2YXIgZGF0YTtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgZGF0YSA9IGhhbmRsZUZvcm0uZ2V0KCk7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wcm9wZXJ0eV9naWQgPSBnaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5saXN0aW5nX2lkID0gbGlzdGluZ19pZDtcclxuICAgICAgICAgICAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdQVVQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnXHJcbiAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgLmRvbmUoZnVuY3Rpb24gKGRhdGEsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSBVcGRhdGVkIEluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdPb3BzIFNvbWV0aGluZyBXZW50IFdyb25nISEhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAuZmFpbChmdW5jdGlvbiAoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAkKCcjY2FuY2VsLWxpc3RpbmcnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICB2YXIgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgICAgICAgICAgIG9iai5tc2cgPSAnzpTOtc69IM6Sz4HOrc64zrfOus61IM6RzrPOs861zrvOr86xJztcclxuICAgICAgICAgICAgICAgIG9iai50ZXh0ID0gJ86UzrfOvM65zr/Phc+BzrPOr86xIM6azrHOuc69zr/Pjc+BzrPOuc6xz4I7JztcclxuICAgICAgICAgICAgICAgIG9iai55ZXMgPSAnzp3Okc6ZJztcclxuICAgICAgICAgICAgICAgIG9iai5ubyA9ICfOn86nzpknO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBvYmoubXNnID0gJ05vIExpc3RpbmcgRm91bmQnO1xyXG4gICAgICAgICAgICAgICAgb2JqLnRleHQgPSAnQ3JlYXRlIE5ldyBMaXN0aW5nPyc7XHJcbiAgICAgICAgICAgICAgICBvYmoueWVzID0gJ1lFUyc7XHJcbiAgICAgICAgICAgICAgICBvYmoubm8gPSAnTk8nO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBkdXN0LnJlbmRlcignZGlhbG9nJywgb2JqLCBmdW5jdGlvbiAoZXJyb3IsIG91dCkge1xyXG4gICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmNzcygnd2lkdGgnLCAnYXV0bycpO1xyXG4gICAgICAgICAgICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgICAgICAgICAgICQoJyN5ZXMnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgZHVzdC5yZW5kZXIoJ2xpc3RpbmdJbnNlcnQnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVudDogJ3RydWUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFkZEltYWdlOiAndHJ1ZScsXHJcbiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIsIG91dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBteURyb3B6b25lO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIG15RHJvcHpvbmUgPSBuZXcgRHJvcHpvbmUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Ryb3B6b25lJyksIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZE11bHRpcGxlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgIGFjY2VwdGVkRmlsZXM6ICcuanBnJyxcclxuICAgICAgICAgICAgICAgICAgICAgIHBhcmFsbGVsVXBsb2FkczogNixcclxuICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZFJlbW92ZUxpbmtzIDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vYXBpLmNsb3VkaW5hcnkuY29tL3YxXzEvZmlydmFpbi9hdXRvL3VwbG9hZCdcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBteURyb3B6b25lLm9uKCdzZW5kaW5nJywgZnVuY3Rpb24gKGZpbGUsIHhociwgZm9ybURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYXBpX2tleScsIDM3NTEzODkzMjY4OTU5MSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2NhbGxiYWNrJywgJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9wdWJsaWMvY2xvdWRpbmFyeV9jb3JzLmh0bWwnKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgndXBsb2FkX3ByZXNldCcsICd0ZXN0dXBsb2FkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3B1YmxpY19pZCcsIGdpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbXlEcm9wem9uZS5vbignc3VjY2VzcycsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uc2V0KHtcclxuICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdpbnNlcnQtdXBkYXRlLWxpc3RpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgc3VibWl0QnRuSWQ6ICdvaydcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAkKCdpbnB1dFtuYW1lPWZpbGVdJykuY2xvdWRpbmFyeV9maWxldXBsb2FkKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gJCgnaW5wdXRbbmFtZT1maWxlXScpLnVuc2lnbmVkX2Nsb3VkaW5hcnlfdXBsb2FkKCd0ZXN0dXBsb2FkJywge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgY2xvdWRfbmFtZTogJ2ZpcnZhaW4nLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgJ3B1YmxpY19pZCc6IGdpZCxcclxuICAgICAgICAgICAgICAgICAgICAvLyB9KTtcclxuICAgICAgICAgICAgICAgICAgICAkKCdpbnB1dFtuYW1lPW9wdGlvbnNdJykub24oJ2NoYW5nZScsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICdTYWxlJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnbGFiZWxbZm9yPXBldHNdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykudmFsKCcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjc2VudC1saXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gaGFuZGxlRm9ybS5nZXQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHJvcGVydHlfZ2lkID0gZ2lkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gMjAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSBVcGRhdGVkIEluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ09vcHMgU29tZXRoaW5nIFdlbnQgV3JvbmchISEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI2NhbmNlbC1saXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgJCgnI25vJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgLy8gc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICQoJy5wcm9wZXJ0eS1pbmZvJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgIHRvYXN0ci5lcnJvcignQ2FudCBGaW5kIEFueSBQcm9wZXJ0eSBUaGVyZS4uLicpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcbi8vID09PT09PSBsb2dvdXQgPT09PT09XHJcbiQoJyNsb2dvdXQnKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgbG9jYXRpb24uaHJlZiA9ICcvbG9nb3V0JztcclxufSk7XHJcbi8vID09PT09PSBpbnNlcnQgPT09PT09XHJcbiQoJyNpbnNlcnRQcm9wZXJ0eScpLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuICB2YXIgb25FbmREcmF3O1xyXG4gIHRvYXN0ci5jbGVhcigpO1xyXG4gICQoJy5wcm9wZXJ0eS1pbmZvJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgbWFwLnVuKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICBkcmF3LnNldEFjdGl2ZSh0cnVlKTtcclxuICBvbkVuZERyYXcgPSBkcmF3Lm9uKCdkcmF3ZW5kJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgb2JqID0ge307XHJcbiAgICB2YXIgY29vcmRzO1xyXG4gICAgdmFyIGdlb2NvZGVPYmo7XHJcbiAgICB2YXIgbGF0bG5nO1xyXG4gICAgdmFyIGdlb2NvZGVOYW1lX2VsO1xyXG4gICAgdmFyIGdlb2NvZGVOYW1lX2VuO1xyXG4gICAgdmFyIGdlb2NvZGVBcmVhTmFtZTtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBkcmF3LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICBjb29yZHMgPSBvbC5wcm9qLnRyYW5zZm9ybShldmVudC5mZWF0dXJlLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgIG9iai5jb29yZHMgPSBjb29yZHM7XHJcbiAgICBsYXRsbmcgPSBjb29yZHNbMV0gKyAnXFwsJyArIGNvb3Jkc1swXTtcclxuICAgIGdlb2NvZGVPYmogPSAkLmdldEpTT04oJ2h0dHBzOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9nZW9jb2RlL2pzb24nLCB7XHJcbiAgICAgIGxhdGxuZzogbGF0bG5nLFxyXG4gICAgICBrZXk6ICdBSXphU3lDa0gzOV9FejIxX1JsQ19walhEMDl6cEpfIC0gZVZoekNyUScsXHJcbiAgICB9LCBmdW5jdGlvbiAoanNvbiwgdGV4dFN0YXR1cykge1xyXG4gICAgICByZXR1cm4ganNvbjtcclxuICAgIH0pO1xyXG4gICAgZ2VvY29kZU9iai50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgZ2VvY29kZU5hbWVfZWwgPSBfLmhlYWQoXy5oZWFkKGdlb2NvZGVPYmoucmVzcG9uc2VKU09OLnJlc3VsdHMpLmFkZHJlc3NfY29tcG9uZW50cykubG9uZ19uYW1lO1xyXG4gICAgICBnZW9jb2RlTmFtZV9lbiA9IHN0cmluZ19lbF90b191cmwoZ2VvY29kZU5hbWVfZWwpO1xyXG4gICAgICBvYmouc3RyZWV0X2VsID0gZ2VvY29kZU5hbWVfZWw7XHJcbiAgICAgIG9iai5zdHJlZXRfZW4gPSBnZW9jb2RlTmFtZV9lbjtcclxuICAgICAgZ2VvY29kZUFyZWFOYW1lID0gXy5maXJzdChfLmRyb3AoXy5tYXAoXy5oZWFkKGdlb2NvZGVPYmoucmVzcG9uc2VKU09OLnJlc3VsdHMpLmFkZHJlc3NfY29tcG9uZW50cywgJ2xvbmdfbmFtZScpKSk7XHJcbiAgICAgIG9iai5hcmVhX25hbWUgPSBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICAgIGRhdGFGb3JtKG9iaik7XHJcbiAgICB9KTtcclxuXHJcbiAgfSk7XHJcblxyXG4gIGZ1bmN0aW9uIGRhdGFGb3JtKG9iaikge1xyXG4gICAgJCgnLm1vZGFsLWRpYWxvZycpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgZHVzdC5yZW5kZXIoJ3Byb3BlcnR5SW5zZXJ0Jywgb2JqLCBmdW5jdGlvbiAoZXJyLCBvdXQpIHtcclxuICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICBoYW5kbGVGb3JtLnNldCh7XHJcbiAgICAgICAgbmFtZTogJ2luc2VydFByb3BlcnR5JyxcclxuICAgICAgICBzdWJtaXRCdG5JZDogJ2luc2VydCdcclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNlc3RhdGVUeXBlJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdEZXRhY2hlZCBIb3VzZScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdEZXRhY2hlZCBIb3VzZScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICfOlM65zrHOvM6tz4HOuc+DzrzOsScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdBcGFydG1lbnQnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86Iz4DOsc+FzrvOtycpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdWaWxsYScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdWaWxsYScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ01haXNvbmV0dGUnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnTWFpc29uZXR0ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0RldGFjaGVkIEhvdXNlJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnQXBhcnRtZW50Jykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86UzrnOsc68zq3Pgc65z4POvM6xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86UzrnOsc68zq3Pgc65z4POvM6xJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ1ZpbGxhJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86Iz4DOsc+FzrvOtycpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOiM+AzrHPhc67zrcnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOnM61zrbOv869zq3PhM6xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86czrXOts6/zr3Orc+EzrEnKTtcclxuXHJcblxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNjYW5jZWxJbnNlcnQnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICBkcmF3blByb3BlcnRpZXMuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICBkcmF3LnVuQnlLZXkob25FbmREcmF3KTtcclxuICAgICAgICAkKCcubW9kYWwtZGlhbG9nJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjaW5zZXJ0Jykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIGRhdGE7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBkYXRhID0gaGFuZGxlRm9ybS5nZXQoKTtcclxuICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgZGF0YS54ID0gb2JqLmNvb3Jkc1swXTtcclxuICAgICAgICAgIGRhdGEueSA9IG9iai5jb29yZHNbMV07XHJcbiAgICAgICAgICBkYXRhLmFkbWluSWQgPSBpZDtcclxuICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9wcm9wZXJ0eScsXHJcbiAgICAgICAgICAgIHR5cGU6ICdQT1NUJyxcclxuICAgICAgICAgICAgZGF0YTogZGF0YVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZCgpIHtcclxuICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSBSZWNvcmRlZCBJbiBEYXRhYmFzZScpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIHRoaXMgcHJvcGVydHkhJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgIGRyYXduUHJvcGVydGllcy5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGRyYXcudW5CeUtleShvbkVuZERyYXcpO1xyXG4gICAgICAgICAgICAkKCcubW9kYWwtZGlhbG9nJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxufSk7XHJcbi8vID09PT09PSBkZWxldGUgPT09PT09XHJcbiQoJyNkZWxldGVQcm9wZXJ0eScpLmNsaWNrKGZ1bmN0aW9uIChldmVudCkge1xyXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgJCgnLnByb3BlcnR5LWluZm8nKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICBtYXAudW4oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICBkcmF3LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgZmVhdHVyZXMuY2xlYXIoKTtcclxuICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgc2VsZWN0LnNldEFjdGl2ZSh0cnVlKTtcclxuICBzZWxlY3Qub25jZSgnc2VsZWN0JywgZnVuY3Rpb24gKGUpIHtcclxuICAgIHZhciAkdG9hc3Q7XHJcbiAgICBpZiAoZS50YXJnZXQuZ2V0RmVhdHVyZXMoKS5nZXRMZW5ndGgoKSA9PT0gMSkge1xyXG4gICAgICAkdG9hc3QgPSB0b2FzdHIud2FybmluZygnPHA+QXJlIHlvdSBzdXJlPzwvcD48ZGl2IGNsYXNzPVwidG9hc3RyLWJ0bnNcIj48YnV0dG9uIGlkPVwieWVzRGVsZXRlXCIgY2xhc3M9XCJtZGwtYnV0dG9uIG1kbC1qcy1idXR0b24gXCI+WWVzPC9idXR0b24+PGJ1dHRvbiBpZD1cIm5vRGVsZXRlXCIgY2xhc3M9XCJtZGwtYnV0dG9uIG1kbC1qcy1idXR0b25cIj5ObzwvYnV0dG9uPjwvZGl2PicpO1xyXG4gICAgICAkdG9hc3Qub24oJ2NsaWNrJywgJyN5ZXNEZWxldGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGdpZCA9IHNlbGVjdC5nZXRGZWF0dXJlcygpLml0ZW0oMCkuZ2V0KCdnaWQnKTtcclxuICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3Byb3BlcnR5JyxcclxuICAgICAgICAgIHR5cGU6ICdERUxFVEUnLFxyXG4gICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgZ2lkOiBnaWRcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgICAgLmRvbmUoZnVuY3Rpb24gY29tcGxldGVkKGRhdGEsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgU3VjY2Vzc2Z1bGx5IERlbGV0ZWQgd2l0aCBpZCA9ICcgKyBkYXRhLnByb3BlcnR5Z2lkICsgJyBmcm9tIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgdGhpcyBwcm9wZXJ0eSEnKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZScpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuYWx3YXlzKGZ1bmN0aW9uIGFsd2F5cygpIHtcclxuICAgICAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICR0b2FzdC5yZW1vdmUoKTtcclxuICAgICAgfSk7XHJcbiAgICAgICR0b2FzdC5vbignY2xpY2snLCAnI25vRGVsZXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICR0b2FzdC5yZW1vdmUoKTtcclxuICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9KTtcclxufSk7XHJcblxyXG4vLyA9PT09PT0gdXBkYXRlID09PT09PVxyXG5cclxuJCgnI3VwZGF0ZVByb3BlcnR5Jykub24oJ2NsaWNrJywgZnVuY3Rpb24gdXBkYXRlUHJvcGVydHkoZXZlbnQpIHtcclxuICB2YXIgZ2lkO1xyXG4gIHZhciBvYmo7XHJcbiAgdmFyIGNvb3JkcztcclxuICB2YXIgb25FbmRUcmFuc2x0ZTtcclxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIHRvYXN0ci5jbGVhcigpO1xyXG4gIG1hcC51bignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICBmZWF0dXJlcy5jbGVhcigpO1xyXG4gIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICBzZWxlY3Quc2V0QWN0aXZlKHRydWUpO1xyXG4gICQoJy5wcm9wZXJ0eS1pbmZvJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgc2VsZWN0Lm9uY2UoJ3NlbGVjdCcsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICB2YXIgc2VsZWN0ZWRGZWF0dXJlcyA9IGUuc2VsZWN0ZWQ7XHJcbiAgICB2YXIgbGVuZ3RoID0gc2VsZWN0ZWRGZWF0dXJlcy5sZW5ndGg7XHJcbiAgICB2YXIgc2VsZWN0ZWRGZWF0dXJlO1xyXG4gICAgaWYgKGxlbmd0aCA9PT0gMSkge1xyXG4gICAgICBnaWQgPSBfLmhlYWQoZS5zZWxlY3RlZCkuZ2V0KCdnaWQnKTtcclxuICAgICAgc2VsZWN0ZWRGZWF0dXJlID0gXy5oZWFkKGUuc2VsZWN0ZWQpO1xyXG4gICAgICBjb29yZHMgPSBvbC5wcm9qLnRyYW5zZm9ybShzZWxlY3RlZEZlYXR1cmUuZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpLCAnRVBTRzozODU3JywgJ0VQU0c6NDMyNicpO1xyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9wcm9wZXJ0eScsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICBnaWQ6IGdpZFxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQoZGF0YSkge1xyXG4gICAgICAgICAgdmFyICR0b2FzdCA9IHt9O1xyXG4gICAgICAgICAgJHRvYXN0Lm9wdGlvbnMgPSB7fTtcclxuICAgICAgICAgIG9iaiA9IF8uaGVhZChkYXRhLmZlYXR1cmVzKS5wcm9wZXJ0aWVzO1xyXG4gICAgICAgICAgY29uc29sZS5sb2cob2JqKVxyXG5cclxuICAgICAgICAgICR0b2FzdCA9IHRvYXN0ci53YXJuaW5nKCc8cD5DaGFuZ2UgUHJvcGVydHkgQ29vcmRpbmF0ZXM/PC9wPjxkaXYgY2xhc3M9XCJ0b2FzdHItYnRuc1wiPjxidXR0b24gaWQ9XCJ5ZXNDaGFuZ2VYWVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uIFwiPlllczwvYnV0dG9uPjxidXR0b24gaWQ9XCJub0NoYW5nZVhZXCIgY2xhc3M9XCJtZGwtYnV0dG9uIG1kbC1qcy1idXR0b25cIj5ObzwvYnV0dG9uPjwvZGl2PicpO1xyXG4gICAgICAgICAgJHRvYXN0Lm9uKCdjbGljaycsICcjeWVzQ2hhbmdlWFknLCBmdW5jdGlvbiB5ZXNDaGFuZ2VYWSgpIHtcclxuICAgICAgICAgICAgdmFyIGxhdGxuZztcclxuICAgICAgICAgICAgdmFyIGdlb2NvZGVPYmo7XHJcbiAgICAgICAgICAgIHZhciBnZW9jb2RlTmFtZUVsO1xyXG4gICAgICAgICAgICB2YXIgZ2VvY29kZU5hbWVFbjtcclxuICAgICAgICAgICAgdmFyIGdlb2NvZGVBcmVhTmFtZTtcclxuICAgICAgICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZSh0cnVlKTtcclxuICAgICAgICAgICAgb25FbmRUcmFuc2x0ZSA9IHRyYW5zbGF0ZS5vbigndHJhbnNsYXRlZW5kJywgZnVuY3Rpb24gdHJhbnNsYXRlRW5kKGUpIHtcclxuICAgICAgICAgICAgICAvLyB2YXIgZ2VvY29kZU9iajtcclxuICAgICAgICAgICAgICBjb29yZHMgPSBvbC5wcm9qLnRyYW5zZm9ybShlLmZlYXR1cmVzLml0ZW0oMCkuZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpLCAnRVBTRzozODU3JywgJ0VQU0c6NDMyNicpO1xyXG4gICAgICAgICAgICAgIGxhdGxuZyA9IGNvb3Jkc1sxXSArICdcXCwnICsgY29vcmRzWzBdO1xyXG4gICAgICAgICAgICAgIGdlb2NvZGVPYmogPSAkLmdldEpTT04oJ2h0dHBzOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9nZW9jb2RlL2pzb24nLCB7XHJcbiAgICAgICAgICAgICAgICBsYXRsbmc6IGxhdGxuZyxcclxuICAgICAgICAgICAgICAgIGtleTogJ0FJemFTeUNrSDM5X0V6MjFfUmxDX3BqWEQwOXpwSl8gLSBlVmh6Q3JRJ1xyXG4gICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChqc29uLCB0ZXh0U3RhdHVzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5yZXN1bHRzO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIGdlb2NvZGVPYmoudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBnZW9jb2RlTmFtZUVsID0gXy5oZWFkKF8uaGVhZChnZW9jb2RlT2JqLnJlc3BvbnNlSlNPTi5yZXN1bHRzKS5hZGRyZXNzX2NvbXBvbmVudHMpLmxvbmdfbmFtZTtcclxuICAgICAgICAgICAgICAgIGdlb2NvZGVOYW1lRW4gPSBzdHJpbmdfZWxfdG9fdXJsKGdlb2NvZGVOYW1lRWwpO1xyXG4gICAgICAgICAgICAgICAgb2JqLnN0cmVldF9lbCA9IGdlb2NvZGVOYW1lRWw7XHJcbiAgICAgICAgICAgICAgICBvYmouc3RyZWV0X2VuID0gZ2VvY29kZU5hbWVFbjtcclxuICAgICAgICAgICAgICAgIGdlb2NvZGVBcmVhTmFtZSA9IF8uZmlyc3QoXy5kcm9wKF8ubWFwKF8uaGVhZChnZW9jb2RlT2JqLnJlc3BvbnNlSlNPTi5yZXN1bHRzKS5hZGRyZXNzX2NvbXBvbmVudHMsICdsb25nX25hbWUnKSkpO1xyXG4gICAgICAgICAgICAgICAgb2JqLmFyZWFfbmFtZSA9IGdlb2NvZGVBcmVhTmFtZTtcclxuICAgICAgICAgICAgICAgIGRhdGFGb3JtKG9iaiwgY29vcmRzKTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgICR0b2FzdC5vbignY2xpY2snLCAnI25vQ2hhbmdlWFknLCBmdW5jdGlvbiBub0NoYW5nZVhZKCkge1xyXG4gICAgICAgICAgICB0cmFuc2xhdGUuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGRhdGFGb3JtKG9iaiwgY29vcmRzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKCkge1xyXG4gICAgICAgICAgdG9hc3RyLmVycm9yKCdPb3BzIFNvbWV0aGluZyBXZW50IFdyb25nISEhJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGZ1bmN0aW9uIGRhdGFGb3JtKG9iaiwgY29vcmRzKSB7XHJcbiAgICAkKCcubW9kYWwtZGlhbG9nJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICBkdXN0LnJlbmRlcigncHJvcGVydHlVcGRhdGUnLCBvYmosIGZ1bmN0aW9uIHJlbmRlclByb3BlcnR5VXBkYXRlKGVyciwgb3V0KSB7XHJcbiAgICAgIHZhciBvbGRWYWx1ZXMgPSB7fTtcclxuICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgIG9sZFZhbHVlcy5iZWRyb29tcyA9ICQoJyNiZWRyb29tcycpLnZhbCgpO1xyXG4gICAgICBvbGRWYWx1ZXMuc3RyZWV0X2VuID0gJCgnI3N0cmVldF9lbicpLnZhbCgpO1xyXG4gICAgICBvbGRWYWx1ZXMuc3RyZWV0X2VsID0gJCgnI3N0cmVldF9lbCcpLnZhbCgpO1xyXG4gICAgICBvbGRWYWx1ZXMuYXJlYV9uYW1lID0gJCgnI2FyZWFfbmFtZScpLnZhbCgpO1xyXG4gICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgaGFuZGxlRm9ybS5zZXQoe1xyXG4gICAgICAgIG5hbWU6ICd1cGRhdGVQcm9wZXJ0eScsXHJcbiAgICAgICAgc3VibWl0QnRuSWQ6ICd1cGRhdGUnXHJcbiAgICAgIH0pO1xyXG4gICAgICAvLyAkKCcjc3RyZWV0X2VsJykudmFsKG9iai5nZW9jb2RlTmFtZV9lbCk7XHJcbiAgICAgIC8vICQoJyNzdHJlZXRfZW4nKS52YWwob2JqLmdlb2NvZGVOYW1lX2VuKTtcclxuICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5jaGFuZ2UoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzpzOv869zr/Ous6xz4TOv865zrrOr86xJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ0RldGFjaGVkIEhvdXNlJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ0RldGFjaGVkIEhvdXNlJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICfOlM65zrHOvM6tz4HOuc+DzrzOsScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdBcGFydG1lbnQnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICfOiM+AzrHPhc67zrcnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnVmlsbGEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnVmlsbGEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnTWFpc29uZXR0ZScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdNYWlzb25ldHRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5jaGFuZ2UoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICgkKHRoaXMpLnZhbCgpID09PSAnRGV0YWNoZWQgSG91c2UnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpzOv869zr/Ous6xz4TOv865zrrOr86xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnQXBhcnRtZW50Jykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86UzrnOsc68zq3Pgc65z4POvM6xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86UzrnOsc68zq3Pgc65z4POvM6xJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICdWaWxsYScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOiM+AzrHPhc67zrcnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzojPgM6xz4XOu863Jyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86czrXOts6/zr3Orc+EzrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpzOtc62zr/Ovc6tz4TOsScpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICQoJyN1cGRhdGUnKS5vbignY2xpY2snLCBmdW5jdGlvbiB1cGRhdGUoZXZlbnQpIHtcclxuICAgICAgICB2YXIgZGF0YTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGRhdGEgPSBoYW5kbGVGb3JtLmdldCgpO1xyXG4gICAgICAgIGlmICghXy5pc05pbChkYXRhKSkge1xyXG4gICAgICAgICAgZGF0YS54ID0gY29vcmRzWzBdO1xyXG4gICAgICAgICAgZGF0YS55ID0gY29vcmRzWzFdO1xyXG4gICAgICAgICAgZGF0YS5naWQgPSBnaWQ7XHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHknLFxyXG4gICAgICAgICAgICB0eXBlOiAnUFVUJyxcclxuICAgICAgICAgICAgZGF0YTogZGF0YVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmRvbmUoZnVuY3Rpb24gY29tcGxldGVkKHJlc3BvbnNlLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSB3aXRoIGdpZCAnICsgcmVzcG9uc2UucHJvcGVydHlnaWQgKyAnIFVwZGF0ZWQgaW4gRGF0YWJhc2UnKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgdGhpcyBwcm9wZXJ0eSEnKTtcclxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gYWx3YXlzKCkge1xyXG4gICAgICAgICAgICAgIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICB0cmFuc2xhdGUudW5CeUtleShvbkVuZFRyYW5zbHRlKTtcclxuICAgICAgICAgICAgICB0cmFuc2xhdGUuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgICAgICAgICAkKCcubW9kYWwtZGlhbG9nJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNjYW5jZWxVcGRhdGUnKS5vbignY2xpY2snLCBmdW5jdGlvbiBjYW5jZWxVcGRhdGUoZXZlbnQpIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgdHJhbnNsYXRlLnVuQnlLZXkob25FbmRUcmFuc2x0ZSk7XHJcbiAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgJCgnI2FkbWluTWFwJykucmVtb3ZlQXR0cignc3R5bGUnKTtcclxufSk7XHJcbiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcclxuICB3aW5kb3cuUGFyc2xleS5vbignZmllbGQ6ZXJyb3InLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyBUaGlzIGdsb2JhbCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBmb3IgYW55IGZpZWxkIHRoYXQgZmFpbHMgdmFsaWRhdGlvbi5cclxuICAgIGNvbnNvbGUubG9nKCdWYWxpZGF0aW9uIGZhaWxlZCBmb3I6ICcsIHRoaXMuJGVsZW1lbnQpO1xyXG4gIH0pO1xyXG4gIHdpbmRvdy5QYXJzbGV5XHJcbiAgICAuYWRkVmFsaWRhdG9yKCdkYXRlJywge1xyXG4gICAgICByZXF1aXJlbWVudFR5cGU6ICdzdHJpbmcnLFxyXG4gICAgICB2YWxpZGF0ZVN0cmluZzogZnVuY3Rpb24gKHZhbHVlLCByZXF1aXJlbWVudCkge1xyXG4gICAgICAgIGlmIChtb21lbnQodmFsdWUsICdERC1NTS1ZWVlZJywgdHJ1ZSkuaXNWYWxpZCgpID09PSB0cnVlKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9LFxyXG4gICAgICBtZXNzYWdlczoge1xyXG4gICAgICAgIGVuOiAnV3JvbmcgRGF0ZScsXHJcbiAgICAgICAgZWw6ICfOm86szrjOv8+CIM6XzrzOtc+Bzr/OvM63zr3Or86xJ1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBzdHJpbmdfZWxfdG9fdXJsKHN0cmluZykge1xyXG4gIHZhciBvcmlnaW5hbFN0cmluZyA9IHN0cmluZztcclxuICB2YXIgbmV3U3RyaW5nO1xyXG4gIHZhciByZXBsYWNlID0gbmV3IEFycmF5KCfOsScsICfOrCcsICfOhicsICfOkScsICfOsicsICfOkicsICfOsycsICfOkycsICfOtCcsICfOlCcsICfOtScsICfOrScsICfOlScsICfOiCcsICfOticsICfOlicsICfOtycsICfOricsICfOlycsICfOuCcsICfOmCcsICfOuScsICfOrycsICfPiicsICfOkCcsICfOmScsICfOiicsICfOuicsICfOmicsICfOuycsICfOmycsICfOvCcsICfOnCcsICfOvScsICfOnScsICfOvicsICfOnicsICfOvycsICfPjCcsICfOnycsICfOjCcsICfPgCcsICfOoCcsICfPgScsICfOoScsICfPgycsICfPgicsICfOoycsICfPhCcsICfOpCcsICfPhScsICfPjScsICfOpScsICfOjicsICfPhicsICfOpicsICfPhycsICfOpycsICfPiCcsICfOqCcsICfPiScsICfPjicsICfOqScsICfOjycsICcgJywgJ1xcJycsICdcXCcnLCAnLCcpO1xyXG4gIHZhciByZXBsYWNlX24gPSBuZXcgQXJyYXkoJ2EnLCAnYScsICdBJywgJ0EnLCAndicsICdWJywgJ2cnLCAnRycsICdkJywgJ0QnLCAnZScsICdlJywgJ0UnLCAnRScsICd6JywgJ1onLCAnaScsICdpJywgJ0knLCAndGgnLCAnVGgnLCAnaScsICdpJywgJ2knLCAnaScsICdJJywgJ0knLCAnaycsICdLJywgJ2wnLCAnTCcsICdtJywgJ00nLCAnbicsICdOJywgJ3gnLCAnWCcsICdvJywgJ28nLCAnTycsICdPJywgJ3AnLCAnUCcsICdyJywgJ1InLCAncycsICdzJywgJ1MnLCAndCcsICdUJywgJ3UnLCAndScsICdZJywgJ1knLCAnZicsICdGJywgJ2NoJywgJ0NoJywgJ3BzJywgJ1BzJywgJ28nLCAnbycsICdPJywgJ08nLCAnICcsICdfJywgJ18nLCAnXycpO1xyXG5cclxuICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcGxhY2UubGVuZ3RoOyBpKyspIHtcclxuICAgIG9yaWdpbmFsU3RyaW5nID0gb3JpZ2luYWxTdHJpbmcucmVwbGFjZShuZXcgUmVnRXhwKHJlcGxhY2VbaV0sICdnJyksIHJlcGxhY2VfbltpXSk7XHJcbiAgfVxyXG4gIG5ld1N0cmluZyA9IG9yaWdpbmFsU3RyaW5nO1xyXG4gIHJldHVybiBuZXdTdHJpbmc7XHJcbn1cclxuJChkb2N1bWVudClcclxuICAuYWpheFN0YXJ0KGZ1bmN0aW9uICgpIHtcclxuICAgICRsb2FkaW5nLmFkZENsYXNzKCdpcy1hY3RpdmUnKTtcclxuICB9KVxyXG4gIC5hamF4U3RvcChmdW5jdGlvbiAoKSB7XHJcbiAgICAkbG9hZGluZy5yZW1vdmVDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSk7XHJcbiIsInZhciBoYW5kbGVGb3JtID0gKGZ1bmN0aW9uICgkLCBwYXJzbGV5KSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG4gIHZhciBmb3JtTmFtZSwgc3VibWl0QnRuSWQsIHA7XHJcblxyXG4gIGZ1bmN0aW9uIHNldE9wdGlvbnMob3B0aW9ucykge1xyXG4gICAgZm9ybU5hbWUgPSBvcHRpb25zLm5hbWU7XHJcbiAgICBzdWJtaXRCdG5JZCA9IG9wdGlvbnMuc3VibWl0QnRuSWQ7XHJcbiAgICBlbmFibGVTZWxlY3QoKTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZW5hYmxlU2VsZWN0KCkge1xyXG4gICAgdmFyIGUgPSAkKCcuZ2V0bWRsLXNlbGVjdCcpO1xyXG4gICAgZS5lYWNoKGZ1bmN0aW9uICgpIHtcclxuICAgICAgYWRkRXZlbnRMaXN0ZW5lcnModGhpcyk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcnMoZSkge1xyXG4gICAgdmFyIHQgPSBlLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0JyksXHJcbiAgICAgIG4gPSBlLnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpJyk7XHJcbiAgICBlLnF1ZXJ5U2VsZWN0b3IoJ2knKTtcclxuICAgIFtdLmZvckVhY2guY2FsbChuLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICBlLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdC52YWx1ZSA9IGUudGV4dENvbnRlbnQ7XHJcbiAgICAgIH07XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZGlzYWJsZVN1Ym1pdEJ0bigpIHtcclxuICAgICQoJyMnICsgc3VibWl0QnRuSWQgKyAnJykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGNyZWF0ZVZhbGlkYXRvcigpIHtcclxuICAgIHAgPSAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5wYXJzbGV5KCk7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGRlc3Ryb3lWYWxpZGF0b3IoKSB7XHJcbiAgICBwLmRlc3Ryb3koKTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHZhbGlkYXRlRm9ybSgpIHtcclxuICAgIHJldHVybiBwLnZhbGlkYXRlKCk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBvblZhbGlkYXRlRm9ybVN1Y2Nlc3MoKSB7XHJcbiAgICBwLm9uKCdmb3JtOnN1Y2Nlc3MnLFxyXG5cclxuICAgICAgZnVuY3Rpb24gKCkge30pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGVzKGF0cikge1xyXG4gICAgJCgnI3N0cmVldF9lbCcpLnZhbChhdHIuc3RyZWV0X2VsKTtcclxuICAgICQoJyNzdHJlZXRfZW4nKS52YWwoYXRyLnN0cmVldF9lbik7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGdldEF0dHJpYnV0ZXMoKSB7XHJcbiAgICB2YXIgb2JqID0ge307XHJcbiAgICBjcmVhdGVWYWxpZGF0b3IoKTtcclxuICAgIGlmICh2YWxpZGF0ZUZvcm0oKSA9PT0gdHJ1ZSkge1xyXG4gICAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLXRleHRmaWVsZF9faW5wdXQnKS5lYWNoKFxyXG5cclxuICAgICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAgIG9ialskKHRoaXMpLmF0dHIoJ2lkJyldID0gJCh0aGlzKS52YWwoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC1jaGVja2JveF9faW5wdXQnKS5lYWNoKFxyXG5cclxuICAgICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAgIG9ialskKHRoaXMpLmF0dHIoJ2lkJyldID0gJCh0aGlzKS5wcm9wKCdjaGVja2VkJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtcmFkaW9fX2J1dHRvbicpLmVhY2goXHJcbiAgICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgICBvYmpbJCh0aGlzKS5hdHRyKCdpZCcpXSA9ICQodGhpcykucHJvcCgnY2hlY2tlZCcpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19zZWxlY3QnKS5lYWNoKFxyXG4gICAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICAgb2JqWyQodGhpcykuYXR0cignaWQnKV0gPSAkKHRoaXMpLnZhbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gb2JqO1xyXG4gICAgfVxyXG4gICAgZWxzZSByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHJlc2V0Rm9ybSgpIHtcclxuICAgIGlmIChjcmVhdGVWYWxpZGF0b3IoKSA9PSB0cnVlKSB7XHJcbiAgICAgIGRlc3Ryb3lWYWxpZGF0b3IoKTtcclxuICAgIH1cclxuICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtdGV4dGZpZWxkX19pbnB1dCcpLmVhY2goXHJcblxyXG4gICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAkKHRoaXMpLnZhbCgnJyk7XHJcbiAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtZGlydHknKTtcclxuICAgICAgICAkKHRoaXMpLnBhcmVudCgpLmVxKDApLnJlbW92ZUNsYXNzKCdpcy1pbnZhbGlkJyk7XHJcbiAgICAgIH0pO1xyXG4gICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC1jaGVja2JveF9faW5wdXQnKS5lYWNoKFxyXG5cclxuICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgJCh0aGlzKS5wcm9wKCdjaGVja2VkJywgZmFsc2UpO1xyXG4gICAgICB9KTtcclxuICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtY2hlY2tib3gnKS5lYWNoKFxyXG5cclxuICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICAgICB9KTtcclxuICB9XHJcbiAgcmV0dXJuIHtcclxuICAgIHNldDogc2V0T3B0aW9ucyxcclxuICAgIGdldDogZ2V0QXR0cmlidXRlcyxcclxuICAgIGNsZWFyOiByZXNldEZvcm0sXHJcbiAgICBzZXRBdHRyaWJ1dGVzOiBzZXRBdHRyaWJ1dGVzXHJcbiAgLy8gY3JlYXRlVmFsaWRhdG9yOiBjcmVhdGVWYWxpZGF0b3IsXHJcbiAgLy8gZGVzdHJveVZhbGlkYXRvcjogZGVzdHJveVZhbGlkYXRvcixcclxuICAvLyB2YWxpZGF0ZUZvcm06IHZhbGlkYXRlRm9ybSxcclxuICAvLyBvblZhbGlkYXRlRm9ybVN1Y2Nlc3M6IG9uVmFsaWRhdGVGb3JtU3VjY2VzcyxcclxuICAvLyBkaXNhYmxlU3VibWl0QnRuOiBkaXNhYmxlU3VibWl0QnRuXHJcbiAgfTtcclxufShqUXVlcnksIHBhcnNsZXkpKTtcclxuIl19
