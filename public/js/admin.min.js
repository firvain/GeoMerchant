(function () {

  if ( typeof window.CustomEvent === "function" ) return false;

  function CustomEvent ( event, params ) {
    params = params || { bubbles: false, cancelable: false, detail: undefined };
    var evt = document.createEvent( 'CustomEvent' );
    evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
    return evt;
   }

  CustomEvent.prototype = window.Event.prototype;

  window.CustomEvent = CustomEvent;
})();

  (function () {
    if (!Element.prototype.scrollIntoViewIfNeeded) {
      Element.prototype.scrollIntoViewIfNeeded = function (centerIfNeeded) {
        centerIfNeeded = arguments.length === 0 ? true : !!centerIfNeeded;

        var parent = this.parentNode,
        parentComputedStyle = window.getComputedStyle(parent, null),
        parentBorderTopWidth = parseInt(parentComputedStyle.getPropertyValue('border-top-width')),
        parentBorderLeftWidth = parseInt(parentComputedStyle.getPropertyValue('border-left-width')),
        overTop = this.offsetTop - parent.offsetTop < parent.scrollTop,
        overBottom = (this.offsetTop - parent.offsetTop + this.clientHeight - parentBorderTopWidth) > (parent.scrollTop + parent.clientHeight),
        overLeft = this.offsetLeft - parent.offsetLeft < parent.scrollLeft,
        overRight = (this.offsetLeft - parent.offsetLeft + this.clientWidth - parentBorderLeftWidth) > (parent.scrollLeft + parent.clientWidth),
        alignWithTop = overTop && !overBottom;

        if ((overTop || overBottom) && centerIfNeeded) {
          parent.scrollTop = this.offsetTop - parent.offsetTop - parent.clientHeight / 2 - parentBorderTopWidth + this.clientHeight / 2;
        }

        if ((overLeft || overRight) && centerIfNeeded) {
          parent.scrollLeft = this.offsetLeft - parent.offsetLeft - parent.clientWidth / 2 - parentBorderLeftWidth + this.clientWidth / 2;
        }

        if ((overTop || overBottom || overLeft || overRight) && !centerIfNeeded) {
          this.scrollIntoView(alignWithTop);
        }
      };
    }
  })();

window.App || (window.App = {});
window.App.config = {
  promises: {
    dustBluebird: Promise.promisifyAll(dust),
    cloudinaryBird: Promise.promisifyAll($.cloudinary)
  },
  commons: {
    map: {},
    trans: {}
  },
  cache: {
    activeEstate: {},
    activeEstateListing: {}
  },
  modules: {
    map: {},
    info: {},
    edit: {},
    delete: {},
    insert: {},
    filters: {}
  }
};
window.App.utils = {};
// var trans;
// var cloudinaryBird = Promise.promisifyAll($.cloudinary);
// var activeEstate;
// var activeEstateListing;
$.cloudinary.config({ cloud_name: 'firvain', api_key: '375138932689591' });

/*eslint no-param-reassign: ["error", { "props": false }]*/
App.utils = {
  findById: function findById(map, id) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (id === layers.item(i).get('id')) {
        return layers.item(i);
      }
    }
    return null;
  },
  findByName: function findByName(map, name) {
    var layers = map.getLayers();
    var length = layers.getLength();
    for (var i = 0; i < length; i++) {
      if (name === layers.item(i).get('name')) {
        return layers.item(i);
      }
    }
    return null;
  },
  preventDotAndSpace: function preventDotAndSpace(e) {
    var key = e.charCode ? e.charCode : e.keyCode;
    this.innerHTML = key;
    if (key === 46 || key === 32) {
      return false;
    }
    return true;
  },
  geometryFunction: function geometryFunction(coordinates, geometry) {
    var geom = geometry;
    var start;
    var end;
    if (!geom) {
      geom = new ol.geom.Polygon(null);
    }
    start = coordinates[0];
    end = coordinates[1];
    geom.setCoordinates([
      [start, [start[0], end[1]], end, [end[0], start[1]], start]
    ]);
    return geom;
  },
  hasClass: function hasClass(el, className) {
    if (el.classList) {
      return el.classList.contains(className);
    }
    return new RegExp('(^| )' + className + '( |$)', 'gi').test(el.className);
  },
  removeClass: function removeClass(el, className) {
    var element = el;
    if (element.classList) {
      element.classList.remove(className);
    } else {
      element.className = element.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
    }
  },
  addClass: function removeClass(el, className) {
    var element = el;
    if (element.classList) {
      element.classList.add(className);
    } else {
      element.className += ' ' + className;
    }
  },
  toggleClass: function toggleClass(el, className) {
    var classes;
    var existingIndex;
    var element = el;
    if (element.classList) {
      element.classList.toggle(className);
    } else {
      classes = element.className.split(' ');
      existingIndex = classes.indexOf(className);

      if (existingIndex >= 0) {
        classes.splice(existingIndex, 1);
      } else {
        classes.push(className);
      }
      element.className = classes.join(' ');
    }
  },
  requestFullScreen: function requestFullScreen(element) {
    // Supports most browsers and their versions.
    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
    var wscript;
    if (requestMethod) { // Native full screen.
      requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== 'undefined') { // Older IE.
      wscript = new ActiveXObject('WScript.Shell');
      if (wscript !== null) {
        wscript.SendKeys('{F11}');
      }
    }
  },
  exitFullsreen: function exitFullsreen(element) {
    var requestMethod = element.exitFullScreen || element.webkitExitFullscreen || element.mozCancelFullScreen || element.msExitFullscreen;
    var wscript;
    if (requestMethod) { // Native full screen.
      requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== 'undefined') { // Older IE.
      wscript = new ActiveXObject('WScript.Shell');
      if (wscript !== null) {
        wscript.SendKeys('{Esc}');
      }
    }
  },
  elToEn: function elToEn(string) {
    var originalString = string;
    var newString;
    var replace = new Array('α', 'ά', 'Ά', 'Α', 'β', 'Β', 'γ', 'Γ', 'δ', 'Δ', 'ε', 'έ', 'Ε', 'Έ', 'ζ', 'Ζ', 'η', 'ή', 'Η', 'θ', 'Θ', 'ι', 'ί', 'ϊ', 'ΐ', 'Ι', 'Ί', 'κ', 'Κ', 'λ', 'Λ', 'μ', 'Μ', 'ν', 'Ν', 'ξ', 'Ξ', 'ο', 'ό', 'Ο', 'Ό', 'π', 'Π', 'ρ', 'Ρ', 'σ', 'ς', 'Σ', 'τ', 'Τ', 'υ', 'ύ', 'Υ', 'Ύ', 'φ', 'Φ', 'χ', 'Χ', 'ψ', 'Ψ', 'ω', 'ώ', 'Ω', 'Ώ', ' ', '\'', '\'', ',');
    var replace_n = new Array('a', 'a', 'A', 'A', 'v', 'V', 'g', 'G', 'd', 'D', 'e', 'e', 'E', 'E', 'z', 'Z', 'i', 'i', 'I', 'th', 'Th', 'i', 'i', 'i', 'i', 'I', 'I', 'k', 'K', 'l', 'L', 'm', 'M', 'n', 'N', 'x', 'X', 'o', 'o', 'O', 'O', 'p', 'P', 'r', 'R', 's', 's', 'S', 't', 'T', 'u', 'u', 'Y', 'Y', 'f', 'F', 'ch', 'Ch', 'ps', 'Ps', 'o', 'o', 'O', 'O', ' ', '_', '_', '_');

    for (var i = 0; i < replace.length; i++) {
      originalString = originalString.replace(new RegExp(replace[i], 'g'), replace_n[i]);
    }
    newString = originalString;
    return newString;
  },
  handleDate: function handleDate(str, lang) {
    var split;
    var newDate = [];
    if (typeof str === 'string' && lang !== 'el') {
      split = _.split(str, '-', 3);
      newDate = [split[1], split[0], split[2]];
      return _.join(newDate, '-');
    }
    return str;
  },
  sanitize: function sanitize(el) {
    var sanitizedStr;
    var str = el.value;
    sanitizedStr = str.replace(/[^a-z0-9A-ZA-zΑ-Ωα-ωίϊΐόάέύϋΰήώ]/gi, '');
    el.value = sanitizedStr;
    console.log(el);
    console.log(el.value);
    console.log(sanitizedStr);
  }
  // zoomToGid: function zoomToGid(map, gid) {
  //   var coordinates = utils.findById(map, 'filteredEstates').getSource().getFeatureById(gid)
  //   .getGeometry()
  //   .getCoordinates();
  //   map.getView().setCenter(coordinates);
  // }
};

App.config.modules.map = (function ol3Map(window, document, Promise, ol, App) {
  'use strict';
  var center = [3677385, 4120949];
  var extent = [3652772, 4112808, 3700000, 4132797];
  var geoJSONFormat = new ol.format.GeoJSON({
    defaultDataProjection: 'EPSG:4326'
  });

  var mapStyles = {
    iconType: function getIconType(estateType) {
      var iconType = {
        Apartment: function getApartmentIcon() {
          return 'apartment';
        },
        Store: function getStoreIcon() {
          return 'store';
        },
        'Detached House': function getDetachedHouseIcon() {
          return 'detached';
        },
        Maisonette: function getMaisonetteIcon() {
          return 'maisonette';
        },
        Villa: function getVillaIon() {
          return 'villa';
        }
      };
      return (iconType[estateType])();
    },
    estates: function estates(feature) {
      var src = './images/pins/none/' +
      mapStyles.iconType(feature.get('estatetype_en')) + '-48.png';
      return new ol.style.Style({
        geometry: feature.getGeometry(),
        image: new ol.style.Icon(({
          src: src,
          anchorOrigin: 'bottom-left',
          anchor: [0.5, 0],
          scale: 1
        }))
      });
    }
  };

  var mapSources = {
    bing: function bing() {
      return new ol.source.BingMaps({
        key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
        imagerySet: 'AerialWithLabels'
      });
    },
    mapBox: function mapBox() {
      return new ol.source.XYZ({
        attributions: [new ol.Attribution({
          html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
        })],
        url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
      });
    },
    estates: function estates() {
      return new ol.source.Vector({
        format: geoJSONFormat,
        loader: function propertyLoader() {
          var url = 'http://127.0.0.1:3000/api/property/all/' + id;
          var self = this;
          Promise.resolve(
            $.ajax({
              url: url,
              type: 'GET',
              dataType: 'json'
            })
          )
          .then(function resolve(data) {
            var features = geoJSONFormat.readFeatures(data, {
              featureProjection: 'EPSG:3857'
            });
            self.addFeatures(features);
          })
          .then(function resolve() {
            self.getFeatures().forEach(function addIds(feature) {
              feature.setId(feature.getProperties().gid);
            });
          })
          .catch(function error(e) {
            console.log(e);
            if (e.status === 404) {
              toastr.error('Sorry, we cannot find any properties!');
            } else if (e.status === 503) {
              toastr.error('Service Unavailable!');
            } else {
              toastr.error('Internal Server Error! Please reload page or try again later');
            }
          });
        }
      });
    }
  };

  var mapLayers = {
    bing: function bing(trans) {
      return new ol.layer.Tile({
        visible: true,
        source: mapSources.bing(),
        maxZoom: 19,
        crossOrigin: 'anonymous',
        preload: Infinity,
        id: 'bing',
        name: trans.layers.bing
      });
    },
    mapBox: function mapBox(trans) {
      return new ol.layer.Tile({
        source: mapSources.mapBox(),
        id: 'mapbox',
        name: trans.layers.mapBox
      });
    },
    estates: function estates() {
      return new ol.layer.Vector({
        source: mapSources.estates(),
        id: 'estates',
        visible: true,
        style: mapStyles.estates
      });
    },
    newEstates: function newEstates(trans) {
      return new ol.layer.Vector({
        source: new ol.source.Vector(),
        id: 'newEstates',
        visible: false
      });
    }
  };
  var initialize = function initialize() {
    var trans = App.config.commons.trans;
    var layers = Object.keys(mapLayers).map(function addMapLayers(key) {
      if (key !== 'bing') { return mapLayers[key](trans); }
      return null;
    });
    return new ol.Map({
      target: 'appwrapper__map',
      layers: _.compact(layers),
      loadTilesWhileAnimating: true,
      loadTilesWhileInteracting: true,
      renderer: 'canvas',
      controls: ol.control.defaults({
        attributionOptions: {
          collapsible: false,
          collapsed: false
        }
      })
       .extend([
         new ol.control.ScaleLine({
           units: 'metric'
         }), new ol.control.OverviewMap({
           className: 'ol-overviewmap ol-custom-overviewmap',
           collapsible: true,
           collapsed: true,
           layers: [mapLayers.bing(trans)]
         }),
         new ol.control.ZoomToExtent({
           extent: extent
         })
       ]),
      view: new ol.View({
        center: center,
        extent: extent,
        projection: 'EPSG:3857',
        zoom: 14,
        maxZoom: 19,
        minZoom: 14
      })
    });
  };
  return {
    initialize: initialize
  };
}(window, document, Promise, ol, App));

App.config.modules.info = (function info(window, document, Promise, $, App) {
  'use strict';
  var lang = document.documentElement.lang;
  var editButton = document.querySelector('#edit');
  var deleteButton = document.querySelector('#delete');
  var infoBoxContent = document.querySelector('#appwrapper__infobox-content');
  var dustBluebird = App.config.promises.dustBluebird;
  var utils = App.utils;
  function dustEstateInfo(data) {
    dustBluebird.renderAsync('edit', data)
    .then(function resolveDust(result) {
      utils.removeClass(infoBoxContent, 'visuallyhidden');
      infoBoxContent.innerHTML = result;
      getmdlSelect.init('.getmdl-select');
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function selectFeature(evt) {
    var map = evt.map;
    var coordinates;
    var estate;
    var gid;
    var renderData = _.cloneDeep(App.config.commons.trans);
    var style = new ol.style.Style({
      image: new ol.style.Icon(({
        src: './images/pins/generic-48.png',
        anchorOrigin: 'bottom-left',
        anchor: [0.5, 0],
        scale: 1,
        color: 'rgb(255,82,82)'
      }))
    });
    // var coordinate = evt.coordinate;
    var clickedFeature = map.forEachFeatureAtPixel(evt.pixel, function findFeature(feature, layer) {
      return {
        feature: feature,
        layer: layer
      };
    }, this, function clickedFeatureLayerFilter(layer) {
      if (layer.get('id') === 'estates') {
        return true;
      }
      return false;
    }, this);
    if (clickedFeature) {
      utils.findById(map, 'estates').getSource().getFeatures()
      .forEach(function resetStyle(feature) {
        feature.setStyle(null);
      });
      estate = clickedFeature.feature;
      coordinates = estate.getGeometry().getCoordinates();
      map.getView().setCenter(coordinates);
      map.getView().setZoom(16);
      gid = estate.getProperties().gid;
      estate.setStyle(style);
      var p1 = Promise.resolve(
        $.ajax({
          url: 'http://127.0.0.1:3000/api/property',
          type: 'GET',
          data: {
            gid: gid
          }
        })
        );
      p1.then(function resolve(data) {
        var feature = data.features[0];
        App.config.cache.activeEstate = feature.properties;
        return feature;
      })
      .then(function resolve(feature) {
        if (lang === 'el') {
          renderData.values = {
            gid: feature.properties.gid,
            x: coordinates[0],
            y: coordinates[1],
            areaName: feature.properties.area_name,
            estateType: feature.properties.estatetype,
            address: feature.properties.street_el,
            addressNumber: feature.properties.street_number,
            pscode: feature.properties.ps_code,
            estateArea: feature.properties.estatearea,
            bedrooms: feature.properties.bedrooms,
            floor: feature.properties.floor,
            year: feature.properties.year,
            planNumber: feature.properties.plan_num,
            plotArea: feature.properties.plotarea,
            parcelNumber: feature.properties.parcel_num,
            parking: feature.properties.parking,
            furnished: feature.properties.furnished,
            isnew: feature.properties.isnew,
            heating: feature.properties.heating,
            cooling: feature.properties.cooling,
            view: feature.properties.view,
            title: feature.properties.title
          };
        } else {
          renderData.values = {
            gid: feature.properties.gid,
            x: feature.geometry.coordinates[0],
            y: feature.geometry.coordinates[1],
            areaName: feature.properties.area_name,
            estateType: feature.properties.estatetype_en,
            address: feature.properties.street_en,
            addressNumber: feature.properties.street_number,
            pscode: feature.properties.ps_code,
            estateArea: feature.properties.estatearea,
            bedrooms: feature.properties.bedrooms,
            floor: feature.properties.floor,
            year: feature.properties.year,
            planNumber: feature.properties.plan_num,
            plotArea: feature.properties.plotarea,
            parcelNumber: feature.properties.parcel_num,
            parking: feature.properties.parking,
            furnished: feature.properties.furnished,
            isnew: feature.properties.isnew,
            heating: feature.properties.heating,
            cooling: feature.properties.cooling,
            view: feature.properties.view,
            title: feature.properties.title
          };
        }
      });
      p1.catch(function error(e) {
        console.log(e);
      });
      var p2 = Promise.resolve(
        $.ajax({
          url: 'http://127.0.0.1:3000/api/listing',
          type: 'GET',
          data: {
            gid: gid
          }
        })
        )
      .then(function resolve(data) {
        App.config.cache.activeEstateListing = data;
        renderData.listing.values = data;
        renderData.listing.values.date_start = utils.handleDate(data.date_start, lang);
        renderData.listing.values.date_end = utils.handleDate(data.date_end, lang);
        renderData.listing.exists = true;
      })
      .catch(function error(e) {
        var snackbarContainer = document.querySelector('#appwrapper__snackbar');
        var data = { message: App.config.commons.trans.errors.listing404 };
        console.log(e);
        if (e.status === 404) {
          renderData.listing.exists = false;
          snackbarContainer.MaterialSnackbar.showSnackbar(data);
        }
      });
      Promise.each([p1, p2], function e(result) {
      })
      .then(function resolve() {
        dustEstateInfo(renderData);
        editButton.removeAttribute('disabled');
        deleteButton.removeAttribute('disabled');

        utils.addClass(editButton, 'mdl-button--accent');
        utils.addClass(deleteButton, 'mdl-button--accent');
      })
      .catch(function error(e) {
        console.log(e);
      });
    } else {
      infoBoxContent.innerHTML = '';
      utils.addClass(infoBoxContent, 'visuallyhidden');
      editButton.setAttribute('disabled', true);

      deleteButton.setAttribute('disabled', true);

      utils.findById(map, 'estates').getSource().getFeatures()
      .forEach(function resetStyle(feature) {
        feature.setStyle(null);
      });
    }
  }

  function init() {
    var map = App.config.commons.map;
    document.querySelector('body').dataset.active = 'info';
    map.on('click', selectFeature);
  }
  function disable() {
    var map = App.config.commons.map;
    map.un('click', selectFeature);
  }
  return {
    init: init,
    disable: disable
  };
}(window, document, Promise, jQuery, App));

App.config.modules.edit = (function edit(window, document, Promise, $, dPick, moment) {
  'use strict';
  var content = document.querySelector('#appwrapper__infobox-content');
  var lang = document.documentElement.lang;
  var info = App.config.modules.info;
  var utils = App.utils;
  var editButton = document.querySelector('#edit');
  var deleteButton = document.querySelector('#delete');
  var body = document.querySelector('body');
  function clearContent() {
    if (content.children.length > 0) {
      content.innerHTML = '';
    }
  }
  function getInteraction(id) {
    var map = App.config.commons.map;
    var interactions = map.getInteractions();
    var found = {};
    interactions.forEach(function getInteractionId(interaction) {
      if (interaction.get('id') === id) {
        found = interaction;
        return false;
      }
      return true;
    });
    return found;
  }
  function assignValidators() {
    var inputs = content.querySelectorAll('input[type=text]');
    [].forEach.call(inputs, function makeParsleyInputs(el) {
      el.addEventListener('blur', function sanitize() {
        var str = this.value;
        var sanitizedStr;
        if (this.dataset.type === 'number') {
          sanitizedStr = str.replace(/[/\D/ ]/gi, '');
        } else if (this.dataset.type === 'alphanum') {
          sanitizedStr = str.replace(/[^a-z0-9A-ZA-zΑ-Ωα-ωίϊΐόάέύϋΰήώ ]/gi, '');
        } else if (this.dataset.type === 'special') {
          sanitizedStr = str.replace(/[^0-9 \/]/gi, '');
        } else if (this.dataset.type === 'date') {
          sanitizedStr = str.replace(/[^0-9 \-]/gi, '');
        }
        this.value = sanitizedStr;
        utils.removeClass(this.parentNode, 'is-invalid');
      });
    });
  }

  function setEstateType(type) {
    var types;
    if (lang === 'el') {
      types = {
        Διαμέρισμα: function getApartment() {
          return 'Apartment';
        },
        Μονοκατοικία: function getDetachedHouse() {
          return 'Detached House';
        },
        Μεζονέτα: function getMaisonette() {
          return 'Maisonette';
        },
        Έπαυλη: function getVilla() {
          return 'Villa';
        }
      };
    } else {
      types = {
        Apartment: function getApartment() {
          return 'Διαμέρισμα';
        },
        'Detached House': function getDetachedHouse() {
          return 'Μονοκατοικία';
        },
        Maisonette: function getMaisonette() {
          return 'Μεζονέτα';
        },
        Villa: function getVilla() {
          return 'Έπαυλη';
        }
      };
    }
    return types[type]();
  }
  function collectValues() {
    var values = {};
    var filteredValues = {};
    var inputs = content.querySelectorAll('input[type=text]');
    var checkboxes = content.querySelectorAll('input[type=checkbox]');
    values.estate = {};
    values.listing = {};

    [].forEach.call(inputs, function collectFromInputs(el) {
      var name = _.last(_.split(el.getAttribute('id'), '-', 3));
      var value = el.value;
      var newX = document.querySelector('#estate').dataset.newx;
      var newY = document.querySelector('#estate').dataset.newy;
      var originalX = document.querySelector('#estate').dataset.originalx;
      var originalY = document.querySelector('#estate').dataset.originaly;

      if (el.getAttribute('id').indexOf('estate') > -1) {
        if (typeof newX !== 'undefined') {
          values.estate.x = newX;
          values.estate.y = newY;
        } else {
          values.estate.x = originalX;
          values.estate.y = originalY;
        }
        if (lang === 'el') {
          if (name === 'type') {
            values.estate.estatetypeEn = setEstateType(value);
            values.estate.estatetype = value;
          }
          if (name === 'address') {
            values.estate.streetEn = utils.elToEn(value);
            values.estate.streetEl = value;
          }
        } else {
          if (name === 'type') {
            values.estate.estatetypeEn = value;
            values.estate.estatetype = setEstateType(value);
          }
          if (name === 'address') {
            values.estate.streetEn = value;
            values.estate.streetEl = utils.elToEn(value);
          }
        }
        if (name === 'addressNumber') {
          values.estate.streetNumber = value;
        }
        values.estate[name] = value;
      } else {
        if (name === 'type') {
          if (value === 'Sale' || value === 'Πώληση') {
            values.listing.sale = true;
            values.listing.rent = false;
          } else {
            values.listing.sale = false;
            values.listing.rent = true;
          }
        } else {
          values.listing[name] = value;
        }
      }
    });
    [].forEach.call(checkboxes, function collectFromCheckboxes(el) {
      var name = _.last(_.split(el.getAttribute('id'), '-', 3));
      var value = el.checked;
      if (name !== 'pets') {
        values.estate[name] = value;
      } else {
        values.listing[name] = value;
      }
    });
    filteredValues.estate = _.omit(values.estate, ['address', 'addressNumber', 'type', 'toggle']);
    filteredValues.listing = values.listing;
    return filteredValues;
  }
  function update(data) {
    var snackbarContainer = document.querySelector('#appwrapper__snackbar');
    var msgData = {};
    function addGidToListing(input, gid) {
      var returnedData = input;
      returnedData.gid = gid;
      return returnedData;
    }
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/property',
        type: 'PUT',
        data: data.estate
      })
      )
    .then(function resolve(estateResult) {
      msgData.estateId = estateResult.propertyGid;
      if (!_.isEmpty(data.listing)) {
        return $.ajax({
          url: 'http://127.0.0.1:3000/api/listing',
          type: 'PUT',
          data: addGidToListing(data.listing, estateResult.propertyGid)
        });
      }
      return null;
    })
    .then(function resolve(listingResult) {
      var msg;
      // console.log(result)
      if (listingResult === null) {
        msg = { message: 'Updated Estate: ' + msgData.estateId };
      } else {
        msg = { message: 'Updated EstateID: ' + msgData.estateId + ' and ListingID: ' + listingResult.listingId };
      }
      snackbarContainer.MaterialSnackbar.showSnackbar(msg);
    })
    .catch(function error(e) {
      var msg = { message: e };
      console.log(e);
      snackbarContainer.MaterialSnackbar.showSnackbar(msg);
    })
    .finally(function closeUpdate() {
      var map = App.config.commons.map;
      clearContent();
      utils.addClass(content, 'visuallyhidden');
      utils.findById(map, 'estates').getSource().getFeatures()
      .forEach(function resetStyle(feature) {
        feature.setStyle(null);
      });
      editButton.setAttribute('disabled', true);
      deleteButton.setAttribute('disabled', true);
      info.init();
      body.dataset.active = 'info';
      getInteraction('translate').setActive(false);
    });
  }
  function datePicker() {
    var format = (lang === 'el') ? 'DD-MM-YYYY' : 'MM-DD-YYYY';
    var dateStartPicker;
    var dateEndPicker;
    var dateStartBtn = document.getElementById('infobox__date-start');
    var dateEndBtn = document.getElementById('infobox__date-end');
    var dateStartInput = document.getElementById('listing__general-dateStart');
    var dateEndInput = document.getElementById('listing__general-dateEnd');
    var dateStartPickerInit;
    var dateEndPickerInit;
    var observeDatePicker = new MutationObserver(function observeDatePicker(mutations) {
      var attributeValue;
      mutations.forEach(function foerEachMutation(mutation) {
        if (mutation.attributeName === 'class') {
          attributeValue = $(mutation.target).prop(mutation.attributeName);
          if (attributeValue.indexOf('mddtp-picker--inactive') > -1) {
            utils.removeClass(document.getElementById('appwrapper__infobox'), 'unclickable');
          } else {
            utils.addClass(document.getElementById('appwrapper__infobox'), 'unclickable');
          }
        }
      });
    });
    if (dateStartInput !== null) {
      console.log(dateStartInput.value);
      if (dateStartInput.value !== 'undefined') {
        dateStartPickerInit = moment(dateStartInput.value, format);
      } else {
        dateStartPickerInit = moment();
      }
      dateStartPicker = new dPick.default({
        type: 'date',
        init: dateStartPickerInit,
        future: moment().add(5, 'years'),
        trigger: dateStartInput,
        orientation: 'PORTRAIT'
      });
      observeDatePicker.observe(document.getElementById('mddtp-picker__date'), {
        attributes: true
      });
      dateStartInput.addEventListener('onOk', function displayPickedate() {
        utils.addClass(this.parentNode, 'is-dirty');
        this.value = dateStartPicker.time.format(format).toString();
      });
      dateStartBtn.addEventListener('click', function showDatePicker() {
        dateStartPicker.toggle();
      });
    }
    if (dateEndInput !== null) {
      if (dateEndInput.value !== 'undefined') {
        dateEndPickerInit = moment(dateStartInput.value, format);
      } else {
        dateEndPickerInit = moment();
      }
      dateEndInput.addEventListener('onOk', function displayPickedate() {
        utils.addClass(this.parentNode, 'is-dirty');
        this.value = dateEndPicker.time.format(format).toString();
      });
      dateEndPicker = new dPick.default({
        type: 'date',
        init: dateEndPickerInit,
        future: moment().add(5, 'years'),
        trigger: dateEndInput,
        orientation: 'PORTRAIT'
      });
      observeDatePicker.observe(document.getElementById('mddtp-picker__date'), {
        attributes: true
      });
      dateEndBtn.addEventListener('click', function showDatePicker() {
        dateEndPicker.toggle();
      });
    }
  }
  function enableEdit() {
    var observeListingInput = new MutationObserver(function observeListingInput(mutations) {
      var attributeValue;
      mutations.forEach(function foerEachMutation(mutation) {
        if (mutation.attributeName === 'data-val') {
          attributeValue = mutation.target.value;
          if (attributeValue === 'Rent' || attributeValue === 'Ενοικίαση') {
            utils.removeClass(document.querySelector('#listing__general-pets-wrapper'), 'visuallyhidden');
          } else {
            utils.addClass(document.querySelector('#listing__general-pets-wrapper'), 'visuallyhidden');
          }
        }
      });
    });
    var map = App.config.commons.map;
    var inputs = content.querySelectorAll('input');
    var labels = content.querySelectorAll('label');
    var buttons = content.querySelectorAll('button');
    var editCloseButton = document.querySelector('.close');
    var editAgreeButton = document.querySelector('.agree');
    var locationSwitch = document.querySelector('#estate_location-toggle');
    var gid = document.querySelector('#estate__info-gid').value;
    var translate = new ol.interaction.Translate({
      features: new ol.Collection([utils.findById(map, 'estates').getSource().getFeatureById(gid)]),
      layers: [utils.findById(map, 'estates')]
    });

    assignValidators();
    translate.set('id', 'translate');
    if (document.getElementById('listing__idAndType-type') !== null) {
      observeListingInput.observe(document.getElementById('listing__idAndType-type'), {
        attributes: true,
        characterData: true
      });
    }
    translate.on('translateend', function setTranslatedCoordinates(e) {
      var element = document.querySelector('#estate');
      element.dataset.newx = e.coordinate[0];
      element.dataset.newy = e.coordinate[1];
      locationSwitch.checked = false;
      utils.removeClass(locationSwitch.parentNode, 'is-checked');
      // App.config.modules.info.init();
      translate.setActive(false);
    });
    map.addInteraction(translate);
    translate.setActive(false);

    locationSwitch.addEventListener('click', function watchLocationSwitch() {
      if (this.checked) {
        // App.config.modules.info.disable();
        translate.setActive(true);
      } else {
        // App.config.modules.info.init();
        translate.setActive(false);
      }
    });

    [].forEach.call(document.getElementsByClassName('listing'), function removeDisabledListing(el) {
      utils.removeClass(el, 'listing-disabled');
    });

    [].forEach.call(inputs, function removeDisabledInputs(el) {
      if (!utils.hasClass(el, 'not-edditable')) {
        el.removeAttribute('disabled');
      }
    });

    [].forEach.call(labels, function removeDisabledLabels(el) {
      utils.removeClass(el, 'is-disabled');
    });

    [].forEach.call(buttons, function removeDisabledLabels(el) {
      el.removeAttribute('disabled');
    });

    utils.removeClass(document.querySelector('#confirmBtns'), 'visuallyhidden');
    editCloseButton.addEventListener('click', function cancelEdit() {
      clearContent();
      utils.addClass(content, 'visuallyhidden');
      utils.findById(map, 'estates').getSource().getFeatures()
      .forEach(function resetStyle(feature) {
        feature.setStyle(null);
      });
      editButton.setAttribute('disabled', true);
      deleteButton.setAttribute('disabled', true);
      info.init();
      body.dataset.active = 'info';
      getInteraction('translate').setActive(false);
    });
    editAgreeButton.addEventListener('click', function updateEdit() {
      // sanitize();
      var data = collectValues();
      console.log(data);
      update(data);
    });
    datePicker();
  }

  function init() {
    info.disable();
    enableEdit();
  }

  return {
    init: init
  };
}(window, document, Promise, $, mdDateTimePicker, moment, App));

App.config.modules.delete = (function edit(window, document, Promise, $, App, dialogPolyfill) {
  'use strict';
  var utils = App.utils;
  var dustBluebird = App.config.promises.dustBluebird;
  var deleteButton = document.getElementById('delete');
  var editButton = document.getElementById('edit');
  var dialog = document.querySelector('dialog');
  var snackbarContainer = document.querySelector('#appwrapper__snackbar');
  var content = document.getElementById('appwrapper__infobox-content');
  var body = document.querySelector('body');
  var info = App.config.modules.info;
  function clearContent() {
    if (content.children.length > 0) {
      content.innerHTML = '';
    }
  }
  function updateEstates() {
    var map = App.config.commons.map;
    utils.findById(map, 'estates').getSource().clear();
  }
  function deleteListing(data) {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/listing',
        type: 'DELETE',
        data: { id: data }
      })
      )
    .then(function resolve(deleteListingresult) {
      console.log(deleteListingresult);
      content.querySelector('#listing').innerHTML = '';
      content.querySelector('#listing').parentNode.removeChild(content.querySelector('#listing'));
    })
    .finally(function enableInfo() {
      var map = App.config.commons.map;
      clearContent();
      body.dataset.active = 'info';
      editButton.setAttribute('disabled', true);
      deleteButton.setAttribute('disabled', true);
      info.init();
      utils.findById(map, 'estates').getSource().getFeatures()
      .forEach(function resetStyle(feature) {
        feature.setStyle(null);
      });
    })
    .catch(function error(e) {
      var msg = { message: e };
      console.log(e);
      snackbarContainer.MaterialSnackbar.showSnackbar(msg);
    });
  }
  function deleteEstateAndListing(data) {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/property',
        type: 'DELETE',
        data: { gid: data }
      })
      )
    .then(function resolve() {
      updateEstates();
    })
    .finally(function enableInfo() {
      var map = App.config.commons.map;
      clearContent();
      body.dataset.active = 'info';
      info.init();
      editButton.setAttribute('disabled', true);
      deleteButton.setAttribute('disabled', true);
      utils.findById(map, 'estates').getSource().getFeatures()
      .forEach(function resetStyle(feature) {
        feature.setStyle(null);
      });
    })
    .catch(function error(e) {
      var msg = { message: e };
      console.log(e);
      snackbarContainer.MaterialSnackbar.showSnackbar(msg);
    });
  }
  function whatToDelete() {
    var checkboxes = dialog.querySelectorAll('input[name=options]');
    var values = {};
    if (checkboxes.length !== 0) {
      [].forEach.call(checkboxes, function getValues(el) {
        var key = _.last(_.split(el.getAttribute('id'), '-', 3));
        values[key] = el.checked;
      });
    }
    return values;
  }
  function cancelDelete() {
    dialog.close();
  }
  function confirmDelete() {
    var data;
    var chooser = whatToDelete();
    if (_.isEmpty(chooser)) {
      data = document.getElementById('estate__info-gid').value;
      deleteEstateAndListing(data);
    } else {
      if (chooser.listing === true) {
        data = document.getElementById('listing__idAndType-id').value;
        deleteListing(data);
      }
      if (chooser.estate === true) {
        data = document.getElementById('estate__info-gid').value;
        deleteEstateAndListing(data);
      }
    }
    dialog.close();
  }
  function show() {
    var listing = document.getElementById('listing__idAndType-id');
    var data = {};
    if (listing === null) {
      data.title = 'Delete Estate';
      data.choose = false;
    } else {
      data.title = 'Please choose what you want to delete';
      data.choose = true;
    }
    dustBluebird.renderAsync('deleteDialog', data)
    .then(function resolveDust(result) {
      dialog.innerHTML = result;
      dialog.showModal();
    })
    .then(function resolve() {
      dialog.querySelector('#cancelDelete').addEventListener('click', cancelDelete);
      dialog.querySelector('#confirmDelete').addEventListener('click', confirmDelete);
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function initDialog() {
    if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    show();
  }
  return {
    init: initDialog
  };
}(window, document, Promise, jQuery, App, dialogPolyfill));

App.config.modules.insert = (function edit(window, document, Promise, $, App, dPick, moment, dialogPolyfill, cloudinary) {
  'use strict';
  var lang = document.documentElement.lang;
  var body = document.querySelector('body');
  var utils = App.utils;
  var dustBluebird = App.config.promises.dustBluebird;
  var content = document.getElementById('appwrapper__infobox-content');
  var addButton = document.getElementById('insert');
  var info = App.config.modules.info;
  var drawnCollection = new ol.Collection();
  function clearContent() {
    if (content.children.length > 0) {
      content.innerHTML = '';
      document.getElementById('activeModule').innerHTML = 'Information';
    }
  }
  function checkEmpty() {
    var inputs = content.querySelectorAll('input[type=text]');
    return _.some(inputs, function isEmpty(input) {
      if (input.value === '') {
        return true;
      }
      return false;
    });
  }
  function getInteraction(id) {
    var map = App.config.commons.map;
    var interactions = map.getInteractions();
    var found = {};
    interactions.forEach(function getInteractionId(interaction) {
      if (interaction.get('id') === id) {
        found = interaction;
        return false;
      }
      return true;
    });
    return found;
  }
  function datePicker() {
    var format = (lang === 'el') ? 'DD-MM-YYYY' : 'MM-DD-YYYY';
    var dateStartPicker;
    var dateEndPicker;
    var dateStartBtn = document.getElementById('infobox__date-start');
    var dateEndBtn = document.getElementById('infobox__date-end');
    var dateStartInput = document.getElementById('listing__general-dateStart');
    var dateEndInput = document.getElementById('listing__general-dateEnd');
    var observeDatePicker = new MutationObserver(function observeDatePicker(mutations) {
      var attributeValue;
      mutations.forEach(function toggleUnclickableInfobox(mutation) {
        if (mutation.attributeName === 'class') {
          attributeValue = $(mutation.target).prop(mutation.attributeName);
          if (attributeValue.indexOf('mddtp-picker--inactive') > -1) {
            utils.removeClass(document.getElementById('appwrapper__infobox'), 'unclickable');
          } else {
            utils.addClass(document.getElementById('appwrapper__infobox'), 'unclickable');
          }
        }
      });
    });
    if (dateStartInput !== null) {
      console.log(dateStartInput.value);
      dateStartPicker = new dPick.default({
        type: 'date',
        init: moment(),
        future: moment().add(5, 'years'),
        trigger: dateStartInput,
        orientation: 'PORTRAIT'
      });
      observeDatePicker.observe(document.getElementById('mddtp-picker__date'), {
        attributes: true
      });
      dateStartInput.addEventListener('onOk', function displayPickedate() {
        utils.addClass(this.parentNode, 'is-dirty');
        this.value = dateStartPicker.time.format(format).toString();
      });
      dateStartBtn.addEventListener('click', function showDatePicker() {
        dateStartPicker.toggle();
      });
    }
    if (dateEndInput !== null) {
      dateEndInput.addEventListener('onOk', function displayPickedate() {
        utils.addClass(this.parentNode, 'is-dirty');
        this.value = dateEndPicker.time.format(format).toString();
      });
      dateEndPicker = new dPick.default({
        type: 'date',
        init: moment(),
        future: moment().add(5, 'years'),
        trigger: dateEndInput,
        orientation: 'PORTRAIT'
      });
      observeDatePicker.observe(document.getElementById('mddtp-picker__date'), {
        attributes: true
      });
      dateEndBtn.addEventListener('click', function showDatePicker() {
        dateEndPicker.toggle();
      });
    }
  }
  function setEstateType(type) {
    var types;
    if (lang === 'el') {
      types = {
        Διαμέρισμα: function getApartment() {
          return 'Apartment';
        },
        Μονοκατοικία: function getDetachedHouse() {
          return 'Detached House';
        },
        Μεζονέτα: function getMaisonette() {
          return 'Maisonette';
        },
        Έπαυλη: function getVilla() {
          return 'Villa';
        }
      };
    } else {
      types = {
        Apartment: function getApartment() {
          return 'Διαμέρισμα';
        },
        'Detached House': function getDetachedHouse() {
          return 'Μονοκατοικία';
        },
        Maisonette: function getMaisonette() {
          return 'Μεζονέτα';
        },
        Villa: function getVilla() {
          return 'Έπαυλη';
        }
      };
    }
    return types[type]();
  }
  function assignValidators() {
    var inputs = content.querySelectorAll('input[type=text]');
    [].forEach.call(inputs, function makeParsleyInputs(el) {
      el.addEventListener('blur', function snitize() {
        var str = this.value;
        var sanitizedStr;
        if (this.dataset.type === 'number') {
          sanitizedStr = str.replace(/[/\D/ ]/gi, '');
        } else if (this.dataset.type === 'alphanum') {
          sanitizedStr = str.replace(/[^a-z0-9A-ZA-zΑ-Ωα-ωίϊΐόάέύϋΰήώ ]/gi, '');
        } else if (this.dataset.type === 'special') {
          sanitizedStr = str.replace(/[^0-9 \/]/gi, '');
        } else if (this.dataset.type === 'date') {
          sanitizedStr = str.replace(/[^0-9 \-]/gi, '');
        }
        this.value = sanitizedStr;
        utils.removeClass(this.parentNode, 'is-invalid');
      });
    });
  }
  function collectValues(getXY) {
    var map = App.config.commons.map;
    var values = {};
    var filteredValues = {};
    var inputs = content.querySelectorAll('input[type=text]');
    var checkboxes = content.querySelectorAll('input[type=checkbox]');
    values.estate = {};
    values.listing = {};
    if (getXY) {
      values.estate.x = utils.findById(map, 'newEstates')
      .getSource().getFeatures()[0].getGeometry().getCoordinates()[0];
      values.estate.y = utils.findById(map, 'newEstates')
      .getSource().getFeatures()[0].getGeometry().getCoordinates()[1];
    } else {
      values.estate.x = document.getElementById('estate').dataset.originalx;
      values.estate.y = document.getElementById('estate').dataset.originaly;
    }
    [].forEach.call(inputs, function collectFromInputs(el) {
      var name = _.last(_.split(el.getAttribute('id'), '-', 3));
      var value = el.value;
      if (lang === 'el') {
        if (name === 'type' && el.id === 'estate__general_estate-type') {
          values.estate.estatetypeEn = setEstateType(value);
          values.estate.estatetype = value;
        } else if (name === 'type' && el.id === 'listing__idAndType-type') {
          if (value === 'Sale' || value === 'Πώληση') {
            values.listing.sale = true;
            values.listing.rent = false;
          } else {
            values.listing.sale = false;
            values.listing.rent = true;
          }
        }
        if (name === 'address') {
          values.estate.streetEn = utils.elToEn(value);
          values.estate.streetEl = value;
        }
      } else {
        if (name === 'type' && el.id === 'estate__general_estate-type') {
          values.estate.estatetypeEn = value;
          values.estate.estatetype = setEstateType(value);
        } else if (name === 'type' && el.id === 'listing__idAndType-type') {
          if (value === 'Sale' || value === 'Πώληση') {
            values.listing.sale = true;
            values.listing.rent = false;
          } else {
            values.listing.sale = false;
            values.listing.rent = true;
          }
        }
        if (name === 'address') {
          values.estate.streetEn = value;
          values.estate.streetEl = utils.elToEn(value);
        }
      }
      if (name === 'addressNumber') {
        values.estate.streetNumber = value;
      }
      if (name === 'price') {
        values.listing.price = value;
      }
      if (name === 'dateStart' || name === 'dateEnd') {
        values.listing[name] = value;
      } else {
        values.estate[name] = value;
      }
    });
    [].forEach.call(checkboxes, function collectFromCheckboxes(el) {
      var name = _.last(_.split(el.getAttribute('id'), '-', 3));
      var value = el.checked;
      if (name !== 'pets') {
        values.estate[name] = value;
      } else {
        values.listing[name] = value;
      }
    });
    filteredValues.estate = _.omit(values.estate, ['address', 'addressNumber', 'type', 'toggle']);
    filteredValues.listing = values.listing;
    return filteredValues;
  }
  function ajaxEstateAndListing(data) {
    console.log(data);
    data.estate.adminId = window.id;
    console.log(data.estate);
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/property',
        type: 'POST',
        data: data.estate
      })
      )
    .then(function resolve(estatedata) {
      var gid = estatedata.gid;
      var uploadOptions = {
        cloud_name: 'firvain',
        upload_preset: 'testupload',
        folder: gid,
        client_allowed_formats: 'jpg',
        theme: 'minimal'
      };
      cloudinary.openUploadWidget(uploadOptions, function upload(error, result) {
        console.log(error, result);
      });
      return gid;
    })
    .then(function resolve(gid) {
      data.listing.gid = gid;
      return $.ajax({
        url: 'http://127.0.0.1:3000/api/listing',
        type: 'POST',
        data: data.listing
      });
    })
    .finally(function closeInsert() {
      clearContent();
      utils.addClass(content, 'visuallyhidden');
      body.dataset.active = 'info';
      info.init();
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function ajaxListing(data) {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/listing',
        type: 'POST',
        data: _.merge({ gid: data.gid }, data.listing)
      })
      )
    .then(function resolve(result) {
      console.log(result);
    })
    .finally(function closeInsert() {
      clearContent();
      utils.addClass(content, 'visuallyhidden');
      body.dataset.active = 'info';
      info.init();
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function renderDustListing() {
    dustBluebird.renderAsync('insertListing', _.cloneDeep(App.config.commons.trans))
    .then(function resolve(data) {
      var agree = document.getElementById('confirmBtns__agree');
      var disagree = document.getElementById('confirmBtns__disagree');
      $('#estate').after(data);
      getmdlSelect.init('.getmdl-select');
      utils.removeClass(document.getElementById('confirmBtns'), 'visuallyhidden');
      assignValidators();
      datePicker();
      disagree.addEventListener('click', function insertAgree(e) {
        e.preventDefault();
        e.stopPropagation();
        clearContent();
        content.innerHTML = '';
        utils.addClass(content, 'visuallyhidden');
        body.dataset.active = info;
        info.init();
      });
      agree.addEventListener('click', function insertContinue(e) {
        var ajaxData;
        e.preventDefault();
        e.stopPropagation();
        if (checkEmpty() !== true) {
          ajaxData = collectValues(false);
          ajaxData.gid = document.getElementById('estate__info-gid').value;
          ajaxListing(ajaxData);
        }
      });
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  function renderDustEsateAndListing() {
    var map = App.config.commons.map;
    var draw = getInteraction('newEstate');
    var renderData = _.cloneDeep(App.config.commons.trans);
    dustBluebird.renderAsync('insert', renderData)
    .then(function resolve(data) {
      clearContent();
      content.innerHTML = data;
      utils.removeClass(content, 'visuallyhidden');
      getmdlSelect.init('.getmdl-select');
    })
    .then(function resolve(data) {
      var agree = document.getElementById('confirmBtns__agree');
      var disagree = document.getElementById('confirmBtns__disagree');
      var listing = document.getElementById('listing');
      assignValidators();
      datePicker();
      disagree.addEventListener('click', function insertAgree(e) {
        e.preventDefault();
        e.stopPropagation();
        clearContent();
        // content.innerHTML = data;
        utils.addClass(content, 'visuallyhidden');
        body.dataset.active = info;
        draw.setActive(false);
        utils.findById(map, 'newEstates').getSource().clear();
        info.init();
      });
      agree.addEventListener('click', function insertContinue(e) {
        e.preventDefault();
        e.stopPropagation();
        utils.removeClass(listing, 'visuallyhidden');
        this.innerHTML = 'Agree';
        e.target.removeEventListener(e.type, insertContinue);
        this.addEventListener('click', function insertAgree(evt) {
          var ajaxData;
          evt.preventDefault();
          evt.stopPropagation();
          // e.target.removeEventListener(e.type, insertAgree);
          if (checkEmpty() !== true) {
            ajaxData = collectValues(true);
            ajaxEstateAndListing(ajaxData);
          }
        });
      });
    })
    .catch(function error(e) {
      console.log(e);
    });
  }

  function createDrawInteraction() {
    var map = App.config.commons.map;
    var draw = new ol.interaction.Draw({
      features: drawnCollection,
      source: utils.findById(map, 'newEstates').getSource(),
      type: 'Point'
    });
    draw.set('id', 'newEstate');
    draw.setActive(false);
    map.addInteraction(draw);
  }
  function checkEstate() {
    if (content.innerHTML === 'undefined' || content.innerHTML === '') {
      return 0; // no estate or listing
    } else if (content.innerHTML !== 'undefined' && document.getElementById('listing') !== null) {
      return 1;  // there is a listing
    }
    return 2; // there is no listing
  }

  function insert() {
    var map = App.config.commons.map;
    var draw = getInteraction('newEstate');
    var newEstates = utils.findById(map, 'newEstates');
    info.disable();
    console.log(checkEstate());
    if (checkEstate() === 0) {
      document.getElementById('activeModule').innerHTML = 'Add Estate And Listing';
      draw.setActive(true);
      utils.findById(map, 'newEstates').setVisible(true);
      drawnCollection.on('change:length', function keepOnlyOneEstate() {
        if (this.getLength() > 0) {
          draw.setActive(false);
          newEstates.getSource().clear();
        }
      });
      draw.on('drawend', renderDustEsateAndListing);
    } else if (checkEstate() === 2) {
      document.getElementById('activeModule').innerHTML = 'Add Listing';
      draw.setActive(false);
      renderDustListing();
    } else {
      draw.setActive(false);
      document.getElementById('activeModule').innerHTML = 'Information';
      info.init();
    }
  }

  function init() {
    if (_.isEmpty(getInteraction('newEstate'))) {
      createDrawInteraction();
    }
    insert();
  }
  return {
    init: init
  };
}(window, document, Promise, jQuery, App, mdDateTimePicker, moment, dialogPolyfill, cloudinary));

var userMap = (function userMap(window, document, Promise, $, App) {
  'use strict';
  var context = 'admin';
  var lang = document.documentElement.lang;
  var $loading = $('.mdl-spinner');
  $(document)
  .ajaxStart(function start() {
    $('.spiner-wrapper').removeClass('visuallyhidden');
    $loading.addClass('is-active');
  })
  .ajaxStop(function stop() {
    $('.spiner-wrapper').addClass('visuallyhidden');
    $loading.removeClass('is-active');
  });
  toastr.options = {
    closeButton: false,
    debug: false,
    newestOnTop: false,
    progressBar: false,
    positionClass: 'toast-top-center',
    preventDuplicates: false,
    onclick: null,
    showDuration: '300',
    hideDuration: '1000',
    timeOut: '5000',
    extendedTimeOut: '1000',
    showEasing: 'swing',
    hideEasing: 'linear',
    showMethod: 'fadeIn',
    hideMethod: 'fadeOut'
  };
  function init() {
    Promise.resolve(
      $.ajax({
        url: 'http://127.0.0.1:3000/api/language',
        type: 'GET',
        data: {
          type: lang,
          context: context
        }
      })
      )
    .then(function resolve(data) {
      App.config.commons.trans = data;
      App.config.commons.map = App.config.modules.map.initialize();
    })
    .then(function resolve() {
      var moduleObserver;
      App.config.modules.info.init();
      moduleObserver = new MutationObserver(function moduleObserverChooser(mutations) {
        mutations.forEach(function foerEachMutation(mutation) {
          if (typeof mutation.target.dataset !== 'undefined') {
            if (mutation.target.dataset.active === 'insert') {
              App.config.modules.insert.init();
            } else if (mutation.target.dataset.active === 'delete') {
              App.config.modules.delete.init();
            } else if (mutation.target.dataset.active === 'edit') {
              App.config.modules.edit.init();
            }
          }
        });
      });
      moduleObserver.observe(document.querySelector('body'), {
        attributes: true
      });
    })
    .catch(function error(e) {
      console.log(e);
    });
  }
  return {
    init: init
  };
}(window, document, Promise, jQuery, App));

userMap.init();

$(function Dready() {
  var utils = App.utils;
  var addButton = document.getElementById('insert');
  var deleteButton = document.getElementById('delete');
  var editButton = document.querySelector('#edit');
  $('#logout').click(function logout() {
    location.href = '/logout';
  });
  document.getElementById('enter-fullscreen').addEventListener('click',
    function addClickEventToEnterFullsreen() {
      var elem = document.body;
      utils.requestFullScreen(elem);
      utils.removeClass(document.getElementById('exit-fullscreen').parentNode, 'visuallyhidden');
      utils.addClass(this.parentNode, 'visuallyhidden');
    }
  );
  document.getElementById('exit-fullscreen').addEventListener('click',
    function addClickEventToExitFullsreen() {
      var elem = document;
      utils.exitFullsreen(elem);
      utils.removeClass(document.getElementById('enter-fullscreen').parentNode, 'visuallyhidden');
      utils.addClass(this.parentNode, 'visuallyhidden');
    }
  );
  addButton.addEventListener('click', function activateInsertModule() {
    var body = document.querySelector('body');
    body.dataset.active = 'insert';
  });
  deleteButton.addEventListener('click', function activateDeleteModule() {
    var body = document.querySelector('body');
    body.dataset.active = 'delete';
  });
  editButton.addEventListener('click', function activateEditModule() {
    var body = document.querySelector('body');
    body.dataset.active = 'edit';
  });
  // console.log(bowser);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkN1c3RvbUV2ZW50LmpzIiwic2Nyb2xsSW50b1ZpZXdJZk5lZWRlZC5qcyIsImdsb2JhbHMuanMiLCJ1dGlscy5qcyIsIm9sMy1tYXAuanMiLCJpbmZvLmpzIiwiZWRpdC5qcyIsImRlbGV0ZS5qcyIsImluc2VydC5qcyIsImluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDN0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25KQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbExBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqTUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6WUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3piQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFkbWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiAoKSB7XHJcblxyXG4gIGlmICggdHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCA9PT0gXCJmdW5jdGlvblwiICkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICBmdW5jdGlvbiBDdXN0b21FdmVudCAoIGV2ZW50LCBwYXJhbXMgKSB7XHJcbiAgICBwYXJhbXMgPSBwYXJhbXMgfHwgeyBidWJibGVzOiBmYWxzZSwgY2FuY2VsYWJsZTogZmFsc2UsIGRldGFpbDogdW5kZWZpbmVkIH07XHJcbiAgICB2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoICdDdXN0b21FdmVudCcgKTtcclxuICAgIGV2dC5pbml0Q3VzdG9tRXZlbnQoIGV2ZW50LCBwYXJhbXMuYnViYmxlcywgcGFyYW1zLmNhbmNlbGFibGUsIHBhcmFtcy5kZXRhaWwgKTtcclxuICAgIHJldHVybiBldnQ7XHJcbiAgIH1cclxuXHJcbiAgQ3VzdG9tRXZlbnQucHJvdG90eXBlID0gd2luZG93LkV2ZW50LnByb3RvdHlwZTtcclxuXHJcbiAgd2luZG93LkN1c3RvbUV2ZW50ID0gQ3VzdG9tRXZlbnQ7XHJcbn0pKCk7XHJcbiIsIiAgKGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICghRWxlbWVudC5wcm90b3R5cGUuc2Nyb2xsSW50b1ZpZXdJZk5lZWRlZCkge1xyXG4gICAgICBFbGVtZW50LnByb3RvdHlwZS5zY3JvbGxJbnRvVmlld0lmTmVlZGVkID0gZnVuY3Rpb24gKGNlbnRlcklmTmVlZGVkKSB7XHJcbiAgICAgICAgY2VudGVySWZOZWVkZWQgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwID8gdHJ1ZSA6ICEhY2VudGVySWZOZWVkZWQ7XHJcblxyXG4gICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGUsXHJcbiAgICAgICAgcGFyZW50Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHBhcmVudCwgbnVsbCksXHJcbiAgICAgICAgcGFyZW50Qm9yZGVyVG9wV2lkdGggPSBwYXJzZUludChwYXJlbnRDb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2JvcmRlci10b3Atd2lkdGgnKSksXHJcbiAgICAgICAgcGFyZW50Qm9yZGVyTGVmdFdpZHRoID0gcGFyc2VJbnQocGFyZW50Q29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdib3JkZXItbGVmdC13aWR0aCcpKSxcclxuICAgICAgICBvdmVyVG9wID0gdGhpcy5vZmZzZXRUb3AgLSBwYXJlbnQub2Zmc2V0VG9wIDwgcGFyZW50LnNjcm9sbFRvcCxcclxuICAgICAgICBvdmVyQm90dG9tID0gKHRoaXMub2Zmc2V0VG9wIC0gcGFyZW50Lm9mZnNldFRvcCArIHRoaXMuY2xpZW50SGVpZ2h0IC0gcGFyZW50Qm9yZGVyVG9wV2lkdGgpID4gKHBhcmVudC5zY3JvbGxUb3AgKyBwYXJlbnQuY2xpZW50SGVpZ2h0KSxcclxuICAgICAgICBvdmVyTGVmdCA9IHRoaXMub2Zmc2V0TGVmdCAtIHBhcmVudC5vZmZzZXRMZWZ0IDwgcGFyZW50LnNjcm9sbExlZnQsXHJcbiAgICAgICAgb3ZlclJpZ2h0ID0gKHRoaXMub2Zmc2V0TGVmdCAtIHBhcmVudC5vZmZzZXRMZWZ0ICsgdGhpcy5jbGllbnRXaWR0aCAtIHBhcmVudEJvcmRlckxlZnRXaWR0aCkgPiAocGFyZW50LnNjcm9sbExlZnQgKyBwYXJlbnQuY2xpZW50V2lkdGgpLFxyXG4gICAgICAgIGFsaWduV2l0aFRvcCA9IG92ZXJUb3AgJiYgIW92ZXJCb3R0b207XHJcblxyXG4gICAgICAgIGlmICgob3ZlclRvcCB8fCBvdmVyQm90dG9tKSAmJiBjZW50ZXJJZk5lZWRlZCkge1xyXG4gICAgICAgICAgcGFyZW50LnNjcm9sbFRvcCA9IHRoaXMub2Zmc2V0VG9wIC0gcGFyZW50Lm9mZnNldFRvcCAtIHBhcmVudC5jbGllbnRIZWlnaHQgLyAyIC0gcGFyZW50Qm9yZGVyVG9wV2lkdGggKyB0aGlzLmNsaWVudEhlaWdodCAvIDI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoKG92ZXJMZWZ0IHx8IG92ZXJSaWdodCkgJiYgY2VudGVySWZOZWVkZWQpIHtcclxuICAgICAgICAgIHBhcmVudC5zY3JvbGxMZWZ0ID0gdGhpcy5vZmZzZXRMZWZ0IC0gcGFyZW50Lm9mZnNldExlZnQgLSBwYXJlbnQuY2xpZW50V2lkdGggLyAyIC0gcGFyZW50Qm9yZGVyTGVmdFdpZHRoICsgdGhpcy5jbGllbnRXaWR0aCAvIDI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoKG92ZXJUb3AgfHwgb3ZlckJvdHRvbSB8fCBvdmVyTGVmdCB8fCBvdmVyUmlnaHQpICYmICFjZW50ZXJJZk5lZWRlZCkge1xyXG4gICAgICAgICAgdGhpcy5zY3JvbGxJbnRvVmlldyhhbGlnbldpdGhUb3ApO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH1cclxuICB9KSgpO1xyXG4iLCJ3aW5kb3cuQXBwIHx8ICh3aW5kb3cuQXBwID0ge30pO1xyXG53aW5kb3cuQXBwLmNvbmZpZyA9IHtcclxuICBwcm9taXNlczoge1xyXG4gICAgZHVzdEJsdWViaXJkOiBQcm9taXNlLnByb21pc2lmeUFsbChkdXN0KSxcclxuICAgIGNsb3VkaW5hcnlCaXJkOiBQcm9taXNlLnByb21pc2lmeUFsbCgkLmNsb3VkaW5hcnkpXHJcbiAgfSxcclxuICBjb21tb25zOiB7XHJcbiAgICBtYXA6IHt9LFxyXG4gICAgdHJhbnM6IHt9XHJcbiAgfSxcclxuICBjYWNoZToge1xyXG4gICAgYWN0aXZlRXN0YXRlOiB7fSxcclxuICAgIGFjdGl2ZUVzdGF0ZUxpc3Rpbmc6IHt9XHJcbiAgfSxcclxuICBtb2R1bGVzOiB7XHJcbiAgICBtYXA6IHt9LFxyXG4gICAgaW5mbzoge30sXHJcbiAgICBlZGl0OiB7fSxcclxuICAgIGRlbGV0ZToge30sXHJcbiAgICBpbnNlcnQ6IHt9LFxyXG4gICAgZmlsdGVyczoge31cclxuICB9XHJcbn07XHJcbndpbmRvdy5BcHAudXRpbHMgPSB7fTtcclxuLy8gdmFyIHRyYW5zO1xyXG4vLyB2YXIgY2xvdWRpbmFyeUJpcmQgPSBQcm9taXNlLnByb21pc2lmeUFsbCgkLmNsb3VkaW5hcnkpO1xyXG4vLyB2YXIgYWN0aXZlRXN0YXRlO1xyXG4vLyB2YXIgYWN0aXZlRXN0YXRlTGlzdGluZztcclxuJC5jbG91ZGluYXJ5LmNvbmZpZyh7IGNsb3VkX25hbWU6ICdmaXJ2YWluJywgYXBpX2tleTogJzM3NTEzODkzMjY4OTU5MScgfSk7XHJcbiIsIi8qZXNsaW50IG5vLXBhcmFtLXJlYXNzaWduOiBbXCJlcnJvclwiLCB7IFwicHJvcHNcIjogZmFsc2UgfV0qL1xyXG5BcHAudXRpbHMgPSB7XHJcbiAgZmluZEJ5SWQ6IGZ1bmN0aW9uIGZpbmRCeUlkKG1hcCwgaWQpIHtcclxuICAgIHZhciBsYXllcnMgPSBtYXAuZ2V0TGF5ZXJzKCk7XHJcbiAgICB2YXIgbGVuZ3RoID0gbGF5ZXJzLmdldExlbmd0aCgpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAoaWQgPT09IGxheWVycy5pdGVtKGkpLmdldCgnaWQnKSkge1xyXG4gICAgICAgIHJldHVybiBsYXllcnMuaXRlbShpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfSxcclxuICBmaW5kQnlOYW1lOiBmdW5jdGlvbiBmaW5kQnlOYW1lKG1hcCwgbmFtZSkge1xyXG4gICAgdmFyIGxheWVycyA9IG1hcC5nZXRMYXllcnMoKTtcclxuICAgIHZhciBsZW5ndGggPSBsYXllcnMuZ2V0TGVuZ3RoKCk7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGlmIChuYW1lID09PSBsYXllcnMuaXRlbShpKS5nZXQoJ25hbWUnKSkge1xyXG4gICAgICAgIHJldHVybiBsYXllcnMuaXRlbShpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfSxcclxuICBwcmV2ZW50RG90QW5kU3BhY2U6IGZ1bmN0aW9uIHByZXZlbnREb3RBbmRTcGFjZShlKSB7XHJcbiAgICB2YXIga2V5ID0gZS5jaGFyQ29kZSA/IGUuY2hhckNvZGUgOiBlLmtleUNvZGU7XHJcbiAgICB0aGlzLmlubmVySFRNTCA9IGtleTtcclxuICAgIGlmIChrZXkgPT09IDQ2IHx8IGtleSA9PT0gMzIpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfSxcclxuICBnZW9tZXRyeUZ1bmN0aW9uOiBmdW5jdGlvbiBnZW9tZXRyeUZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBnZW9tZXRyeSkge1xyXG4gICAgdmFyIGdlb20gPSBnZW9tZXRyeTtcclxuICAgIHZhciBzdGFydDtcclxuICAgIHZhciBlbmQ7XHJcbiAgICBpZiAoIWdlb20pIHtcclxuICAgICAgZ2VvbSA9IG5ldyBvbC5nZW9tLlBvbHlnb24obnVsbCk7XHJcbiAgICB9XHJcbiAgICBzdGFydCA9IGNvb3JkaW5hdGVzWzBdO1xyXG4gICAgZW5kID0gY29vcmRpbmF0ZXNbMV07XHJcbiAgICBnZW9tLnNldENvb3JkaW5hdGVzKFtcclxuICAgICAgW3N0YXJ0LCBbc3RhcnRbMF0sIGVuZFsxXV0sIGVuZCwgW2VuZFswXSwgc3RhcnRbMV1dLCBzdGFydF1cclxuICAgIF0pO1xyXG4gICAgcmV0dXJuIGdlb207XHJcbiAgfSxcclxuICBoYXNDbGFzczogZnVuY3Rpb24gaGFzQ2xhc3MoZWwsIGNsYXNzTmFtZSkge1xyXG4gICAgaWYgKGVsLmNsYXNzTGlzdCkge1xyXG4gICAgICByZXR1cm4gZWwuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3IFJlZ0V4cCgnKF58ICknICsgY2xhc3NOYW1lICsgJyggfCQpJywgJ2dpJykudGVzdChlbC5jbGFzc05hbWUpO1xyXG4gIH0sXHJcbiAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIHJlbW92ZUNsYXNzKGVsLCBjbGFzc05hbWUpIHtcclxuICAgIHZhciBlbGVtZW50ID0gZWw7XHJcbiAgICBpZiAoZWxlbWVudC5jbGFzc0xpc3QpIHtcclxuICAgICAgZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UobmV3IFJlZ0V4cCgnKF58XFxcXGIpJyArIGNsYXNzTmFtZS5zcGxpdCgnICcpLmpvaW4oJ3wnKSArICcoXFxcXGJ8JCknLCAnZ2knKSwgJyAnKTtcclxuICAgIH1cclxuICB9LFxyXG4gIGFkZENsYXNzOiBmdW5jdGlvbiByZW1vdmVDbGFzcyhlbCwgY2xhc3NOYW1lKSB7XHJcbiAgICB2YXIgZWxlbWVudCA9IGVsO1xyXG4gICAgaWYgKGVsZW1lbnQuY2xhc3NMaXN0KSB7XHJcbiAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZWxlbWVudC5jbGFzc05hbWUgKz0gJyAnICsgY2xhc3NOYW1lO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIHRvZ2dsZUNsYXNzKGVsLCBjbGFzc05hbWUpIHtcclxuICAgIHZhciBjbGFzc2VzO1xyXG4gICAgdmFyIGV4aXN0aW5nSW5kZXg7XHJcbiAgICB2YXIgZWxlbWVudCA9IGVsO1xyXG4gICAgaWYgKGVsZW1lbnQuY2xhc3NMaXN0KSB7XHJcbiAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LnRvZ2dsZShjbGFzc05hbWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2xhc3NlcyA9IGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJyk7XHJcbiAgICAgIGV4aXN0aW5nSW5kZXggPSBjbGFzc2VzLmluZGV4T2YoY2xhc3NOYW1lKTtcclxuXHJcbiAgICAgIGlmIChleGlzdGluZ0luZGV4ID49IDApIHtcclxuICAgICAgICBjbGFzc2VzLnNwbGljZShleGlzdGluZ0luZGV4LCAxKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjbGFzc2VzLnB1c2goY2xhc3NOYW1lKTtcclxuICAgICAgfVxyXG4gICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVxdWVzdEZ1bGxTY3JlZW46IGZ1bmN0aW9uIHJlcXVlc3RGdWxsU2NyZWVuKGVsZW1lbnQpIHtcclxuICAgIC8vIFN1cHBvcnRzIG1vc3QgYnJvd3NlcnMgYW5kIHRoZWlyIHZlcnNpb25zLlxyXG4gICAgdmFyIHJlcXVlc3RNZXRob2QgPSBlbGVtZW50LnJlcXVlc3RGdWxsU2NyZWVuIHx8IGVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4gfHwgZWxlbWVudC5tb3pSZXF1ZXN0RnVsbFNjcmVlbiB8fCBlbGVtZW50Lm1zUmVxdWVzdEZ1bGxTY3JlZW47XHJcbiAgICB2YXIgd3NjcmlwdDtcclxuICAgIGlmIChyZXF1ZXN0TWV0aG9kKSB7IC8vIE5hdGl2ZSBmdWxsIHNjcmVlbi5cclxuICAgICAgcmVxdWVzdE1ldGhvZC5jYWxsKGVsZW1lbnQpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygd2luZG93LkFjdGl2ZVhPYmplY3QgIT09ICd1bmRlZmluZWQnKSB7IC8vIE9sZGVyIElFLlxyXG4gICAgICB3c2NyaXB0ID0gbmV3IEFjdGl2ZVhPYmplY3QoJ1dTY3JpcHQuU2hlbGwnKTtcclxuICAgICAgaWYgKHdzY3JpcHQgIT09IG51bGwpIHtcclxuICAgICAgICB3c2NyaXB0LlNlbmRLZXlzKCd7RjExfScpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfSxcclxuICBleGl0RnVsbHNyZWVuOiBmdW5jdGlvbiBleGl0RnVsbHNyZWVuKGVsZW1lbnQpIHtcclxuICAgIHZhciByZXF1ZXN0TWV0aG9kID0gZWxlbWVudC5leGl0RnVsbFNjcmVlbiB8fCBlbGVtZW50LndlYmtpdEV4aXRGdWxsc2NyZWVuIHx8IGVsZW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbiB8fCBlbGVtZW50Lm1zRXhpdEZ1bGxzY3JlZW47XHJcbiAgICB2YXIgd3NjcmlwdDtcclxuICAgIGlmIChyZXF1ZXN0TWV0aG9kKSB7IC8vIE5hdGl2ZSBmdWxsIHNjcmVlbi5cclxuICAgICAgcmVxdWVzdE1ldGhvZC5jYWxsKGVsZW1lbnQpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygd2luZG93LkFjdGl2ZVhPYmplY3QgIT09ICd1bmRlZmluZWQnKSB7IC8vIE9sZGVyIElFLlxyXG4gICAgICB3c2NyaXB0ID0gbmV3IEFjdGl2ZVhPYmplY3QoJ1dTY3JpcHQuU2hlbGwnKTtcclxuICAgICAgaWYgKHdzY3JpcHQgIT09IG51bGwpIHtcclxuICAgICAgICB3c2NyaXB0LlNlbmRLZXlzKCd7RXNjfScpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfSxcclxuICBlbFRvRW46IGZ1bmN0aW9uIGVsVG9FbihzdHJpbmcpIHtcclxuICAgIHZhciBvcmlnaW5hbFN0cmluZyA9IHN0cmluZztcclxuICAgIHZhciBuZXdTdHJpbmc7XHJcbiAgICB2YXIgcmVwbGFjZSA9IG5ldyBBcnJheSgnzrEnLCAnzqwnLCAnzoYnLCAnzpEnLCAnzrInLCAnzpInLCAnzrMnLCAnzpMnLCAnzrQnLCAnzpQnLCAnzrUnLCAnzq0nLCAnzpUnLCAnzognLCAnzrYnLCAnzpYnLCAnzrcnLCAnzq4nLCAnzpcnLCAnzrgnLCAnzpgnLCAnzrknLCAnzq8nLCAnz4onLCAnzpAnLCAnzpknLCAnzoonLCAnzronLCAnzponLCAnzrsnLCAnzpsnLCAnzrwnLCAnzpwnLCAnzr0nLCAnzp0nLCAnzr4nLCAnzp4nLCAnzr8nLCAnz4wnLCAnzp8nLCAnzownLCAnz4AnLCAnzqAnLCAnz4EnLCAnzqEnLCAnz4MnLCAnz4InLCAnzqMnLCAnz4QnLCAnzqQnLCAnz4UnLCAnz40nLCAnzqUnLCAnzo4nLCAnz4YnLCAnzqYnLCAnz4cnLCAnzqcnLCAnz4gnLCAnzqgnLCAnz4knLCAnz44nLCAnzqknLCAnzo8nLCAnICcsICdcXCcnLCAnXFwnJywgJywnKTtcclxuICAgIHZhciByZXBsYWNlX24gPSBuZXcgQXJyYXkoJ2EnLCAnYScsICdBJywgJ0EnLCAndicsICdWJywgJ2cnLCAnRycsICdkJywgJ0QnLCAnZScsICdlJywgJ0UnLCAnRScsICd6JywgJ1onLCAnaScsICdpJywgJ0knLCAndGgnLCAnVGgnLCAnaScsICdpJywgJ2knLCAnaScsICdJJywgJ0knLCAnaycsICdLJywgJ2wnLCAnTCcsICdtJywgJ00nLCAnbicsICdOJywgJ3gnLCAnWCcsICdvJywgJ28nLCAnTycsICdPJywgJ3AnLCAnUCcsICdyJywgJ1InLCAncycsICdzJywgJ1MnLCAndCcsICdUJywgJ3UnLCAndScsICdZJywgJ1knLCAnZicsICdGJywgJ2NoJywgJ0NoJywgJ3BzJywgJ1BzJywgJ28nLCAnbycsICdPJywgJ08nLCAnICcsICdfJywgJ18nLCAnXycpO1xyXG5cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVwbGFjZS5sZW5ndGg7IGkrKykge1xyXG4gICAgICBvcmlnaW5hbFN0cmluZyA9IG9yaWdpbmFsU3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cChyZXBsYWNlW2ldLCAnZycpLCByZXBsYWNlX25baV0pO1xyXG4gICAgfVxyXG4gICAgbmV3U3RyaW5nID0gb3JpZ2luYWxTdHJpbmc7XHJcbiAgICByZXR1cm4gbmV3U3RyaW5nO1xyXG4gIH0sXHJcbiAgaGFuZGxlRGF0ZTogZnVuY3Rpb24gaGFuZGxlRGF0ZShzdHIsIGxhbmcpIHtcclxuICAgIHZhciBzcGxpdDtcclxuICAgIHZhciBuZXdEYXRlID0gW107XHJcbiAgICBpZiAodHlwZW9mIHN0ciA9PT0gJ3N0cmluZycgJiYgbGFuZyAhPT0gJ2VsJykge1xyXG4gICAgICBzcGxpdCA9IF8uc3BsaXQoc3RyLCAnLScsIDMpO1xyXG4gICAgICBuZXdEYXRlID0gW3NwbGl0WzFdLCBzcGxpdFswXSwgc3BsaXRbMl1dO1xyXG4gICAgICByZXR1cm4gXy5qb2luKG5ld0RhdGUsICctJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3RyO1xyXG4gIH0sXHJcbiAgc2FuaXRpemU6IGZ1bmN0aW9uIHNhbml0aXplKGVsKSB7XHJcbiAgICB2YXIgc2FuaXRpemVkU3RyO1xyXG4gICAgdmFyIHN0ciA9IGVsLnZhbHVlO1xyXG4gICAgc2FuaXRpemVkU3RyID0gc3RyLnJlcGxhY2UoL1teYS16MC05QS1aQS16zpEtzqnOsS3Pic6vz4rOkM+MzqzOrc+Nz4vOsM6uz45dL2dpLCAnJyk7XHJcbiAgICBlbC52YWx1ZSA9IHNhbml0aXplZFN0cjtcclxuICAgIGNvbnNvbGUubG9nKGVsKTtcclxuICAgIGNvbnNvbGUubG9nKGVsLnZhbHVlKTtcclxuICAgIGNvbnNvbGUubG9nKHNhbml0aXplZFN0cik7XHJcbiAgfVxyXG4gIC8vIHpvb21Ub0dpZDogZnVuY3Rpb24gem9vbVRvR2lkKG1hcCwgZ2lkKSB7XHJcbiAgLy8gICB2YXIgY29vcmRpbmF0ZXMgPSB1dGlscy5maW5kQnlJZChtYXAsICdmaWx0ZXJlZEVzdGF0ZXMnKS5nZXRTb3VyY2UoKS5nZXRGZWF0dXJlQnlJZChnaWQpXHJcbiAgLy8gICAuZ2V0R2VvbWV0cnkoKVxyXG4gIC8vICAgLmdldENvb3JkaW5hdGVzKCk7XHJcbiAgLy8gICBtYXAuZ2V0VmlldygpLnNldENlbnRlcihjb29yZGluYXRlcyk7XHJcbiAgLy8gfVxyXG59O1xyXG4iLCJBcHAuY29uZmlnLm1vZHVsZXMubWFwID0gKGZ1bmN0aW9uIG9sM01hcCh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCBvbCwgQXBwKSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG4gIHZhciBjZW50ZXIgPSBbMzY3NzM4NSwgNDEyMDk0OV07XHJcbiAgdmFyIGV4dGVudCA9IFszNjUyNzcyLCA0MTEyODA4LCAzNzAwMDAwLCA0MTMyNzk3XTtcclxuICB2YXIgZ2VvSlNPTkZvcm1hdCA9IG5ldyBvbC5mb3JtYXQuR2VvSlNPTih7XHJcbiAgICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbiAgfSk7XHJcblxyXG4gIHZhciBtYXBTdHlsZXMgPSB7XHJcbiAgICBpY29uVHlwZTogZnVuY3Rpb24gZ2V0SWNvblR5cGUoZXN0YXRlVHlwZSkge1xyXG4gICAgICB2YXIgaWNvblR5cGUgPSB7XHJcbiAgICAgICAgQXBhcnRtZW50OiBmdW5jdGlvbiBnZXRBcGFydG1lbnRJY29uKCkge1xyXG4gICAgICAgICAgcmV0dXJuICdhcGFydG1lbnQnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgU3RvcmU6IGZ1bmN0aW9uIGdldFN0b3JlSWNvbigpIHtcclxuICAgICAgICAgIHJldHVybiAnc3RvcmUnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgJ0RldGFjaGVkIEhvdXNlJzogZnVuY3Rpb24gZ2V0RGV0YWNoZWRIb3VzZUljb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ2RldGFjaGVkJztcclxuICAgICAgICB9LFxyXG4gICAgICAgIE1haXNvbmV0dGU6IGZ1bmN0aW9uIGdldE1haXNvbmV0dGVJY29uKCkge1xyXG4gICAgICAgICAgcmV0dXJuICdtYWlzb25ldHRlJztcclxuICAgICAgICB9LFxyXG4gICAgICAgIFZpbGxhOiBmdW5jdGlvbiBnZXRWaWxsYUlvbigpIHtcclxuICAgICAgICAgIHJldHVybiAndmlsbGEnO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIChpY29uVHlwZVtlc3RhdGVUeXBlXSkoKTtcclxuICAgIH0sXHJcbiAgICBlc3RhdGVzOiBmdW5jdGlvbiBlc3RhdGVzKGZlYXR1cmUpIHtcclxuICAgICAgdmFyIHNyYyA9ICcuL2ltYWdlcy9waW5zL25vbmUvJyArXHJcbiAgICAgIG1hcFN0eWxlcy5pY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNDgucG5nJztcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgICAgZ2VvbWV0cnk6IGZlYXR1cmUuZ2V0R2VvbWV0cnkoKSxcclxuICAgICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICAgIHNyYzogc3JjLFxyXG4gICAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgICAgYW5jaG9yOiBbMC41LCAwXSxcclxuICAgICAgICAgIHNjYWxlOiAxXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIHZhciBtYXBTb3VyY2VzID0ge1xyXG4gICAgYmluZzogZnVuY3Rpb24gYmluZygpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuQmluZ01hcHMoe1xyXG4gICAgICAgIGtleTogJ0FrMkdxOFZVZklDc1BwdWY3TFJBTlhtWHQyc0hXbVNMUGhvaG1WTEZ0RklFd1lqc181TUN5QWhBRndSU1ZwTGonLFxyXG4gICAgICAgIGltYWdlcnlTZXQ6ICdBZXJpYWxXaXRoTGFiZWxzJ1xyXG4gICAgICB9KTtcclxuICAgIH0sXHJcbiAgICBtYXBCb3g6IGZ1bmN0aW9uIG1hcEJveCgpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuWFlaKHtcclxuICAgICAgICBhdHRyaWJ1dGlvbnM6IFtuZXcgb2wuQXR0cmlidXRpb24oe1xyXG4gICAgICAgICAgaHRtbDogJzxhIGhyZWY9XCJodHRwczovL3d3dy5tYXBib3guY29tL2Fib3V0L21hcHMvXCIgdGFyZ2V0PVwiX2JsYW5rXCI+JmNvcHk7IE1hcGJveCAmY29weTsgT3BlblN0cmVldE1hcDwvYT4nXHJcbiAgICAgICAgfSldLFxyXG4gICAgICAgIHVybDogJ2h0dHBzOi8vYXBpLm1hcGJveC5jb20vdjQvbWFwYm94LnN0cmVldHMve3p9L3t4fS97eX0ucG5nP2FjY2Vzc190b2tlbj1way5leUoxSWpvaVptbHlkbUZwYmlJc0ltRWlPaUpsT1dZeVlUTTBOVGhpTldNMFlqSmpPREpqTkRFNE9EUXpOekEyTUdReU5pSjkuLU5WRE8yN0h6dC13X25Rb3NVUGZMQSdcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgZXN0YXRlczogZnVuY3Rpb24gZXN0YXRlcygpIHtcclxuICAgICAgcmV0dXJuIG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcclxuICAgICAgICBmb3JtYXQ6IGdlb0pTT05Gb3JtYXQsXHJcbiAgICAgICAgbG9hZGVyOiBmdW5jdGlvbiBwcm9wZXJ0eUxvYWRlcigpIHtcclxuICAgICAgICAgIHZhciB1cmwgPSAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9wcm9wZXJ0eS9hbGwvJyArIGlkO1xyXG4gICAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICAgIHVybDogdXJsLFxyXG4gICAgICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIClcclxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICAgICAgICB2YXIgZmVhdHVyZXMgPSBnZW9KU09ORm9ybWF0LnJlYWRGZWF0dXJlcyhkYXRhLCB7XHJcbiAgICAgICAgICAgICAgZmVhdHVyZVByb2plY3Rpb246ICdFUFNHOjM4NTcnXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzZWxmLmFkZEZlYXR1cmVzKGZlYXR1cmVzKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKCkge1xyXG4gICAgICAgICAgICBzZWxmLmdldEZlYXR1cmVzKCkuZm9yRWFjaChmdW5jdGlvbiBhZGRJZHMoZmVhdHVyZSkge1xyXG4gICAgICAgICAgICAgIGZlYXR1cmUuc2V0SWQoZmVhdHVyZS5nZXRQcm9wZXJ0aWVzKCkuZ2lkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgICAgIGlmIChlLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgYW55IHByb3BlcnRpZXMhJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZS5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZSEnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvciEgUGxlYXNlIHJlbG9hZCBwYWdlIG9yIHRyeSBhZ2FpbiBsYXRlcicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIHZhciBtYXBMYXllcnMgPSB7XHJcbiAgICBiaW5nOiBmdW5jdGlvbiBiaW5nKHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuYmluZygpLFxyXG4gICAgICAgIG1heFpvb206IDE5LFxyXG4gICAgICAgIGNyb3NzT3JpZ2luOiAnYW5vbnltb3VzJyxcclxuICAgICAgICBwcmVsb2FkOiBJbmZpbml0eSxcclxuICAgICAgICBpZDogJ2JpbmcnLFxyXG4gICAgICAgIG5hbWU6IHRyYW5zLmxheWVycy5iaW5nXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIG1hcEJveDogZnVuY3Rpb24gbWFwQm94KHRyYW5zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVGlsZSh7XHJcbiAgICAgICAgc291cmNlOiBtYXBTb3VyY2VzLm1hcEJveCgpLFxyXG4gICAgICAgIGlkOiAnbWFwYm94JyxcclxuICAgICAgICBuYW1lOiB0cmFucy5sYXllcnMubWFwQm94XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGVzdGF0ZXM6IGZ1bmN0aW9uIGVzdGF0ZXMoKSB7XHJcbiAgICAgIHJldHVybiBuZXcgb2wubGF5ZXIuVmVjdG9yKHtcclxuICAgICAgICBzb3VyY2U6IG1hcFNvdXJjZXMuZXN0YXRlcygpLFxyXG4gICAgICAgIGlkOiAnZXN0YXRlcycsXHJcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcclxuICAgICAgICBzdHlsZTogbWFwU3R5bGVzLmVzdGF0ZXNcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG4gICAgbmV3RXN0YXRlczogZnVuY3Rpb24gbmV3RXN0YXRlcyh0cmFucykge1xyXG4gICAgICByZXR1cm4gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgICAgICAgc291cmNlOiBuZXcgb2wuc291cmNlLlZlY3RvcigpLFxyXG4gICAgICAgIGlkOiAnbmV3RXN0YXRlcycsXHJcbiAgICAgICAgdmlzaWJsZTogZmFsc2VcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfTtcclxuICB2YXIgaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7XHJcbiAgICB2YXIgdHJhbnMgPSBBcHAuY29uZmlnLmNvbW1vbnMudHJhbnM7XHJcbiAgICB2YXIgbGF5ZXJzID0gT2JqZWN0LmtleXMobWFwTGF5ZXJzKS5tYXAoZnVuY3Rpb24gYWRkTWFwTGF5ZXJzKGtleSkge1xyXG4gICAgICBpZiAoa2V5ICE9PSAnYmluZycpIHsgcmV0dXJuIG1hcExheWVyc1trZXldKHRyYW5zKTsgfVxyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG5ldyBvbC5NYXAoe1xyXG4gICAgICB0YXJnZXQ6ICdhcHB3cmFwcGVyX19tYXAnLFxyXG4gICAgICBsYXllcnM6IF8uY29tcGFjdChsYXllcnMpLFxyXG4gICAgICBsb2FkVGlsZXNXaGlsZUFuaW1hdGluZzogdHJ1ZSxcclxuICAgICAgbG9hZFRpbGVzV2hpbGVJbnRlcmFjdGluZzogdHJ1ZSxcclxuICAgICAgcmVuZGVyZXI6ICdjYW52YXMnLFxyXG4gICAgICBjb250cm9sczogb2wuY29udHJvbC5kZWZhdWx0cyh7XHJcbiAgICAgICAgYXR0cmlidXRpb25PcHRpb25zOiB7XHJcbiAgICAgICAgICBjb2xsYXBzaWJsZTogZmFsc2UsXHJcbiAgICAgICAgICBjb2xsYXBzZWQ6IGZhbHNlXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICAgLmV4dGVuZChbXHJcbiAgICAgICAgIG5ldyBvbC5jb250cm9sLlNjYWxlTGluZSh7XHJcbiAgICAgICAgICAgdW5pdHM6ICdtZXRyaWMnXHJcbiAgICAgICAgIH0pLCBuZXcgb2wuY29udHJvbC5PdmVydmlld01hcCh7XHJcbiAgICAgICAgICAgY2xhc3NOYW1lOiAnb2wtb3ZlcnZpZXdtYXAgb2wtY3VzdG9tLW92ZXJ2aWV3bWFwJyxcclxuICAgICAgICAgICBjb2xsYXBzaWJsZTogdHJ1ZSxcclxuICAgICAgICAgICBjb2xsYXBzZWQ6IHRydWUsXHJcbiAgICAgICAgICAgbGF5ZXJzOiBbbWFwTGF5ZXJzLmJpbmcodHJhbnMpXVxyXG4gICAgICAgICB9KSxcclxuICAgICAgICAgbmV3IG9sLmNvbnRyb2wuWm9vbVRvRXh0ZW50KHtcclxuICAgICAgICAgICBleHRlbnQ6IGV4dGVudFxyXG4gICAgICAgICB9KVxyXG4gICAgICAgXSksXHJcbiAgICAgIHZpZXc6IG5ldyBvbC5WaWV3KHtcclxuICAgICAgICBjZW50ZXI6IGNlbnRlcixcclxuICAgICAgICBleHRlbnQ6IGV4dGVudCxcclxuICAgICAgICBwcm9qZWN0aW9uOiAnRVBTRzozODU3JyxcclxuICAgICAgICB6b29tOiAxNCxcclxuICAgICAgICBtYXhab29tOiAxOSxcclxuICAgICAgICBtaW5ab29tOiAxNFxyXG4gICAgICB9KVxyXG4gICAgfSk7XHJcbiAgfTtcclxuICByZXR1cm4ge1xyXG4gICAgaW5pdGlhbGl6ZTogaW5pdGlhbGl6ZVxyXG4gIH07XHJcbn0od2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgb2wsIEFwcCkpO1xyXG4iLCJBcHAuY29uZmlnLm1vZHVsZXMuaW5mbyA9IChmdW5jdGlvbiBpbmZvKHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsICQsIEFwcCkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgbGFuZyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5sYW5nO1xyXG4gIHZhciBlZGl0QnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2VkaXQnKTtcclxuICB2YXIgZGVsZXRlQnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2RlbGV0ZScpO1xyXG4gIHZhciBpbmZvQm94Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNhcHB3cmFwcGVyX19pbmZvYm94LWNvbnRlbnQnKTtcclxuICB2YXIgZHVzdEJsdWViaXJkID0gQXBwLmNvbmZpZy5wcm9taXNlcy5kdXN0Qmx1ZWJpcmQ7XHJcbiAgdmFyIHV0aWxzID0gQXBwLnV0aWxzO1xyXG4gIGZ1bmN0aW9uIGR1c3RFc3RhdGVJbmZvKGRhdGEpIHtcclxuICAgIGR1c3RCbHVlYmlyZC5yZW5kZXJBc3luYygnZWRpdCcsIGRhdGEpXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlRHVzdChyZXN1bHQpIHtcclxuICAgICAgdXRpbHMucmVtb3ZlQ2xhc3MoaW5mb0JveENvbnRlbnQsICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICBpbmZvQm94Q29udGVudC5pbm5lckhUTUwgPSByZXN1bHQ7XHJcbiAgICAgIGdldG1kbFNlbGVjdC5pbml0KCcuZ2V0bWRsLXNlbGVjdCcpO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHNlbGVjdEZlYXR1cmUoZXZ0KSB7XHJcbiAgICB2YXIgbWFwID0gZXZ0Lm1hcDtcclxuICAgIHZhciBjb29yZGluYXRlcztcclxuICAgIHZhciBlc3RhdGU7XHJcbiAgICB2YXIgZ2lkO1xyXG4gICAgdmFyIHJlbmRlckRhdGEgPSBfLmNsb25lRGVlcChBcHAuY29uZmlnLmNvbW1vbnMudHJhbnMpO1xyXG4gICAgdmFyIHN0eWxlID0gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgICAgc3JjOiAnLi9pbWFnZXMvcGlucy9nZW5lcmljLTQ4LnBuZycsXHJcbiAgICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICAgIGFuY2hvcjogWzAuNSwgMF0sXHJcbiAgICAgICAgc2NhbGU6IDEsXHJcbiAgICAgICAgY29sb3I6ICdyZ2IoMjU1LDgyLDgyKSdcclxuICAgICAgfSkpXHJcbiAgICB9KTtcclxuICAgIC8vIHZhciBjb29yZGluYXRlID0gZXZ0LmNvb3JkaW5hdGU7XHJcbiAgICB2YXIgY2xpY2tlZEZlYXR1cmUgPSBtYXAuZm9yRWFjaEZlYXR1cmVBdFBpeGVsKGV2dC5waXhlbCwgZnVuY3Rpb24gZmluZEZlYXR1cmUoZmVhdHVyZSwgbGF5ZXIpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBmZWF0dXJlOiBmZWF0dXJlLFxyXG4gICAgICAgIGxheWVyOiBsYXllclxyXG4gICAgICB9O1xyXG4gICAgfSwgdGhpcywgZnVuY3Rpb24gY2xpY2tlZEZlYXR1cmVMYXllckZpbHRlcihsYXllcikge1xyXG4gICAgICBpZiAobGF5ZXIuZ2V0KCdpZCcpID09PSAnZXN0YXRlcycpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9LCB0aGlzKTtcclxuICAgIGlmIChjbGlja2VkRmVhdHVyZSkge1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdlc3RhdGVzJykuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZXMoKVxyXG4gICAgICAuZm9yRWFjaChmdW5jdGlvbiByZXNldFN0eWxlKGZlYXR1cmUpIHtcclxuICAgICAgICBmZWF0dXJlLnNldFN0eWxlKG51bGwpO1xyXG4gICAgICB9KTtcclxuICAgICAgZXN0YXRlID0gY2xpY2tlZEZlYXR1cmUuZmVhdHVyZTtcclxuICAgICAgY29vcmRpbmF0ZXMgPSBlc3RhdGUuZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpO1xyXG4gICAgICBtYXAuZ2V0VmlldygpLnNldENlbnRlcihjb29yZGluYXRlcyk7XHJcbiAgICAgIG1hcC5nZXRWaWV3KCkuc2V0Wm9vbSgxNik7XHJcbiAgICAgIGdpZCA9IGVzdGF0ZS5nZXRQcm9wZXJ0aWVzKCkuZ2lkO1xyXG4gICAgICBlc3RhdGUuc2V0U3R5bGUoc3R5bGUpO1xyXG4gICAgICB2YXIgcDEgPSBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9hcGkvcHJvcGVydHknLFxyXG4gICAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgIGdpZDogZ2lkXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICBwMS50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICAgIHZhciBmZWF0dXJlID0gZGF0YS5mZWF0dXJlc1swXTtcclxuICAgICAgICBBcHAuY29uZmlnLmNhY2hlLmFjdGl2ZUVzdGF0ZSA9IGZlYXR1cmUucHJvcGVydGllcztcclxuICAgICAgICByZXR1cm4gZmVhdHVyZTtcclxuICAgICAgfSlcclxuICAgICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShmZWF0dXJlKSB7XHJcbiAgICAgICAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgICAgIHJlbmRlckRhdGEudmFsdWVzID0ge1xyXG4gICAgICAgICAgICBnaWQ6IGZlYXR1cmUucHJvcGVydGllcy5naWQsXHJcbiAgICAgICAgICAgIHg6IGNvb3JkaW5hdGVzWzBdLFxyXG4gICAgICAgICAgICB5OiBjb29yZGluYXRlc1sxXSxcclxuICAgICAgICAgICAgYXJlYU5hbWU6IGZlYXR1cmUucHJvcGVydGllcy5hcmVhX25hbWUsXHJcbiAgICAgICAgICAgIGVzdGF0ZVR5cGU6IGZlYXR1cmUucHJvcGVydGllcy5lc3RhdGV0eXBlLFxyXG4gICAgICAgICAgICBhZGRyZXNzOiBmZWF0dXJlLnByb3BlcnRpZXMuc3RyZWV0X2VsLFxyXG4gICAgICAgICAgICBhZGRyZXNzTnVtYmVyOiBmZWF0dXJlLnByb3BlcnRpZXMuc3RyZWV0X251bWJlcixcclxuICAgICAgICAgICAgcHNjb2RlOiBmZWF0dXJlLnByb3BlcnRpZXMucHNfY29kZSxcclxuICAgICAgICAgICAgZXN0YXRlQXJlYTogZmVhdHVyZS5wcm9wZXJ0aWVzLmVzdGF0ZWFyZWEsXHJcbiAgICAgICAgICAgIGJlZHJvb21zOiBmZWF0dXJlLnByb3BlcnRpZXMuYmVkcm9vbXMsXHJcbiAgICAgICAgICAgIGZsb29yOiBmZWF0dXJlLnByb3BlcnRpZXMuZmxvb3IsXHJcbiAgICAgICAgICAgIHllYXI6IGZlYXR1cmUucHJvcGVydGllcy55ZWFyLFxyXG4gICAgICAgICAgICBwbGFuTnVtYmVyOiBmZWF0dXJlLnByb3BlcnRpZXMucGxhbl9udW0sXHJcbiAgICAgICAgICAgIHBsb3RBcmVhOiBmZWF0dXJlLnByb3BlcnRpZXMucGxvdGFyZWEsXHJcbiAgICAgICAgICAgIHBhcmNlbE51bWJlcjogZmVhdHVyZS5wcm9wZXJ0aWVzLnBhcmNlbF9udW0sXHJcbiAgICAgICAgICAgIHBhcmtpbmc6IGZlYXR1cmUucHJvcGVydGllcy5wYXJraW5nLFxyXG4gICAgICAgICAgICBmdXJuaXNoZWQ6IGZlYXR1cmUucHJvcGVydGllcy5mdXJuaXNoZWQsXHJcbiAgICAgICAgICAgIGlzbmV3OiBmZWF0dXJlLnByb3BlcnRpZXMuaXNuZXcsXHJcbiAgICAgICAgICAgIGhlYXRpbmc6IGZlYXR1cmUucHJvcGVydGllcy5oZWF0aW5nLFxyXG4gICAgICAgICAgICBjb29saW5nOiBmZWF0dXJlLnByb3BlcnRpZXMuY29vbGluZyxcclxuICAgICAgICAgICAgdmlldzogZmVhdHVyZS5wcm9wZXJ0aWVzLnZpZXcsXHJcbiAgICAgICAgICAgIHRpdGxlOiBmZWF0dXJlLnByb3BlcnRpZXMudGl0bGVcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlbmRlckRhdGEudmFsdWVzID0ge1xyXG4gICAgICAgICAgICBnaWQ6IGZlYXR1cmUucHJvcGVydGllcy5naWQsXHJcbiAgICAgICAgICAgIHg6IGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMF0sXHJcbiAgICAgICAgICAgIHk6IGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMV0sXHJcbiAgICAgICAgICAgIGFyZWFOYW1lOiBmZWF0dXJlLnByb3BlcnRpZXMuYXJlYV9uYW1lLFxyXG4gICAgICAgICAgICBlc3RhdGVUeXBlOiBmZWF0dXJlLnByb3BlcnRpZXMuZXN0YXRldHlwZV9lbixcclxuICAgICAgICAgICAgYWRkcmVzczogZmVhdHVyZS5wcm9wZXJ0aWVzLnN0cmVldF9lbixcclxuICAgICAgICAgICAgYWRkcmVzc051bWJlcjogZmVhdHVyZS5wcm9wZXJ0aWVzLnN0cmVldF9udW1iZXIsXHJcbiAgICAgICAgICAgIHBzY29kZTogZmVhdHVyZS5wcm9wZXJ0aWVzLnBzX2NvZGUsXHJcbiAgICAgICAgICAgIGVzdGF0ZUFyZWE6IGZlYXR1cmUucHJvcGVydGllcy5lc3RhdGVhcmVhLFxyXG4gICAgICAgICAgICBiZWRyb29tczogZmVhdHVyZS5wcm9wZXJ0aWVzLmJlZHJvb21zLFxyXG4gICAgICAgICAgICBmbG9vcjogZmVhdHVyZS5wcm9wZXJ0aWVzLmZsb29yLFxyXG4gICAgICAgICAgICB5ZWFyOiBmZWF0dXJlLnByb3BlcnRpZXMueWVhcixcclxuICAgICAgICAgICAgcGxhbk51bWJlcjogZmVhdHVyZS5wcm9wZXJ0aWVzLnBsYW5fbnVtLFxyXG4gICAgICAgICAgICBwbG90QXJlYTogZmVhdHVyZS5wcm9wZXJ0aWVzLnBsb3RhcmVhLFxyXG4gICAgICAgICAgICBwYXJjZWxOdW1iZXI6IGZlYXR1cmUucHJvcGVydGllcy5wYXJjZWxfbnVtLFxyXG4gICAgICAgICAgICBwYXJraW5nOiBmZWF0dXJlLnByb3BlcnRpZXMucGFya2luZyxcclxuICAgICAgICAgICAgZnVybmlzaGVkOiBmZWF0dXJlLnByb3BlcnRpZXMuZnVybmlzaGVkLFxyXG4gICAgICAgICAgICBpc25ldzogZmVhdHVyZS5wcm9wZXJ0aWVzLmlzbmV3LFxyXG4gICAgICAgICAgICBoZWF0aW5nOiBmZWF0dXJlLnByb3BlcnRpZXMuaGVhdGluZyxcclxuICAgICAgICAgICAgY29vbGluZzogZmVhdHVyZS5wcm9wZXJ0aWVzLmNvb2xpbmcsXHJcbiAgICAgICAgICAgIHZpZXc6IGZlYXR1cmUucHJvcGVydGllcy52aWV3LFxyXG4gICAgICAgICAgICB0aXRsZTogZmVhdHVyZS5wcm9wZXJ0aWVzLnRpdGxlXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHAxLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHZhciBwMiA9IFByb21pc2UucmVzb2x2ZShcclxuICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9saXN0aW5nJyxcclxuICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICBnaWQ6IGdpZFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgICBBcHAuY29uZmlnLmNhY2hlLmFjdGl2ZUVzdGF0ZUxpc3RpbmcgPSBkYXRhO1xyXG4gICAgICAgIHJlbmRlckRhdGEubGlzdGluZy52YWx1ZXMgPSBkYXRhO1xyXG4gICAgICAgIHJlbmRlckRhdGEubGlzdGluZy52YWx1ZXMuZGF0ZV9zdGFydCA9IHV0aWxzLmhhbmRsZURhdGUoZGF0YS5kYXRlX3N0YXJ0LCBsYW5nKTtcclxuICAgICAgICByZW5kZXJEYXRhLmxpc3RpbmcudmFsdWVzLmRhdGVfZW5kID0gdXRpbHMuaGFuZGxlRGF0ZShkYXRhLmRhdGVfZW5kLCBsYW5nKTtcclxuICAgICAgICByZW5kZXJEYXRhLmxpc3RpbmcuZXhpc3RzID0gdHJ1ZTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgICB2YXIgc25hY2tiYXJDb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjYXBwd3JhcHBlcl9fc25hY2tiYXInKTtcclxuICAgICAgICB2YXIgZGF0YSA9IHsgbWVzc2FnZTogQXBwLmNvbmZpZy5jb21tb25zLnRyYW5zLmVycm9ycy5saXN0aW5nNDA0IH07XHJcbiAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgaWYgKGUuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgIHJlbmRlckRhdGEubGlzdGluZy5leGlzdHMgPSBmYWxzZTtcclxuICAgICAgICAgIHNuYWNrYmFyQ29udGFpbmVyLk1hdGVyaWFsU25hY2tiYXIuc2hvd1NuYWNrYmFyKGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIFByb21pc2UuZWFjaChbcDEsIHAyXSwgZnVuY3Rpb24gZShyZXN1bHQpIHtcclxuICAgICAgfSlcclxuICAgICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZSgpIHtcclxuICAgICAgICBkdXN0RXN0YXRlSW5mbyhyZW5kZXJEYXRhKTtcclxuICAgICAgICBlZGl0QnV0dG9uLnJlbW92ZUF0dHJpYnV0ZSgnZGlzYWJsZWQnKTtcclxuICAgICAgICBkZWxldGVCdXR0b24ucmVtb3ZlQXR0cmlidXRlKCdkaXNhYmxlZCcpO1xyXG5cclxuICAgICAgICB1dGlscy5hZGRDbGFzcyhlZGl0QnV0dG9uLCAnbWRsLWJ1dHRvbi0tYWNjZW50Jyk7XHJcbiAgICAgICAgdXRpbHMuYWRkQ2xhc3MoZGVsZXRlQnV0dG9uLCAnbWRsLWJ1dHRvbi0tYWNjZW50Jyk7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5mb0JveENvbnRlbnQuaW5uZXJIVE1MID0gJyc7XHJcbiAgICAgIHV0aWxzLmFkZENsYXNzKGluZm9Cb3hDb250ZW50LCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgZWRpdEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcblxyXG4gICAgICBkZWxldGVCdXR0b24uc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsIHRydWUpO1xyXG5cclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLmdldFNvdXJjZSgpLmdldEZlYXR1cmVzKClcclxuICAgICAgLmZvckVhY2goZnVuY3Rpb24gcmVzZXRTdHlsZShmZWF0dXJlKSB7XHJcbiAgICAgICAgZmVhdHVyZS5zZXRTdHlsZShudWxsKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBpbml0KCkge1xyXG4gICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JykuZGF0YXNldC5hY3RpdmUgPSAnaW5mbyc7XHJcbiAgICBtYXAub24oJ2NsaWNrJywgc2VsZWN0RmVhdHVyZSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGRpc2FibGUoKSB7XHJcbiAgICB2YXIgbWFwID0gQXBwLmNvbmZpZy5jb21tb25zLm1hcDtcclxuICAgIG1hcC51bignY2xpY2snLCBzZWxlY3RGZWF0dXJlKTtcclxuICB9XHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXQ6IGluaXQsXHJcbiAgICBkaXNhYmxlOiBkaXNhYmxlXHJcbiAgfTtcclxufSh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCBqUXVlcnksIEFwcCkpO1xyXG4iLCJBcHAuY29uZmlnLm1vZHVsZXMuZWRpdCA9IChmdW5jdGlvbiBlZGl0KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsICQsIGRQaWNrLCBtb21lbnQpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGNvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjYXBwd3JhcHBlcl9faW5mb2JveC1jb250ZW50Jyk7XHJcbiAgdmFyIGxhbmcgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZztcclxuICB2YXIgaW5mbyA9IEFwcC5jb25maWcubW9kdWxlcy5pbmZvO1xyXG4gIHZhciB1dGlscyA9IEFwcC51dGlscztcclxuICB2YXIgZWRpdEJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNlZGl0Jyk7XHJcbiAgdmFyIGRlbGV0ZUJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNkZWxldGUnKTtcclxuICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTtcclxuICBmdW5jdGlvbiBjbGVhckNvbnRlbnQoKSB7XHJcbiAgICBpZiAoY29udGVudC5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gJyc7XHJcbiAgICB9XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGdldEludGVyYWN0aW9uKGlkKSB7XHJcbiAgICB2YXIgbWFwID0gQXBwLmNvbmZpZy5jb21tb25zLm1hcDtcclxuICAgIHZhciBpbnRlcmFjdGlvbnMgPSBtYXAuZ2V0SW50ZXJhY3Rpb25zKCk7XHJcbiAgICB2YXIgZm91bmQgPSB7fTtcclxuICAgIGludGVyYWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIGdldEludGVyYWN0aW9uSWQoaW50ZXJhY3Rpb24pIHtcclxuICAgICAgaWYgKGludGVyYWN0aW9uLmdldCgnaWQnKSA9PT0gaWQpIHtcclxuICAgICAgICBmb3VuZCA9IGludGVyYWN0aW9uO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGZvdW5kO1xyXG4gIH1cclxuICBmdW5jdGlvbiBhc3NpZ25WYWxpZGF0b3JzKCkge1xyXG4gICAgdmFyIGlucHV0cyA9IGNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbdHlwZT10ZXh0XScpO1xyXG4gICAgW10uZm9yRWFjaC5jYWxsKGlucHV0cywgZnVuY3Rpb24gbWFrZVBhcnNsZXlJbnB1dHMoZWwpIHtcclxuICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsIGZ1bmN0aW9uIHNhbml0aXplKCkge1xyXG4gICAgICAgIHZhciBzdHIgPSB0aGlzLnZhbHVlO1xyXG4gICAgICAgIHZhciBzYW5pdGl6ZWRTdHI7XHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YXNldC50eXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgc2FuaXRpemVkU3RyID0gc3RyLnJlcGxhY2UoL1svXFxELyBdL2dpLCAnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRhdGFzZXQudHlwZSA9PT0gJ2FscGhhbnVtJykge1xyXG4gICAgICAgICAgc2FuaXRpemVkU3RyID0gc3RyLnJlcGxhY2UoL1teYS16MC05QS1aQS16zpEtzqnOsS3Pic6vz4rOkM+MzqzOrc+Nz4vOsM6uz44gXS9naSwgJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhc2V0LnR5cGUgPT09ICdzcGVjaWFsJykge1xyXG4gICAgICAgICAgc2FuaXRpemVkU3RyID0gc3RyLnJlcGxhY2UoL1teMC05IFxcL10vZ2ksICcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YXNldC50eXBlID09PSAnZGF0ZScpIHtcclxuICAgICAgICAgIHNhbml0aXplZFN0ciA9IHN0ci5yZXBsYWNlKC9bXjAtOSBcXC1dL2dpLCAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudmFsdWUgPSBzYW5pdGl6ZWRTdHI7XHJcbiAgICAgICAgdXRpbHMucmVtb3ZlQ2xhc3ModGhpcy5wYXJlbnROb2RlLCAnaXMtaW52YWxpZCcpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gc2V0RXN0YXRlVHlwZSh0eXBlKSB7XHJcbiAgICB2YXIgdHlwZXM7XHJcbiAgICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICB0eXBlcyA9IHtcclxuICAgICAgICDOlM65zrHOvM6tz4HOuc+DzrzOsTogZnVuY3Rpb24gZ2V0QXBhcnRtZW50KCkge1xyXG4gICAgICAgICAgcmV0dXJuICdBcGFydG1lbnQnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgzpzOv869zr/Ous6xz4TOv865zrrOr86xOiBmdW5jdGlvbiBnZXREZXRhY2hlZEhvdXNlKCkge1xyXG4gICAgICAgICAgcmV0dXJuICdEZXRhY2hlZCBIb3VzZSc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICDOnM61zrbOv869zq3PhM6xOiBmdW5jdGlvbiBnZXRNYWlzb25ldHRlKCkge1xyXG4gICAgICAgICAgcmV0dXJuICdNYWlzb25ldHRlJztcclxuICAgICAgICB9LFxyXG4gICAgICAgIM6Iz4DOsc+FzrvOtzogZnVuY3Rpb24gZ2V0VmlsbGEoKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ1ZpbGxhJztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0eXBlcyA9IHtcclxuICAgICAgICBBcGFydG1lbnQ6IGZ1bmN0aW9uIGdldEFwYXJ0bWVudCgpIHtcclxuICAgICAgICAgIHJldHVybiAnzpTOuc6xzrzOrc+BzrnPg868zrEnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgJ0RldGFjaGVkIEhvdXNlJzogZnVuY3Rpb24gZ2V0RGV0YWNoZWRIb3VzZSgpIHtcclxuICAgICAgICAgIHJldHVybiAnzpzOv869zr/Ous6xz4TOv865zrrOr86xJztcclxuICAgICAgICB9LFxyXG4gICAgICAgIE1haXNvbmV0dGU6IGZ1bmN0aW9uIGdldE1haXNvbmV0dGUoKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ86czrXOts6/zr3Orc+EzrEnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgVmlsbGE6IGZ1bmN0aW9uIGdldFZpbGxhKCkge1xyXG4gICAgICAgICAgcmV0dXJuICfOiM+AzrHPhc67zrcnO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIHJldHVybiB0eXBlc1t0eXBlXSgpO1xyXG4gIH1cclxuICBmdW5jdGlvbiBjb2xsZWN0VmFsdWVzKCkge1xyXG4gICAgdmFyIHZhbHVlcyA9IHt9O1xyXG4gICAgdmFyIGZpbHRlcmVkVmFsdWVzID0ge307XHJcbiAgICB2YXIgaW5wdXRzID0gY29udGVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFt0eXBlPXRleHRdJyk7XHJcbiAgICB2YXIgY2hlY2tib3hlcyA9IGNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbdHlwZT1jaGVja2JveF0nKTtcclxuICAgIHZhbHVlcy5lc3RhdGUgPSB7fTtcclxuICAgIHZhbHVlcy5saXN0aW5nID0ge307XHJcblxyXG4gICAgW10uZm9yRWFjaC5jYWxsKGlucHV0cywgZnVuY3Rpb24gY29sbGVjdEZyb21JbnB1dHMoZWwpIHtcclxuICAgICAgdmFyIG5hbWUgPSBfLmxhc3QoXy5zcGxpdChlbC5nZXRBdHRyaWJ1dGUoJ2lkJyksICctJywgMykpO1xyXG4gICAgICB2YXIgdmFsdWUgPSBlbC52YWx1ZTtcclxuICAgICAgdmFyIG5ld1ggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZXN0YXRlJykuZGF0YXNldC5uZXd4O1xyXG4gICAgICB2YXIgbmV3WSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNlc3RhdGUnKS5kYXRhc2V0Lm5ld3k7XHJcbiAgICAgIHZhciBvcmlnaW5hbFggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZXN0YXRlJykuZGF0YXNldC5vcmlnaW5hbHg7XHJcbiAgICAgIHZhciBvcmlnaW5hbFkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZXN0YXRlJykuZGF0YXNldC5vcmlnaW5hbHk7XHJcblxyXG4gICAgICBpZiAoZWwuZ2V0QXR0cmlidXRlKCdpZCcpLmluZGV4T2YoJ2VzdGF0ZScpID4gLTEpIHtcclxuICAgICAgICBpZiAodHlwZW9mIG5ld1ggIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICB2YWx1ZXMuZXN0YXRlLnggPSBuZXdYO1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS55ID0gbmV3WTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS54ID0gb3JpZ2luYWxYO1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS55ID0gb3JpZ2luYWxZO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICAgICAgaWYgKG5hbWUgPT09ICd0eXBlJykge1xyXG4gICAgICAgICAgICB2YWx1ZXMuZXN0YXRlLmVzdGF0ZXR5cGVFbiA9IHNldEVzdGF0ZVR5cGUodmFsdWUpO1xyXG4gICAgICAgICAgICB2YWx1ZXMuZXN0YXRlLmVzdGF0ZXR5cGUgPSB2YWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChuYW1lID09PSAnYWRkcmVzcycpIHtcclxuICAgICAgICAgICAgdmFsdWVzLmVzdGF0ZS5zdHJlZXRFbiA9IHV0aWxzLmVsVG9Fbih2YWx1ZSk7XHJcbiAgICAgICAgICAgIHZhbHVlcy5lc3RhdGUuc3RyZWV0RWwgPSB2YWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKG5hbWUgPT09ICd0eXBlJykge1xyXG4gICAgICAgICAgICB2YWx1ZXMuZXN0YXRlLmVzdGF0ZXR5cGVFbiA9IHZhbHVlO1xyXG4gICAgICAgICAgICB2YWx1ZXMuZXN0YXRlLmVzdGF0ZXR5cGUgPSBzZXRFc3RhdGVUeXBlKHZhbHVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChuYW1lID09PSAnYWRkcmVzcycpIHtcclxuICAgICAgICAgICAgdmFsdWVzLmVzdGF0ZS5zdHJlZXRFbiA9IHZhbHVlO1xyXG4gICAgICAgICAgICB2YWx1ZXMuZXN0YXRlLnN0cmVldEVsID0gdXRpbHMuZWxUb0VuKHZhbHVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5hbWUgPT09ICdhZGRyZXNzTnVtYmVyJykge1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS5zdHJlZXROdW1iZXIgPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFsdWVzLmVzdGF0ZVtuYW1lXSA9IHZhbHVlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChuYW1lID09PSAndHlwZScpIHtcclxuICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJ1NhbGUnIHx8IHZhbHVlID09PSAnzqDPjs67zrfPg863Jykge1xyXG4gICAgICAgICAgICB2YWx1ZXMubGlzdGluZy5zYWxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgdmFsdWVzLmxpc3RpbmcucmVudCA9IGZhbHNlO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFsdWVzLmxpc3Rpbmcuc2FsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB2YWx1ZXMubGlzdGluZy5yZW50ID0gdHJ1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsdWVzLmxpc3RpbmdbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgW10uZm9yRWFjaC5jYWxsKGNoZWNrYm94ZXMsIGZ1bmN0aW9uIGNvbGxlY3RGcm9tQ2hlY2tib3hlcyhlbCkge1xyXG4gICAgICB2YXIgbmFtZSA9IF8ubGFzdChfLnNwbGl0KGVsLmdldEF0dHJpYnV0ZSgnaWQnKSwgJy0nLCAzKSk7XHJcbiAgICAgIHZhciB2YWx1ZSA9IGVsLmNoZWNrZWQ7XHJcbiAgICAgIGlmIChuYW1lICE9PSAncGV0cycpIHtcclxuICAgICAgICB2YWx1ZXMuZXN0YXRlW25hbWVdID0gdmFsdWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFsdWVzLmxpc3RpbmdbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBmaWx0ZXJlZFZhbHVlcy5lc3RhdGUgPSBfLm9taXQodmFsdWVzLmVzdGF0ZSwgWydhZGRyZXNzJywgJ2FkZHJlc3NOdW1iZXInLCAndHlwZScsICd0b2dnbGUnXSk7XHJcbiAgICBmaWx0ZXJlZFZhbHVlcy5saXN0aW5nID0gdmFsdWVzLmxpc3Rpbmc7XHJcbiAgICByZXR1cm4gZmlsdGVyZWRWYWx1ZXM7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHVwZGF0ZShkYXRhKSB7XHJcbiAgICB2YXIgc25hY2tiYXJDb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjYXBwd3JhcHBlcl9fc25hY2tiYXInKTtcclxuICAgIHZhciBtc2dEYXRhID0ge307XHJcbiAgICBmdW5jdGlvbiBhZGRHaWRUb0xpc3RpbmcoaW5wdXQsIGdpZCkge1xyXG4gICAgICB2YXIgcmV0dXJuZWREYXRhID0gaW5wdXQ7XHJcbiAgICAgIHJldHVybmVkRGF0YS5naWQgPSBnaWQ7XHJcbiAgICAgIHJldHVybiByZXR1cm5lZERhdGE7XHJcbiAgICB9XHJcbiAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICQuYWpheCh7XHJcbiAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9wcm9wZXJ0eScsXHJcbiAgICAgICAgdHlwZTogJ1BVVCcsXHJcbiAgICAgICAgZGF0YTogZGF0YS5lc3RhdGVcclxuICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShlc3RhdGVSZXN1bHQpIHtcclxuICAgICAgbXNnRGF0YS5lc3RhdGVJZCA9IGVzdGF0ZVJlc3VsdC5wcm9wZXJ0eUdpZDtcclxuICAgICAgaWYgKCFfLmlzRW1wdHkoZGF0YS5saXN0aW5nKSkge1xyXG4gICAgICAgIHJldHVybiAkLmFqYXgoe1xyXG4gICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9saXN0aW5nJyxcclxuICAgICAgICAgIHR5cGU6ICdQVVQnLFxyXG4gICAgICAgICAgZGF0YTogYWRkR2lkVG9MaXN0aW5nKGRhdGEubGlzdGluZywgZXN0YXRlUmVzdWx0LnByb3BlcnR5R2lkKVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfSlcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUobGlzdGluZ1Jlc3VsdCkge1xyXG4gICAgICB2YXIgbXNnO1xyXG4gICAgICAvLyBjb25zb2xlLmxvZyhyZXN1bHQpXHJcbiAgICAgIGlmIChsaXN0aW5nUmVzdWx0ID09PSBudWxsKSB7XHJcbiAgICAgICAgbXNnID0geyBtZXNzYWdlOiAnVXBkYXRlZCBFc3RhdGU6ICcgKyBtc2dEYXRhLmVzdGF0ZUlkIH07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbXNnID0geyBtZXNzYWdlOiAnVXBkYXRlZCBFc3RhdGVJRDogJyArIG1zZ0RhdGEuZXN0YXRlSWQgKyAnIGFuZCBMaXN0aW5nSUQ6ICcgKyBsaXN0aW5nUmVzdWx0Lmxpc3RpbmdJZCB9O1xyXG4gICAgICB9XHJcbiAgICAgIHNuYWNrYmFyQ29udGFpbmVyLk1hdGVyaWFsU25hY2tiYXIuc2hvd1NuYWNrYmFyKG1zZyk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgdmFyIG1zZyA9IHsgbWVzc2FnZTogZSB9O1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgICAgc25hY2tiYXJDb250YWluZXIuTWF0ZXJpYWxTbmFja2Jhci5zaG93U25hY2tiYXIobXNnKTtcclxuICAgIH0pXHJcbiAgICAuZmluYWxseShmdW5jdGlvbiBjbG9zZVVwZGF0ZSgpIHtcclxuICAgICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICAgIGNsZWFyQ29udGVudCgpO1xyXG4gICAgICB1dGlscy5hZGRDbGFzcyhjb250ZW50LCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLmdldFNvdXJjZSgpLmdldEZlYXR1cmVzKClcclxuICAgICAgLmZvckVhY2goZnVuY3Rpb24gcmVzZXRTdHlsZShmZWF0dXJlKSB7XHJcbiAgICAgICAgZmVhdHVyZS5zZXRTdHlsZShudWxsKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGVkaXRCdXR0b24uc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICBkZWxldGVCdXR0b24uc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICBpbmZvLmluaXQoKTtcclxuICAgICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9ICdpbmZvJztcclxuICAgICAgZ2V0SW50ZXJhY3Rpb24oJ3RyYW5zbGF0ZScpLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZGF0ZVBpY2tlcigpIHtcclxuICAgIHZhciBmb3JtYXQgPSAobGFuZyA9PT0gJ2VsJykgPyAnREQtTU0tWVlZWScgOiAnTU0tREQtWVlZWSc7XHJcbiAgICB2YXIgZGF0ZVN0YXJ0UGlja2VyO1xyXG4gICAgdmFyIGRhdGVFbmRQaWNrZXI7XHJcbiAgICB2YXIgZGF0ZVN0YXJ0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2luZm9ib3hfX2RhdGUtc3RhcnQnKTtcclxuICAgIHZhciBkYXRlRW5kQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2luZm9ib3hfX2RhdGUtZW5kJyk7XHJcbiAgICB2YXIgZGF0ZVN0YXJ0SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGlzdGluZ19fZ2VuZXJhbC1kYXRlU3RhcnQnKTtcclxuICAgIHZhciBkYXRlRW5kSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGlzdGluZ19fZ2VuZXJhbC1kYXRlRW5kJyk7XHJcbiAgICB2YXIgZGF0ZVN0YXJ0UGlja2VySW5pdDtcclxuICAgIHZhciBkYXRlRW5kUGlja2VySW5pdDtcclxuICAgIHZhciBvYnNlcnZlRGF0ZVBpY2tlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZ1bmN0aW9uIG9ic2VydmVEYXRlUGlja2VyKG11dGF0aW9ucykge1xyXG4gICAgICB2YXIgYXR0cmlidXRlVmFsdWU7XHJcbiAgICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIGZvZXJFYWNoTXV0YXRpb24obXV0YXRpb24pIHtcclxuICAgICAgICBpZiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSA9PT0gJ2NsYXNzJykge1xyXG4gICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAkKG11dGF0aW9uLnRhcmdldCkucHJvcChtdXRhdGlvbi5hdHRyaWJ1dGVOYW1lKTtcclxuICAgICAgICAgIGlmIChhdHRyaWJ1dGVWYWx1ZS5pbmRleE9mKCdtZGR0cC1waWNrZXItLWluYWN0aXZlJykgPiAtMSkge1xyXG4gICAgICAgICAgICB1dGlscy5yZW1vdmVDbGFzcyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwd3JhcHBlcl9faW5mb2JveCcpLCAndW5jbGlja2FibGUnKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHV0aWxzLmFkZENsYXNzKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHB3cmFwcGVyX19pbmZvYm94JyksICd1bmNsaWNrYWJsZScpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIGlmIChkYXRlU3RhcnRJbnB1dCAhPT0gbnVsbCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhkYXRlU3RhcnRJbnB1dC52YWx1ZSk7XHJcbiAgICAgIGlmIChkYXRlU3RhcnRJbnB1dC52YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICBkYXRlU3RhcnRQaWNrZXJJbml0ID0gbW9tZW50KGRhdGVTdGFydElucHV0LnZhbHVlLCBmb3JtYXQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRhdGVTdGFydFBpY2tlckluaXQgPSBtb21lbnQoKTtcclxuICAgICAgfVxyXG4gICAgICBkYXRlU3RhcnRQaWNrZXIgPSBuZXcgZFBpY2suZGVmYXVsdCh7XHJcbiAgICAgICAgdHlwZTogJ2RhdGUnLFxyXG4gICAgICAgIGluaXQ6IGRhdGVTdGFydFBpY2tlckluaXQsXHJcbiAgICAgICAgZnV0dXJlOiBtb21lbnQoKS5hZGQoNSwgJ3llYXJzJyksXHJcbiAgICAgICAgdHJpZ2dlcjogZGF0ZVN0YXJ0SW5wdXQsXHJcbiAgICAgICAgb3JpZW50YXRpb246ICdQT1JUUkFJVCdcclxuICAgICAgfSk7XHJcbiAgICAgIG9ic2VydmVEYXRlUGlja2VyLm9ic2VydmUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21kZHRwLXBpY2tlcl9fZGF0ZScpLCB7XHJcbiAgICAgICAgYXR0cmlidXRlczogdHJ1ZVxyXG4gICAgICB9KTtcclxuICAgICAgZGF0ZVN0YXJ0SW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignb25PaycsIGZ1bmN0aW9uIGRpc3BsYXlQaWNrZWRhdGUoKSB7XHJcbiAgICAgICAgdXRpbHMuYWRkQ2xhc3ModGhpcy5wYXJlbnROb2RlLCAnaXMtZGlydHknKTtcclxuICAgICAgICB0aGlzLnZhbHVlID0gZGF0ZVN0YXJ0UGlja2VyLnRpbWUuZm9ybWF0KGZvcm1hdCkudG9TdHJpbmcoKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGRhdGVTdGFydEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uIHNob3dEYXRlUGlja2VyKCkge1xyXG4gICAgICAgIGRhdGVTdGFydFBpY2tlci50b2dnbGUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoZGF0ZUVuZElucHV0ICE9PSBudWxsKSB7XHJcbiAgICAgIGlmIChkYXRlRW5kSW5wdXQudmFsdWUgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgZGF0ZUVuZFBpY2tlckluaXQgPSBtb21lbnQoZGF0ZVN0YXJ0SW5wdXQudmFsdWUsIGZvcm1hdCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZGF0ZUVuZFBpY2tlckluaXQgPSBtb21lbnQoKTtcclxuICAgICAgfVxyXG4gICAgICBkYXRlRW5kSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignb25PaycsIGZ1bmN0aW9uIGRpc3BsYXlQaWNrZWRhdGUoKSB7XHJcbiAgICAgICAgdXRpbHMuYWRkQ2xhc3ModGhpcy5wYXJlbnROb2RlLCAnaXMtZGlydHknKTtcclxuICAgICAgICB0aGlzLnZhbHVlID0gZGF0ZUVuZFBpY2tlci50aW1lLmZvcm1hdChmb3JtYXQpLnRvU3RyaW5nKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBkYXRlRW5kUGlja2VyID0gbmV3IGRQaWNrLmRlZmF1bHQoe1xyXG4gICAgICAgIHR5cGU6ICdkYXRlJyxcclxuICAgICAgICBpbml0OiBkYXRlRW5kUGlja2VySW5pdCxcclxuICAgICAgICBmdXR1cmU6IG1vbWVudCgpLmFkZCg1LCAneWVhcnMnKSxcclxuICAgICAgICB0cmlnZ2VyOiBkYXRlRW5kSW5wdXQsXHJcbiAgICAgICAgb3JpZW50YXRpb246ICdQT1JUUkFJVCdcclxuICAgICAgfSk7XHJcbiAgICAgIG9ic2VydmVEYXRlUGlja2VyLm9ic2VydmUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21kZHRwLXBpY2tlcl9fZGF0ZScpLCB7XHJcbiAgICAgICAgYXR0cmlidXRlczogdHJ1ZVxyXG4gICAgICB9KTtcclxuICAgICAgZGF0ZUVuZEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uIHNob3dEYXRlUGlja2VyKCkge1xyXG4gICAgICAgIGRhdGVFbmRQaWNrZXIudG9nZ2xlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBmdW5jdGlvbiBlbmFibGVFZGl0KCkge1xyXG4gICAgdmFyIG9ic2VydmVMaXN0aW5nSW5wdXQgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbiBvYnNlcnZlTGlzdGluZ0lucHV0KG11dGF0aW9ucykge1xyXG4gICAgICB2YXIgYXR0cmlidXRlVmFsdWU7XHJcbiAgICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIGZvZXJFYWNoTXV0YXRpb24obXV0YXRpb24pIHtcclxuICAgICAgICBpZiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSA9PT0gJ2RhdGEtdmFsJykge1xyXG4gICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSBtdXRhdGlvbi50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICBpZiAoYXR0cmlidXRlVmFsdWUgPT09ICdSZW50JyB8fCBhdHRyaWJ1dGVWYWx1ZSA9PT0gJ86Vzr3Ov865zrrOr86xz4POtycpIHtcclxuICAgICAgICAgICAgdXRpbHMucmVtb3ZlQ2xhc3MoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2xpc3RpbmdfX2dlbmVyYWwtcGV0cy13cmFwcGVyJyksICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdXRpbHMuYWRkQ2xhc3MoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2xpc3RpbmdfX2dlbmVyYWwtcGV0cy13cmFwcGVyJyksICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgdmFyIGlucHV0cyA9IGNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQnKTtcclxuICAgIHZhciBsYWJlbHMgPSBjb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2xhYmVsJyk7XHJcbiAgICB2YXIgYnV0dG9ucyA9IGNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnYnV0dG9uJyk7XHJcbiAgICB2YXIgZWRpdENsb3NlQnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmNsb3NlJyk7XHJcbiAgICB2YXIgZWRpdEFncmVlQnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmFncmVlJyk7XHJcbiAgICB2YXIgbG9jYXRpb25Td2l0Y2ggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZXN0YXRlX2xvY2F0aW9uLXRvZ2dsZScpO1xyXG4gICAgdmFyIGdpZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNlc3RhdGVfX2luZm8tZ2lkJykudmFsdWU7XHJcbiAgICB2YXIgdHJhbnNsYXRlID0gbmV3IG9sLmludGVyYWN0aW9uLlRyYW5zbGF0ZSh7XHJcbiAgICAgIGZlYXR1cmVzOiBuZXcgb2wuQ29sbGVjdGlvbihbdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLmdldFNvdXJjZSgpLmdldEZlYXR1cmVCeUlkKGdpZCldKSxcclxuICAgICAgbGF5ZXJzOiBbdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpXVxyXG4gICAgfSk7XHJcblxyXG4gICAgYXNzaWduVmFsaWRhdG9ycygpO1xyXG4gICAgdHJhbnNsYXRlLnNldCgnaWQnLCAndHJhbnNsYXRlJyk7XHJcbiAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpc3RpbmdfX2lkQW5kVHlwZS10eXBlJykgIT09IG51bGwpIHtcclxuICAgICAgb2JzZXJ2ZUxpc3RpbmdJbnB1dC5vYnNlcnZlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaXN0aW5nX19pZEFuZFR5cGUtdHlwZScpLCB7XHJcbiAgICAgICAgYXR0cmlidXRlczogdHJ1ZSxcclxuICAgICAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdHJhbnNsYXRlLm9uKCd0cmFuc2xhdGVlbmQnLCBmdW5jdGlvbiBzZXRUcmFuc2xhdGVkQ29vcmRpbmF0ZXMoZSkge1xyXG4gICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNlc3RhdGUnKTtcclxuICAgICAgZWxlbWVudC5kYXRhc2V0Lm5ld3ggPSBlLmNvb3JkaW5hdGVbMF07XHJcbiAgICAgIGVsZW1lbnQuZGF0YXNldC5uZXd5ID0gZS5jb29yZGluYXRlWzFdO1xyXG4gICAgICBsb2NhdGlvblN3aXRjaC5jaGVja2VkID0gZmFsc2U7XHJcbiAgICAgIHV0aWxzLnJlbW92ZUNsYXNzKGxvY2F0aW9uU3dpdGNoLnBhcmVudE5vZGUsICdpcy1jaGVja2VkJyk7XHJcbiAgICAgIC8vIEFwcC5jb25maWcubW9kdWxlcy5pbmZvLmluaXQoKTtcclxuICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICB9KTtcclxuICAgIG1hcC5hZGRJbnRlcmFjdGlvbih0cmFuc2xhdGUpO1xyXG4gICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcblxyXG4gICAgbG9jYXRpb25Td2l0Y2guYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiB3YXRjaExvY2F0aW9uU3dpdGNoKCkge1xyXG4gICAgICBpZiAodGhpcy5jaGVja2VkKSB7XHJcbiAgICAgICAgLy8gQXBwLmNvbmZpZy5tb2R1bGVzLmluZm8uZGlzYWJsZSgpO1xyXG4gICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gQXBwLmNvbmZpZy5tb2R1bGVzLmluZm8uaW5pdCgpO1xyXG4gICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnbGlzdGluZycpLCBmdW5jdGlvbiByZW1vdmVEaXNhYmxlZExpc3RpbmcoZWwpIHtcclxuICAgICAgdXRpbHMucmVtb3ZlQ2xhc3MoZWwsICdsaXN0aW5nLWRpc2FibGVkJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoaW5wdXRzLCBmdW5jdGlvbiByZW1vdmVEaXNhYmxlZElucHV0cyhlbCkge1xyXG4gICAgICBpZiAoIXV0aWxzLmhhc0NsYXNzKGVsLCAnbm90LWVkZGl0YWJsZScpKSB7XHJcbiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdkaXNhYmxlZCcpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBbXS5mb3JFYWNoLmNhbGwobGFiZWxzLCBmdW5jdGlvbiByZW1vdmVEaXNhYmxlZExhYmVscyhlbCkge1xyXG4gICAgICB1dGlscy5yZW1vdmVDbGFzcyhlbCwgJ2lzLWRpc2FibGVkJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoYnV0dG9ucywgZnVuY3Rpb24gcmVtb3ZlRGlzYWJsZWRMYWJlbHMoZWwpIHtcclxuICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdkaXNhYmxlZCcpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdXRpbHMucmVtb3ZlQ2xhc3MoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NvbmZpcm1CdG5zJyksICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgZWRpdENsb3NlQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gY2FuY2VsRWRpdCgpIHtcclxuICAgICAgY2xlYXJDb250ZW50KCk7XHJcbiAgICAgIHV0aWxzLmFkZENsYXNzKGNvbnRlbnQsICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdlc3RhdGVzJykuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZXMoKVxyXG4gICAgICAuZm9yRWFjaChmdW5jdGlvbiByZXNldFN0eWxlKGZlYXR1cmUpIHtcclxuICAgICAgICBmZWF0dXJlLnNldFN0eWxlKG51bGwpO1xyXG4gICAgICB9KTtcclxuICAgICAgZWRpdEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgIGRlbGV0ZUJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgIGluZm8uaW5pdCgpO1xyXG4gICAgICBib2R5LmRhdGFzZXQuYWN0aXZlID0gJ2luZm8nO1xyXG4gICAgICBnZXRJbnRlcmFjdGlvbigndHJhbnNsYXRlJykuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gICAgZWRpdEFncmVlQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gdXBkYXRlRWRpdCgpIHtcclxuICAgICAgLy8gc2FuaXRpemUoKTtcclxuICAgICAgdmFyIGRhdGEgPSBjb2xsZWN0VmFsdWVzKCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICB1cGRhdGUoZGF0YSk7XHJcbiAgICB9KTtcclxuICAgIGRhdGVQaWNrZXIoKTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGluaXQoKSB7XHJcbiAgICBpbmZvLmRpc2FibGUoKTtcclxuICAgIGVuYWJsZUVkaXQoKTtcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBpbml0OiBpbml0XHJcbiAgfTtcclxufSh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCBtZERhdGVUaW1lUGlja2VyLCBtb21lbnQsIEFwcCkpO1xyXG4iLCJBcHAuY29uZmlnLm1vZHVsZXMuZGVsZXRlID0gKGZ1bmN0aW9uIGVkaXQod2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgJCwgQXBwLCBkaWFsb2dQb2x5ZmlsbCkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgdXRpbHMgPSBBcHAudXRpbHM7XHJcbiAgdmFyIGR1c3RCbHVlYmlyZCA9IEFwcC5jb25maWcucHJvbWlzZXMuZHVzdEJsdWViaXJkO1xyXG4gIHZhciBkZWxldGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVsZXRlJyk7XHJcbiAgdmFyIGVkaXRCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZWRpdCcpO1xyXG4gIHZhciBkaWFsb2cgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaWFsb2cnKTtcclxuICB2YXIgc25hY2tiYXJDb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjYXBwd3JhcHBlcl9fc25hY2tiYXInKTtcclxuICB2YXIgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHB3cmFwcGVyX19pbmZvYm94LWNvbnRlbnQnKTtcclxuICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTtcclxuICB2YXIgaW5mbyA9IEFwcC5jb25maWcubW9kdWxlcy5pbmZvO1xyXG4gIGZ1bmN0aW9uIGNsZWFyQ29udGVudCgpIHtcclxuICAgIGlmIChjb250ZW50LmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29udGVudC5pbm5lckhUTUwgPSAnJztcclxuICAgIH1cclxuICB9XHJcbiAgZnVuY3Rpb24gdXBkYXRlRXN0YXRlcygpIHtcclxuICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgdXRpbHMuZmluZEJ5SWQobWFwLCAnZXN0YXRlcycpLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGRlbGV0ZUxpc3RpbmcoZGF0YSkge1xyXG4gICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9hcGkvbGlzdGluZycsXHJcbiAgICAgICAgdHlwZTogJ0RFTEVURScsXHJcbiAgICAgICAgZGF0YTogeyBpZDogZGF0YSB9XHJcbiAgICAgIH0pXHJcbiAgICAgIClcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGVsZXRlTGlzdGluZ3Jlc3VsdCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhkZWxldGVMaXN0aW5ncmVzdWx0KTtcclxuICAgICAgY29udGVudC5xdWVyeVNlbGVjdG9yKCcjbGlzdGluZycpLmlubmVySFRNTCA9ICcnO1xyXG4gICAgICBjb250ZW50LnF1ZXJ5U2VsZWN0b3IoJyNsaXN0aW5nJykucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChjb250ZW50LnF1ZXJ5U2VsZWN0b3IoJyNsaXN0aW5nJykpO1xyXG4gICAgfSlcclxuICAgIC5maW5hbGx5KGZ1bmN0aW9uIGVuYWJsZUluZm8oKSB7XHJcbiAgICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgICBjbGVhckNvbnRlbnQoKTtcclxuICAgICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9ICdpbmZvJztcclxuICAgICAgZWRpdEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgIGRlbGV0ZUJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgIGluZm8uaW5pdCgpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdlc3RhdGVzJykuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZXMoKVxyXG4gICAgICAuZm9yRWFjaChmdW5jdGlvbiByZXNldFN0eWxlKGZlYXR1cmUpIHtcclxuICAgICAgICBmZWF0dXJlLnNldFN0eWxlKG51bGwpO1xyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICB2YXIgbXNnID0geyBtZXNzYWdlOiBlIH07XHJcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICBzbmFja2JhckNvbnRhaW5lci5NYXRlcmlhbFNuYWNrYmFyLnNob3dTbmFja2Jhcihtc2cpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGRlbGV0ZUVzdGF0ZUFuZExpc3RpbmcoZGF0YSkge1xyXG4gICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9hcGkvcHJvcGVydHknLFxyXG4gICAgICAgIHR5cGU6ICdERUxFVEUnLFxyXG4gICAgICAgIGRhdGE6IHsgZ2lkOiBkYXRhIH1cclxuICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZSgpIHtcclxuICAgICAgdXBkYXRlRXN0YXRlcygpO1xyXG4gICAgfSlcclxuICAgIC5maW5hbGx5KGZ1bmN0aW9uIGVuYWJsZUluZm8oKSB7XHJcbiAgICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgICBjbGVhckNvbnRlbnQoKTtcclxuICAgICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9ICdpbmZvJztcclxuICAgICAgaW5mby5pbml0KCk7XHJcbiAgICAgIGVkaXRCdXR0b24uc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICBkZWxldGVCdXR0b24uc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICB1dGlscy5maW5kQnlJZChtYXAsICdlc3RhdGVzJykuZ2V0U291cmNlKCkuZ2V0RmVhdHVyZXMoKVxyXG4gICAgICAuZm9yRWFjaChmdW5jdGlvbiByZXNldFN0eWxlKGZlYXR1cmUpIHtcclxuICAgICAgICBmZWF0dXJlLnNldFN0eWxlKG51bGwpO1xyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICB2YXIgbXNnID0geyBtZXNzYWdlOiBlIH07XHJcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICBzbmFja2JhckNvbnRhaW5lci5NYXRlcmlhbFNuYWNrYmFyLnNob3dTbmFja2Jhcihtc2cpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHdoYXRUb0RlbGV0ZSgpIHtcclxuICAgIHZhciBjaGVja2JveGVzID0gZGlhbG9nLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W25hbWU9b3B0aW9uc10nKTtcclxuICAgIHZhciB2YWx1ZXMgPSB7fTtcclxuICAgIGlmIChjaGVja2JveGVzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICBbXS5mb3JFYWNoLmNhbGwoY2hlY2tib3hlcywgZnVuY3Rpb24gZ2V0VmFsdWVzKGVsKSB7XHJcbiAgICAgICAgdmFyIGtleSA9IF8ubGFzdChfLnNwbGl0KGVsLmdldEF0dHJpYnV0ZSgnaWQnKSwgJy0nLCAzKSk7XHJcbiAgICAgICAgdmFsdWVzW2tleV0gPSBlbC5jaGVja2VkO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZXM7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGNhbmNlbERlbGV0ZSgpIHtcclxuICAgIGRpYWxvZy5jbG9zZSgpO1xyXG4gIH1cclxuICBmdW5jdGlvbiBjb25maXJtRGVsZXRlKCkge1xyXG4gICAgdmFyIGRhdGE7XHJcbiAgICB2YXIgY2hvb3NlciA9IHdoYXRUb0RlbGV0ZSgpO1xyXG4gICAgaWYgKF8uaXNFbXB0eShjaG9vc2VyKSkge1xyXG4gICAgICBkYXRhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VzdGF0ZV9faW5mby1naWQnKS52YWx1ZTtcclxuICAgICAgZGVsZXRlRXN0YXRlQW5kTGlzdGluZyhkYXRhKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChjaG9vc2VyLmxpc3RpbmcgPT09IHRydWUpIHtcclxuICAgICAgICBkYXRhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpc3RpbmdfX2lkQW5kVHlwZS1pZCcpLnZhbHVlO1xyXG4gICAgICAgIGRlbGV0ZUxpc3RpbmcoZGF0YSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGNob29zZXIuZXN0YXRlID09PSB0cnVlKSB7XHJcbiAgICAgICAgZGF0YSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlc3RhdGVfX2luZm8tZ2lkJykudmFsdWU7XHJcbiAgICAgICAgZGVsZXRlRXN0YXRlQW5kTGlzdGluZyhkYXRhKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgZGlhbG9nLmNsb3NlKCk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIHNob3coKSB7XHJcbiAgICB2YXIgbGlzdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaXN0aW5nX19pZEFuZFR5cGUtaWQnKTtcclxuICAgIHZhciBkYXRhID0ge307XHJcbiAgICBpZiAobGlzdGluZyA9PT0gbnVsbCkge1xyXG4gICAgICBkYXRhLnRpdGxlID0gJ0RlbGV0ZSBFc3RhdGUnO1xyXG4gICAgICBkYXRhLmNob29zZSA9IGZhbHNlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZGF0YS50aXRsZSA9ICdQbGVhc2UgY2hvb3NlIHdoYXQgeW91IHdhbnQgdG8gZGVsZXRlJztcclxuICAgICAgZGF0YS5jaG9vc2UgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgZHVzdEJsdWViaXJkLnJlbmRlckFzeW5jKCdkZWxldGVEaWFsb2cnLCBkYXRhKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZUR1c3QocmVzdWx0KSB7XHJcbiAgICAgIGRpYWxvZy5pbm5lckhUTUwgPSByZXN1bHQ7XHJcbiAgICAgIGRpYWxvZy5zaG93TW9kYWwoKTtcclxuICAgIH0pXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKCkge1xyXG4gICAgICBkaWFsb2cucXVlcnlTZWxlY3RvcignI2NhbmNlbERlbGV0ZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2FuY2VsRGVsZXRlKTtcclxuICAgICAgZGlhbG9nLnF1ZXJ5U2VsZWN0b3IoJyNjb25maXJtRGVsZXRlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjb25maXJtRGVsZXRlKTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBpbml0RGlhbG9nKCkge1xyXG4gICAgaWYgKCEgZGlhbG9nLnNob3dNb2RhbCkge1xyXG4gICAgICBkaWFsb2dQb2x5ZmlsbC5yZWdpc3RlckRpYWxvZyhkaWFsb2cpO1xyXG4gICAgfVxyXG4gICAgc2hvdygpO1xyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgaW5pdDogaW5pdERpYWxvZ1xyXG4gIH07XHJcbn0od2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgalF1ZXJ5LCBBcHAsIGRpYWxvZ1BvbHlmaWxsKSk7XHJcbiIsIkFwcC5jb25maWcubW9kdWxlcy5pbnNlcnQgPSAoZnVuY3Rpb24gZWRpdCh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCBBcHAsIGRQaWNrLCBtb21lbnQsIGRpYWxvZ1BvbHlmaWxsLCBjbG91ZGluYXJ5KSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG4gIHZhciBsYW5nID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmxhbmc7XHJcbiAgdmFyIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5Jyk7XHJcbiAgdmFyIHV0aWxzID0gQXBwLnV0aWxzO1xyXG4gIHZhciBkdXN0Qmx1ZWJpcmQgPSBBcHAuY29uZmlnLnByb21pc2VzLmR1c3RCbHVlYmlyZDtcclxuICB2YXIgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHB3cmFwcGVyX19pbmZvYm94LWNvbnRlbnQnKTtcclxuICB2YXIgYWRkQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2luc2VydCcpO1xyXG4gIHZhciBpbmZvID0gQXBwLmNvbmZpZy5tb2R1bGVzLmluZm87XHJcbiAgdmFyIGRyYXduQ29sbGVjdGlvbiA9IG5ldyBvbC5Db2xsZWN0aW9uKCk7XHJcbiAgZnVuY3Rpb24gY2xlYXJDb250ZW50KCkge1xyXG4gICAgaWYgKGNvbnRlbnQuY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb250ZW50LmlubmVySFRNTCA9ICcnO1xyXG4gICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aXZlTW9kdWxlJykuaW5uZXJIVE1MID0gJ0luZm9ybWF0aW9uJztcclxuICAgIH1cclxuICB9XHJcbiAgZnVuY3Rpb24gY2hlY2tFbXB0eSgpIHtcclxuICAgIHZhciBpbnB1dHMgPSBjb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W3R5cGU9dGV4dF0nKTtcclxuICAgIHJldHVybiBfLnNvbWUoaW5wdXRzLCBmdW5jdGlvbiBpc0VtcHR5KGlucHV0KSB7XHJcbiAgICAgIGlmIChpbnB1dC52YWx1ZSA9PT0gJycpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gZ2V0SW50ZXJhY3Rpb24oaWQpIHtcclxuICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgdmFyIGludGVyYWN0aW9ucyA9IG1hcC5nZXRJbnRlcmFjdGlvbnMoKTtcclxuICAgIHZhciBmb3VuZCA9IHt9O1xyXG4gICAgaW50ZXJhY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gZ2V0SW50ZXJhY3Rpb25JZChpbnRlcmFjdGlvbikge1xyXG4gICAgICBpZiAoaW50ZXJhY3Rpb24uZ2V0KCdpZCcpID09PSBpZCkge1xyXG4gICAgICAgIGZvdW5kID0gaW50ZXJhY3Rpb247XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gZm91bmQ7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGRhdGVQaWNrZXIoKSB7XHJcbiAgICB2YXIgZm9ybWF0ID0gKGxhbmcgPT09ICdlbCcpID8gJ0RELU1NLVlZWVknIDogJ01NLURELVlZWVknO1xyXG4gICAgdmFyIGRhdGVTdGFydFBpY2tlcjtcclxuICAgIHZhciBkYXRlRW5kUGlja2VyO1xyXG4gICAgdmFyIGRhdGVTdGFydEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbmZvYm94X19kYXRlLXN0YXJ0Jyk7XHJcbiAgICB2YXIgZGF0ZUVuZEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbmZvYm94X19kYXRlLWVuZCcpO1xyXG4gICAgdmFyIGRhdGVTdGFydElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpc3RpbmdfX2dlbmVyYWwtZGF0ZVN0YXJ0Jyk7XHJcbiAgICB2YXIgZGF0ZUVuZElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpc3RpbmdfX2dlbmVyYWwtZGF0ZUVuZCcpO1xyXG4gICAgdmFyIG9ic2VydmVEYXRlUGlja2VyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24gb2JzZXJ2ZURhdGVQaWNrZXIobXV0YXRpb25zKSB7XHJcbiAgICAgIHZhciBhdHRyaWJ1dGVWYWx1ZTtcclxuICAgICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24gdG9nZ2xlVW5jbGlja2FibGVJbmZvYm94KG11dGF0aW9uKSB7XHJcbiAgICAgICAgaWYgKG11dGF0aW9uLmF0dHJpYnV0ZU5hbWUgPT09ICdjbGFzcycpIHtcclxuICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gJChtdXRhdGlvbi50YXJnZXQpLnByb3AobXV0YXRpb24uYXR0cmlidXRlTmFtZSk7XHJcbiAgICAgICAgICBpZiAoYXR0cmlidXRlVmFsdWUuaW5kZXhPZignbWRkdHAtcGlja2VyLS1pbmFjdGl2ZScpID4gLTEpIHtcclxuICAgICAgICAgICAgdXRpbHMucmVtb3ZlQ2xhc3MoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcHdyYXBwZXJfX2luZm9ib3gnKSwgJ3VuY2xpY2thYmxlJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB1dGlscy5hZGRDbGFzcyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwd3JhcHBlcl9faW5mb2JveCcpLCAndW5jbGlja2FibGUnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBpZiAoZGF0ZVN0YXJ0SW5wdXQgIT09IG51bGwpIHtcclxuICAgICAgY29uc29sZS5sb2coZGF0ZVN0YXJ0SW5wdXQudmFsdWUpO1xyXG4gICAgICBkYXRlU3RhcnRQaWNrZXIgPSBuZXcgZFBpY2suZGVmYXVsdCh7XHJcbiAgICAgICAgdHlwZTogJ2RhdGUnLFxyXG4gICAgICAgIGluaXQ6IG1vbWVudCgpLFxyXG4gICAgICAgIGZ1dHVyZTogbW9tZW50KCkuYWRkKDUsICd5ZWFycycpLFxyXG4gICAgICAgIHRyaWdnZXI6IGRhdGVTdGFydElucHV0LFxyXG4gICAgICAgIG9yaWVudGF0aW9uOiAnUE9SVFJBSVQnXHJcbiAgICAgIH0pO1xyXG4gICAgICBvYnNlcnZlRGF0ZVBpY2tlci5vYnNlcnZlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZGR0cC1waWNrZXJfX2RhdGUnKSwge1xyXG4gICAgICAgIGF0dHJpYnV0ZXM6IHRydWVcclxuICAgICAgfSk7XHJcbiAgICAgIGRhdGVTdGFydElucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ29uT2snLCBmdW5jdGlvbiBkaXNwbGF5UGlja2VkYXRlKCkge1xyXG4gICAgICAgIHV0aWxzLmFkZENsYXNzKHRoaXMucGFyZW50Tm9kZSwgJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgdGhpcy52YWx1ZSA9IGRhdGVTdGFydFBpY2tlci50aW1lLmZvcm1hdChmb3JtYXQpLnRvU3RyaW5nKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBkYXRlU3RhcnRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiBzaG93RGF0ZVBpY2tlcigpIHtcclxuICAgICAgICBkYXRlU3RhcnRQaWNrZXIudG9nZ2xlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKGRhdGVFbmRJbnB1dCAhPT0gbnVsbCkge1xyXG4gICAgICBkYXRlRW5kSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignb25PaycsIGZ1bmN0aW9uIGRpc3BsYXlQaWNrZWRhdGUoKSB7XHJcbiAgICAgICAgdXRpbHMuYWRkQ2xhc3ModGhpcy5wYXJlbnROb2RlLCAnaXMtZGlydHknKTtcclxuICAgICAgICB0aGlzLnZhbHVlID0gZGF0ZUVuZFBpY2tlci50aW1lLmZvcm1hdChmb3JtYXQpLnRvU3RyaW5nKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBkYXRlRW5kUGlja2VyID0gbmV3IGRQaWNrLmRlZmF1bHQoe1xyXG4gICAgICAgIHR5cGU6ICdkYXRlJyxcclxuICAgICAgICBpbml0OiBtb21lbnQoKSxcclxuICAgICAgICBmdXR1cmU6IG1vbWVudCgpLmFkZCg1LCAneWVhcnMnKSxcclxuICAgICAgICB0cmlnZ2VyOiBkYXRlRW5kSW5wdXQsXHJcbiAgICAgICAgb3JpZW50YXRpb246ICdQT1JUUkFJVCdcclxuICAgICAgfSk7XHJcbiAgICAgIG9ic2VydmVEYXRlUGlja2VyLm9ic2VydmUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21kZHRwLXBpY2tlcl9fZGF0ZScpLCB7XHJcbiAgICAgICAgYXR0cmlidXRlczogdHJ1ZVxyXG4gICAgICB9KTtcclxuICAgICAgZGF0ZUVuZEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uIHNob3dEYXRlUGlja2VyKCkge1xyXG4gICAgICAgIGRhdGVFbmRQaWNrZXIudG9nZ2xlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBmdW5jdGlvbiBzZXRFc3RhdGVUeXBlKHR5cGUpIHtcclxuICAgIHZhciB0eXBlcztcclxuICAgIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgICAgIHR5cGVzID0ge1xyXG4gICAgICAgIM6UzrnOsc68zq3Pgc65z4POvM6xOiBmdW5jdGlvbiBnZXRBcGFydG1lbnQoKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ0FwYXJ0bWVudCc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICDOnM6/zr3Ov866zrHPhM6/zrnOus6vzrE6IGZ1bmN0aW9uIGdldERldGFjaGVkSG91c2UoKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ0RldGFjaGVkIEhvdXNlJztcclxuICAgICAgICB9LFxyXG4gICAgICAgIM6czrXOts6/zr3Orc+EzrE6IGZ1bmN0aW9uIGdldE1haXNvbmV0dGUoKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ01haXNvbmV0dGUnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgzojPgM6xz4XOu863OiBmdW5jdGlvbiBnZXRWaWxsYSgpIHtcclxuICAgICAgICAgIHJldHVybiAnVmlsbGEnO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHR5cGVzID0ge1xyXG4gICAgICAgIEFwYXJ0bWVudDogZnVuY3Rpb24gZ2V0QXBhcnRtZW50KCkge1xyXG4gICAgICAgICAgcmV0dXJuICfOlM65zrHOvM6tz4HOuc+DzrzOsSc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAnRGV0YWNoZWQgSG91c2UnOiBmdW5jdGlvbiBnZXREZXRhY2hlZEhvdXNlKCkge1xyXG4gICAgICAgICAgcmV0dXJuICfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgTWFpc29uZXR0ZTogZnVuY3Rpb24gZ2V0TWFpc29uZXR0ZSgpIHtcclxuICAgICAgICAgIHJldHVybiAnzpzOtc62zr/Ovc6tz4TOsSc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBWaWxsYTogZnVuY3Rpb24gZ2V0VmlsbGEoKSB7XHJcbiAgICAgICAgICByZXR1cm4gJ86Iz4DOsc+FzrvOtyc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHR5cGVzW3R5cGVdKCk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGFzc2lnblZhbGlkYXRvcnMoKSB7XHJcbiAgICB2YXIgaW5wdXRzID0gY29udGVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFt0eXBlPXRleHRdJyk7XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoaW5wdXRzLCBmdW5jdGlvbiBtYWtlUGFyc2xleUlucHV0cyhlbCkge1xyXG4gICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgZnVuY3Rpb24gc25pdGl6ZSgpIHtcclxuICAgICAgICB2YXIgc3RyID0gdGhpcy52YWx1ZTtcclxuICAgICAgICB2YXIgc2FuaXRpemVkU3RyO1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFzZXQudHlwZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgIHNhbml0aXplZFN0ciA9IHN0ci5yZXBsYWNlKC9bL1xcRC8gXS9naSwgJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhc2V0LnR5cGUgPT09ICdhbHBoYW51bScpIHtcclxuICAgICAgICAgIHNhbml0aXplZFN0ciA9IHN0ci5yZXBsYWNlKC9bXmEtejAtOUEtWkEtes6RLc6pzrEtz4nOr8+KzpDPjM6szq3Pjc+LzrDOrs+OIF0vZ2ksICcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YXNldC50eXBlID09PSAnc3BlY2lhbCcpIHtcclxuICAgICAgICAgIHNhbml0aXplZFN0ciA9IHN0ci5yZXBsYWNlKC9bXjAtOSBcXC9dL2dpLCAnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRhdGFzZXQudHlwZSA9PT0gJ2RhdGUnKSB7XHJcbiAgICAgICAgICBzYW5pdGl6ZWRTdHIgPSBzdHIucmVwbGFjZSgvW14wLTkgXFwtXS9naSwgJycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnZhbHVlID0gc2FuaXRpemVkU3RyO1xyXG4gICAgICAgIHV0aWxzLnJlbW92ZUNsYXNzKHRoaXMucGFyZW50Tm9kZSwgJ2lzLWludmFsaWQnKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gY29sbGVjdFZhbHVlcyhnZXRYWSkge1xyXG4gICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICB2YXIgdmFsdWVzID0ge307XHJcbiAgICB2YXIgZmlsdGVyZWRWYWx1ZXMgPSB7fTtcclxuICAgIHZhciBpbnB1dHMgPSBjb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W3R5cGU9dGV4dF0nKTtcclxuICAgIHZhciBjaGVja2JveGVzID0gY29udGVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFt0eXBlPWNoZWNrYm94XScpO1xyXG4gICAgdmFsdWVzLmVzdGF0ZSA9IHt9O1xyXG4gICAgdmFsdWVzLmxpc3RpbmcgPSB7fTtcclxuICAgIGlmIChnZXRYWSkge1xyXG4gICAgICB2YWx1ZXMuZXN0YXRlLnggPSB1dGlscy5maW5kQnlJZChtYXAsICduZXdFc3RhdGVzJylcclxuICAgICAgLmdldFNvdXJjZSgpLmdldEZlYXR1cmVzKClbMF0uZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpWzBdO1xyXG4gICAgICB2YWx1ZXMuZXN0YXRlLnkgPSB1dGlscy5maW5kQnlJZChtYXAsICduZXdFc3RhdGVzJylcclxuICAgICAgLmdldFNvdXJjZSgpLmdldEZlYXR1cmVzKClbMF0uZ2V0R2VvbWV0cnkoKS5nZXRDb29yZGluYXRlcygpWzFdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFsdWVzLmVzdGF0ZS54ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VzdGF0ZScpLmRhdGFzZXQub3JpZ2luYWx4O1xyXG4gICAgICB2YWx1ZXMuZXN0YXRlLnkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXN0YXRlJykuZGF0YXNldC5vcmlnaW5hbHk7XHJcbiAgICB9XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwoaW5wdXRzLCBmdW5jdGlvbiBjb2xsZWN0RnJvbUlucHV0cyhlbCkge1xyXG4gICAgICB2YXIgbmFtZSA9IF8ubGFzdChfLnNwbGl0KGVsLmdldEF0dHJpYnV0ZSgnaWQnKSwgJy0nLCAzKSk7XHJcbiAgICAgIHZhciB2YWx1ZSA9IGVsLnZhbHVlO1xyXG4gICAgICBpZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gICAgICAgIGlmIChuYW1lID09PSAndHlwZScgJiYgZWwuaWQgPT09ICdlc3RhdGVfX2dlbmVyYWxfZXN0YXRlLXR5cGUnKSB7XHJcbiAgICAgICAgICB2YWx1ZXMuZXN0YXRlLmVzdGF0ZXR5cGVFbiA9IHNldEVzdGF0ZVR5cGUodmFsdWUpO1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS5lc3RhdGV0eXBlID0gdmFsdWU7XHJcbiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAndHlwZScgJiYgZWwuaWQgPT09ICdsaXN0aW5nX19pZEFuZFR5cGUtdHlwZScpIHtcclxuICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJ1NhbGUnIHx8IHZhbHVlID09PSAnzqDPjs67zrfPg863Jykge1xyXG4gICAgICAgICAgICB2YWx1ZXMubGlzdGluZy5zYWxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgdmFsdWVzLmxpc3RpbmcucmVudCA9IGZhbHNlO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFsdWVzLmxpc3Rpbmcuc2FsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB2YWx1ZXMubGlzdGluZy5yZW50ID0gdHJ1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5hbWUgPT09ICdhZGRyZXNzJykge1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS5zdHJlZXRFbiA9IHV0aWxzLmVsVG9Fbih2YWx1ZSk7XHJcbiAgICAgICAgICB2YWx1ZXMuZXN0YXRlLnN0cmVldEVsID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChuYW1lID09PSAndHlwZScgJiYgZWwuaWQgPT09ICdlc3RhdGVfX2dlbmVyYWxfZXN0YXRlLXR5cGUnKSB7XHJcbiAgICAgICAgICB2YWx1ZXMuZXN0YXRlLmVzdGF0ZXR5cGVFbiA9IHZhbHVlO1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS5lc3RhdGV0eXBlID0gc2V0RXN0YXRlVHlwZSh2YWx1ZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAndHlwZScgJiYgZWwuaWQgPT09ICdsaXN0aW5nX19pZEFuZFR5cGUtdHlwZScpIHtcclxuICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJ1NhbGUnIHx8IHZhbHVlID09PSAnzqDPjs67zrfPg863Jykge1xyXG4gICAgICAgICAgICB2YWx1ZXMubGlzdGluZy5zYWxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgdmFsdWVzLmxpc3RpbmcucmVudCA9IGZhbHNlO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFsdWVzLmxpc3Rpbmcuc2FsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB2YWx1ZXMubGlzdGluZy5yZW50ID0gdHJ1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5hbWUgPT09ICdhZGRyZXNzJykge1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS5zdHJlZXRFbiA9IHZhbHVlO1xyXG4gICAgICAgICAgdmFsdWVzLmVzdGF0ZS5zdHJlZXRFbCA9IHV0aWxzLmVsVG9Fbih2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChuYW1lID09PSAnYWRkcmVzc051bWJlcicpIHtcclxuICAgICAgICB2YWx1ZXMuZXN0YXRlLnN0cmVldE51bWJlciA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChuYW1lID09PSAncHJpY2UnKSB7XHJcbiAgICAgICAgdmFsdWVzLmxpc3RpbmcucHJpY2UgPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAobmFtZSA9PT0gJ2RhdGVTdGFydCcgfHwgbmFtZSA9PT0gJ2RhdGVFbmQnKSB7XHJcbiAgICAgICAgdmFsdWVzLmxpc3RpbmdbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB2YWx1ZXMuZXN0YXRlW25hbWVdID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgW10uZm9yRWFjaC5jYWxsKGNoZWNrYm94ZXMsIGZ1bmN0aW9uIGNvbGxlY3RGcm9tQ2hlY2tib3hlcyhlbCkge1xyXG4gICAgICB2YXIgbmFtZSA9IF8ubGFzdChfLnNwbGl0KGVsLmdldEF0dHJpYnV0ZSgnaWQnKSwgJy0nLCAzKSk7XHJcbiAgICAgIHZhciB2YWx1ZSA9IGVsLmNoZWNrZWQ7XHJcbiAgICAgIGlmIChuYW1lICE9PSAncGV0cycpIHtcclxuICAgICAgICB2YWx1ZXMuZXN0YXRlW25hbWVdID0gdmFsdWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFsdWVzLmxpc3RpbmdbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBmaWx0ZXJlZFZhbHVlcy5lc3RhdGUgPSBfLm9taXQodmFsdWVzLmVzdGF0ZSwgWydhZGRyZXNzJywgJ2FkZHJlc3NOdW1iZXInLCAndHlwZScsICd0b2dnbGUnXSk7XHJcbiAgICBmaWx0ZXJlZFZhbHVlcy5saXN0aW5nID0gdmFsdWVzLmxpc3Rpbmc7XHJcbiAgICByZXR1cm4gZmlsdGVyZWRWYWx1ZXM7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGFqYXhFc3RhdGVBbmRMaXN0aW5nKGRhdGEpIHtcclxuICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgZGF0YS5lc3RhdGUuYWRtaW5JZCA9IHdpbmRvdy5pZDtcclxuICAgIGNvbnNvbGUubG9nKGRhdGEuZXN0YXRlKTtcclxuICAgIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvYXBpL3Byb3BlcnR5JyxcclxuICAgICAgICB0eXBlOiAnUE9TVCcsXHJcbiAgICAgICAgZGF0YTogZGF0YS5lc3RhdGVcclxuICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShlc3RhdGVkYXRhKSB7XHJcbiAgICAgIHZhciBnaWQgPSBlc3RhdGVkYXRhLmdpZDtcclxuICAgICAgdmFyIHVwbG9hZE9wdGlvbnMgPSB7XHJcbiAgICAgICAgY2xvdWRfbmFtZTogJ2ZpcnZhaW4nLFxyXG4gICAgICAgIHVwbG9hZF9wcmVzZXQ6ICd0ZXN0dXBsb2FkJyxcclxuICAgICAgICBmb2xkZXI6IGdpZCxcclxuICAgICAgICBjbGllbnRfYWxsb3dlZF9mb3JtYXRzOiAnanBnJyxcclxuICAgICAgICB0aGVtZTogJ21pbmltYWwnXHJcbiAgICAgIH07XHJcbiAgICAgIGNsb3VkaW5hcnkub3BlblVwbG9hZFdpZGdldCh1cGxvYWRPcHRpb25zLCBmdW5jdGlvbiB1cGxvYWQoZXJyb3IsIHJlc3VsdCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycm9yLCByZXN1bHQpO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIGdpZDtcclxuICAgIH0pXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGdpZCkge1xyXG4gICAgICBkYXRhLmxpc3RpbmcuZ2lkID0gZ2lkO1xyXG4gICAgICByZXR1cm4gJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvYXBpL2xpc3RpbmcnLFxyXG4gICAgICAgIHR5cGU6ICdQT1NUJyxcclxuICAgICAgICBkYXRhOiBkYXRhLmxpc3RpbmdcclxuICAgICAgfSk7XHJcbiAgICB9KVxyXG4gICAgLmZpbmFsbHkoZnVuY3Rpb24gY2xvc2VJbnNlcnQoKSB7XHJcbiAgICAgIGNsZWFyQ29udGVudCgpO1xyXG4gICAgICB1dGlscy5hZGRDbGFzcyhjb250ZW50LCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9ICdpbmZvJztcclxuICAgICAgaW5mby5pbml0KCk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gYWpheExpc3RpbmcoZGF0YSkge1xyXG4gICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9hcGkvbGlzdGluZycsXHJcbiAgICAgICAgdHlwZTogJ1BPU1QnLFxyXG4gICAgICAgIGRhdGE6IF8ubWVyZ2UoeyBnaWQ6IGRhdGEuZ2lkIH0sIGRhdGEubGlzdGluZylcclxuICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShyZXN1bHQpIHtcclxuICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcclxuICAgIH0pXHJcbiAgICAuZmluYWxseShmdW5jdGlvbiBjbG9zZUluc2VydCgpIHtcclxuICAgICAgY2xlYXJDb250ZW50KCk7XHJcbiAgICAgIHV0aWxzLmFkZENsYXNzKGNvbnRlbnQsICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICBib2R5LmRhdGFzZXQuYWN0aXZlID0gJ2luZm8nO1xyXG4gICAgICBpbmZvLmluaXQoKTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiByZW5kZXJEdXN0TGlzdGluZygpIHtcclxuICAgIGR1c3RCbHVlYmlyZC5yZW5kZXJBc3luYygnaW5zZXJ0TGlzdGluZycsIF8uY2xvbmVEZWVwKEFwcC5jb25maWcuY29tbW9ucy50cmFucykpXHJcbiAgICAudGhlbihmdW5jdGlvbiByZXNvbHZlKGRhdGEpIHtcclxuICAgICAgdmFyIGFncmVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbmZpcm1CdG5zX19hZ3JlZScpO1xyXG4gICAgICB2YXIgZGlzYWdyZWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uZmlybUJ0bnNfX2Rpc2FncmVlJyk7XHJcbiAgICAgICQoJyNlc3RhdGUnKS5hZnRlcihkYXRhKTtcclxuICAgICAgZ2V0bWRsU2VsZWN0LmluaXQoJy5nZXRtZGwtc2VsZWN0Jyk7XHJcbiAgICAgIHV0aWxzLnJlbW92ZUNsYXNzKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25maXJtQnRucycpLCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgYXNzaWduVmFsaWRhdG9ycygpO1xyXG4gICAgICBkYXRlUGlja2VyKCk7XHJcbiAgICAgIGRpc2FncmVlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gaW5zZXJ0QWdyZWUoZSkge1xyXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIGNsZWFyQ29udGVudCgpO1xyXG4gICAgICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gJyc7XHJcbiAgICAgICAgdXRpbHMuYWRkQ2xhc3MoY29udGVudCwgJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9IGluZm87XHJcbiAgICAgICAgaW5mby5pbml0KCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBhZ3JlZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uIGluc2VydENvbnRpbnVlKGUpIHtcclxuICAgICAgICB2YXIgYWpheERhdGE7XHJcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgaWYgKGNoZWNrRW1wdHkoKSAhPT0gdHJ1ZSkge1xyXG4gICAgICAgICAgYWpheERhdGEgPSBjb2xsZWN0VmFsdWVzKGZhbHNlKTtcclxuICAgICAgICAgIGFqYXhEYXRhLmdpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlc3RhdGVfX2luZm8tZ2lkJykudmFsdWU7XHJcbiAgICAgICAgICBhamF4TGlzdGluZyhhamF4RGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24gZXJyb3IoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBmdW5jdGlvbiByZW5kZXJEdXN0RXNhdGVBbmRMaXN0aW5nKCkge1xyXG4gICAgdmFyIG1hcCA9IEFwcC5jb25maWcuY29tbW9ucy5tYXA7XHJcbiAgICB2YXIgZHJhdyA9IGdldEludGVyYWN0aW9uKCduZXdFc3RhdGUnKTtcclxuICAgIHZhciByZW5kZXJEYXRhID0gXy5jbG9uZURlZXAoQXBwLmNvbmZpZy5jb21tb25zLnRyYW5zKTtcclxuICAgIGR1c3RCbHVlYmlyZC5yZW5kZXJBc3luYygnaW5zZXJ0JywgcmVuZGVyRGF0YSlcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICBjbGVhckNvbnRlbnQoKTtcclxuICAgICAgY29udGVudC5pbm5lckhUTUwgPSBkYXRhO1xyXG4gICAgICB1dGlscy5yZW1vdmVDbGFzcyhjb250ZW50LCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgZ2V0bWRsU2VsZWN0LmluaXQoJy5nZXRtZGwtc2VsZWN0Jyk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZShkYXRhKSB7XHJcbiAgICAgIHZhciBhZ3JlZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25maXJtQnRuc19fYWdyZWUnKTtcclxuICAgICAgdmFyIGRpc2FncmVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbmZpcm1CdG5zX19kaXNhZ3JlZScpO1xyXG4gICAgICB2YXIgbGlzdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaXN0aW5nJyk7XHJcbiAgICAgIGFzc2lnblZhbGlkYXRvcnMoKTtcclxuICAgICAgZGF0ZVBpY2tlcigpO1xyXG4gICAgICBkaXNhZ3JlZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uIGluc2VydEFncmVlKGUpIHtcclxuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBjbGVhckNvbnRlbnQoKTtcclxuICAgICAgICAvLyBjb250ZW50LmlubmVySFRNTCA9IGRhdGE7XHJcbiAgICAgICAgdXRpbHMuYWRkQ2xhc3MoY29udGVudCwgJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9IGluZm87XHJcbiAgICAgICAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ25ld0VzdGF0ZXMnKS5nZXRTb3VyY2UoKS5jbGVhcigpO1xyXG4gICAgICAgIGluZm8uaW5pdCgpO1xyXG4gICAgICB9KTtcclxuICAgICAgYWdyZWUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiBpbnNlcnRDb250aW51ZShlKSB7XHJcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgdXRpbHMucmVtb3ZlQ2xhc3MobGlzdGluZywgJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgdGhpcy5pbm5lckhUTUwgPSAnQWdyZWUnO1xyXG4gICAgICAgIGUudGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoZS50eXBlLCBpbnNlcnRDb250aW51ZSk7XHJcbiAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uIGluc2VydEFncmVlKGV2dCkge1xyXG4gICAgICAgICAgdmFyIGFqYXhEYXRhO1xyXG4gICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAvLyBlLnRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKGUudHlwZSwgaW5zZXJ0QWdyZWUpO1xyXG4gICAgICAgICAgaWYgKGNoZWNrRW1wdHkoKSAhPT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBhamF4RGF0YSA9IGNvbGxlY3RWYWx1ZXModHJ1ZSk7XHJcbiAgICAgICAgICAgIGFqYXhFc3RhdGVBbmRMaXN0aW5nKGFqYXhEYXRhKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGNyZWF0ZURyYXdJbnRlcmFjdGlvbigpIHtcclxuICAgIHZhciBtYXAgPSBBcHAuY29uZmlnLmNvbW1vbnMubWFwO1xyXG4gICAgdmFyIGRyYXcgPSBuZXcgb2wuaW50ZXJhY3Rpb24uRHJhdyh7XHJcbiAgICAgIGZlYXR1cmVzOiBkcmF3bkNvbGxlY3Rpb24sXHJcbiAgICAgIHNvdXJjZTogdXRpbHMuZmluZEJ5SWQobWFwLCAnbmV3RXN0YXRlcycpLmdldFNvdXJjZSgpLFxyXG4gICAgICB0eXBlOiAnUG9pbnQnXHJcbiAgICB9KTtcclxuICAgIGRyYXcuc2V0KCdpZCcsICduZXdFc3RhdGUnKTtcclxuICAgIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgIG1hcC5hZGRJbnRlcmFjdGlvbihkcmF3KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gY2hlY2tFc3RhdGUoKSB7XHJcbiAgICBpZiAoY29udGVudC5pbm5lckhUTUwgPT09ICd1bmRlZmluZWQnIHx8IGNvbnRlbnQuaW5uZXJIVE1MID09PSAnJykge1xyXG4gICAgICByZXR1cm4gMDsgLy8gbm8gZXN0YXRlIG9yIGxpc3RpbmdcclxuICAgIH0gZWxzZSBpZiAoY29udGVudC5pbm5lckhUTUwgIT09ICd1bmRlZmluZWQnICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaXN0aW5nJykgIT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIDE7ICAvLyB0aGVyZSBpcyBhIGxpc3RpbmdcclxuICAgIH1cclxuICAgIHJldHVybiAyOyAvLyB0aGVyZSBpcyBubyBsaXN0aW5nXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBpbnNlcnQoKSB7XHJcbiAgICB2YXIgbWFwID0gQXBwLmNvbmZpZy5jb21tb25zLm1hcDtcclxuICAgIHZhciBkcmF3ID0gZ2V0SW50ZXJhY3Rpb24oJ25ld0VzdGF0ZScpO1xyXG4gICAgdmFyIG5ld0VzdGF0ZXMgPSB1dGlscy5maW5kQnlJZChtYXAsICduZXdFc3RhdGVzJyk7XHJcbiAgICBpbmZvLmRpc2FibGUoKTtcclxuICAgIGNvbnNvbGUubG9nKGNoZWNrRXN0YXRlKCkpO1xyXG4gICAgaWYgKGNoZWNrRXN0YXRlKCkgPT09IDApIHtcclxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGl2ZU1vZHVsZScpLmlubmVySFRNTCA9ICdBZGQgRXN0YXRlIEFuZCBMaXN0aW5nJztcclxuICAgICAgZHJhdy5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgICAgIHV0aWxzLmZpbmRCeUlkKG1hcCwgJ25ld0VzdGF0ZXMnKS5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICBkcmF3bkNvbGxlY3Rpb24ub24oJ2NoYW5nZTpsZW5ndGgnLCBmdW5jdGlvbiBrZWVwT25seU9uZUVzdGF0ZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5nZXRMZW5ndGgoKSA+IDApIHtcclxuICAgICAgICAgIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgIG5ld0VzdGF0ZXMuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBkcmF3Lm9uKCdkcmF3ZW5kJywgcmVuZGVyRHVzdEVzYXRlQW5kTGlzdGluZyk7XHJcbiAgICB9IGVsc2UgaWYgKGNoZWNrRXN0YXRlKCkgPT09IDIpIHtcclxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGl2ZU1vZHVsZScpLmlubmVySFRNTCA9ICdBZGQgTGlzdGluZyc7XHJcbiAgICAgIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgcmVuZGVyRHVzdExpc3RpbmcoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRyYXcuc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGl2ZU1vZHVsZScpLmlubmVySFRNTCA9ICdJbmZvcm1hdGlvbic7XHJcbiAgICAgIGluZm8uaW5pdCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaW5pdCgpIHtcclxuICAgIGlmIChfLmlzRW1wdHkoZ2V0SW50ZXJhY3Rpb24oJ25ld0VzdGF0ZScpKSkge1xyXG4gICAgICBjcmVhdGVEcmF3SW50ZXJhY3Rpb24oKTtcclxuICAgIH1cclxuICAgIGluc2VydCgpO1xyXG4gIH1cclxuICByZXR1cm4ge1xyXG4gICAgaW5pdDogaW5pdFxyXG4gIH07XHJcbn0od2luZG93LCBkb2N1bWVudCwgUHJvbWlzZSwgalF1ZXJ5LCBBcHAsIG1kRGF0ZVRpbWVQaWNrZXIsIG1vbWVudCwgZGlhbG9nUG9seWZpbGwsIGNsb3VkaW5hcnkpKTtcclxuIiwidmFyIHVzZXJNYXAgPSAoZnVuY3Rpb24gdXNlck1hcCh3aW5kb3csIGRvY3VtZW50LCBQcm9taXNlLCAkLCBBcHApIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgdmFyIGNvbnRleHQgPSAnYWRtaW4nO1xyXG4gIHZhciBsYW5nID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmxhbmc7XHJcbiAgdmFyICRsb2FkaW5nID0gJCgnLm1kbC1zcGlubmVyJyk7XHJcbiAgJChkb2N1bWVudClcclxuICAuYWpheFN0YXJ0KGZ1bmN0aW9uIHN0YXJ0KCkge1xyXG4gICAgJCgnLnNwaW5lci13cmFwcGVyJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAkbG9hZGluZy5hZGRDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSlcclxuICAuYWpheFN0b3AoZnVuY3Rpb24gc3RvcCgpIHtcclxuICAgICQoJy5zcGluZXItd3JhcHBlcicpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgJGxvYWRpbmcucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIH0pO1xyXG4gIHRvYXN0ci5vcHRpb25zID0ge1xyXG4gICAgY2xvc2VCdXR0b246IGZhbHNlLFxyXG4gICAgZGVidWc6IGZhbHNlLFxyXG4gICAgbmV3ZXN0T25Ub3A6IGZhbHNlLFxyXG4gICAgcHJvZ3Jlc3NCYXI6IGZhbHNlLFxyXG4gICAgcG9zaXRpb25DbGFzczogJ3RvYXN0LXRvcC1jZW50ZXInLFxyXG4gICAgcHJldmVudER1cGxpY2F0ZXM6IGZhbHNlLFxyXG4gICAgb25jbGljazogbnVsbCxcclxuICAgIHNob3dEdXJhdGlvbjogJzMwMCcsXHJcbiAgICBoaWRlRHVyYXRpb246ICcxMDAwJyxcclxuICAgIHRpbWVPdXQ6ICc1MDAwJyxcclxuICAgIGV4dGVuZGVkVGltZU91dDogJzEwMDAnLFxyXG4gICAgc2hvd0Vhc2luZzogJ3N3aW5nJyxcclxuICAgIGhpZGVFYXNpbmc6ICdsaW5lYXInLFxyXG4gICAgc2hvd01ldGhvZDogJ2ZhZGVJbicsXHJcbiAgICBoaWRlTWV0aG9kOiAnZmFkZU91dCdcclxuICB9O1xyXG4gIGZ1bmN0aW9uIGluaXQoKSB7XHJcbiAgICBQcm9taXNlLnJlc29sdmUoXHJcbiAgICAgICQuYWpheCh7XHJcbiAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9sYW5ndWFnZScsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgdHlwZTogbGFuZyxcclxuICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHRcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIClcclxuICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICBBcHAuY29uZmlnLmNvbW1vbnMudHJhbnMgPSBkYXRhO1xyXG4gICAgICBBcHAuY29uZmlnLmNvbW1vbnMubWFwID0gQXBwLmNvbmZpZy5tb2R1bGVzLm1hcC5pbml0aWFsaXplKCk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gcmVzb2x2ZSgpIHtcclxuICAgICAgdmFyIG1vZHVsZU9ic2VydmVyO1xyXG4gICAgICBBcHAuY29uZmlnLm1vZHVsZXMuaW5mby5pbml0KCk7XHJcbiAgICAgIG1vZHVsZU9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24gbW9kdWxlT2JzZXJ2ZXJDaG9vc2VyKG11dGF0aW9ucykge1xyXG4gICAgICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIGZvZXJFYWNoTXV0YXRpb24obXV0YXRpb24pIHtcclxuICAgICAgICAgIGlmICh0eXBlb2YgbXV0YXRpb24udGFyZ2V0LmRhdGFzZXQgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgIGlmIChtdXRhdGlvbi50YXJnZXQuZGF0YXNldC5hY3RpdmUgPT09ICdpbnNlcnQnKSB7XHJcbiAgICAgICAgICAgICAgQXBwLmNvbmZpZy5tb2R1bGVzLmluc2VydC5pbml0KCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobXV0YXRpb24udGFyZ2V0LmRhdGFzZXQuYWN0aXZlID09PSAnZGVsZXRlJykge1xyXG4gICAgICAgICAgICAgIEFwcC5jb25maWcubW9kdWxlcy5kZWxldGUuaW5pdCgpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG11dGF0aW9uLnRhcmdldC5kYXRhc2V0LmFjdGl2ZSA9PT0gJ2VkaXQnKSB7XHJcbiAgICAgICAgICAgICAgQXBwLmNvbmZpZy5tb2R1bGVzLmVkaXQuaW5pdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBtb2R1bGVPYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSwge1xyXG4gICAgICAgIGF0dHJpYnV0ZXM6IHRydWVcclxuICAgICAgfSk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKGZ1bmN0aW9uIGVycm9yKGUpIHtcclxuICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcmV0dXJuIHtcclxuICAgIGluaXQ6IGluaXRcclxuICB9O1xyXG59KHdpbmRvdywgZG9jdW1lbnQsIFByb21pc2UsIGpRdWVyeSwgQXBwKSk7XHJcblxyXG51c2VyTWFwLmluaXQoKTtcclxuXHJcbiQoZnVuY3Rpb24gRHJlYWR5KCkge1xyXG4gIHZhciB1dGlscyA9IEFwcC51dGlscztcclxuICB2YXIgYWRkQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2luc2VydCcpO1xyXG4gIHZhciBkZWxldGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVsZXRlJyk7XHJcbiAgdmFyIGVkaXRCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZWRpdCcpO1xyXG4gICQoJyNsb2dvdXQnKS5jbGljayhmdW5jdGlvbiBsb2dvdXQoKSB7XHJcbiAgICBsb2NhdGlvbi5ocmVmID0gJy9sb2dvdXQnO1xyXG4gIH0pO1xyXG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbnRlci1mdWxsc2NyZWVuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLFxyXG4gICAgZnVuY3Rpb24gYWRkQ2xpY2tFdmVudFRvRW50ZXJGdWxsc3JlZW4oKSB7XHJcbiAgICAgIHZhciBlbGVtID0gZG9jdW1lbnQuYm9keTtcclxuICAgICAgdXRpbHMucmVxdWVzdEZ1bGxTY3JlZW4oZWxlbSk7XHJcbiAgICAgIHV0aWxzLnJlbW92ZUNsYXNzKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGl0LWZ1bGxzY3JlZW4nKS5wYXJlbnROb2RlLCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgdXRpbHMuYWRkQ2xhc3ModGhpcy5wYXJlbnROb2RlLCAndmlzdWFsbHloaWRkZW4nKTtcclxuICAgIH1cclxuICApO1xyXG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleGl0LWZ1bGxzY3JlZW4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsXHJcbiAgICBmdW5jdGlvbiBhZGRDbGlja0V2ZW50VG9FeGl0RnVsbHNyZWVuKCkge1xyXG4gICAgICB2YXIgZWxlbSA9IGRvY3VtZW50O1xyXG4gICAgICB1dGlscy5leGl0RnVsbHNyZWVuKGVsZW0pO1xyXG4gICAgICB1dGlscy5yZW1vdmVDbGFzcyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW50ZXItZnVsbHNjcmVlbicpLnBhcmVudE5vZGUsICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICB1dGlscy5hZGRDbGFzcyh0aGlzLnBhcmVudE5vZGUsICd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgfVxyXG4gICk7XHJcbiAgYWRkQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gYWN0aXZhdGVJbnNlcnRNb2R1bGUoKSB7XHJcbiAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTtcclxuICAgIGJvZHkuZGF0YXNldC5hY3RpdmUgPSAnaW5zZXJ0JztcclxuICB9KTtcclxuICBkZWxldGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiBhY3RpdmF0ZURlbGV0ZU1vZHVsZSgpIHtcclxuICAgIHZhciBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpO1xyXG4gICAgYm9keS5kYXRhc2V0LmFjdGl2ZSA9ICdkZWxldGUnO1xyXG4gIH0pO1xyXG4gIGVkaXRCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiBhY3RpdmF0ZUVkaXRNb2R1bGUoKSB7XHJcbiAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTtcclxuICAgIGJvZHkuZGF0YXNldC5hY3RpdmUgPSAnZWRpdCc7XHJcbiAgfSk7XHJcbiAgLy8gY29uc29sZS5sb2coYm93c2VyKTtcclxufSk7XHJcbiJdfQ==
