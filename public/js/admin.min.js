var $loading = $('.mdl-spinner');

var center = [3677385, 4120949];
var extent = [3590094, 4102833, 3855483, 4261211];
var lang = document.documentElement.lang;
var geoJSONFormat = new ol.format.GeoJSON({
  defaultDataProjection: 'EPSG:4326'
});
var propertySource;
var property;
var map;
var features;
var drawnProperties;
var draw;
var select;
var translate;
var bing;
var mapbox;
toastr.options = {
  closeButton: false,
  debug: false,
  newestOnTop: false,
  progressBar: false,
  positionClass: 'toast-top-center',
  preventDuplicates: false,
  onclick: null,
  showDuration: '300',
  hideDuration: '1000',
  timeOut: '5000',
  extendedTimeOut: '1000',
  showEasing: 'swing',
  hideEasing: 'linear',
  showMethod: 'fadeIn',
  hideMethod: 'fadeOut'
};
bing = new ol.layer.Tile({
  visible: true,
  source: new ol.source.BingMaps({
    key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
    imagerySet: 'Aerial'
  }),
  maxZoom: 19,
  crossOrigin: 'anonymous',
  preload: Infinity,
  id: 'bing'
});
mapbox = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [new ol.Attribution({
      html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
    })],
    url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
  }),
  id: 'mapbox'
});

function getIconType(estateType) {
  var iconType = {
    Apartment: function () {
      return 'apartment';
    },
    Store: function () {
      return 'store';
    },
    'Detached House': function () {
      return 'detached';
    },
    Maisonette: function () {
      return 'maisonette';
    },
    Villa: function () {
      return 'villa';
    }
  };
  return (iconType[estateType])();
}

function getIconPath(listingType) {
  var iconPath = {
    true: function () {
      return './images/pins/sale/';
    },
    false: function () {
      return './images/pins/rent/';
    },
    none: function () {
      return './images/pins/none/';
    }
  };
  return (iconPath[listingType])();
}

function PropertyStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-48.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
propertySource = new ol.source.Vector({
  format: geoJSONFormat,
  loader: function (extent, resolution, projection) {
    var url = 'http://127.0.0.1:3000/db/property/' + id;
    var self = this;
    // self.clear();
    $.ajax({
      url: url,
      type: 'GET',
      beforeSend: function (xhr) {
        if (localStorage.getItem('userToken')) {
          xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('userToken'));
        }
      },
      dataType: 'json'
    })
    .done(function completed(data, textStatus, jqXHR) {
      var newFeatures = geoJSONFormat.readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
      self.addFeatures(newFeatures);
    })
    .fail(function failed(jqXHR, textStatus, errorThrown) {
      toastr.clear();
      if (jqXHR.status === 404) {
        toastr.error('Sorry, we cannot find this property!');
      } else if (jqXHR.status === 503) {
        toastr.error('Service Unavailable');
      } else {
        toastr.error('Internal Server Error');
      }
    });
  },
  strategy: ol.loadingstrategy.all
});
property = new ol.layer.Vector({
  source: propertySource,
  id: 'property',
  visible: true,
  style: PropertyStyle
});
property.setZIndex(2);
map = new ol.Map({
  target: 'adminMap',
  layers: [
    mapbox, property
  ],
  loadTilesWhileAnimating: true,
  loadTilesWhileInteracting: true,
  renderer: 'canvas',
  controls: ol.control.defaults({
    attributionOptions: {
      collapsible: false,
      collapsed: false
    }
  }).extend([
    new ol.control.ScaleLine({
      units: 'metric'
    }),
    new ol.control.OverviewMap({
      className: 'ol-overviewmap ol-custom-overviewmap',
      collapsible: true,
      collapsed: true,
      layers: [bing]
    }),
    new ol.control.ZoomToExtent({
      extent: extent
    })
  ]),
  view: new ol.View({
    center: center,
    // extent: extent,
    projection: 'EPSG:3857',
    zoom: 14,
    maxZoom: 19,
    minZoom: 10
  })
});
if (lang === 'el') {
  bing.set('name', 'Δορυφορική εικόνα');
  mapbox.set('name', 'Χάρτης');
  property.set('name', 'Ακίνητα');
} else {
  bing.set('name', 'Sattelite Image');
  mapbox.set('name', 'Map');
  property.set('name', 'Properties');
}
// ====== interactions ======
features = new ol.Collection();

function drawnPropertiesStyle(color) {
  var src;
  src = './images/pins/generic-48.png';
  if (typeof color !== 'undefined') {
    return new ol.style.Style({
      image: new ol.style.Icon(({
        src: src,
        anchorOrigin: 'bottom-left',
        anchor: [
          0.5, 0
        ],
        scale: 1,
        color: color
      }))
    });
  }
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
drawnProperties = new ol.layer.Vector({
  source: new ol.source.Vector(),
  id: 'drawnProperties',
  style: drawnPropertiesStyle('#4caf50')
});
map.addLayer(drawnProperties);
// draw
draw = new ol.interaction.Draw({
  // features: features,
  source: drawnProperties.getSource(),
  type: 'Point',
  style: drawnPropertiesStyle('#4caf50')
});
map.addInteraction(draw);
draw.setActive(false);
// select
function selectedStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-64.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1,
      color: '#ffeb3b'
    }))
  });
}
select = new ol.interaction.Select({
  layers: [property],
  features: features,
  multi: false,
  style: selectedStyle
});
map.addInteraction(select);
select.setActive(false);
translate = new ol.interaction.Translate({
  features: select.getFeatures()
});
map.addInteraction(translate);
translate.setActive(false);
// ====== info ======
map.on('click', clickInfo);

function clickInfo(event) {
  var obj = {};

  event.preventDefault();
  select.setActive(true);
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      obj.feature = {};
      selectedFeature = _.head(e.selected);
      // clickedFeature.feature.setScale(1.2);
      selectedFeature.getKeys().forEach(function (key) {
        obj.feature[key] = selectedFeature.get(key);
      });
      dust.render('adminPropertyInfo', obj, function (err, out) {
        $('.property-info').html(out);
        $('.property-info').removeClass('visuallyhidden');
        componentHandler.upgradeDom();
        $('#listing').on('click', function (event) {
          var gid;
          event.preventDefault();
          gid = $(this).data('gid');
          $.ajax({
              url: 'http://127.0.0.1:3000/db/listing',
              type: 'GET',
              dataType: 'json',
              data: {
                gid: gid,
              },
            })
            .done(function (data) {
              // console.log(data);
              var listing_id = data.id;
              $('#openModal').css('width', 'auto');
              $('.modal-dialog').removeClass('visuallyhidden');
              dust.render('listingInsert', data, function (err, out) {
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                handleForm.set({
                  name: 'insert-update-listing',
                  submitBtnId: 'ok',
                });
                if ($('input[name=options]:checked').val() === 'Sale') {
                  $('#pets').parent().hide();
                  $('#prefered_customer').parent().hide();
                }
                $('input[name=options]').on('change', function (event) {
                  if ($(this).val() === 'Sale') {
                    $('#pets').prop('disabled', true);
                    $('#pets').prop('checked', false);
                    $('#pets').parent().hide();
                    $('label[for=pets]').removeClass('is-checked');
                    $('#prefered_customer').val('');
                    $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                    $('#prefered_customer').prop('disabled', true);
                    $('#prefered_customer').parent().hide();
                  } else {
                    $('#pets').prop('disabled', false);
                    $('#pets').parent().show();
                    $('#prefered_customer').prop('disabled', false);
                    $('#prefered_customer').parent().show();
                  }
                });
                $('#sent-listing').on('click', function (event) {
                  var data;
                  event.preventDefault();
                  data = handleForm.get();
                  if (data !== null) {
                    data.property_gid = gid;
                    data.listing_id = listing_id;
                    $.ajax({
                        url: 'http://127.0.0.1:3000/db/listing',
                        type: 'PUT',
                        data: data,
                        dataType: 'text'
                      })
                      .done(function (data, textStatus, jqXHR) {
                        if (jqXHR.status === 200) {
                          toastr.success('Property Updated In Database');
                        } else {
                          toastr.error('Oops Something Went Wrong!!!');
                        }
                      })
                      .fail(function (jqXHR, textStatus, errorThrown) {
                        toastr.error('Oops Something Went Wrong!!!');
                      })
                      .always(function () {
                        handleForm.clear();
                        $('#openModal').addClass('visuallyhidden');
                        propertySource.clear();
                        select.getFeatures().clear();
                        select.setActive(false);
                      });
                  }
                });
                $('#cancel-listing').on('click', function (event) {
                  event.preventDefault();
                  handleForm.clear();
                  select.getFeatures().clear();
                  select.setActive(false);
                  $('#openModal').addClass('visuallyhidden');
                });
              });
            })
            .fail(function () {
              var obj = {};
              if (lang === 'el') {
                obj.msg = 'Δεν Βρέθηκε Αγγελία';
                obj.text = 'Δημιουργία Καινούργιας;';
                obj.yes = 'ΝΑΙ';
                obj.no = 'ΟΧΙ';
              } else {
                obj.msg = 'No Listing Found';
                obj.text = 'Create New Listing?';
                obj.yes = 'YES';
                obj.no = 'NO';
              }
              dust.render('dialog', obj, function (error, out) {
                $('#openModal').removeClass('visuallyhidden');
                $('#openModal').css('width', 'auto');
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                $('#yes').on('click', function (event) {
                  event.preventDefault();
                  dust.render('listingInsert', {
                    rent: 'true',
                    addImage: 'true',
                  }, function (err, out) {
                    var myDropzone;
                    $('.modal-content').html(out);
                    componentHandler.upgradeDom();
                    myDropzone = new Dropzone(document.getElementById('dropzone'), {
                      uploadMultiple: false,
                      acceptedFiles: '.jpg',
                      parallelUploads: 6,
                      // addRemoveLinks : true,
                      url: 'https://api.cloudinary.com/v1_1/firvain/auto/upload'
                    });
                    myDropzone.on('sending', function (file, xhr, formData) {
                      formData.append('api_key', 375138932689591);
                      formData.append('callback', 'http://127.0.0.1:3000/public/cloudinary_cors.html');
                      formData.append('upload_preset', 'testupload');
                      formData.append('public_id', gid);
                    });
                    myDropzone.on('success', function () {
                      this.element.style.display = 'none';
                    });
                    handleForm.set({
                      name: 'insert-update-listing',
                      submitBtnId: 'ok'
                    });
                    // $('input[name=file]').cloudinary_fileupload();
                    // $('input[name=file]').unsigned_cloudinary_upload('testupload', {
                    //   cloud_name: 'firvain',
                    //   'public_id': gid,
                    // });
                    $('input[name=options]').on('change', function (event) {
                      if ($(this).val() === 'Sale') {
                        $('#pets').prop('disabled', true);
                        $('#pets').prop('checked', false);
                        $('label[for=pets]').removeClass('is-checked');
                        $('#prefered_customer').val('');
                        $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                        $('#prefered_customer').prop('disabled', true);
                      } else {
                        $('#pets').prop('disabled', false);
                        $('#prefered_customer').prop('disabled', false);
                      }
                    });
                    $('#sent-listing').on('click', function (event) {
                      var data;
                      event.preventDefault();
                      data = handleForm.get();
                      if (data !== null) {
                        data.property_gid = gid;
                        $.ajax({
                            url: 'http://127.0.0.1:3000/db/listing',
                            type: 'POST',
                            data: data,
                            dataType: 'text'
                          })
                          .done(function (data, textStatus, jqXHR) {
                            if (jqXHR.status === 201) {
                              toastr.success('Property Updated In Database');
                            } else {
                              toastr.error('Oops Something Went Wrong!!!');
                            }
                          })
                          .fail(function (jqXHR, textStatus, errorThrown) {
                            toastr.error('Oops Something Went Wrong!!!');
                          })
                          .always(function () {
                            handleForm.clear();
                            $('#openModal').addClass('visuallyhidden');
                            select.getFeatures().clear();
                            select.setActive(false);
                          });
                      }
                    });
                    $('#cancel-listing').on('click', function (event) {
                      event.preventDefault();
                      handleForm.clear();
                      select.getFeatures().clear();
                      select.setActive(false);
                      $('#openModal').addClass('visuallyhidden');
                    });
                  });
                });
                $('#no').on('click', function (event) {
                  event.preventDefault();
                  $('#openModal').addClass('visuallyhidden');
                  select.getFeatures().clear();
                  select.setActive(false);
                });
              });
            });
        });
      });
    } else {
      select.getFeatures().clear();
      // select.setActive(false);
      $('.property-info').addClass('visuallyhidden');
      toastr.error('Cant Find Any Property There...');
    }
  });
}
// ====== logout ======
$('#logout').click(function () {
  location.href = '/map/logout';
});
// ====== insert ======
$('#insertProperty').click(function () {
  var onEndDraw;
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  select.getFeatures().clear();
  select.setActive(false);
  draw.setActive(true);
  onEndDraw = draw.on('drawend', function (event) {
    var obj = {};
    var coords;
    var geocodeObj;
    var latlng;
    var geocodeName_el;
    var geocodeName_en;
    var geocodeAreaName;
    event.preventDefault();
    draw.setActive(false);
    coords = ol.proj.transform(event.feature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
    obj.coords = coords;
    latlng = coords[1] + '\,' + coords[0];
    geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
      latlng: latlng,
      key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ',
    }, function (json, textStatus) {
      return json;
    });
    geocodeObj.then(function () {
      geocodeName_el = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
      geocodeName_en = string_el_to_url(geocodeName_el);
      obj.street_el = geocodeName_el;
      obj.street_en = geocodeName_en;
      geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
      obj.area_name = geocodeAreaName;
      dataForm(obj);
    });

  });

  function dataForm(obj) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyInsert', obj, function (err, out) {
      $('.modal-content').html(out);
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'insertProperty',
        submitBtnId: 'insert'
      });
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val('');
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val('');
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');


        }
      });
      $('#cancelInsert').on('click', function (event) {
        event.preventDefault();
        handleForm.clear();
        drawnProperties.getSource().clear();
        draw.unByKey(onEndDraw);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
      $('#insert').on('click', function (event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (data !== null) {
          data.x = obj.coords[0];
          data.y = obj.coords[1];
          data.adminId = id;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'POST',
            data: data
          })
          .done(function completed() {
            toastr.clear();
            toastr.success('Property Recorded In Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function () {
            event.preventDefault();
            drawnProperties.getSource().clear();
            propertySource.clear();
            handleForm.clear();
            draw.unByKey(onEndDraw);
            $('.modal-dialog').addClass('visuallyhidden');
            map.on('click', clickInfo);
          });
        }
      });
    });
  }
});
// ====== delete ======
$('#deleteProperty').click(function (event) {
  event.preventDefault();
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  select.once('select', function (e) {
    var $toast;
    if (e.target.getFeatures().getLength() === 1) {
      $toast = toastr.warning('<p>Are you sure?</p><div class="toastr-btns"><button id="yesDelete" class="mdl-button mdl-js-button ">Yes</button><button id="noDelete" class="mdl-button mdl-js-button">No</button></div>');
      $toast.on('click', '#yesDelete', function () {
        var gid = select.getFeatures().item(0).get('gid');
        $.ajax({
          url: 'http://127.0.0.1:3000/db/property',
          type: 'DELETE',
          dataType: 'json',
          data: {
            gid: gid
          }
        })
          .done(function completed(data, textStatus, jqXHR) {
            toastr.clear();
            toastr.success('Property Successfully Deleted with id = ' + data.propertygid + ' from Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function always() {
            propertySource.clear();
            select.getFeatures().clear();
            select.setActive(false);
            map.on('click', clickInfo);
          });

        $toast.remove();
      });
      $toast.on('click', '#noDelete', function () {
        $toast.remove();
        select.getFeatures().clear();
        select.setActive(false);
      });
    }
  });
});

// ====== update ======

$('#updateProperty').on('click', function updateProperty(event) {
  var gid;
  var obj;
  var coords;
  var onEndTranslte;
  event.preventDefault();
  toastr.clear();
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  $('.property-info').addClass('visuallyhidden');
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      gid = _.head(e.selected).get('gid');
      selectedFeature = _.head(e.selected);
      coords = ol.proj.transform(selectedFeature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
      $.ajax({
        url: 'http://127.0.0.1:3000/db/property',
        type: 'GET',
        dataType: 'json',
        data: {
          gid: gid
        }
      })
        .done(function completed(data) {
          var $toast = {};
          $toast.options = {};
          obj = _.head(data.features).properties;
          console.log(obj)

          $toast = toastr.warning('<p>Change Property Coordinates?</p><div class="toastr-btns"><button id="yesChangeXY" class="mdl-button mdl-js-button ">Yes</button><button id="noChangeXY" class="mdl-button mdl-js-button">No</button></div>');
          $toast.on('click', '#yesChangeXY', function yesChangeXY() {
            var latlng;
            var geocodeObj;
            var geocodeNameEl;
            var geocodeNameEn;
            var geocodeAreaName;
            translate.setActive(true);
            onEndTranslte = translate.on('translateend', function translateEnd(e) {
              // var geocodeObj;
              coords = ol.proj.transform(e.features.item(0).getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
              latlng = coords[1] + '\,' + coords[0];
              geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
                latlng: latlng,
                key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ'
              }, function (json, textStatus) {
                return json.results;
              });
              geocodeObj.then(function () {
                geocodeNameEl = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
                geocodeNameEn = string_el_to_url(geocodeNameEl);
                obj.street_el = geocodeNameEl;
                obj.street_en = geocodeNameEn;
                geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
                obj.area_name = geocodeAreaName;
                dataForm(obj, coords);
              });
            });
          });
          $toast.on('click', '#noChangeXY', function noChangeXY() {
            translate.setActive(false);
            toastr.clear();
            dataForm(obj, coords);
          });
        })
        .fail(function failed() {
          toastr.error('Oops Something Went Wrong!!!');
        });
    }
  });

  function dataForm(obj, coords) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyUpdate', obj, function renderPropertyUpdate(err, out) {
      var oldValues = {};
      $('.modal-content').html(out);
      oldValues.bedrooms = $('#bedrooms').val();
      oldValues.street_en = $('#street_en').val();
      oldValues.street_el = $('#street_el').val();
      oldValues.area_name = $('#area_name').val();
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'updateProperty',
        submitBtnId: 'update'
      });
      // $('#street_el').val(obj.geocodeName_el);
      // $('#street_en').val(obj.geocodeName_en);
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');
        }
      });
      $('#update').on('click', function update(event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (!_.isNil(data)) {
          data.x = coords[0];
          data.y = coords[1];
          data.gid = gid;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'PUT',
            data: data
          })
            .done(function completed(response, textStatus, jqXHR) {
              toastr.clear();
              toastr.success('Property with gid ' + response.propertygid + ' Updated in Database');
            })
            .fail(function failed(jqXHR, textStatus, errorThrown) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find this property!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            })
            .always(function always() {
              propertySource.clear();
              select.getFeatures().clear();
              select.setActive(false);
              translate.unByKey(onEndTranslte);
              translate.setActive(false);
              map.on('click', clickInfo);
              $('.modal-dialog').addClass('visuallyhidden');
            });
        }
      });
      $('#cancelUpdate').on('click', function cancelUpdate(event) {
        event.preventDefault();
        handleForm.clear();
        propertySource.clear();
        select.getFeatures().clear();
        translate.unByKey(onEndTranslte);
        select.setActive(false);
        translate.setActive(false);
        map.on('click', clickInfo);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
    });
  }

  $('#adminMap').removeAttr('style');
});
$(document).ready(function () {
  window.Parsley.on('field:error', function () {
    // This global callback will be called for any field that fails validation.
    console.log('Validation failed for: ', this.$element);
  });
  window.Parsley
    .addValidator('date', {
      requirementType: 'string',
      validateString: function (value, requirement) {
        if (moment(value, 'DD-MM-YYYY', true).isValid() === true) {
          return true;
        }
        return false;
      },
      messages: {
        en: 'Wrong Date',
        el: 'Λάθος Ημερομηνία'
      }
    });
});

function string_el_to_url(string) {
  var originalString = string;
  var newString;
  var replace = new Array('α', 'ά', 'Ά', 'Α', 'β', 'Β', 'γ', 'Γ', 'δ', 'Δ', 'ε', 'έ', 'Ε', 'Έ', 'ζ', 'Ζ', 'η', 'ή', 'Η', 'θ', 'Θ', 'ι', 'ί', 'ϊ', 'ΐ', 'Ι', 'Ί', 'κ', 'Κ', 'λ', 'Λ', 'μ', 'Μ', 'ν', 'Ν', 'ξ', 'Ξ', 'ο', 'ό', 'Ο', 'Ό', 'π', 'Π', 'ρ', 'Ρ', 'σ', 'ς', 'Σ', 'τ', 'Τ', 'υ', 'ύ', 'Υ', 'Ύ', 'φ', 'Φ', 'χ', 'Χ', 'ψ', 'Ψ', 'ω', 'ώ', 'Ω', 'Ώ', ' ', '\'', '\'', ',');
  var replace_n = new Array('a', 'a', 'A', 'A', 'v', 'V', 'g', 'G', 'd', 'D', 'e', 'e', 'E', 'E', 'z', 'Z', 'i', 'i', 'I', 'th', 'Th', 'i', 'i', 'i', 'i', 'I', 'I', 'k', 'K', 'l', 'L', 'm', 'M', 'n', 'N', 'x', 'X', 'o', 'o', 'O', 'O', 'p', 'P', 'r', 'R', 's', 's', 'S', 't', 'T', 'u', 'u', 'Y', 'Y', 'f', 'F', 'ch', 'Ch', 'ps', 'Ps', 'o', 'o', 'O', 'O', ' ', '_', '_', '_');

  for (var i = 0; i < replace.length; i++) {
    originalString = originalString.replace(new RegExp(replace[i], 'g'), replace_n[i]);
  }
  newString = originalString;
  return newString;
}
$(document)
  .ajaxStart(function () {
    $loading.addClass('is-active');
  })
  .ajaxStop(function () {
    $loading.removeClass('is-active');
  });

var handleForm = (function ($, parsley) {
  'use strict';
  var formName, submitBtnId, p;

  function setOptions(options) {
    formName = options.name;
    submitBtnId = options.submitBtnId;
    enableSelect();
  }
  function enableSelect() {
    var e = $('.getmdl-select');
    e.each(function () {
      addEventListeners(this);
    });
  }
  function addEventListeners(e) {
    var t = e.querySelector('input'),
      n = e.querySelectorAll('li');
    e.querySelector('i');
    [].forEach.call(n, function (e) {
      e.onclick = function () {
        t.value = e.textContent;
      };
    });
  }
  function disableSubmitBtn() {
    $('#' + submitBtnId + '').prop('disabled', true);
  }

  function createValidator() {
    p = $('form[name="' + formName + '"').parsley();
    return true;
  }

  function destroyValidator() {
    p.destroy();
  }

  function validateForm() {
    return p.validate();
  }

  function onValidateFormSuccess() {
    p.on('form:success',

      function () {});
  }
  function setAttributes(atr) {
    $('#street_el').val(atr.street_el);
    $('#street_en').val(atr.street_en);
  }
  function getAttributes() {
    var obj = {};
    createValidator();
    if (validateForm() === true) {
      $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-radio__button').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-selectfield__select').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      return obj;
    }
    else return null;
  }

  function resetForm() {
    if (createValidator() == true) {
      destroyValidator();
    }
    $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

      function (index, element) {
        $(this).val('');
        $(this).parent().eq(0).removeClass('is-dirty');
        $(this).parent().eq(0).removeClass('is-invalid');
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

      function (index, element) {
        $(this).prop('checked', false);
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox').each(

      function (index, element) {
        $(this).removeClass('is-checked');
      });
  }
  return {
    set: setOptions,
    get: getAttributes,
    clear: resetForm,
    setAttributes: setAttributes,
  // createValidator: createValidator,
  // destroyValidator: destroyValidator,
  // validateForm: validateForm,
  // onValidateFormSuccess: onValidateFormSuccess,
  // disableSubmitBtn: disableSubmitBtn
  };
}(jQuery, parsley));

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFkbWluLmpzIiwiaGFuZGxlRm9ybS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdjVCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFkbWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciAkbG9hZGluZyA9ICQoJy5tZGwtc3Bpbm5lcicpO1xyXG5cclxudmFyIGNlbnRlciA9IFszNjc3Mzg1LCA0MTIwOTQ5XTtcclxudmFyIGV4dGVudCA9IFszNTkwMDk0LCA0MTAyODMzLCAzODU1NDgzLCA0MjYxMjExXTtcclxudmFyIGxhbmcgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZztcclxudmFyIGdlb0pTT05Gb3JtYXQgPSBuZXcgb2wuZm9ybWF0Lkdlb0pTT04oe1xyXG4gIGRlZmF1bHREYXRhUHJvamVjdGlvbjogJ0VQU0c6NDMyNidcclxufSk7XHJcbnZhciBwcm9wZXJ0eVNvdXJjZTtcclxudmFyIHByb3BlcnR5O1xyXG52YXIgbWFwO1xyXG52YXIgZmVhdHVyZXM7XHJcbnZhciBkcmF3blByb3BlcnRpZXM7XHJcbnZhciBkcmF3O1xyXG52YXIgc2VsZWN0O1xyXG52YXIgdHJhbnNsYXRlO1xyXG52YXIgYmluZztcclxudmFyIG1hcGJveDtcclxudG9hc3RyLm9wdGlvbnMgPSB7XHJcbiAgY2xvc2VCdXR0b246IGZhbHNlLFxyXG4gIGRlYnVnOiBmYWxzZSxcclxuICBuZXdlc3RPblRvcDogZmFsc2UsXHJcbiAgcHJvZ3Jlc3NCYXI6IGZhbHNlLFxyXG4gIHBvc2l0aW9uQ2xhc3M6ICd0b2FzdC10b3AtY2VudGVyJyxcclxuICBwcmV2ZW50RHVwbGljYXRlczogZmFsc2UsXHJcbiAgb25jbGljazogbnVsbCxcclxuICBzaG93RHVyYXRpb246ICczMDAnLFxyXG4gIGhpZGVEdXJhdGlvbjogJzEwMDAnLFxyXG4gIHRpbWVPdXQ6ICc1MDAwJyxcclxuICBleHRlbmRlZFRpbWVPdXQ6ICcxMDAwJyxcclxuICBzaG93RWFzaW5nOiAnc3dpbmcnLFxyXG4gIGhpZGVFYXNpbmc6ICdsaW5lYXInLFxyXG4gIHNob3dNZXRob2Q6ICdmYWRlSW4nLFxyXG4gIGhpZGVNZXRob2Q6ICdmYWRlT3V0J1xyXG59O1xyXG5iaW5nID0gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gIHZpc2libGU6IHRydWUsXHJcbiAgc291cmNlOiBuZXcgb2wuc291cmNlLkJpbmdNYXBzKHtcclxuICAgIGtleTogJ0FrMkdxOFZVZklDc1BwdWY3TFJBTlhtWHQyc0hXbVNMUGhvaG1WTEZ0RklFd1lqc181TUN5QWhBRndSU1ZwTGonLFxyXG4gICAgaW1hZ2VyeVNldDogJ0FlcmlhbCdcclxuICB9KSxcclxuICBtYXhab29tOiAxOSxcclxuICBjcm9zc09yaWdpbjogJ2Fub255bW91cycsXHJcbiAgcHJlbG9hZDogSW5maW5pdHksXHJcbiAgaWQ6ICdiaW5nJ1xyXG59KTtcclxubWFwYm94ID0gbmV3IG9sLmxheWVyLlRpbGUoe1xyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5YWVooe1xyXG4gICAgYXR0cmlidXRpb25zOiBbbmV3IG9sLkF0dHJpYnV0aW9uKHtcclxuICAgICAgaHRtbDogJzxhIGhyZWY9XCJodHRwczovL3d3dy5tYXBib3guY29tL2Fib3V0L21hcHMvXCIgdGFyZ2V0PVwiX2JsYW5rXCI+JmNvcHk7IE1hcGJveCAmY29weTsgT3BlblN0cmVldE1hcDwvYT4nXHJcbiAgICB9KV0sXHJcbiAgICB1cmw6ICdodHRwczovL2FwaS5tYXBib3guY29tL3Y0L21hcGJveC5zdHJlZXRzL3t6fS97eH0ve3l9LnBuZz9hY2Nlc3NfdG9rZW49cGsuZXlKMUlqb2labWx5ZG1GcGJpSXNJbUVpT2lKbE9XWXlZVE0wTlRoaU5XTTBZakpqT0RKak5ERTRPRFF6TnpBMk1HUXlOaUo5Li1OVkRPMjdIenQtd19uUW9zVVBmTEEnXHJcbiAgfSksXHJcbiAgaWQ6ICdtYXBib3gnXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZ2V0SWNvblR5cGUoZXN0YXRlVHlwZSkge1xyXG4gIHZhciBpY29uVHlwZSA9IHtcclxuICAgIEFwYXJ0bWVudDogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJ2FwYXJ0bWVudCc7XHJcbiAgICB9LFxyXG4gICAgU3RvcmU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuICdzdG9yZSc7XHJcbiAgICB9LFxyXG4gICAgJ0RldGFjaGVkIEhvdXNlJzogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJ2RldGFjaGVkJztcclxuICAgIH0sXHJcbiAgICBNYWlzb25ldHRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHJldHVybiAnbWFpc29uZXR0ZSc7XHJcbiAgICB9LFxyXG4gICAgVmlsbGE6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuICd2aWxsYSc7XHJcbiAgICB9XHJcbiAgfTtcclxuICByZXR1cm4gKGljb25UeXBlW2VzdGF0ZVR5cGVdKSgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRJY29uUGF0aChsaXN0aW5nVHlwZSkge1xyXG4gIHZhciBpY29uUGF0aCA9IHtcclxuICAgIHRydWU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuICcuL2ltYWdlcy9waW5zL3NhbGUvJztcclxuICAgIH0sXHJcbiAgICBmYWxzZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvcmVudC8nO1xyXG4gICAgfSxcclxuICAgIG5vbmU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuICcuL2ltYWdlcy9waW5zL25vbmUvJztcclxuICAgIH1cclxuICB9O1xyXG4gIHJldHVybiAoaWNvblBhdGhbbGlzdGluZ1R5cGVdKSgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBQcm9wZXJ0eVN0eWxlKGZlYXR1cmUpIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9IGdldEljb25QYXRoKCdub25lJykgKyBnZXRJY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNDgucG5nJztcclxuICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICBzcmM6IHNyYyxcclxuICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICBhbmNob3I6IFtcclxuICAgICAgICAwLjUsIDBcclxuICAgICAgXSxcclxuICAgICAgc2NhbGU6IDFcclxuICAgIH0pKVxyXG4gIH0pO1xyXG59XHJcbnByb3BlcnR5U291cmNlID0gbmV3IG9sLnNvdXJjZS5WZWN0b3Ioe1xyXG4gIGZvcm1hdDogZ2VvSlNPTkZvcm1hdCxcclxuICBsb2FkZXI6IGZ1bmN0aW9uIChleHRlbnQsIHJlc29sdXRpb24sIHByb2plY3Rpb24pIHtcclxuICAgIHZhciB1cmwgPSAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3Byb3BlcnR5LycgKyBpZDtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIC8vIHNlbGYuY2xlYXIoKTtcclxuICAgICQuYWpheCh7XHJcbiAgICAgIHVybDogdXJsLFxyXG4gICAgICB0eXBlOiAnR0VUJyxcclxuICAgICAgYmVmb3JlU2VuZDogZnVuY3Rpb24gKHhocikge1xyXG4gICAgICAgIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlclRva2VuJykpIHtcclxuICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJUb2tlbicpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIGRhdGFUeXBlOiAnanNvbidcclxuICAgIH0pXHJcbiAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgdmFyIG5ld0ZlYXR1cmVzID0gZ2VvSlNPTkZvcm1hdC5yZWFkRmVhdHVyZXMoZGF0YSwge1xyXG4gICAgICAgIGZlYXR1cmVQcm9qZWN0aW9uOiAnRVBTRzozODU3J1xyXG4gICAgICB9KTtcclxuICAgICAgc2VsZi5hZGRGZWF0dXJlcyhuZXdGZWF0dXJlcyk7XHJcbiAgICB9KVxyXG4gICAgLmZhaWwoZnVuY3Rpb24gZmFpbGVkKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDA0KSB7XHJcbiAgICAgICAgdG9hc3RyLmVycm9yKCdTb3JyeSwgd2UgY2Fubm90IGZpbmQgdGhpcyBwcm9wZXJ0eSEnKTtcclxuICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcignU2VydmljZSBVbmF2YWlsYWJsZScpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0sXHJcbiAgc3RyYXRlZ3k6IG9sLmxvYWRpbmdzdHJhdGVneS5hbGxcclxufSk7XHJcbnByb3BlcnR5ID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgc291cmNlOiBwcm9wZXJ0eVNvdXJjZSxcclxuICBpZDogJ3Byb3BlcnR5JyxcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHN0eWxlOiBQcm9wZXJ0eVN0eWxlXHJcbn0pO1xyXG5wcm9wZXJ0eS5zZXRaSW5kZXgoMik7XHJcbm1hcCA9IG5ldyBvbC5NYXAoe1xyXG4gIHRhcmdldDogJ2FkbWluTWFwJyxcclxuICBsYXllcnM6IFtcclxuICAgIG1hcGJveCwgcHJvcGVydHlcclxuICBdLFxyXG4gIGxvYWRUaWxlc1doaWxlQW5pbWF0aW5nOiB0cnVlLFxyXG4gIGxvYWRUaWxlc1doaWxlSW50ZXJhY3Rpbmc6IHRydWUsXHJcbiAgcmVuZGVyZXI6ICdjYW52YXMnLFxyXG4gIGNvbnRyb2xzOiBvbC5jb250cm9sLmRlZmF1bHRzKHtcclxuICAgIGF0dHJpYnV0aW9uT3B0aW9uczoge1xyXG4gICAgICBjb2xsYXBzaWJsZTogZmFsc2UsXHJcbiAgICAgIGNvbGxhcHNlZDogZmFsc2VcclxuICAgIH1cclxuICB9KS5leHRlbmQoW1xyXG4gICAgbmV3IG9sLmNvbnRyb2wuU2NhbGVMaW5lKHtcclxuICAgICAgdW5pdHM6ICdtZXRyaWMnXHJcbiAgICB9KSxcclxuICAgIG5ldyBvbC5jb250cm9sLk92ZXJ2aWV3TWFwKHtcclxuICAgICAgY2xhc3NOYW1lOiAnb2wtb3ZlcnZpZXdtYXAgb2wtY3VzdG9tLW92ZXJ2aWV3bWFwJyxcclxuICAgICAgY29sbGFwc2libGU6IHRydWUsXHJcbiAgICAgIGNvbGxhcHNlZDogdHJ1ZSxcclxuICAgICAgbGF5ZXJzOiBbYmluZ11cclxuICAgIH0pLFxyXG4gICAgbmV3IG9sLmNvbnRyb2wuWm9vbVRvRXh0ZW50KHtcclxuICAgICAgZXh0ZW50OiBleHRlbnRcclxuICAgIH0pXHJcbiAgXSksXHJcbiAgdmlldzogbmV3IG9sLlZpZXcoe1xyXG4gICAgY2VudGVyOiBjZW50ZXIsXHJcbiAgICAvLyBleHRlbnQ6IGV4dGVudCxcclxuICAgIHByb2plY3Rpb246ICdFUFNHOjM4NTcnLFxyXG4gICAgem9vbTogMTQsXHJcbiAgICBtYXhab29tOiAxOSxcclxuICAgIG1pblpvb206IDEwXHJcbiAgfSlcclxufSk7XHJcbmlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgYmluZy5zZXQoJ25hbWUnLCAnzpTOv8+Bz4XPhs6/z4HOuc66zq4gzrXOuc66z4zOvc6xJyk7XHJcbiAgbWFwYm94LnNldCgnbmFtZScsICfOp86sz4HPhM63z4InKTtcclxuICBwcm9wZXJ0eS5zZXQoJ25hbWUnLCAnzpHOus6vzr3Ot8+EzrEnKTtcclxufSBlbHNlIHtcclxuICBiaW5nLnNldCgnbmFtZScsICdTYXR0ZWxpdGUgSW1hZ2UnKTtcclxuICBtYXBib3guc2V0KCduYW1lJywgJ01hcCcpO1xyXG4gIHByb3BlcnR5LnNldCgnbmFtZScsICdQcm9wZXJ0aWVzJyk7XHJcbn1cclxuLy8gPT09PT09IGludGVyYWN0aW9ucyA9PT09PT1cclxuZmVhdHVyZXMgPSBuZXcgb2wuQ29sbGVjdGlvbigpO1xyXG5cclxuZnVuY3Rpb24gZHJhd25Qcm9wZXJ0aWVzU3R5bGUoY29sb3IpIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9ICcuL2ltYWdlcy9waW5zL2dlbmVyaWMtNDgucG5nJztcclxuICBpZiAodHlwZW9mIGNvbG9yICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICAgIHNyYzogc3JjLFxyXG4gICAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgICBhbmNob3I6IFtcclxuICAgICAgICAgIDAuNSwgMFxyXG4gICAgICAgIF0sXHJcbiAgICAgICAgc2NhbGU6IDEsXHJcbiAgICAgICAgY29sb3I6IGNvbG9yXHJcbiAgICAgIH0pKVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogW1xyXG4gICAgICAgIDAuNSwgMFxyXG4gICAgICBdLFxyXG4gICAgICBzY2FsZTogMVxyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxuZHJhd25Qcm9wZXJ0aWVzID0gbmV3IG9sLmxheWVyLlZlY3Rvcih7XHJcbiAgc291cmNlOiBuZXcgb2wuc291cmNlLlZlY3RvcigpLFxyXG4gIGlkOiAnZHJhd25Qcm9wZXJ0aWVzJyxcclxuICBzdHlsZTogZHJhd25Qcm9wZXJ0aWVzU3R5bGUoJyM0Y2FmNTAnKVxyXG59KTtcclxubWFwLmFkZExheWVyKGRyYXduUHJvcGVydGllcyk7XHJcbi8vIGRyYXdcclxuZHJhdyA9IG5ldyBvbC5pbnRlcmFjdGlvbi5EcmF3KHtcclxuICAvLyBmZWF0dXJlczogZmVhdHVyZXMsXHJcbiAgc291cmNlOiBkcmF3blByb3BlcnRpZXMuZ2V0U291cmNlKCksXHJcbiAgdHlwZTogJ1BvaW50JyxcclxuICBzdHlsZTogZHJhd25Qcm9wZXJ0aWVzU3R5bGUoJyM0Y2FmNTAnKVxyXG59KTtcclxubWFwLmFkZEludGVyYWN0aW9uKGRyYXcpO1xyXG5kcmF3LnNldEFjdGl2ZShmYWxzZSk7XHJcbi8vIHNlbGVjdFxyXG5mdW5jdGlvbiBzZWxlY3RlZFN0eWxlKGZlYXR1cmUpIHtcclxuICB2YXIgc3JjO1xyXG4gIHNyYyA9IGdldEljb25QYXRoKCdub25lJykgKyBnZXRJY29uVHlwZShmZWF0dXJlLmdldCgnZXN0YXRldHlwZV9lbicpKSArICctNjQucG5nJztcclxuICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICBzcmM6IHNyYyxcclxuICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICBhbmNob3I6IFswLjUsIDBdLFxyXG4gICAgICBzY2FsZTogMSxcclxuICAgICAgY29sb3I6ICcjZmZlYjNiJ1xyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxuc2VsZWN0ID0gbmV3IG9sLmludGVyYWN0aW9uLlNlbGVjdCh7XHJcbiAgbGF5ZXJzOiBbcHJvcGVydHldLFxyXG4gIGZlYXR1cmVzOiBmZWF0dXJlcyxcclxuICBtdWx0aTogZmFsc2UsXHJcbiAgc3R5bGU6IHNlbGVjdGVkU3R5bGVcclxufSk7XHJcbm1hcC5hZGRJbnRlcmFjdGlvbihzZWxlY3QpO1xyXG5zZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxudHJhbnNsYXRlID0gbmV3IG9sLmludGVyYWN0aW9uLlRyYW5zbGF0ZSh7XHJcbiAgZmVhdHVyZXM6IHNlbGVjdC5nZXRGZWF0dXJlcygpXHJcbn0pO1xyXG5tYXAuYWRkSW50ZXJhY3Rpb24odHJhbnNsYXRlKTtcclxudHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbi8vID09PT09PSBpbmZvID09PT09PVxyXG5tYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuXHJcbmZ1bmN0aW9uIGNsaWNrSW5mbyhldmVudCkge1xyXG4gIHZhciBvYmogPSB7fTtcclxuXHJcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICBzZWxlY3Quc2V0QWN0aXZlKHRydWUpO1xyXG4gIHNlbGVjdC5vbmNlKCdzZWxlY3QnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZXMgPSBlLnNlbGVjdGVkO1xyXG4gICAgdmFyIGxlbmd0aCA9IHNlbGVjdGVkRmVhdHVyZXMubGVuZ3RoO1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZTtcclxuICAgIGlmIChsZW5ndGggPT09IDEpIHtcclxuICAgICAgb2JqLmZlYXR1cmUgPSB7fTtcclxuICAgICAgc2VsZWN0ZWRGZWF0dXJlID0gXy5oZWFkKGUuc2VsZWN0ZWQpO1xyXG4gICAgICAvLyBjbGlja2VkRmVhdHVyZS5mZWF0dXJlLnNldFNjYWxlKDEuMik7XHJcbiAgICAgIHNlbGVjdGVkRmVhdHVyZS5nZXRLZXlzKCkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgb2JqLmZlYXR1cmVba2V5XSA9IHNlbGVjdGVkRmVhdHVyZS5nZXQoa2V5KTtcclxuICAgICAgfSk7XHJcbiAgICAgIGR1c3QucmVuZGVyKCdhZG1pblByb3BlcnR5SW5mbycsIG9iaiwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICAgJCgnLnByb3BlcnR5LWluZm8nKS5odG1sKG91dCk7XHJcbiAgICAgICAgJCgnLnByb3BlcnR5LWluZm8nKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgICAkKCcjbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgdmFyIGdpZDtcclxuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICBnaWQgPSAkKHRoaXMpLmRhdGEoJ2dpZCcpO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcclxuICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBnaWQ6IGdpZCxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZShmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgIHZhciBsaXN0aW5nX2lkID0gZGF0YS5pZDtcclxuICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuY3NzKCd3aWR0aCcsICdhdXRvJyk7XHJcbiAgICAgICAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgIGR1c3QucmVuZGVyKCdsaXN0aW5nSW5zZXJ0JywgZGF0YSwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICAgICAgICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5zZXQoe1xyXG4gICAgICAgICAgICAgICAgICBuYW1lOiAnaW5zZXJ0LXVwZGF0ZS1saXN0aW5nJyxcclxuICAgICAgICAgICAgICAgICAgc3VibWl0QnRuSWQ6ICdvaycsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmICgkKCdpbnB1dFtuYW1lPW9wdGlvbnNdOmNoZWNrZWQnKS52YWwoKSA9PT0gJ1NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucGFyZW50KCkuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAkKCdpbnB1dFtuYW1lPW9wdGlvbnNdJykub24oJ2NoYW5nZScsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ1NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnBhcmVudCgpLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCdsYWJlbFtmb3I9cGV0c10nKS5yZW1vdmVDbGFzcygnaXMtY2hlY2tlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnZhbCgnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnBhcmVudCgpLnNob3coKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wYXJlbnQoKS5zaG93KCk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgJCgnI3NlbnQtbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICB2YXIgZGF0YTtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgZGF0YSA9IGhhbmRsZUZvcm0uZ2V0KCk7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wcm9wZXJ0eV9naWQgPSBnaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5saXN0aW5nX2lkID0gbGlzdGluZ19pZDtcclxuICAgICAgICAgICAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdQVVQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnXHJcbiAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgLmRvbmUoZnVuY3Rpb24gKGRhdGEsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSBVcGRhdGVkIEluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdPb3BzIFNvbWV0aGluZyBXZW50IFdyb25nISEhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAuZmFpbChmdW5jdGlvbiAoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAkKCcjY2FuY2VsLWxpc3RpbmcnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICB2YXIgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgaWYgKGxhbmcgPT09ICdlbCcpIHtcclxuICAgICAgICAgICAgICAgIG9iai5tc2cgPSAnzpTOtc69IM6Sz4HOrc64zrfOus61IM6RzrPOs861zrvOr86xJztcclxuICAgICAgICAgICAgICAgIG9iai50ZXh0ID0gJ86UzrfOvM65zr/Phc+BzrPOr86xIM6azrHOuc69zr/Pjc+BzrPOuc6xz4I7JztcclxuICAgICAgICAgICAgICAgIG9iai55ZXMgPSAnzp3Okc6ZJztcclxuICAgICAgICAgICAgICAgIG9iai5ubyA9ICfOn86nzpknO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBvYmoubXNnID0gJ05vIExpc3RpbmcgRm91bmQnO1xyXG4gICAgICAgICAgICAgICAgb2JqLnRleHQgPSAnQ3JlYXRlIE5ldyBMaXN0aW5nPyc7XHJcbiAgICAgICAgICAgICAgICBvYmoueWVzID0gJ1lFUyc7XHJcbiAgICAgICAgICAgICAgICBvYmoubm8gPSAnTk8nO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBkdXN0LnJlbmRlcignZGlhbG9nJywgb2JqLCBmdW5jdGlvbiAoZXJyb3IsIG91dCkge1xyXG4gICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmNzcygnd2lkdGgnLCAnYXV0bycpO1xyXG4gICAgICAgICAgICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgICAgICAgICAgICQoJyN5ZXMnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgZHVzdC5yZW5kZXIoJ2xpc3RpbmdJbnNlcnQnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVudDogJ3RydWUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFkZEltYWdlOiAndHJ1ZScsXHJcbiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIsIG91dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBteURyb3B6b25lO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEhhbmRsZXIudXBncmFkZURvbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIG15RHJvcHpvbmUgPSBuZXcgRHJvcHpvbmUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Ryb3B6b25lJyksIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZE11bHRpcGxlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgIGFjY2VwdGVkRmlsZXM6ICcuanBnJyxcclxuICAgICAgICAgICAgICAgICAgICAgIHBhcmFsbGVsVXBsb2FkczogNixcclxuICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZFJlbW92ZUxpbmtzIDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vYXBpLmNsb3VkaW5hcnkuY29tL3YxXzEvZmlydmFpbi9hdXRvL3VwbG9hZCdcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBteURyb3B6b25lLm9uKCdzZW5kaW5nJywgZnVuY3Rpb24gKGZpbGUsIHhociwgZm9ybURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYXBpX2tleScsIDM3NTEzODkzMjY4OTU5MSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2NhbGxiYWNrJywgJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9wdWJsaWMvY2xvdWRpbmFyeV9jb3JzLmh0bWwnKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgndXBsb2FkX3ByZXNldCcsICd0ZXN0dXBsb2FkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3B1YmxpY19pZCcsIGdpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbXlEcm9wem9uZS5vbignc3VjY2VzcycsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uc2V0KHtcclxuICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdpbnNlcnQtdXBkYXRlLWxpc3RpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgc3VibWl0QnRuSWQ6ICdvaydcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAkKCdpbnB1dFtuYW1lPWZpbGVdJykuY2xvdWRpbmFyeV9maWxldXBsb2FkKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gJCgnaW5wdXRbbmFtZT1maWxlXScpLnVuc2lnbmVkX2Nsb3VkaW5hcnlfdXBsb2FkKCd0ZXN0dXBsb2FkJywge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgY2xvdWRfbmFtZTogJ2ZpcnZhaW4nLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgJ3B1YmxpY19pZCc6IGdpZCxcclxuICAgICAgICAgICAgICAgICAgICAvLyB9KTtcclxuICAgICAgICAgICAgICAgICAgICAkKCdpbnB1dFtuYW1lPW9wdGlvbnNdJykub24oJ2NoYW5nZScsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICdTYWxlJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnbGFiZWxbZm9yPXBldHNdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykudmFsKCcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjc2VudC1saXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gaGFuZGxlRm9ybS5nZXQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHJvcGVydHlfZ2lkID0gZ2lkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpxWEhSLnN0YXR1cyA9PT0gMjAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCdQcm9wZXJ0eSBVcGRhdGVkIEluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ09vcHMgU29tZXRoaW5nIFdlbnQgV3JvbmchISEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI2NhbmNlbC1saXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgJCgnI25vJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgLy8gc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICQoJy5wcm9wZXJ0eS1pbmZvJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgIHRvYXN0ci5lcnJvcignQ2FudCBGaW5kIEFueSBQcm9wZXJ0eSBUaGVyZS4uLicpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcbi8vID09PT09PSBsb2dvdXQgPT09PT09XHJcbiQoJyNsb2dvdXQnKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgbG9jYXRpb24uaHJlZiA9ICcvbWFwL2xvZ291dCc7XHJcbn0pO1xyXG4vLyA9PT09PT0gaW5zZXJ0ID09PT09PVxyXG4kKCcjaW5zZXJ0UHJvcGVydHknKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIG9uRW5kRHJhdztcclxuICB0b2FzdHIuY2xlYXIoKTtcclxuICAkKCcucHJvcGVydHktaW5mbycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gIG1hcC51bignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgZHJhdy5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgb25FbmREcmF3ID0gZHJhdy5vbignZHJhd2VuZCcsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgdmFyIGNvb3JkcztcclxuICAgIHZhciBnZW9jb2RlT2JqO1xyXG4gICAgdmFyIGxhdGxuZztcclxuICAgIHZhciBnZW9jb2RlTmFtZV9lbDtcclxuICAgIHZhciBnZW9jb2RlTmFtZV9lbjtcclxuICAgIHZhciBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgY29vcmRzID0gb2wucHJvai50cmFuc2Zvcm0oZXZlbnQuZmVhdHVyZS5nZXRHZW9tZXRyeSgpLmdldENvb3JkaW5hdGVzKCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICBvYmouY29vcmRzID0gY29vcmRzO1xyXG4gICAgbGF0bG5nID0gY29vcmRzWzFdICsgJ1xcLCcgKyBjb29yZHNbMF07XHJcbiAgICBnZW9jb2RlT2JqID0gJC5nZXRKU09OKCdodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvZ2VvY29kZS9qc29uJywge1xyXG4gICAgICBsYXRsbmc6IGxhdGxuZyxcclxuICAgICAga2V5OiAnQUl6YVN5Q2tIMzlfRXoyMV9SbENfcGpYRDA5enBKXyAtIGVWaHpDclEnLFxyXG4gICAgfSwgZnVuY3Rpb24gKGpzb24sIHRleHRTdGF0dXMpIHtcclxuICAgICAgcmV0dXJuIGpzb247XHJcbiAgICB9KTtcclxuICAgIGdlb2NvZGVPYmoudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGdlb2NvZGVOYW1lX2VsID0gXy5oZWFkKF8uaGVhZChnZW9jb2RlT2JqLnJlc3BvbnNlSlNPTi5yZXN1bHRzKS5hZGRyZXNzX2NvbXBvbmVudHMpLmxvbmdfbmFtZTtcclxuICAgICAgZ2VvY29kZU5hbWVfZW4gPSBzdHJpbmdfZWxfdG9fdXJsKGdlb2NvZGVOYW1lX2VsKTtcclxuICAgICAgb2JqLnN0cmVldF9lbCA9IGdlb2NvZGVOYW1lX2VsO1xyXG4gICAgICBvYmouc3RyZWV0X2VuID0gZ2VvY29kZU5hbWVfZW47XHJcbiAgICAgIGdlb2NvZGVBcmVhTmFtZSA9IF8uZmlyc3QoXy5kcm9wKF8ubWFwKF8uaGVhZChnZW9jb2RlT2JqLnJlc3BvbnNlSlNPTi5yZXN1bHRzKS5hZGRyZXNzX2NvbXBvbmVudHMsICdsb25nX25hbWUnKSkpO1xyXG4gICAgICBvYmouYXJlYV9uYW1lID0gZ2VvY29kZUFyZWFOYW1lO1xyXG4gICAgICBkYXRhRm9ybShvYmopO1xyXG4gICAgfSk7XHJcblxyXG4gIH0pO1xyXG5cclxuICBmdW5jdGlvbiBkYXRhRm9ybShvYmopIHtcclxuICAgICQoJy5tb2RhbC1kaWFsb2cnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgIGR1c3QucmVuZGVyKCdwcm9wZXJ0eUluc2VydCcsIG9iaiwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgaGFuZGxlRm9ybS5zZXQoe1xyXG4gICAgICAgIG5hbWU6ICdpbnNlcnRQcm9wZXJ0eScsXHJcbiAgICAgICAgc3VibWl0QnRuSWQ6ICdpbnNlcnQnXHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjZXN0YXRlVHlwZScpLmNoYW5nZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnRGV0YWNoZWQgSG91c2UnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnRGV0YWNoZWQgSG91c2UnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzpTOuc6xzrzOrc+BzrnPg868zrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICfOiM+AzrHPhc67zrcnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnVmlsbGEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnVmlsbGEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdNYWlzb25ldHRlJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ01haXNvbmV0dGUnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLmNoYW5nZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICdEZXRhY2hlZCBIb3VzZScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpzOv869zr/Ous6xz4TOv865zrrOr86xJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0FwYXJ0bWVudCcpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICdWaWxsYScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOiM+AzrHPhc67zrcnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzojPgM6xz4XOu863Jyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpzOtc62zr/Ovc6tz4TOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOnM61zrbOv869zq3PhM6xJyk7XHJcblxyXG5cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjY2FuY2VsSW5zZXJ0Jykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgZHJhd25Qcm9wZXJ0aWVzLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgZHJhdy51bkJ5S2V5KG9uRW5kRHJhdyk7XHJcbiAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2luc2VydCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBkYXRhO1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgZGF0YSA9IGhhbmRsZUZvcm0uZ2V0KCk7XHJcbiAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHtcclxuICAgICAgICAgIGRhdGEueCA9IG9iai5jb29yZHNbMF07XHJcbiAgICAgICAgICBkYXRhLnkgPSBvYmouY29vcmRzWzFdO1xyXG4gICAgICAgICAgZGF0YS5hZG1pbklkID0gaWQ7XHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHknLFxyXG4gICAgICAgICAgICB0eXBlOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGFcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQoKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgUmVjb3JkZWQgSW4gRGF0YWJhc2UnKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCB0aGlzIHByb3BlcnR5IScpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICBkcmF3blByb3BlcnRpZXMuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICBkcmF3LnVuQnlLZXkob25FbmREcmF3KTtcclxuICAgICAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn0pO1xyXG4vLyA9PT09PT0gZGVsZXRlID09PT09PVxyXG4kKCcjZGVsZXRlUHJvcGVydHknKS5jbGljayhmdW5jdGlvbiAoZXZlbnQpIHtcclxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIHRvYXN0ci5jbGVhcigpO1xyXG4gICQoJy5wcm9wZXJ0eS1pbmZvJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgbWFwLnVuKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gIGZlYXR1cmVzLmNsZWFyKCk7XHJcbiAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gIHNlbGVjdC5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgc2VsZWN0Lm9uY2UoJ3NlbGVjdCcsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICB2YXIgJHRvYXN0O1xyXG4gICAgaWYgKGUudGFyZ2V0LmdldEZlYXR1cmVzKCkuZ2V0TGVuZ3RoKCkgPT09IDEpIHtcclxuICAgICAgJHRvYXN0ID0gdG9hc3RyLndhcm5pbmcoJzxwPkFyZSB5b3Ugc3VyZT88L3A+PGRpdiBjbGFzcz1cInRvYXN0ci1idG5zXCI+PGJ1dHRvbiBpZD1cInllc0RlbGV0ZVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uIFwiPlllczwvYnV0dG9uPjxidXR0b24gaWQ9XCJub0RlbGV0ZVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uXCI+Tm88L2J1dHRvbj48L2Rpdj4nKTtcclxuICAgICAgJHRvYXN0Lm9uKCdjbGljaycsICcjeWVzRGVsZXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBnaWQgPSBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5pdGVtKDApLmdldCgnZ2lkJyk7XHJcbiAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9wcm9wZXJ0eScsXHJcbiAgICAgICAgICB0eXBlOiAnREVMRVRFJyxcclxuICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgIGdpZDogZ2lkXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoJ1Byb3BlcnR5IFN1Y2Nlc3NmdWxseSBEZWxldGVkIHdpdGggaWQgPSAnICsgZGF0YS5wcm9wZXJ0eWdpZCArICcgZnJvbSBEYXRhYmFzZScpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIHRoaXMgcHJvcGVydHkhJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiBhbHdheXMoKSB7XHJcbiAgICAgICAgICAgIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkdG9hc3QucmVtb3ZlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICAkdG9hc3Qub24oJ2NsaWNrJywgJyNub0RlbGV0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAkdG9hc3QucmVtb3ZlKCk7XHJcbiAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuLy8gPT09PT09IHVwZGF0ZSA9PT09PT1cclxuXHJcbiQoJyN1cGRhdGVQcm9wZXJ0eScpLm9uKCdjbGljaycsIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnR5KGV2ZW50KSB7XHJcbiAgdmFyIGdpZDtcclxuICB2YXIgb2JqO1xyXG4gIHZhciBjb29yZHM7XHJcbiAgdmFyIG9uRW5kVHJhbnNsdGU7XHJcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICB0b2FzdHIuY2xlYXIoKTtcclxuICBtYXAudW4oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICBkcmF3LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgZmVhdHVyZXMuY2xlYXIoKTtcclxuICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgc2VsZWN0LnNldEFjdGl2ZSh0cnVlKTtcclxuICAkKCcucHJvcGVydHktaW5mbycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gIHNlbGVjdC5vbmNlKCdzZWxlY3QnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZXMgPSBlLnNlbGVjdGVkO1xyXG4gICAgdmFyIGxlbmd0aCA9IHNlbGVjdGVkRmVhdHVyZXMubGVuZ3RoO1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZTtcclxuICAgIGlmIChsZW5ndGggPT09IDEpIHtcclxuICAgICAgZ2lkID0gXy5oZWFkKGUuc2VsZWN0ZWQpLmdldCgnZ2lkJyk7XHJcbiAgICAgIHNlbGVjdGVkRmVhdHVyZSA9IF8uaGVhZChlLnNlbGVjdGVkKTtcclxuICAgICAgY29vcmRzID0gb2wucHJvai50cmFuc2Zvcm0oc2VsZWN0ZWRGZWF0dXJlLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHknLFxyXG4gICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgZ2lkOiBnaWRcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgICAgLmRvbmUoZnVuY3Rpb24gY29tcGxldGVkKGRhdGEpIHtcclxuICAgICAgICAgIHZhciAkdG9hc3QgPSB7fTtcclxuICAgICAgICAgICR0b2FzdC5vcHRpb25zID0ge307XHJcbiAgICAgICAgICBvYmogPSBfLmhlYWQoZGF0YS5mZWF0dXJlcykucHJvcGVydGllcztcclxuICAgICAgICAgIGNvbnNvbGUubG9nKG9iailcclxuXHJcbiAgICAgICAgICAkdG9hc3QgPSB0b2FzdHIud2FybmluZygnPHA+Q2hhbmdlIFByb3BlcnR5IENvb3JkaW5hdGVzPzwvcD48ZGl2IGNsYXNzPVwidG9hc3RyLWJ0bnNcIj48YnV0dG9uIGlkPVwieWVzQ2hhbmdlWFlcIiBjbGFzcz1cIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvbiBcIj5ZZXM8L2J1dHRvbj48YnV0dG9uIGlkPVwibm9DaGFuZ2VYWVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uXCI+Tm88L2J1dHRvbj48L2Rpdj4nKTtcclxuICAgICAgICAgICR0b2FzdC5vbignY2xpY2snLCAnI3llc0NoYW5nZVhZJywgZnVuY3Rpb24geWVzQ2hhbmdlWFkoKSB7XHJcbiAgICAgICAgICAgIHZhciBsYXRsbmc7XHJcbiAgICAgICAgICAgIHZhciBnZW9jb2RlT2JqO1xyXG4gICAgICAgICAgICB2YXIgZ2VvY29kZU5hbWVFbDtcclxuICAgICAgICAgICAgdmFyIGdlb2NvZGVOYW1lRW47XHJcbiAgICAgICAgICAgIHZhciBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICAgICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIG9uRW5kVHJhbnNsdGUgPSB0cmFuc2xhdGUub24oJ3RyYW5zbGF0ZWVuZCcsIGZ1bmN0aW9uIHRyYW5zbGF0ZUVuZChlKSB7XHJcbiAgICAgICAgICAgICAgLy8gdmFyIGdlb2NvZGVPYmo7XHJcbiAgICAgICAgICAgICAgY29vcmRzID0gb2wucHJvai50cmFuc2Zvcm0oZS5mZWF0dXJlcy5pdGVtKDApLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgICAgICAgICAgICBsYXRsbmcgPSBjb29yZHNbMV0gKyAnXFwsJyArIGNvb3Jkc1swXTtcclxuICAgICAgICAgICAgICBnZW9jb2RlT2JqID0gJC5nZXRKU09OKCdodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvZ2VvY29kZS9qc29uJywge1xyXG4gICAgICAgICAgICAgICAgbGF0bG5nOiBsYXRsbmcsXHJcbiAgICAgICAgICAgICAgICBrZXk6ICdBSXphU3lDa0gzOV9FejIxX1JsQ19walhEMDl6cEpfIC0gZVZoekNyUSdcclxuICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoanNvbiwgdGV4dFN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ucmVzdWx0cztcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICBnZW9jb2RlT2JqLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgZ2VvY29kZU5hbWVFbCA9IF8uaGVhZChfLmhlYWQoZ2VvY29kZU9iai5yZXNwb25zZUpTT04ucmVzdWx0cykuYWRkcmVzc19jb21wb25lbnRzKS5sb25nX25hbWU7XHJcbiAgICAgICAgICAgICAgICBnZW9jb2RlTmFtZUVuID0gc3RyaW5nX2VsX3RvX3VybChnZW9jb2RlTmFtZUVsKTtcclxuICAgICAgICAgICAgICAgIG9iai5zdHJlZXRfZWwgPSBnZW9jb2RlTmFtZUVsO1xyXG4gICAgICAgICAgICAgICAgb2JqLnN0cmVldF9lbiA9IGdlb2NvZGVOYW1lRW47XHJcbiAgICAgICAgICAgICAgICBnZW9jb2RlQXJlYU5hbWUgPSBfLmZpcnN0KF8uZHJvcChfLm1hcChfLmhlYWQoZ2VvY29kZU9iai5yZXNwb25zZUpTT04ucmVzdWx0cykuYWRkcmVzc19jb21wb25lbnRzLCAnbG9uZ19uYW1lJykpKTtcclxuICAgICAgICAgICAgICAgIG9iai5hcmVhX25hbWUgPSBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICAgICAgICAgICAgICBkYXRhRm9ybShvYmosIGNvb3Jkcyk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICAkdG9hc3Qub24oJ2NsaWNrJywgJyNub0NoYW5nZVhZJywgZnVuY3Rpb24gbm9DaGFuZ2VYWSgpIHtcclxuICAgICAgICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICBkYXRhRm9ybShvYmosIGNvb3Jkcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZCgpIHtcclxuICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBmdW5jdGlvbiBkYXRhRm9ybShvYmosIGNvb3Jkcykge1xyXG4gICAgJCgnLm1vZGFsLWRpYWxvZycpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgZHVzdC5yZW5kZXIoJ3Byb3BlcnR5VXBkYXRlJywgb2JqLCBmdW5jdGlvbiByZW5kZXJQcm9wZXJ0eVVwZGF0ZShlcnIsIG91dCkge1xyXG4gICAgICB2YXIgb2xkVmFsdWVzID0ge307XHJcbiAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICBvbGRWYWx1ZXMuYmVkcm9vbXMgPSAkKCcjYmVkcm9vbXMnKS52YWwoKTtcclxuICAgICAgb2xkVmFsdWVzLnN0cmVldF9lbiA9ICQoJyNzdHJlZXRfZW4nKS52YWwoKTtcclxuICAgICAgb2xkVmFsdWVzLnN0cmVldF9lbCA9ICQoJyNzdHJlZXRfZWwnKS52YWwoKTtcclxuICAgICAgb2xkVmFsdWVzLmFyZWFfbmFtZSA9ICQoJyNhcmVhX25hbWUnKS52YWwoKTtcclxuICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgIGhhbmRsZUZvcm0uc2V0KHtcclxuICAgICAgICBuYW1lOiAndXBkYXRlUHJvcGVydHknLFxyXG4gICAgICAgIHN1Ym1pdEJ0bklkOiAndXBkYXRlJ1xyXG4gICAgICB9KTtcclxuICAgICAgLy8gJCgnI3N0cmVldF9lbCcpLnZhbChvYmouZ2VvY29kZU5hbWVfZWwpO1xyXG4gICAgICAvLyAkKCcjc3RyZWV0X2VuJykudmFsKG9iai5nZW9jb2RlTmFtZV9lbik7XHJcbiAgICAgICQoJyNlc3RhdGVUeXBlJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdEZXRhY2hlZCBIb3VzZScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdEZXRhY2hlZCBIb3VzZScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzpTOuc6xzrzOrc+BzrnPg868zrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzojPgM6xz4XOu863Jykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ1ZpbGxhJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ1ZpbGxhJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ01haXNvbmV0dGUnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnTWFpc29uZXR0ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0RldGFjaGVkIEhvdXNlJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0FwYXJ0bWVudCcpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnVmlsbGEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzojPgM6xz4XOu863Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86Iz4DOsc+FzrvOtycpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOnM61zrbOv869zq3PhM6xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86czrXOts6/zr3Orc+EzrEnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjdXBkYXRlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gdXBkYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIGRhdGE7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBkYXRhID0gaGFuZGxlRm9ybS5nZXQoKTtcclxuICAgICAgICBpZiAoIV8uaXNOaWwoZGF0YSkpIHtcclxuICAgICAgICAgIGRhdGEueCA9IGNvb3Jkc1swXTtcclxuICAgICAgICAgIGRhdGEueSA9IGNvb3Jkc1sxXTtcclxuICAgICAgICAgIGRhdGEuZ2lkID0gZ2lkO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3Byb3BlcnR5JyxcclxuICAgICAgICAgICAgdHlwZTogJ1BVVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGFcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZChyZXNwb25zZSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgd2l0aCBnaWQgJyArIHJlc3BvbnNlLnByb3BlcnR5Z2lkICsgJyBVcGRhdGVkIGluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIHRoaXMgcHJvcGVydHkhJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuYWx3YXlzKGZ1bmN0aW9uIGFsd2F5cygpIHtcclxuICAgICAgICAgICAgICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgdHJhbnNsYXRlLnVuQnlLZXkob25FbmRUcmFuc2x0ZSk7XHJcbiAgICAgICAgICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgICAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjY2FuY2VsVXBkYXRlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gY2FuY2VsVXBkYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgIHRyYW5zbGF0ZS51bkJ5S2V5KG9uRW5kVHJhbnNsdGUpO1xyXG4gICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICAgICQoJy5tb2RhbC1kaWFsb2cnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gICQoJyNhZG1pbk1hcCcpLnJlbW92ZUF0dHIoJ3N0eWxlJyk7XHJcbn0pO1xyXG4kKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7XHJcbiAgd2luZG93LlBhcnNsZXkub24oJ2ZpZWxkOmVycm9yJywgZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gVGhpcyBnbG9iYWwgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgZm9yIGFueSBmaWVsZCB0aGF0IGZhaWxzIHZhbGlkYXRpb24uXHJcbiAgICBjb25zb2xlLmxvZygnVmFsaWRhdGlvbiBmYWlsZWQgZm9yOiAnLCB0aGlzLiRlbGVtZW50KTtcclxuICB9KTtcclxuICB3aW5kb3cuUGFyc2xleVxyXG4gICAgLmFkZFZhbGlkYXRvcignZGF0ZScsIHtcclxuICAgICAgcmVxdWlyZW1lbnRUeXBlOiAnc3RyaW5nJyxcclxuICAgICAgdmFsaWRhdGVTdHJpbmc6IGZ1bmN0aW9uICh2YWx1ZSwgcmVxdWlyZW1lbnQpIHtcclxuICAgICAgICBpZiAobW9tZW50KHZhbHVlLCAnREQtTU0tWVlZWScsIHRydWUpLmlzVmFsaWQoKSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSxcclxuICAgICAgbWVzc2FnZXM6IHtcclxuICAgICAgICBlbjogJ1dyb25nIERhdGUnLFxyXG4gICAgICAgIGVsOiAnzpvOrM64zr/PgiDOl868zrXPgc6/zrzOt869zq/OsSdcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gc3RyaW5nX2VsX3RvX3VybChzdHJpbmcpIHtcclxuICB2YXIgb3JpZ2luYWxTdHJpbmcgPSBzdHJpbmc7XHJcbiAgdmFyIG5ld1N0cmluZztcclxuICB2YXIgcmVwbGFjZSA9IG5ldyBBcnJheSgnzrEnLCAnzqwnLCAnzoYnLCAnzpEnLCAnzrInLCAnzpInLCAnzrMnLCAnzpMnLCAnzrQnLCAnzpQnLCAnzrUnLCAnzq0nLCAnzpUnLCAnzognLCAnzrYnLCAnzpYnLCAnzrcnLCAnzq4nLCAnzpcnLCAnzrgnLCAnzpgnLCAnzrknLCAnzq8nLCAnz4onLCAnzpAnLCAnzpknLCAnzoonLCAnzronLCAnzponLCAnzrsnLCAnzpsnLCAnzrwnLCAnzpwnLCAnzr0nLCAnzp0nLCAnzr4nLCAnzp4nLCAnzr8nLCAnz4wnLCAnzp8nLCAnzownLCAnz4AnLCAnzqAnLCAnz4EnLCAnzqEnLCAnz4MnLCAnz4InLCAnzqMnLCAnz4QnLCAnzqQnLCAnz4UnLCAnz40nLCAnzqUnLCAnzo4nLCAnz4YnLCAnzqYnLCAnz4cnLCAnzqcnLCAnz4gnLCAnzqgnLCAnz4knLCAnz44nLCAnzqknLCAnzo8nLCAnICcsICdcXCcnLCAnXFwnJywgJywnKTtcclxuICB2YXIgcmVwbGFjZV9uID0gbmV3IEFycmF5KCdhJywgJ2EnLCAnQScsICdBJywgJ3YnLCAnVicsICdnJywgJ0cnLCAnZCcsICdEJywgJ2UnLCAnZScsICdFJywgJ0UnLCAneicsICdaJywgJ2knLCAnaScsICdJJywgJ3RoJywgJ1RoJywgJ2knLCAnaScsICdpJywgJ2knLCAnSScsICdJJywgJ2snLCAnSycsICdsJywgJ0wnLCAnbScsICdNJywgJ24nLCAnTicsICd4JywgJ1gnLCAnbycsICdvJywgJ08nLCAnTycsICdwJywgJ1AnLCAncicsICdSJywgJ3MnLCAncycsICdTJywgJ3QnLCAnVCcsICd1JywgJ3UnLCAnWScsICdZJywgJ2YnLCAnRicsICdjaCcsICdDaCcsICdwcycsICdQcycsICdvJywgJ28nLCAnTycsICdPJywgJyAnLCAnXycsICdfJywgJ18nKTtcclxuXHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXBsYWNlLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBvcmlnaW5hbFN0cmluZyA9IG9yaWdpbmFsU3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cChyZXBsYWNlW2ldLCAnZycpLCByZXBsYWNlX25baV0pO1xyXG4gIH1cclxuICBuZXdTdHJpbmcgPSBvcmlnaW5hbFN0cmluZztcclxuICByZXR1cm4gbmV3U3RyaW5nO1xyXG59XHJcbiQoZG9jdW1lbnQpXHJcbiAgLmFqYXhTdGFydChmdW5jdGlvbiAoKSB7XHJcbiAgICAkbG9hZGluZy5hZGRDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSlcclxuICAuYWpheFN0b3AoZnVuY3Rpb24gKCkge1xyXG4gICAgJGxvYWRpbmcucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIH0pO1xyXG4iLCJ2YXIgaGFuZGxlRm9ybSA9IChmdW5jdGlvbiAoJCwgcGFyc2xleSkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgZm9ybU5hbWUsIHN1Ym1pdEJ0bklkLCBwO1xyXG5cclxuICBmdW5jdGlvbiBzZXRPcHRpb25zKG9wdGlvbnMpIHtcclxuICAgIGZvcm1OYW1lID0gb3B0aW9ucy5uYW1lO1xyXG4gICAgc3VibWl0QnRuSWQgPSBvcHRpb25zLnN1Ym1pdEJ0bklkO1xyXG4gICAgZW5hYmxlU2VsZWN0KCk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGVuYWJsZVNlbGVjdCgpIHtcclxuICAgIHZhciBlID0gJCgnLmdldG1kbC1zZWxlY3QnKTtcclxuICAgIGUuZWFjaChmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGFkZEV2ZW50TGlzdGVuZXJzKHRoaXMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXJzKGUpIHtcclxuICAgIHZhciB0ID0gZS5xdWVyeVNlbGVjdG9yKCdpbnB1dCcpLFxyXG4gICAgICBuID0gZS5xdWVyeVNlbGVjdG9yQWxsKCdsaScpO1xyXG4gICAgZS5xdWVyeVNlbGVjdG9yKCdpJyk7XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwobiwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgZS5vbmNsaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHQudmFsdWUgPSBlLnRleHRDb250ZW50O1xyXG4gICAgICB9O1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGRpc2FibGVTdWJtaXRCdG4oKSB7XHJcbiAgICAkKCcjJyArIHN1Ym1pdEJ0bklkICsgJycpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBjcmVhdGVWYWxpZGF0b3IoKSB7XHJcbiAgICBwID0gJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykucGFyc2xleSgpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBkZXN0cm95VmFsaWRhdG9yKCkge1xyXG4gICAgcC5kZXN0cm95KCk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiB2YWxpZGF0ZUZvcm0oKSB7XHJcbiAgICByZXR1cm4gcC52YWxpZGF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gb25WYWxpZGF0ZUZvcm1TdWNjZXNzKCkge1xyXG4gICAgcC5vbignZm9ybTpzdWNjZXNzJyxcclxuXHJcbiAgICAgIGZ1bmN0aW9uICgpIHt9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gc2V0QXR0cmlidXRlcyhhdHIpIHtcclxuICAgICQoJyNzdHJlZXRfZWwnKS52YWwoYXRyLnN0cmVldF9lbCk7XHJcbiAgICAkKCcjc3RyZWV0X2VuJykudmFsKGF0ci5zdHJlZXRfZW4pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBnZXRBdHRyaWJ1dGVzKCkge1xyXG4gICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgY3JlYXRlVmFsaWRhdG9yKCk7XHJcbiAgICBpZiAodmFsaWRhdGVGb3JtKCkgPT09IHRydWUpIHtcclxuICAgICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC10ZXh0ZmllbGRfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgICBvYmpbJCh0aGlzKS5hdHRyKCdpZCcpXSA9ICQodGhpcykudmFsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtY2hlY2tib3hfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgICBvYmpbJCh0aGlzKS5hdHRyKCdpZCcpXSA9ICQodGhpcykucHJvcCgnY2hlY2tlZCcpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLXJhZGlvX19idXR0b24nKS5lYWNoKFxyXG4gICAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICAgb2JqWyQodGhpcykuYXR0cignaWQnKV0gPSAkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fc2VsZWN0JykuZWFjaChcclxuICAgICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAgIG9ialskKHRoaXMpLmF0dHIoJ2lkJyldID0gJCh0aGlzKS52YWwoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgcmV0dXJuIG9iajtcclxuICAgIH1cclxuICAgIGVsc2UgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiByZXNldEZvcm0oKSB7XHJcbiAgICBpZiAoY3JlYXRlVmFsaWRhdG9yKCkgPT0gdHJ1ZSkge1xyXG4gICAgICBkZXN0cm95VmFsaWRhdG9yKCk7XHJcbiAgICB9XHJcbiAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLXRleHRmaWVsZF9faW5wdXQnKS5lYWNoKFxyXG5cclxuICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgJCh0aGlzKS52YWwoJycpO1xyXG4gICAgICAgICQodGhpcykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtaW52YWxpZCcpO1xyXG4gICAgICB9KTtcclxuICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtY2hlY2tib3hfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICQodGhpcykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgfSk7XHJcbiAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLWNoZWNrYm94JykuZWFjaChcclxuXHJcbiAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiB7XHJcbiAgICBzZXQ6IHNldE9wdGlvbnMsXHJcbiAgICBnZXQ6IGdldEF0dHJpYnV0ZXMsXHJcbiAgICBjbGVhcjogcmVzZXRGb3JtLFxyXG4gICAgc2V0QXR0cmlidXRlczogc2V0QXR0cmlidXRlcyxcclxuICAvLyBjcmVhdGVWYWxpZGF0b3I6IGNyZWF0ZVZhbGlkYXRvcixcclxuICAvLyBkZXN0cm95VmFsaWRhdG9yOiBkZXN0cm95VmFsaWRhdG9yLFxyXG4gIC8vIHZhbGlkYXRlRm9ybTogdmFsaWRhdGVGb3JtLFxyXG4gIC8vIG9uVmFsaWRhdGVGb3JtU3VjY2Vzczogb25WYWxpZGF0ZUZvcm1TdWNjZXNzLFxyXG4gIC8vIGRpc2FibGVTdWJtaXRCdG46IGRpc2FibGVTdWJtaXRCdG5cclxuICB9O1xyXG59KGpRdWVyeSwgcGFyc2xleSkpO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
