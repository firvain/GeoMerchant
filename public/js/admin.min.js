var translation = (function language(jQuery, context, document, Promise) {
  'use strict';
  function getLanguage() {
    return document.documentElement.lang;
  }
  function getTranslation() {
    var lang = getLanguage();
    Promise.resolve(
      jQuery.ajax({
        url: 'http://127.0.0.1:3000/api/language',
        type: 'GET',
        data: {
          language: lang,
          context: context
        }
      })
      )
      .then(function resolve(data) {
        window.trans = data;
      })
      .catch(function error(e) {
        console.log(e.statusText);
      });
  }
  return {
    getTranslation: getTranslation
  };
}(jQuery, context, document, Promise));

var $loading = $('.mdl-spinner');
var center = [3677385, 4120949];
var extent = [3652772, 4112808, 3700000, 4132797];
var lang = document.documentElement.lang;
var geoJSONFormat = new ol.format.GeoJSON({
  defaultDataProjection: 'EPSG:4326'
});
var propertySource;
var property;
var map;
var features;
var drawnProperties;
var draw;
var select;
var translate;
var bing;
var mapbox;
toastr.options = {
  closeButton: false,
  debug: false,
  newestOnTop: false,
  progressBar: false,
  positionClass: 'toast-top-center',
  preventDuplicates: false,
  onclick: null,
  showDuration: '300',
  hideDuration: '1000',
  timeOut: '5000',
  extendedTimeOut: '1000',
  showEasing: 'swing',
  hideEasing: 'linear',
  showMethod: 'fadeIn',
  hideMethod: 'fadeOut'
};
bing = new ol.layer.Tile({
  visible: true,
  source: new ol.source.BingMaps({
    key: 'Ak2Gq8VUfICsPpuf7LRANXmXt2sHWmSLPhohmVLFtFIEwYjs_5MCyAhAFwRSVpLj',
    imagerySet: 'Aerial'
  }),
  maxZoom: 19,
  crossOrigin: 'anonymous',
  preload: Infinity,
  id: 'bing'
});
mapbox = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [new ol.Attribution({
      html: '<a href="https://www.mapbox.com/about/maps/" target="_blank">&copy; Mapbox &copy; OpenStreetMap</a>'
    })],
    url: 'https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZmlydmFpbiIsImEiOiJlOWYyYTM0NThiNWM0YjJjODJjNDE4ODQzNzA2MGQyNiJ9.-NVDO27Hzt-w_nQosUPfLA'
  }),
  id: 'mapbox'
});

function getIconType(estateType) {
  var iconType = {
    Apartment: function getApartmentIcon() {
      return 'apartment';
    },
    Store: function getStoreIcon() {
      return 'store';
    },
    'Detached House': function getDetachedHouseIcon() {
      return 'detached';
    },
    Maisonette: function getMaisonetteIcon() {
      return 'maisonette';
    },
    Villa: function getVillaIon() {
      return 'villa';
    }
  };
  return (iconType[estateType])();
}

function getIconPath(listingType) {
  var iconPath = {
    true: function () {
      return './images/pins/sale/';
    },
    false: function () {
      return './images/pins/rent/';
    },
    none: function () {
      return './images/pins/none/';
    }
  };
  return (iconPath[listingType])();
}

function PropertyStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-48.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
propertySource = new ol.source.Vector({
  format: geoJSONFormat,
  loader: function (extent, resolution, projection) {
    var url = 'http://127.0.0.1:3000/db/property/' + id;
    var self = this;
    // self.clear();
    $.ajax({
      url: url,
      type: 'GET',
      dataType: 'json'
    })
    .done(function completed(data, textStatus, jqXHR) {
      var newFeatures = geoJSONFormat.readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
      self.addFeatures(newFeatures);
    })
    .fail(function failed(jqXHR, textStatus, errorThrown) {
      toastr.clear();
      if (jqXHR.status === 404) {
        toastr.error('Sorry, we cannot find this property!');
      } else if (jqXHR.status === 503) {
        toastr.error('Service Unavailable');
      } else {
        toastr.error('Internal Server Error');
      }
    });
  }
});
property = new ol.layer.Vector({
  source: propertySource,
  id: 'property',
  visible: true,
  style: PropertyStyle
});
property.setZIndex(2);
map = new ol.Map({
  target: 'adminMap',
  layers: [
    mapbox, property
  ],
  loadTilesWhileAnimating: true,
  loadTilesWhileInteracting: true,
  renderer: 'canvas',
  controls: ol.control.defaults({
    attributionOptions: {
      collapsible: false,
      collapsed: false
    }
  }).extend([
    new ol.control.ScaleLine({
      units: 'metric'
    }),
    new ol.control.OverviewMap({
      className: 'ol-overviewmap ol-custom-overviewmap',
      collapsible: true,
      collapsed: true,
      layers: [bing]
    }),
    new ol.control.ZoomToExtent({
      extent: extent
    })
  ]),
  view: new ol.View({
    center: center,
    extent: extent,
    projection: 'EPSG:3857',
    zoom: 14,
    maxZoom: 19,
    minZoom: 14
  })
});
if (lang === 'el') {
  bing.set('name', 'Δορυφορική εικόνα');
  mapbox.set('name', 'Χάρτης');
  property.set('name', 'Ακίνητα');
} else {
  bing.set('name', 'Sattelite Image');
  mapbox.set('name', 'Map');
  property.set('name', 'Properties');
}
// ====== interactions ======
features = new ol.Collection();

function drawnPropertiesStyle(color) {
  var src;
  src = './images/pins/generic-48.png';
  if (typeof color !== 'undefined') {
    return new ol.style.Style({
      image: new ol.style.Icon(({
        src: src,
        anchorOrigin: 'bottom-left',
        anchor: [
          0.5, 0
        ],
        scale: 1,
        color: color
      }))
    });
  }
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [
        0.5, 0
      ],
      scale: 1
    }))
  });
}
drawnProperties = new ol.layer.Vector({
  source: new ol.source.Vector(),
  id: 'drawnProperties',
  style: drawnPropertiesStyle('#4caf50')
});
map.addLayer(drawnProperties);
// draw
draw = new ol.interaction.Draw({
  // features: features,
  source: drawnProperties.getSource(),
  type: 'Point',
  style: drawnPropertiesStyle('#4caf50')
});
map.addInteraction(draw);
draw.setActive(false);
// select
function selectedStyle(feature) {
  var src;
  src = getIconPath('none') + getIconType(feature.get('estatetype_en')) + '-64.png';
  return new ol.style.Style({
    image: new ol.style.Icon(({
      src: src,
      anchorOrigin: 'bottom-left',
      anchor: [0.5, 0],
      scale: 1,
      color: '#ffeb3b'
    }))
  });
}
select = new ol.interaction.Select({
  layers: [property],
  features: features,
  multi: false,
  style: selectedStyle
});
map.addInteraction(select);
select.setActive(false);
translate = new ol.interaction.Translate({
  features: select.getFeatures()
});
map.addInteraction(translate);
translate.setActive(false);
// ====== info ======
map.on('click', clickInfo);

function clickInfo(event) {
  var obj = {};

  event.preventDefault();
  select.setActive(true);
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      obj.feature = {};
      selectedFeature = _.head(e.selected);
      // clickedFeature.feature.setScale(1.2);
      selectedFeature.getKeys().forEach(function (key) {
        obj.feature[key] = selectedFeature.get(key);
      });
      dust.render('adminPropertyInfo', obj, function (err, out) {
        $('.property-info').html(out);
        $('.property-info').removeClass('visuallyhidden');
        componentHandler.upgradeDom();
        $('#listing').on('click', function (event) {
          var gid;
          event.preventDefault();
          gid = $(this).data('gid');
          $.ajax({
              url: 'http://127.0.0.1:3000/db/listing',
              type: 'GET',
              dataType: 'json',
              data: {
                gid: gid,
              },
            })
            .done(function (data) {
              // console.log(data);
              var listing_id = data.id;
              $('#openModal').css('width', 'auto');
              $('.modal-dialog').removeClass('visuallyhidden');
              dust.render('listingInsert', data, function (err, out) {
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                handleForm.set({
                  name: 'insert-update-listing',
                  submitBtnId: 'ok',
                });
                if ($('input[name=options]:checked').val() === 'Sale') {
                  $('#pets').parent().hide();
                  $('#prefered_customer').parent().hide();
                }
                $('input[name=options]').on('change', function (event) {
                  if ($(this).val() === 'Sale') {
                    $('#pets').prop('disabled', true);
                    $('#pets').prop('checked', false);
                    $('#pets').parent().hide();
                    $('label[for=pets]').removeClass('is-checked');
                    $('#prefered_customer').val('');
                    $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                    $('#prefered_customer').prop('disabled', true);
                    $('#prefered_customer').parent().hide();
                  } else {
                    $('#pets').prop('disabled', false);
                    $('#pets').parent().show();
                    $('#prefered_customer').prop('disabled', false);
                    $('#prefered_customer').parent().show();
                  }
                });
                $('#sent-listing').on('click', function (event) {
                  var data;
                  event.preventDefault();
                  data = handleForm.get();
                  if (data !== null) {
                    data.property_gid = gid;
                    data.listing_id = listing_id;
                    $.ajax({
                        url: 'http://127.0.0.1:3000/db/listing',
                        type: 'PUT',
                        data: data,
                        dataType: 'text'
                      })
                      .done(function (data, textStatus, jqXHR) {
                        if (jqXHR.status === 200) {
                          toastr.success('Property Updated In Database');
                        } else {
                          toastr.error('Oops Something Went Wrong!!!');
                        }
                      })
                      .fail(function (jqXHR, textStatus, errorThrown) {
                        toastr.error('Oops Something Went Wrong!!!');
                      })
                      .always(function () {
                        handleForm.clear();
                        $('#openModal').addClass('visuallyhidden');
                        propertySource.clear();
                        select.getFeatures().clear();
                        select.setActive(false);
                      });
                  }
                });
                $('#cancel-listing').on('click', function (event) {
                  event.preventDefault();
                  handleForm.clear();
                  select.getFeatures().clear();
                  select.setActive(false);
                  $('#openModal').addClass('visuallyhidden');
                });
              });
            })
            .fail(function () {
              var obj = {};
              if (lang === 'el') {
                obj.msg = 'Δεν Βρέθηκε Αγγελία';
                obj.text = 'Δημιουργία Καινούργιας;';
                obj.yes = 'ΝΑΙ';
                obj.no = 'ΟΧΙ';
              } else {
                obj.msg = 'No Listing Found';
                obj.text = 'Create New Listing?';
                obj.yes = 'YES';
                obj.no = 'NO';
              }
              dust.render('dialog', obj, function (error, out) {
                $('#openModal').removeClass('visuallyhidden');
                $('#openModal').css('width', 'auto');
                $('.modal-content').html(out);
                componentHandler.upgradeDom();
                $('#yes').on('click', function (event) {
                  event.preventDefault();
                  dust.render('listingInsert', {
                    rent: 'true',
                    addImage: 'true',
                  }, function (err, out) {
                    var myDropzone;
                    $('.modal-content').html(out);
                    componentHandler.upgradeDom();
                    myDropzone = new Dropzone(document.getElementById('dropzone'), {
                      uploadMultiple: false,
                      acceptedFiles: '.jpg',
                      parallelUploads: 6,
                      // addRemoveLinks : true,
                      url: 'https://api.cloudinary.com/v1_1/firvain/auto/upload'
                    });
                    myDropzone.on('sending', function (file, xhr, formData) {
                      formData.append('api_key', 375138932689591);
                      formData.append('callback', 'http://127.0.0.1:3000/public/cloudinary_cors.html');
                      formData.append('upload_preset', 'testupload');
                      formData.append('public_id', gid);
                    });
                    myDropzone.on('success', function () {
                      this.element.style.display = 'none';
                    });
                    handleForm.set({
                      name: 'insert-update-listing',
                      submitBtnId: 'ok'
                    });
                    // $('input[name=file]').cloudinary_fileupload();
                    // $('input[name=file]').unsigned_cloudinary_upload('testupload', {
                    //   cloud_name: 'firvain',
                    //   'public_id': gid,
                    // });
                    $('input[name=options]').on('change', function (event) {
                      if ($(this).val() === 'Sale') {
                        $('#pets').prop('disabled', true);
                        $('#pets').prop('checked', false);
                        $('label[for=pets]').removeClass('is-checked');
                        $('#prefered_customer').val('');
                        $('#prefered_customer').parent().eq(0).removeClass('is-dirty');
                        $('#prefered_customer').prop('disabled', true);
                      } else {
                        $('#pets').prop('disabled', false);
                        $('#prefered_customer').prop('disabled', false);
                      }
                    });
                    $('#sent-listing').on('click', function (event) {
                      var data;
                      event.preventDefault();
                      data = handleForm.get();
                      if (data !== null) {
                        data.property_gid = gid;
                        $.ajax({
                            url: 'http://127.0.0.1:3000/db/listing',
                            type: 'POST',
                            data: data,
                            dataType: 'text'
                          })
                          .done(function (data, textStatus, jqXHR) {
                            if (jqXHR.status === 201) {
                              toastr.success('Property Updated In Database');
                            } else {
                              toastr.error('Oops Something Went Wrong!!!');
                            }
                          })
                          .fail(function (jqXHR, textStatus, errorThrown) {
                            toastr.error('Oops Something Went Wrong!!!');
                          })
                          .always(function () {
                            handleForm.clear();
                            $('#openModal').addClass('visuallyhidden');
                            select.getFeatures().clear();
                            select.setActive(false);
                          });
                      }
                    });
                    $('#cancel-listing').on('click', function (event) {
                      event.preventDefault();
                      handleForm.clear();
                      select.getFeatures().clear();
                      select.setActive(false);
                      $('#openModal').addClass('visuallyhidden');
                    });
                  });
                });
                $('#no').on('click', function (event) {
                  event.preventDefault();
                  $('#openModal').addClass('visuallyhidden');
                  select.getFeatures().clear();
                  select.setActive(false);
                });
              });
            });
        });
      });
    } else {
      select.getFeatures().clear();
      // select.setActive(false);
      $('.property-info').addClass('visuallyhidden');
      toastr.error('Cant Find Any Property There...');
    }
  });
}
// ====== logout ======
$('#logout').click(function () {
  location.href = '/logout';
});
// ====== insert ======
$('#insertProperty').click(function () {
  var onEndDraw;
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  select.getFeatures().clear();
  select.setActive(false);
  draw.setActive(true);
  onEndDraw = draw.on('drawend', function (event) {
    var obj = {};
    var coords;
    var geocodeObj;
    var latlng;
    var geocodeName_el;
    var geocodeName_en;
    var geocodeAreaName;
    event.preventDefault();
    draw.setActive(false);
    coords = ol.proj.transform(event.feature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
    obj.coords = coords;
    latlng = coords[1] + '\,' + coords[0];
    geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
      latlng: latlng,
      key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ',
    }, function (json, textStatus) {
      return json;
    });
    geocodeObj.then(function () {
      geocodeName_el = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
      geocodeName_en = string_el_to_url(geocodeName_el);
      obj.street_el = geocodeName_el;
      obj.street_en = geocodeName_en;
      geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
      obj.area_name = geocodeAreaName;
      dataForm(obj);
    });

  });

  function dataForm(obj) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyInsert', obj, function (err, out) {
      $('.modal-content').html(out);
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'insertProperty',
        submitBtnId: 'insert'
      });
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val('');
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val('');
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val('');
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');


        }
      });
      $('#cancelInsert').on('click', function (event) {
        event.preventDefault();
        handleForm.clear();
        drawnProperties.getSource().clear();
        draw.unByKey(onEndDraw);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
      $('#insert').on('click', function (event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (data !== null) {
          data.x = obj.coords[0];
          data.y = obj.coords[1];
          data.adminId = id;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'POST',
            data: data
          })
          .done(function completed() {
            toastr.clear();
            toastr.success('Property Recorded In Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function () {
            event.preventDefault();
            drawnProperties.getSource().clear();
            propertySource.clear();
            handleForm.clear();
            draw.unByKey(onEndDraw);
            $('.modal-dialog').addClass('visuallyhidden');
            map.on('click', clickInfo);
          });
        }
      });
    });
  }
});
// ====== delete ======
$('#deleteProperty').click(function (event) {
  event.preventDefault();
  toastr.clear();
  $('.property-info').addClass('visuallyhidden');
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  select.once('select', function (e) {
    var $toast;
    if (e.target.getFeatures().getLength() === 1) {
      $toast = toastr.warning('<p>Are you sure?</p><div class="toastr-btns"><button id="yesDelete" class="mdl-button mdl-js-button ">Yes</button><button id="noDelete" class="mdl-button mdl-js-button">No</button></div>');
      $toast.on('click', '#yesDelete', function () {
        var gid = select.getFeatures().item(0).get('gid');
        $.ajax({
          url: 'http://127.0.0.1:3000/db/property',
          type: 'DELETE',
          dataType: 'json',
          data: {
            gid: gid
          }
        })
          .done(function completed(data, textStatus, jqXHR) {
            toastr.clear();
            toastr.success('Property Successfully Deleted with id = ' + data.propertygid + ' from Database');
          })
          .fail(function failed(jqXHR, textStatus, errorThrown) {
            toastr.clear();
            if (jqXHR.status === 404) {
              toastr.error('Sorry, we cannot find this property!');
            } else if (jqXHR.status === 503) {
              toastr.error('Service Unavailable');
            } else {
              toastr.error('Internal Server Error');
            }
          })
          .always(function always() {
            propertySource.clear();
            select.getFeatures().clear();
            select.setActive(false);
            map.on('click', clickInfo);
          });

        $toast.remove();
      });
      $toast.on('click', '#noDelete', function () {
        $toast.remove();
        select.getFeatures().clear();
        select.setActive(false);
      });
    }
  });
});

// ====== update ======

$('#updateProperty').on('click', function updateProperty(event) {
  var gid;
  var obj;
  var coords;
  var onEndTranslte;
  event.preventDefault();
  toastr.clear();
  map.un('click', clickInfo);
  draw.setActive(false);
  features.clear();
  propertySource.clear();
  select.getFeatures().clear();
  select.setActive(true);
  $('.property-info').addClass('visuallyhidden');
  select.once('select', function (e) {
    var selectedFeatures = e.selected;
    var length = selectedFeatures.length;
    var selectedFeature;
    if (length === 1) {
      gid = _.head(e.selected).get('gid');
      selectedFeature = _.head(e.selected);
      coords = ol.proj.transform(selectedFeature.getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
      $.ajax({
        url: 'http://127.0.0.1:3000/db/property',
        type: 'GET',
        dataType: 'json',
        data: {
          gid: gid
        }
      })
        .done(function completed(data) {
          var $toast = {};
          $toast.options = {};
          obj = _.head(data.features).properties;
          console.log(obj)

          $toast = toastr.warning('<p>Change Property Coordinates?</p><div class="toastr-btns"><button id="yesChangeXY" class="mdl-button mdl-js-button ">Yes</button><button id="noChangeXY" class="mdl-button mdl-js-button">No</button></div>');
          $toast.on('click', '#yesChangeXY', function yesChangeXY() {
            var latlng;
            var geocodeObj;
            var geocodeNameEl;
            var geocodeNameEn;
            var geocodeAreaName;
            translate.setActive(true);
            onEndTranslte = translate.on('translateend', function translateEnd(e) {
              // var geocodeObj;
              coords = ol.proj.transform(e.features.item(0).getGeometry().getCoordinates(), 'EPSG:3857', 'EPSG:4326');
              latlng = coords[1] + '\,' + coords[0];
              geocodeObj = $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
                latlng: latlng,
                key: 'AIzaSyCkH39_Ez21_RlC_pjXD09zpJ_ - eVhzCrQ'
              }, function (json, textStatus) {
                return json.results;
              });
              geocodeObj.then(function () {
                geocodeNameEl = _.head(_.head(geocodeObj.responseJSON.results).address_components).long_name;
                geocodeNameEn = string_el_to_url(geocodeNameEl);
                obj.street_el = geocodeNameEl;
                obj.street_en = geocodeNameEn;
                geocodeAreaName = _.first(_.drop(_.map(_.head(geocodeObj.responseJSON.results).address_components, 'long_name')));
                obj.area_name = geocodeAreaName;
                dataForm(obj, coords);
              });
            });
          });
          $toast.on('click', '#noChangeXY', function noChangeXY() {
            translate.setActive(false);
            toastr.clear();
            dataForm(obj, coords);
          });
        })
        .fail(function failed() {
          toastr.error('Oops Something Went Wrong!!!');
        });
    }
  });

  function dataForm(obj, coords) {
    $('.modal-dialog').removeClass('visuallyhidden');
    dust.render('propertyUpdate', obj, function renderPropertyUpdate(err, out) {
      var oldValues = {};
      $('.modal-content').html(out);
      oldValues.bedrooms = $('#bedrooms').val();
      oldValues.street_en = $('#street_en').val();
      oldValues.street_el = $('#street_el').val();
      oldValues.area_name = $('#area_name').val();
      componentHandler.upgradeDom();
      handleForm.set({
        name: 'updateProperty',
        submitBtnId: 'update'
      });
      // $('#street_el').val(obj.geocodeName_el);
      // $('#street_en').val(obj.geocodeName_en);
      $('#estateType').change(function () {
        if ($(this).val() === 'Μονοκατοικία') {
          $('#estateType_en').val('Detached House');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Detached House');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Διαμέρισμα') {
          $('#estateType_en').val('Apartment');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Apartment');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Έπαυλη') {
          $('#estateType_en').val('Villa');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Villa');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType_en').val('Maisonette');
          $('#estateType_en').parent().find('.mdl-selectfield__box-value').html('Maisonette');
        }
      });
      $('#estateType_en').change(function () {
        if ($(this).val() === 'Detached House') {
          $('#estateType').val('Μονοκατοικία');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μονοκατοικία');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Apartment') {
          $('#estateType').val('Διαμέρισμα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Διαμέρισμα');
          $('#bedrooms').val(oldValues.bedrooms);
        } else if ($(this).val() === 'Villa') {
          $('#estateType').val('Έπαυλη');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Έπαυλη');
          $('#bedrooms').val(oldValues.bedrooms);
        } else {
          $('#estateType').val('Μεζονέτα');
          $('#estateType').parent().find('.mdl-selectfield__box-value').html('Μεζονέτα');
        }
      });
      $('#update').on('click', function update(event) {
        var data;
        event.preventDefault();
        data = handleForm.get();
        if (!_.isNil(data)) {
          data.x = coords[0];
          data.y = coords[1];
          data.gid = gid;
          $.ajax({
            url: 'http://127.0.0.1:3000/db/property',
            type: 'PUT',
            data: data
          })
            .done(function completed(response, textStatus, jqXHR) {
              toastr.clear();
              toastr.success('Property with gid ' + response.propertygid + ' Updated in Database');
            })
            .fail(function failed(jqXHR, textStatus, errorThrown) {
              toastr.clear();
              if (jqXHR.status === 404) {
                toastr.error('Sorry, we cannot find this property!');
              } else if (jqXHR.status === 503) {
                toastr.error('Service Unavailable');
              } else {
                toastr.error('Internal Server Error');
              }
            })
            .always(function always() {
              propertySource.clear();
              select.getFeatures().clear();
              select.setActive(false);
              translate.unByKey(onEndTranslte);
              translate.setActive(false);
              map.on('click', clickInfo);
              $('.modal-dialog').addClass('visuallyhidden');
            });
        }
      });
      $('#cancelUpdate').on('click', function cancelUpdate(event) {
        event.preventDefault();
        handleForm.clear();
        propertySource.clear();
        select.getFeatures().clear();
        translate.unByKey(onEndTranslte);
        select.setActive(false);
        translate.setActive(false);
        map.on('click', clickInfo);
        $('.modal-dialog').addClass('visuallyhidden');
        map.on('click', clickInfo);
      });
    });
  }

  $('#adminMap').removeAttr('style');
});
$(document).ready(function () {
  window.Parsley.on('field:error', function () {
    // This global callback will be called for any field that fails validation.
    console.log('Validation failed for: ', this.$element);
  });
  window.Parsley
    .addValidator('date', {
      requirementType: 'string',
      validateString: function (value, requirement) {
        if (moment(value, 'DD-MM-YYYY', true).isValid() === true) {
          return true;
        }
        return false;
      },
      messages: {
        en: 'Wrong Date',
        el: 'Λάθος Ημερομηνία'
      }
    });
});

function string_el_to_url(string) {
  var originalString = string;
  var newString;
  var replace = new Array('α', 'ά', 'Ά', 'Α', 'β', 'Β', 'γ', 'Γ', 'δ', 'Δ', 'ε', 'έ', 'Ε', 'Έ', 'ζ', 'Ζ', 'η', 'ή', 'Η', 'θ', 'Θ', 'ι', 'ί', 'ϊ', 'ΐ', 'Ι', 'Ί', 'κ', 'Κ', 'λ', 'Λ', 'μ', 'Μ', 'ν', 'Ν', 'ξ', 'Ξ', 'ο', 'ό', 'Ο', 'Ό', 'π', 'Π', 'ρ', 'Ρ', 'σ', 'ς', 'Σ', 'τ', 'Τ', 'υ', 'ύ', 'Υ', 'Ύ', 'φ', 'Φ', 'χ', 'Χ', 'ψ', 'Ψ', 'ω', 'ώ', 'Ω', 'Ώ', ' ', '\'', '\'', ',');
  var replace_n = new Array('a', 'a', 'A', 'A', 'v', 'V', 'g', 'G', 'd', 'D', 'e', 'e', 'E', 'E', 'z', 'Z', 'i', 'i', 'I', 'th', 'Th', 'i', 'i', 'i', 'i', 'I', 'I', 'k', 'K', 'l', 'L', 'm', 'M', 'n', 'N', 'x', 'X', 'o', 'o', 'O', 'O', 'p', 'P', 'r', 'R', 's', 's', 'S', 't', 'T', 'u', 'u', 'Y', 'Y', 'f', 'F', 'ch', 'Ch', 'ps', 'Ps', 'o', 'o', 'O', 'O', ' ', '_', '_', '_');

  for (var i = 0; i < replace.length; i++) {
    originalString = originalString.replace(new RegExp(replace[i], 'g'), replace_n[i]);
  }
  newString = originalString;
  return newString;
}
$(document)
  .ajaxStart(function () {
    $loading.addClass('is-active');
  })
  .ajaxStop(function () {
    $loading.removeClass('is-active');
  });

var handleForm = (function ($, parsley) {
  'use strict';
  var formName, submitBtnId, p;

  function setOptions(options) {
    formName = options.name;
    submitBtnId = options.submitBtnId;
    enableSelect();
  }
  function enableSelect() {
    var e = $('.getmdl-select');
    e.each(function () {
      addEventListeners(this);
    });
  }
  function addEventListeners(e) {
    var t = e.querySelector('input'),
      n = e.querySelectorAll('li');
    e.querySelector('i');
    [].forEach.call(n, function (e) {
      e.onclick = function () {
        t.value = e.textContent;
      };
    });
  }
  function disableSubmitBtn() {
    $('#' + submitBtnId + '').prop('disabled', true);
  }

  function createValidator() {
    p = $('form[name="' + formName + '"').parsley();
    return true;
  }

  function destroyValidator() {
    p.destroy();
  }

  function validateForm() {
    return p.validate();
  }

  function onValidateFormSuccess() {
    p.on('form:success',

      function () {});
  }
  function setAttributes(atr) {
    $('#street_el').val(atr.street_el);
    $('#street_en').val(atr.street_en);
  }
  function getAttributes() {
    var obj = {};
    createValidator();
    if (validateForm() === true) {
      $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-radio__button').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).prop('checked');
        });
      $('form[name="' + formName + '"').find('.mdl-selectfield__select').each(
        function (index, element) {
          obj[$(this).attr('id')] = $(this).val();
        });
      return obj;
    }
    else return null;
  }

  function resetForm() {
    if (createValidator() == true) {
      destroyValidator();
    }
    $('form[name="' + formName + '"').find('.mdl-textfield__input').each(

      function (index, element) {
        $(this).val('');
        $(this).parent().eq(0).removeClass('is-dirty');
        $(this).parent().eq(0).removeClass('is-invalid');
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox__input').each(

      function (index, element) {
        $(this).prop('checked', false);
      });
    $('form[name="' + formName + '"').find('.mdl-checkbox').each(

      function (index, element) {
        $(this).removeClass('is-checked');
      });
  }
  return {
    set: setOptions,
    get: getAttributes,
    clear: resetForm,
    setAttributes: setAttributes
  // createValidator: createValidator,
  // destroyValidator: destroyValidator,
  // validateForm: validateForm,
  // onValidateFormSuccess: onValidateFormSuccess,
  // disableSubmitBtn: disableSubmitBtn
  };
}(jQuery, parsley));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyYW5zbGF0aW9uLmpzIiwiYWRtaW4uanMiLCJoYW5kbGVGb3JtLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYWRtaW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHRyYW5zbGF0aW9uID0gKGZ1bmN0aW9uIGxhbmd1YWdlKGpRdWVyeSwgY29udGV4dCwgZG9jdW1lbnQsIFByb21pc2UpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgZnVuY3Rpb24gZ2V0TGFuZ3VhZ2UoKSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmxhbmc7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGdldFRyYW5zbGF0aW9uKCkge1xyXG4gICAgdmFyIGxhbmcgPSBnZXRMYW5ndWFnZSgpO1xyXG4gICAgUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICBqUXVlcnkuYWpheCh7XHJcbiAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2FwaS9sYW5ndWFnZScsXHJcbiAgICAgICAgdHlwZTogJ0dFVCcsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgbGFuZ3VhZ2U6IGxhbmcsXHJcbiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICApXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uIHJlc29sdmUoZGF0YSkge1xyXG4gICAgICAgIHdpbmRvdy50cmFucyA9IGRhdGE7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5jYXRjaChmdW5jdGlvbiBlcnJvcihlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZS5zdGF0dXNUZXh0KTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiB7XHJcbiAgICBnZXRUcmFuc2xhdGlvbjogZ2V0VHJhbnNsYXRpb25cclxuICB9O1xyXG59KGpRdWVyeSwgY29udGV4dCwgZG9jdW1lbnQsIFByb21pc2UpKTtcclxuIiwidmFyICRsb2FkaW5nID0gJCgnLm1kbC1zcGlubmVyJyk7XHJcbnZhciBjZW50ZXIgPSBbMzY3NzM4NSwgNDEyMDk0OV07XHJcbnZhciBleHRlbnQgPSBbMzY1Mjc3MiwgNDExMjgwOCwgMzcwMDAwMCwgNDEzMjc5N107XHJcbnZhciBsYW5nID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmxhbmc7XHJcbnZhciBnZW9KU09ORm9ybWF0ID0gbmV3IG9sLmZvcm1hdC5HZW9KU09OKHtcclxuICBkZWZhdWx0RGF0YVByb2plY3Rpb246ICdFUFNHOjQzMjYnXHJcbn0pO1xyXG52YXIgcHJvcGVydHlTb3VyY2U7XHJcbnZhciBwcm9wZXJ0eTtcclxudmFyIG1hcDtcclxudmFyIGZlYXR1cmVzO1xyXG52YXIgZHJhd25Qcm9wZXJ0aWVzO1xyXG52YXIgZHJhdztcclxudmFyIHNlbGVjdDtcclxudmFyIHRyYW5zbGF0ZTtcclxudmFyIGJpbmc7XHJcbnZhciBtYXBib3g7XHJcbnRvYXN0ci5vcHRpb25zID0ge1xyXG4gIGNsb3NlQnV0dG9uOiBmYWxzZSxcclxuICBkZWJ1ZzogZmFsc2UsXHJcbiAgbmV3ZXN0T25Ub3A6IGZhbHNlLFxyXG4gIHByb2dyZXNzQmFyOiBmYWxzZSxcclxuICBwb3NpdGlvbkNsYXNzOiAndG9hc3QtdG9wLWNlbnRlcicsXHJcbiAgcHJldmVudER1cGxpY2F0ZXM6IGZhbHNlLFxyXG4gIG9uY2xpY2s6IG51bGwsXHJcbiAgc2hvd0R1cmF0aW9uOiAnMzAwJyxcclxuICBoaWRlRHVyYXRpb246ICcxMDAwJyxcclxuICB0aW1lT3V0OiAnNTAwMCcsXHJcbiAgZXh0ZW5kZWRUaW1lT3V0OiAnMTAwMCcsXHJcbiAgc2hvd0Vhc2luZzogJ3N3aW5nJyxcclxuICBoaWRlRWFzaW5nOiAnbGluZWFyJyxcclxuICBzaG93TWV0aG9kOiAnZmFkZUluJyxcclxuICBoaWRlTWV0aG9kOiAnZmFkZU91dCdcclxufTtcclxuYmluZyA9IG5ldyBvbC5sYXllci5UaWxlKHtcclxuICB2aXNpYmxlOiB0cnVlLFxyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5CaW5nTWFwcyh7XHJcbiAgICBrZXk6ICdBazJHcThWVWZJQ3NQcHVmN0xSQU5YbVh0MnNIV21TTFBob2htVkxGdEZJRXdZanNfNU1DeUFoQUZ3UlNWcExqJyxcclxuICAgIGltYWdlcnlTZXQ6ICdBZXJpYWwnXHJcbiAgfSksXHJcbiAgbWF4Wm9vbTogMTksXHJcbiAgY3Jvc3NPcmlnaW46ICdhbm9ueW1vdXMnLFxyXG4gIHByZWxvYWQ6IEluZmluaXR5LFxyXG4gIGlkOiAnYmluZydcclxufSk7XHJcbm1hcGJveCA9IG5ldyBvbC5sYXllci5UaWxlKHtcclxuICBzb3VyY2U6IG5ldyBvbC5zb3VyY2UuWFlaKHtcclxuICAgIGF0dHJpYnV0aW9uczogW25ldyBvbC5BdHRyaWJ1dGlvbih7XHJcbiAgICAgIGh0bWw6ICc8YSBocmVmPVwiaHR0cHM6Ly93d3cubWFwYm94LmNvbS9hYm91dC9tYXBzL1wiIHRhcmdldD1cIl9ibGFua1wiPiZjb3B5OyBNYXBib3ggJmNvcHk7IE9wZW5TdHJlZXRNYXA8L2E+J1xyXG4gICAgfSldLFxyXG4gICAgdXJsOiAnaHR0cHM6Ly9hcGkubWFwYm94LmNvbS92NC9tYXBib3guc3RyZWV0cy97en0ve3h9L3t5fS5wbmc/YWNjZXNzX3Rva2VuPXBrLmV5SjFJam9pWm1seWRtRnBiaUlzSW1FaU9pSmxPV1l5WVRNME5UaGlOV00wWWpKak9ESmpOREU0T0RRek56QTJNR1F5TmlKOS4tTlZETzI3SHp0LXdfblFvc1VQZkxBJ1xyXG4gIH0pLFxyXG4gIGlkOiAnbWFwYm94J1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGdldEljb25UeXBlKGVzdGF0ZVR5cGUpIHtcclxuICB2YXIgaWNvblR5cGUgPSB7XHJcbiAgICBBcGFydG1lbnQ6IGZ1bmN0aW9uIGdldEFwYXJ0bWVudEljb24oKSB7XHJcbiAgICAgIHJldHVybiAnYXBhcnRtZW50JztcclxuICAgIH0sXHJcbiAgICBTdG9yZTogZnVuY3Rpb24gZ2V0U3RvcmVJY29uKCkge1xyXG4gICAgICByZXR1cm4gJ3N0b3JlJztcclxuICAgIH0sXHJcbiAgICAnRGV0YWNoZWQgSG91c2UnOiBmdW5jdGlvbiBnZXREZXRhY2hlZEhvdXNlSWNvbigpIHtcclxuICAgICAgcmV0dXJuICdkZXRhY2hlZCc7XHJcbiAgICB9LFxyXG4gICAgTWFpc29uZXR0ZTogZnVuY3Rpb24gZ2V0TWFpc29uZXR0ZUljb24oKSB7XHJcbiAgICAgIHJldHVybiAnbWFpc29uZXR0ZSc7XHJcbiAgICB9LFxyXG4gICAgVmlsbGE6IGZ1bmN0aW9uIGdldFZpbGxhSW9uKCkge1xyXG4gICAgICByZXR1cm4gJ3ZpbGxhJztcclxuICAgIH1cclxuICB9O1xyXG4gIHJldHVybiAoaWNvblR5cGVbZXN0YXRlVHlwZV0pKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEljb25QYXRoKGxpc3RpbmdUeXBlKSB7XHJcbiAgdmFyIGljb25QYXRoID0ge1xyXG4gICAgdHJ1ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvc2FsZS8nO1xyXG4gICAgfSxcclxuICAgIGZhbHNlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHJldHVybiAnLi9pbWFnZXMvcGlucy9yZW50Lyc7XHJcbiAgICB9LFxyXG4gICAgbm9uZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICByZXR1cm4gJy4vaW1hZ2VzL3BpbnMvbm9uZS8nO1xyXG4gICAgfVxyXG4gIH07XHJcbiAgcmV0dXJuIChpY29uUGF0aFtsaXN0aW5nVHlwZV0pKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIFByb3BlcnR5U3R5bGUoZmVhdHVyZSkge1xyXG4gIHZhciBzcmM7XHJcbiAgc3JjID0gZ2V0SWNvblBhdGgoJ25vbmUnKSArIGdldEljb25UeXBlKGZlYXR1cmUuZ2V0KCdlc3RhdGV0eXBlX2VuJykpICsgJy00OC5wbmcnO1xyXG4gIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgaW1hZ2U6IG5ldyBvbC5zdHlsZS5JY29uKCh7XHJcbiAgICAgIHNyYzogc3JjLFxyXG4gICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgIGFuY2hvcjogW1xyXG4gICAgICAgIDAuNSwgMFxyXG4gICAgICBdLFxyXG4gICAgICBzY2FsZTogMVxyXG4gICAgfSkpXHJcbiAgfSk7XHJcbn1cclxucHJvcGVydHlTb3VyY2UgPSBuZXcgb2wuc291cmNlLlZlY3Rvcih7XHJcbiAgZm9ybWF0OiBnZW9KU09ORm9ybWF0LFxyXG4gIGxvYWRlcjogZnVuY3Rpb24gKGV4dGVudCwgcmVzb2x1dGlvbiwgcHJvamVjdGlvbikge1xyXG4gICAgdmFyIHVybCA9ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHkvJyArIGlkO1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgLy8gc2VsZi5jbGVhcigpO1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgdXJsOiB1cmwsXHJcbiAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICBkYXRhVHlwZTogJ2pzb24nXHJcbiAgICB9KVxyXG4gICAgLmRvbmUoZnVuY3Rpb24gY29tcGxldGVkKGRhdGEsIHRleHRTdGF0dXMsIGpxWEhSKSB7XHJcbiAgICAgIHZhciBuZXdGZWF0dXJlcyA9IGdlb0pTT05Gb3JtYXQucmVhZEZlYXR1cmVzKGRhdGEsIHtcclxuICAgICAgICBmZWF0dXJlUHJvamVjdGlvbjogJ0VQU0c6Mzg1NydcclxuICAgICAgfSk7XHJcbiAgICAgIHNlbGYuYWRkRmVhdHVyZXMobmV3RmVhdHVyZXMpO1xyXG4gICAgfSlcclxuICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIHRoaXMgcHJvcGVydHkhJyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbn0pO1xyXG5wcm9wZXJ0eSA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gIHNvdXJjZTogcHJvcGVydHlTb3VyY2UsXHJcbiAgaWQ6ICdwcm9wZXJ0eScsXHJcbiAgdmlzaWJsZTogdHJ1ZSxcclxuICBzdHlsZTogUHJvcGVydHlTdHlsZVxyXG59KTtcclxucHJvcGVydHkuc2V0WkluZGV4KDIpO1xyXG5tYXAgPSBuZXcgb2wuTWFwKHtcclxuICB0YXJnZXQ6ICdhZG1pbk1hcCcsXHJcbiAgbGF5ZXJzOiBbXHJcbiAgICBtYXBib3gsIHByb3BlcnR5XHJcbiAgXSxcclxuICBsb2FkVGlsZXNXaGlsZUFuaW1hdGluZzogdHJ1ZSxcclxuICBsb2FkVGlsZXNXaGlsZUludGVyYWN0aW5nOiB0cnVlLFxyXG4gIHJlbmRlcmVyOiAnY2FudmFzJyxcclxuICBjb250cm9sczogb2wuY29udHJvbC5kZWZhdWx0cyh7XHJcbiAgICBhdHRyaWJ1dGlvbk9wdGlvbnM6IHtcclxuICAgICAgY29sbGFwc2libGU6IGZhbHNlLFxyXG4gICAgICBjb2xsYXBzZWQ6IGZhbHNlXHJcbiAgICB9XHJcbiAgfSkuZXh0ZW5kKFtcclxuICAgIG5ldyBvbC5jb250cm9sLlNjYWxlTGluZSh7XHJcbiAgICAgIHVuaXRzOiAnbWV0cmljJ1xyXG4gICAgfSksXHJcbiAgICBuZXcgb2wuY29udHJvbC5PdmVydmlld01hcCh7XHJcbiAgICAgIGNsYXNzTmFtZTogJ29sLW92ZXJ2aWV3bWFwIG9sLWN1c3RvbS1vdmVydmlld21hcCcsXHJcbiAgICAgIGNvbGxhcHNpYmxlOiB0cnVlLFxyXG4gICAgICBjb2xsYXBzZWQ6IHRydWUsXHJcbiAgICAgIGxheWVyczogW2JpbmddXHJcbiAgICB9KSxcclxuICAgIG5ldyBvbC5jb250cm9sLlpvb21Ub0V4dGVudCh7XHJcbiAgICAgIGV4dGVudDogZXh0ZW50XHJcbiAgICB9KVxyXG4gIF0pLFxyXG4gIHZpZXc6IG5ldyBvbC5WaWV3KHtcclxuICAgIGNlbnRlcjogY2VudGVyLFxyXG4gICAgZXh0ZW50OiBleHRlbnQsXHJcbiAgICBwcm9qZWN0aW9uOiAnRVBTRzozODU3JyxcclxuICAgIHpvb206IDE0LFxyXG4gICAgbWF4Wm9vbTogMTksXHJcbiAgICBtaW5ab29tOiAxNFxyXG4gIH0pXHJcbn0pO1xyXG5pZiAobGFuZyA9PT0gJ2VsJykge1xyXG4gIGJpbmcuc2V0KCduYW1lJywgJ86Uzr/Pgc+Fz4bOv8+BzrnOus6uIM61zrnOus+Mzr3OsScpO1xyXG4gIG1hcGJveC5zZXQoJ25hbWUnLCAnzqfOrM+Bz4TOt8+CJyk7XHJcbiAgcHJvcGVydHkuc2V0KCduYW1lJywgJ86RzrrOr869zrfPhM6xJyk7XHJcbn0gZWxzZSB7XHJcbiAgYmluZy5zZXQoJ25hbWUnLCAnU2F0dGVsaXRlIEltYWdlJyk7XHJcbiAgbWFwYm94LnNldCgnbmFtZScsICdNYXAnKTtcclxuICBwcm9wZXJ0eS5zZXQoJ25hbWUnLCAnUHJvcGVydGllcycpO1xyXG59XHJcbi8vID09PT09PSBpbnRlcmFjdGlvbnMgPT09PT09XHJcbmZlYXR1cmVzID0gbmV3IG9sLkNvbGxlY3Rpb24oKTtcclxuXHJcbmZ1bmN0aW9uIGRyYXduUHJvcGVydGllc1N0eWxlKGNvbG9yKSB7XHJcbiAgdmFyIHNyYztcclxuICBzcmMgPSAnLi9pbWFnZXMvcGlucy9nZW5lcmljLTQ4LnBuZyc7XHJcbiAgaWYgKHR5cGVvZiBjb2xvciAhPT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgIHJldHVybiBuZXcgb2wuc3R5bGUuU3R5bGUoe1xyXG4gICAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgICBzcmM6IHNyYyxcclxuICAgICAgICBhbmNob3JPcmlnaW46ICdib3R0b20tbGVmdCcsXHJcbiAgICAgICAgYW5jaG9yOiBbXHJcbiAgICAgICAgICAwLjUsIDBcclxuICAgICAgICBdLFxyXG4gICAgICAgIHNjYWxlOiAxLFxyXG4gICAgICAgIGNvbG9yOiBjb2xvclxyXG4gICAgICB9KSlcclxuICAgIH0pO1xyXG4gIH1cclxuICByZXR1cm4gbmV3IG9sLnN0eWxlLlN0eWxlKHtcclxuICAgIGltYWdlOiBuZXcgb2wuc3R5bGUuSWNvbigoe1xyXG4gICAgICBzcmM6IHNyYyxcclxuICAgICAgYW5jaG9yT3JpZ2luOiAnYm90dG9tLWxlZnQnLFxyXG4gICAgICBhbmNob3I6IFtcclxuICAgICAgICAwLjUsIDBcclxuICAgICAgXSxcclxuICAgICAgc2NhbGU6IDFcclxuICAgIH0pKVxyXG4gIH0pO1xyXG59XHJcbmRyYXduUHJvcGVydGllcyA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xyXG4gIHNvdXJjZTogbmV3IG9sLnNvdXJjZS5WZWN0b3IoKSxcclxuICBpZDogJ2RyYXduUHJvcGVydGllcycsXHJcbiAgc3R5bGU6IGRyYXduUHJvcGVydGllc1N0eWxlKCcjNGNhZjUwJylcclxufSk7XHJcbm1hcC5hZGRMYXllcihkcmF3blByb3BlcnRpZXMpO1xyXG4vLyBkcmF3XHJcbmRyYXcgPSBuZXcgb2wuaW50ZXJhY3Rpb24uRHJhdyh7XHJcbiAgLy8gZmVhdHVyZXM6IGZlYXR1cmVzLFxyXG4gIHNvdXJjZTogZHJhd25Qcm9wZXJ0aWVzLmdldFNvdXJjZSgpLFxyXG4gIHR5cGU6ICdQb2ludCcsXHJcbiAgc3R5bGU6IGRyYXduUHJvcGVydGllc1N0eWxlKCcjNGNhZjUwJylcclxufSk7XHJcbm1hcC5hZGRJbnRlcmFjdGlvbihkcmF3KTtcclxuZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4vLyBzZWxlY3RcclxuZnVuY3Rpb24gc2VsZWN0ZWRTdHlsZShmZWF0dXJlKSB7XHJcbiAgdmFyIHNyYztcclxuICBzcmMgPSBnZXRJY29uUGF0aCgnbm9uZScpICsgZ2V0SWNvblR5cGUoZmVhdHVyZS5nZXQoJ2VzdGF0ZXR5cGVfZW4nKSkgKyAnLTY0LnBuZyc7XHJcbiAgcmV0dXJuIG5ldyBvbC5zdHlsZS5TdHlsZSh7XHJcbiAgICBpbWFnZTogbmV3IG9sLnN0eWxlLkljb24oKHtcclxuICAgICAgc3JjOiBzcmMsXHJcbiAgICAgIGFuY2hvck9yaWdpbjogJ2JvdHRvbS1sZWZ0JyxcclxuICAgICAgYW5jaG9yOiBbMC41LCAwXSxcclxuICAgICAgc2NhbGU6IDEsXHJcbiAgICAgIGNvbG9yOiAnI2ZmZWIzYidcclxuICAgIH0pKVxyXG4gIH0pO1xyXG59XHJcbnNlbGVjdCA9IG5ldyBvbC5pbnRlcmFjdGlvbi5TZWxlY3Qoe1xyXG4gIGxheWVyczogW3Byb3BlcnR5XSxcclxuICBmZWF0dXJlczogZmVhdHVyZXMsXHJcbiAgbXVsdGk6IGZhbHNlLFxyXG4gIHN0eWxlOiBzZWxlY3RlZFN0eWxlXHJcbn0pO1xyXG5tYXAuYWRkSW50ZXJhY3Rpb24oc2VsZWN0KTtcclxuc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbnRyYW5zbGF0ZSA9IG5ldyBvbC5pbnRlcmFjdGlvbi5UcmFuc2xhdGUoe1xyXG4gIGZlYXR1cmVzOiBzZWxlY3QuZ2V0RmVhdHVyZXMoKVxyXG59KTtcclxubWFwLmFkZEludGVyYWN0aW9uKHRyYW5zbGF0ZSk7XHJcbnRyYW5zbGF0ZS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4vLyA9PT09PT0gaW5mbyA9PT09PT1cclxubWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcblxyXG5mdW5jdGlvbiBjbGlja0luZm8oZXZlbnQpIHtcclxuICB2YXIgb2JqID0ge307XHJcblxyXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgc2VsZWN0LnNldEFjdGl2ZSh0cnVlKTtcclxuICBzZWxlY3Qub25jZSgnc2VsZWN0JywgZnVuY3Rpb24gKGUpIHtcclxuICAgIHZhciBzZWxlY3RlZEZlYXR1cmVzID0gZS5zZWxlY3RlZDtcclxuICAgIHZhciBsZW5ndGggPSBzZWxlY3RlZEZlYXR1cmVzLmxlbmd0aDtcclxuICAgIHZhciBzZWxlY3RlZEZlYXR1cmU7XHJcbiAgICBpZiAobGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIG9iai5mZWF0dXJlID0ge307XHJcbiAgICAgIHNlbGVjdGVkRmVhdHVyZSA9IF8uaGVhZChlLnNlbGVjdGVkKTtcclxuICAgICAgLy8gY2xpY2tlZEZlYXR1cmUuZmVhdHVyZS5zZXRTY2FsZSgxLjIpO1xyXG4gICAgICBzZWxlY3RlZEZlYXR1cmUuZ2V0S2V5cygpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xyXG4gICAgICAgIG9iai5mZWF0dXJlW2tleV0gPSBzZWxlY3RlZEZlYXR1cmUuZ2V0KGtleSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBkdXN0LnJlbmRlcignYWRtaW5Qcm9wZXJ0eUluZm8nLCBvYmosIGZ1bmN0aW9uIChlcnIsIG91dCkge1xyXG4gICAgICAgICQoJy5wcm9wZXJ0eS1pbmZvJykuaHRtbChvdXQpO1xyXG4gICAgICAgICQoJy5wcm9wZXJ0eS1pbmZvJykucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgICAgJCgnI2xpc3RpbmcnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgIHZhciBnaWQ7XHJcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgZ2lkID0gJCh0aGlzKS5kYXRhKCdnaWQnKTtcclxuICAgICAgICAgICQuYWpheCh7XHJcbiAgICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RpbmcnLFxyXG4gICAgICAgICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgZ2lkOiBnaWQsXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmRvbmUoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgICB2YXIgbGlzdGluZ19pZCA9IGRhdGEuaWQ7XHJcbiAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmNzcygnd2lkdGgnLCAnYXV0bycpO1xyXG4gICAgICAgICAgICAgICQoJy5tb2RhbC1kaWFsb2cnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICBkdXN0LnJlbmRlcignbGlzdGluZ0luc2VydCcsIGRhdGEsIGZ1bmN0aW9uIChlcnIsIG91dCkge1xyXG4gICAgICAgICAgICAgICAgJCgnLm1vZGFsLWNvbnRlbnQnKS5odG1sKG91dCk7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uc2V0KHtcclxuICAgICAgICAgICAgICAgICAgbmFtZTogJ2luc2VydC11cGRhdGUtbGlzdGluZycsXHJcbiAgICAgICAgICAgICAgICAgIHN1Ym1pdEJ0bklkOiAnb2snLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoJCgnaW5wdXRbbmFtZT1vcHRpb25zXTpjaGVja2VkJykudmFsKCkgPT09ICdTYWxlJykge1xyXG4gICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnBhcmVudCgpLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJCgnaW5wdXRbbmFtZT1vcHRpb25zXScpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICdTYWxlJykge1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnZGlzYWJsZWQnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wYXJlbnQoKS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnbGFiZWxbZm9yPXBldHNdJykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS52YWwoJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnBhcmVudCgpLmVxKDApLnJlbW92ZUNsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNwZXRzJykucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wYXJlbnQoKS5zaG93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucGFyZW50KCkuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICQoJyNzZW50LWxpc3RpbmcnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgdmFyIGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgIGRhdGEgPSBoYW5kbGVGb3JtLmdldCgpO1xyXG4gICAgICAgICAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHJvcGVydHlfZ2lkID0gZ2lkO1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEubGlzdGluZ19pZCA9IGxpc3RpbmdfaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL2xpc3RpbmcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnUFVUJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0J1xyXG4gICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgVXBkYXRlZCBJbiBEYXRhYmFzZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgLmZhaWwoZnVuY3Rpb24gKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ09vcHMgU29tZXRoaW5nIFdlbnQgV3JvbmchISEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAuYWx3YXlzKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgJCgnI2NhbmNlbC1saXN0aW5nJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZmFpbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgICAgICAgICAgIGlmIChsYW5nID09PSAnZWwnKSB7XHJcbiAgICAgICAgICAgICAgICBvYmoubXNnID0gJ86UzrXOvSDOks+Bzq3OuM63zrrOtSDOkc6zzrPOtc67zq/OsSc7XHJcbiAgICAgICAgICAgICAgICBvYmoudGV4dCA9ICfOlM63zrzOuc6/z4XPgc6zzq/OsSDOms6xzrnOvc6/z43Pgc6zzrnOsc+COyc7XHJcbiAgICAgICAgICAgICAgICBvYmoueWVzID0gJ86dzpHOmSc7XHJcbiAgICAgICAgICAgICAgICBvYmoubm8gPSAnzp/Op86ZJztcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgb2JqLm1zZyA9ICdObyBMaXN0aW5nIEZvdW5kJztcclxuICAgICAgICAgICAgICAgIG9iai50ZXh0ID0gJ0NyZWF0ZSBOZXcgTGlzdGluZz8nO1xyXG4gICAgICAgICAgICAgICAgb2JqLnllcyA9ICdZRVMnO1xyXG4gICAgICAgICAgICAgICAgb2JqLm5vID0gJ05PJztcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgZHVzdC5yZW5kZXIoJ2RpYWxvZycsIG9iaiwgZnVuY3Rpb24gKGVycm9yLCBvdXQpIHtcclxuICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5jc3MoJ3dpZHRoJywgJ2F1dG8nKTtcclxuICAgICAgICAgICAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgICAgICAgICAgICAkKCcjeWVzJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgIGR1c3QucmVuZGVyKCdsaXN0aW5nSW5zZXJ0Jywge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlbnQ6ICd0cnVlJyxcclxuICAgICAgICAgICAgICAgICAgICBhZGRJbWFnZTogJ3RydWUnLFxyXG4gICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyLCBvdXQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbXlEcm9wem9uZTtcclxuICAgICAgICAgICAgICAgICAgICAkKCcubW9kYWwtY29udGVudCcpLmh0bWwob3V0KTtcclxuICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgICAgICAgICAgICAgICBteURyb3B6b25lID0gbmV3IERyb3B6b25lKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcm9wem9uZScpLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRNdWx0aXBsZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICBhY2NlcHRlZEZpbGVzOiAnLmpwZycsXHJcbiAgICAgICAgICAgICAgICAgICAgICBwYXJhbGxlbFVwbG9hZHM6IDYsXHJcbiAgICAgICAgICAgICAgICAgICAgICAvLyBhZGRSZW1vdmVMaW5rcyA6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2FwaS5jbG91ZGluYXJ5LmNvbS92MV8xL2ZpcnZhaW4vYXV0by91cGxvYWQnXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbXlEcm9wem9uZS5vbignc2VuZGluZycsIGZ1bmN0aW9uIChmaWxlLCB4aHIsIGZvcm1EYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FwaV9rZXknLCAzNzUxMzg5MzI2ODk1OTEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdjYWxsYmFjaycsICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvcHVibGljL2Nsb3VkaW5hcnlfY29ycy5odG1sJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3VwbG9hZF9wcmVzZXQnLCAndGVzdHVwbG9hZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdwdWJsaWNfaWQnLCBnaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIG15RHJvcHpvbmUub24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVGb3JtLnNldCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnaW5zZXJ0LXVwZGF0ZS1saXN0aW5nJyxcclxuICAgICAgICAgICAgICAgICAgICAgIHN1Ym1pdEJ0bklkOiAnb2snXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gJCgnaW5wdXRbbmFtZT1maWxlXScpLmNsb3VkaW5hcnlfZmlsZXVwbG9hZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICQoJ2lucHV0W25hbWU9ZmlsZV0nKS51bnNpZ25lZF9jbG91ZGluYXJ5X3VwbG9hZCgndGVzdHVwbG9hZCcsIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgIGNsb3VkX25hbWU6ICdmaXJ2YWluJyxcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICdwdWJsaWNfaWQnOiBnaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnaW5wdXRbbmFtZT1vcHRpb25zXScpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLnZhbCgpID09PSAnU2FsZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcGV0cycpLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJ2xhYmVsW2Zvcj1wZXRzXScpLnJlbW92ZUNsYXNzKCdpcy1jaGVja2VkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnZhbCgnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwcmVmZXJlZF9jdXN0b21lcicpLnBhcmVudCgpLmVxKDApLnJlbW92ZUNsYXNzKCdpcy1kaXJ0eScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcjcHJlZmVyZWRfY3VzdG9tZXInKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3BldHMnKS5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3ByZWZlcmVkX2N1c3RvbWVyJykucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnI3NlbnQtbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGhhbmRsZUZvcm0uZ2V0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnByb3BlcnR5X2dpZCA9IGdpZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9saXN0aW5nJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdQT1NUJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAuZG9uZShmdW5jdGlvbiAoZGF0YSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDIwMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgVXBkYXRlZCBJbiBEYXRhYmFzZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdPb3BzIFNvbWV0aGluZyBXZW50IFdyb25nISEhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAuZmFpbChmdW5jdGlvbiAoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ09vcHMgU29tZXRoaW5nIFdlbnQgV3JvbmchISEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI29wZW5Nb2RhbCcpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICQoJyNjYW5jZWwtbGlzdGluZycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcm0uY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICQoJyNvcGVuTW9kYWwnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICQoJyNubycpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAkKCcjb3Blbk1vZGFsJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgIC8vIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAkKCcucHJvcGVydHktaW5mbycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICB0b2FzdHIuZXJyb3IoJ0NhbnQgRmluZCBBbnkgUHJvcGVydHkgVGhlcmUuLi4nKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG4vLyA9PT09PT0gbG9nb3V0ID09PT09PVxyXG4kKCcjbG9nb3V0JykuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gIGxvY2F0aW9uLmhyZWYgPSAnL2xvZ291dCc7XHJcbn0pO1xyXG4vLyA9PT09PT0gaW5zZXJ0ID09PT09PVxyXG4kKCcjaW5zZXJ0UHJvcGVydHknKS5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIG9uRW5kRHJhdztcclxuICB0b2FzdHIuY2xlYXIoKTtcclxuICAkKCcucHJvcGVydHktaW5mbycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gIG1hcC51bignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgZHJhdy5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgb25FbmREcmF3ID0gZHJhdy5vbignZHJhd2VuZCcsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgdmFyIGNvb3JkcztcclxuICAgIHZhciBnZW9jb2RlT2JqO1xyXG4gICAgdmFyIGxhdGxuZztcclxuICAgIHZhciBnZW9jb2RlTmFtZV9lbDtcclxuICAgIHZhciBnZW9jb2RlTmFtZV9lbjtcclxuICAgIHZhciBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgY29vcmRzID0gb2wucHJvai50cmFuc2Zvcm0oZXZlbnQuZmVhdHVyZS5nZXRHZW9tZXRyeSgpLmdldENvb3JkaW5hdGVzKCksICdFUFNHOjM4NTcnLCAnRVBTRzo0MzI2Jyk7XHJcbiAgICBvYmouY29vcmRzID0gY29vcmRzO1xyXG4gICAgbGF0bG5nID0gY29vcmRzWzFdICsgJ1xcLCcgKyBjb29yZHNbMF07XHJcbiAgICBnZW9jb2RlT2JqID0gJC5nZXRKU09OKCdodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvZ2VvY29kZS9qc29uJywge1xyXG4gICAgICBsYXRsbmc6IGxhdGxuZyxcclxuICAgICAga2V5OiAnQUl6YVN5Q2tIMzlfRXoyMV9SbENfcGpYRDA5enBKXyAtIGVWaHpDclEnLFxyXG4gICAgfSwgZnVuY3Rpb24gKGpzb24sIHRleHRTdGF0dXMpIHtcclxuICAgICAgcmV0dXJuIGpzb247XHJcbiAgICB9KTtcclxuICAgIGdlb2NvZGVPYmoudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGdlb2NvZGVOYW1lX2VsID0gXy5oZWFkKF8uaGVhZChnZW9jb2RlT2JqLnJlc3BvbnNlSlNPTi5yZXN1bHRzKS5hZGRyZXNzX2NvbXBvbmVudHMpLmxvbmdfbmFtZTtcclxuICAgICAgZ2VvY29kZU5hbWVfZW4gPSBzdHJpbmdfZWxfdG9fdXJsKGdlb2NvZGVOYW1lX2VsKTtcclxuICAgICAgb2JqLnN0cmVldF9lbCA9IGdlb2NvZGVOYW1lX2VsO1xyXG4gICAgICBvYmouc3RyZWV0X2VuID0gZ2VvY29kZU5hbWVfZW47XHJcbiAgICAgIGdlb2NvZGVBcmVhTmFtZSA9IF8uZmlyc3QoXy5kcm9wKF8ubWFwKF8uaGVhZChnZW9jb2RlT2JqLnJlc3BvbnNlSlNPTi5yZXN1bHRzKS5hZGRyZXNzX2NvbXBvbmVudHMsICdsb25nX25hbWUnKSkpO1xyXG4gICAgICBvYmouYXJlYV9uYW1lID0gZ2VvY29kZUFyZWFOYW1lO1xyXG4gICAgICBkYXRhRm9ybShvYmopO1xyXG4gICAgfSk7XHJcblxyXG4gIH0pO1xyXG5cclxuICBmdW5jdGlvbiBkYXRhRm9ybShvYmopIHtcclxuICAgICQoJy5tb2RhbC1kaWFsb2cnKS5yZW1vdmVDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgIGR1c3QucmVuZGVyKCdwcm9wZXJ0eUluc2VydCcsIG9iaiwgZnVuY3Rpb24gKGVyciwgb3V0KSB7XHJcbiAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICBjb21wb25lbnRIYW5kbGVyLnVwZ3JhZGVEb20oKTtcclxuICAgICAgaGFuZGxlRm9ybS5zZXQoe1xyXG4gICAgICAgIG5hbWU6ICdpbnNlcnRQcm9wZXJ0eScsXHJcbiAgICAgICAgc3VibWl0QnRuSWQ6ICdpbnNlcnQnXHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjZXN0YXRlVHlwZScpLmNoYW5nZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnRGV0YWNoZWQgSG91c2UnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnRGV0YWNoZWQgSG91c2UnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzpTOuc6xzrzOrc+BzrnPg868zrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICfOiM+AzrHPhc67zrcnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnVmlsbGEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnVmlsbGEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbCgnJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdNYWlzb25ldHRlJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ01haXNvbmV0dGUnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLmNoYW5nZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCQodGhpcykudmFsKCkgPT09ICdEZXRhY2hlZCBIb3VzZScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzpzOv869zr/Ous6xz4TOv865zrrOr86xJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0FwYXJ0bWVudCcpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKCcnKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCQodGhpcykudmFsKCkgPT09ICdWaWxsYScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOiM+AzrHPhc67zrcnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnzojPgM6xz4XOu863Jyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwoJycpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzpzOtc62zr/Ovc6tz4TOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOnM61zrbOv869zq3PhM6xJyk7XHJcblxyXG5cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjY2FuY2VsSW5zZXJ0Jykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgZHJhd25Qcm9wZXJ0aWVzLmdldFNvdXJjZSgpLmNsZWFyKCk7XHJcbiAgICAgICAgZHJhdy51bkJ5S2V5KG9uRW5kRHJhdyk7XHJcbiAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICB9KTtcclxuICAgICAgJCgnI2luc2VydCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBkYXRhO1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgZGF0YSA9IGhhbmRsZUZvcm0uZ2V0KCk7XHJcbiAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHtcclxuICAgICAgICAgIGRhdGEueCA9IG9iai5jb29yZHNbMF07XHJcbiAgICAgICAgICBkYXRhLnkgPSBvYmouY29vcmRzWzFdO1xyXG4gICAgICAgICAgZGF0YS5hZG1pbklkID0gaWQ7XHJcbiAgICAgICAgICAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHknLFxyXG4gICAgICAgICAgICB0eXBlOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGFcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuZG9uZShmdW5jdGlvbiBjb21wbGV0ZWQoKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgUmVjb3JkZWQgSW4gRGF0YWJhc2UnKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuZmFpbChmdW5jdGlvbiBmYWlsZWQoanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NvcnJ5LCB3ZSBjYW5ub3QgZmluZCB0aGlzIHByb3BlcnR5IScpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpxWEhSLnN0YXR1cyA9PT0gNTAzKSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5hbHdheXMoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICBkcmF3blByb3BlcnRpZXMuZ2V0U291cmNlKCkuY2xlYXIoKTtcclxuICAgICAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgaGFuZGxlRm9ybS5jbGVhcigpO1xyXG4gICAgICAgICAgICBkcmF3LnVuQnlLZXkob25FbmREcmF3KTtcclxuICAgICAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn0pO1xyXG4vLyA9PT09PT0gZGVsZXRlID09PT09PVxyXG4kKCcjZGVsZXRlUHJvcGVydHknKS5jbGljayhmdW5jdGlvbiAoZXZlbnQpIHtcclxuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIHRvYXN0ci5jbGVhcigpO1xyXG4gICQoJy5wcm9wZXJ0eS1pbmZvJykuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7XHJcbiAgbWFwLnVuKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgZHJhdy5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gIGZlYXR1cmVzLmNsZWFyKCk7XHJcbiAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gIHNlbGVjdC5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgc2VsZWN0Lm9uY2UoJ3NlbGVjdCcsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICB2YXIgJHRvYXN0O1xyXG4gICAgaWYgKGUudGFyZ2V0LmdldEZlYXR1cmVzKCkuZ2V0TGVuZ3RoKCkgPT09IDEpIHtcclxuICAgICAgJHRvYXN0ID0gdG9hc3RyLndhcm5pbmcoJzxwPkFyZSB5b3Ugc3VyZT88L3A+PGRpdiBjbGFzcz1cInRvYXN0ci1idG5zXCI+PGJ1dHRvbiBpZD1cInllc0RlbGV0ZVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uIFwiPlllczwvYnV0dG9uPjxidXR0b24gaWQ9XCJub0RlbGV0ZVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uXCI+Tm88L2J1dHRvbj48L2Rpdj4nKTtcclxuICAgICAgJHRvYXN0Lm9uKCdjbGljaycsICcjeWVzRGVsZXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBnaWQgPSBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5pdGVtKDApLmdldCgnZ2lkJyk7XHJcbiAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgIHVybDogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9kYi9wcm9wZXJ0eScsXHJcbiAgICAgICAgICB0eXBlOiAnREVMRVRFJyxcclxuICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgIGdpZDogZ2lkXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZChkYXRhLCB0ZXh0U3RhdHVzLCBqcVhIUikge1xyXG4gICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoJ1Byb3BlcnR5IFN1Y2Nlc3NmdWxseSBEZWxldGVkIHdpdGggaWQgPSAnICsgZGF0YS5wcm9wZXJ0eWdpZCArICcgZnJvbSBEYXRhYmFzZScpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgdG9hc3RyLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIGlmIChqcVhIUi5zdGF0dXMgPT09IDQwNCkge1xyXG4gICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIHRoaXMgcHJvcGVydHkhJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoanFYSFIuc3RhdHVzID09PSA1MDMpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ1NlcnZpY2UgVW5hdmFpbGFibGUnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoJ0ludGVybmFsIFNlcnZlciBFcnJvcicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmFsd2F5cyhmdW5jdGlvbiBhbHdheXMoKSB7XHJcbiAgICAgICAgICAgIHByb3BlcnR5U291cmNlLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkdG9hc3QucmVtb3ZlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICAkdG9hc3Qub24oJ2NsaWNrJywgJyNub0RlbGV0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAkdG9hc3QucmVtb3ZlKCk7XHJcbiAgICAgICAgc2VsZWN0LmdldEZlYXR1cmVzKCkuY2xlYXIoKTtcclxuICAgICAgICBzZWxlY3Quc2V0QWN0aXZlKGZhbHNlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuLy8gPT09PT09IHVwZGF0ZSA9PT09PT1cclxuXHJcbiQoJyN1cGRhdGVQcm9wZXJ0eScpLm9uKCdjbGljaycsIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnR5KGV2ZW50KSB7XHJcbiAgdmFyIGdpZDtcclxuICB2YXIgb2JqO1xyXG4gIHZhciBjb29yZHM7XHJcbiAgdmFyIG9uRW5kVHJhbnNsdGU7XHJcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICB0b2FzdHIuY2xlYXIoKTtcclxuICBtYXAudW4oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICBkcmF3LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgZmVhdHVyZXMuY2xlYXIoKTtcclxuICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgc2VsZWN0LnNldEFjdGl2ZSh0cnVlKTtcclxuICAkKCcucHJvcGVydHktaW5mbycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gIHNlbGVjdC5vbmNlKCdzZWxlY3QnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZXMgPSBlLnNlbGVjdGVkO1xyXG4gICAgdmFyIGxlbmd0aCA9IHNlbGVjdGVkRmVhdHVyZXMubGVuZ3RoO1xyXG4gICAgdmFyIHNlbGVjdGVkRmVhdHVyZTtcclxuICAgIGlmIChsZW5ndGggPT09IDEpIHtcclxuICAgICAgZ2lkID0gXy5oZWFkKGUuc2VsZWN0ZWQpLmdldCgnZ2lkJyk7XHJcbiAgICAgIHNlbGVjdGVkRmVhdHVyZSA9IF8uaGVhZChlLnNlbGVjdGVkKTtcclxuICAgICAgY29vcmRzID0gb2wucHJvai50cmFuc2Zvcm0oc2VsZWN0ZWRGZWF0dXJlLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgICAgJC5hamF4KHtcclxuICAgICAgICB1cmw6ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvZGIvcHJvcGVydHknLFxyXG4gICAgICAgIHR5cGU6ICdHRVQnLFxyXG4gICAgICAgIGRhdGFUeXBlOiAnanNvbicsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgZ2lkOiBnaWRcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgICAgLmRvbmUoZnVuY3Rpb24gY29tcGxldGVkKGRhdGEpIHtcclxuICAgICAgICAgIHZhciAkdG9hc3QgPSB7fTtcclxuICAgICAgICAgICR0b2FzdC5vcHRpb25zID0ge307XHJcbiAgICAgICAgICBvYmogPSBfLmhlYWQoZGF0YS5mZWF0dXJlcykucHJvcGVydGllcztcclxuICAgICAgICAgIGNvbnNvbGUubG9nKG9iailcclxuXHJcbiAgICAgICAgICAkdG9hc3QgPSB0b2FzdHIud2FybmluZygnPHA+Q2hhbmdlIFByb3BlcnR5IENvb3JkaW5hdGVzPzwvcD48ZGl2IGNsYXNzPVwidG9hc3RyLWJ0bnNcIj48YnV0dG9uIGlkPVwieWVzQ2hhbmdlWFlcIiBjbGFzcz1cIm1kbC1idXR0b24gbWRsLWpzLWJ1dHRvbiBcIj5ZZXM8L2J1dHRvbj48YnV0dG9uIGlkPVwibm9DaGFuZ2VYWVwiIGNsYXNzPVwibWRsLWJ1dHRvbiBtZGwtanMtYnV0dG9uXCI+Tm88L2J1dHRvbj48L2Rpdj4nKTtcclxuICAgICAgICAgICR0b2FzdC5vbignY2xpY2snLCAnI3llc0NoYW5nZVhZJywgZnVuY3Rpb24geWVzQ2hhbmdlWFkoKSB7XHJcbiAgICAgICAgICAgIHZhciBsYXRsbmc7XHJcbiAgICAgICAgICAgIHZhciBnZW9jb2RlT2JqO1xyXG4gICAgICAgICAgICB2YXIgZ2VvY29kZU5hbWVFbDtcclxuICAgICAgICAgICAgdmFyIGdlb2NvZGVOYW1lRW47XHJcbiAgICAgICAgICAgIHZhciBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICAgICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIG9uRW5kVHJhbnNsdGUgPSB0cmFuc2xhdGUub24oJ3RyYW5zbGF0ZWVuZCcsIGZ1bmN0aW9uIHRyYW5zbGF0ZUVuZChlKSB7XHJcbiAgICAgICAgICAgICAgLy8gdmFyIGdlb2NvZGVPYmo7XHJcbiAgICAgICAgICAgICAgY29vcmRzID0gb2wucHJvai50cmFuc2Zvcm0oZS5mZWF0dXJlcy5pdGVtKDApLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSwgJ0VQU0c6Mzg1NycsICdFUFNHOjQzMjYnKTtcclxuICAgICAgICAgICAgICBsYXRsbmcgPSBjb29yZHNbMV0gKyAnXFwsJyArIGNvb3Jkc1swXTtcclxuICAgICAgICAgICAgICBnZW9jb2RlT2JqID0gJC5nZXRKU09OKCdodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvZ2VvY29kZS9qc29uJywge1xyXG4gICAgICAgICAgICAgICAgbGF0bG5nOiBsYXRsbmcsXHJcbiAgICAgICAgICAgICAgICBrZXk6ICdBSXphU3lDa0gzOV9FejIxX1JsQ19walhEMDl6cEpfIC0gZVZoekNyUSdcclxuICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoanNvbiwgdGV4dFN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ucmVzdWx0cztcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICBnZW9jb2RlT2JqLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgZ2VvY29kZU5hbWVFbCA9IF8uaGVhZChfLmhlYWQoZ2VvY29kZU9iai5yZXNwb25zZUpTT04ucmVzdWx0cykuYWRkcmVzc19jb21wb25lbnRzKS5sb25nX25hbWU7XHJcbiAgICAgICAgICAgICAgICBnZW9jb2RlTmFtZUVuID0gc3RyaW5nX2VsX3RvX3VybChnZW9jb2RlTmFtZUVsKTtcclxuICAgICAgICAgICAgICAgIG9iai5zdHJlZXRfZWwgPSBnZW9jb2RlTmFtZUVsO1xyXG4gICAgICAgICAgICAgICAgb2JqLnN0cmVldF9lbiA9IGdlb2NvZGVOYW1lRW47XHJcbiAgICAgICAgICAgICAgICBnZW9jb2RlQXJlYU5hbWUgPSBfLmZpcnN0KF8uZHJvcChfLm1hcChfLmhlYWQoZ2VvY29kZU9iai5yZXNwb25zZUpTT04ucmVzdWx0cykuYWRkcmVzc19jb21wb25lbnRzLCAnbG9uZ19uYW1lJykpKTtcclxuICAgICAgICAgICAgICAgIG9iai5hcmVhX25hbWUgPSBnZW9jb2RlQXJlYU5hbWU7XHJcbiAgICAgICAgICAgICAgICBkYXRhRm9ybShvYmosIGNvb3Jkcyk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICAkdG9hc3Qub24oJ2NsaWNrJywgJyNub0NoYW5nZVhZJywgZnVuY3Rpb24gbm9DaGFuZ2VYWSgpIHtcclxuICAgICAgICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgIHRvYXN0ci5jbGVhcigpO1xyXG4gICAgICAgICAgICBkYXRhRm9ybShvYmosIGNvb3Jkcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZCgpIHtcclxuICAgICAgICAgIHRvYXN0ci5lcnJvcignT29wcyBTb21ldGhpbmcgV2VudCBXcm9uZyEhIScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBmdW5jdGlvbiBkYXRhRm9ybShvYmosIGNvb3Jkcykge1xyXG4gICAgJCgnLm1vZGFsLWRpYWxvZycpLnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgZHVzdC5yZW5kZXIoJ3Byb3BlcnR5VXBkYXRlJywgb2JqLCBmdW5jdGlvbiByZW5kZXJQcm9wZXJ0eVVwZGF0ZShlcnIsIG91dCkge1xyXG4gICAgICB2YXIgb2xkVmFsdWVzID0ge307XHJcbiAgICAgICQoJy5tb2RhbC1jb250ZW50JykuaHRtbChvdXQpO1xyXG4gICAgICBvbGRWYWx1ZXMuYmVkcm9vbXMgPSAkKCcjYmVkcm9vbXMnKS52YWwoKTtcclxuICAgICAgb2xkVmFsdWVzLnN0cmVldF9lbiA9ICQoJyNzdHJlZXRfZW4nKS52YWwoKTtcclxuICAgICAgb2xkVmFsdWVzLnN0cmVldF9lbCA9ICQoJyNzdHJlZXRfZWwnKS52YWwoKTtcclxuICAgICAgb2xkVmFsdWVzLmFyZWFfbmFtZSA9ICQoJyNhcmVhX25hbWUnKS52YWwoKTtcclxuICAgICAgY29tcG9uZW50SGFuZGxlci51cGdyYWRlRG9tKCk7XHJcbiAgICAgIGhhbmRsZUZvcm0uc2V0KHtcclxuICAgICAgICBuYW1lOiAndXBkYXRlUHJvcGVydHknLFxyXG4gICAgICAgIHN1Ym1pdEJ0bklkOiAndXBkYXRlJ1xyXG4gICAgICB9KTtcclxuICAgICAgLy8gJCgnI3N0cmVldF9lbCcpLnZhbChvYmouZ2VvY29kZU5hbWVfZWwpO1xyXG4gICAgICAvLyAkKCcjc3RyZWV0X2VuJykudmFsKG9iai5nZW9jb2RlTmFtZV9lbik7XHJcbiAgICAgICQoJyNlc3RhdGVUeXBlJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykudmFsKCdEZXRhY2hlZCBIb3VzZScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCdEZXRhY2hlZCBIb3VzZScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzpTOuc6xzrzOrc+BzrnPg868zrEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnZhbCgnQXBhcnRtZW50Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ0FwYXJ0bWVudCcpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnzojPgM6xz4XOu863Jykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ1ZpbGxhJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZV9lbicpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ1ZpbGxhJyk7XHJcbiAgICAgICAgICAkKCcjYmVkcm9vbXMnKS52YWwob2xkVmFsdWVzLmJlZHJvb21zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGVfZW4nKS52YWwoJ01haXNvbmV0dGUnKTtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykucGFyZW50KCkuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fYm94LXZhbHVlJykuaHRtbCgnTWFpc29uZXR0ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICQoJyNlc3RhdGVUeXBlX2VuJykuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0RldGFjaGVkIEhvdXNlJykge1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS52YWwoJ86czr/Ovc6/zrrOsc+Ezr/Ouc66zq/OsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOnM6/zr3Ov866zrHPhM6/zrnOus6vzrEnKTtcclxuICAgICAgICAgICQoJyNiZWRyb29tcycpLnZhbChvbGRWYWx1ZXMuYmVkcm9vbXMpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoJCh0aGlzKS52YWwoKSA9PT0gJ0FwYXJ0bWVudCcpIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2VzdGF0ZVR5cGUnKS5wYXJlbnQoKS5maW5kKCcubWRsLXNlbGVjdGZpZWxkX19ib3gtdmFsdWUnKS5odG1sKCfOlM65zrHOvM6tz4HOuc+DzrzOsScpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLnZhbCgpID09PSAnVmlsbGEnKSB7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnZhbCgnzojPgM6xz4XOu863Jyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86Iz4DOsc+FzrvOtycpO1xyXG4gICAgICAgICAgJCgnI2JlZHJvb21zJykudmFsKG9sZFZhbHVlcy5iZWRyb29tcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICQoJyNlc3RhdGVUeXBlJykudmFsKCfOnM61zrbOv869zq3PhM6xJyk7XHJcbiAgICAgICAgICAkKCcjZXN0YXRlVHlwZScpLnBhcmVudCgpLmZpbmQoJy5tZGwtc2VsZWN0ZmllbGRfX2JveC12YWx1ZScpLmh0bWwoJ86czrXOts6/zr3Orc+EzrEnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjdXBkYXRlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gdXBkYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIGRhdGE7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBkYXRhID0gaGFuZGxlRm9ybS5nZXQoKTtcclxuICAgICAgICBpZiAoIV8uaXNOaWwoZGF0YSkpIHtcclxuICAgICAgICAgIGRhdGEueCA9IGNvb3Jkc1swXTtcclxuICAgICAgICAgIGRhdGEueSA9IGNvb3Jkc1sxXTtcclxuICAgICAgICAgIGRhdGEuZ2lkID0gZ2lkO1xyXG4gICAgICAgICAgJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnaHR0cDovLzEyNy4wLjAuMTozMDAwL2RiL3Byb3BlcnR5JyxcclxuICAgICAgICAgICAgdHlwZTogJ1BVVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGFcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5kb25lKGZ1bmN0aW9uIGNvbXBsZXRlZChyZXNwb25zZSwgdGV4dFN0YXR1cywganFYSFIpIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygnUHJvcGVydHkgd2l0aCBnaWQgJyArIHJlc3BvbnNlLnByb3BlcnR5Z2lkICsgJyBVcGRhdGVkIGluIERhdGFiYXNlJyk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5mYWlsKGZ1bmN0aW9uIGZhaWxlZChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICB0b2FzdHIuY2xlYXIoKTtcclxuICAgICAgICAgICAgICBpZiAoanFYSFIuc3RhdHVzID09PSA0MDQpIHtcclxuICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignU29ycnksIHdlIGNhbm5vdCBmaW5kIHRoaXMgcHJvcGVydHkhJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChqcVhIUi5zdGF0dXMgPT09IDUwMykge1xyXG4gICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdTZXJ2aWNlIFVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcignSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuYWx3YXlzKGZ1bmN0aW9uIGFsd2F5cygpIHtcclxuICAgICAgICAgICAgICBwcm9wZXJ0eVNvdXJjZS5jbGVhcigpO1xyXG4gICAgICAgICAgICAgIHNlbGVjdC5nZXRGZWF0dXJlcygpLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgc2VsZWN0LnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgdHJhbnNsYXRlLnVuQnlLZXkob25FbmRUcmFuc2x0ZSk7XHJcbiAgICAgICAgICAgICAgdHJhbnNsYXRlLnNldEFjdGl2ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgbWFwLm9uKCdjbGljaycsIGNsaWNrSW5mbyk7XHJcbiAgICAgICAgICAgICAgJCgnLm1vZGFsLWRpYWxvZycpLmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKCcjY2FuY2VsVXBkYXRlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gY2FuY2VsVXBkYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBoYW5kbGVGb3JtLmNsZWFyKCk7XHJcbiAgICAgICAgcHJvcGVydHlTb3VyY2UuY2xlYXIoKTtcclxuICAgICAgICBzZWxlY3QuZ2V0RmVhdHVyZXMoKS5jbGVhcigpO1xyXG4gICAgICAgIHRyYW5zbGF0ZS51bkJ5S2V5KG9uRW5kVHJhbnNsdGUpO1xyXG4gICAgICAgIHNlbGVjdC5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgIHRyYW5zbGF0ZS5zZXRBY3RpdmUoZmFsc2UpO1xyXG4gICAgICAgIG1hcC5vbignY2xpY2snLCBjbGlja0luZm8pO1xyXG4gICAgICAgICQoJy5tb2RhbC1kaWFsb2cnKS5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTtcclxuICAgICAgICBtYXAub24oJ2NsaWNrJywgY2xpY2tJbmZvKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gICQoJyNhZG1pbk1hcCcpLnJlbW92ZUF0dHIoJ3N0eWxlJyk7XHJcbn0pO1xyXG4kKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7XHJcbiAgd2luZG93LlBhcnNsZXkub24oJ2ZpZWxkOmVycm9yJywgZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gVGhpcyBnbG9iYWwgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgZm9yIGFueSBmaWVsZCB0aGF0IGZhaWxzIHZhbGlkYXRpb24uXHJcbiAgICBjb25zb2xlLmxvZygnVmFsaWRhdGlvbiBmYWlsZWQgZm9yOiAnLCB0aGlzLiRlbGVtZW50KTtcclxuICB9KTtcclxuICB3aW5kb3cuUGFyc2xleVxyXG4gICAgLmFkZFZhbGlkYXRvcignZGF0ZScsIHtcclxuICAgICAgcmVxdWlyZW1lbnRUeXBlOiAnc3RyaW5nJyxcclxuICAgICAgdmFsaWRhdGVTdHJpbmc6IGZ1bmN0aW9uICh2YWx1ZSwgcmVxdWlyZW1lbnQpIHtcclxuICAgICAgICBpZiAobW9tZW50KHZhbHVlLCAnREQtTU0tWVlZWScsIHRydWUpLmlzVmFsaWQoKSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSxcclxuICAgICAgbWVzc2FnZXM6IHtcclxuICAgICAgICBlbjogJ1dyb25nIERhdGUnLFxyXG4gICAgICAgIGVsOiAnzpvOrM64zr/PgiDOl868zrXPgc6/zrzOt869zq/OsSdcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gc3RyaW5nX2VsX3RvX3VybChzdHJpbmcpIHtcclxuICB2YXIgb3JpZ2luYWxTdHJpbmcgPSBzdHJpbmc7XHJcbiAgdmFyIG5ld1N0cmluZztcclxuICB2YXIgcmVwbGFjZSA9IG5ldyBBcnJheSgnzrEnLCAnzqwnLCAnzoYnLCAnzpEnLCAnzrInLCAnzpInLCAnzrMnLCAnzpMnLCAnzrQnLCAnzpQnLCAnzrUnLCAnzq0nLCAnzpUnLCAnzognLCAnzrYnLCAnzpYnLCAnzrcnLCAnzq4nLCAnzpcnLCAnzrgnLCAnzpgnLCAnzrknLCAnzq8nLCAnz4onLCAnzpAnLCAnzpknLCAnzoonLCAnzronLCAnzponLCAnzrsnLCAnzpsnLCAnzrwnLCAnzpwnLCAnzr0nLCAnzp0nLCAnzr4nLCAnzp4nLCAnzr8nLCAnz4wnLCAnzp8nLCAnzownLCAnz4AnLCAnzqAnLCAnz4EnLCAnzqEnLCAnz4MnLCAnz4InLCAnzqMnLCAnz4QnLCAnzqQnLCAnz4UnLCAnz40nLCAnzqUnLCAnzo4nLCAnz4YnLCAnzqYnLCAnz4cnLCAnzqcnLCAnz4gnLCAnzqgnLCAnz4knLCAnz44nLCAnzqknLCAnzo8nLCAnICcsICdcXCcnLCAnXFwnJywgJywnKTtcclxuICB2YXIgcmVwbGFjZV9uID0gbmV3IEFycmF5KCdhJywgJ2EnLCAnQScsICdBJywgJ3YnLCAnVicsICdnJywgJ0cnLCAnZCcsICdEJywgJ2UnLCAnZScsICdFJywgJ0UnLCAneicsICdaJywgJ2knLCAnaScsICdJJywgJ3RoJywgJ1RoJywgJ2knLCAnaScsICdpJywgJ2knLCAnSScsICdJJywgJ2snLCAnSycsICdsJywgJ0wnLCAnbScsICdNJywgJ24nLCAnTicsICd4JywgJ1gnLCAnbycsICdvJywgJ08nLCAnTycsICdwJywgJ1AnLCAncicsICdSJywgJ3MnLCAncycsICdTJywgJ3QnLCAnVCcsICd1JywgJ3UnLCAnWScsICdZJywgJ2YnLCAnRicsICdjaCcsICdDaCcsICdwcycsICdQcycsICdvJywgJ28nLCAnTycsICdPJywgJyAnLCAnXycsICdfJywgJ18nKTtcclxuXHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXBsYWNlLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBvcmlnaW5hbFN0cmluZyA9IG9yaWdpbmFsU3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cChyZXBsYWNlW2ldLCAnZycpLCByZXBsYWNlX25baV0pO1xyXG4gIH1cclxuICBuZXdTdHJpbmcgPSBvcmlnaW5hbFN0cmluZztcclxuICByZXR1cm4gbmV3U3RyaW5nO1xyXG59XHJcbiQoZG9jdW1lbnQpXHJcbiAgLmFqYXhTdGFydChmdW5jdGlvbiAoKSB7XHJcbiAgICAkbG9hZGluZy5hZGRDbGFzcygnaXMtYWN0aXZlJyk7XHJcbiAgfSlcclxuICAuYWpheFN0b3AoZnVuY3Rpb24gKCkge1xyXG4gICAgJGxvYWRpbmcucmVtb3ZlQ2xhc3MoJ2lzLWFjdGl2ZScpO1xyXG4gIH0pO1xyXG4iLCJ2YXIgaGFuZGxlRm9ybSA9IChmdW5jdGlvbiAoJCwgcGFyc2xleSkge1xyXG4gICd1c2Ugc3RyaWN0JztcclxuICB2YXIgZm9ybU5hbWUsIHN1Ym1pdEJ0bklkLCBwO1xyXG5cclxuICBmdW5jdGlvbiBzZXRPcHRpb25zKG9wdGlvbnMpIHtcclxuICAgIGZvcm1OYW1lID0gb3B0aW9ucy5uYW1lO1xyXG4gICAgc3VibWl0QnRuSWQgPSBvcHRpb25zLnN1Ym1pdEJ0bklkO1xyXG4gICAgZW5hYmxlU2VsZWN0KCk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGVuYWJsZVNlbGVjdCgpIHtcclxuICAgIHZhciBlID0gJCgnLmdldG1kbC1zZWxlY3QnKTtcclxuICAgIGUuZWFjaChmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGFkZEV2ZW50TGlzdGVuZXJzKHRoaXMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXJzKGUpIHtcclxuICAgIHZhciB0ID0gZS5xdWVyeVNlbGVjdG9yKCdpbnB1dCcpLFxyXG4gICAgICBuID0gZS5xdWVyeVNlbGVjdG9yQWxsKCdsaScpO1xyXG4gICAgZS5xdWVyeVNlbGVjdG9yKCdpJyk7XHJcbiAgICBbXS5mb3JFYWNoLmNhbGwobiwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgZS5vbmNsaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHQudmFsdWUgPSBlLnRleHRDb250ZW50O1xyXG4gICAgICB9O1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIGRpc2FibGVTdWJtaXRCdG4oKSB7XHJcbiAgICAkKCcjJyArIHN1Ym1pdEJ0bklkICsgJycpLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBjcmVhdGVWYWxpZGF0b3IoKSB7XHJcbiAgICBwID0gJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykucGFyc2xleSgpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBkZXN0cm95VmFsaWRhdG9yKCkge1xyXG4gICAgcC5kZXN0cm95KCk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiB2YWxpZGF0ZUZvcm0oKSB7XHJcbiAgICByZXR1cm4gcC52YWxpZGF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gb25WYWxpZGF0ZUZvcm1TdWNjZXNzKCkge1xyXG4gICAgcC5vbignZm9ybTpzdWNjZXNzJyxcclxuXHJcbiAgICAgIGZ1bmN0aW9uICgpIHt9KTtcclxuICB9XHJcbiAgZnVuY3Rpb24gc2V0QXR0cmlidXRlcyhhdHIpIHtcclxuICAgICQoJyNzdHJlZXRfZWwnKS52YWwoYXRyLnN0cmVldF9lbCk7XHJcbiAgICAkKCcjc3RyZWV0X2VuJykudmFsKGF0ci5zdHJlZXRfZW4pO1xyXG4gIH1cclxuICBmdW5jdGlvbiBnZXRBdHRyaWJ1dGVzKCkge1xyXG4gICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgY3JlYXRlVmFsaWRhdG9yKCk7XHJcbiAgICBpZiAodmFsaWRhdGVGb3JtKCkgPT09IHRydWUpIHtcclxuICAgICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC10ZXh0ZmllbGRfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgICBvYmpbJCh0aGlzKS5hdHRyKCdpZCcpXSA9ICQodGhpcykudmFsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtY2hlY2tib3hfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgICBvYmpbJCh0aGlzKS5hdHRyKCdpZCcpXSA9ICQodGhpcykucHJvcCgnY2hlY2tlZCcpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLXJhZGlvX19idXR0b24nKS5lYWNoKFxyXG4gICAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICAgb2JqWyQodGhpcykuYXR0cignaWQnKV0gPSAkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgJCgnZm9ybVtuYW1lPVwiJyArIGZvcm1OYW1lICsgJ1wiJykuZmluZCgnLm1kbC1zZWxlY3RmaWVsZF9fc2VsZWN0JykuZWFjaChcclxuICAgICAgICBmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcclxuICAgICAgICAgIG9ialskKHRoaXMpLmF0dHIoJ2lkJyldID0gJCh0aGlzKS52YWwoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgcmV0dXJuIG9iajtcclxuICAgIH1cclxuICAgIGVsc2UgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiByZXNldEZvcm0oKSB7XHJcbiAgICBpZiAoY3JlYXRlVmFsaWRhdG9yKCkgPT0gdHJ1ZSkge1xyXG4gICAgICBkZXN0cm95VmFsaWRhdG9yKCk7XHJcbiAgICB9XHJcbiAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLXRleHRmaWVsZF9faW5wdXQnKS5lYWNoKFxyXG5cclxuICAgICAgZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XHJcbiAgICAgICAgJCh0aGlzKS52YWwoJycpO1xyXG4gICAgICAgICQodGhpcykucGFyZW50KCkuZXEoMCkucmVtb3ZlQ2xhc3MoJ2lzLWRpcnR5Jyk7XHJcbiAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5lcSgwKS5yZW1vdmVDbGFzcygnaXMtaW52YWxpZCcpO1xyXG4gICAgICB9KTtcclxuICAgICQoJ2Zvcm1bbmFtZT1cIicgKyBmb3JtTmFtZSArICdcIicpLmZpbmQoJy5tZGwtY2hlY2tib3hfX2lucHV0JykuZWFjaChcclxuXHJcbiAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICQodGhpcykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTtcclxuICAgICAgfSk7XHJcbiAgICAkKCdmb3JtW25hbWU9XCInICsgZm9ybU5hbWUgKyAnXCInKS5maW5kKCcubWRsLWNoZWNrYm94JykuZWFjaChcclxuXHJcbiAgICAgIGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xyXG4gICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ2lzLWNoZWNrZWQnKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiB7XHJcbiAgICBzZXQ6IHNldE9wdGlvbnMsXHJcbiAgICBnZXQ6IGdldEF0dHJpYnV0ZXMsXHJcbiAgICBjbGVhcjogcmVzZXRGb3JtLFxyXG4gICAgc2V0QXR0cmlidXRlczogc2V0QXR0cmlidXRlc1xyXG4gIC8vIGNyZWF0ZVZhbGlkYXRvcjogY3JlYXRlVmFsaWRhdG9yLFxyXG4gIC8vIGRlc3Ryb3lWYWxpZGF0b3I6IGRlc3Ryb3lWYWxpZGF0b3IsXHJcbiAgLy8gdmFsaWRhdGVGb3JtOiB2YWxpZGF0ZUZvcm0sXHJcbiAgLy8gb25WYWxpZGF0ZUZvcm1TdWNjZXNzOiBvblZhbGlkYXRlRm9ybVN1Y2Nlc3MsXHJcbiAgLy8gZGlzYWJsZVN1Ym1pdEJ0bjogZGlzYWJsZVN1Ym1pdEJ0blxyXG4gIH07XHJcbn0oalF1ZXJ5LCBwYXJzbGV5KSk7XHJcbiJdfQ==
